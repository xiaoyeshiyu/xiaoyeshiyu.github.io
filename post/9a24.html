<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这篇文章将探讨DNS（域名系统）和CDN（内容分发网络）的重要性和功能，介绍一些常见的DNS和CDN优化策略，以提高网站的可用性、安全性和性能。">
<meta property="og:type" content="article">
<meta property="og:title" content="DNS &amp; CND">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/9a24.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="这篇文章将探讨DNS（域名系统）和CDN（内容分发网络）的重要性和功能，介绍一些常见的DNS和CDN优化策略，以提高网站的可用性、安全性和性能。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162328822.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162403478.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162926645.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163024532.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163311185.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163449253.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207164837139.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170221398.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170425290.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170639723.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171225596.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171254922.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171315027.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171548263.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172258043.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172704086.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172843553.png">
<meta property="article:published_time" content="2023-12-06T16:00:00.000Z">
<meta property="article:modified_time" content="2023-12-12T08:31:38.476Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162328822.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/9a24.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/9a24.html","path":"post/9a24.html","title":"DNS & CND"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>DNS & CND | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DNS"><span class="nav-number">1.</span> <span class="nav-text">DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">1.2.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-DNS-%E5%8A%AB%E6%8C%81"><span class="nav-number">1.2.1.</span> <span class="nav-text">Local DNS 劫持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%9F%E5%90%8D%E7%BC%93%E5%AD%98"><span class="nav-number">1.2.2.</span> <span class="nav-text">域名缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E8%BD%AC%E5%8F%91"><span class="nav-number">1.2.3.</span> <span class="nav-text">解析转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%BD%92%E5%87%BA%E5%8F%A3-NAT"><span class="nav-number">1.2.4.</span> <span class="nav-text">递归出口 NAT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8-DNS-%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.</span> <span class="nav-text">高可用 DNS 设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.4.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTPDNS%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.4.1.</span> <span class="nav-text">HTTPDNS基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%B2%BB%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8"><span class="nav-number">1.4.2.</span> <span class="nav-text">根治域名解析异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF"><span class="nav-number">1.4.3.</span> <span class="nav-text">优势</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CDN"><span class="nav-number">2.</span> <span class="nav-text">CDN</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">系统架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">2.2.</span> <span class="nav-text">数据一致性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99-x2F-%E5%8A%A8%E6%80%81-CDN-%E5%8A%A0%E9%80%9F"><span class="nav-number">2.3.</span> <span class="nav-text">静&#x2F;动态 CDN 加速</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81-CDN-%E5%8A%A0%E9%80%9F"><span class="nav-number">2.3.1.</span> <span class="nav-text">静态 CDN 加速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81-CDN-%E5%8A%A0%E9%80%9F"><span class="nav-number">2.3.2.</span> <span class="nav-text">动态 CDN 加速</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">128</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/9a24.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="DNS & CND | 小夜时雨">
      <meta itemprop="description" content="这篇文章将探讨DNS（域名系统）和CDN（内容分发网络）的重要性和功能，介绍一些常见的DNS和CDN优化策略，以提高网站的可用性、安全性和性能。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DNS & CND
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-07 00:00:00" itemprop="dateCreated datePublished" datetime="2023-12-07T00:00:00+08:00">2023-12-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-12 16:31:38" itemprop="dateModified" datetime="2023-12-12T16:31:38+08:00">2023-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GoTrainingCamp/" itemprop="url" rel="index"><span itemprop="name">Go训练营</span></a>
        </span>
    </span>

  
    <span id="/post/9a24.html" class="post-meta-item leancloud_visitors" data-flag-title="DNS & CND" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">这篇文章将探讨DNS（域名系统）和CDN（内容分发网络）的重要性和功能，介绍一些常见的DNS和CDN优化策略，以提高网站的可用性、安全性和性能。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>DNS</code>（<code>Domain Name System</code>，域名系统），<code>DNS</code> 服务用于在网络请求时，将域名转为 <code>IP</code> 地址。能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的 IP 数串。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162328822.png" alt="image-20231207162328822"></p>
<p>传统的基于 <code>UDP</code> 协议的公共 <code>DNS</code> 服务极易发生 <code>DNS</code> 劫持，从而造成安全问题。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162403478.png" alt="image-20231207162403478"></p>
<ul>
<li><p>递归查询</p>
<p>如果主机所查询的本地域名服务器不知道被查询域名的 <code>IP</code> 地址，那么本地域名服务器就以 <code>DNS</code> 客户端的身份，向其他根域名服务器继续发出查询请求报文，而不是让该主机自己进行下一步的查询。</p>
</li>
<li><p>迭代查询</p>
<p>当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所查询的 <code>IP</code> 地址，要么告诉本地域名服务器：你下一步应当向哪一个域名服务器进行查询。然后让本地域名服务器进行后续的查询，而不是替本地域名服务器进行后续的查询。</p>
</li>
</ul>
<p>由此可见，客户端到 <code>Local DNS</code> 服务器，<code>Local DNS</code> 与上级 <code>DNS</code> 服务器之间属于递归查询；<code>DNS</code> 服务器与根 <code>DNS</code> 服务器之间属于迭代查询。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="Local-DNS-劫持"><a href="#Local-DNS-劫持" class="headerlink" title="Local DNS 劫持"></a><code>Local DNS</code> 劫持</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207162926645.png" alt="image-20231207162926645"></p>
<p><code>Local DNS</code> 把域名劫持到其他域名，实现其不可告人的目的。</p>
<h3 id="域名缓存"><a href="#域名缓存" class="headerlink" title="域名缓存"></a>域名缓存</h3><p>域名缓存就是 <code>LocalDNS</code> 缓存了业务的域名的解析结果，不向权威 <code>DNS</code> 发起递归。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163024532.png" alt="image-20231207163024532"></p>
<ul>
<li>保证用户访问流量在本地内网消化：国内的各互联网接入运营商的带宽资源、网间结算费用、IDC机房分布、网内<code>ICP</code>资源分布等存在较大差异。为了保证网内用户的访问质量，同时减少跨网结算，运营商在网内搭建了内容缓存服务器，通过把域名强行指向内容缓存服务器的IP地址，就实现了把本地本网流量完全留在了本地的目的。（从而实现本网流量消化，不用跨网，也就可以省钱，或者增加一些广告。）</li>
<li>推送广告：有部分 <code>LocalDNS</code> 会把部分域名解析结果所指向的内容缓存，并替换成第三方广告联盟的广告。</li>
</ul>
<h3 id="解析转发"><a href="#解析转发" class="headerlink" title="解析转发"></a>解析转发</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163311185.png" alt="image-20231207163311185"></p>
<p>除了域名缓存以外，运营商的<code>LocalDNS</code> 还存在解析转发的现象。</p>
<p>解析转发是指运营商自身不进行域名递归解析，而是把域名解析请求转发到其他运营商的递归<code>DNS</code>上的行为。</p>
<p>而部分小运营商为了节省资源，就直接将解析请求转发到了其他运营的递归 <code>LocalDNS</code> 上去了。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207163449253.png" alt="image-20231207163449253"></p>
<p>这样的直接后果就是权威 <code>DNS</code> 收到的域名解析请求的来源IP就成了其他运营商的IP，最终导致用户流量被导向了错误的<code>IDC</code>，用户访问变慢。</p>
<h3 id="递归出口-NAT"><a href="#递归出口-NAT" class="headerlink" title="递归出口 NAT"></a>递归出口 <code>NAT</code></h3><p><code>LocalDNS</code> 递归出口 <code>NAT</code> 指的是运营商的 <code>LocalDNS</code> 按照标准的 <code>DNS</code> 协议进行配置，但是因为在网络上存在多出口且配置了目标路由 <code>NAT</code>，结果导致<code>LocalDNS</code> 最终进行递归解析的时候的出口 IP 就有概率不为本网的 <code>IP</code> 地址。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207164837139.png" alt="image-20231207164837139"></p>
<p>这样的直接后果就是 <code>DNS</code> 收到的域名解析请求的来源<code>IP</code>还是成了其他运营商的<code>IP</code>，最终导致用户流量被导向了错误的 <code>IDC</code>，用户访问变慢。</p>
<h2 id="高可用-DNS-设计"><a href="#高可用-DNS-设计" class="headerlink" title="高可用 DNS 设计"></a>高可用 <code>DNS</code> 设计</h2><p>实时监控 + 商务推动：</p>
<p>这种方案周期比较长，毕竟通过行政手段来推动运营商来解决这个问题是比较耗时的。</p>
<p>另外我们通过大数据分析，得出的结论是 <code>Top3</code> 的问题用户均为移动互联网用户。对于这部分用户，我们有什么技术手段可以解决以上的问题呢？</p>
<p>绕过自动分配 <code>DNS</code>，使用 <code>114DNS</code>或<code>Google public DNS</code>：</p>
<ul>
<li>如何在用户侧构造域名请求：对于 <code>PC</code> 端的客户端来说，构造一个标准的 <code>DNS</code> 请求包并不算什么难事。但在移动端要向一个指定的 <code>LocalDNS</code> 上发送标准的 <code>DNS</code> 请求包，而且要兼容各种 <code>iOS</code> 和 <code>Android</code> 的版本的话，技术上是可行的，只是兼容的成本会很高。</li>
<li>推动用户修改配置极高：如果要推动用户手动修改 <code>PC</code> 的<code>DNS</code>配置的话，在 <code>PC</code>端和手机客户端的 <code>Wi-Fi</code> 下面还算勉强可行。但是要用户修改在移动互联网环境下的 <code>DNS</code> 配置，其难度不言而喻。</li>
</ul>
<p>完全抛弃域名，自建 <code>HTTPDNS</code> 进行流量调度：</p>
<ul>
<li>如果要采用这种方案的话，首先就得要拿到一份准确的<code>IP</code>地址库来判断用户的归属（根据<code>HTTP</code>的<code>Header</code>获取里面放的源<code>IP</code>），然后再指定个协议，搭建服务器来做调度，然后再对接入层做调度改造。</li>
<li>这种方案和上面两种方案一样，可以做，但是成本会很高，尤其对于大体量业务规模如此庞大的公司而言。</li>
</ul>
<p>当前主流的解决方案：<code>HTTPDNS</code>。使用 <code>HTTP</code> 请求，代替使用 <code>UDP</code> 请求 <code>DNS</code></p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p><code>HTTPDNS</code> 利用 <code>HTTP</code> 协议与 <code>DNS</code> 服务器交互，代替了传统的基于 <code>UDP</code> 协议的 <code>DNS</code> 交互，绕开了运营商的 <code>LocalDNS</code>，有效防止了域名劫持，提高域名解析效率。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170221398.png" alt="image-20231207170221398"></p>
<p>另外，由于 <code>HTTPDNS</code> 服务器端获取的是真实用户端 <code>IP</code> 而非 <code>LocalDNS</code> 的 <code>IP</code>，能够精确定位客户端地理位置、运营商信息，从而有效改进调度精确性。</p>
<h3 id="HTTPDNS基本原理"><a href="#HTTPDNS基本原理" class="headerlink" title="HTTPDNS基本原理"></a><code>HTTPDNS</code>基本原理</h3><p>由于 <code>HTTPDNS</code> 是通过 <code>ip</code> 直接请求 <code>HTTP</code>获取服务器A记录地址，不存在向本地运营商询问 <code>domain</code> 解析过程，所以从根本避免了劫持问题。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170425290.png" alt="image-20231207170425290"></p>
<p>平均访问延迟下降：</p>
<ul>
<li>由于是<code>ip</code>直接访问省掉了一次 <code>domain</code> 解析过程</li>
</ul>
<p>用户连接失败率下降：</p>
<ul>
<li>通过算法降低以往失败率过高的服务器排序</li>
<li>通过时间近期访问过的数据提高服务器排序</li>
<li>通过历史访问成功记录提高服务器排序</li>
</ul>
<h3 id="根治域名解析异常"><a href="#根治域名解析异常" class="headerlink" title="根治域名解析异常"></a>根治域名解析异常</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207170639723.png" alt="image-20231207170639723"></p>
<p>由于绕过了运营商的 <code>LocalDNS</code>，用户解析域名的请求通过<code>HTTP</code>协议直接透传到了 <code>HTTPDNS</code> 服务器<code>IP</code> 上，用户在客户端的域名解析请求将不会遭受到域名解析异常的困扰。</p>
<ul>
<li>调度精准：<code>HTTPDNS</code> 能直接获取到用户<code>IP</code>，通过结合 <code>IP</code>地址库以及测速系统，可以保证将用户引导到访问最快的 <code>IDC</code>节点上；</li>
<li>实现成本低廉：<ul>
<li>接入 <code>HTTPDNS</code>的业务仅需要对客户端接入层做少量改造，无需用户手机进行 <code>root</code> 或越狱；</li>
<li>而且由于少量<code>HTTP</code>协议请求构造非常简单，兼容各版本的移动操作系统更不成问题；</li>
<li>另外 <code>HTTPDNS</code>的后端配置完全复用现有权威 <code>DNS</code> 配置，管理成本也非常低；</li>
</ul>
</li>
</ul>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><p>如果只有一个 <code>VIP</code>，即可以增加 <code>DNS</code>记录的TTL，减少解析的延迟。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171225596.png" alt="image-20231207171225596"></p>
<p><code>Anycast</code> 可以使用一个<code>IP</code>，将数据路由到最近的一组服务器，通过<code>BGP</code>宣告这个<code>IP</code>，但是这存在两个问题：</p>
<ul>
<li>如果某个节点承载过多的用户会过载</li>
<li><code>BGP</code> 路由计算可能会导致连接重置</li>
</ul>
<p>因此需要一个稳定<code>Anycast</code>技术来实现。例如谷歌使用的 <code>8.8.8.8</code> ：<span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BzYW5qZWV2cGFuZGV5MTgvaG93LWFueWNhc3QtbWFrZXMtZG5zLXJlc29sdmUtZmFzdGVyLTU3MjY5ZTE4OWZhOA==">How Anycast makes DNS resolve faster<i class="fa fa-external-link-alt"></i></span></p>
<h1 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h1><p>使用 <code>HTTPDNS</code> + <code>CDN</code>缓存静态图片等资源，让终端访问更快。</p>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><p>架构图</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171254922.png" alt="image-20231207171254922"></p>
<ol>
<li>用户流量发起 <code>DNS</code> 请求到 <code>Loacl DNS</code>，查询<code>IP</code>，返回最佳接入<code>IP</code>（由权威的<code>DNS</code>返回距离最近的IP）</li>
<li>往最佳 <code>IP</code> 发起请求，也就是一级 <code>CDN</code>，一级 <code>CDN</code> 可能会将流量转发到二级 <code>CDN</code></li>
<li>二级<code>CDN</code>访问源站节点，将资源返回，并且缓存到本地</li>
</ol>
<p>拓扑图</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171315027.png" alt="image-20231207171315027"></p>
<ul>
<li><p>缓存代理</p>
<p>通过智能<code>DNS</code>的筛选，用户的请求被透明地指向离他最近的省内骨干节点，最大限度的缩短用户信息的传输距离。</p>
</li>
<li><p>路由加速</p>
<p>利用接入节点和中继节点或者多线节点互联互通</p>
</li>
<li><p>安全保护</p>
<p>无论面对是渗透还是 <code>DDoS</code> 攻击，攻击的目标大都会被指向到了 <code>CDN</code>，进而保护了用户源站</p>
</li>
<li><p>节省成本</p>
<p><code>CDN</code> 节点机房只需要在当地运营商的单线机房，或者带宽相对便宜的城市，采购成本低。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207171548263.png" alt="image-20231207171548263"></p>
<ul>
<li><p>内容路由</p>
<p><code>DNS</code>系统、应用层重定向，传输层重定向</p>
</li>
<li><p>内容分发</p>
<ul>
<li><code>PUSH</code>：主动分发，内容管理系统发起，将内容从源分发到 <code>CDN</code> 的 <code>Cache</code> 节点。使用边缘节点存储热点数据，降低内部网络流量和延迟。</li>
<li><code>PULL</code>：被动分发技术，用户请求驱动，用户请求内容中 <code>miss</code>，从源中或者其他 <code>CDN</code> 节点中实时获取内容（还可以使用归并回源，收敛请求）</li>
</ul>
</li>
<li><p>内存存储</p>
<p>随机读、顺序写、小文件的分布式存储</p>
</li>
<li><p>内容管理</p>
<p>提高内容服务的效率，提高 <code>CDN</code> 的缓存利用率</p>
</li>
</ul>
<h2 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h2><ul>
<li><p><code>PUSH</code></p>
<p>不存在数据一致性问题（特别是前端<code>js</code>，<code>css</code> 文件名保持一致，导致新版本跟老版本不一致的问题，推荐在 <code>js</code>，<code>css</code>里面的<code>references</code>里面携带 <code>md5</code>信息，例如 <code>a.&#123;md5&#125;.js</code>）</p>
</li>
<li><p><code>PULL</code></p>
<p>缓存更新不及时，数据一致性问题，可设置缓存的失效时间，可以达到最终一致性。如果用户对一致性要求比较高也可以使用 <code>?version=xxx</code> 的技术，也可以每次上传图片返回的 <code>url</code> 是不同的方式来代替版本号。</p>
</li>
</ul>
<p><code>CDN</code> 存储的资源复本指定过期时间，因而缓存图像文件可在一个小时，一个月有效的。任何资源缓存在 <code>CDN</code>上，是潜在历史版本，因为在源数据与副本之间总是有一个更新与传输的延迟。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172258043.png" alt="image-20231207172258043"></p>
<ul>
<li><p><code>Expires</code></p>
<p>即在 <code>HTTP</code> 头中指明具体失效的时间（<code>HTTP/1.0</code>）</p>
</li>
<li><p><code>Cache Control</code></p>
<p><code>max-age</code> 在 <code>HTTP</code> 头中按秒指定失效的时间，优先级高于 <code>Expires(HTTP/1.1)</code></p>
</li>
<li><p><code>Last-Modified / If-Modified-Since</code></p>
<p>文件最后一次修改的时间（精度是秒，<code>HTTP/1.0</code>），需要 <code>Cache-Control</code> 过期</p>
</li>
<li><p><code>Etag</code></p>
<p>当前资源在服务器的唯一标识（生成规则由服务器决定），优先级高于 <code>Last-Modified</code></p>
</li>
</ul>
<h2 id="静-x2F-动态-CDN-加速"><a href="#静-x2F-动态-CDN-加速" class="headerlink" title="静&#x2F;动态 CDN 加速"></a>静&#x2F;动态 <code>CDN</code> 加速</h2><h3 id="静态-CDN-加速"><a href="#静态-CDN-加速" class="headerlink" title="静态 CDN 加速"></a>静态 <code>CDN</code> 加速</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172704086.png" alt="image-20231207172704086"></p>
<p>地理位置分散的用户最小化接收静态内容所需的跳数，直接从附近边缘的缓存中获取内容。结果是显著降低了延迟和数据包丢失，加快了页面加载速度，并大大降低了原始基础架构的负载。</p>
<ul>
<li>静态域名非主域名（例如<code>api</code>域名和<code>主域名做区分</code>，避免同源策略携带<code>cookie</code>）</li>
<li>静态多域名和收敛（PC上多域名可以提高并发，移动端减少域名降低域名请求次数）</li>
<li>静态资源版本化管理（增量发布，避免缓存带来的影响）</li>
</ul>
<h3 id="动态-CDN-加速"><a href="#动态-CDN-加速" class="headerlink" title="动态 CDN 加速"></a>动态 <code>CDN</code> 加速</h3><p>也就是动态数据加速，数据发生变化的时候，通过<code>CDN</code>回源到核心机房，实现加速。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2023/12/image-20231207172843553.png" alt="image-20231207172843553"></p>
<ul>
<li><p><code>TCP</code>优化</p>
<p>设计算法来处理网络拥堵和包丢失，加快这些情况下的数据从 <code>CDN</code> 的恢复以及一些常见的 <code>TCP</code> 瓶颈</p>
</li>
<li><p><code>Route optimization</code></p>
<p>就是优化从源到用户端的请求的线路，以及可靠性，就是不断的测量计算得到更快更可靠的路线。</p>
</li>
<li><p><code>Connection management</code></p>
<p>就是边缘和源之间，包括 <code>CDN</code> 之前的线路，采用长连接，而不是每一个请求一个连接（避免源站链接数过多）</p>
</li>
<li><p><code>On-the-fly compression</code></p>
<p>就是数据在刚刚离开源的时候就进行压缩，可以缩短在整个网络之中的流通时间。</p>
</li>
<li><p><code>SSL offload</code></p>
<p>加速或者说减少一些安全检测，减少原服务器执行这种计算密集型的压力。（在边缘节点分摊）</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/c682.html" rel="prev" title="微服务可观察性之链路追踪">
                  <i class="fa fa-chevron-left"></i> 微服务可观察性之链路追踪
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/b09f.html" rel="next" title="多活">
                  多活 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
