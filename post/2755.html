<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="工作中使用到数据库时，为了更好的抽象数据库的使用，通常会通过ORM处理对象关系，比较常用的框架是GORM和XORM，这里总结一下GORM常用的一些内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="GORM学习笔记">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/2755.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="工作中使用到数据库时，为了更好的抽象数据库的使用，通常会通过ORM处理对象关系，比较常用的框架是GORM和XORM，这里总结一下GORM常用的一些内容。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-25T16:00:00.000Z">
<meta property="article:modified_time" content="2023-07-24T07:09:28.864Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="Golang, 微服务，数据库，中间件, 算法">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/2755.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/2755.html","path":"post/2755.html","title":"GORM学习笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>GORM学习笔记 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">1.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%AE%9E%E7%94%A8%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">3.</span> <span class="nav-text">简单实用的操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E6%97%A5%E5%BF%97"><span class="nav-number">3.1.</span> <span class="nav-text">打印日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="nav-number">3.2.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRUDL"><span class="nav-number">3.3.</span> <span class="nav-text">CRUDL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E"><span class="nav-number">3.3.1.</span> <span class="nav-text">新增</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.3.2.</span> <span class="nav-text">查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0"><span class="nav-number">3.3.3.</span> <span class="nav-text">更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">3.3.4.</span> <span class="nav-text">删除</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="nav-number">3.4.</span> <span class="nav-text">类型定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">3.5.</span> <span class="nav-text">多表操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#belongs-to"><span class="nav-number">3.5.1.</span> <span class="nav-text">belongs to</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#has-many"><span class="nav-number">3.5.2.</span> <span class="nav-text">has many</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#many-to-many"><span class="nav-number">3.5.3.</span> <span class="nav-text">many to many</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E5%90%8D"><span class="nav-number">3.6.</span> <span class="nav-text">自定义表名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%97"><span class="nav-number">3.7.</span> <span class="nav-text">自定义列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E9%9B%85%E7%9A%84%E5%88%86%E9%A1%B5"><span class="nav-number">3.8.</span> <span class="nav-text">优雅的分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.9.</span> <span class="nav-text">自定义数据结构</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/2755.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="GORM学习笔记 | 小夜时雨">
      <meta itemprop="description" content="工作中使用到数据库时，为了更好的抽象数据库的使用，通常会通过ORM处理对象关系，比较常用的框架是GORM和XORM，这里总结一下GORM常用的一些内容。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GORM学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-26 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-26T00:00:00+08:00">2022-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-24 15:09:28" itemprop="dateModified" datetime="2023-07-24T15:09:28+08:00">2023-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
    <span id="/post/2755.html" class="post-meta-item leancloud_visitors" data-flag-title="GORM学习笔记" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/post/2755.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="post/2755.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description">工作中使用到数据库时，为了更好的抽象数据库的使用，通常会通过ORM处理对象关系，比较常用的框架是GORM和XORM，这里总结一下GORM常用的一些内容。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>gorm官方有中文文档，但是实际使用时，还是有很多没有详细注意到的地方，这里做一个整理的笔记。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9nb3JtLmlvL3poX0NOL2RvY3Mv">GORM 指南<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>全功能 ORM</li>
<li>关联 (Has One，Has Many，Belongs To，Many To Many，多态，单表继承)</li>
<li>Create，Save，Update，Delete，Find 中钩子方法</li>
<li>支持 <code>Preload</code>、<code>Joins</code> 的预加载</li>
<li>事务，嵌套事务，Save Point，Rollback To Saved Point</li>
<li>Context、预编译模式、DryRun 模式</li>
<li>批量插入，FindInBatches，Find&#x2F;Create with Map，使用 SQL 表达式、Context Valuer 进行 CRUD</li>
<li>SQL 构建器，Upsert，数据库锁，Optimizer&#x2F;Index&#x2F;Comment Hint，命名参数，子查询</li>
<li>复合主键，索引，约束</li>
<li>Auto Migration</li>
<li>自定义 Logger</li>
<li>灵活的可扩展插件 API：Database Resolver（多数据库，读写分离）、Prometheus…</li>
<li>每个特性都经过了测试的重重考验</li>
<li>开发者友好</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get -u gorm.io/gorm</span><br></pre></td></tr></table></figure>

<p>安装驱动，连接对应数据库使用对应驱动</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sqlite</span></span><br><span class="line"><span class="keyword">go</span> get -u gorm.io/driver/sqlite</span><br><span class="line"><span class="comment">// mysql</span></span><br><span class="line"><span class="keyword">go</span> get -u gorm.io/driver/mysql</span><br><span class="line"><span class="comment">// sql server </span></span><br><span class="line"><span class="keyword">go</span> get -u gorm.io/driver/sqlserver</span><br><span class="line"><span class="comment">// pgsql </span></span><br><span class="line"><span class="keyword">go</span> get -u gorm.io/driver/postgres</span><br></pre></td></tr></table></figure>

<p>例如使用mysql</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情</span></span><br><span class="line">	db, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line">		DSN:                       <span class="string">&quot;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span>, <span class="comment">// DSN data source name</span></span><br><span class="line">    DefaultStringSize:         <span class="number">256</span>,                                                                           <span class="comment">// string 类型字段的默认长度</span></span><br><span class="line">		DisableDatetimePrecision:  <span class="literal">true</span>,                                                                          <span class="comment">// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持</span></span><br><span class="line">		DontSupportRenameIndex:    <span class="literal">true</span>,                                                                          <span class="comment">// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引</span></span><br><span class="line">		DontSupportRenameColumn:   <span class="literal">true</span>,                                                                          <span class="comment">// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列</span></span><br><span class="line">		SkipInitializeWithVersion: <span class="literal">false</span>,                                                                         <span class="comment">// 根据当前 MySQL 版本自动配置</span></span><br><span class="line">	&#125;), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>DSN</code>格式如下 <code>username:password@tcp(host:port)/db_name</code></p>
<p>GORM 使用 <span class="exturl" data-url="aHR0cHM6Ly9wa2cuZ28uZGV2L2RhdGFiYXNlL3NxbA==">database&#x2F;sql<i class="fa fa-external-link-alt"></i></span> 维护连接池</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sqlDB, err := db.DB()</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxIdleConns 设置空闲连接池中连接的最大数量</span></span><br><span class="line">sqlDB.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line">SetMaxIdleConns设置连接池中的最大闲置连接数。</span><br><span class="line">如果n大于最大开启连接数，则新的最大闲置连接数会减小到匹配最大开启连接数的限制。</span><br><span class="line">如果n &lt;= <span class="number">0</span>，不会保留闲置连接。</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxOpenConns 设置打开数据库连接的最大数量。</span></span><br><span class="line">sqlDB.SetMaxOpenConns(<span class="number">100</span>)</span><br><span class="line">SetMaxOpenConns设置与数据库建立连接的最大数目。</span><br><span class="line">如果n大于<span class="number">0</span>且小于最大闲置连接数，会将最大闲置连接数减小到匹配最大开启连接数的限制。</span><br><span class="line">如果n &lt;= <span class="number">0</span>，不会限制最大开启连接数，默认为<span class="number">0</span>（无限制）。</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetConnMaxLifetime 设置了连接可复用的最大时间。</span></span><br><span class="line">sqlDB.SetConnMaxLifetime(time.Hour)</span><br></pre></td></tr></table></figure>

<p>例如，当使用db没有返回连接</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	db, err := sql.Open(<span class="string">&quot;postgres&quot;</span>,</span><br><span class="line">		<span class="string">&quot;host=192.168.51.206 user=datatom password=db_password dbname=gorm port=30238 sslmode=disable TimeZone=Asia/Shanghai&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最大连接数5个</span></span><br><span class="line">	db.SetMaxOpenConns(<span class="number">5</span>)</span><br><span class="line">	err = db.Ping()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">    <span class="comment">// 使用事务，但是不提交，占用连接</span></span><br><span class="line">		_, err := db.Begin()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;conn &quot;</span>, i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行后，会卡在获取第六个连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conn  0</span><br><span class="line">conn  1</span><br><span class="line">conn  2</span><br><span class="line">conn  3</span><br><span class="line">conn  4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用<code>gorm</code>也是一样</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dsn := <span class="string">&quot;host=192.168.51.206 user=datatom password=db_password dbname=gorm port=30238 sslmode=disable TimeZone=Asia/Shanghai&quot;</span></span><br><span class="line">	newLogger := logger.New(</span><br><span class="line">		log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), <span class="comment">// io writer（日志输出的目标，前缀和日志包含的内容——译者注）</span></span><br><span class="line">		logger.Config&#123;</span><br><span class="line">			SlowThreshold:             time.Second, <span class="comment">// 慢 SQL 阈值</span></span><br><span class="line">			LogLevel:                  logger.Info, <span class="comment">// 日志级别</span></span><br><span class="line">			IgnoreRecordNotFoundError: <span class="literal">true</span>,        <span class="comment">// 忽略ErrRecordNotFound（记录未找到）错误</span></span><br><span class="line">			Colorful:                  <span class="literal">true</span>,        <span class="comment">// 禁用彩色打印</span></span><br><span class="line">		&#125;,</span><br><span class="line">	)</span><br><span class="line">	db, err := gorm.Open(postgres.Open(dsn), &amp;gorm.Config&#123;</span><br><span class="line">		Logger: newLogger,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	s, err := db.DB()</span><br><span class="line">	s.SetMaxOpenConns(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">		db.Begin()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;conn &quot;</span>, i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也会卡在获取第6个连接时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conn  0</span><br><span class="line">conn  1</span><br><span class="line">conn  2</span><br><span class="line">conn  3</span><br><span class="line">conn  4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="简单实用的操作"><a href="#简单实用的操作" class="headerlink" title="简单实用的操作"></a>简单实用的操作</h2><h3 id="打印日志"><a href="#打印日志" class="headerlink" title="打印日志"></a>打印日志</h3><p>打印日志的功能非常实用，既可以看到所有raw sql语句，也可以针对慢日志打印语句</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	newLogger := logger.New(</span><br><span class="line">		log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags), <span class="comment">// io writer（日志输出的目标，前缀和日志包含的内容——译者注）</span></span><br><span class="line">		logger.Config&#123;</span><br><span class="line">			SlowThreshold:             time.Second, <span class="comment">// 慢 SQL 阈值</span></span><br><span class="line">			LogLevel:                  logger.Info, <span class="comment">// 日志级别，Info等级下，会打印所有操作</span></span><br><span class="line">			IgnoreRecordNotFoundError: <span class="literal">true</span>,        <span class="comment">// 忽略ErrRecordNotFound（记录未找到）错误</span></span><br><span class="line">			Colorful:                  <span class="literal">true</span>,        <span class="comment">// 启用彩色打印</span></span><br><span class="line">		&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接使用newLogger的配置</span></span><br><span class="line">&amp;gorm.Config&#123;</span><br><span class="line">		Logger: newLogger,</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><p><code>gorm</code>可以通过迁移，将结构体映射成表</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err = db.AutoMigrate(User&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Fatal(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到日志如下，默认情况，在没有指定表名时，表名为全小写，驼峰体变更为下划线。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[1.399ms] [rows:-] SELECT DATABASE()</span><br><span class="line">[6.693ms] [rows:1] SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE &#x27;gorm%&#x27; ORDER BY SCHEMA_NAME=&#x27;gorm&#x27; DESC,SCHEMA_NAME limit 1</span><br><span class="line">[6.108ms] [rows:-] SELECT count(*) FROM information_schema.tables WHERE table_schema = &#x27;gorm&#x27; AND table_name = &#x27;users&#x27; AND table_type = &#x27;BASE TABLE&#x27;</span><br><span class="line">[34.257ms] [rows:0] CREATE TABLE `users` (`id` bigint unsigned AUTO_INCREMENT,`created_at` datetime NULL,`updated_at` datetime NULL,`deleted_at` datetime NULL,`name` varchar(256),PRIMARY KEY (`id`),INDEX `idx_users_deleted_at` (`deleted_at`))</span><br></pre></td></tr></table></figure>

<p>其中，gorm.Model 的定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Model <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">uint</span>           <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  CreatedAt time.Time</span><br><span class="line">  UpdatedAt time.Time</span><br><span class="line">  DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般通过结构体嵌套使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等效于</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">uint</span>           <span class="string">`gorm:&quot;primaryKey&quot;`</span> </span><br><span class="line">  CreatedAt time.Time</span><br><span class="line">  UpdatedAt time.Time</span><br><span class="line">  DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID           <span class="type">uint</span>						<span class="comment">// 默认情况下，会将id字段设置为主键</span></span><br><span class="line">	Name         <span class="type">string</span></span><br><span class="line">	Email        *<span class="type">string</span></span><br><span class="line">	Age          <span class="type">uint8</span></span><br><span class="line">	Birthday     *time.Time</span><br><span class="line">	MemberNumber sql.NullString</span><br><span class="line">	ActivatedAt  sql.NullTime</span><br><span class="line">	CreatedAt    time.Time</span><br><span class="line">	UpdatedAt    time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CRUDL"><a href="#CRUDL" class="headerlink" title="CRUDL"></a>CRUDL</h3><h4 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = db.Create(&amp;User&#123;	<span class="comment">// 传入指针，创建后，该类型的id会被更新</span></span><br><span class="line">		Name: <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line"><span class="comment">// [14.754ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`,`name`) VALUES (&#x27;2022-09-26 15:33:49.137&#x27;,&#x27;2022-09-26 15:33:49.137&#x27;,NULL,&#x27;mitaka&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>返回信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.ID             // 返回插入数据的主键</span><br><span class="line">result.Error        // 返回 error</span><br><span class="line">result.RowsAffected // 返回插入记录的条数</span><br></pre></td></tr></table></figure>

<p>批量插入</p>
<p>批量插入，可以传入一个切片的指针，插入的时候，是<strong>使用一条语句进行创建</strong>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = []User&#123;&#123;Name: <span class="string">&quot;mitaka1&quot;</span>&#125;, &#123;Name: <span class="string">&quot;mitaka2&quot;</span>&#125;, &#123;Name: <span class="string">&quot;mitaka3&quot;</span>&#125;&#125;</span><br><span class="line">db.Create(&amp;users)</span><br><span class="line"><span class="comment">// 单一sql语句</span></span><br><span class="line"><span class="comment">// [27.023ms] [rows:3] INSERT INTO `users` (`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`) VALUES (&#x27;mitaka1&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:38:22.93&#x27;,&#x27;2022-09-26 16:38:22.93&#x27;),(&#x27;mitaka2&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:38:22.93&#x27;,&#x27;2022-09-26 16:38:22.93&#x27;),(&#x27;mitaka3&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:38:22.93&#x27;,&#x27;2022-09-26 16:38:22.93&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">	fmt.Println(user.ID) <span class="comment">// 1,2,3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>CreateInBatches</code> 分批创建时，可以指定每批的数量（sql语句有长度限制，当数据量很大时，可以使用这个方式）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.CreateInBatches(&amp;users, <span class="number">2</span>)</span><br><span class="line"><span class="comment">// [3.693ms] [rows:2] INSERT INTO `users` (`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`) VALUES (&#x27;mitaka1&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:43:31.42&#x27;,&#x27;2022-09-26 16:43:31.42&#x27;),(&#x27;mitaka2&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:43:31.42&#x27;,&#x27;2022-09-26 16:43:31.42&#x27;)</span></span><br><span class="line"><span class="comment">// [3.590ms] [rows:1] INSERT INTO `users` (`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`) VALUES (&#x27;mitaka3&#x27;,NULL,0,NULL,NULL,NULL,&#x27;2022-09-26 16:43:31.423&#x27;,&#x27;2022-09-26 16:43:31.423&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>第一条语句创建2个，第二条创建1个。</p>
<p>创建钩子，GORM 允许用户定义的钩子有 <code>BeforeSave</code>, <code>BeforeCreate</code>, <code>AfterSave</code>, <code>AfterCreate</code> 创建记录时将调用这些钩子方法，</p>
<p>例如在创建之前，有一些逻辑判断，判断该用户是否有某些权限之类的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;invalid role&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>map</code>批量创建</p>
<p>GORM 支持根据 <code>map[string]interface&#123;&#125;</code> 和 <code>[]map[string]interface&#123;&#125;&#123;&#125;</code> 创建记录，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Create(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mitaka&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// [21.837ms] [rows:1] INSERT INTO `users` (`age`,`name`) VALUES (18,&#x27;mitaka&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// batch insert from `[]map[string]interface&#123;&#125;&#123;&#125;`</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Create([]<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	&#123;<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mitaka1&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">	&#123;<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mitaka2&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">20</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// [11.139ms] [rows:2] INSERT INTO `users` (`age`,`name`) VALUES (18,&#x27;mitaka1&#x27;),(20,&#x27;mitaka2&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>map创建适用于不知道表结构的情况</p>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>查询一个，根据主键查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">	db.First(&amp;User&#123;&#125;, <span class="number">1</span>)                    <span class="comment">// 根据主键查询</span></span><br><span class="line">	db.First(&amp;User&#123;&#125;, <span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;mitaka&quot;</span>) <span class="comment">// 根据条件查询</span></span><br><span class="line"><span class="comment">// [2.951ms] [rows:1] SELECT * FROM `users` WHERE `users`.`id` = 1 AND `users`.`deleted_at` IS NULL ORDER BY `users`.`id` LIMIT 1</span></span><br><span class="line"><span class="comment">// [2.618ms] [rows:1] SELECT * FROM `users` WHERE name = &#x27;mitaka&#x27; AND `users`.`deleted_at` IS NULL ORDER BY `users`.`id` LIMIT 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他查询</span></span><br><span class="line"><span class="comment">// 获取一条记录，没有指定排序字段</span></span><br><span class="line">db.Take(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取最后一条记录（主键降序）</span></span><br><span class="line">db.Last(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY id DESC LIMIT 1;</span></span><br></pre></td></tr></table></figure>

<p>返回值和错误处理</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result := db.First(&amp;user)</span><br><span class="line">result.RowsAffected <span class="comment">// 返回找到的记录数</span></span><br><span class="line">result.Error        <span class="comment">// returns error or nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查 ErrRecordNotFound 错误</span></span><br><span class="line">errors.Is(result.Error, gorm.ErrRecordNotFound)</span><br></pre></td></tr></table></figure>

<p>通过主键高级查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据主键查询多行</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Find(&amp;users, []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment">// [5.704ms] [rows:3] SELECT * FROM `users` WHERE `users`.`id` IN (1,2,3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果主键是字符串（例如像 uuid），查询将被写成这样：(ps：string类型的主键支持这种方式查询是新版功能，老版本会出现只截取整数类型的数值)</span></span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">db.First(&amp;user, <span class="string">&quot;id = ?&quot;</span>, <span class="string">&quot;1b74413f-f3b8-409f-ac47-e8c062e3472a&quot;</span>)</span><br><span class="line"><span class="comment">// [15.420ms] [rows:1] SELECT * FROM `users` WHERE id = &#x27;1b74413f-f3b8-409f-ac47-e8c062e3472a&#x27; ORDER BY `users`.`id` LIMIT 1</span></span><br></pre></td></tr></table></figure>

<p>条件查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Get all records</span><br><span class="line">result := db.Find(&amp;users)</span><br><span class="line">// SELECT * FROM users;</span><br><span class="line"></span><br><span class="line">// 返回值</span><br><span class="line">result.RowsAffected // returns found records count, equals `len(users)`</span><br><span class="line">result.Error        // returns error</span><br></pre></td></tr></table></figure>

<p>使用<code>string</code>的方式，（当没有设置<code>column</code>的<code>tag</code>时，搜索的字段名，大小写不敏感）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用string更新</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;mitaka&quot;</span>).Find(&amp;users) <span class="comment">// 通过users，获取到表名</span></span><br><span class="line"><span class="comment">// [5.784ms] [rows:1] SELECT * FROM `users` WHERE name = &#x27;mitaka&#x27;</span></span><br></pre></td></tr></table></figure>

<p>更多的用法如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get all matched records</span></span><br><span class="line">db.Where(<span class="string">&quot;name &lt;&gt; ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name &lt;&gt; &#x27;jinzhu&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IN</span></span><br><span class="line">db.Where(<span class="string">&quot;name IN ?&quot;</span>, []<span class="type">string</span>&#123;<span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;jinzhu 2&quot;</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name IN (&#x27;jinzhu&#x27;,&#x27;jinzhu 2&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LIKE</span></span><br><span class="line">db.Where(<span class="string">&quot;name LIKE ?&quot;</span>, <span class="string">&quot;%jin%&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name LIKE &#x27;%jin%&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AND</span></span><br><span class="line">db.Where(<span class="string">&quot;name = ? AND age &gt;= ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;22&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; AND age &gt;= 22;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Time</span></span><br><span class="line">db.Where(<span class="string">&quot;updated_at &gt; ?&quot;</span>, lastWeek).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE updated_at &gt; &#x27;2000-01-01 00:00:00&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BETWEEN</span></span><br><span class="line">db.Where(<span class="string">&quot;created_at BETWEEN ? AND ?&quot;</span>, lastWeek, today).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE created_at BETWEEN &#x27;2000-01-01 00:00:00&#x27; AND &#x27;2000-01-08 00:00:00&#x27;;</span></span><br></pre></td></tr></table></figure>

<p><strong>ps：使用结构体作为查询条件时，依然有零值问题。</strong></p>
<p>更多的查询方式和条件使用，详见官方文档：<span class="exturl" data-url="aHR0cHM6Ly9nb3JtLmlvL3poX0NOL2RvY3MvcXVlcnkuaHRtbA==">查询和高级查询<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><p>根据主键更新一个</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> u User</span><br><span class="line">db.First(&amp;u, <span class="number">1</span>) <span class="comment">// 根据主键查询</span></span><br><span class="line">db.Model(&amp;u).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;xiaoyeshiyu&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如果<code>Model</code>中<strong>不包含主键</strong>(只能接受主键条件)，则需要条件查询，不然会出现报错，<code>WHERE conditions required</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;mitaka&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>通过<code>Where</code>条件更新</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Where(User&#123;Name: <span class="string">&quot;xiaoyeshiyu&quot;</span>&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;mitaka&quot;</span>)</span><br><span class="line"><span class="comment">// [5.208ms] [rows:0] UPDATE `users` SET `name`=&#x27;mitaka&#x27;,`updated_at`=&#x27;2022-09-26 15:33:49.157&#x27; WHERE `users`.`name` = &#x27;xiaoyeshiyu&#x27; AND `users`.`deleted_at` IS NULL</span></span><br></pre></td></tr></table></figure>

<p>注意，更新可以通过<code>map[string]interface&#123;&#125;</code>更新多个，也可以通过结构体更新，其中，结构体更新仅更新非零字段。（也就是零值不更新）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;u).Updates(User&#123;Name: <span class="string">&quot;mitaka&quot;</span>, Age: <span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">// [13.125ms] [rows:0] UPDATE `users` SET `updated_at`=&#x27;2022-09-26 15:49:08.27&#x27;,`name`=&#x27;mitaka&#x27; WHERE `users`.`deleted_at` IS NULL AND `id` = 1</span></span><br></pre></td></tr></table></figure>

<p>可以看到，没有更新Age的语法，此时可以通过<code>map[string]interface&#123;&#125;</code>更新</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;u).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	<span class="string">&quot;name&quot;</span>: <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">	<span class="string">&quot;age&quot;</span>:  <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// [5.152ms] [rows:0] UPDATE `users` SET `age`=0,`name`=&#x27;mitaka&#x27;,`updated_at`=&#x27;2022-09-26 15:49:37.67&#x27; WHERE `users`.`deleted_at` IS NULL AND `id` = 1</span></span><br></pre></td></tr></table></figure>

<p>也可以使用<code>Select</code>强制更新（使用select时，需要指定所有需要更新的字段）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;u).Select(&quot;name&quot;, &quot;age&quot;).Updates(User&#123;Name: &quot;mitaka&quot;, Age: 0&#125;)</span><br><span class="line">// [5.838ms] [rows:0] UPDATE `users` SET `updated_at`=&#x27;2022-09-26 15:51:47.907&#x27;,`name`=&#x27;mitaka&#x27;,`age`=0 WHERE `users`.`deleted_at` IS NULL AND `id` = 1</span><br></pre></td></tr></table></figure>

<p>还可以通过<code>sql</code>中的<code>NullInt64</code>类型实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age  sql.NullInt64</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;u).Updates(User&#123;Name: <span class="string">&quot;mitaka&quot;</span>, Age: sql.NullInt64&#123;</span><br><span class="line">	Int64: <span class="number">0</span>,</span><br><span class="line">	Valid: <span class="literal">true</span>, <span class="comment">// true为更新，false不更新</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"><span class="comment">// [4.523ms] [rows:0] UPDATE `users` SET `updated_at`=&#x27;2022-09-26 15:56:51.534&#x27;,`name`=&#x27;mitaka&#x27;,`age`=0 WHERE `users`.`deleted_at` IS NULL AND `id` = 1</span></span><br></pre></td></tr></table></figure>

<p>另外，还可以将字段设置为指针类型，也可以更新零值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> empty <span class="type">string</span></span><br><span class="line">user := User&#123;Name: <span class="string">&quot;mitaka&quot;</span>, Email: &amp;empty&#125;</span><br><span class="line">db.Model(User&#123;ID: <span class="number">1</span>&#125;).Updates(&amp;user)</span><br><span class="line"><span class="comment">// [16.577ms] [rows:1] UPDATE `users` SET `name`=&#x27;mitaka&#x27;,`email`=&#x27;&#x27;,`updated_at`=&#x27;2022-09-26 17:24:38.672&#x27; WHERE `id` = 1</span></span><br></pre></td></tr></table></figure>

<p>通过save保存所有字段（包括零值），save是一个创建和更新语句</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有主键</span></span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">user.Name = <span class="string">&quot;mitaka&quot;</span></span><br><span class="line">user.Age = <span class="number">28</span></span><br><span class="line">db.Save(&amp;user)</span><br><span class="line"><span class="comment">// [15.861ms] [rows:1] INSERT INTO `users` (`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`) VALUES (&#x27;mitaka&#x27;,NULL,28,NULL,NULL,NULL,&#x27;2022-09-26 17:13:36.619&#x27;,&#x27;2022-09-26 17:13:36.619&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 有主键</span></span><br><span class="line">user.ID = <span class="number">2</span></span><br><span class="line">db.Save(&amp;user)</span><br><span class="line"><span class="comment">// [12.707ms] [rows:1] UPDATE `users` SET `name`=&#x27;mitaka&#x27;,`email`=NULL,`age`=28,`birthday`=NULL,`member_number`=NULL,`activated_at`=NULL,`created_at`=&#x27;2022-09-26 17:15:03.18&#x27;,`updated_at`=&#x27;2022-09-26 17:15:03.196&#x27; WHERE `id` = 2</span></span><br></pre></td></tr></table></figure>

<h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><p>根据主键删除（不带主键的话，会触发批量删除）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	db.Delete(&amp;u, 1)</span><br><span class="line">// [10.681ms] [rows:1] UPDATE `users` SET `deleted_at`=&#x27;2022-09-26 15:37:42.275&#x27; WHERE `users`.`id` = 1 AND `users`.`id` = 1 AND `users`.`deleted_at` IS NULL</span><br></pre></td></tr></table></figure>

<p>不带主键，带条件的批量删除</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Where(User&#123;Name: <span class="string">&quot;mitaka&quot;</span>&#125;).Delete(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// [8.132ms] [rows:1] UPDATE `users` SET `deleted_at`=&#x27;2022-09-26 15:40:25.535&#x27; WHERE `users`.`name` = &#x27;mitaka&#x27; AND `users`.`deleted_at` IS NULL</span></span><br></pre></td></tr></table></figure>

<p>如果您的模型包含了一个 <code>gorm.deletedat</code> 字段（<code>gorm.Model</code> 已经包含了该字段)，它将自动获得软删除的能力！</p>
<p>如果在没有任何条件的情况下执行批量删除，GORM 不会执行该操作，并返回 <code>ErrMissingWhereClause </code>错误</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;Name: <span class="string">&quot;mitaka&quot;</span>&#125;</span><br><span class="line">db.Delete(&amp;user)</span><br><span class="line"><span class="comment">// WHERE conditions required</span></span><br><span class="line"><span class="comment">// [2.004ms] [rows:0] DELETE FROM `users`</span></span><br></pre></td></tr></table></figure>

<p>获取被软删除的记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Unscoped().Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;mitaka&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// [2.967ms] [rows:5] SELECT * FROM `users` WHERE name = &#x27;mitaka&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="类型定义"><a href="#类型定义" class="headerlink" title="类型定义"></a>类型定义</h3><p>GORM 倾向于约定，而不是配置。默认情况下，GORM 使用 <code>ID</code> 作为主键，使用结构体名的 <code>蛇形复数</code> 作为表名，字段名的 <code>蛇形</code> 作为列名，并使用 <code>CreatedAt</code>、<code>UpdatedAt</code> 字段追踪创建、更新时间。（例如<code>User</code>结构体，迁移后的表名为<code>users</code>，如果是<code>UserInfo</code>，则是<code>user_infos</code>）</p>
<p>自定义配置，通过标签配置</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name <span class="type">string</span> <span class="string">`gorm:&quot;column:my_name&quot;`</span></span><br><span class="line">	Age  sql.NullInt64</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了<code>column</code>，还有其他的标签如下：tag 名大小写不敏感，但建议使用 <code>camelCase</code> 风格</p>
<table>
<thead>
<tr>
<th align="left">标签名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">column</td>
<td align="left">指定 db 列名</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">列数据类型，推荐使用兼容性好的通用类型，例如：所有数据库都支持 bool、int、uint、float、string、time、bytes 并且可以和其他标签一起使用，例如：<code>not null</code>、<code>size</code>, <code>autoIncrement</code>… 像 <code>varbinary(8)</code> 这样指定数据库数据类型也是支持的。在使用指定数据库数据类型时，它需要是完整的数据库数据类型，如：<code>MEDIUMINT UNSIGNED not NULL AUTO_INCREMENT</code></td>
</tr>
<tr>
<td align="left">serializer</td>
<td align="left">指定将数据序列化或反序列化到数据库中的序列化器, 例如: <code>serializer:json/gob/unixtime</code></td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">定义列数据类型的大小或长度，例如 <code>size: 256</code></td>
</tr>
<tr>
<td align="left">primaryKey</td>
<td align="left">将列定义为主键</td>
</tr>
<tr>
<td align="left">unique</td>
<td align="left">将列定义为唯一键</td>
</tr>
<tr>
<td align="left">default</td>
<td align="left">定义列的默认值</td>
</tr>
<tr>
<td align="left">precision</td>
<td align="left">specifies column precision，精度</td>
</tr>
<tr>
<td align="left">scale</td>
<td align="left">specifies column scale，列大小</td>
</tr>
<tr>
<td align="left">not null</td>
<td align="left">specifies column as NOT NULL，非空</td>
</tr>
<tr>
<td align="left">autoIncrement</td>
<td align="left">specifies column auto incrementable，自增</td>
</tr>
<tr>
<td align="left">autoIncrementIncrement</td>
<td align="left">auto increment step, controls the interval between successive column values，自增增量</td>
</tr>
<tr>
<td align="left">embedded</td>
<td align="left">embed the field，嵌入的结构体</td>
</tr>
<tr>
<td align="left">embeddedPrefix</td>
<td align="left">column name prefix for embedded fields，嵌入结构体的前缀</td>
</tr>
<tr>
<td align="left">autoCreateTime</td>
<td align="left">track current time when creating, for <code>int</code> fields, it will track unix seconds, use value <code>nano</code>&#x2F;<code>milli</code> to track unix nano&#x2F;milli seconds, e.g: <code>autoCreateTime:nano</code>，自动创建时间，如果是int类型，则是跟踪unix秒</td>
</tr>
<tr>
<td align="left">autoUpdateTime</td>
<td align="left">track current time when creating&#x2F;updating, for <code>int</code> fields, it will track unix seconds, use value <code>nano</code>&#x2F;<code>milli</code> to track unix nano&#x2F;milli seconds, e.g: <code>autoUpdateTime:milli</code>，自动更新时间</td>
</tr>
<tr>
<td align="left">index</td>
<td align="left">create index with options, use same name for multiple fields creates composite indexes, refer <span class="exturl" data-url="aHR0cHM6Ly9nb3JtLmlvL3poX0NOL2RvY3MvaW5kZXhlcy5odG1s">Indexes<i class="fa fa-external-link-alt"></i></span> for details，索引</td>
</tr>
<tr>
<td align="left">uniqueIndex</td>
<td align="left">same as <code>index</code>, but create uniqued index，唯一索引</td>
</tr>
<tr>
<td align="left">check</td>
<td align="left">creates check constraint, eg: <code>check:age &gt; 13</code>, refer <span class="exturl" data-url="aHR0cHM6Ly9nb3JtLmlvL3poX0NOL2RvY3MvY29uc3RyYWludHMuaHRtbA==">Constraints<i class="fa fa-external-link-alt"></i></span>，字段检查</td>
</tr>
<tr>
<td align="left">&lt;-</td>
<td align="left">set field’s write permission, <code>&lt;-:create</code> create-only field, <code>&lt;-:update</code> update-only field, <code>&lt;-:false</code> no write permission, <code>&lt;-</code> create and update permission，设置写入和更新权限</td>
</tr>
<tr>
<td align="left">-&gt;</td>
<td align="left">set field’s read permission, <code>-&gt;:false</code> no read permission，设置读取权限</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">ignore this field, <code>-</code> no read&#x2F;write permission, <code>-:migration</code> no migrate permission, <code>-:all</code> no read&#x2F;write&#x2F;migrate permission，忽略字段</td>
</tr>
<tr>
<td align="left">comment</td>
<td align="left">add comment for field when migration，添加注释</td>
</tr>
</tbody></table>
<p>多个标签，通过<code>;</code>隔开</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name <span class="type">string</span> <span class="string">`gorm:&quot;column:my_name;type:varchar(50)&quot;`</span></span><br><span class="line">	Age  sql.NullInt64</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多表操作"><a href="#多表操作" class="headerlink" title="多表操作"></a>多表操作</h3><p>多表操作适用于需要表关联的场景，例如<code>belongs to</code> （一对一属于，能有多个A属于一个B），<code>has one</code>（一对一，一个A只有一个B），<code>has many</code> （一对多，一个A拥有多个B），<code>Many to Many</code>（多对多，一个A属于多个B，一个B有多个A）。</p>
<h4 id="belongs-to"><a href="#belongs-to" class="headerlink" title="belongs to"></a><code>belongs to</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `User` 属于 `Company`，`CompanyID` 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name      <span class="type">string</span></span><br><span class="line">	CompanyID <span class="type">int</span></span><br><span class="line">	Company   Company</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID   <span class="type">int</span></span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建表</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时新建users表和companies表</span></span><br><span class="line">db.AutoMigrate(User&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>创建时，则需要确保外键存在，因此，创建时，会优先创建Company，再创建User</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">	Name: <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">	Company: Company&#123;</span><br><span class="line">		Name: <span class="string">&quot;x&quot;</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;user)</span><br><span class="line"><span class="comment">// [13.027ms] [rows:1] INSERT INTO `companies` (`name`) VALUES (&#x27;x&#x27;) ON DUPLICATE KEY UPDATE `id`=`id`</span></span><br><span class="line"><span class="comment">// [25.259ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`,`name`,`company_id`) VALUES (&#x27;2022-09-26 17:45:32.484&#x27;,&#x27;2022-09-26 17:45:32.484&#x27;,NULL,&#x27;mitaka&#x27;,1)</span></span><br></pre></td></tr></table></figure>

<p>当外键存在时，可以直接通过id指定</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">	Name:      <span class="string">&quot;mitaka01&quot;</span>,</span><br><span class="line">	CompanyID: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;user)</span><br><span class="line"><span class="comment">//	[9.861ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`,`name`,`company_id`) VALUES (&#x27;2022-09-26 17:47:17.531&#x27;,&#x27;2022-09-26 17:47:17.531&#x27;,NULL,&#x27;mitaka01&#x27;,1)</span></span><br></pre></td></tr></table></figure>

<p>关联查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">db.Preload(<span class="string">&quot;Company&quot;</span>).Find(&amp;user, <span class="number">1</span>) <span class="comment">// 放入关联的字段名称</span></span><br><span class="line"><span class="comment">// [4.732ms] [rows:1] SELECT * FROM `companies` WHERE `companies`.`id` = 1</span></span><br><span class="line"><span class="comment">// [10.439ms] [rows:1] SELECT * FROM `users` WHERE `users`.`id` = 1 AND `users`.`deleted_at` IS NULL</span></span><br></pre></td></tr></table></figure>

<p>或者通过<code>join</code>方法，相比之下，<code>join</code>是使用的一条语句，使用<code>join</code>操作</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Joins(<span class="string">&quot;Company&quot;</span>).Find(&amp;user, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// [4.426ms] [rows:1] SELECT `users`.`id`,`users`.`created_at`,`users`.`updated_at`,`users`.`deleted_at`,`users`.`name`,`users`.`company_id`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` `Company` ON `users`.`company_id` = `Company`.`id` WHERE `users`.`id` = 1 AND `users`.`deleted_at` IS NULL</span></span><br></pre></td></tr></table></figure>

<p>重写外键：默认情况下，外键的名字，使用拥有者的类型名称加上表的主键的字段名字，例如</p>
<p><code>CompanyID</code>是名称，<code>int</code>是类型。此时如果改成使用其他字段，例如使用<code>Company</code>的<code>Name</code>字段作为外键</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  CompanyID <span class="type">string</span>	<span class="comment">// 字段类型改为string</span></span><br><span class="line">  Company   Company <span class="string">`gorm:&quot;references:Name&quot;`</span> <span class="comment">// 使用 Name 作为引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="has-many"><a href="#has-many" class="headerlink" title="has many"></a><code>has many</code></h4><p><code>has many</code> <code>与belongs to</code>在数据库存储上是一样的，只是相对于不同的角度。例如，在<code>User</code>的角度，就是<code>belongs to</code>一个<code>Company</code>，那么在<code>Company</code>的角度，就是一个<code>Company has many</code> 多个<code>User</code>。</p>
<p>例如一个用户有多个信用卡，一个信用卡只属于一个用户</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 有多张 CreditCard，UserID 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span>				<span class="comment">// 这个UserID就是User表中的ID字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建表，此时需要创建两张表，由于没有特殊指定外键，无法通过<code>UserID</code>字段获取对应结构体字段，因此无法通过只创建<code>CreditCard</code>创建两张表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.AutoMigrate(User&#123;&#125;, CreditCard&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>创建和检索</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">u := User&#123;</span><br><span class="line">	CreditCards: []CreditCard&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			Number: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			Number: <span class="string">&quot;b&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			Number: <span class="string">&quot;c&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;u)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Model(&amp;User&#123;&#125;).Preload(<span class="string">&quot;CreditCards&quot;</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<p>重写外键</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard <span class="string">`gorm:&quot;foreignKey:UserRefer&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreditCard 表的外键字段是UserRefer，指向User的ID字段</span></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number    <span class="type">string</span></span><br><span class="line">  UserRefer <span class="type">uint</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ps：一般在高并发的系统中，不会使用外键约束，这是由于外键影响性能。一般通过业务层面的代码确保数据完整性，而不是首选外键。</p>
<p>通过<code>user</code>获取<code>CreditCards</code>的查询方式（与<code>belongs to</code>相同的是语法，<code>Preload</code>外键字段，不同的是<code>belongs to</code>用在这里，是通过<code>CreditCards</code>获取所属的<code>User</code>）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">db.Model(&amp;User&#123;&#125;).Preload(<span class="string">&quot;CreditCards&quot;</span>).First(&amp;user)</span><br><span class="line"><span class="keyword">for</span> _, cre := <span class="keyword">range</span> user.CreditCards &#123;</span><br><span class="line">	fmt.Println(cre.UserRefer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="many-to-many"><a href="#many-to-many" class="headerlink" title="many to many"></a><code>many to many</code></h4><p>例如，您的应用包含了 <code>user</code> 和 <code>language</code>，且一个 <code>user</code> 可以说多种 <code>language</code>，多个 <code>user</code> 也可以说一种 <code>language</code>。</p>
<p>这种情况下，无法通过<code>user</code>的外键指向<code>language</code>或者通过<code>language</code>的外键指向<code>user</code>，这种情况下，一般使用第三张表存储两者之间的关系。<code>gorm</code>中，通过<code>many2many</code>创建第三张关联表。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.AutoMigrate(User&#123;&#125;, Language&#123;&#125;)</span><br><span class="line"><span class="comment">// [17.745ms] [rows:0] CREATE TABLE `user_languages` (`user_id` bigint unsigned,`language_id` bigint unsigned,PRIMARY KEY (`user_id`,`language_id`),CONSTRAINT `fk_user_languages_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),CONSTRAINT `fk_user_languages_language` FOREIGN KEY (`language_id`) REFERENCES `languages`(`id`))</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">language1 := Language&#123;Name: <span class="string">&quot;go&quot;</span>&#125;</span><br><span class="line">language2 := Language&#123;Name: <span class="string">&quot;python&quot;</span>&#125;</span><br><span class="line">language3 := Language&#123;Name: <span class="string">&quot;php&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">u1 := User&#123;</span><br><span class="line">	Languages: []Language&#123;language1, language2&#125;,</span><br><span class="line">&#125;</span><br><span class="line">u2 := User&#123;</span><br><span class="line">	Languages: []Language&#123;language3, language2&#125;,</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;u1)</span><br><span class="line"><span class="comment">// [3.321ms] [rows:2] INSERT INTO `languages` (`created_at`,`updated_at`,`deleted_at`,`name`) VALUES (&#x27;2022-09-27 09:38:15.442&#x27;,&#x27;2022-09-27 09:38:15.442&#x27;,NULL,&#x27;go&#x27;),(&#x27;2022-09-27 09:38:15.442&#x27;,&#x27;2022-09-27 09:38:15.442&#x27;,NULL,&#x27;python&#x27;) ON DUPLICATE KEY UPDATE `id`=`id`</span></span><br><span class="line"><span class="comment">// [4.177ms] [rows:2] INSERT INTO `user_languages` (`user_id`,`language_id`) VALUES (1,1),(1,2) ON DUPLICATE KEY UPDATE `user_id`=`user_id`</span></span><br><span class="line"><span class="comment">// [20.401ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`) VALUES (&#x27;2022-09-27 09:38:15.435&#x27;,&#x27;2022-09-27 09:38:15.435&#x27;,NULL)</span></span><br><span class="line">db.Create(&amp;u2)</span><br><span class="line"><span class="comment">// [2.758ms] [rows:2] INSERT INTO `languages` (`created_at`,`updated_at`,`deleted_at`,`name`) VALUES (&#x27;2022-09-27 09:38:15.458&#x27;,&#x27;2022-09-27 09:38:15.458&#x27;,NULL,&#x27;php&#x27;),(&#x27;2022-09-27 09:38:15.458&#x27;,&#x27;2022-09-27 09:38:15.458&#x27;,NULL,&#x27;python&#x27;) ON DUPLICATE KEY UPDATE `id`=`id`</span></span><br><span class="line"><span class="comment">// [3.019ms] [rows:2] INSERT INTO `user_languages` (`user_id`,`language_id`) VALUES (2,3),(2,4) ON DUPLICATE KEY UPDATE `user_id`=`user_id`</span></span><br><span class="line"><span class="comment">// [14.102ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`) VALUES (&#x27;2022-09-27 09:38:15.456&#x27;,&#x27;2022-09-27 09:38:15.456&#x27;,NULL)</span></span><br></pre></td></tr></table></figure>

<p>获取</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">u := User&#123;&#125;</span><br><span class="line">db.Preload(<span class="string">&quot;Languages&quot;</span>).Find(&amp;u, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// [4.432ms] [rows:2] SELECT * FROM `user_languages` WHERE `user_languages`.`user_id` = 1</span></span><br><span class="line"><span class="comment">// [4.026ms] [rows:2] SELECT * FROM `languages` WHERE `languages`.`id` IN (1,2) AND `languages`.`deleted_at` IS NULL</span></span><br><span class="line"><span class="comment">// [13.775ms] [rows:1] SELECT * FROM `users` WHERE `users`.`id` = 1 AND `users`.`deleted_at` IS NULL</span></span><br><span class="line"><span class="keyword">for</span> _, l := <span class="keyword">range</span> u.Languages &#123;</span><br><span class="line">	fmt.Println(l.Name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反向引用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Languages []*Language <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Users []*User <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这种反向引用的方式，<code>user</code>获取<code>language</code>，则通过<code>Preload Languages</code>，当然，也可以通过<code>language</code>获取<code>user</code>，通过<code>Preload Users</code></p>
<p>关联模式，关联模式是通过一条语句，通过<code>join</code>实现关联</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> u User</span><br><span class="line">u.ID = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> l []*Language</span><br><span class="line">db.Model(&amp;u).Association(<span class="string">&quot;Languages&quot;</span>).Find(&amp;l)</span><br><span class="line"><span class="comment">// [6.577ms] [rows:2] SELECT `languages`.`id`,`languages`.`created_at`,`languages`.`updated_at`,`languages`.`deleted_at`,`languages`.`name` FROM `languages` JOIN `user_languages` ON `user_languages`.`language_id` = `languages`.`id` AND `user_languages`.`user_id` = 1 WHERE `languages`.`deleted_at` IS NULL</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义表名"><a href="#自定义表名" class="headerlink" title="自定义表名"></a>自定义表名</h3><p>通过给结构体添加<code>TableName</code>方法自定义表名</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(User)</span></span> TableName() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;myUser&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加表前缀，在配置中指定命名规则</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;gorm.Config&#123;</span><br><span class="line">		Logger: newLogger,</span><br><span class="line">		NamingStrategy: schema.NamingStrategy&#123;</span><br><span class="line">			TablePrefix: <span class="string">&quot;my_&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ps：当既有配置，也有TableName函数时，配置不会生效。</p>
<h3 id="自定义列"><a href="#自定义列" class="headerlink" title="自定义列"></a>自定义列</h3><p>例如自定义一个<code>time.time</code>属性的列，在创建时自动增加创建时间</p>
<p>方法1、通过钩子，BeforeCreate、BeforeUpdate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Atime time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">	u.Atime = time.Now()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	u := User&#123;</span><br><span class="line">		Name: <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	db.Create(&amp;u)</span><br><span class="line">	<span class="comment">// [12.566ms] [rows:1] INSERT INTO `myUser` (`created_at`,`updated_at`,`deleted_at`,`name`,`atime`) VALUES (&#x27;2022-09-27 10:24:25.151&#x27;,&#x27;2022-09-27 10:24:25.151&#x27;,NULL,&#x27;mitaka&#x27;,&#x27;2022-09-27 10:24:25.151&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>需要注意，此时如果没有<code>BeforeCreate</code>的钩子创建时间，保存会出现报错：<code>Error 1292: Incorrect datetime value: &#39;0000-00-00&#39; for column &#39;atime&#39; at row 1</code>，此时可以将Atime字段类型设置为 <code>sql.NullTime</code></p>
<p>方法2、使用<code>gorm</code>自带的时间戳，字段名称改为<code>CreatedAt</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name      <span class="type">string</span></span><br><span class="line">	CreatedAt time.Time </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以将这个字段设置为指针类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Atime *time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优雅的分页"><a href="#优雅的分页" class="headerlink" title="优雅的分页"></a>优雅的分页</h3><p>通过一个功能函数封装分页的功能</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Paginate</span><span class="params">(page, pageSize <span class="type">int</span>)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">		<span class="keyword">if</span> page == <span class="number">0</span> &#123;</span><br><span class="line">			page = <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> pageSize &gt; <span class="number">100</span>:</span><br><span class="line">			pageSize = <span class="number">100</span></span><br><span class="line">		<span class="keyword">case</span> pageSize &lt;= <span class="number">0</span>:</span><br><span class="line">			pageSize = <span class="number">10</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		offset := (page - <span class="number">1</span>) * pageSize</span><br><span class="line">		<span class="keyword">return</span> db.Offset(offset).Limit(pageSize)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Scopes(Paginate(page, pageSize)).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h3 id="自定义数据结构"><a href="#自定义数据结构" class="headerlink" title="自定义数据结构"></a>自定义数据结构</h3><p>在数据库中，无法直接存储切片或者数组，此时需要将切片或者数组转义成字符串，而gORM没有默认支持切片的转义，因此需要针对这种结构体类型，实现自定义转义和读取方式。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Images []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 sql.Scanner 接口，Scan 将 value 扫描至 Jsonb</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *Images)</span></span> Scan(value <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> json.Unmarshal(value.([]<span class="type">byte</span>), i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 driver.Valuer 接口，Value 返回 json value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Images)</span></span> Value() (driver.Value, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> json.Marshal(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际的数据结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User1 <span class="keyword">struct</span> &#123;</span><br><span class="line">	gorm.Model</span><br><span class="line"></span><br><span class="line">	ID           <span class="type">uint</span></span><br><span class="line">	Name         <span class="type">string</span></span><br><span class="line">	Email        *<span class="type">string</span></span><br><span class="line">	Age          <span class="type">uint8</span></span><br><span class="line">	Birthday     *time.Time</span><br><span class="line">	MemberNumber sql.NullString</span><br><span class="line">	ActivatedAt  sql.NullTime</span><br><span class="line">	CreatedAt    time.Time</span><br><span class="line">	UpdatedAt    time.Time</span><br><span class="line">	Deleted      gorm.DeletedAt</span><br><span class="line">	Images       Images</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user1` (</span><br><span class="line">  `id` <span class="type">bigint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `created_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `updated_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `deleted_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` tinyint unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `birthday` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `member_number` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `activated_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `deleted` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `images` longblob,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_user1_deleted_at` (`deleted_at`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>

<p><code>images</code>是<code>longblob</code>结构。</p>
<p>这里介绍一个工具，<span class="exturl" data-url="aHR0cHM6Ly9wcmludGxvdmUuY24vdG9vbHMvc3FsMmdvcm0=">SQL转GORM Model<i class="fa fa-external-link-alt"></i></span>，在开发过程中，可以先定义好表结构，然后拷贝SQL语句，转换成结构体。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/c867.html" rel="prev" title="微服务开发之gRPC">
                  <i class="fa fa-chevron-left"></i> 微服务开发之gRPC
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/8e69.html" rel="next" title="使用md5盐值加密存储密码">
                  使用md5盐值加密存储密码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.3/algoliasearch-lite.umd.js" integrity="sha256-dyJcbGuYfdzNfifkHxYVd/rzeR6SLLcDFYEidcybldM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.51.1/instantsearch.production.min.js" integrity="sha256-y6I4MY/blLHk4a7G33zp97DcnBFRY2iMId4FObo8toI=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
