<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="分布式键值存储系统 etcd 在 Kubernetes 架构中的关键作用。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 控制平面组件：etcd">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/387e.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="分布式键值存储系统 etcd 在 Kubernetes 架构中的关键作用。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111145201033.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111145603647.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111151519295.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111152850124.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111160127124.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111162008166.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112175505965.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112181201356.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112141506850.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142212166.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142419159.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142636405.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112143519067.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112151247242.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112151539027.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152340147.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152444763.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152601108.png">
<meta property="article:published_time" content="2024-01-09T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-24T05:55:00.370Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111145201033.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/387e.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/387e.html","path":"post/387e.html","title":"Kubernetes 控制平面组件：etcd"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes 控制平面组件：etcd | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#etcd-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">etcd 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.</span> <span class="nav-text">主要功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.2.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E5%80%BC%E5%AF%B9%E5%AD%98%E5%82%A8"><span class="nav-number">1.3.</span> <span class="nav-text">键值对存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-number">1.4.</span> <span class="nav-text">服务注册与发现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85"><span class="nav-number">1.5.</span> <span class="nav-text">消息发布与订阅</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Etcd-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-number">1.6.</span> <span class="nav-text">Etcd 的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Member-list"><span class="nav-number">1.6.1.</span> <span class="nav-text">Member list</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">1.6.2.</span> <span class="nav-text">常用操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%EF%BC%9A-TTL-CAS"><span class="nav-number">1.7.</span> <span class="nav-text">核心： TTL &amp; CAS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Raft-%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.</span> <span class="nav-text">Raft 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Raft-%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%A7%88"><span class="nav-number">2.1.</span> <span class="nav-text">Raft 协议概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%A7%A3-Raft-%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.2.</span> <span class="nav-text">理解 Raft 协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#learner"><span class="nav-number">2.3.</span> <span class="nav-text">learner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E5%9F%BA%E4%BA%8E-Raft-%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">2.4.</span> <span class="nav-text">etcd 基于 Raft 的一致性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6"><span class="nav-number">2.5.</span> <span class="nav-text">日志复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">2.6.</span> <span class="nav-text">安全性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86"><span class="nav-number">2.7.</span> <span class="nav-text">失效处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wal-%E6%97%A5%E5%BF%97"><span class="nav-number">2.8.</span> <span class="nav-text">wal 日志</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#etcd-%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">etcd 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-v3-%E5%AD%98%E5%82%A8%EF%BC%8CWatch-%E4%BB%A5%E5%8F%8A%E8%BF%87%E6%9C%9F%E6%9C%BA%E5%88%B6"><span class="nav-number">3.1.</span> <span class="nav-text">etcd v3 存储，Watch 以及过期机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">3.1.1.</span> <span class="nav-text">存储机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">3.1.2.</span> <span class="nav-text">etcd 写入数据的流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd-%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">3.1.3.</span> <span class="nav-text">etcd 数据一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Watch%E6%9C%BA%E5%88%B6"><span class="nav-number">3.1.4.</span> <span class="nav-text">Watch机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#watch-%E7%BB%83%E4%B9%A0"><span class="nav-number">3.1.5.</span> <span class="nav-text">watch 练习</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E9%87%8D%E8%A6%81%E5%8F%82%E6%95%B0"><span class="nav-number">3.2.</span> <span class="nav-text">etcd 重要参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%81%BE%E5%A4%87"><span class="nav-number">3.3.</span> <span class="nav-text">灾备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E9%87%8F%E7%AE%A1%E7%90%86"><span class="nav-number">3.4.</span> <span class="nav-text">容量管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ALarm-Disarm-ALarm"><span class="nav-number">3.5.</span> <span class="nav-text">ALarm &amp; Disarm ALarm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A2%8E%E7%89%87%E6%95%B4%E7%90%86"><span class="nav-number">3.6.</span> <span class="nav-text">碎片整理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8-etcd-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">3.7.</span> <span class="nav-text">高可用 etcd 解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Etcd-Operator"><span class="nav-number">3.7.1.</span> <span class="nav-text">Etcd-Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-Bitnami-%E5%AE%89%E8%A3%85-etcd-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="nav-number">3.7.2.</span> <span class="nav-text">基于 Bitnami 安装 etcd 高可用集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E4%BD%BF%E7%94%A8-etcd"><span class="nav-number">3.8.</span> <span class="nav-text">Kubernetes 使用 etcd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E5%AF%B9%E8%B1%A1%E5%9C%A8etcd-%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84"><span class="nav-number">3.9.</span> <span class="nav-text">Kubernetes 对象在etcd 中的存储路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%89%80%E5%A4%84%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">3.10.</span> <span class="nav-text">etcd 在集群中所处的位置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E9%9B%86%E7%BE%A4"><span class="nav-number">3.11.</span> <span class="nav-text">etcd 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E5%8F%A0%E5%BC%8F-etcd-%E9%9B%86%E7%BE%A4%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8B%93%E6%89%91"><span class="nav-number">3.11.1.</span> <span class="nav-text">堆叠式 etcd 集群的高可用拓扑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8-etcd-%E9%9B%86%E7%BE%A4%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8B%93%E6%89%91"><span class="nav-number">3.11.2.</span> <span class="nav-text">外部 etcd 集群的高可用拓扑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.11.3.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F"><span class="nav-number">3.11.3.1.</span> <span class="nav-text">减少网络延迟</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E7%A3%81%E7%9B%98-I-O-%E5%BB%B6%E8%BF%9F"><span class="nav-number">3.11.3.2.</span> <span class="nav-text">减少磁盘 I&#x2F;O 延迟</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81%E5%90%88%E7%90%86%E7%9A%84%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="nav-number">3.11.3.3.</span> <span class="nav-text">保持合理的日志文件大小</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%88%E7%90%86%E7%9A%84%E5%AD%98%E5%82%A8%E9%85%8D%E9%A2%9D"><span class="nav-number">3.11.4.</span> <span class="nav-text">设置合理的存储配额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8E%8B%E7%BC%A9%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC"><span class="nav-number">3.11.5.</span> <span class="nav-text">自动压缩历史版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E6%9C%9F%E6%B6%88%E9%99%A4%E7%A2%8E%E7%89%87%E5%8C%96"><span class="nav-number">3.11.6.</span> <span class="nav-text">定期消除碎片化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88"><span class="nav-number">3.11.7.</span> <span class="nav-text">备份方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">3.11.8.</span> <span class="nav-text">优化运行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd-%E5%A4%87%E4%BB%BD%E5%AD%98%E5%82%A8"><span class="nav-number">3.11.9.</span> <span class="nav-text">etcd 备份存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.11.10.</span> <span class="nav-text">备份方案实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%BC%BA%E7%89%88-backup-%E6%96%B9%E6%A1%88"><span class="nav-number">3.12.</span> <span class="nav-text">增强版 backup 方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="nav-number">3.13.</span> <span class="nav-text">etcd 数据加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E4%B8%AD%E6%95%B0%E6%8D%AE%E5%88%86%E7%A6%BB"><span class="nav-number">3.14.</span> <span class="nav-text">Kubernetes 中数据分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2-APIServer"><span class="nav-number">3.15.</span> <span class="nav-text">查询 APIServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E-10245-%E7%89%88%E6%9C%AC%E5%BC%80%E5%A7%8B%EF%BC%8C%E7%9B%91%E5%90%AC%E6%89%80%E6%9C%89%E5%AF%B9%E8%B1%A1%E5%8F%98%E5%8C%96"><span class="nav-number">3.16.</span> <span class="nav-text">从 10245 版本开始，监听所有对象变化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.17.</span> <span class="nav-text">分页查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ResourceVersion"><span class="nav-number">3.18.</span> <span class="nav-text">ResourceVersion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%AD%E9%81%87%E7%9A%84%E9%99%B7%E9%98%B1"><span class="nav-number">3.19.</span> <span class="nav-text">遭遇的陷阱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%91%E6%95%B0-etcd-%E6%88%90%E5%91%98-Down"><span class="nav-number">3.20.</span> <span class="nav-text">少数 etcd 成员 Down</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Master-%E8%8A%82%E7%82%B9%E5%87%BA%E7%8E%B0%E7%BD%91%E7%BB%9C%E5%88%86%E5%8C%BA"><span class="nav-number">3.21.</span> <span class="nav-text">Master 节点出现网络分区</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#references"><span class="nav-number">4.</span> <span class="nav-text">references</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/387e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes 控制平面组件：etcd | 小夜时雨">
      <meta itemprop="description" content="分布式键值存储系统 etcd 在 Kubernetes 架构中的关键作用。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 控制平面组件：etcd
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-10T00:00:00+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-24 13:55:00" itemprop="dateModified" datetime="2024-01-24T13:55:00+08:00">2024-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">云原生训练营</span></a>
        </span>
    </span>

  
    <span id="/post/387e.html" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes 控制平面组件：etcd" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">分布式键值存储系统 etcd 在 Kubernetes 架构中的关键作用。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="etcd-简介"><a href="#etcd-简介" class="headerlink" title="etcd 简介"></a>etcd 简介</h1><p><code>Etcd</code> 是 <code>CoreOS</code> 基于 <code>Raft</code> 开发的分布式 <code>key</code> - <code>value</code> 存储，可用于<strong>服务发现</strong>、<strong>共享配置</strong>以及<strong>一致性保障</strong>（如数据库选主、分布式锁等）。</p>
<p>在分布式系统中，如何管理节点间的状态一直是一个难题，etcd 像是专门为集群环境的服务发现和注册而设计，它提供了数据 <code>TTL</code> 失效、数据改变监视、多值、目录监听、分布式锁原子操作等功能，可以方便的跟踪并管理集群节点的状态。</p>
<ul>
<li>键值对存储：将数据存储在分层组织的目录中，如同在标准文件系统中</li>
<li>检测变更：检测特定的键或目录以进行更改，并对值的更改做出反应</li>
<li>简单：<code>curl</code> 可访问的用户的 <code>API</code>（<code>HTTP</code> + <code>JSON</code>）</li>
<li>安全：可选的 <code>SSL</code> 客户端证书认证</li>
<li>快速：单实例每秒 1000 次写操作，2000+ 次读操作</li>
<li>可靠：使用 <code>Raft</code> 算法保证一致性（选举 <code>Leader</code>；超过半数达成一致）</li>
</ul>
<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><ul>
<li>基本的 <code>key</code> - <code>value</code> 存储</li>
<li>监听机制</li>
<li><code>key</code> 的过期及续约机制，用于监控和服务发现</li>
<li>原子 <code>Compare And Swap</code> 和 <code>Compare And Delete</code>，用于分布式锁和 <code>leader</code> 选举</li>
</ul>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>也可以用于键值对存储，应用程序可以读取和写入 <code>etcd</code> 中的数据</li>
<li><code>etcd</code> 比较多的应用场景是用于服务注册与发现</li>
<li>基于监听机制的分布式异步系统</li>
</ul>
<h2 id="键值对存储"><a href="#键值对存储" class="headerlink" title="键值对存储"></a>键值对存储</h2><p><code>etcd</code> 是一个键值存储的组件，其他的应用都是基于其键值存储的功能展开。</p>
<ul>
<li>采用 <code>kv</code> 型数据存储，一般情况下比关系型数据库快</li>
<li>支持动态存储（内存）以及静态存储（磁盘）</li>
<li>分布式存储，可集成为多节点集群</li>
<li>存储方式，采用类似目录结构。（<code>B+tree</code>）<ul>
<li>只有叶子节点才能真正存储数据，相当于文件</li>
<li>叶子节点的父节点一定是目录，目录不能存储数据</li>
</ul>
</li>
</ul>
<h2 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h2><ul>
<li>强一致性、高可用的服务存储目录<ul>
<li>基于 <code>Raft</code> 算法的 <code>etcd</code> 天生就是这样一个强一致性、高可用的服务存储目录</li>
</ul>
</li>
<li>一种注册服务和服务健康状况的机制<ul>
<li>用户可以在 <code>etcd</code> 中注册服务，并且对注册的服务配置 <code>key TTL</code>，定时保持服务的心跳（续约）以达到监控健康状态的效果</li>
</ul>
</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111145201033.png" alt="image-20240111145201033"></p>
<h2 id="消息发布与订阅"><a href="#消息发布与订阅" class="headerlink" title="消息发布与订阅"></a>消息发布与订阅</h2><ul>
<li>在分布式系统中，最适用的一种组件间通信方式就是消息发布与订阅；</li>
<li>即构建一个配置共享中心，数据提供者在这个配置中心发布消息，而消息使用者则订阅他们关心的主题，一旦主题有消息发布，就会实时通知订阅者；</li>
<li>通过这种方式可以做到分布式系统配置的集中式管理与动态更新；</li>
<li>应用中用到的一些配置信息放到 <code>etcd</code> 上进行集中管理；</li>
<li>应用在启动的时候主动从 <code>etcd</code> 获取一次配置信息，同时，在 <code>etcd</code> 节点上注册一个 <code>Watcher</code> 并等待，以后每次配置有更新的时候，<code>etcd</code> 都会实时通知订阅者，以此达到获取最新配置信息的目的。</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111145603647.png" alt="image-20240111145603647"></p>
<h2 id="Etcd-的安装"><a href="#Etcd-的安装" class="headerlink" title="Etcd 的安装"></a>Etcd 的安装</h2><p>下载安装包，参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V0Y2QtaW8vZXRjZC9yZWxlYXNlcw==">https://github.com/etcd-io/etcd/releases<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ETCD_VER=v3.4.29</span><br><span class="line"></span><br><span class="line"># choose either URL</span><br><span class="line">GOOGLE_URL=https://storage.googleapis.com/etcd</span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=$&#123;GOOGLE_URL&#125;</span><br><span class="line"></span><br><span class="line">rm -f /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test</span><br><span class="line"></span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1</span><br><span class="line">rm -f /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">/tmp/etcd-download-test/etcd --version</span><br><span class="line">/tmp/etcd-download-test/etcdctl version</span><br></pre></td></tr></table></figure>

<p>为避免跟本地的 hostNetwork 的 etcd 容器冲突，我们需要修改 etcd 的监听端口</p>
<ul>
<li><p><code>initial-cluster</code>：初始化集群，需要列所有 member 地址</p>
<blockquote>
<p>What is the difference between listen-&lt;client,peer&gt;-urls, advertise-client-urls or initial-advertise-peer-urls?</p>
<p>listen-client-urls and listen-peer-urls specify the local addresses etcd server binds to for accepting incoming connections. To listen on a port for all interfaces, specify 0.0.0.0 as the listen IP address.</p>
<p>advertise-client-urls and initial-advertise-peer-urls specify the addresses etcd clients or other etcd members should use to contact the etcd server. The advertise addresses must be reachable from the remote machines. Do not advertise addresses like localhost or 0.0.0.0 for a production setup since these addresses are unreachable from remote machines.</p>
<p>listen-client-urls和listen-peer-urls指定etcd服务器绑定以接受传入连接的本地地址。要在所有接口上监听一个端口，请将0.0.0.0指定为监听IP地址。<br>advertise-client-urls和initial-advertise-peer-urls指定etcd客户端或其他etcd成员应使用的地址来联系etcd服务器。广告地址必须从远程机器可达。不要在生产环境中广告类似localhost或0.0.0.0的地址，因为这些地址对于远程机器是无法访问的。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcd --listen-client-urls &#x27;http://localhost:12379&#x27; \</span><br><span class="line"> --advertise-client-urls &#x27;http://localhost:12379&#x27; \</span><br><span class="line"> --listen-peer-urls &#x27;http://localhost:12380&#x27; \</span><br><span class="line"> --initial-advertise-peer-urls &#x27;http://localhost:12380&#x27; \</span><br><span class="line"> --initial-cluster &#x27;default=http://localhost:12380&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="Member-list"><a href="#Member-list" class="headerlink" title="Member list"></a>Member list</h3><p>获取集群成员</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member list --write-out=table --endpoints=localhost:12379</span><br></pre></td></tr></table></figure>

<p>操作键值对</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 put /key1 val1</span><br><span class="line">etcdctl --endpoints=localhost:12379 put /key2 val2</span><br><span class="line">etcdctl --endpoints=localhost:12379 get --prefix /</span><br><span class="line">etcdctl --endpoints=localhost:12379 get --prefix / --keys-only</span><br><span class="line">etcdctl --endpoints=localhost:12379 watch --prefix /</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 put /key val1</span><br><span class="line">etcdctl --endpoints=localhost:12379 put /key val2</span><br><span class="line">etcdctl --endpoints=localhost:12379 put /key val3</span><br><span class="line">etcdctl --endpoints=localhost:12379 put /key val4</span><br><span class="line">// 以更详细的方式获取 key</span><br><span class="line">etcdctl --endpoints=localhost:12379 get /key -wjson</span><br><span class="line">// 监听</span><br><span class="line">etcdctl --endpoints=localhost:12379 watch --prefix / --rev 0</span><br><span class="line">etcdctl --endpoints=localhost:12379 watch --prefix / --rev 1</span><br><span class="line">etcdctl --endpoints=localhost:12379 watch --prefix / --rev 2</span><br></pre></td></tr></table></figure>

<p>第三方库和客户端工具</p>
<p>目前有很多支持 <code>etcd</code> 的库和客户端工具</p>
<ul>
<li>命令行客户端工具 <code>etcdctl</code> （将命令转化成 <code>REST</code> 进行请求）</li>
<li><code>Go</code> 客户端 <code>go-etcd</code></li>
<li><code>Java</code> 客户端 <code>jetcd</code></li>
<li><code>Python</code> 客户端 <code>python-etcd</code></li>
</ul>
</li>
</ul>
<h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><p>查看集群成员状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member list --write-out=table</span><br><span class="line">+------------------+---------+---------+-----------------------+-----------------------+------------+</span><br><span class="line">| ID | STATUS | NAME | PEER ADDRS | CLIENT ADDRS | IS LEARNER |</span><br><span class="line">+------------------+---------+---------+-----------------------+-----------------------+------------+</span><br><span class="line">| 8e9e05c52164694d | started | default | http://localhost:2380 | http://localhost:2379 | false |</span><br><span class="line">+------------------+---------+---------+-----------------------+-----------------------+------------+</span><br></pre></td></tr></table></figure>

<p>基本的数据读写操作：</p>
<p>写入数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 put /a b</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>读取数据（获取键值对）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 get /a</span><br><span class="line">/a  // 键</span><br><span class="line">b   // 值</span><br></pre></td></tr></table></figure>

<p>按 <code>key</code> 的前缀查询数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 get --prefix /</span><br></pre></td></tr></table></figure>

<p>只显示键值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=localhost:12379 get --prefix / --keys-only --debug</span><br></pre></td></tr></table></figure>

<h2 id="核心：-TTL-CAS"><a href="#核心：-TTL-CAS" class="headerlink" title="核心： TTL &amp; CAS"></a>核心： TTL &amp; CAS</h2><p><code>TTL</code>（<code>time to live</code>）指的是给一个 <code>key</code> 设置一个有效期，到期后这个 <code>key</code> 就会被自动删掉，这在很多分布式锁的实现上都会用到，可以保证锁的实时有效性。</p>
<p><code>Atomic Compare-and-Swap</code>（<code>CAS</code>）指的是在对 <code>key</code> 进行赋值的时候，客户端需要提供一些条件，当这些条件满足后，才能赋值成功。这些条件包括：</p>
<ul>
<li><code>prevExist</code>：<code>key</code> 当前赋值前是否存在</li>
<li><code>prevValue</code>：<code>key</code> 当前赋值前的值</li>
<li><code>prevIndex</code>：<code>key</code> 当前赋值前的 <code>Index</code></li>
</ul>
<p>这样的话，<code>key</code> 的设置是有前提的，需要知道这个 <code>key</code> 当前的具体情况才可以对其设置</p>
<h1 id="Raft-协议"><a href="#Raft-协议" class="headerlink" title="Raft 协议"></a>Raft 协议</h1><h2 id="Raft-协议概览"><a href="#Raft-协议概览" class="headerlink" title="Raft 协议概览"></a>Raft 协议概览</h2><p><code>Raft</code> 协议基于 <code>quorum</code> 机制，即大多数同意原则，任何的变更都需要超过半数的成员确认。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111151519295.png" alt="image-20240111151519295"></p>
<p>请求发送到服务器端，服务器中的一致性模块进行一致性协商，一致性模块将请求发送到另外两个服务器，并且将本次请求写入到本地的日志模块（临时存储）中，其他服务器接收到之后，记录到本地日志模块，记录完成之后，返回给第一个节点，当超过半数返回，则更新状态机（可以理解为持久化组件）。</p>
<h2 id="理解-Raft-协议"><a href="#理解-Raft-协议" class="headerlink" title="理解 Raft 协议"></a>理解 Raft 协议</h2><p><span class="exturl" data-url="aHR0cHM6Ly90aGVzZWNyZXRsaXZlc29mZGF0YS5jb20vcmFmdC8=">https://thesecretlivesofdata.com/raft/<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="learner"><a href="#learner" class="headerlink" title="learner"></a>learner</h2><p><code>Raft</code> 4.2.1 引入的新角色</p>
<p>当出现一个 <code>etcd</code> 集群需要增加节点时，新节点与 <code>Leader</code> 的数据差异较大，需要较多数据同步才能跟上 <code>leader</code> 的最新的数据。</p>
<p>此时 <code>Leader</code>  的网络带宽很可能被用尽，进而使得 <code>leader</code> 无法正常保持心跳。</p>
<p>进而导致 <code>follower</code> 重新发起投票。</p>
<p>进而可能引发 <code>etcd</code> 集群不可用。</p>
<p><code>Learner</code> 角色只接收数据而不参与投票，因此增加 <code>learner</code> 节点时，集群的 <code>quorum</code> 不变。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111152850124.png" alt="image-20240111152850124"></p>
<h2 id="etcd-基于-Raft-的一致性"><a href="#etcd-基于-Raft-的一致性" class="headerlink" title="etcd 基于 Raft 的一致性"></a>etcd 基于 Raft 的一致性</h2><p>选举方法：</p>
<ul>
<li>初始启动时，节点处于 <code>follower</code> 状态并设定一个 <code>election timeout</code>，如果在这一时间周期内没有收到来自 <code>leader</code> 的 <code>heartbeat</code>，节点将会发起选择：将自己切换为 <code>candidate</code> 之后，向集群中其他 <code>candidate</code> 节点（满足1:自己没有 <code>leader</code>，2:自己没有投票，才会投票）发送请求，询问其是否选举自己成为 <code>leader</code>。</li>
<li>当收到来自集群中过半数节点的接收投票后，节点即为 <code>leader</code>，开始接收保存 <code>client</code> 的数据并向其他的 <code>follower</code> 节点同步日志。</li>
<li>如果没有达成一致，则 <code>condidate</code> 随机选择一个等待间隔（<code>150ms</code> ~ <code>300ms</code>）再次发起投票，得到集群中半数以上 <code>follower</code> 接受的 <code>candidate</code> 将成为 <code>leader</code></li>
<li><code>leader</code> 节点依靠定时向 <code>follower</code> 发送 <code>heartbeat</code> 来保持其地位</li>
<li>任何时候如果其他 <code>follower</code> 在 <code>election timeout</code> 期间都没有收到来自 <code>leader</code> 的 <code>heartbeat</code>，同样会将自己状态切换为 <code>candidate</code> 并发起选举。每成功选举一次，新 <code>leader</code> 的任期（<code>Term</code>）都会比之前 <code>leader</code> 的任期大 1；</li>
</ul>
<h2 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h2><ul>
<li>当 <code>Leader</code> 接收到客户端的日志（事务请求）后，先把该日志追加到本地的 <code>Log</code> 中</li>
<li>然后通过 <code>heartbeat</code> 把该 <code>Entry</code> 同步给其他 <code>Follower</code></li>
<li><code>Follower</code> 接收到日志后，记录日志然后向 <code>Leader</code> 发送 <code>ACK</code></li>
<li>当 <code>Leader</code> 收到大多数（<code>n/2</code>+1）<code>Follower</code> 的 <code>ACK</code> 信息后将该日志设置为已提交并追加到本地磁盘中，通知客户端并在下个 <code>heartbeat</code> 中 <code>Leader</code> 将通知所有的 <code>Follower</code> 将该日志存储在自己的磁盘中。</li>
</ul>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>安全性是用于保证每个节点都执行相同序列的安全机制。</p>
<ul>
<li>如当某个 <code>Follower</code> 在当前 <code>Leader</code> <code>commit Log</code> 时变得不可用了，稍候可能该 <code>Follower</code> 又会被选举为 <code>Leader</code>，</li>
<li>这时新 <code>Leader</code> 可能会用新的 <code>Log</code> 覆盖先前已 <code>committed</code> 的 <code>Log</code>，这就是导致节点执行不同序列；</li>
</ul>
<p><code>Safety</code> 就是用于保证选举出来的 <code>Leader</code> 一定包含先前 <code>committed Log</code> 的机制。</p>
<p>选举安全性（<code>Election Safety</code>）：每个任期（<code>Term</code>）只能选举出一个 <code>Leader</code> （数据同步由 <code>Leader</code> 管理。）</p>
<p><code>Leader</code> 完整性（<code>Leader Completeness</code>）：指 <code>Leader</code> 日志的完整性，当 <code>Log</code> 在任期 <code>Term1</code> 被 <code>Commit</code> 后，那么以后任期 <code>Term2</code>、<code>Term3</code> … 等的 <code>Leader</code> 必须包含该 <code>Log</code>；</p>
<p><code>Raft</code> 在选举阶段就使用 <code>Term</code> 的判断用于保证完整性：当请求投票的该 <code>Candidate</code> 的 <code>Term</code> 较大或 <code>Index</code> 更大，则投票，否则拒绝该请求。</p>
<h2 id="失效处理"><a href="#失效处理" class="headerlink" title="失效处理"></a>失效处理</h2><ol>
<li><code>Leader</code> 失效：其他没有收到 <code>heartbeat</code> 的节点会发起新的选举，而当 <code>Leader</code> 恢复后由于步进数小会自动成为 <code>follower</code>（日志也会被新 <code>leader</code> 的日志覆盖）；</li>
<li><code>follower</code> 节点不可用：<code>follower</code> 节点不可用的情况相对容易解决。因为集群中的日志内容始终是从 <code>leader</code> 节点同步的，只要这一节点再次加入集群时重新从 <code>leader</code> 节点出复制日志即可；</li>
<li>多个 <code>candidate</code>：冲突后 <code>candidate</code> 将随机选择一个等待间隔（<code>150ms</code> ~ <code>300ms</code>）再次发起投票，得到集群半数以上 <code>follower</code> 接受的 <code>candidate</code> 将会成为 <code>leader</code></li>
</ol>
<h2 id="wal-日志"><a href="#wal-日志" class="headerlink" title="wal 日志"></a>wal 日志</h2><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111160127124.png" alt="image-20240111160127124"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jaHJvbWl1bS5nb29nbGVzb3VyY2UuY29tL2V4dGVybmFsL2dpdGh1Yi5jb20vY29yZW9zL2V0Y2QvKy9IRUFEL3JhZnQvcmFmdHBiL3JhZnQucHJvdG8=">https://chromium.googlesource.com/external/github.com/coreos/etcd/+/HEAD/raft/raftpb/raft.proto<i class="fa fa-external-link-alt"></i></span></p>
<p><code>wal</code> 日志是二进制的，解析出来以后是以上数据结构 <code>LogEntry</code>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Entry</span> &#123;</span><br><span class="line">    <span class="keyword">option</span> (versionpb.etcd_version_msg) = <span class="string">&quot;3.0&quot;</span>;</span><br><span class="line">    <span class="keyword">optional</span> <span class="type">uint64</span>     Term  = <span class="number">2</span> [(gogoproto.nullable) = <span class="literal">false</span>]; <span class="comment">// must be 64-bit aligned for atomic operations</span></span><br><span class="line">    <span class="keyword">optional</span> <span class="type">uint64</span>     Index = <span class="number">3</span> [(gogoproto.nullable) = <span class="literal">false</span>]; <span class="comment">// must be 64-bit aligned for atomic operations</span></span><br><span class="line">    <span class="keyword">optional</span> EntryType  Type  = <span class="number">1</span> [(gogoproto.nullable) = <span class="literal">false</span>];</span><br><span class="line">    <span class="keyword">optional</span> <span class="type">bytes</span>      Data  = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第一个字段 <code>type</code>，现版本（<code>v3.5</code>）有三种：</p>
<ul>
<li>0: 表示 <code>Normal</code></li>
<li>1: 表示 <code>ConfChange</code>（<code>ConfChange</code> 表示 <code>Etcd</code> 本身的配置变更同步，比如有新的节点加入等）。</li>
<li>2: 表示 <code>ConfChangeV2</code></li>
</ul>
</li>
<li><p>第二个字段是 <code>term</code></p>
<p>每个 <code>term</code> 代表一个主节点的任期，每次主节点变更 <code>term</code> 就会变化。</p>
</li>
<li><p>第三个字段是 <code>index</code></p>
<p>这个序号是严格有序递增的，代表变更序号</p>
</li>
<li><p>第四个字段是二进制的 <code>data</code></p>
<p>将 <code>raft request</code> 对象的 <code>pb</code> 结构（使用 <code>protoc buffers</code> 二进制，相比 <code>json</code> 更加节省空间）整个保存下。</p>
</li>
</ul>
<p><code>etcd</code> 源码下有个 <code>tools/etcd-dump-logs</code>，可以将 <code>wal</code> 日志 <code>dump</code> 成文本查看，可以协助分析 <code>Raft</code> 协议。</p>
<p><code>Raft</code> 协议本身不关心应用数据，也就是 <code>data</code> 中的部分，一致性都通过同步 <code>wal</code> 日志来实现，每个节点将从主节点收到的 <code>data apply</code> 到本地的存储，<code>Raft</code> 只关心日志的同步状态，如果本地存储实现的有 <code>bug</code>，比如没有正确的将 <code>data apply</code> 到本地，也可能会导致数据不一致。</p>
<h1 id="etcd-使用"><a href="#etcd-使用" class="headerlink" title="etcd 使用"></a>etcd 使用</h1><h2 id="etcd-v3-存储，Watch-以及过期机制"><a href="#etcd-v3-存储，Watch-以及过期机制" class="headerlink" title="etcd v3 存储，Watch 以及过期机制"></a>etcd v3 存储，Watch 以及过期机制</h2><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240111162008166.png" alt="image-20240111162008166"></p>
<h3 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h3><p><code>etcd v3 store</code> 分为两部分，一部分是内存中的索引，<code>kvindex</code>，是基于 <code>Google</code> 开源的一个 <code>Golang</code> 的 <code>btree</code> 实现的。</p>
<p>另一部分是后端存储。按照它的设计，<code>backend</code> 可以对接多种存储，当前使用的 <code>boltdb</code>。<code>boltdb</code> 是一个单机的支持事务的 <code>kv</code> 存储，<code>etcd</code> 的事务是基于 <code>boltdb</code> 的事务实现的。</p>
<p><code>etcd</code> 在 <code>boltdb</code> 中存储的 <code>key</code> 是 <code>reversion</code>，<code>value</code> 是 <code>etcd</code> 自己的 <code>key-value</code> 组合，也就是说 <code>etcd</code> 会在 <code>boltdb</code> 中把每个版本都保存下，从而实现了多版本机制。（一个数据存储多份，也就是多份版本。）</p>
<p><code>reversion</code> 主要由两部分组成，第一部分 <code>main rev</code>，每次事务进行加一，第二部分 <code>sub rev</code>，同一个事务中的每次操作加一。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// set </span><br><span class="line"></span><br><span class="line">// 获取详情 json</span><br><span class="line"></span><br><span class="line">// 再次 set</span><br><span class="line"></span><br><span class="line">// 获取详情 json，可以看到 reversion 更新</span><br><span class="line"></span><br><span class="line">// 指定 reversion 版本获取对应版本的值</span><br></pre></td></tr></table></figure>

<p><code>etcd</code> 提供了命令和设置选项来控制 <code>compact</code>，同时支持 <code>put</code> 操作的参数来精确控制某个 <code>key</code> 的历史版本数。</p>
<p>内存 <code>kvindex</code> 保存的就是 <code>key</code> 和 <code>reversion</code> 之前的映射关系，用来加速查询。</p>
<h3 id="etcd-写入数据的流程"><a href="#etcd-写入数据的流程" class="headerlink" title="etcd 写入数据的流程"></a>etcd 写入数据的流程</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112175505965.png" alt="image-20240112175505965"></p>
<ol>
<li>客户端写入数据</li>
<li><code>leader</code> 在预检查中做一系列的检测（配额、限速、鉴权、包大小例如 <code>1.5M</code> 等）</li>
<li>检查通过之后，将数据发送到 <code>KVServer</code></li>
<li><code>KVServer</code> 发送到 <code>Raft</code> 的一致性模块，如果是发送到的 <code>Leader</code> 则直接处理，如果不是，则由一致性模块转发发送到 <code>Leader</code></li>
<li>通过调用 <code>Propose</code> 方法，将数据作为入参</li>
<li>内存中的 <code>raftLog</code> 将数据放入 <code>unstable</code> 中作为临时存储</li>
<li><code>Leader</code> 将数据发送到 <code>Follower</code>，并且同时将数据写入日志模块 <code>WAL</code> 日志（<code>WAL</code> 是一个临时保障数据持久化的能力，防止宕机时内存中没有确认的数据丢失，虽然没有写入 <code>MVCC</code> 无法 <code>get</code> 出来。）</li>
<li>后台 <code>fsync</code> 会周期性将 <code>wal</code> 日志中的数据刷盘到磁盘中，存储完成后，数据才是稳定的</li>
<li>其他的 <code>Follower</code> 收到请求之后，一样会将数据写入到 <code>WAL</code> 日志中，并且返回 <code>response</code></li>
<li><code>KVServer</code> 判断是否收到超过半数确认</li>
<li>如果确认了，则将数据从 <code>unstable</code> 移动到 <code>committed</code>（此时数据无法 <code>get</code> 到）</li>
<li>最终操作 <code>applied</code>，通过 <code>MVCC</code> 模块操作索引，写入版本信息</li>
<li>在 <code>treeIndex</code> 中会记录对应 <code>key</code> 的当前版本，创建版本，历史版本</li>
<li>在 <code>BoltDB</code> 里面使用 <code>BTree</code> 存储，存储的 <code>key</code> 是版本信息，<code>value</code> 是 <code>key</code>-<code>value</code> 的键值对，创建版本、修改版本、当前版本</li>
</ol>
<p>也就是说，在 <code>MVCC</code> 模块中，要读取某个数据的某个版本，先从 <code>treeIndex</code> 中找到 <code>key</code> 对应数据，获取数据版本信息，在从 <code>BoltDB</code> 中通过 <code>key</code> 查对应版本，在 <code>value</code> 中获取值。</p>
<h3 id="etcd-数据一致性"><a href="#etcd-数据一致性" class="headerlink" title="etcd 数据一致性"></a>etcd 数据一致性</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112181201356.png" alt="image-20240112181201356"></p>
<ol>
<li>集群中有三个 <code>node</code>，<code>Leader</code> 是 <code>A</code>，<code>Follower</code> 是 <code>B</code>、<code>C</code></li>
<li>日志数据顺序写入，使用 <code>Index</code> 单调递增</li>
<li>已经写入持久化的数据 <code>a</code>，<code>b</code> 是已提交的</li>
<li>继续写入 <code>c</code>、<code>d</code>、<code>e</code> 所有成员确认，可以提交</li>
<li>当出现数据 <code>f</code> 、<code>g</code>，只有 <code>C</code> 没有收到，但是超过半数，也会提交</li>
<li>最后写入的 <code>h</code>，只有 <code>A</code> 收到，没有超过半数，<code>h</code> 不会提交</li>
</ol>
<h3 id="Watch机制"><a href="#Watch机制" class="headerlink" title="Watch机制"></a>Watch机制</h3><p><code>etcd v3</code> 的 <code>watch</code> 机制支持 <code>watch</code> 某个固定的 <code>key</code>，也支持 <code>watch</code> 一个范围（可以用于模拟目录的结构 <code>watch</code>），所以 <code>watchGroup</code> 包含两种 <code>watcher：</code></p>
<ul>
<li>一种是 <code>key watchers</code>，数据结构是每个 <code>key</code> 对应一组 <code>watcher；</code></li>
<li>另外一种是 <code>range watchers</code>，数据结构是一个 <code>IntervalTree</code>，方便通过区间查找到对应的 <code>watcher</code></li>
</ul>
<p>同时，每个 <code>WatchableStore</code> 包含两种 <code>watcherGroup</code>：</p>
<ul>
<li>一种是 <code>synced</code>，表示该 <code>group</code> 的 <code>watcher</code> 数据都已经同步完毕，在等待新的变更；</li>
<li>一种是 <code>unsynced</code>，表示该 <code>group</code> 的 <code>watcher</code> 数据同步落后于当前最新变更，还在追赶；</li>
</ul>
<p>当 <code>etcd</code> 收到客户端的 <code>watch</code> 请求，如果请求携带了 <code>revision</code> 参数，则比较请求的 <code>revision</code> 和 <code>store</code> 当前的 <code>revision</code>：</p>
<ul>
<li>如果大于当前 <code>revision</code>，则放入 <code>synced</code> 组中；</li>
<li>否则放入 <code>unsynced</code> 组；（也就是请求老版本数据，需要从 <code>boltdb</code> 中读取）</li>
</ul>
<p>同时 <code>etcd</code> 会启动一个后台的 <code>goroutine</code> 持续同步 <code>unsynced</code> 的 <code>watcher</code> ，然后将其迁移到 <code>synced</code> 组。</p>
<p>也就是这种机制下，<code>etcd v3</code> 支持从任意版本开始 <code>watch</code>，没有 <code>v2</code> 的 1000 条历史 <code>event</code> 表限制的问题（当然这是指没有 <code>compact</code> 的情况下）</p>
<h3 id="watch-练习"><a href="#watch-练习" class="headerlink" title="watch 练习"></a>watch 练习</h3><p>查看集群成员状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member list --write-out=table</span><br></pre></td></tr></table></figure>

<p>启动新 <code>etcd</code> 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d registry.aliyuncs.com/google_containers/etcd:3.5.0-0 /usr/local/bin/etcd</span><br></pre></td></tr></table></figure>

<p>进入 <code>etcd</code> 容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps|grep etcd</span><br><span class="line">docker exec –it &lt;containerid&gt; sh</span><br></pre></td></tr></table></figure>

<p>存入数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put x 0</span><br></pre></td></tr></table></figure>

<p>读取数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get x -w=json</span><br><span class="line">&#123;&quot;header&quot;:&#123;&quot;cluster_id&quot;:14841639068965178418,&quot;member_id&quot;:10276657743932975437,&quot;r</span><br><span class="line">evision&quot;:2,&quot;raft_term&quot;:2&#125;,&quot;kvs&quot;:[&#123;&quot;key&quot;:&quot;eA==&quot;,&quot;create_revision&quot;:2,&quot;mod_revision&quot;:2,&quot;versi</span><br><span class="line">on&quot;:1,&quot;value&quot;:&quot;MA==&quot;&#125;],&quot;count&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p>修改值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put x 1</span><br></pre></td></tr></table></figure>

<p>查询最新值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get x</span><br><span class="line">x</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>查询历史版本值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get x --rev=2</span><br><span class="line">x</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h2 id="etcd-重要参数"><a href="#etcd-重要参数" class="headerlink" title="etcd 重要参数"></a>etcd 重要参数</h2><p>成员相关参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--name &#x27;default&#x27;</span><br><span class="line">    Human-readable name for this member.  指定成员名字</span><br><span class="line">--data-dir &#x27;$&#123;name&#125;.etcd&#x27;</span><br><span class="line">    Path to the data directory.						指定 db 文件存储位置</span><br><span class="line">--listen-peer-urls &#x27;http://localhost:2380&#x27;   </span><br><span class="line">    List of URLs to listen on for peer traffic.			member 之间协商的端口</span><br><span class="line">--listen-client-urls &#x27;http://localhost:2379&#x27;</span><br><span class="line">    List of URLs to listen on for client traffic.		客户端连接的 地址</span><br></pre></td></tr></table></figure>

<p>集群相关参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--initial-advertise-peer-urls &#x27;http://localhost:2380&#x27;</span><br><span class="line">    List of this member&#x27;s peer URLs to advertise to the rest of the cluster.	</span><br><span class="line">--initial-cluster &#x27;default=http://localhost:2380&#x27;</span><br><span class="line">    Initial cluster configuration for bootstrapping.</span><br><span class="line">--initial-cluster-state &#x27;new&#x27;</span><br><span class="line">    Initial cluster state (&#x27;new&#x27; or &#x27;existing&#x27;).</span><br><span class="line">--initial-cluster-token &#x27;etcd-cluster&#x27;</span><br><span class="line">    Initial cluster token for the etcd cluster during bootstrap.</span><br><span class="line">--advertise-client-urls &#x27;http://localhost:2379&#x27;</span><br><span class="line">    List of this member&#x27;s client URLs to advertise to the public.</span><br></pre></td></tr></table></figure>

<p>安全相关参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--cert-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS cert file.</span><br><span class="line">--key-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS key file.</span><br><span class="line">--client-crl-file &#x27;&#x27;</span><br><span class="line">    Path to the client certificate revocation list file.</span><br><span class="line">--trusted-ca-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS trusted CA cert file.</span><br><span class="line">--peer-cert-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS cert file.</span><br><span class="line">--peer-key-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS key file.</span><br><span class="line">--peer-trusted-ca-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS trusted CA file.</span><br></pre></td></tr></table></figure>

<p>客户端操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=https://192.168.239.128:2379 \</span><br><span class="line">    --cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">    --key /etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">    --cacert /etc/kubernetes/pki/etcd/ca.crt member list</span><br></pre></td></tr></table></figure>

<h2 id="灾备"><a href="#灾备" class="headerlink" title="灾备"></a>灾备</h2><p>创建 <code>Snapshot</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">    --endpoints https://127.0.0.1:3379 \</span><br><span class="line">    --cert /tmp/etcd-certs/certs/127.0.0.1.pem \</span><br><span class="line">    --key /tmp/etcd-certs/certs/127.0.0.1-key.pem \</span><br><span class="line">    --cacert /tmp/etcd-certs/certs/ca.pem \</span><br><span class="line">    snapshot save snapshot.db</span><br></pre></td></tr></table></figure>

<p>恢复数据（可直接通过集群恢复，也可通过单节点恢复之后，再加入其他节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot restore snapshot.db \</span><br><span class="line">    --name infra2 \</span><br><span class="line">    --data-dir=/tmp/etcd/infra2 \</span><br><span class="line">    --initial-cluster infra0=http://127.0.0.1:3380,infra1=http://127.0.0.1:4380,infra2=http://127.0.0.1:5380 \</span><br><span class="line">    --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">    --initial-advertise-peer-urls http://127.0.0.1:5380</span><br></pre></td></tr></table></figure>

<h2 id="容量管理"><a href="#容量管理" class="headerlink" title="容量管理"></a>容量管理</h2><p>单个对象不建议超过 <code>1.5M</code></p>
<p>默认容量 <code>2G</code></p>
<p>不建议超过 <code>8G</code> （除了本就存储在内存中的 <code>kvindex</code>，还会将 <code>blotdb</code> 映射到内存里面，加快访问速度。）</p>
<h2 id="ALarm-Disarm-ALarm"><a href="#ALarm-Disarm-ALarm" class="headerlink" title="ALarm &amp; Disarm ALarm"></a>ALarm &amp; Disarm ALarm</h2><p>设置 <code>etcd</code> 存储大小 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcd --quota-backend-bytes=$((16*1024*1024))</span><br></pre></td></tr></table></figure>

<p>写爆磁盘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while [ 1 ]; do dd if=/dev/urandom bs=1024 count=1024 | ETCDCTL_API=3 etcdctl put key || break; done</span><br></pre></td></tr></table></figure>

<p>写满了之后，数据库变成只读。</p>
<p>查看 <code>endpoint</code> 状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --write-out=table endpoint status</span><br></pre></td></tr></table></figure>

<p>查看 <code>alarm</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl alarm list</span><br></pre></td></tr></table></figure>

<p>清理碎片</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl defrag</span><br></pre></td></tr></table></figure>

<p>清理 <code>alarm</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl alarm disarm</span><br></pre></td></tr></table></figure>

<h2 id="碎片整理"><a href="#碎片整理" class="headerlink" title="碎片整理"></a>碎片整理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keep one hour of <span class="built_in">history</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">etcd --auto-compaction-retention=1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compact up to revision 3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">etcdctl compact 3</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">etcdctl defrag</span></span><br><span class="line">Finished defragmenting etcd member[127.0.0.1:2379]</span><br></pre></td></tr></table></figure>

<h2 id="高可用-etcd-解决方案"><a href="#高可用-etcd-解决方案" class="headerlink" title="高可用 etcd 解决方案"></a>高可用 <code>etcd</code> 解决方案</h2><p><code>etcd-operator</code>：<code>coreos</code> 开源的，基于 Kubernetes CRD 完成 <code>etcd</code> 集群配置。<code>Archived</code>：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvcmVvcy9ldGNkLW9wZXJhdG9yJUVGJUJDJTg4JUU4JUFGJUE1JUU5JUExJUI5JUU3JTlCJUFFJUU0JUI4JThEJUU1JTg2JThEJUU3JUE3JUFGJUU2JTlFJTgxJUU1JUJDJTgwJUU1JThGJTkxJUU2JTg4JTk2JUU3JUJCJUI0JUU2JThBJUE0JUVGJUJDJTg5">https://github.com/coreos/etcd-operator（该项目不再积极开发或维护）<i class="fa fa-external-link-alt"></i></span></p>
<p><code>Etcd statefulset Helm chart: Bitnami</code>（<code>powered by vmware</code>）</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9iaXRuYW1pLmNvbS9zdGFjay9ldGNkL2hlbG0=">https://bitnami.com/stack/etcd/helm<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JpdG5hbWkvY2hhcnRzL3RyZWUvbWFpbi9iaXRuYW1pL2V0Y2Q=">https://github.com/bitnami/charts/tree/main/bitnami/etcd<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="Etcd-Operator"><a href="#Etcd-Operator" class="headerlink" title="Etcd-Operator"></a>Etcd-Operator</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvcmVvcy9ldGNkLW9wZXJhdG9y">https://github.com/coreos/etcd-operator<i class="fa fa-external-link-alt"></i></span></p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112141506850.png" alt="image-20240112141506850"></p>
<h3 id="基于-Bitnami-安装-etcd-高可用集群"><a href="#基于-Bitnami-安装-etcd-高可用集群" class="headerlink" title="基于 Bitnami 安装 etcd 高可用集群"></a>基于 Bitnami 安装 <code>etcd</code> 高可用集群</h3><p>安装 <code>heml</code></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hlbG0vaGVsbS9yZWxlYXNlcw==">https://github.com/helm/helm/releases<i class="fa fa-external-link-alt"></i></span></p>
<p>通过 <code>helm</code> 安装 <code>etcd</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm install my-release bitnami/etcd</span><br></pre></td></tr></table></figure>

<p>通过客户端与 <code>serve</code> 交互</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl run my-release-etcd-client \</span><br><span class="line">    --restart=&#x27;Never&#x27; \</span><br><span class="line">    --image docker.io/bitnami/etcd:3.5.0-debian-10-r94 \</span><br><span class="line">    --env ROOT_PASSWORD=$(kubectl get secret --namespace default my-release-etcd -o jsonpath=&quot;&#123;.data.etcd-root-password&#125;&quot; | base64 --decode) \</span><br><span class="line">    --env ETCDCTL_ENDPOINTS=&quot;my-release-etcd.default.svc.cluster.local:2379&quot; \</span><br><span class="line">    --namespace default \</span><br><span class="line">    --command -- sleep infinity</span><br></pre></td></tr></table></figure>

<h2 id="Kubernetes-使用-etcd"><a href="#Kubernetes-使用-etcd" class="headerlink" title="Kubernetes 使用 etcd"></a>Kubernetes 使用 etcd</h2><p><code>etcd</code> 是 Kubernetes 的后端存储，对于每一个 Kubernetes <code>Object</code>，都有对应的 <code>storage.go</code> 负责对象的存储操作</p>
<p><code>pkg/registry/core/pod/storage/storage.go</code></p>
<p><code>API server</code> 启动脚本中指定 <code>etcd</code> <code>servers</code> 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">    containers:</span><br><span class="line">    - command:</span><br><span class="line">        - kube-apiserver</span><br><span class="line">        - --advertise-address=192.168.34.2</span><br><span class="line">        - --enable-bootstrap-token-auth=true</span><br><span class="line">        - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">        - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">        - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="line">        - --etcd-servers=https://127.0.0.1:2379</span><br></pre></td></tr></table></figure>

<p>早期 <code>API server</code> 对 <code>etcd</code> 做简单的 <code>Ping</code> <code>check</code>，现在已经改为真实的 <code>etcd api call</code>。</p>
<h2 id="Kubernetes-对象在etcd-中的存储路径"><a href="#Kubernetes-对象在etcd-中的存储路径" class="headerlink" title="Kubernetes 对象在etcd 中的存储路径"></a>Kubernetes 对象在etcd 中的存储路径</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ks exec -it etcd -cadminsh</span><br><span class="line">ETCDCTL_API=3</span><br><span class="line">alias ectl =&#x27;etcdctl--endpoints https://127.0.0.1:2379 \</span><br><span class="line">    --cacert /etc/kubernetes/pki/etcd/ca.crt\</span><br><span class="line">    --cert /etc/kubernetes/pki/etcd/ server.crt\</span><br><span class="line">    --key /etc/kubernetes/pki/etcd/server.key&#x27;</span><br><span class="line">ectl get --prefix --keys-only \</span><br><span class="line">    /registry/namespaces/calico-apiserver \</span><br><span class="line">    /registry/networkpolicies/calico-apiserver/allow-apiserver \</span><br><span class="line">    /registry/operator.tigera.io/tigerastatuses/apiserver \</span><br><span class="line">    /registry/pods/calico-apiserver/calico-apiserver-77dffffcdf-g2tcx \</span><br><span class="line">    /registry/pods/default/toolbox-68f79dd5f8-4664n</span><br></pre></td></tr></table></figure>

<h2 id="etcd-在集群中所处的位置"><a href="#etcd-在集群中所处的位置" class="headerlink" title="etcd 在集群中所处的位置"></a>etcd 在集群中所处的位置</h2><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142212166.png" alt="image-20240112142212166"></p>
<p><code>API server</code> 启动脚本中指定 <code>etcd servers</code> 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kube-apiserver \</span><br><span class="line">    --etcd_servers=https://localhost:4001 \</span><br><span class="line">    --etcd-cafile=/etc/ssl/kubernetes/ca.crt--storage-backend=etcd3 \</span><br><span class="line">    --etcd-servers-overrides=/events#https://localhost:4002</span><br></pre></td></tr></table></figure>

<p>将变动频繁的（例如 <code>events</code>）的数据使用  <code>overrides</code> 指定到另外一个 <code>etcd</code> 集群。</p>
<h2 id="etcd-集群"><a href="#etcd-集群" class="headerlink" title="etcd 集群"></a>etcd 集群</h2><h3 id="堆叠式-etcd-集群的高可用拓扑"><a href="#堆叠式-etcd-集群的高可用拓扑" class="headerlink" title="堆叠式 etcd 集群的高可用拓扑"></a>堆叠式 <code>etcd</code> 集群的高可用拓扑</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142419159.png" alt="image-20240112142419159"></p>
<p>这种拓扑将相同节点上的控制平面和 <code>etcd</code> 成员耦合在一起。</p>
<p>优点在于建立起来非常容易，并且对副本的管理也更容易。但是，堆叠式存在耦合失败的风险。</p>
<p>如果一个节点发生故障，则 <code>etcd</code> 成员和控制平面实例都会丢失，并且集群冗余也会收到损害。可以通过添加更多控制平面节点来减轻这种风险。因此为实现集群高可用应该至少运行三个堆叠的 <code>Master</code> 节点。</p>
<h3 id="外部-etcd-集群的高可用拓扑"><a href="#外部-etcd-集群的高可用拓扑" class="headerlink" title="外部 etcd 集群的高可用拓扑"></a>外部 <code>etcd</code> 集群的高可用拓扑</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112142636405.png" alt="image-20240112142636405"></p>
<p>该拓扑将控制平面和 <code>etcd</code> 成员解耦。如果丢失一个 <code>Master</code> 节点，对 <code>etcd</code> 成员的影响较小，并且不会像堆叠式拓扑那样对集群冗余产生太大影响。</p>
<p>但是，此拓扑所需的主机数量是堆叠式拓扑的两倍。具有此拓扑的集群至少需要三个主机用于控制平面节点，三个主机用于 <code>etcd</code> 集群。</p>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>多少个 <code>peer</code> 最合适？</p>
<ul>
<li>1个？3个？5个？</li>
<li>保证高可用是首要目标，节点过多也会影响性能；但是3个节点时，一个节点故障，需要运维立马介入，而5个风险更小。</li>
<li>所有写操作都要经过 <code>leader</code>（如果 follower 接收请求也会转发给 <code>leader</code>）</li>
<li><code>peer</code> 多了是否能提升集群并读操作的并发能力？<ul>
<li><code>apiserver</code> 的配置直连本地的 <code>etcd peer</code></li>
<li><code>apiserver</code> 的配置指定所有 <code>etcd peers</code>，但只有当前连接的 <code>etcd member</code> 异常，<code>apiserver</code> 才会换目标</li>
</ul>
</li>
<li>需要动态 <code>flex up</code> 吗？</li>
</ul>
<p>保证 <code>apiserver</code> 和 <code>etcd</code> 之间的高效性通讯</p>
<ul>
<li><p><code>apiserver</code> 和 <code>etcd</code> 部署在同一节点</p>
</li>
<li><p><code>apiserver</code> 和 <code>etcd</code> 之间的通讯基于 <code>gRPC</code></p>
<ul>
<li><p>针对每一个 <code>object</code>，<code>apiserver</code> 和 <code>etcd</code> 之间的 <code>Connection</code> -&gt; <code>stream</code> 共享</p>
</li>
<li><p><code>http2</code> 的特性</p>
<ul>
<li><p><code>Stream quota</code></p>
</li>
<li><p>带来的问题？对于大规模集群，会造成链路阻塞（本 <code>grpc</code> 数据全部被占用，影响 <code>node</code> 的心跳数据发送）</p>
</li>
<li><p>10000 个 <code>pod</code>，一次 <code>list</code> 操作需要返回的数据可能超过 <code>100M</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k get pod --all-namespaces|<span class="built_in">wc</span>–l</span></span><br><span class="line">8520</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k get pod -oyaml --all-namespaces &gt; pods</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span> -l pods</span></span><br><span class="line">rw-r--r-- 1 root root 75339736 Apr 5 03:13 pods</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>本地 <code>vs</code> 远程？</p>
<ul>
<li><code>Remote Storage</code><ul>
<li>优势是假设永远可用，现实真实如此吗？</li>
<li>劣势是 <code>IO</code> 效率，可能带来的问题？</li>
</ul>
</li>
<li>最佳实践<ul>
<li><code>Local SSD</code></li>
<li>利用 <code>local volume</code> 分配空间</li>
</ul>
</li>
</ul>
</li>
<li><p>多少空间？</p>
<ul>
<li><p>与集群规模相关，思考：为什么每个 <code>member</code> 的 <code>DB size</code> 不一致？</p>
<p>包含的碎片大小不一样，<code>defrag</code> 和 <code>snap</code>。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112143519067.png" alt="image-20240112143519067"></p>
</li>
</ul>
</li>
</ul>
<p>安全性</p>
<ul>
<li><p><code>peer</code> 和 <code>peer</code> 之间的通讯加密</p>
<ul>
<li><p>是否有需求</p>
<ul>
<li><code>TLS</code> 的额外开销</li>
<li>运营复杂度增加</li>
</ul>
</li>
<li><p>数据加密</p>
<ul>
<li><p>是否有需求</p>
</li>
<li><p>Kubernetes 提供了针对 <code>secret</code> 的加密</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL2VuY3J5cHQtZGF0YS8=">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/<i class="fa fa-external-link-alt"></i></span></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>事件分离</p>
<ul>
<li><p>对于大规模集群，大量的事件会对 <code>etcd</code> 造成压力</p>
</li>
<li><p><code>API server</code> 启动脚本中指定 <code>etcd servers</code> 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kube-apiserver \</span><br><span class="line">    --etcd_servers=https://localhost:4001 \</span><br><span class="line">    --etcd-cafile=/etc/ssl/kubernetes/ca.crt--storage-backend=etcd3 \</span><br><span class="line">    --etcd-servers-overrides=/events#https://localhost:4002</span><br></pre></td></tr></table></figure></li>
</ul>
<p>如何监控？</p>
<h4 id="减少网络延迟"><a href="#减少网络延迟" class="headerlink" title="减少网络延迟"></a>减少网络延迟</h4><ul>
<li><p>数据中心内的 <code>RTT</code> 大概是数毫秒，国内的典型 <code>RTT</code> 约为 <code>50ms</code>，两大洲之间的 <code>RTT</code> 可能慢至 <code>400ms</code>。因此建议 <code>etcd</code> 集群尽量同地域部署。（外加异地备份）</p>
</li>
<li><p>当客户端到 <code>Leader</code> 的并发连接数量过多，可能会导致其他 <code>Follower</code> 节点发往 <code>Leader</code> 的请求因为网络拥塞而被延迟处理。在 <code>Follower</code> 节点上，可能会看到这样的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dropped MsgProp to 247ae21ff9436b2d since streamMsg&#x27;s sending buffer is full</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在节点上通过流量控制工具（<code>Traffic Control</code>）提高 <code>etcd</code> 成员之间发送数据的优先级来避免。</p>
</li>
</ul>
<h4 id="减少磁盘-I-O-延迟"><a href="#减少磁盘-I-O-延迟" class="headerlink" title="减少磁盘 I&#x2F;O 延迟"></a>减少磁盘 I&#x2F;O 延迟</h4><p>对于磁盘延迟，典型的旋转磁盘写延迟约为 <code>10ms</code>。对于 SSD（<code>Solid State Drivers</code>，固态硬盘），延迟通常低于 <code>1ms</code>。HDD（<code>Hard Disk Drive</code>，硬盘驱动器）或者网盘在大量数据读写操作的情况下延迟会不稳定。因此强烈建议使用 SSD。</p>
<p>同时为了降低其他应用程序的 <code>I/O</code> 操作对 <code>etcd</code> 的干扰，建议将 <code>etcd</code> 的数据存放在单独的磁盘内。也可以将不同类型的对象存储在不同的若干个 <code>etcd</code> 集群中，比如将频繁变更的 <code>event</code> 对象从主 <code>etcd</code> 集群中分离出来，以保证主集群的高性能。在 <code>APIServer</code> 处这是可以通过参数配置的。这些 <code>etcd</code> 集群最好也分别能有一块单独的存储磁盘。</p>
<p>如果不可避免地，<code>etcd</code> 和其他的业务共享存储磁盘，那么就需要通过下面 <code>ionice</code> 命令对 <code>etcd</code> 服务设置更高的磁盘 <code>I/O</code> 优先级，尽可能避免其他进程的影响。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionice -c2 -n0 -p &#x27;pgrep etcd&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="保持合理的日志文件大小"><a href="#保持合理的日志文件大小" class="headerlink" title="保持合理的日志文件大小"></a>保持合理的日志文件大小</h4><p><code>etcd</code> 以日志的形式保存数据，无论是数据创建还是修改，它都将操作追加到日志文件，因此日志文件大小会随着数据修改次数而线性增长。</p>
<p>当 Kubernetes 集群规模较大时，其对 <code>etcd</code> 集群中的数据更加也会很频繁，集群日志文件会迅速增长。</p>
<p>为了有效降低日志文件大小，<code>etcd</code> 会以固定周期创建快照保存系统的当前状态，兵移除旧日志文件。另外，当修改次数达到一定的数量（默认是 10000，通过参数 <code>--snapshot-count</code> 指定），<code>etcd</code> 也会创建快照文件。</p>
<p>如果 <code>etcd</code> 的内存使用和磁盘使用过高，可以先分析是否数据写入频度过大导致快照频度过高，确认后可通过调低快照触发的阈值来降低其对内存和磁盘的使用。</p>
<h3 id="设置合理的存储配额"><a href="#设置合理的存储配额" class="headerlink" title="设置合理的存储配额"></a>设置合理的存储配额</h3><p>存储空间的配额用于控制 <code>etcd</code> 数据空间的大小。合理的存储配额可保证集群操作的可靠性。</p>
<p>如果没有存储配额，也就是 <code>etcd</code> 可以利用整个磁盘空间，<code>etcd</code> 的性能会因为存储空间的持续增长而严重下降，甚至有耗完集群磁盘空间导致不可预测集群行为的风险。</p>
<p>如果设置的存储配额太小，一旦其中一个节点的后台数据库的存储空间超出了存储配额，<code>etcd</code> 就会触发集群范围的告警，并将集群置于只接受读和删除请求的维护模式。</p>
<p>只有在释放足够的空间、消除后端数据库的碎片和清除存储配额告警之后，集群才能恢复正常操作。</p>
<h3 id="自动压缩历史版本"><a href="#自动压缩历史版本" class="headerlink" title="自动压缩历史版本"></a>自动压缩历史版本</h3><p><code>etcd</code> 会为每个键都保存了历史版本。为了避免出现性能问题或存储空间消耗完导致写不进去的问题，这些历史版本需要进行周期性地压缩。</p>
<p>压缩历史版本就是丢弃该键给定版本之前的所有信息，节省出来的空间可以用于后续的写操作。</p>
<p><code>etcd</code> 支持自动压缩历史版本，在启动参数中指定参数 <code>--auto-compaction</code>，其值以小时为单位。也就是 <code>etcd</code> 会自动压缩该值设置的时间窗口之前的历史版本。</p>
<h3 id="定期消除碎片化"><a href="#定期消除碎片化" class="headerlink" title="定期消除碎片化"></a>定期消除碎片化</h3><p>压缩历史版本，相当于离散的抹去 <code>etcd</code> 存储空间某些数据，<code>etcd</code> 存储空间中将会出现碎片。</p>
<p>这些碎片无法被后台存储使用，却仍占据节点的存储空间。</p>
<p>因此定期消除存储碎片，将释放碎片化的存储空间，重新调整整个存储空间。</p>
<h3 id="备份方案"><a href="#备份方案" class="headerlink" title="备份方案"></a>备份方案</h3><ul>
<li><p><code>etcd</code> 备份：备份完整的集群信息，灾难恢复</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvcmVvcy9ldGNkLW9wZXJhdG9y">https://github.com/coreos/etcd-operator<i class="fa fa-external-link-alt"></i></span></p>
<p>借鉴 <code>operator</code> 的备份和恢复逻辑（通过创建 <code>pod</code> 来进行备份）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot save</span><br></pre></td></tr></table></figure>
</li>
<li><p>备份 Kubernetes event</p>
</li>
</ul>
<p>备份频度</p>
<ul>
<li>时间间隔太长：<ul>
<li>能否接受 <code>user data lost</code>？</li>
<li>如果有外部资源配置，如负载均衡等，能否接受数据丢失导致的 <code>leak</code>？</li>
</ul>
</li>
<li>间隔时间太短：<ul>
<li>对 <code>etcd </code> 的影响<ul>
<li>做 <code>snapshot</code> 的时候，<code>etcd</code> 会锁住当前数据</li>
<li>并发的写操作需要开辟新的空间进行增量写，导致磁盘空间增长</li>
</ul>
</li>
<li>同时监控  <code>wal</code> ，单独记录下来</li>
</ul>
</li>
</ul>
<p>如何保证备份的时效性，同时防止磁盘爆掉？</p>
<ul>
<li><code>Auto defrag</code>？</li>
</ul>
<h3 id="优化运行参数"><a href="#优化运行参数" class="headerlink" title="优化运行参数"></a>优化运行参数</h3><p>当网络延迟和磁盘延迟固定的情况下，可以优化 <code>etcd</code> 运行参数来提升集群的工作效率。</p>
<p><code>etcd</code> 基于 <code>Raft</code> 协议进行 <code>Leader</code> 选举，当 <code>Leader</code> 选定以后才能开始数据读写操作，因此频繁的 <code>Leader</code> 选举会导致数据读写性能显著降低。可以通过调整心跳周期（<code>Heartbeat Interval</code>）和选举超时时间（<code>Election Timeout</code>），来降低 <code>Leader</code> 选举的可能性。</p>
<p>心跳周期是控制 <code>Leader</code> 以何种频度向 <code>Follower</code> 发起心跳通知。心跳通知处表明 <code>Leader</code> 活跃状态之外，还带有待写入数据信息，<code>Follower</code> 依据心跳信息进行数据写入，默认心跳周期是 <code>100ms</code>。选举超时时间定义了当 <code>Follower</code> 多久没有收到 <code>Leader</code> 心跳，则重新发起选举，该参数的默认设置是 <code>1000ms</code>。</p>
<p>如果 <code>etcd</code> 集群的不同实例是部署在延迟较低的相同数据中心，通常使用默认配置即可。</p>
<p>如果不同实例部署在多数据中心或者网络延迟较高的集群环境，则需要对心跳周期和选举超时时间进行调整。建议心跳周期参数推荐设置为接近 <code>etcd</code> 多个成员之间平均数据往返周期的最大值，一般是平均 <code>RTT</code> 的 <code>0.55</code> - <code>1.5</code> 倍。</p>
<p>如果心跳周期设置得过低，<code>etcd</code> 会发送很多不必要的心跳信息，从而增加 <code>CPU</code> 和网络的负担。 如果设置得过高，则会导致选举频繁超时。</p>
<p>选举超时时间也需要根据 <code>etcd</code> 成员之间的平均 <code>RTT</code> 时间来设置。选举超时时间最少设置为 <code>etcd</code> 成员之间 <code>RTT</code> 时间的 <code>10</code> 倍，以便应对网络波动。</p>
<p>心跳间隔和选举超时时间的值必须对同一个 <code>etcd</code> 集群的所有节点都生效，如果各个节点配置不同，就会导致集群成员之间协商结果不可预知而不稳定。</p>
<h3 id="etcd-备份存储"><a href="#etcd-备份存储" class="headerlink" title="etcd 备份存储"></a>etcd 备份存储</h3><p><code>etcd</code> 的默认工作目录下会生成两个子目录：<code>wal</code> 和 <code>snap</code>。</p>
<ul>
<li><code>wal</code> 是用于存放预写式日志，其最大的作用是记录整个数据变化的全部历程。所有数据的修改在提交前，都要先写入 <code>wal</code> 中。</li>
<li><code>snap</code> 是用于存放快照数据。为防止 <code>wal</code> 文件过多，<code>etcd</code> 会定期（当 <code>wal</code> 中数据超过 10000 条记录时，由参数 <code>--snapshot-count</code> 设置）创建快照。当快照生成后，<code>wal</code> 中数据就可以被删除了。</li>
</ul>
<p>如果数据遭到破坏或错误修改需要回滚到之前某个状态时，方法就有两个：</p>
<ul>
<li>一是从快照中恢复数据主体，但是未被拍入快照的数据会丢失</li>
<li>二是执行所有 <code>wal</code> 中记录的修改操作，从最原始的数据恢复到数据损坏之前的状态，但恢复的时间较长</li>
</ul>
<h3 id="备份方案实践"><a href="#备份方案实践" class="headerlink" title="备份方案实践"></a>备份方案实践</h3><p>官方推荐 <code>etcd</code> 集群的备份方式是定期创建快照。</p>
<ul>
<li>和 <code>etcd</code> 内部定期创建快照的目的不同，该备份方式依赖外部程序定期创建快照，并将快照上传到网络存储设备以实现 <code>etcd</code> 数据的冗余备份。</li>
<li>上传到网络设备的数据，都应进行了加密。</li>
<li>即使当所有 <code>etcd</code> 实例都丢失了数据，也能允许 <code>etcd</code> 集群从一个已知的良好状态的时间点在任一地方进行恢复。</li>
</ul>
<p>根据集群对 <code>etcd</code> 备份粒度的要求，可适当调节备份的周期。在生产环境中实测，拍摄快照通常会影响集群当时的性能，因此不建议频繁创建快照。但是备份周期太长，就可能导致大量数据的丢失。</p>
<p>这里可以使用增量备份的方式。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112151247242.png" alt="image-20240112151247242"></p>
<p>备份程序每 <code>30</code> 分钟触发一次快照的拍摄。</p>
<p>紧接着它从快照结束的版本（<code>Revision</code>）开始，监听 <code>etcd</code> 集群的事件，并每 <code>10</code> 秒钟将事件保存到文件中，并将快照和事件文件上传到网络存储设备中。</p>
<p>30分钟的快照周期对集群性能影响甚微。当大灾难来临时，也至多丢失 <code>10s</code> 的数据。</p>
<p>至于数据修复，首先把数据从网络设备存储中下载下来，然后从快照中恢复大块数据，并在此基础上依次应用存储的所有事件。这样就可以将集群数据恢复到灾难发生前。</p>
<h2 id="增强版-backup-方案"><a href="#增强版-backup-方案" class="headerlink" title="增强版 backup 方案"></a>增强版 backup 方案</h2><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112151539027.png" alt="image-20240112151539027"></p>
<h2 id="etcd-数据加密"><a href="#etcd-数据加密" class="headerlink" title="etcd 数据加密"></a>etcd 数据加密</h2><p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL2VuY3J5cHQtZGF0YS8=">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiserver.config.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EncryptionConfiguration</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pandas.awesome.bears.example</span></span><br><span class="line">    <span class="attr">providers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">aescbc:</span></span><br><span class="line">          <span class="attr">keys:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">key1</span></span><br><span class="line">              <span class="comment"># See the following text for more details about the secret value</span></span><br><span class="line">              <span class="attr">secret:</span> <span class="string">&lt;BASE</span> <span class="number">64</span> <span class="string">ENCODED</span> <span class="string">SECRET&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">identity:</span> &#123;&#125; <span class="comment"># this fallback allows reading unencrypted secrets;</span></span><br><span class="line">                     <span class="comment"># for example, during initial migration</span></span><br></pre></td></tr></table></figure>

<h2 id="Kubernetes-中数据分离"><a href="#Kubernetes-中数据分离" class="headerlink" title="Kubernetes 中数据分离"></a>Kubernetes 中数据分离</h2><ul>
<li><p>对于大规模集群，大量的事件会对 <code>etcd</code> 造成压力</p>
</li>
<li><p><code>API server</code> 启动脚本中指定 <code>etcd servers</code> 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kube-apiserver \</span><br><span class="line">    --etcd-servers=https://localhost:4001 \</span><br><span class="line">    --etcd-cafile=/etc/ssl/kubernetes/ca.crt \</span><br><span class="line">    --storage-backend=etcd3 \</span><br><span class="line">    --etcd-servers-overrides=/events#https://localhost:4002</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="查询-APIServer"><a href="#查询-APIServer" class="headerlink" title="查询 APIServer"></a>查询 APIServer</h2><p>返回某 <code>namespace</code> 中的所有 <code>Pod</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/namespaces/test/pods</span><br><span class="line">---</span><br><span class="line"><span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PodList&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;resourceVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;10245&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="从-10245-版本开始，监听所有对象变化"><a href="#从-10245-版本开始，监听所有对象变化" class="headerlink" title="从 10245 版本开始，监听所有对象变化"></a>从 10245 版本开始，监听所有对象变化</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/namespaces/test/pods?watch=<span class="number">1</span>&amp;resourceVersion=<span class="number">10245</span></span><br><span class="line">---</span><br><span class="line"><span class="number">200</span> OK</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ADDED&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pod&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;resourceVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10596&quot;</span><span class="punctuation">,</span> ...<span class="punctuation">&#125;</span><span class="punctuation">,</span> ...<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MODIFIED&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pod&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;resourceVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;11020&quot;</span><span class="punctuation">,</span> ...<span class="punctuation">&#125;</span><span class="punctuation">,</span> ...<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/pods?limit=<span class="number">500</span></span><br><span class="line">---</span><br><span class="line"><span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PodList&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resourceVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;10245&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;continue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ENCODED_CONTINUE_TOKEN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      ...</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span> <span class="comment">// returns pods 1-500</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET</span><br><span class="line">/api/v1/pods?limit=<span class="number">500</span>&amp;continue=ENCODED_CONTINUE_TOKEN</span><br><span class="line">---</span><br><span class="line"><span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PodList&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resourceVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;10245&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;continue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ENCODED_CONTINUE_TOKEN_2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span> <span class="comment">// returns pods 501-1000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="ResourceVersion"><a href="#ResourceVersion" class="headerlink" title="ResourceVersion"></a>ResourceVersion</h2><ul>
<li><p>单个对象的 <code>resourceVersion</code></p>
<ul>
<li>对象的最后修改 <code>resourceVersion</code></li>
</ul>
</li>
<li><p><code>List</code> 对象的 <code>resourceVersion</code></p>
<ul>
<li>生成 <code>list response</code> 时的 <code>resourceVersion</code></li>
</ul>
</li>
<li><p><code>List</code> 行为</p>
<ul>
<li><p><code>List</code> 对象时，如果不加 <code>resourceVersion</code>，意味着需要 <code>Most Recent</code> 数据，请求会击穿 <code>APIServer</code> 缓存，直接发送至 <code>etcd</code></p>
</li>
<li><p><code>APIServer</code> 通过 <code>Label</code> 过滤对象查询时，过滤动作是在 <code>APIServer</code> 端，<code>APIServer</code> 需要向 <code>etcd</code> 发起全量查询请求</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152340147.png" alt="image-20240112152340147"></p>
</li>
</ul>
</li>
</ul>
<h2 id="遭遇的陷阱"><a href="#遭遇的陷阱" class="headerlink" title="遭遇的陷阱"></a>遭遇的陷阱</h2><ul>
<li>频繁的 <code>leader election</code></li>
<li><code>etcd</code> 分裂</li>
<li><code>etcd</code> 不响应</li>
<li>与 <code>apiserver</code> 之间的链路阻塞</li>
<li>磁盘暴涨</li>
</ul>
<h2 id="少数-etcd-成员-Down"><a href="#少数-etcd-成员-Down" class="headerlink" title="少数 etcd 成员 Down"></a>少数 etcd 成员 Down</h2><p>老版本可能出现少数 <code>etcd</code> 异常，但是上层 <code>apiserver</code> 正常，可能会导致两个节点上的 <code>pod</code> 出现异常。</p>
<p>解决方法是健康检查，<code>apiserver</code> 检测 <code>etcd</code> 异常之后，自杀，让<code>apiserver</code>调用其他节点上的 <code>etcd</code></p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152444763.png" alt="image-20240112152444763"></p>
<h2 id="Master-节点出现网络分区"><a href="#Master-节点出现网络分区" class="headerlink" title="Master 节点出现网络分区"></a>Master 节点出现网络分区</h2><p>网络分区出现：</p>
<ul>
<li><code>Group#1</code>: <code>master-1</code>、<code>master-2</code></li>
<li><code>Group#2</code>: <code>master-3</code>、<code>master-4</code>、<code>master-5</code></li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240112152601108.png" alt="image-20240112152601108"></p>
<h1 id="references"><a href="#references" class="headerlink" title="references"></a>references</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NodW5taWFvMzAzMi9hcnRpY2xlL2RldGFpbHMvMTI1NTcxNjUx">ETCD如何处理读写请求<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V0Y2QtaW8vZXRjZA==">etcd-io&#x2F;etcd<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ldGNkLmlvL2RvY3MvdjMuNS8=">v3.5 docs<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMDQxNjU3Nw==">面试官问你B树和B+树，就把这篇文章丢给他<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGl4dWVkdWFuLmNvbS9wb3N0cy9ldGNkLzA3LXJlYWQtcHJvY2Vzcy8=">etcd教程(七)—读请求执行流程分析<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/ff15.html" rel="prev" title="Kubernetes 架构原则和对象设计">
                  <i class="fa fa-angle-left"></i> Kubernetes 架构原则和对象设计
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/bad7.html" rel="next" title="Kubernetes 控制平面组件：API Server">
                  Kubernetes 控制平面组件：API Server <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.20.0/algoliasearch-lite.umd.js" integrity="sha256-DABVk+hYj0mdUzo+7ViJC6cwLahQIejFvC+my2M/wfM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.60.0/instantsearch.production.min.js" integrity="sha256-9242vN47QUX50UG5Gf5XDO1YREWCEJRyXHofh5fsl24=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/387e.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
