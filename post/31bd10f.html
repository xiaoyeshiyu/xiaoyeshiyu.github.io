<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="进一步提高QPS，可以针对使用场景进行优化">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 系统层面性能优化">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/31bd10f.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="进一步提高QPS，可以针对使用场景进行优化">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F14-48-24-image-20240325144823985.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-08-08-image-20240325150808670.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-14-11-image-20240325151411440.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-18-42-image-20240325151842364.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-19-12-image-20240325151912713.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-19-52-image-20240325151952034.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-22-33-image-20240325152233334.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-26-36-image-20240325152636606.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-51-57-image-20240325155157710.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-52-20-image-20240325155220006.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-55-41-image-20240325155541373.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-58-13-image-20240325155813757.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-00-02-image-20240325160002359.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-10-53-image-20240325161052933.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-17-45-image-20240325161745890.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-24-image-20240325162124637.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-34-image-20240325162134133.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-44-image-20240325162144154.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-24-09-image-20240325162409073.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-33-00-image-20240325163300065.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-35-34-image-20240325163534117.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-37-29-image-20240325163729852.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-39-48-image-20240325163948470.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-40-49-image-20240325164049678.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-43-33-image-20240325164333619.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-44-22-image-20240325164421957.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-46-59-image-20240325164659857.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-50-54-image-20240325165053979.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-51-14-image-20240325165114003.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-53-04-image-20240325165304672.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-57-14-image-20240325165713913.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-04-13-image-20240325170413114.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-04-22-image-20240325170422599.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-09-15-image-20240325170915707.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-12-45-Center.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-13-22-image-20240325171322618.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-18-00-image-20240325171800819.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-20-01-image-20240325172001460.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-28-05-image-20240325172805240.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-30-44-image-20240325173044001.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-32-48-image-20240325173248407.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-35-09-image-20240325173509100.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-36-03-image-20240325173603293.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-36-55-image-20240325173655700.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-37-46-image-20240325173746406.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-38-32-image-20240325173832612.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-40-33-image-20240325174033170.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-40-50-image-20240325174050798.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-41-06-image-20240325174106911.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-41-59-image-20240325174159492.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-09-image-20240325174209539.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-25-image-20240325174225738.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-37-image-20240325174237841.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-43-03-image-20240325174303622.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-46-48-image-20240325174648056.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-47-04-image-20240325174704851.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-48-16-image-20240325174815967.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-49-19-image-20240325174919125.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-53-13-image-20240325175313866.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-53-30-image-20240325175330638.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-54-15-image-20240325175415539.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-55-45-image-20240325175545270.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-56-06-image-20240325175606092.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-56-38-image-20240325175638214.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-57-47-image-20240325175747311.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-58-09-image-20240325175809413.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-38-16-image-20240325193816491.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-39-07-image-20240325193907773.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-57-57-image-20240325195757195.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-58-51-image-20240325195851789.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-42-56-image-20240325194256235.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-44-25-image-20240325194425098.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-44-40-image-20240325194440150.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-46-56-image-20240325194656072.png">
<meta property="article:published_time" content="2024-03-24T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-26T01:28:34.767Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F14-48-24-image-20240325144823985.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/31bd10f.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/31bd10f.html","path":"post/31bd10f.html","title":"Nginx 系统层面性能优化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx 系统层面性能优化 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%B1%82%E9%9D%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">Nginx 的系统层面性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E8%AE%BA"><span class="nav-number">1.1.</span> <span class="nav-text">方法论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E6%95%88%E4%BD%BF%E7%94%A8CPU"><span class="nav-number">1.2.</span> <span class="nav-text">高效使用CPU</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%A4%A7-Nginx-%E4%BD%BF%E7%94%A8-CPU-%E7%9A%84%E6%9C%89%E6%95%88%E6%97%B6%E9%95%BF"><span class="nav-number">1.2.1.</span> <span class="nav-text">增大 Nginx 使用 CPU 的有效时长</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2"><span class="nav-number">1.2.2.</span> <span class="nav-text">进程上下文切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81%E8%BF%9B%E7%A8%8B%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%80%81"><span class="nav-number">1.2.3.</span> <span class="nav-text">保持进程在运行态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%88%87%E6%8D%A2"><span class="nav-number">1.2.4.</span> <span class="nav-text">减少进程间切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E6%AC%A1%E6%95%B0"><span class="nav-number">1.2.5.</span> <span class="nav-text">查看上下文切换次数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B3%E5%AE%9A-CPU-%E6%97%B6%E9%97%B4%E7%89%87%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-number">1.2.6.</span> <span class="nav-text">决定 CPU 时间片的大小</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E6%A0%B8%E9%97%B4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.</span> <span class="nav-text">多核间负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-%E8%BF%9B%E7%A8%8B%E9%97%B4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.1.</span> <span class="nav-text">worker 进程间负载均衡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.4.</span> <span class="nav-text">网络层面优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%98%9F%E5%88%97%E7%BD%91%E5%8D%A1"><span class="nav-number">1.4.1.</span> <span class="nav-text">多队列网卡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E5%8D%87-CPU-%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87"><span class="nav-number">1.4.2.</span> <span class="nav-text">提升 CPU 缓存命中率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.4.3.</span> <span class="nav-text">TCP 层面优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">TCP 连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-TCP-%E8%BF%9E%E6%8E%A5%E4%BC%98%E5%8C%96"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">建立 TCP 连接优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E6%95%B0%E7%9A%84%E4%B8%8A%E9%99%90"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">句柄数的上限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE-worker-%E8%BF%9B%E7%A8%8B%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%87%8F"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">设置 worker 进程最大连接数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E9%98%9F%E5%88%97%E7%9A%84%E9%95%BF%E5%BA%A6"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">两个队列的长度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-Fast-Open"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">TCP Fast Open</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">滑动窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E5%91%8A%E7%AA%97%E5%8F%A3"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">通告窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx-%E7%9A%84%E6%BD%AE%E6%B9%BF%E6%8C%87%E4%BB%A4%E4%B8%8E%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">Nginx 的潮湿指令与滑动窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A2%E5%8C%85%E9%87%8D%E4%BC%A0"><span class="nav-number">1.4.3.10.</span> <span class="nav-text">丢包重传</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-number">1.4.3.11.</span> <span class="nav-text">TCP 缓冲区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E6%95%B4%E6%8E%A5%E6%94%B6%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98"><span class="nav-number">1.4.3.12.</span> <span class="nav-text">调整接收窗口与应用缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A6%81%E7%94%A8-Nagle-%E7%AE%97%E6%B3%95"><span class="nav-number">1.4.3.13.</span> <span class="nav-text">禁用 Nagle 算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">1.4.3.14.</span> <span class="nav-text">流量控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RTT-%E4%B8%8E-RTO"><span class="nav-number">1.4.3.15.</span> <span class="nav-text">RTT 与 RTO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-%E7%9A%84-Keep-alive-%E5%8A%9F%E8%83%BD"><span class="nav-number">1.4.3.16.</span> <span class="nav-text">TCP 的 Keep-alive 功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD-TCP-%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.4.3.17.</span> <span class="nav-text">关闭 TCP 连接</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.</span> <span class="nav-text">应用层面优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TLS-SSL-%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.1.</span> <span class="nav-text">TLS&#x2F;SSL 优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.5.2.</span> <span class="nav-text">HTTP 长连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip-%E5%8E%8B%E7%BC%A9"><span class="nav-number">1.5.3.</span> <span class="nav-text">gzip 压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E6%9B%B4%E9%AB%98%E6%95%88%E7%9A%84-HTTP2-%E5%8D%8F%E8%AE%AE"><span class="nav-number">1.5.4.</span> <span class="nav-text">升级更高效的 HTTP2 协议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A3%81%E7%9B%98-IO-%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.</span> <span class="nav-text">磁盘 IO 的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E7%A3%81%E7%9B%98-IO"><span class="nav-number">1.6.1.</span> <span class="nav-text">减少磁盘 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5-IO"><span class="nav-number">1.6.2.</span> <span class="nav-text">直接 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5-IO"><span class="nav-number">1.6.3.</span> <span class="nav-text">异步 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%AF%BB-IO-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">1.6.4.</span> <span class="nav-text">异步读 IO 线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E6%AC%A1%E6%95%B0"><span class="nav-number">1.6.5.</span> <span class="nav-text">减少磁盘读写次数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendfile-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8F%90%E5%8D%87%E6%80%A7%E8%83%BD"><span class="nav-number">1.6.6.</span> <span class="nav-text">sendfile 零拷贝提升性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip-static-%E6%A8%A1%E5%9D%97"><span class="nav-number">1.6.7.</span> <span class="nav-text">gzip_static 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gunzip-%E6%A8%A1%E5%9D%97"><span class="nav-number">1.6.8.</span> <span class="nav-text">gunzip 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tcmalloc"><span class="nav-number">1.7.</span> <span class="nav-text">tcmalloc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-gperftools-%E5%AE%9A%E4%BD%8D-Nginx-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">1.7.1.</span> <span class="nav-text">使用 gperftools 定位 Nginx 性能问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stub-status-%E6%A8%A1%E5%9D%97%E7%9B%91%E6%8E%A7-Nginx"><span class="nav-number">1.8.</span> <span class="nav-text">stub_status 模块监控 Nginx</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/31bd10f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx 系统层面性能优化 | 小夜时雨">
      <meta itemprop="description" content="进一步提高QPS，可以针对使用场景进行优化">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx 系统层面性能优化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-25 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-25T00:00:00+08:00">2024-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-26 09:28:34" itemprop="dateModified" datetime="2024-03-26T09:28:34+08:00">2024-03-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
    <span id="/post/31bd10f.html" class="post-meta-item leancloud_visitors" data-flag-title="Nginx 系统层面性能优化" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">进一步提高QPS，可以针对使用场景进行优化</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>优化 Nginx 性能是建立在 TCP 和 Linux 内核上。</p>
<h1 id="Nginx-的系统层面性能优化"><a href="#Nginx-的系统层面性能优化" class="headerlink" title="Nginx 的系统层面性能优化"></a>Nginx 的系统层面性能优化</h1><h2 id="方法论"><a href="#方法论" class="headerlink" title="方法论"></a>方法论</h2><ul>
<li>从软件层面提升硬件使用效率<ul>
<li>增大 CPU 的利用率（惊群现象，就会导致 CPU 利用率增大）</li>
<li>增大内存的利用率</li>
<li>增大磁盘 IO 的利用率（可以使用缓存在内存中，不打开文件）</li>
<li>增大网络带宽的利用率</li>
</ul>
</li>
<li>提升硬件规格<ul>
<li>网卡：万兆网卡，例如 10G、25G、40G 等</li>
<li>磁盘：固态硬盘，关注 IOPS 和 BPS 指标</li>
<li>CPU：更快的主频，更多的核心，更大的缓存，更优的架构</li>
<li>内存：更快的访问速度</li>
</ul>
</li>
<li>超出硬件性能上限后使用 DNS，例如下图，通过 DNS 负载到不同的集群</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F14-48-24-image-20240325144823985.png" alt="image-20240325144823985"></p>
<h2 id="高效使用CPU"><a href="#高效使用CPU" class="headerlink" title="高效使用CPU"></a>高效使用CPU</h2><h3 id="增大-Nginx-使用-CPU-的有效时长"><a href="#增大-Nginx-使用-CPU-的有效时长" class="headerlink" title="增大 Nginx 使用 CPU 的有效时长"></a>增大 Nginx 使用 CPU 的有效时长</h3><ul>
<li>能够使用全面 CPU 资源<ul>
<li>master-worker 多进程架构</li>
<li>worker 进程数量应大于等于 CPU 核数</li>
</ul>
</li>
<li>Nginx 进程间不做无用功浪费 CPU 资源<ul>
<li>worker 进程不应在繁忙时，主动让出 CPU<ul>
<li>worker 进程间不应由于争抢造成资源耗散<ul>
<li>worker 进程数量应当等于 CPU 核数（大于时，会出现争抢）</li>
</ul>
</li>
<li>worker 进程不应调用一些 API 导致主动让出 CPU（例如 <strong>阻塞</strong> 方法）<ul>
<li>拒绝类似的第三方模块</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>不被其他进程争抢资源<ul>
<li>提升优先级占用 CPU 更长的时间</li>
<li>减少操作系统上耗资源的非 Nginx 进程</li>
</ul>
</li>
</ul>
<p>设置 worker 进程的数量</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9uZ3hfY29yZV9tb2R1bGUuaHRtbCN3b3JrZXJfcHJvY2Vzc2Vz">https://nginx.org/en/docs/ngx_core_module.html#worker_processes<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_processes</span> number | auto;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line">Context:	main</span><br></pre></td></tr></table></figure>

<h3 id="进程上下文切换"><a href="#进程上下文切换" class="headerlink" title="进程上下文切换"></a>进程上下文切换</h3><p>一个 CPU 就可以同时运行多个进程</p>
<ul>
<li>宏观上并行，微观上串行<ul>
<li>把进程的运行时间分为一段段的时间片</li>
<li>OS 调度系统依次选择每个进程，最多执行时间片规定的时长</li>
</ul>
</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-08-08-image-20240325150808670.png" alt="image-20240325150808670"></p>
<ul>
<li>阻塞 API 引发的时间片内主动让出 CPU<ul>
<li>速度不一致引发的阻塞 API<ul>
<li>硬件执行速度不一致，例如 CPU 和磁盘（例如读取磁盘中的内容，此时 CPU 就会陷入等待，让出 CPU）</li>
</ul>
</li>
<li>业务场景产生的阻塞 API<ul>
<li>例如同步读网络报文（发出网络报文后，同步等待读取）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="保持进程在运行态"><a href="#保持进程在运行态" class="headerlink" title="保持进程在运行态"></a>保持进程在运行态</h3><ul>
<li>R 运行：正在运行或在运行队列中等待</li>
<li>S 中断：休眠中，受阻，在等待某个条件的形成或接受到信号</li>
<li>D 不可中断：收到信号不唤醒和不可运行，进程必须等待直到有中断发生</li>
<li>Z 僵死：进程已终止，但进程描述符不存在，直到父进程调用 <code>wait4()</code> 系统调用后释放</li>
<li>T 停止：进程收到 SIGSTOP，SIGSTP，SIGTIN，SIGTOU 信号后停止运行</li>
</ul>
<h3 id="减少进程间切换"><a href="#减少进程间切换" class="headerlink" title="减少进程间切换"></a>减少进程间切换</h3><ul>
<li>Nginx worker 尽可能的处于 R 状态<ul>
<li>R 状态的进程数量大于 CPU 核心时，负载急速增高</li>
</ul>
</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-14-11-image-20240325151411440.png" alt="image-20240325151411440"></p>
<ul>
<li>尽可能的减少进程间切换<ul>
<li>进程间切换：是指 CPU 从一个进程或线程切换到另一个进程或线程</li>
<li>类别：<ul>
<li>主动切换：例如阻塞 API </li>
<li>被动切换：时间片耗尽</li>
<li><code>cost: &lt;5us</code>，进程间切换的耗时</li>
</ul>
</li>
<li>减少主动切换</li>
<li>减少被动切换<ul>
<li>增大进程优先级（也就是增大时间片）</li>
</ul>
</li>
</ul>
</li>
<li>绑定 CPU</li>
</ul>
<p>延迟处理新连接</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">listen</span> address[:port] [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> port [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> unix:path [default_server] [ssl] [http2 | quic] [proxy_protocol] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">80</span> | *:<span class="number">8000</span>;</span><br><span class="line">Context:	server</span><br></pre></td></tr></table></figure>

<p><code>deferred</code>：使用 TCP_DEFER_ACCEPT 延迟处理新连接</p>
<h3 id="查看上下文切换次数"><a href="#查看上下文切换次数" class="headerlink" title="查看上下文切换次数"></a>查看上下文切换次数</h3><p><code>context-switch</code></p>
<ul>
<li><p><code>vmstat</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-18-42-image-20240325151842364.png" alt="image-20240325151842364"></p>
</li>
<li><p><code>dstat</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-19-12-image-20240325151912713.png" alt="image-20240325151912713"></p>
</li>
<li><p><code>pidstat -w -p &lt;pid&gt;</code>，针对进程</p>
<ul>
<li><code>cswch/s</code>：主动切换</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-19-52-image-20240325151952034.png" alt="image-20240325151952034"></p>
</li>
</ul>
<h3 id="决定-CPU-时间片的大小"><a href="#决定-CPU-时间片的大小" class="headerlink" title="决定 CPU 时间片的大小"></a>决定 CPU 时间片的大小</h3><ul>
<li>Nice 静态优先级：<code>-20 -- 19</code>，越大说明可以交由其他 CPU 执行，一般会将 Nginx 调小</li>
<li>Priority 动态优先级：<code>0 - 139</code></li>
</ul>
<p><code>#define DEFAULT_PRIO (MAX_RT_PRIO + NICE_WIDTH /2)</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-22-33-image-20240325152233334.png" alt="image-20240325152233334"></p>
<p>O1 调度算法（CFS）</p>
<ul>
<li>优先级动态调整<ul>
<li>幅度<ul>
<li><code>+-5</code></li>
</ul>
</li>
<li>依据<ul>
<li>CPU 消耗型进程</li>
<li>IO 消耗型进程</li>
</ul>
</li>
</ul>
</li>
<li>分时：时间片<ul>
<li><code>5ms-800ms</code> （最小和最大）</li>
</ul>
</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-26-36-image-20240325152636606.png" alt="image-20240325152636606"></p>
<p>设置 worker 进程的静态优先级</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_priority</span> number;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">worker_priority</span> <span class="number">0</span>;</span><br><span class="line">Context:	main</span><br></pre></td></tr></table></figure>

<h2 id="多核间负载均衡"><a href="#多核间负载均衡" class="headerlink" title="多核间负载均衡"></a>多核间负载均衡</h2><h3 id="worker-进程间负载均衡"><a href="#worker-进程间负载均衡" class="headerlink" title="worker 进程间负载均衡"></a>worker 进程间负载均衡</h3><p>解决惊群问题的三种方式：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-51-57-image-20240325155157710.png" alt="image-20240325155157710"></p>
<p>最终在 Linux 3.9 内核以上，选择 <code>reuseport</code> 特性</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-52-20-image-20240325155220006.png" alt="image-20240325155220006"></p>
<p>在 Kernel 层面，一个 <code>socket</code> 被每一个 <code>worker</code> 进程监听，并且做负载均衡。</p>
<h2 id="网络层面优化"><a href="#网络层面优化" class="headerlink" title="网络层面优化"></a>网络层面优化</h2><h3 id="多队列网卡"><a href="#多队列网卡" class="headerlink" title="多队列网卡"></a>多队列网卡</h3><p>多队列网卡对多核 CPU 的优化</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-55-41-image-20240325155541373.png" alt="image-20240325155541373"></p>
<ul>
<li>RSS：Receive Side Scaling：硬中断负载均衡（多个 CPU 可以同时并发处理硬中断）</li>
<li>RPS：Receive Packet Steering：软中断负载均衡</li>
<li>RFS：Receive Flow Steering（基于 RPS 做更好一层负载均衡）</li>
</ul>
<p>根据具体场景，做对应调试。</p>
<h3 id="提升-CPU-缓存命中率"><a href="#提升-CPU-缓存命中率" class="headerlink" title="提升 CPU 缓存命中率"></a>提升 CPU 缓存命中率</h3><p>跟 <code>worker_cpu_affinity</code> 指令相关</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F15-58-13-image-20240325155813757.png" alt="image-20240325155813757"></p>
<p>进程绑定 CPU 的好处是避免 CPU 上的缓存失效</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_cpu_affinity</span> cpumask ...;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> auto [cpumask];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	main</span><br></pre></td></tr></table></figure>

<p>Numa 架构</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-00-02-image-20240325160002359.png" alt="image-20240325160002359"></p>
<p>NUMA（Non-Uniform Memory Access，非一致性内存访问）是一种计算机系统设计架构，旨在解决多处理器系统中内存访问速度不一致的问题。在 NUMA 架构中，系统中的不同处理器核心（CPU）通过不同的内存控制器访问内存，导致不同内存区域的访问速度可能不同。</p>
<p>例如 NUMA 系统中每个处理器核心连接到不同的内存区域，因此访问本地内存比访问远程内存更快。因此，在 NUMA 系统中，内存被划分为不同的节点，每个节点包含处理器核心和与之关联的本地内存。处理器可以更快地访问其本地节点的内存，而访问其他节点的内存则需要经过更慢的跨节点通信。为了最大程度地减少跨节点访问带来的性能损失，NUMA 系统会尽可能将数据放置在本地节点，以减少跨节点通信。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># numactl --hardware</span></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 28 29 30 31 32 33 34 35 36 37 38 39 40 41</span><br><span class="line">node 0 size: 64133 MB</span><br><span class="line">node 0 free: 16704 MB</span><br><span class="line">node 1 cpus: 14 15 16 17 18 19 20 21 22 23 24 25 26 27 42 43 44 45 46 47 48 49 50 51 52 53 54 55</span><br><span class="line">node 1 size: 64504 MB</span><br><span class="line">node 1 free: 14147 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10</span><br></pre></td></tr></table></figure>

<p>查看命中率</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># numastat</span></span><br><span class="line">                           node0           node1</span><br><span class="line">numa_hit              8612016427     14780539235</span><br><span class="line">numa_miss                3111870         5509741</span><br><span class="line">numa_foreign             5509741         3111870</span><br><span class="line">interleave_hit             15697           15579</span><br><span class="line">local_node            8611826708     14780752466</span><br><span class="line">other_node               3188551         5700408</span><br></pre></td></tr></table></figure>

<p>当缓存命中率低，可以通过修改 numa 结构，例如禁止访问远端，例如关闭 numa 架构。</p>
<h3 id="TCP-层面优化"><a href="#TCP-层面优化" class="headerlink" title="TCP 层面优化"></a>TCP 层面优化</h3><h4 id="TCP-连接"><a href="#TCP-连接" class="headerlink" title="TCP 连接"></a>TCP 连接</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-10-53-image-20240325161052933.png" alt="image-20240325161052933"></p>
<p><strong>SYN_SENT 状态</strong> ：客户端</p>
<p><code>net.ipv4.tcp_syn_retries = 6</code>：主动建立连接时，发 SYN 的重试次数</p>
<p><code>net.ipv4.ip_local_port_range = 32768 60999</code>：建立连接时的本地端口可用范围</p>
<p><strong>主动建立连接时应用层超时时间</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Byb3h5X21vZHVsZS5odG1sI3Byb3h5X2Nvbm5lY3RfdGltZW91dA==">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_connect_timeout<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">proxy_connect_timeout</span> time;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">60s</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9zdHJlYW0vbmd4X3N0cmVhbV9wcm94eV9tb2R1bGUuaHRtbCNwcm94eV9jb25uZWN0X3RpbWVvdXQ=">https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_connect_timeout<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">proxy_connect_timeout</span> time;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">60s</span>;</span><br><span class="line">Context:	stream, server</span><br></pre></td></tr></table></figure>

<p><strong>SYN_RCVD 状态</strong>：服务器端</p>
<p><code>net.ipv4.tcp_max_syn_backlog</code>：SYN_RCVD 状态连接的最大个数（三次握手未完成，半连接的方式）</p>
<p><code>net.ipv4.tcp_synack_retries</code>：被动建立连接时，发 SYN&#x2F;ACK 的重试次数</p>
<p><strong>服务器端处理三次握手</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-17-45-image-20240325161745890.png" alt="image-20240325161745890"></p>
<h4 id="建立-TCP-连接优化"><a href="#建立-TCP-连接优化" class="headerlink" title="建立 TCP 连接优化"></a>建立 TCP 连接优化</h4><p><strong>应对 SYN 攻击</strong></p>
<p>攻击者短时间伪造不同 IP 地址的 SYN 报文，快速占满 backlog 队列，使服务器不能为正常用户服务。</p>
<p><code>net.core.netdev_max_backlog</code>：接受自网卡、但未被内核协议栈处理的报文队列长度</p>
<p><code>net.ipv4.tcp_max_syn_backlog</code>：SYNC_RCVD 状态连接的最大个数</p>
<p><code>net.ipv4.tcp_abort_on_overflow</code>：超出处理能力时，对新来的 SYN 直接回包 RST，丢弃连接</p>
<p>除此之外，还有一个方法 <code>tcp_syncookies</code></p>
<p>正常流程如下：通过 SYN 队列存储收到的 SYN 报文连接信息；通过 Accept 队列存储返回 ACK 报文的连接，让应用层处理。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-24-image-20240325162124637.png" alt="image-20240325162124637"></p>
<p>当应用程序过慢，导致 Accept  队列满，因此 SYN 队列中的数据取出来也无法存放，导致连接无法建立。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-34-image-20240325162134133.png" alt="image-20240325162134133"></p>
<p>使用 <code>cookie</code>，当 Accept 队列满，使用 <code>cookie</code> </p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-21-44-image-20240325162144154.png" alt="image-20240325162144154"></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-24-09-image-20240325162409073.png" alt="image-20240325162409073"></p>
<h4 id="句柄数的上限"><a href="#句柄数的上限" class="headerlink" title="句柄数的上限"></a>句柄数的上限</h4><p>Linux 系统中，一切皆文件，句柄数上限可能会限制连接数上限。</p>
<ul>
<li><p>操作系统全局</p>
<ul>
<li><code>fs.file-max</code><ul>
<li>操作系统可使用的最大句柄数</li>
</ul>
</li>
<li>使用 <code>fs.file-nr</code> 可以查看当前已分配、正使用、上限<ul>
<li><code>fs.file-nr = 21632 0   40000500</code></li>
</ul>
</li>
</ul>
</li>
<li><p>限制用户</p>
<ul>
<li><code>/etc/security/limits.conf</code><ul>
<li><code>root soft nofile 65535</code>：进程在运行时可以修改的链接数，一定要小于 <code>hard</code></li>
<li><code>root hard nofile 65535</code> ：强制的，真实的链接数</li>
</ul>
</li>
</ul>
</li>
<li><p>限制进程</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9uZ3hfY29yZV9tb2R1bGUuaHRtbCN3b3JrZXJfcmxpbWl0X25vZmlsZQ==">https://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_rlimit_nofile</span> number;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	main</span><br></pre></td></tr></table></figure>

<h4 id="设置-worker-进程最大连接数量"><a href="#设置-worker-进程最大连接数量" class="headerlink" title="设置 worker 进程最大连接数量"></a>设置 worker 进程最大连接数量</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9uZ3hfY29yZV9tb2R1bGUuaHRtbCN3b3JrZXJfY29ubmVjdGlvbnM=">https://nginx.org/en/docs/ngx_core_module.html#worker_connections<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_connections</span> number;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">worker_connections</span> <span class="number">512</span>;</span><br><span class="line">Context:	events</span><br></pre></td></tr></table></figure>

<p>设置单个工作进程可以打开的最大同时连接数。包括 Nginx 与上游、下游间的连接。</p>
<h4 id="两个队列的长度"><a href="#两个队列的长度" class="headerlink" title="两个队列的长度"></a>两个队列的长度</h4><ul>
<li>SYN 队列未完成握手：<code>net.ipv4.tcp_max_syn_backlog = 262144</code></li>
<li>ACCEPT 队列已完成握手：<code>net.core.somaxconn</code>，系统级最大 <code>backlog</code> 队列长度</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">listen</span> address[:port] [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> port [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> unix:path [default_server] [ssl] [http2 | quic] [proxy_protocol] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">80</span> | *:<span class="number">8000</span>;</span><br><span class="line">Context:	server</span><br></pre></td></tr></table></figure>

<p><code>backlog</code>：在 <code>listen()</code> 调用中设置 <code>backlog</code> 参数，该参数限制了挂起连接队列的最大长度。默认情况下，在 FreeBSD、DragonFly BSD 和 macOS 上，backlog 设置为 -1，在其他平台上设置为 511。</p>
</li>
</ul>
<h4 id="TCP-Fast-Open"><a href="#TCP-Fast-Open" class="headerlink" title="TCP Fast Open"></a>TCP Fast Open</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-33-00-image-20240325163300065.png" alt="image-20240325163300065"></p>
<p>将发送数据的过程省掉，在响应 SYN 报文时，同时发送 <code>cookie</code>，客户端保存 <code>cookie</code>，在后续发送数据时，携带 <code>cookie</code>，不需要重复建立 TCP。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-35-34-image-20240325163534117.png" alt="image-20240325163534117"></p>
<h4 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h4><p>TCP 建立连接后，开始传输数据。这个时候滑动窗口机制会影响效率，以及调整 TCP 缓冲区大小。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-37-29-image-20240325163729852.png" alt="image-20240325163729852"></p>
<h4 id="通告窗口"><a href="#通告窗口" class="headerlink" title="通告窗口"></a>通告窗口</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-39-48-image-20240325163948470.png" alt="image-20240325163948470"></p>
<p>TCP 报文中的 Window 字段，表示当前窗口大小。</p>
<p>发送 TCP 消息</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-40-49-image-20240325164049678.png" alt="image-20240325164049678"></p>
<p>第 5、6 步使用阻塞模型</p>
<p>TCP 消息接收</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-43-33-image-20240325164333619.png" alt="image-20240325164333619"></p>
<p>TCP 消息接收发生 CS（进程休眠，导致进程切换）</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-44-22-image-20240325164421957.png" alt="image-20240325164421957"></p>
<p>TCP 消息接收时新报文到达</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-46-59-image-20240325164659857.png" alt="image-20240325164659857"></p>
<h4 id="Nginx-的潮湿指令与滑动窗口"><a href="#Nginx-的潮湿指令与滑动窗口" class="headerlink" title="Nginx 的潮湿指令与滑动窗口"></a>Nginx 的潮湿指令与滑动窗口</h4><p>两次读操作间的超时</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">client_body_timeout</span> time;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">client_body_timeout</span> <span class="number">60s</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>两次写操作的超时</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">send_timeout</span> time;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">send_timeout</span> <span class="number">60s</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>以上两者兼具</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">proxy_timeout</span> timeout;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">proxy_timeout</span> <span class="number">10m</span>;</span><br><span class="line">Context:	stream, server</span><br></pre></td></tr></table></figure>

<h4 id="丢包重传"><a href="#丢包重传" class="headerlink" title="丢包重传"></a>丢包重传</h4><p>TCP 有重传机制，可同限制重传次数提升性能</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-50-54-image-20240325165053979.png" alt="image-20240325165053979"></p>
<h4 id="TCP-缓冲区"><a href="#TCP-缓冲区" class="headerlink" title="TCP 缓冲区"></a>TCP 缓冲区</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-51-14-image-20240325165114003.png" alt="image-20240325165114003"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">listen</span> address[:port] [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> port [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> unix:path [default_server] [ssl] [http2 | quic] [proxy_protocol] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">80</span> | *:<span class="number">8000</span>;</span><br><span class="line">Context:	server</span><br></pre></td></tr></table></figure>

<p><code>rcvbuf</code>&#x3D;<code>size</code>：设置侦听套接字的接收缓冲区大小（SO_RCVBUF 选项）。</p>
<p><code>sndbuf</code>&#x3D;<code>size</code>：设置侦听套接字的发送缓冲区大小（SO_SNDBUF 选项）。</p>
<p>使用读写缓冲区配置，操作系统的配置则会失效。</p>
<h4 id="调整接收窗口与应用缓存"><a href="#调整接收窗口与应用缓存" class="headerlink" title="调整接收窗口与应用缓存"></a>调整接收窗口与应用缓存</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-53-04-image-20240325165304672.png" alt="image-20240325165304672"></p>
<p><strong>BDP</strong></p>
<p>BDP（带宽时间级，也就是意味着网络中有多少传输中的字节数，也就是接收窗口） &#x3D; 带宽 x 时延，吞吐量 &#x3D; 窗口&#x2F;时延</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F16-57-14-image-20240325165713913.png" alt="image-20240325165713913"></p>
<h4 id="禁用-Nagle-算法"><a href="#禁用-Nagle-算法" class="headerlink" title="禁用 Nagle 算法"></a>禁用 Nagle 算法</h4><p>尽量将小报文合并成大报文</p>
<img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-04-13-image-20240325170413114.png" alt="image-20240325170413114" style="zoom:50%;" />

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-04-22-image-20240325170422599.png" alt="image-20240325170422599"></p>
<p>Nginx 也可以避免发送小报文</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjcG9zdHBvbmVfb3V0cHV0">https://nginx.org/en/docs/http/ngx_http_core_module.html#postpone_output<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	postpone_output size;</span><br><span class="line">Default:	</span><br><span class="line">postpone_output 1460;</span><br><span class="line">Context:	http, server, location</span><br></pre></td></tr></table></figure>

<p><strong>启用 CORK 算法</strong></p>
<p>仅针对 <code>sendfile on</code> 开启时有效，完全禁止小报文的发送，提升网络效率</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">tcp_nopush</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">tcp_nopush</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><blockquote>
<p>滑动窗口用于控制发送方发送数据的速率，以匹配接收方的接收能力，而拥塞窗口用于控制数据在网络中的传输速率，以避免网络拥塞。</p>
</blockquote>
<ul>
<li>拥塞窗口<ul>
<li>发送方主动限制流量</li>
</ul>
</li>
<li>通告窗口（对端接收窗口）<ul>
<li>接收方限制流量</li>
</ul>
</li>
<li>实际流量<ul>
<li>拥塞窗口与通告窗口的最小值</li>
</ul>
</li>
</ul>
<p>拥塞处理：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-09-15-image-20240325170915707.png" alt="image-20240325170915707"></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-12-45-Center.png" alt="img"></p>
<h4 id="RTT-与-RTO"><a href="#RTT-与-RTO" class="headerlink" title="RTT 与 RTO"></a>RTT 与 RTO</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-13-22-image-20240325171322618.png" alt="image-20240325171322618"></p>
<ul>
<li>RTT：Round Trip Time，指的是数据从发送端发送到接收端，再从接收端发送回确认的整个往返时间<ul>
<li>时刻变化</li>
<li>组成：<ul>
<li>物理链路传输时间</li>
<li>末端处理时间</li>
<li>路由器排队处理时间</li>
</ul>
</li>
<li>知道 RTO</li>
</ul>
</li>
<li>RTO：Retransmission TimeOut，是指在TCP协议中，当发送方发送数据后，等待接收确认的超时时间。如果在RTO时间内未收到确认，则发送方会重新发送数据。<ul>
<li>正确的应对丢包</li>
</ul>
</li>
</ul>
<p>在TCP通信中，发送方会根据RTT和RTO的信息来调整数据传输的速率和重传机制，以确保数据传输的可靠性和效率。合理设置RTO时间是保证数据传输可靠性的关键之一，过短的RTO可能导致不必要的重传，而过长的RTO可能延迟数据传输的恢复。</p>
<h4 id="TCP-的-Keep-alive-功能"><a href="#TCP-的-Keep-alive-功能" class="headerlink" title="TCP 的 Keep-alive 功能"></a>TCP 的 Keep-alive 功能</h4><p>应用场景：</p>
<ul>
<li>检测实际断掉的连接，及时释放 TCP 资源（与 HTTP 中的 keep-alive 的复用连接将短连接复用成长连接不同）</li>
<li>用于维护与客户端间的防火墙有活跃网络包</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-18-00-image-20240325171800819.png" alt="image-20240325171800819"></p>
<h4 id="关闭-TCP-连接"><a href="#关闭-TCP-连接" class="headerlink" title="关闭 TCP 连接"></a>关闭 TCP 连接</h4><p>TCP 连接的过程</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-20-01-image-20240325172001460.png" alt="image-20240325172001460"></p>
<p>当应用程序关闭连接，被动方才会从 CLOSE_WAIT 状态变为 LAST_ACK 状态。</p>
<p><strong>被动关闭连接端</strong></p>
<ul>
<li>CLOSE_WAIT 状态<ul>
<li>应用进程没有及时响应对端关闭连接（如果有大量的连接处于这个状态，那么是应用程序出现 bug，收到 FIN 后，没有调用 <code>close()</code> 方法）</li>
</ul>
</li>
<li>LAST_ACK 状态<ul>
<li>等待接受主动关闭操作系统发来的针对 FIN 的 ACK 报文（如果有大量的连接处于这个状态，代表迟迟没有收到对端的 ACK 报文）</li>
</ul>
</li>
</ul>
<p><strong>主动关闭连接端的状态</strong></p>
<ul>
<li>FIN_WAIT1 状态（发送 FIN 报文后的状态）<ul>
<li><code>net.ipv4.tcp_orphan_retries = 0</code>，发送 FIN 报文的重试次数，0 相当于 8 （FIN 报文可能被丢掉）</li>
</ul>
</li>
<li>FIN_WAIT2 状态（接受到对端 ACK 报文后的状态）<ul>
<li><code>net.ipv4.tcp_fin_timeout = 60</code>，保持在 FIN_WAIT2 状态的时间（也就是等待对方的 FIN 报文）</li>
</ul>
</li>
<li>TIME_WAIT 状态（接受到对端 FIN 报文后的状态）</li>
</ul>
<p><strong>TIME_WAIT</strong></p>
<ul>
<li><code>MSL(Maximum Segment Lifetime)</code>：报文最大生存时间</li>
</ul>
<p>TIME_WAIT 状态过短或者不存在会怎样：</p>
<p>维持 2MSL 时长的 TIME_WAIT 状态，保证至少一次报文的往返时间内端口是不可复用的。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-28-05-image-20240325172805240.png" alt="image-20240325172805240"></p>
<p><strong>tcp_tw_reuse</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-30-44-image-20240325173044001.png" alt="image-20240325173044001"></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-32-48-image-20240325173248407.png" alt="image-20240325173248407"></p>
<p><strong>lingering_close</strong> 延迟关闭的意义</p>
<p>当 Nginx 处理完成调用 <code>close</code> 关闭连接后，若接收缓冲区仍然收到客户端发来的内容，则服务器会向客户端发送 RST 包关闭连接，导致客户端由于收到RST而忽略了<code>http response</code>。</p>
<p>配置指令</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-35-09-image-20240325173509100.png" alt="image-20240325173509100"></p>
<p><strong>以 RST 代替正常的四次握手关闭连接</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-36-03-image-20240325173603293.png" alt="image-20240325173603293"></p>
<h2 id="应用层面优化"><a href="#应用层面优化" class="headerlink" title="应用层面优化"></a>应用层面优化</h2><h3 id="TLS-SSL-优化"><a href="#TLS-SSL-优化" class="headerlink" title="TLS&#x2F;SSL 优化"></a>TLS&#x2F;SSL 优化</h3><p><strong>TLS&#x2F;SSL 优化握手性能</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-36-55-image-20240325173655700.png" alt="image-20240325173655700"></p>
<p><strong>TLS&#x2F;SSL 中的会话票证 tickets</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-37-46-image-20240325173746406.png" alt="image-20240325173746406"></p>
<h3 id="HTTP-长连接"><a href="#HTTP-长连接" class="headerlink" title="HTTP 长连接"></a>HTTP 长连接</h3><p>优点：</p>
<ul>
<li>减少握手次数</li>
<li>通过减少并发连接数减少了服务器资源的消耗</li>
<li>降低 TCP 拥塞控制的影响</li>
</ul>
<p>对下游和上游的 HTTP 长连接配置</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-38-32-image-20240325173832612.png" alt="image-20240325173832612"></p>
<h3 id="gzip-压缩"><a href="#gzip-压缩" class="headerlink" title="gzip 压缩"></a>gzip 压缩</h3><p>通过实时压缩 HTTP 包体，提升网络传输效率。默认编译进 Nginx</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2d6aXBfbW9kdWxlLmh0bWw=">https://nginx.org/en/docs/http/ngx_http_gzip_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">gzip</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">gzip</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span>, if in <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>设置压缩哪些请求的响应</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-40-33-image-20240325174033170.png" alt="image-20240325174033170"></p>
<p>设置是否压缩上游的响应</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-40-50-image-20240325174050798.png" alt="image-20240325174050798"></p>
<p>其他压缩参数</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-41-06-image-20240325174106911.png" alt="image-20240325174106911"></p>
<h3 id="升级更高效的-HTTP2-协议"><a href="#升级更高效的-HTTP2-协议" class="headerlink" title="升级更高效的 HTTP2 协议"></a>升级更高效的 HTTP2 协议</h3><ul>
<li>向前兼容 http&#x2F;1.x 协议</li>
<li>传输效率大幅度提升</li>
</ul>
<h2 id="磁盘-IO-的优化"><a href="#磁盘-IO-的优化" class="headerlink" title="磁盘 IO 的优化"></a>磁盘 IO 的优化</h2><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-41-59-image-20240325174159492.png" alt="image-20240325174159492" style="zoom:50%;" />

<img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-09-image-20240325174209539.png" alt="image-20240325174209539" style="zoom:50%;" />

<p>可以通过 <code>fio</code> 测试性能</p>
<h3 id="减少磁盘-IO"><a href="#减少磁盘-IO" class="headerlink" title="减少磁盘 IO"></a>减少磁盘 IO</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-25-image-20240325174225738.png" alt="image-20240325174225738"></p>
<img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-42-37-image-20240325174237841.png" alt="image-20240325174237841" style="zoom:50%;" />

<h3 id="直接-IO"><a href="#直接-IO" class="headerlink" title="直接 IO"></a>直接 IO</h3><p>绕开磁盘高速缓存</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-43-03-image-20240325174303622.png" alt="image-20240325174303622"></p>
<p>左边正常读取数据；右边直接 IO 读取和写入数据，也就是读和写都绕过内核缓冲区。</p>
<p>适合于大文件：直接 IO</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-46-48-image-20240325174648056.png" alt="image-20240325174648056"></p>
<h3 id="异步-IO"><a href="#异步-IO" class="headerlink" title="异步 IO"></a>异步 IO</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-47-04-image-20240325174704851.png" alt="image-20240325174704851"></p>
<p>左边传统方式；右边异步 IO，调用 <code>read</code> 方法时，用户程序可以处理其他任务，不会陷入阻塞。</p>
<p>使用方式：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-48-16-image-20240325174815967.png" alt="image-20240325174815967"></p>
<h3 id="异步读-IO-线程池"><a href="#异步读-IO-线程池" class="headerlink" title="异步读 IO 线程池"></a>异步读 IO 线程池</h3><p>编译时加入 <code>--with-threads</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-49-19-image-20240325174919125.png" alt="image-20240325174919125"></p>
<p>在异步读取 IO 时，避免进程进入等待，会派生出线程处理任务队列中的任务，等待任务执行完，丢给 worker 进程继续执行。</p>
<p>线程池：做静态资源读取服务时使用，避免内存不够 <code>inode</code> 失效导致的读取异步 IO。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubmdpbnguY29tL2Jsb2cvdGhyZWFkLXBvb2xzLWJvb3N0LXBlcmZvcm1hbmNlLTl4Lw==">Thread Pools in NGINX Boost Performance 9x!<i class="fa fa-external-link-alt"></i></span></p>
<p>定义线程池：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-53-13-image-20240325175313866.png" alt="image-20240325175313866"></p>
<p>异步 IO 中的缓存：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-53-30-image-20240325175330638.png" alt="image-20240325175330638"></p>
<h3 id="减少磁盘读写次数"><a href="#减少磁盘读写次数" class="headerlink" title="减少磁盘读写次数"></a>减少磁盘读写次数</h3><p><strong>empty_gif 模块</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-54-15-image-20240325175415539.png" alt="image-20240325175415539"></p>
<p><strong>access 日志的压缩</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-55-45-image-20240325175545270.png" alt="image-20240325175545270"></p>
<p><strong>error.log 日志输出内存</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-56-06-image-20240325175606092.png" alt="image-20240325175606092"></p>
<p><strong>syslog 协议</strong></p>
<p>避免将日志写入磁盘，而是通过网络协议写入到 <code>syslog</code> 服务器</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-56-38-image-20240325175638214.png" alt="image-20240325175638214"></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-57-47-image-20240325175747311.png" alt="image-20240325175747311"></p>
<p><strong>rsyslog 与 Nginx</strong></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F25%2F17-58-09-image-20240325175809413.png" alt="image-20240325175809413"></p>
<h3 id="sendfile-零拷贝提升性能"><a href="#sendfile-零拷贝提升性能" class="headerlink" title="sendfile 零拷贝提升性能"></a>sendfile 零拷贝提升性能</h3><ul>
<li>减少进程间切换</li>
<li>减少内存拷贝次数</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-38-16-image-20240325193816491.png" alt="image-20240325193816491"></p>
<p>正常情况下，当需要响应磁盘中的内容时，应用程序从磁盘中读取数据，是先要读取到内核的页缓存，然后再读取到应用程序缓存区，也就是经过两次拷贝，发送出去也是同样的过程，首先从应用程序缓冲区拷贝到 <code>socket</code> 缓冲区，然后被网卡发送出去。</p>
<p>零拷贝是应用程序通过指令，让内核将磁盘中的数据读取到页缓存（也可以通过 DMA 高速传输），然后拷贝到 <code>socket</code> 缓冲区，交由网卡处理。</p>
<p>同时开启 <code>sendfile</code>、直接 IO、异步 IO：但是直接 IO 会禁用 <code>sendfile</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-39-07-image-20240325193907773.png" alt="image-20240325193907773"></p>
<h3 id="gzip-static-模块"><a href="#gzip-static-模块" class="headerlink" title="gzip_static 模块"></a>gzip_static 模块</h3><p>如果启用了 <code>gzip</code>，需要压缩，那么数据一定会读取到缓存中进行压缩。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2d6aXBfc3RhdGljX21vZHVsZS5odG1s">https://nginx.org/en/docs/http/ngx_http_gzip_static_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>检测到同名 <code>.gz</code> 文件时，<code>response</code> 中以 <code>gzip</code> 相关 <code>header</code> 返回 <code>.gz</code> 文件的内容。默认不编译进 Nginx</p>
<p><code>always</code>：不管客户端是否支持，都发送压缩过的文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">gzip_static</span> <span class="literal">on</span> | <span class="literal">off</span> | always;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">gzip_static</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h3 id="gunzip-模块"><a href="#gunzip-模块" class="headerlink" title="gunzip 模块"></a>gunzip 模块</h3><p>当客户端不支持 <code>gzip</code> 时，且磁盘上仅有压缩文件，则实时解压缩并将其发送给客户端。默认不编译进 Nginx</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2d1bnppcF9tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_gunzip_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">gunzip</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">gunzip</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line">Syntax:	gunzip_buffers number size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">gunzip_buffers</span> <span class="number">32</span> <span class="number">4k</span>|<span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h2 id="tcmalloc"><a href="#tcmalloc" class="headerlink" title="tcmalloc"></a>tcmalloc</h2><p>谷歌提供的内存分配库</p>
<ul>
<li>更快的内存分配器<ul>
<li>并发能力强于 <code>glibc</code><ul>
<li>并发线程数越多，性能越好</li>
</ul>
</li>
<li>减少内存碎片</li>
<li>擅长管理小块内存</li>
</ul>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9nb29nLXBlcmZ0b29scy5zb3VyY2Vmb3JnZS5uZXQvZG9jL3RjbWFsbG9jLmh0bWw=">https://goog-perftools.sourceforge.net/doc/tcmalloc.html<i class="fa fa-external-link-alt"></i></span></p>
<p>线程数对比</p>
<p>下面的图表显示了<code>TCMalloc</code>与<code>PTMalloc2</code>在几个不同指标上的性能。首先是每秒经过的总操作次数（百万）与最大分配大小之间的关系，针对不同线程数量。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-57-57-image-20240325195757195.png" alt="image-20240325195757195"></p>
<p>内存大小对比</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-58-51-image-20240325195851789.png" alt="image-20240325195851789"></p>
<p>库：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dwZXJmdG9vbHMvZ3BlcmZ0b29scw==">https://github.com/gperftools/gperftools<i class="fa fa-external-link-alt"></i></span></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-42-56-image-20240325194256235.png" alt="image-20240325194256235"></p>
<h3 id="使用-gperftools-定位-Nginx-性能问题"><a href="#使用-gperftools-定位-Nginx-性能问题" class="headerlink" title="使用 gperftools 定位 Nginx 性能问题"></a>使用 gperftools 定位 Nginx 性能问题</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-44-25-image-20240325194425098.png" alt="image-20240325194425098"></p>
<p>文本风格结果</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-44-40-image-20240325194440150.png" alt="image-20240325194440150"></p>
<h2 id="stub-status-模块监控-Nginx"><a href="#stub-status-模块监控-Nginx" class="headerlink" title="stub_status 模块监控 Nginx"></a>stub_status 模块监控 Nginx</h2><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3N0dWJfc3RhdHVzX21vZHVsZS5odG1s">https://nginx.org/en/docs/http/ngx_http_stub_status_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>通过 HTTP 接口，实时检测 Nginx 的连接状态。</p>
<p>统计数据存放于共享内存中，所以统计值包含所有 worker 进程，且执行 <code>reload</code> 不会导致数据清零，但热升级会导致数据清零。默认没有编译进 Nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	stub_status;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>模块的监控项</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F25%2F19-46-56-image-20240325194656072.png" alt="image-20240325194656072"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/4cec1707.html" rel="prev" title="Nginx负载均衡和反向代理">
                  <i class="fa fa-angle-left"></i> Nginx负载均衡和反向代理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/ff89bae5.html" rel="next" title="Elasticsearch 介绍">
                  Elasticsearch 介绍 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/31bd10f.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
