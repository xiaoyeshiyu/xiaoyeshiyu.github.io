<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="无论是开发 kubernetes 还是开发上层应用，都需要对 k8s 源码有深入理解。因此这里记录一下源码阅读过程，增加记忆和理解。本篇主要是 API Server，版本是 1.29.4">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s源码阅读笔记之 API Server 生成和启动">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/7d689b97.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="无论是开发 kubernetes 还是开发上层应用，都需要对 k8s 源码有深入理解。因此这里记录一下源码阅读过程，增加记忆和理解。本篇主要是 API Server，版本是 1.29.4">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F05%2F03%2F22-12-54-image-20240503221253955.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F05%2F08%2F10-13-35-1583210632919-e5d25e2f-5028-4112-99d8-cca024834a05.png">
<meta property="article:published_time" content="2024-04-22T16:00:00.000Z">
<meta property="article:modified_time" content="2024-05-10T08:59:05.958Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F05%2F03%2F22-12-54-image-20240503221253955.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/7d689b97.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/7d689b97.html","path":"post/7d689b97.html","title":"K8s源码阅读笔记之 API Server 生成和启动"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8s源码阅读笔记之 API Server 生成和启动 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Handler-Chain"><span class="nav-number">2.</span> <span class="nav-text">Handler Chain</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Scheme"><span class="nav-number">3.</span> <span class="nav-text">Scheme</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Object"><span class="nav-number">3.1.</span> <span class="nav-text">Object</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Resource"><span class="nav-number">3.2.</span> <span class="nav-text">Resource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Internal-Version-%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F"><span class="nav-number">3.3.</span> <span class="nav-text">Internal Version 注册方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-Version-%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F"><span class="nav-number">3.4.</span> <span class="nav-text">External Version 注册方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Generic-Server"><span class="nav-number">4.</span> <span class="nav-text">Generic Server</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenAPI-%E4%B8%8E-Generic-Server"><span class="nav-number">4.1.</span> <span class="nav-text">OpenAPI 与 Generic Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CAPIGroup"><span class="nav-number">4.2.</span> <span class="nav-text">注册APIGroup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ExternsionsServer"><span class="nav-number">4.2.1.</span> <span class="nav-text">ExternsionsServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#storage"><span class="nav-number">4.2.2.</span> <span class="nav-text">storage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InstallAPIGroup"><span class="nav-number">4.2.3.</span> <span class="nav-text">InstallAPIGroup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-APIServer"><span class="nav-number">4.2.4.</span> <span class="nav-text">Master APIServer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-Web-%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.</span> <span class="nav-text">启动 Web 服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/7d689b97.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="K8s源码阅读笔记之 API Server 生成和启动 | 小夜时雨">
      <meta itemprop="description" content="无论是开发 kubernetes 还是开发上层应用，都需要对 k8s 源码有深入理解。因此这里记录一下源码阅读过程，增加记忆和理解。本篇主要是 API Server，版本是 1.29.4">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s源码阅读笔记之 API Server 生成和启动
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-23 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-23T00:00:00+08:00">2024-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-05-10 16:59:05" itemprop="dateModified" datetime="2024-05-10T16:59:05+08:00">2024-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s-%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">k8s 源码走读</span></a>
        </span>
    </span>

  
    <span id="/post/7d689b97.html" class="post-meta-item leancloud_visitors" data-flag-title="K8s源码阅读笔记之 API Server 生成和启动" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">无论是开发 kubernetes 还是开发上层应用，都需要对 k8s 源码有深入理解。因此这里记录一下源码阅读过程，增加记忆和理解。本篇主要是 API Server，版本是 1.29.4</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>API Server 是 k8s 最核心的管理组件，也是相对而言读起来比较简单的。</p>
<h1 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h1><p>使用 cobra 框架作为命令行启动工具，通过启动时添加参数来做配置</p>
<p><code>cmd/kube-apiserver/app/server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">    cmd := &amp;cobra.Command&#123;</span><br><span class="line">        Use: <span class="string">&quot;kube-apiserver&quot;</span>,</span><br><span class="line">        Long: <span class="string">`The Kubernetes API server validates and configures data</span></span><br><span class="line"><span class="string">for the api objects which include pods, services, replicationcontrollers, and</span></span><br><span class="line"><span class="string">others. The API Server services REST operations and provides the frontend to the</span></span><br><span class="line"><span class="string">cluster&#x27;s shared state through which all other components interact.`</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stop printing usage when the command errors</span></span><br><span class="line">        SilenceUsage: <span class="literal">true</span>,</span><br><span class="line">        PersistentPreRunE: <span class="function"><span class="keyword">func</span><span class="params">(*cobra.Command, []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="comment">// silence client-go warnings.</span></span><br><span class="line">            <span class="comment">// kube-apiserver loopback clients should not log self-issued warnings.</span></span><br><span class="line">            rest.SetDefaultWarningHandler(rest.NoWarnings&#123;&#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 核心逻辑，RunE 相比 Run 会返回 Error</span></span><br><span class="line">        RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            verflag.PrintAndExitIfRequested()</span><br><span class="line">            fs := cmd.Flags()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Activate logging as soon as possible, after that</span></span><br><span class="line">            <span class="comment">// show flags with the final logging configuration.</span></span><br><span class="line">            <span class="keyword">if</span> err := logsapi.ValidateAndApply(s.Logs, utilfeature.DefaultFeatureGate); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            cliflag.PrintFlags(fs)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set default options</span></span><br><span class="line">      <span class="comment">// 补全默认值</span></span><br><span class="line">            completedOptions, err := s.Complete()</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// validate options</span></span><br><span class="line">      <span class="comment">// 校验配置是否合法或者是否有冲突</span></span><br><span class="line">            <span class="keyword">if</span> errs := completedOptions.Validate(); <span class="built_in">len</span>(errs) != <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> utilerrors.NewAggregate(errs)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// add feature enablement metrics</span></span><br><span class="line">            utilfeature.DefaultMutableFeatureGate.AddMetrics()</span><br><span class="line">      <span class="comment">// 运行 Run 方法</span></span><br><span class="line">      <span class="comment">// 也是通过 chan 做服务停止的信号处理</span></span><br><span class="line">            <span class="keyword">return</span> Run(completedOptions, genericapiserver.SetupSignalHandler())</span><br><span class="line">        &#125;,</span><br><span class="line">        Args: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> _, arg := <span class="keyword">range</span> args &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(arg) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q does not take any arguments, got %q&quot;</span>, cmd.CommandPath(), args)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将命令行指定的配置和 fs 关联起来</span></span><br><span class="line">    fs := cmd.Flags()</span><br><span class="line">    namedFlagSets := s.Flags()</span><br><span class="line">    verflag.AddFlags(namedFlagSets.FlagSet(<span class="string">&quot;global&quot;</span>))</span><br><span class="line">    globalflag.AddGlobalFlags(namedFlagSets.FlagSet(<span class="string">&quot;global&quot;</span>), cmd.Name(), logs.SkipLoggingConfigurationFlags())</span><br><span class="line">    options.AddCustomGlobalFlags(namedFlagSets.FlagSet(<span class="string">&quot;generic&quot;</span>))</span><br><span class="line">    <span class="keyword">for</span> _, f := <span class="keyword">range</span> namedFlagSets.FlagSets &#123;</span><br><span class="line">        fs.AddFlagSet(f)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cols, _, _ := term.TerminalSize(cmd.OutOrStdout())</span><br><span class="line">    cliflag.SetUsageAndHelpFunc(cmd, namedFlagSets, cols)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br></pre></td></tr></table></figure>

<p>将 <code>command</code> 返回出来，然后运行跑起来</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run runs the specified APIServer.  This should never exit.</span></span><br><span class="line"><span class="comment">// 也就是执行逻辑，将命令行跑起来</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(opts options.CompletedOptions, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// To help debugging, immediately log version</span></span><br><span class="line">    klog.Infof(<span class="string">&quot;Version: %+v&quot;</span>, version.Get())</span><br><span class="line"></span><br><span class="line">    klog.InfoS(<span class="string">&quot;Golang settings&quot;</span>, <span class="string">&quot;GOGC&quot;</span>, os.Getenv(<span class="string">&quot;GOGC&quot;</span>), <span class="string">&quot;GOMAXPROCS&quot;</span>, os.Getenv(<span class="string">&quot;GOMAXPROCS&quot;</span>), <span class="string">&quot;GOTRACEBACK&quot;</span>, os.Getenv(<span class="string">&quot;GOTRACEBACK&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建配置</span></span><br><span class="line">    config, err := NewConfig(opts)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 补全配置</span></span><br><span class="line">    completed, err := config.Complete()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建请求链（跟 gin 的请求链很相似）</span></span><br><span class="line">    server, err := CreateServerChain(completed)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepared, err := server.PrepareRun()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> prepared.Run(stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>config.Complete()</code> 配置补全内容非常多，这是由于 APIServer 的模块众多，相应的配置参数也非常之多，分类一下：</p>
<ul>
<li>genericConfig 通用配置</li>
<li>OpenAPI配置</li>
<li>Storage (etcd)配置</li>
<li>Authentication 认证配置</li>
<li>Authorization 授权配置</li>
</ul>
<h1 id="Handler-Chain"><a href="#Handler-Chain" class="headerlink" title="Handler Chain"></a>Handler Chain</h1><p>其中 <code>CreateServerChain</code> 则是构建请求流的处理过程：</p>
<p><code>Aggregation Server</code> -&gt; <code>Master</code> -&gt; <code>Extension Server</code> -&gt; <code>Not Found Handler</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateServerChain creates the apiservers connected via delegation.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateServerChain</span><span class="params">(config CompletedConfig)</span></span> (*aggregatorapiserver.APIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// notFoundHandler ，前面所有的 chan 都没有命中，就是用 notFoundHandler</span></span><br><span class="line">    notFoundHandler := notfoundhandler.New(config.ControlPlane.GenericConfig.Serializer, genericapifilters.NoMuxAndDiscoveryIncompleteKey)</span><br><span class="line">    <span class="comment">// ExtensionsServer：负责 CRD 的处理，也就是 Custom API Server</span></span><br><span class="line">    apiExtensionsServer, err := config.ApiExtensions.New(genericapiserver.NewEmptyDelegateWithCustomHandler(notFoundHandler))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    crdAPIEnabled := config.ApiExtensions.GenericConfig.MergedResourceConfig.ResourceEnabled(apiextensionsv1.SchemeGroupVersion.WithResource(<span class="string">&quot;customresourcedefinitions&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// kubeAPIServer 负责 build-in 的 API Object 相关的处理</span></span><br><span class="line">    kubeAPIServer, err := config.ControlPlane.New(apiExtensionsServer.GenericAPIServer)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// aggregator comes last in the chain</span></span><br><span class="line">    <span class="comment">// 负责转发请求到 API Server 或者 Custom API Server</span></span><br><span class="line">    aggregatorServer, err := createAggregatorServer(config.Aggregator, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers, crdAPIEnabled)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// we don&#x27;t need special handling for innerStopCh because the aggregator server doesn&#x27;t create any go routines</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> aggregatorServer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>API Server 的 Instance 是通过 <code> config.ControlPlane.New(apiExtensionsServer.GenericAPIServer)</code> 实现的</p>
<p><code>pkg/controlplane/instance.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*Instance, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// 这个就是返回的 Instance</span></span><br><span class="line">    m := &amp;Instance&#123;</span><br><span class="line">        GenericAPIServer:          s,</span><br><span class="line">        ClusterAuthenticationInfo: c.ExtraConfig.ClusterAuthenticationInfo,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 注册核心的方法，用于响应 REST 请求，用于处理 元老级资源请求</span></span><br><span class="line">    legacyRESTStorageProvider, err := corerest.New(corerest.Config&#123;</span><br><span class="line">        GenericConfig: corerest.GenericConfig&#123;</span><br><span class="line">            StorageFactory:              c.ExtraConfig.StorageFactory,</span><br><span class="line">            EventTTL:                    c.ExtraConfig.EventTTL,</span><br><span class="line">            LoopbackClientConfig:        c.GenericConfig.LoopbackClientConfig,</span><br><span class="line">            ServiceAccountIssuer:        c.ExtraConfig.ServiceAccountIssuer,</span><br><span class="line">            ExtendExpiration:            c.ExtraConfig.ExtendExpiration,</span><br><span class="line">            ServiceAccountMaxExpiration: c.ExtraConfig.ServiceAccountMaxExpiration,</span><br><span class="line">            APIAudiences:                c.GenericConfig.Authentication.APIAudiences,</span><br><span class="line">            Informers:                   c.ExtraConfig.VersionedInformers,</span><br><span class="line">        &#125;,</span><br><span class="line">        Proxy: corerest.ProxyConfig&#123;</span><br><span class="line">            Transport:           c.ExtraConfig.ProxyTransport,</span><br><span class="line">            KubeletClientConfig: c.ExtraConfig.KubeletClientConfig,</span><br><span class="line">        &#125;,</span><br><span class="line">        Services: corerest.ServicesConfig&#123;</span><br><span class="line">            ClusterIPRange:          c.ExtraConfig.ServiceIPRange,</span><br><span class="line">            SecondaryClusterIPRange: c.ExtraConfig.SecondaryServiceIPRange,</span><br><span class="line">            NodePortRange:           c.ExtraConfig.ServiceNodePortRange,</span><br><span class="line">            IPRepairInterval:        c.ExtraConfig.RepairServicesInterval,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// The order here is preserved in discovery.</span></span><br><span class="line">    <span class="comment">// If resources with identical names exist in more than one of these groups (e.g. &quot;deployments.apps&quot;&quot; and &quot;deployments.extensions&quot;),</span></span><br><span class="line">    <span class="comment">// the order of this list determines which group an unqualified resource name (e.g. &quot;deployments&quot;) should prefer.</span></span><br><span class="line">    <span class="comment">// This priority order is used for local discovery, but it ends up aggregated in `k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go</span></span><br><span class="line">    <span class="comment">// with specific priorities.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> describe the priority all the way down in the RESTStorageProviders and plumb it back through the various discovery</span></span><br><span class="line">    <span class="comment">// handlers that we have.</span></span><br><span class="line">    <span class="comment">// 所有的 Provider，用于响应 REST 请求，元老级资源和非元老级资源</span></span><br><span class="line">    <span class="comment">// 如果具有相同名称的资源存在于这些组中的多个组中（例如“deployments.apps”和“deployments.extensions”），则此列表的顺序决定未经限定的资源名称（例如“deployments”）应优先选择哪个组。</span></span><br><span class="line">    <span class="comment">// 此优先级顺序用于本地发现，但最终会聚合到`k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go` 中，并具有特定优先级。</span></span><br><span class="line">    restStorageProviders := []RESTStorageProvider&#123;</span><br><span class="line">        legacyRESTStorageProvider,</span><br><span class="line">        apiserverinternalrest.StorageProvider&#123;&#125;,</span><br><span class="line">        authenticationrest.RESTStorageProvider&#123;Authenticator: c.GenericConfig.Authentication.Authenticator, APIAudiences: c.GenericConfig.Authentication.APIAudiences&#125;,</span><br><span class="line">        authorizationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer, RuleResolver: c.GenericConfig.RuleResolver&#125;,</span><br><span class="line">        autoscalingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        batchrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        certificatesrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        coordinationrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        discoveryrest.StorageProvider&#123;&#125;,</span><br><span class="line">        networkingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        noderest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        policyrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        rbacrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer&#125;,</span><br><span class="line">        schedulingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        storagerest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">        flowcontrolrest.RESTStorageProvider&#123;InformerFactory: c.GenericConfig.SharedInformerFactory&#125;,</span><br><span class="line">        <span class="comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span></span><br><span class="line">        <span class="comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span></span><br><span class="line">        appsrest.StorageProvider&#123;&#125;,</span><br><span class="line">        admissionregistrationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer, DiscoveryClient: discoveryClientForAdmissionRegistration&#125;,</span><br><span class="line">        eventsrest.RESTStorageProvider&#123;TTL: c.ExtraConfig.EventTTL&#125;,</span><br><span class="line">        resourcerest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := m.InstallAPIs(c.ExtraConfig.APIResourceConfigSource, c.GenericConfig.RESTOptionsGetter, restStorageProviders...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 API 的划分不是根据资源类型，而是作为参数，因此需要将对应 Object 注册进来，然后针对性处理。</p>
<p>实现都在 <code>InstallAPIs</code> 里面</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Instance)</span></span> InstallAPIs(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter, restStorageProviders ...RESTStorageProvider) <span class="type">error</span> &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, restStorageBuilder := <span class="keyword">range</span> restStorageProviders &#123;</span><br><span class="line">        groupName := restStorageBuilder.GroupName()</span><br><span class="line">        <span class="comment">// 生成 apiGroupInfo，包含所有元老资源信息</span></span><br><span class="line">        apiGroupInfo, err := restStorageBuilder.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;problem initializing API group %q : %v&quot;</span>, groupName, err)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(groupName) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// the legacy group for core APIs is special that it is installed into /api via this special install method.</span></span><br><span class="line">            <span class="comment">// 将元老资源都 install 到 APIGroup 里面</span></span><br><span class="line">            <span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering legacy API: %w&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// everything else goes to /apis</span></span><br><span class="line">            nonLegacy = <span class="built_in">append</span>(nonLegacy, &amp;apiGroupInfo)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 非元老资源 install 进来</span></span><br><span class="line">    <span class="keyword">if</span> err := m.GenericAPIServer.InstallAPIGroups(nonLegacy...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering group versions: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体资源的定义，是通过包导入的方式实现。在 <code>cmd/kube-apiserver/app/server.go</code> 中，通过导入 <code>&quot;k8s.io/kubernetes/pkg/controlplane&quot;</code>，在 <code>pkg/controlplane/import_known_versions.go</code> 中，通过导入匿名包执行  <code>init</code> 函数实现导入</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="comment">// These imports are the API groups the API server will support.</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/admission/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/admissionregistration/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/apiserverinternal/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/apps/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/authentication/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/authorization/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/autoscaling/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/batch/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/certificates/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/coordination/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/core/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/discovery/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/events/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/extensions/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/flowcontrol/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/imagepolicy/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/networking/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/node/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/policy/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/rbac/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/resource/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/scheduling/install&quot;</span></span><br><span class="line">    _ <span class="string">&quot;k8s.io/kubernetes/pkg/apis/storage/install&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Install(legacyscheme.Scheme)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Install registers the API group and adds types to a scheme</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Install</span><span class="params">(scheme *runtime.Scheme)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 依次将group、version注册到了scheme中，并设置各version的优先级</span></span><br><span class="line">    utilruntime.Must(events.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(v1beta1.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(v1.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(scheme.SetVersionPriority(v1.SchemeGroupVersion, v1beta1.SchemeGroupVersion))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 <code>scheme</code> 导入到 API Server 中</p>
<p><code>pkg/api/legacyscheme/scheme.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// Scheme is the default instance of runtime.Scheme to which types in the Kubernetes API are already registered.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> If you are copying this file to start a new api group, STOP! Copy the</span></span><br><span class="line">    <span class="comment">// extensions group instead. This Scheme is special and should appear ONLY in</span></span><br><span class="line">    <span class="comment">// the api group, unless you really know what you&#x27;re doing.</span></span><br><span class="line">    <span class="comment">// TODO(lavalamp): make the above error impossible.</span></span><br><span class="line">    Scheme = runtime.NewScheme()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Codecs provides access to encoding and decoding for the scheme</span></span><br><span class="line">    Codecs = serializer.NewCodecFactory(Scheme)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ParameterCodec handles versioning of objects that are converted to query parameters.</span></span><br><span class="line">    ParameterCodec = runtime.NewParameterCodec(Scheme)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="Scheme"><a href="#Scheme" class="headerlink" title="Scheme"></a>Scheme</h1><p>Scheme 注册表，定义了序列化和反序列化 API 对象的方法，用于将组、版本和类型信息转换为 Go 模式，并在不同版本之间进行映射。</p>
<p>方案是随着时间推移而建立的分级 API 和配置的基础。</p>
<p>在一个 Scheme 中，Type 是特定的 Go 结构体，Version 是表示该 Type 特定表现形式的时点标识符（通常向后兼容），Kind 是该 Version 内 Type 的唯一名称，Group 标识一组随时间演变的 Versions、Kinds 和 Types。</p>
<p>Unversioned Type 指尚未正式绑定到类型并承诺向后兼容（实际上是不希望未来发生更改的 v1 类型）。</p>
<p>预计方案在运行时不会更改，并且只有在注册完成后才能保证线程安全。</p>
<p>总的来说，Schema 是一个结构体，内含处理外部 Version 之间转换，GVK 和 Go Type 之间转换之用的数据和方法。</p>
<p><code>vendor/k8s.io/apimachinery/pkg/runtime/scheme.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scheme defines methods for serializing and deserializing API objects, a type</span></span><br><span class="line"><span class="comment">// registry for converting group, version, and kind information to and from Go</span></span><br><span class="line"><span class="comment">// schemas, and mappings between Go schemas of different versions. A scheme is the</span></span><br><span class="line"><span class="comment">// foundation for a versioned API and versioned configuration over time.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In a Scheme, a Type is a particular Go struct, a Version is a point-in-time</span></span><br><span class="line"><span class="comment">// identifier for a particular representation of that Type (typically backwards</span></span><br><span class="line"><span class="comment">// compatible), a Kind is the unique name for that Type within the Version, and a</span></span><br><span class="line"><span class="comment">// Group identifies a set of Versions, Kinds, and Types that evolve over time. An</span></span><br><span class="line"><span class="comment">// Unversioned Type is one that is not yet formally bound to a type and is promised</span></span><br><span class="line"><span class="comment">// to be backwards compatible (effectively a &quot;v1&quot; of a Type that does not expect</span></span><br><span class="line"><span class="comment">// to break in the future).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Schemes are not expected to change at runtime and are only threadsafe after</span></span><br><span class="line"><span class="comment">// registration is complete.</span></span><br><span class="line"><span class="keyword">type</span> Scheme <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// gvkToType allows one to figure out the go type of an object with</span></span><br><span class="line">    <span class="comment">// the given version and name.</span></span><br><span class="line">  <span class="comment">// gvk 和 type 两者相互转换，用map结构存储gvk和Type的映射关系，一个gvk只会具体对应一个Type</span></span><br><span class="line">    gvkToType <span class="keyword">map</span>[schema.GroupVersionKind]reflect.Type</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 几乎所有的资源都是携带版本的，是常用的类型，用map结构存储type和gvk的映射关系，不同的是，一个type可能会对应多个gvk</span></span><br><span class="line">    <span class="comment">// typeToGVK allows one to find metadata for a given go object.</span></span><br><span class="line">    <span class="comment">// The reflect.Type we index by should *not* be a pointer.</span></span><br><span class="line">    typeToGVK <span class="keyword">map</span>[reflect.Type][]schema.GroupVersionKind</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无版本资源。这个在现版本的k8s中使用非常少，可以忽略</span></span><br><span class="line">    <span class="comment">// unversionedTypes are transformed without conversion in ConvertToVersion.</span></span><br><span class="line">    unversionedTypes <span class="keyword">map</span>[reflect.Type]schema.GroupVersionKind</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unversionedKinds are the names of kinds that can be created in the context of any group</span></span><br><span class="line">    <span class="comment">// or version</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> resolve the status of unversioned types.</span></span><br><span class="line">    unversionedKinds <span class="keyword">map</span>[<span class="type">string</span>]reflect.Type</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Map from version and resource to the corresponding func to convert</span></span><br><span class="line">    <span class="comment">// resource field labels in that version to internal version.</span></span><br><span class="line">    fieldLabelConversionFuncs <span class="keyword">map</span>[schema.GroupVersionKind]FieldLabelConversionFunc</span><br><span class="line"></span><br><span class="line">    <span class="comment">// defaulterFuncs is a map to funcs to be called with an object to provide defaulting</span></span><br><span class="line">    <span class="comment">// the provided object must be a pointer.</span></span><br><span class="line">  <span class="comment">// 设置默认值</span></span><br><span class="line">    defaulterFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// converter stores all registered conversion functions. It also has</span></span><br><span class="line">    <span class="comment">// default converting behavior.</span></span><br><span class="line">    <span class="comment">// map结构，存放资源版本转换的方法</span></span><br><span class="line">    converter *conversion.Converter</span><br><span class="line"></span><br><span class="line">    <span class="comment">// versionPriority is a map of groups to ordered lists of versions for those groups indicating the</span></span><br><span class="line">    <span class="comment">// default priorities of these versions as registered in the scheme</span></span><br><span class="line">    versionPriority <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// observedVersions keeps track of the order we&#x27;ve seen versions during type registration</span></span><br><span class="line">    observedVersions []schema.GroupVersion</span><br><span class="line"></span><br><span class="line">    <span class="comment">// schemeName is the name of this scheme.  If you don&#x27;t specify a name, the stack of the NewScheme caller will be used.</span></span><br><span class="line">    <span class="comment">// This is useful for error reporting to indicate the origin of the scheme.</span></span><br><span class="line">    schemeName <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GroupVersionKind unambiguously identifies a kind.  It doesn&#x27;t anonymously include GroupVersion</span></span><br><span class="line"><span class="comment">// to avoid automatic coercion.  It doesn&#x27;t use a GroupVersion to avoid custom marshalling</span></span><br><span class="line"><span class="keyword">type</span> GroupVersionKind <span class="keyword">struct</span> &#123;</span><br><span class="line">    Group   <span class="type">string</span></span><br><span class="line">    Version <span class="type">string</span></span><br><span class="line">    Kind    <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方通常通过缩写词 <strong>GVR</strong>(GroupVersionKind) 来描述一个资源的明确位置(类似于绝对路径)，例如 deployment 对应的路径是：<code>apps/v1/deployments/status</code>。</p>
<p>同理，<strong>GVK</strong>(GroupVersionKind) 锚定资源的明确所属类型，在项目代码中也经常用到。</p>
<p>一般来说，Scheme 的用法是通过 json&#x2F;yaml 序列化成某一个版本，然后转换成 内部数据，或者通过其他的方式，以另外的版本注入数据。</p>
<p>因此，可能某一个 API Object 由 V1 版本创建，但是可以通过被其他的版本例如 V2 的客户端操作。</p>
<p>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Converter() *Converter</span><br><span class="line">AddUnversionedTypes(version GroupVersion, types ...Object)</span><br><span class="line"><span class="comment">// 提供的两个注册方法，使用 reflect 反射的方法获取 type obj 的 gvk 然后进行注册</span></span><br><span class="line">AddKnownTypes(gv GroupVersion, types ...Object)</span><br><span class="line">AddKnownTypeWithName(gvk GroupVersionKind, obj Object)</span><br><span class="line"></span><br><span class="line">KnownTypes(gv GroupVersion) <span class="keyword">map</span>[<span class="type">string</span>]reflect.Type</span><br><span class="line">VersionsForGroupKind(gk GroupKind) []GroupVersion</span><br><span class="line">AllKnownTypes() <span class="keyword">map</span>[GroupVersionKind]reflect.Type</span><br><span class="line">ObjectKinds(obj Object) ([]GroupVersionKind, <span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">Recognizes(gvk GroupVersionKind) <span class="type">bool</span></span><br><span class="line">IsUnversioned(obj Object) (<span class="type">bool</span>, <span class="type">bool</span>)</span><br><span class="line">New(kind GroupVersionKind) (Object, <span class="type">error</span>)</span><br><span class="line">AddIgnoredConversionType(from <span class="keyword">interface</span>&#123;&#125;, to <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">AddConversionFunc(a <span class="keyword">interface</span>&#123;&#125;, b <span class="keyword">interface</span>&#123;&#125;, fn ConversionFunc) <span class="type">error</span></span><br><span class="line">AddGeneratedConversionFunc(a <span class="keyword">interface</span>&#123;&#125;, b <span class="keyword">interface</span>&#123;&#125;, fn ConversionFunc) <span class="type">error</span></span><br><span class="line">AddFieldLabelConversionFunc(gvk GroupVersionKind, conversionFunc FieldLabelConversionFunc) <span class="type">error</span></span><br><span class="line">AddTypeDefaultingFunc(srcType Object, fn <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span>)</span><br><span class="line">Default(src Object)</span><br><span class="line">Convert(in <span class="keyword">interface</span>&#123;&#125;, out <span class="keyword">interface</span>&#123;&#125;, context <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">ConvertFieldLabel(gvk GroupVersionKind, label <span class="type">string</span>, value <span class="type">string</span>) (<span class="type">string</span>, <span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">ConvertToVersion(in Object, target GroupVersioner) (Object, <span class="type">error</span>)</span><br><span class="line">UnsafeConvertToVersion(in Object, target GroupVersioner) (Object, <span class="type">error</span>)</span><br><span class="line">SetVersionPriority(versions ...GroupVersion) <span class="type">error</span></span><br><span class="line">PrioritizedVersionsForGroup(group <span class="type">string</span>) []GroupVersion</span><br><span class="line">PrioritizedVersionsAllGroups() []GroupVersion</span><br><span class="line">PreferredVersionAllGroups() []GroupVersion</span><br><span class="line">IsGroupRegistered(group <span class="type">string</span>) <span class="type">bool</span></span><br><span class="line">IsVersionRegistered(version GroupVersion) <span class="type">bool</span></span><br><span class="line">Name() <span class="type">string</span></span><br></pre></td></tr></table></figure>

<p>注入的过程，例如：</p>
<p><code>vendor/k8s.io/api/apps/v1/register.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> move SchemeBuilder with zz_generated.deepcopy.go to k8s.io/api.</span></span><br><span class="line">    <span class="comment">// localSchemeBuilder and AddToScheme will stay in k8s.io/kubernetes.</span></span><br><span class="line">    SchemeBuilder      = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">    localSchemeBuilder = &amp;SchemeBuilder</span><br><span class="line">    AddToScheme        = localSchemeBuilder.AddToScheme</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adds the list of known types to the given scheme.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">        &amp;Deployment&#123;&#125;,</span><br><span class="line">        &amp;DeploymentList&#123;&#125;,</span><br><span class="line">        &amp;StatefulSet&#123;&#125;,</span><br><span class="line">        &amp;StatefulSetList&#123;&#125;,</span><br><span class="line">        &amp;DaemonSet&#123;&#125;,</span><br><span class="line">        &amp;DaemonSetList&#123;&#125;,</span><br><span class="line">        &amp;ReplicaSet&#123;&#125;,</span><br><span class="line">        &amp;ReplicaSetList&#123;&#125;,</span><br><span class="line">        &amp;ControllerRevision&#123;&#125;,</span><br><span class="line">        &amp;ControllerRevisionList&#123;&#125;,</span><br><span class="line">    )</span><br><span class="line">    metav1.AddToGroupVersion(scheme, SchemeGroupVersion)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入的内容就是 kubernetes 里面的 Object</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deployment enables declarative updates for Pods and ReplicaSets.</span></span><br><span class="line"><span class="keyword">type</span> Deployment <span class="keyword">struct</span> &#123;</span><br><span class="line">    metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">    <span class="comment">// Standard object&#x27;s metadata.</span></span><br><span class="line">    <span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specification of the desired behavior of the Deployment.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Spec DeploymentSpec <span class="string">`json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name=spec&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Most recently observed status of the Deployment.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Status DeploymentStatus <span class="string">`json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name=status&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 Builder  的设计模式，构建 Object：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F05%2F03%2F22-12-54-image-20240503221253955.png" alt="image-20240503221253955"></p>
<h2 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h2><p>Runtime库被称为运行时，几乎是所有程序的核心库，在k8s中也不例外。</p>
<p>k8s的运行时实现在 <code>vendor/k8s.io/apimachinery/pkg/runtime/</code> 路径下。</p>
<p>其中，runtime.Object是K8s中所有资源类型结构的基石，作为interface被封装，所有的资源对象均以runtime.Object为基础结构实现了相应的interface方法，runtime.Object是一种通用的struct结构体，资源对象可以与runtime.Object通用对象互相转换。</p>
<p><code>vendor/k8s.io/apimachinery/pkg/runtime/interfaces.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object interface must be supported by all API types registered with Scheme. Since objects in a scheme are</span></span><br><span class="line"><span class="comment">// expected to be serialized to the wire, the interface an Object must provide to the Scheme allows</span></span><br><span class="line"><span class="comment">// serializers to set the kind, version, and group the object is represented as. An Object may choose</span></span><br><span class="line"><span class="comment">// to return a no-op ObjectKindAccessor in cases where it is not expected to be serialized.</span></span><br><span class="line"><span class="keyword">type</span> Object <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetObjectKind() schema.ObjectKind</span><br><span class="line">    DeepCopyObject() Object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apimachinery/pkg/runtime/schema/interfaces.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// All objects that are serialized from a Scheme encode their type information. This interface is used</span></span><br><span class="line"><span class="comment">// by serialization to set type information from the Scheme onto the serialized version of an object.</span></span><br><span class="line"><span class="comment">// For objects that cannot be serialized or have unique requirements, this interface may be a no-op.</span></span><br><span class="line"><span class="keyword">type</span> ObjectKind <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil</span></span><br><span class="line">    <span class="comment">// should clear the current setting.</span></span><br><span class="line">    SetGroupVersionKind(kind GroupVersionKind)</span><br><span class="line">    <span class="comment">// GroupVersionKind returns the stored group, version, and kind of an object, or an empty struct</span></span><br><span class="line">    <span class="comment">// if the object does not expose or provide these fields.</span></span><br><span class="line">    GroupVersionKind() GroupVersionKind</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APIServer对资源的描述支持多种格式，分别对应不同的Serializer。</p>
<p><code>vendor/k8s.io/apimachinery/pkg/runtime/serializer/codec_factory.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CodecFactory provides methods for retrieving codecs and serializers for specific</span></span><br><span class="line"><span class="comment">// versions and content types.</span></span><br><span class="line"><span class="keyword">type</span> CodecFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">    scheme    *runtime.Scheme</span><br><span class="line">    universal runtime.Decoder</span><br><span class="line">    accepts   []runtime.SerializerInfo</span><br><span class="line"></span><br><span class="line">    legacySerializer runtime.Serializer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 yaml 的序列化代码可以看到，默认以json格式响应，而对于yaml格式，先将其转换为json格式，再转换回yaml格式响应。</p>
<p><code>vendor/k8s.io/apimachinery/pkg/runtime/serializer/yaml/yaml.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// yamlSerializer converts YAML passed to the Decoder methods to JSON.</span></span><br><span class="line"><span class="keyword">type</span> yamlSerializer <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// the nested serializer</span></span><br><span class="line">    runtime.Serializer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// yamlSerializer implements Serializer</span></span><br><span class="line"><span class="keyword">var</span> _ runtime.Serializer = yamlSerializer&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewDecodingSerializer adds YAML decoding support to a serializer that supports JSON.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecodingSerializer</span><span class="params">(jsonSerializer runtime.Serializer)</span></span> runtime.Serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;yamlSerializer&#123;jsonSerializer&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c yamlSerializer)</span></span> Decode(data []<span class="type">byte</span>, gvk *schema.GroupVersionKind, into runtime.Object) (runtime.Object, *schema.GroupVersionKind, <span class="type">error</span>) &#123;</span><br><span class="line">    out, err := yaml.ToJSON(data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    data = out</span><br><span class="line">    <span class="keyword">return</span> c.Serializer.Decode(data, gvk, into)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h2><p>在K8s的设计中，<code>resource</code> 是其最基础、最重要的概念，也是最小的管理单位，所有的管理对象都承载在一个个的 <code>resource</code> 实例上，为了实现这些 <code>resource</code> 的复杂管理逻辑，又进一步地将他们分组化、版本化，依照逻辑层次，形成了 <code>Group</code>、<code>Version</code>、<code>Kind</code>、<code>Resource</code> 核心数据结构：</p>
<ul>
<li>Group：资源组，也称APIGroup，常见的有core、apps、extensions等 <code>vendor/k8s.io/api</code> 目录下</li>
<li>Version：资源版本，也称APIVersion，常见的有v1、v1beta1 (Resource可能属于拥有多个Version，这些version也会有优先级之分，例如deployment即属于apps&#x2F;v1,又属于extensions&#x2F;v1beta1，在不同k8s版本中，version的优先级可能会变化)</li>
<li>Kind：资源种类，描述资源的类别，例如pod类别、svc类别等</li>
<li>Resource：资源实例对象，也称为 APIResource</li>
<li>SubResource：子资源，部分资源实例会 有子资源，例如 Deployment 资源会拥有 Status 子资源</li>
<li>CRD: Custom Resource Definitions，用户自定义资源类型</li>
</ul>
<p>资源操作方式：</p>
<p>概念层面，每种resource都有对应的管理操作方法，目前支持的有这几种：</p>
<ul>
<li>get</li>
<li>list</li>
<li>watch</li>
<li>create</li>
<li>update</li>
<li>patch</li>
<li>delete</li>
<li>deletecolletction</li>
<li>proxy</li>
</ul>
<p>分别归属于 增、删、改、查四类。</p>
<p>落实到代码里，资源对应的操作方法，都在metav1.Verbs结构体中归纳：</p>
<p><code>vendor/k8s.io/apimachinery/pkg/apis/meta/v1/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// APIResource specifies the name of a resource and whether it is namespaced.</span></span><br><span class="line"><span class="keyword">type</span> APIResource <span class="keyword">struct</span> &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// verbs is a list of supported kube verbs (this includes get, list, watch, create,</span></span><br><span class="line">    <span class="comment">// update, patch, delete, deletecollection, and proxy)</span></span><br><span class="line">    Verbs Verbs <span class="string">`json:&quot;verbs&quot; protobuf:&quot;bytes,4,opt,name=verbs&quot;`</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Verbs masks the value so protobuf can generate</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// +protobuf.nullable=true</span></span><br><span class="line"><span class="comment">// +protobuf.options.(gogoproto.goproto_stringer)=false</span></span><br><span class="line"><span class="keyword">type</span> Verbs []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(vs Verbs)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, []<span class="type">string</span>(vs))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>[]string</code>结构来描述资源所对应的操作，而[]string终归只是描述，需要与实际的存储资源CRUD操作关联。</p>
<h2 id="Internal-Version-注册方式"><a href="#Internal-Version-注册方式" class="headerlink" title="Internal Version 注册方式"></a>Internal Version 注册方式</h2><p>在k8s的设计中，资源版本分外部版本(external)和内部版本(internal)之分，外部版本(例如v1&#x2F;v1beta1&#x2F;v1beta2)提供给外部使用，而对应的内部版本仅在APIServer内部使用。</p>
<p>区分内外版本的作用：</p>
<ul>
<li>提供不同版本之间的转换功能，例如从v1beta1–&gt;v1的过程实际是v1beta1–&gt; internal –&gt;v1，转换函数会注册到scheme表中</li>
<li>减少复杂度，方便版本维护，避免维护多个版本的对应代码，实际APIServer端处理的都是转换后的内部版本</li>
<li>不同外部版本资源之间的字段&#x2F;功能可能存在些许差异，而内部版本包含所有版本的字段&#x2F;功能，这为它作为外部资源版本之间转换的桥梁提供了基础。</li>
</ul>
<p>内部版本和外部版本对于资源结构体定义显著的区别是，内部版本是不带json和proto标签的，因为其不需要结构化提供给外部。</p>
<p>以向APIServer发起创建一个资源实例为例，在解码时，APIServer首先从 HTTP 路径中获取对应的外部version，然后使用 scheme 以外部version创建一个空对象，然后将该对象转换成内部版本对应的对象结构进行持久存储(写入etcd).</p>
<p>而在查询请求中，资源对象会被从内部版本转换为路径对应的外部版本，响应给请求端。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F05%2F08%2F10-13-35-1583210632919-e5d25e2f-5028-4112-99d8-cca024834a05.png" alt="image.png"></p>
<p>内部版本的代码：</p>
<p><code>pkg/apis/apps/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StatefulSet <span class="keyword">struct</span> &#123;</span><br><span class="line">    metav1.TypeMeta</span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    metav1.ObjectMeta</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spec defines the desired identities of pods in this set.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Spec StatefulSetSpec</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status is the current status of Pods in this StatefulSet. This data</span></span><br><span class="line">    <span class="comment">// may be out of date by some window of time.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Status StatefulSetStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pkg/apis/apps/install/install.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 注册 legacyscheme 中的 Schema</span></span><br><span class="line">    Install(legacyscheme.Scheme)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Install registers the API group and adds types to a scheme</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Install</span><span class="params">(scheme *runtime.Scheme)</span></span> &#123;</span><br><span class="line">    utilruntime.Must(apps.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(v1beta1.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(v1beta2.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(v1.AddToScheme(scheme))</span><br><span class="line">    utilruntime.Must(scheme.SetVersionPriority(v1.SchemeGroupVersion, v1beta2.SchemeGroupVersion, v1beta1.SchemeGroupVersion))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pkg/apis/apps/register.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// SchemeBuilder stores functions to add things to a scheme.</span></span><br><span class="line">    SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">    <span class="comment">// AddToScheme applies all stored functions t oa scheme.</span></span><br><span class="line">    AddToScheme = SchemeBuilder.AddToScheme</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="External-Version-注册方式"><a href="#External-Version-注册方式" class="headerlink" title="External Version 注册方式"></a>External Version 注册方式</h2><p>外部版本的代码路径为</p>
<p><code>vendor/k8s.io/api/apps/v1/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StatefulSet represents a set of pods with consistent identities.</span></span><br><span class="line"><span class="comment">// Identities are defined as:</span></span><br><span class="line"><span class="comment">//   - Network: A single stable DNS and hostname.</span></span><br><span class="line"><span class="comment">//   - Storage: As many VolumeClaims as requested.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The StatefulSet guarantees that a given network identity will always</span></span><br><span class="line"><span class="comment">// map to the same storage identity.</span></span><br><span class="line"><span class="keyword">type</span> StatefulSet <span class="keyword">struct</span> &#123;</span><br><span class="line">    metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">    <span class="comment">// Standard object&#x27;s metadata.</span></span><br><span class="line">    <span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spec defines the desired identities of pods in this set.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Spec StatefulSetSpec <span class="string">`json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name=spec&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status is the current status of Pods in this StatefulSet. This data</span></span><br><span class="line">    <span class="comment">// may be out of date by some window of time.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Status StatefulSetStatus <span class="string">`json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name=status&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如 V1，与 Internal Version 共用 <code>install.go</code></p>
<p><code>pkg/apis/apps/v1/register.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// We only register manually written functions here. The registration of the</span></span><br><span class="line">    <span class="comment">// generated functions takes place in the generated files. The separation</span></span><br><span class="line">    <span class="comment">// makes the code compile even when the generated files are missing.</span></span><br><span class="line">    localSchemeBuilder.Register(addDefaultingFuncs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及通过代码生成的方式注册</p>
<p><code>pkg/apis/apps/v1/zz_generated.conversion.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    localSchemeBuilder.Register(RegisterConversions)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码生生成方式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:conversion-gen=k8s.io/kubernetes/pkg/apis/apps</span></span><br><span class="line"><span class="comment">// +k8s:conversion-gen-external-types=k8s.io/api/apps/v1</span></span><br><span class="line"><span class="comment">// +k8s:defaulter-gen=TypeMeta</span></span><br><span class="line"><span class="comment">// +k8s:defaulter-gen-input=k8s.io/api/apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> v1 <span class="comment">// import &quot;k8s.io/kubernetes/pkg/apis/apps/v1&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用代码生成的原因：</p>
<ol>
<li>有 Internal 和 External Version 的转换</li>
<li>Go 语言没有继承机制</li>
</ol>
<p>例如：</p>
<p><code>pkg/apis/apps/v1/zz_generated.conversion.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">autoConvert_v1_ControllerRevision_To_apps_ControllerRevision</span><span class="params">(in *v1.ControllerRevision, out *apps.ControllerRevision, s conversion.Scope)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    out.ObjectMeta = in.ObjectMeta</span><br><span class="line">    <span class="keyword">if</span> err := runtime.Convert_runtime_RawExtension_To_runtime_Object(&amp;in.Data, &amp;out.Data, s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    out.Revision = in.Revision</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">autoConvert_apps_ControllerRevision_To_v1_ControllerRevision</span><span class="params">(in *apps.ControllerRevision, out *v1.ControllerRevision, s conversion.Scope)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    out.ObjectMeta = in.ObjectMeta</span><br><span class="line">    <span class="keyword">if</span> err := runtime.Convert_runtime_Object_To_runtime_RawExtension(&amp;in.Data, &amp;out.Data, s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    out.Revision = in.Revision</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pkg/apis/apps/v1/zz_generated.defaults.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetObjectDefaults_Deployment</span><span class="params">(in *v1.Deployment)</span></span> &#123;</span><br><span class="line">    SetDefaults_Deployment(in)</span><br><span class="line">    corev1.SetDefaults_PodSpec(&amp;in.Spec.Template.Spec)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><code>pkg/apis/apps/v1/defaults.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetDefaults_Deployment sets additional defaults compared to its counterpart</span></span><br><span class="line"><span class="comment">// in extensions. These addons are:</span></span><br><span class="line"><span class="comment">// - MaxUnavailable during rolling update set to 25% (1 in extensions)</span></span><br><span class="line"><span class="comment">// - MaxSurge value during rolling update set to 25% (1 in extensions)</span></span><br><span class="line"><span class="comment">// - RevisionHistoryLimit set to 10 (not set in extensions)</span></span><br><span class="line"><span class="comment">// - ProgressDeadlineSeconds set to 600s (not set in extensions)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetDefaults_Deployment</span><span class="params">(obj *appsv1.Deployment)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set DeploymentSpec.Replicas to 1 if it is not set.</span></span><br><span class="line">    <span class="keyword">if</span> obj.Spec.Replicas == <span class="literal">nil</span> &#123;</span><br><span class="line">        obj.Spec.Replicas = <span class="built_in">new</span>(<span class="type">int32</span>)</span><br><span class="line">        *obj.Spec.Replicas = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    strategy := &amp;obj.Spec.Strategy</span><br><span class="line">    <span class="comment">// Set default DeploymentStrategyType as RollingUpdate.</span></span><br><span class="line">    <span class="keyword">if</span> strategy.Type == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        strategy.Type = appsv1.RollingUpdateDeploymentStrategyType</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> strategy.Type == appsv1.RollingUpdateDeploymentStrategyType &#123;</span><br><span class="line">        <span class="keyword">if</span> strategy.RollingUpdate == <span class="literal">nil</span> &#123;</span><br><span class="line">            rollingUpdate := appsv1.RollingUpdateDeployment&#123;&#125;</span><br><span class="line">            strategy.RollingUpdate = &amp;rollingUpdate</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> strategy.RollingUpdate.MaxUnavailable == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// Set default MaxUnavailable as 25% by default.</span></span><br><span class="line">            maxUnavailable := intstr.FromString(<span class="string">&quot;25%&quot;</span>)</span><br><span class="line">            strategy.RollingUpdate.MaxUnavailable = &amp;maxUnavailable</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> strategy.RollingUpdate.MaxSurge == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// Set default MaxSurge as 25% by default.</span></span><br><span class="line">            maxSurge := intstr.FromString(<span class="string">&quot;25%&quot;</span>)</span><br><span class="line">            strategy.RollingUpdate.MaxSurge = &amp;maxSurge</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> obj.Spec.RevisionHistoryLimit == <span class="literal">nil</span> &#123;</span><br><span class="line">        obj.Spec.RevisionHistoryLimit = <span class="built_in">new</span>(<span class="type">int32</span>)</span><br><span class="line">        *obj.Spec.RevisionHistoryLimit = <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> obj.Spec.ProgressDeadlineSeconds == <span class="literal">nil</span> &#123;</span><br><span class="line">        obj.Spec.ProgressDeadlineSeconds = <span class="built_in">new</span>(<span class="type">int32</span>)</span><br><span class="line">        *obj.Spec.ProgressDeadlineSeconds = <span class="number">600</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Generic-Server"><a href="#Generic-Server" class="headerlink" title="Generic Server"></a>Generic Server</h1><p>提供暴露 http 服务所需基础设施。将操作 API Object 的 restful 服务暴露出去。</p>
<p><code>vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericAPIServer contains state for a Kubernetes cluster api server.</span></span><br><span class="line"><span class="keyword">type</span> GenericAPIServer <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// &quot;Outputs&quot;</span></span><br><span class="line">    <span class="comment">// Handler holds the handlers being used by this API server</span></span><br><span class="line">    <span class="comment">// http handler 句柄</span></span><br><span class="line">    Handler *APIServerHandler</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一些钩子函数</span></span><br><span class="line">    <span class="comment">// PostStartHooks are each called after the server has started listening, in a separate go func for each</span></span><br><span class="line">    <span class="comment">// with no guarantee of ordering between them.  The map key is a name used for error reporting.</span></span><br><span class="line">    <span class="comment">// It may kill the process with a panic if it wishes to by returning an error.</span></span><br><span class="line">    postStartHookLock      sync.Mutex</span><br><span class="line">    postStartHooks         <span class="keyword">map</span>[<span class="type">string</span>]postStartHookEntry</span><br><span class="line">    postStartHooksCalled   <span class="type">bool</span></span><br><span class="line">    disabledPostStartHooks sets.String</span><br><span class="line"></span><br><span class="line">    preShutdownHookLock    sync.Mutex</span><br><span class="line">    preShutdownHooks       <span class="keyword">map</span>[<span class="type">string</span>]preShutdownHookEntry</span><br><span class="line">    preShutdownHooksCalled <span class="type">bool</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些重要方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">UnprotectedHandler() http.Handler</span><br><span class="line">PostStartHooks() <span class="keyword">map</span>[<span class="type">string</span>]postStartHookEntry</span><br><span class="line">PreShutdownHooks() <span class="keyword">map</span>[<span class="type">string</span>]preShutdownHookEntry</span><br><span class="line">HealthzChecks() []HealthChecker</span><br><span class="line">ListedPaths() []<span class="type">string</span></span><br><span class="line">NextDelegate() DelegationTarget</span><br><span class="line">RegisterMuxAndDiscoveryCompleteSignal(signalName <span class="type">string</span>, signal &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">MuxAndDiscoveryCompleteSignals() <span class="keyword">map</span>[<span class="type">string</span>]&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">RegisterDestroyFunc(destroyFn <span class="function"><span class="keyword">func</span><span class="params">()</span></span>)</span><br><span class="line">Destroy()</span><br><span class="line">PrepareRun() preparedGenericAPIServer</span><br><span class="line">InstallLegacyAPIGroup(apiPrefix <span class="type">string</span>, apiGroupInfo *APIGroupInfo) <span class="type">error</span></span><br><span class="line">InstallAPIGroups(apiGroupInfos ...*APIGroupInfo) <span class="type">error</span></span><br><span class="line">InstallAPIGroup(apiGroupInfo *APIGroupInfo) <span class="type">error</span></span><br><span class="line">AddHealthChecks(checks ...HealthChecker) <span class="type">error</span></span><br><span class="line">AddBootSequenceHealthChecks(checks ...HealthChecker) <span class="type">error</span></span><br><span class="line">AddReadyzChecks(checks ...HealthChecker) <span class="type">error</span></span><br><span class="line">AddLivezChecks(delay time.Duration, checks ...HealthChecker) <span class="type">error</span></span><br><span class="line">AddPostStartHook(name <span class="type">string</span>, hook PostStartHookFunc) <span class="type">error</span></span><br><span class="line">AddPostStartHookOrDie(name <span class="type">string</span>, hook PostStartHookFunc)</span><br><span class="line">AddPreShutdownHook(name <span class="type">string</span>, hook PreShutdownHookFunc) <span class="type">error</span></span><br><span class="line">AddPreShutdownHookOrDie(name <span class="type">string</span>, hook PreShutdownHookFunc)</span><br><span class="line">RunPostStartHooks(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">RunPreShutdownHooks() <span class="type">error</span></span><br></pre></td></tr></table></figure>

<p>构建 Requets Handler</p>
<p><code>pkg/controlplane/instance.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*Instance, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    s, err := c.GenericConfig.New(<span class="string">&quot;kube-apiserver&quot;</span>, delegationTarget)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/config.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(name <span class="type">string</span>, delegationTarget DelegationTarget) (*GenericAPIServer, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    apiServerHandler := NewAPIServerHandler(name, c.Serializer, handlerChainBuilder, delegationTarget.UnprotectedHandler())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/handler.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIServerHandler</span><span class="params">(name <span class="type">string</span>, s runtime.NegotiatedSerializer, handlerChainBuilder HandlerChainBuilderFn, notFoundHandler http.Handler)</span></span> *APIServerHandler &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构建 handler</span></span><br><span class="line">  </span><br><span class="line">    nonGoRestfulMux := mux.NewPathRecorderMux(name)</span><br><span class="line">    <span class="keyword">if</span> notFoundHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">        nonGoRestfulMux.NotFoundHandler(notFoundHandler)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 使用 restful 构建 mux</span></span><br><span class="line">    gorestfulContainer := restful.NewContainer()</span><br><span class="line">    gorestfulContainer.ServeMux = http.NewServeMux()</span><br><span class="line">    gorestfulContainer.Router(restful.CurlyRouter&#123;&#125;) <span class="comment">// e.g. for proxy/&#123;kind&#125;/&#123;name&#125;/&#123;*&#125;</span></span><br><span class="line">    gorestfulContainer.RecoverHandler(<span class="function"><span class="keyword">func</span><span class="params">(panicReason <span class="keyword">interface</span>&#123;&#125;, httpWriter http.ResponseWriter)</span></span> &#123;</span><br><span class="line">        logStackOnRecover(s, panicReason, httpWriter)</span><br><span class="line">    &#125;)</span><br><span class="line">    gorestfulContainer.ServiceErrorHandler(<span class="function"><span class="keyword">func</span><span class="params">(serviceErr restful.ServiceError, request *restful.Request, response *restful.Response)</span></span> &#123;</span><br><span class="line">        serviceErrorHandler(s, serviceErr, request, response)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    director := director&#123;</span><br><span class="line">        name:               name,</span><br><span class="line">        goRestfulContainer: gorestfulContainer,</span><br><span class="line">        nonGoRestfulMux:    nonGoRestfulMux,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最后的 Handler</span></span><br><span class="line">    <span class="keyword">return</span> &amp;APIServerHandler&#123;</span><br><span class="line">        FullHandlerChain:   handlerChainBuilder(director),</span><br><span class="line">        GoRestfulContainer: gorestfulContainer,</span><br><span class="line">        NonGoRestfulMux:    nonGoRestfulMux,</span><br><span class="line">        Director:           director,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/handler.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeHTTP makes it an http.Handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *APIServerHandler)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">    a.FullHandlerChain.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>k8s选用的Restful框架是go-restful，简单说明一下go-restful的结构，辅助后面对于APIServer工作流程的理解。</p>
<p>go-restful 层级结构概念自顶上下依次有:</p>
<ul>
<li>Container: 一个Container就是一个独立的http server，可拥有独立的地址端口组合(类似nginx的server层级)</li>
<li>WebService： 大粒度的分类，某一类别的服务可归属到同一个WebService中，其下包含多个Route</li>
<li>Route: 每个Route对应具体的uri路径，将该路径路由到对应的handler函数上</li>
</ul>
<blockquote>
<p> 基本上跟 gin 框架差不多，mux 为句柄，相等于 Container，WebService 为 group，route 为具体处理请求的 handler。</p>
</blockquote>
<p>再看 <code>handlerChainBuilder</code>，构建出的 <code>Chain</code></p>
<p><code>vendor/k8s.io/apiserver/pkg/server/config.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(name <span class="type">string</span>, delegationTarget DelegationTarget) (*GenericAPIServer, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    handlerChainBuilder := <span class="function"><span class="keyword">func</span><span class="params">(handler http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">        <span class="keyword">return</span> c.BuildHandlerChainFunc(handler, c.Config)</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cmd/kube-apiserver/app/aggregator.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createAggregatorConfig</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    kubeAPIServerConfig genericapiserver.Config,</span></span></span><br><span class="line"><span class="params"><span class="function">    commandOptions controlplaneapiserver.CompletedOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">    externalInformers kubeexternalinformers.SharedInformerFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">    serviceResolver aggregatorapiserver.ServiceResolver,</span></span></span><br><span class="line"><span class="params"><span class="function">    proxyTransport *http.Transport,</span></span></span><br><span class="line"><span class="params"><span class="function">    peerProxy utilpeerproxy.Interface,</span></span></span><br><span class="line"><span class="params"><span class="function">    pluginInitializers []admission.PluginInitializer,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> (*aggregatorapiserver.Config, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">        genericConfig.BuildHandlerChainFunc = genericapiserver.BuildHandlerChainWithStorageVersionPrecondition</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/config.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildHandlerChainWithStorageVersionPrecondition</span><span class="params">(apiHandler http.Handler, c *Config)</span></span> http.Handler &#123;</span><br><span class="line">    <span class="comment">// WithStorageVersionPrecondition needs the WithRequestInfo to run first</span></span><br><span class="line">    handler := genericapifilters.WithStorageVersionPrecondition(apiHandler, c.StorageVersionManager, c.Serializer)</span><br><span class="line">    <span class="keyword">return</span> DefaultBuildHandlerChain(handler, c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>鉴权、超时、跨域、重试、recovery 等等</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultBuildHandlerChain</span><span class="params">(apiHandler http.Handler, c *Config)</span></span> http.Handler &#123;</span><br><span class="line">    handler := apiHandler</span><br><span class="line"></span><br><span class="line">    handler = filterlatency.TrackCompleted(handler)</span><br><span class="line">    handler = genericapifilters.WithAuthorization(handler, c.Authorization.Authorizer, c.Serializer)</span><br><span class="line">    handler = filterlatency.TrackStarted(handler, c.TracerProvider, <span class="string">&quot;authorization&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c.FlowControl != <span class="literal">nil</span> &#123;</span><br><span class="line">       workEstimatorCfg := flowcontrolrequest.DefaultWorkEstimatorConfig()</span><br><span class="line">       requestWorkEstimator := flowcontrolrequest.NewWorkEstimator(</span><br><span class="line">          c.StorageObjectCountTracker.Get, c.FlowControl.GetInterestedWatchCount, workEstimatorCfg, c.FlowControl.GetMaxSeats)</span><br><span class="line">       handler = filterlatency.TrackCompleted(handler)</span><br><span class="line">       handler = genericfilters.WithPriorityAndFairness(handler, c.LongRunningFunc, c.FlowControl, requestWorkEstimator, c.RequestTimeout/<span class="number">4</span>)</span><br><span class="line">       handler = filterlatency.TrackStarted(handler, c.TracerProvider, <span class="string">&quot;priorityandfairness&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       handler = genericfilters.WithMaxInFlightLimit(handler, c.MaxRequestsInFlight, c.MaxMutatingRequestsInFlight, c.LongRunningFunc)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handler = filterlatency.TrackCompleted(handler)</span><br><span class="line">    handler = genericapifilters.WithImpersonation(handler, c.Authorization.Authorizer, c.Serializer)</span><br><span class="line">    handler = filterlatency.TrackStarted(handler, c.TracerProvider, <span class="string">&quot;impersonation&quot;</span>)</span><br><span class="line"></span><br><span class="line">    handler = filterlatency.TrackCompleted(handler)</span><br><span class="line">    handler = genericapifilters.WithAudit(handler, c.AuditBackend, c.AuditPolicyRuleEvaluator, c.LongRunningFunc)</span><br><span class="line">    handler = filterlatency.TrackStarted(handler, c.TracerProvider, <span class="string">&quot;audit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    failedHandler := genericapifilters.Unauthorized(c.Serializer)</span><br><span class="line">    failedHandler = genericapifilters.WithFailedAuthenticationAudit(failedHandler, c.AuditBackend, c.AuditPolicyRuleEvaluator)</span><br><span class="line"></span><br><span class="line">    failedHandler = filterlatency.TrackCompleted(failedHandler)</span><br><span class="line">    handler = filterlatency.TrackCompleted(handler)</span><br><span class="line">    handler = genericapifilters.WithAuthentication(handler, c.Authentication.Authenticator, failedHandler, c.Authentication.APIAudiences, c.Authentication.RequestHeaderConfig)</span><br><span class="line">    handler = filterlatency.TrackStarted(handler, c.TracerProvider, <span class="string">&quot;authentication&quot;</span>)</span><br><span class="line"></span><br><span class="line">    handler = genericfilters.WithCORS(handler, c.CorsAllowedOriginList, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WithTimeoutForNonLongRunningRequests will call the rest of the request handling in a go-routine with the</span></span><br><span class="line">    <span class="comment">// context with deadline. The go-routine can keep running, while the timeout logic will return a timeout to the client.</span></span><br><span class="line">    handler = genericfilters.WithTimeoutForNonLongRunningRequests(handler, c.LongRunningFunc)</span><br><span class="line"></span><br><span class="line">    handler = genericapifilters.WithRequestDeadline(handler, c.AuditBackend, c.AuditPolicyRuleEvaluator,</span><br><span class="line">       c.LongRunningFunc, c.Serializer, c.RequestTimeout)</span><br><span class="line">    handler = genericfilters.WithWaitGroup(handler, c.LongRunningFunc, c.NonLongRunningRequestWaitGroup)</span><br><span class="line">    <span class="keyword">if</span> c.ShutdownWatchTerminationGracePeriod &gt; <span class="number">0</span> &#123;</span><br><span class="line">       handler = genericfilters.WithWatchTerminationDuringShutdown(handler, c.lifecycleSignals, c.WatchRequestWaitGroup)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c.SecureServing != <span class="literal">nil</span> &amp;&amp; !c.SecureServing.DisableHTTP2 &amp;&amp; c.GoawayChance &gt; <span class="number">0</span> &#123;</span><br><span class="line">       handler = genericfilters.WithProbabilisticGoaway(handler, c.GoawayChance)</span><br><span class="line">    &#125;</span><br><span class="line">    handler = genericapifilters.WithWarningRecorder(handler)</span><br><span class="line">    handler = genericapifilters.WithCacheControl(handler)</span><br><span class="line">    handler = genericfilters.WithHSTS(handler, c.HSTSDirectives)</span><br><span class="line">    <span class="keyword">if</span> c.ShutdownSendRetryAfter &#123;</span><br><span class="line">       handler = genericfilters.WithRetryAfter(handler, c.lifecycleSignals.NotAcceptingNewRequest.Signaled())</span><br><span class="line">    &#125;</span><br><span class="line">    handler = genericfilters.WithHTTPLogging(handler)</span><br><span class="line">    <span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(genericfeatures.APIServerTracing) &#123;</span><br><span class="line">       handler = genericapifilters.WithTracing(handler, c.TracerProvider)</span><br><span class="line">    &#125;</span><br><span class="line">    handler = genericapifilters.WithLatencyTrackers(handler)</span><br><span class="line">    handler = genericapifilters.WithRequestInfo(handler, c.RequestInfoResolver)</span><br><span class="line">    handler = genericapifilters.WithRequestReceivedTimestamp(handler)</span><br><span class="line">    handler = genericapifilters.WithMuxAndDiscoveryComplete(handler, c.lifecycleSignals.MuxAndDiscoveryComplete.Signaled())</span><br><span class="line">    handler = genericfilters.WithPanicRecovery(handler, c.RequestInfoResolver)</span><br><span class="line">    handler = genericapifilters.WithAuditInit(handler)</span><br><span class="line">    <span class="keyword">return</span> handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OpenAPI-与-Generic-Server"><a href="#OpenAPI-与-Generic-Server" class="headerlink" title="OpenAPI 与 Generic Server"></a>OpenAPI 与 Generic Server</h2><p>k8s 通过生成 swagger 文档，定义对外提供的 restful service，客户端可以依照该规定来向 api server 发 http 请求。</p>
<p><code>hack/update-openapi-spec.sh</code></p>
<p>生成的 swagger 在 <code>api/openapi-spec/swagger.json</code>，里面可以分为六个部分：</p>
<ul>
<li><code>definitions</code>：定义 yaml 文档的格式</li>
<li><code>info</code></li>
<li><code>paths</code>：定义支持的方法</li>
<li><code>security</code></li>
<li><code>securityDefinitions</code></li>
<li><code>swagger</code>：描述 <code>swagger</code> 文档版本</li>
</ul>
<p>生成定义的方法：</p>
<p>例如，在 <code>staging/src/k8s.io/api/apps/v1/doc.go</code> 中，定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:deepcopy-gen=package</span></span><br><span class="line"><span class="comment">// +k8s:protobuf-gen=package</span></span><br><span class="line"><span class="comment">// +k8s:openapi-gen=true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> v1 <span class="comment">// import &quot;k8s.io/api/apps/v1&quot;</span></span><br></pre></td></tr></table></figure>

<p>记录会将当前目录中定义的 <code>types</code> 生成对应格式的资源，<code>staging/src/k8s.io/api/apps/v1/types.go</code>，生成出来的文件是 <code>pkg/generated/openapi/zz_generated.openapi.go</code></p>
<p>这个文件中,可以找到当前 kubernetes 版本中所有内建的 API Object 的 openAPI definition，井且每个外部版本+API Object的组合会有一个 Defition。</p>
<p>这里的 key 和 swagger json 中的 definition id 有一对一映射关系</p>
<p><code>staging/src/k8s.io/apiserver/pkg/endpoints/openapi/openapi.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetDefinitionName returns the name and tags for a given definition</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefinitionNamer)</span></span> GetDefinitionName(name <span class="type">string</span>) (<span class="type">string</span>, spec.Extensions) &#123;</span><br><span class="line">    <span class="keyword">if</span> groupVersionKinds, ok := d.typeGroupVersionKinds[name]; ok &#123;</span><br><span class="line">        <span class="keyword">return</span> friendlyName(name), spec.Extensions&#123;</span><br><span class="line">            extensionGVK: groupVersionKinds.JSON(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> friendlyName(name), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些Generated code的作用：为每一个以字符串（就是上面那个key）标识的api object, 生成其 openapi definition, definition的主体是一个json schema,该 schema定义了这个api object的 json 表示中可以有哪些属性,属性类型信息等等。</p>
<p>在主函数 run 起来之前，首先会创建配置</p>
<p><code>cmd/kube-apiserver/app/server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateKubeAPIServerConfig</span><span class="params">(opts options.CompletedOptions)</span></span> (</span><br><span class="line">    *controlplane.Config,</span><br><span class="line">    aggregatorapiserver.ServiceResolver,</span><br><span class="line">    []admission.PluginInitializer,</span><br><span class="line">    <span class="type">error</span>,</span><br><span class="line">) &#123;</span><br><span class="line">    proxyTransport := CreateProxyTransport()</span><br><span class="line"></span><br><span class="line">    genericConfig, versionedInformers, storageFactory, err := controlplaneapiserver.BuildGenericConfig(</span><br><span class="line">        opts.CompletedOptions,</span><br><span class="line">        []*runtime.Scheme&#123;legacyscheme.Scheme, extensionsapiserver.Scheme, aggregatorscheme.Scheme&#125;,</span><br><span class="line">        generatedopenapi.GetOpenAPIDefinitions,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以猜想到上面的 <code>OpenAPIDefinitions</code> 会以配置的方式注入。</p>
<p>在预启动时，也就是主函数中的 <code>PrepareRun</code> 方法</p>
<p><code>vendor/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *APIAggregator)</span></span> PrepareRun() (preparedAPIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    prepared := s.GenericAPIServer.PrepareRun()</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PrepareRun does post API installation setup steps. It calls recursively the same function of the delegates.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span></span> PrepareRun() preparedGenericAPIServer &#123;</span><br><span class="line">    s.delegationTarget.PrepareRun()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> s.openAPIConfig != <span class="literal">nil</span> &amp;&amp; !s.skipOpenAPIInstallation &#123;</span><br><span class="line">        s.OpenAPIVersionedService, s.StaticOpenAPISpec = routes.OpenAPI&#123;</span><br><span class="line">            Config: s.openAPIConfig,</span><br><span class="line">        &#125;.InstallV2(s.Handler.GoRestfulContainer, s.Handler.NonGoRestfulMux)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/server/routes/openapi.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Install adds the SwaggerUI webservice to the given mux.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(oa OpenAPI)</span></span> InstallV2(c *restful.Container, mux *mux.PathRecorderMux) (*handler.OpenAPIService, *spec.Swagger) &#123;</span><br><span class="line">    spec, err := builder2.BuildOpenAPISpecFromRoutes(restfuladapter.AdaptWebServices(c.RegisteredWebServices()), oa.Config)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        klog.Fatalf(<span class="string">&quot;Failed to build open api spec for root: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    spec.Definitions = handler.PruneDefaults(spec.Definitions)</span><br><span class="line">    openAPIVersionedService := handler.NewOpenAPIService(spec)</span><br><span class="line">    openAPIVersionedService.RegisterOpenAPIVersionedService(<span class="string">&quot;/openapi/v2&quot;</span>, mux)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> openAPIVersionedService, spec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 openAPI Install 到当前的 API Server。</p>
<p>当用户请求 <code>/openapi/v2</code> ，spec 信息会被 <code>mux</code> 返回。</p>
<h2 id="注册APIGroup"><a href="#注册APIGroup" class="headerlink" title="注册APIGroup"></a>注册APIGroup</h2><p>也就是注册APIGroup下的所有resource。</p>
<h3 id="ExternsionsServer"><a href="#ExternsionsServer" class="headerlink" title="ExternsionsServer"></a>ExternsionsServer</h3><p>在创建 Server Chain 时，创建的 <code>ExtensionsServer</code> ：</p>
<p>创建 <code>genericapiserver</code></p>
<p><code>cmd/kube-apiserver/app/server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateServerChain</span><span class="params">(config CompletedConfig)</span></span> (*aggregatorapiserver.APIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    apiExtensionsServer, err := config.ApiExtensions.New(genericapiserver.NewEmptyDelegateWithCustomHandler(notFoundHandler))</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>genericServer 提供了一个通用的 http server，定义了通用的模板，例如地址、端口、认证、授权、健康检查等等通用功能。</p>
<p>无论是 APIServer 还是 APIExtensionsServer 都依赖于 genericServer。</p>
<p>注册 APIGroup</p>
<p><code>vendor/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*CustomResourceDefinitions, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    apiResourceConfig := c.GenericConfig.MergedResourceConfig</span><br><span class="line">    apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)</span><br><span class="line">    storage := <span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;</span><br><span class="line">    <span class="comment">// customresourcedefinitions 也就是 crd</span></span><br><span class="line">    <span class="keyword">if</span> resource := <span class="string">&quot;customresourcedefinitions&quot;</span>; apiResourceConfig.ResourceEnabled(v1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">        customResourceDefinitionStorage, err := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        storage[resource] = customResourceDefinitionStorage</span><br><span class="line">        storage[resource+<span class="string">&quot;/status&quot;</span>] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefinitionStorage)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(storage) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] = storage</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err := s.GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两个需要注意的：<code>storage</code> 和 <code>InstallAPIGroup</code></p>
<h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><p><code>rest.Storage</code> 是一个接口，可以理解为一个跟 <code>etcd</code> 交互的接口。</p>
<p><code>vendor/k8s.io/apiextensions-apiserver/pkg/registry/customresourcedefinition/etcd.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rest implements a RESTStorage for API services against etcd</span></span><br><span class="line"><span class="keyword">type</span> REST <span class="keyword">struct</span> &#123;</span><br><span class="line">    *genericregistry.Store</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewREST returns a RESTStorage object that will work against API services.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewREST</span><span class="params">(scheme *runtime.Scheme, optsGetter generic.RESTOptionsGetter)</span></span> (*REST, <span class="type">error</span>) &#123;</span><br><span class="line">    strategy := NewStrategy(scheme)</span><br><span class="line"></span><br><span class="line">    store := &amp;genericregistry.Store&#123;</span><br><span class="line">        NewFunc:                   <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object &#123; <span class="keyword">return</span> &amp;apiextensions.CustomResourceDefinition&#123;&#125; &#125;,</span><br><span class="line">        NewListFunc:               <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object &#123; <span class="keyword">return</span> &amp;apiextensions.CustomResourceDefinitionList&#123;&#125; &#125;,</span><br><span class="line">        PredicateFunc:             MatchCustomResourceDefinition,</span><br><span class="line">        DefaultQualifiedResource:  apiextensions.Resource(<span class="string">&quot;customresourcedefinitions&quot;</span>),</span><br><span class="line">        SingularQualifiedResource: apiextensions.Resource(<span class="string">&quot;customresourcedefinition&quot;</span>),</span><br><span class="line"></span><br><span class="line">        CreateStrategy:      strategy,</span><br><span class="line">        UpdateStrategy:      strategy,</span><br><span class="line">        DeleteStrategy:      strategy,</span><br><span class="line">        ResetFieldsStrategy: strategy,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> define table converter that exposes more than name/creation timestamp</span></span><br><span class="line">        TableConvertor: rest.NewDefaultTableConvertor(apiextensions.Resource(<span class="string">&quot;customresourcedefinitions&quot;</span>)),</span><br><span class="line">    &#125;</span><br><span class="line">    options := &amp;generic.StoreOptions&#123;RESTOptions: optsGetter, AttrFunc: GetAttrs&#125;</span><br><span class="line">    <span class="keyword">if</span> err := store.CompleteWithOptions(options); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;REST&#123;store&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储实现了 k8s.io/apiserver/pkg/registry/rest.StandardStorage。</span></span><br><span class="line"><span class="comment">// 它旨在可嵌入，并允许消费者实现任何所需的非通用函数。此对象旨在是可复制的，以便可以以不同方式使用但共享相同的基础行为。除非另有说明，否则所有字段都是必需的。</span></span><br><span class="line"><span class="comment">// 此类型预期用于嵌入到特定 Kind RESTStorage 实现中。该类型提供了对 Kubelike 资源的 CRUD 语义，处理冲突检测和语义等细节与 ResourceVersion 相关。</span></span><br><span class="line"><span class="comment">// RESTCreateStrategy、RESTUpdateStrategy 和 RESTDeleteStrategy 在所有后端上都是通用的，并封装了特定于 API 的逻辑。待办事项：使默认公开方法完全匹配通用 RESTStorage</span></span><br><span class="line"><span class="keyword">type</span> Store <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// NewFunc returns a new instance of the type this registry returns for a</span></span><br><span class="line">    <span class="comment">// GET of a single object, e.g.:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// curl GET /apis/group/version/namespaces/my-ns/myresource/name-of-object</span></span><br><span class="line">    NewFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NewListFunc returns a new list of the type this registry; it is the</span></span><br><span class="line">    <span class="comment">// type returned when the resource is listed, e.g.:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// curl GET /apis/group/version/namespaces/my-ns/myresource</span></span><br><span class="line">    NewListFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册了 CRD 对应的 Store 后，即可实现其对应的 CURD 方法，例如查询某个 CRD 对象对应的 api 是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// GET /apis/group/version/namespaces/my-ns/myresource/name-of-object</span><br><span class="line">GET /apis/apiextensions.k8s.io/v1beta1/namespaces/$&#123;namespace&#125;/crd/$&#123;crd-name&#125;</span><br></pre></td></tr></table></figure>

<p><code>Store</code> 可以实现的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">New() Object</span><br><span class="line">Destroy()</span><br><span class="line">NewList() Object</span><br><span class="line">NamespaceScoped() <span class="type">bool</span></span><br><span class="line">GetCreateStrategy() RESTCreateStrategy</span><br><span class="line">GetUpdateStrategy() RESTUpdateStrategy</span><br><span class="line">GetDeleteStrategy() RESTDeleteStrategy</span><br><span class="line">List(ctx context.Context, options *ListOptions) (Object, <span class="type">error</span>)</span><br><span class="line">ListPredicate(ctx context.Context, p SelectionPredicate, options *ListOptions) (Object, <span class="type">error</span>)</span><br><span class="line">Create(ctx context.Context, obj Object, createValidation ValidateObjectFunc, options *CreateOptions) (Object, <span class="type">error</span>)</span><br><span class="line">Update(ctx context.Context, name <span class="type">string</span>, objInfo UpdatedObjectInfo, createValidation ValidateObjectFunc, updateValidation ValidateObjectUpdateFunc, forceAllowCreate <span class="type">bool</span>, options *UpdateOptions) (Object, <span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">Get(ctx context.Context, name <span class="type">string</span>, options *GetOptions) (Object, <span class="type">error</span>)</span><br><span class="line">Delete(ctx context.Context, name <span class="type">string</span>, deleteValidation ValidateObjectFunc, options *DeleteOptions) (Object, <span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">DeleteReturnsDeletedObject() <span class="type">bool</span></span><br><span class="line">DeleteCollection(ctx context.Context, deleteValidation ValidateObjectFunc, options *DeleteOptions, listOptions *ListOptions) (Object, <span class="type">error</span>)</span><br><span class="line">Watch(ctx context.Context, options *ListOptions) (Interface, <span class="type">error</span>)</span><br><span class="line">WatchPredicate(ctx context.Context, p SelectionPredicate, resourceVersion <span class="type">string</span>, sendInitialEvents *<span class="type">bool</span>) (Interface, <span class="type">error</span>)</span><br><span class="line">CompleteWithOptions(options *StoreOptions) <span class="type">error</span></span><br><span class="line">ConvertToTable(ctx context.Context, object Object, tableOptions Object) (*Table, <span class="type">error</span>)</span><br><span class="line">StorageVersion() GroupVersioner</span><br><span class="line">GetResetFields() <span class="keyword">map</span>[APIVersion]*Set</span><br><span class="line">GetSingularName() <span class="type">string</span></span><br></pre></td></tr></table></figure>

<h3 id="InstallAPIGroup"><a href="#InstallAPIGroup" class="headerlink" title="InstallAPIGroup"></a>InstallAPIGroup</h3><p><code>vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InstallAPIGroup exposes the given api group in the API.</span></span><br><span class="line"><span class="comment">// The &lt;apiGroupInfo&gt; passed into this function shouldn&#x27;t be used elsewhere as the</span></span><br><span class="line"><span class="comment">// underlying storage will be destroyed on this servers shutdown.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span></span> InstallAPIGroup(apiGroupInfo *APIGroupInfo) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s.InstallAPIGroups(apiGroupInfo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span></span> InstallAPIGroups(apiGroupInfos ...*APIGroupInfo) <span class="type">error</span> &#123;</span><br><span class="line">...</span><br><span class="line">     <span class="comment">// 注册APIGroup下的所有resource并注册    </span></span><br><span class="line">    <span class="keyword">for</span> _, apiGroupInfo := <span class="keyword">range</span> apiGroupInfos &#123;</span><br><span class="line">        <span class="keyword">if</span> err := s.installAPIResources(APIGroupPrefix, apiGroupInfo, openAPIModels); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to install api resources: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// setup discovery</span></span><br><span class="line">        <span class="comment">// Install the version handler.</span></span><br><span class="line">        <span class="comment">// Add a handler at /apis/&lt;groupName&gt; to enumerate all versions supported by this group.</span></span><br><span class="line">        apiVersionsForDiscovery := []metav1.GroupVersionForDiscovery&#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.PrioritizedVersions &#123;</span><br><span class="line">            <span class="comment">// Check the config to make sure that we elide versions that don&#x27;t have any resources</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(apiGroupInfo.VersionedResourcesStorageMap[groupVersion.Version]) == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            apiVersionsForDiscovery = <span class="built_in">append</span>(apiVersionsForDiscovery, metav1.GroupVersionForDiscovery&#123;</span><br><span class="line">                GroupVersion: groupVersion.String(),</span><br><span class="line">                Version:      groupVersion.Version,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        preferredVersionForDiscovery := metav1.GroupVersionForDiscovery&#123;</span><br><span class="line">            GroupVersion: apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].String(),</span><br><span class="line">            Version:      apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].Version,</span><br><span class="line">        &#125;</span><br><span class="line">        apiGroup := metav1.APIGroup&#123;</span><br><span class="line">            Name:             apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].Group,</span><br><span class="line">            Versions:         apiVersionsForDiscovery,</span><br><span class="line">            PreferredVersion: preferredVersionForDiscovery,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s.DiscoveryGroupManager.AddGroup(apiGroup)</span><br><span class="line">        s.Handler.GoRestfulContainer.Add(discovery.NewAPIGroupHandler(s.Serializer, apiGroup).WebService())</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span></span> installAPIResources(apiPrefix <span class="type">string</span>, apiGroupInfo *APIGroupInfo, typeConverter managedfields.TypeConverter) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resourceInfos []*storageversion.ResourceInfo</span><br><span class="line">    <span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.PrioritizedVersions &#123;</span><br><span class="line">        ...</span><br><span class="line">                discoveryAPIResources, r, err := apiGroupVersion.InstallREST(s.Handler.GoRestfulContainer)</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/apiserver/pkg/endpoints/groupversion.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InstallREST registers the REST handlers (storage, watch, proxy and redirect) into a restful Container.</span></span><br><span class="line"><span class="comment">// It is expected that the provided path root prefix will serve all operations. Root MUST NOT end</span></span><br><span class="line"><span class="comment">// in a slash.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *APIGroupVersion)</span></span> InstallREST(container *restful.Container) ([]apidiscoveryv2beta1.APIResourceDiscovery, []*storageversion.ResourceInfo, <span class="type">error</span>) &#123;</span><br><span class="line">    prefix := path.Join(g.Root, g.GroupVersion.Group, g.GroupVersion.Version)</span><br><span class="line">    installer := &amp;APIInstaller&#123;</span><br><span class="line">        group:             g,</span><br><span class="line">        prefix:            prefix,</span><br><span class="line">        minRequestTimeout: g.MinRequestTimeout,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    apiResources, resourceInfos, ws, registrationErrors := installer.Install()</span><br><span class="line">    versionDiscoveryHandler := discovery.NewAPIVersionHandler(g.Serializer, g.GroupVersion, staticLister&#123;apiResources&#125;)</span><br><span class="line">    versionDiscoveryHandler.AddToWebService(ws)</span><br><span class="line">    container.Add(ws)</span><br><span class="line">    aggregatedDiscoveryResources, err := ConvertGroupVersionIntoToDiscovery(apiResources)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        registrationErrors = <span class="built_in">append</span>(registrationErrors, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> aggregatedDiscoveryResources, removeNonPersistedResources(resourceInfos), utilerrors.NewAggregate(registrationErrors)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>vendor/k8s.io/apiserver/pkg/endpoints/installer.go</code> 中定义的 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> APIInstaller <span class="keyword">struct</span> &#123;</span><br><span class="line">    group             *APIGroupVersion</span><br><span class="line">    prefix            <span class="type">string</span> <span class="comment">// Path prefix where API resources are to be registered.</span></span><br><span class="line">    minRequestTimeout time.Duration</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>prefix</code> 代表的就是路径。</p>
<p><code>vendor/k8s.io/apiserver/pkg/endpoints/installer.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *APIInstaller)</span></span> Install() ([]metav1.APIResource, []*storageversion.ResourceInfo, *restful.WebService, []<span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">for</span> _, path := <span class="keyword">range</span> paths &#123;</span><br><span class="line">        apiResource, resourceInfo, err := a.registerResourceHandlers(path, a.group.Storage[path], ws)</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *APIInstaller)</span></span> registerResourceHandlers(path <span class="type">string</span>, storage rest.Storage, ws *restful.WebService) (*metav1.APIResource, *storageversion.ResourceInfo, <span class="type">error</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// what verbs are supported by the storage, used to know what verbs we support per path</span></span><br><span class="line">    creater, isCreater := storage.(rest.Creater)</span><br><span class="line">    namedCreater, isNamedCreater := storage.(rest.NamedCreater)</span><br><span class="line">    lister, isLister := storage.(rest.Lister)</span><br><span class="line">    getter, isGetter := storage.(rest.Getter)</span><br><span class="line">    getterWithOptions, isGetterWithOptions := storage.(rest.GetterWithOptions)</span><br><span class="line">    gracefulDeleter, isGracefulDeleter := storage.(rest.GracefulDeleter)</span><br><span class="line">    collectionDeleter, isCollectionDeleter := storage.(rest.CollectionDeleter)</span><br><span class="line">    updater, isUpdater := storage.(rest.Updater)</span><br><span class="line">    patcher, isPatcher := storage.(rest.Patcher)</span><br><span class="line">    watcher, isWatcher := storage.(rest.Watcher)</span><br><span class="line">    connecter, isConnecter := storage.(rest.Connecter)</span><br><span class="line">    storageMeta, isMetadata := storage.(rest.StorageMetadata)</span><br><span class="line">    storageVersionProvider, isStorageVersionProvider := storage.(rest.StorageVersionProvider)</span><br><span class="line">    gvAcceptor, _ := storage.(rest.GroupVersionAcceptor)</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2、为 resource 添加对应的 actions 并根据是否支持 namespace </span></span><br><span class="line">        <span class="comment">// Handler for standard REST verbs (GET, PUT, POST and DELETE).</span></span><br><span class="line">        <span class="comment">// Add actions at the resource path: /api/apiVersion/resource</span></span><br><span class="line">        actions = appendIf(actions, action&#123;<span class="string">&quot;LIST&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isLister)</span><br><span class="line">        actions = appendIf(actions, action&#123;<span class="string">&quot;POST&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isCreater)</span><br><span class="line">        actions = appendIf(actions, action&#123;<span class="string">&quot;DELETECOLLECTION&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isCollectionDeleter)</span><br><span class="line">        <span class="comment">// DEPRECATED in 1.11</span></span><br><span class="line">        actions = appendIf(actions, action&#123;<span class="string">&quot;WATCHLIST&quot;</span>, <span class="string">&quot;watch/&quot;</span> + resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, allowWatchList)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add actions at the item path: /api/apiVersion/resource/&#123;name&#125;</span></span><br><span class="line">        actions = appendIf(actions, action&#123;<span class="string">&quot;GET&quot;</span>, itemPath, nameParams, namer, <span class="literal">false</span>&#125;, isGetter)</span><br><span class="line">        <span class="keyword">if</span> getSubpath &#123;</span><br><span class="line">            actions = appendIf(actions, action&#123;<span class="string">&quot;GET&quot;</span>, itemPath + <span class="string">&quot;/&#123;path:*&#125;&quot;</span>, proxyParams, namer, <span class="literal">false</span>&#125;, isGetter)</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">        <span class="comment">// 根据 action 创建对应的 route</span></span><br><span class="line">    kubeVerbs := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    reqScope := handlers.RequestScope&#123;</span><br><span class="line">        Serializer:      a.group.Serializer,</span><br><span class="line">        ParameterCodec:  a.group.ParameterCodec,</span><br><span class="line">        Creater:         a.group.Creater,</span><br><span class="line">        Convertor:       a.group.Convertor,</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 从 rest.Storage 到 restful.Route 映射</span></span><br><span class="line">    <span class="comment">// 为每个操作添加对应的 handler</span></span><br><span class="line">    <span class="keyword">for</span> _, action := <span class="keyword">range</span> actions &#123;</span><br><span class="line">        producedObject := storageMeta.ProducesObject(action.Verb)</span><br><span class="line">        <span class="keyword">if</span> producedObject == <span class="literal">nil</span> &#123;</span><br><span class="line">            producedObject = defaultVersionedObject</span><br><span class="line">        &#125;</span><br><span class="line">        reqScope.Namer = action.Namer</span><br><span class="line"></span><br><span class="line">        requestScope := <span class="string">&quot;cluster&quot;</span></span><br><span class="line">        <span class="keyword">var</span> namespaced <span class="type">string</span></span><br><span class="line">        <span class="keyword">var</span> operationSuffix <span class="type">string</span></span><br><span class="line">        <span class="keyword">if</span> apiResource.Namespaced &#123;</span><br><span class="line">            requestScope = <span class="string">&quot;namespace&quot;</span></span><br><span class="line">            namespaced = <span class="string">&quot;Namespaced&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> strings.HasSuffix(action.Path, <span class="string">&quot;/&#123;path:*&#125;&quot;</span>) &#123;</span><br><span class="line">            requestScope = <span class="string">&quot;resource&quot;</span></span><br><span class="line">            operationSuffix = operationSuffix + <span class="string">&quot;WithPath&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> strings.Contains(action.Path, <span class="string">&quot;/&#123;name&#125;&quot;</span>) || action.Verb == <span class="string">&quot;POST&quot;</span> &#123;</span><br><span class="line">            requestScope = <span class="string">&quot;resource&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> action.AllNamespaces &#123;</span><br><span class="line">            requestScope = <span class="string">&quot;cluster&quot;</span></span><br><span class="line">            operationSuffix = operationSuffix + <span class="string">&quot;ForAllNamespaces&quot;</span></span><br><span class="line">            namespaced = <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 为每一种操作，绑定 route 到 handler</span></span><br><span class="line">                <span class="keyword">switch</span> action.Verb &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;GET&quot;</span>: <span class="comment">// Get a resource.</span></span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;LIST&quot;</span>: <span class="comment">// List all resources of a kind.</span></span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;PUT&quot;</span>: <span class="comment">// Update a resource.</span></span><br><span class="line">                    ...</span><br><span class="line">                <span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</span><br><span class="line">            route.Metadata(ROUTE_META_GVK, metav1.GroupVersionKind&#123;</span><br><span class="line">                Group:   reqScope.Kind.Group,</span><br><span class="line">                Version: reqScope.Kind.Version,</span><br><span class="line">                Kind:    reqScope.Kind.Kind,</span><br><span class="line">            &#125;)</span><br><span class="line">            route.Metadata(ROUTE_META_ACTION, strings.ToLower(action.Verb))</span><br><span class="line">                    <span class="comment">// 最终使用 go-restful 生成 WebService</span></span><br><span class="line">            ws.Route(route)</span><br><span class="line">        &#125;</span><br><span class="line">                    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>registerResourceHandlers</code> 实现了 <code>rest.Storage</code> 到 <code>restful.Route</code> 的转换，其首先会判断 API Resource 所支持的 REST 接口，然后为 REST 接口添加对应的 handler，最后将其注册到路由中。</p>
<p>例如 POST</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;POST&quot;</span>: <span class="comment">// Create a resource.</span></span><br><span class="line">            <span class="keyword">var</span> handler restful.RouteFunction</span><br><span class="line">            <span class="keyword">if</span> isNamedCreater &#123;</span><br><span class="line">                handler = restfulCreateNamedResource(namedCreater, reqScope, admit)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                handler = restfulCreateResource(creater, reqScope, admit)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 可观测行</span></span><br><span class="line">            handler = metrics.InstrumentRouteFunc(action.Verb, group, version, resource, subresource, requestScope, metrics.APIServerComponent, deprecated, removedRelease, handler)</span><br><span class="line">            <span class="comment">// 链式调用，AOP 思想</span></span><br><span class="line">            handler = utilwarning.AddWarningsHandler(handler, warnings)</span><br><span class="line">            article := GetArticleForNoun(kind, <span class="string">&quot; &quot;</span>)</span><br><span class="line">            doc := <span class="string">&quot;create&quot;</span> + article + kind</span><br><span class="line">            <span class="keyword">if</span> isSubresource &#123;</span><br><span class="line">                doc = <span class="string">&quot;create &quot;</span> + subresource + <span class="string">&quot; of&quot;</span> + article + kind</span><br><span class="line">            &#125;</span><br><span class="line">            route := ws.POST(action.Path).To(handler).</span><br><span class="line">                Doc(doc).</span><br><span class="line">                Param(ws.QueryParameter(<span class="string">&quot;pretty&quot;</span>, <span class="string">&quot;If &#x27;true&#x27;, then the output is pretty printed. Defaults to &#x27;false&#x27; unless the user-agent indicates a browser or command-line HTTP tool (curl and wget).&quot;</span>)).</span><br><span class="line">                Operation(<span class="string">&quot;create&quot;</span>+namespaced+kind+strings.Title(subresource)+operationSuffix).</span><br><span class="line">                Produces(<span class="built_in">append</span>(storageMeta.ProducesMIMETypes(action.Verb), mediaTypes...)...).</span><br><span class="line">                Returns(http.StatusOK, <span class="string">&quot;OK&quot;</span>, producedObject).</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> in some cases, the API may return a v1.Status instead of the versioned object</span></span><br><span class="line">                <span class="comment">// but currently go-restful can&#x27;t handle multiple different objects being returned.</span></span><br><span class="line">                Returns(http.StatusCreated, <span class="string">&quot;Created&quot;</span>, producedObject).</span><br><span class="line">                Returns(http.StatusAccepted, <span class="string">&quot;Accepted&quot;</span>, producedObject).</span><br><span class="line">                Reads(defaultVersionedObject).</span><br><span class="line">                Writes(producedObject)</span><br><span class="line">            <span class="keyword">if</span> err := AddObjectParams(ws, route, versionedCreateOptions); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            addParams(route, action.Params)</span><br><span class="line">            routes = <span class="built_in">append</span>(routes, route)</span><br></pre></td></tr></table></figure>

<h3 id="Master-APIServer"><a href="#Master-APIServer" class="headerlink" title="Master APIServer"></a>Master APIServer</h3><p>创建 master apiserver 也是一样的逻辑</p>
<p>创建 kubeAPIServer</p>
<p><code>cmd/kube-apiserver/app/server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateServerChain</span><span class="params">(config CompletedConfig)</span></span> (*aggregatorapiserver.APIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    kubeAPIServer, err := config.ControlPlane.New(apiExtensionsServer.GenericAPIServer)</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建的时，Install 所有的 API</p>
<p><code>pkg/controlplane/instance.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*Instance, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> err := m.InstallAPIs(c.ExtraConfig.APIResourceConfigSource, c.GenericConfig.RESTOptionsGetter, restStorageProviders...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="comment">// InstallAPIs will install the APIs for the restStorageProviders if they are enabled.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Instance)</span></span> InstallAPIs(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter, restStorageProviders ...RESTStorageProvider) <span class="type">error</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> _, restStorageBuilder := <span class="keyword">range</span> restStorageProviders &#123;</span><br><span class="line">        groupName := restStorageBuilder.GroupName()</span><br><span class="line">        apiGroupInfo, err := restStorageBuilder.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;problem initializing API group %q : %v&quot;</span>, groupName, err)</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(groupName) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// the legacy group for core APIs is special that it is installed into /api via this special install method.</span></span><br><span class="line">            <span class="comment">// DefaultLegacyAPIPrefix 也就是 /api 前缀</span></span><br><span class="line">            <span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering legacy API: %w&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 将其他的注入到 /apis 前缀里面</span></span><br><span class="line">            <span class="comment">// everything else goes to /apis</span></span><br><span class="line">            nonLegacy = <span class="built_in">append</span>(nonLegacy, &amp;apiGroupInfo)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册 /apis</span></span><br><span class="line">    <span class="keyword">if</span> err := m.GenericAPIServer.InstallAPIGroups(nonLegacy...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering group versions: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来又回到了 <code>vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</code> ，跟 APIExtensionsServer 一致。</p>
<p>APIServer 启动分为以下几步：</p>
<p>1、创建 GenericServer</p>
<p>2、实例化 master APIServer(Kube APIServer)</p>
<p>3、注册 &#x2F;api 下的资源(LegacyAPI)</p>
<p>4、注册 &#x2F;apis下的资源（nonLegacy）</p>
<p>与启动 APIExtensionsServer 的流程差不多。</p>
<p>至此，CreateServerChain 中流程已经分析完，其中的调用链如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                    |--&gt; CreateNodeDialer</span><br><span class="line">                    |</span><br><span class="line">                    |--&gt; CreateKubeAPIServerConfig</span><br><span class="line">                    |</span><br><span class="line">CreateServerChain --|--&gt; createAPIExtensionsConfig</span><br><span class="line">                    |</span><br><span class="line">                    |                                                                       |--&gt; c.GenericConfig.New</span><br><span class="line">                    |--&gt; createAPIExtensionsServer --&gt; apiextensionsConfig.Complete().New --|</span><br><span class="line">                    |                                                                       |--&gt; s.GenericAPIServer.InstallAPIGroup</span><br><span class="line">                    |</span><br><span class="line">                    |                                                                 |--&gt; c.GenericConfig.New --&gt; legacyRESTStorageProvider.NewLegacyRESTStorage</span><br><span class="line">                    |                                                                 |</span><br><span class="line">                    |--&gt; CreateKubeAPIServer --&gt; kubeAPIServerConfig.Complete().New --|--&gt; m.InstallLegacyAPI</span><br><span class="line">                    |                                                                 |</span><br><span class="line">                    |                                                                 |--&gt; m.InstallAPIs</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">                    |--&gt; createAggregatorConfig</span><br><span class="line">                    |</span><br><span class="line">                    |                                                                             |--&gt; c.GenericConfig.New</span><br><span class="line">                    |                                                                             |</span><br><span class="line">                    |--&gt; createAggregatorServer --&gt; aggregatorConfig.Complete().NewWithDelegate --|--&gt; apiservicerest.NewRESTStorage</span><br><span class="line">                                                                                                  |</span><br><span class="line">                                                                                                  |--&gt; s.GenericAPIServer.InstallAPIGroup</span><br></pre></td></tr></table></figure>

<h1 id="启动-Web-服务"><a href="#启动-Web-服务" class="headerlink" title="启动 Web 服务"></a>启动 Web 服务</h1><p>所有的配置、resource、chain handler 注册好了之后，启动 Web 服务</p>
<p>在 <code>cmd/kube-apiserver/app/server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(opts options.CompletedOptions, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">...</span><br><span class="line">    prepared, err := server.PrepareRun()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> prepared.Run(stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vendor/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedAPIAggregator)</span></span> Run(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s.runnable.Run(stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实是 <code>prepared</code> 的 Run 方法：</p>
<p><code>vendor/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *APIAggregator)</span></span> PrepareRun() (preparedAPIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    prepared := s.GenericAPIServer.PrepareRun()</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> preparedAPIAggregator&#123;APIAggregator: s, runnable: prepared&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedAPIAggregator)</span></span> Run(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s.runnable.Run(stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编制出 server 生命周期中的状态流转（利用 channel 机制）；关闭开始前调用 PreShutdownHooks</p>
<p><code>vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run spawns the secure http server. It only returns if stopCh is closed</span></span><br><span class="line"><span class="comment">// or the secure port cannot be listened on initially.</span></span><br><span class="line"><span class="comment">// This is the diagram of what channels/signals are dependent on each other:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// |                                  stopCh</span></span><br><span class="line"><span class="comment">// |                                    |</span></span><br><span class="line"><span class="comment">// |           ---------------------------------------------------------</span></span><br><span class="line"><span class="comment">// |           |                                                       |</span></span><br><span class="line"><span class="comment">// |    ShutdownInitiated (shutdownInitiatedCh)                        |</span></span><br><span class="line"><span class="comment">// |           |                                                       |</span></span><br><span class="line"><span class="comment">// | (ShutdownDelayDuration)                                    (PreShutdownHooks)</span></span><br><span class="line"><span class="comment">// |           |                                                       |</span></span><br><span class="line"><span class="comment">// |  AfterShutdownDelayDuration (delayedStopCh)   PreShutdownHooksStopped (preShutdownHooksHasStoppedCh)</span></span><br><span class="line"><span class="comment">// |           |                                                       |</span></span><br><span class="line"><span class="comment">// |           |-------------------------------------------------------|</span></span><br><span class="line"><span class="comment">// |                                    |</span></span><br><span class="line"><span class="comment">// |                                    |</span></span><br><span class="line"><span class="comment">// |               NotAcceptingNewRequest (notAcceptingNewRequestCh)</span></span><br><span class="line"><span class="comment">// |                                    |</span></span><br><span class="line"><span class="comment">// |                                    |</span></span><br><span class="line"><span class="comment">// |           |----------------------------------------------------------------------------------|</span></span><br><span class="line"><span class="comment">// |           |                        |              |                                          |</span></span><br><span class="line"><span class="comment">// |        [without                 [with             |                                          |</span></span><br><span class="line"><span class="comment">// | ShutdownSendRetryAfter]  ShutdownSendRetryAfter]  |                                          |</span></span><br><span class="line"><span class="comment">// |           |                        |              |                                          |</span></span><br><span class="line"><span class="comment">// |           |                        ---------------|                                          |</span></span><br><span class="line"><span class="comment">// |           |                                       |                                          |</span></span><br><span class="line"><span class="comment">// |           |                      |----------------|-----------------------|                  |</span></span><br><span class="line"><span class="comment">// |           |                      |                                        |                  |</span></span><br><span class="line"><span class="comment">// |           |         (NonLongRunningRequestWaitGroup::Wait)   (WatchRequestWaitGroup::Wait)   |</span></span><br><span class="line"><span class="comment">// |           |                      |                                        |                  |</span></span><br><span class="line"><span class="comment">// |           |                      |------------------|---------------------|                  |</span></span><br><span class="line"><span class="comment">// |           |                                         |                                        |</span></span><br><span class="line"><span class="comment">// |           |                         InFlightRequestsDrained (drainedCh)                      |</span></span><br><span class="line"><span class="comment">// |           |                                         |                                        |</span></span><br><span class="line"><span class="comment">// |           |-------------------|---------------------|----------------------------------------|</span></span><br><span class="line"><span class="comment">// |                               |                     |</span></span><br><span class="line"><span class="comment">// |                       stopHttpServerCh     (AuditBackend::Shutdown())</span></span><br><span class="line"><span class="comment">// |                               |</span></span><br><span class="line"><span class="comment">// |                       listenerStoppedCh</span></span><br><span class="line"><span class="comment">// |                               |</span></span><br><span class="line"><span class="comment">// |      HTTPServerStoppedListening (httpServerStoppedListeningCh)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span></span> Run(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">...</span><br><span class="line">        <span class="comment">// Start the audit backend before any request comes in. This means we must call Backend.Run</span></span><br><span class="line">    <span class="comment">// before http server start serving. Otherwise the Backend.ProcessEvents call might block.</span></span><br><span class="line">    <span class="comment">// AuditBackend.Run will stop as soon as all in-flight requests are drained.</span></span><br><span class="line">    <span class="comment">// 审计相关</span></span><br><span class="line">    <span class="keyword">if</span> s.AuditBackend != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := s.AuditBackend.Run(drainedCh.Signaled()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to run the audit backend: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 非阻塞启动服务</span></span><br><span class="line">    stoppedCh, listenerStoppedCh, err := s.NonBlockingRun(stopHttpServerCh, shutdownTimeout)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span></span> NonBlockingRun(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, shutdownTimeout time.Duration) (&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">if</span> s.SecureServingInfo != <span class="literal">nil</span> &amp;&amp; s.Handler != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">        stoppedCh, listenerStoppedCh, err = s.SecureServingInfo.Serve(s.Handler, shutdownTimeout, internalStopCh)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">close</span>(internalStopCh)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HTTP 2.0 设置 TLS 设置，启动 Server</p>
<p><code>vendor/k8s.io/apiserver/pkg/server/secure_serving.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SecureServingInfo)</span></span> Serve(handler http.Handler, shutdownTimeout time.Duration, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) (&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">...</span><br><span class="line">    secureServer := &amp;http.Server&#123;</span><br><span class="line">        Addr:           s.Listener.Addr().String(),</span><br><span class="line">        Handler:        handler,</span><br><span class="line">        MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</span><br><span class="line">        TLSConfig:      tlsConfig,</span><br><span class="line"></span><br><span class="line">        IdleTimeout:       <span class="number">90</span> * time.Second, <span class="comment">// matches http.DefaultTransport keep-alive timeout</span></span><br><span class="line">        ReadHeaderTimeout: <span class="number">32</span> * time.Second, <span class="comment">// just shy of requestTimeoutUpperBound</span></span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> RunServer(secureServer, s.Listener, shutdownTimeout, stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终是通过 HTTP Server 启动服务。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cua3ViZXJuZXRlcy5vcmcuY24vNjgzOS5odG1s">图解kubernetes中的api多版本中反序列化与转换<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lpbndlbnFpbi9rdWJlU291cmNlQ29kZU5vdGUvYmxvYi9tYXN0ZXIvYXBpU2VydmVyL0t1YmVybmV0ZXMlRTYlQkElOTAlRTclQTAlODElRTUlQUQlQTYlRTQlQjklQTAtQVBJU2VydmVyLVAxLSVFNSU5RiVCQSVFNyVBMSU4MCVFNyVCQiU5MyVFNiU5RSU4NCVFNCVCRiVBMSVFNiU4MSVBRi5tZA==">Kubernetes源码学习-APIServer-P1-基础结构信息<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnRpYW5mZWl5dS5jb20vc291cmNlLWNvZGUtcmVhZGluZy1ub3Rlcy9rdWJlcm5ldGVzL2t1YmVfYXBpc2VydmVyLmh0bWw=">kube-apiserver 的设计与实现<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/2040d45d.html" rel="prev" title="Canal">
                  <i class="fa fa-angle-left"></i> Canal
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/116450ad.html" rel="next" title="LeetCode Hot100笔记-上">
                  LeetCode Hot100笔记-上 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.20.0/algoliasearch-lite.umd.js" integrity="sha256-DABVk+hYj0mdUzo+7ViJC6cwLahQIejFvC+my2M/wfM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.60.0/instantsearch.production.min.js" integrity="sha256-9242vN47QUX50UG5Gf5XDO1YREWCEJRyXHofh5fsl24=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/7d689b97.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
