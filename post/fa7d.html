<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是学习MySQL的笔记事务和锁篇，主要包含数据库的事务、锁和MVCC机制。">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL学习笔记事务和锁篇">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/fa7d.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="这是学习MySQL的笔记事务和锁篇，主要包含数据库的事务、锁和MVCC机制。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122205527852.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215224984.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215425596.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215607038.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215842827.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122225953987.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122225935399.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123145613755.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123151948870.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123154701699.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123155107531.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204441117.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204009071.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204221137.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123203800462.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123203948900.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205341477.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205503134.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205825888.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205921819.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123210521940.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123210721287.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20221123210845713.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123215755143.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123215850385.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220108591.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220420343.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220458824.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220621018.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20221123210859630.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123222646322.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123222905492.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123223103358.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124093251289.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124115442357.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124155836072.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124155941944.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124163809373.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124164354310.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124164630676.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124170709408.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124204516590.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124212206988.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124221958830.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124222511565.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124222545821.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124223838600.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124224534753.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102136430.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102316103.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102729824.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125103220778.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125110751171.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125112340543.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125112730129.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125114343122.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125115601339.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125114343122.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125115601339.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125121001971.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125121611519.png">
<meta property="article:published_time" content="2022-11-23T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-08T01:48:25.612Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122205527852.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/fa7d.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/fa7d.html","path":"post/fa7d.html","title":"MySQL学习笔记事务和锁篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL学习笔记事务和锁篇 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">事务概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.</span> <span class="nav-text">事务的ACID特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">1.2.</span> <span class="nav-text">事务的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.3.</span> <span class="nav-text">使用事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%90%E5%BC%8F%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.4.</span> <span class="nav-text">隐式提交数据的情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">事务操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1-1"><span class="nav-number">2.1.</span> <span class="nav-text">使用事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB%E5%92%8CMyISAM%E5%9C%A8%E4%BA%8B%E5%8A%A1%E4%B8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.2.</span> <span class="nav-text">InnoDB和MyISAM在事务下的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E7%82%B9-SAVEPOINT"><span class="nav-number">2.3.</span> <span class="nav-text">保存点 SAVEPOINT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">3.</span> <span class="nav-text">事务的隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="nav-number">3.1.</span> <span class="nav-text">数据并发问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E4%B8%AD%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">3.2.</span> <span class="nav-text">SQL中的四种隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E6%94%AF%E6%8C%81%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">3.3.</span> <span class="nav-text">MySQL支持的四种隔离级别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E4%B9%8Bredo%E6%97%A5%E5%BF%97"><span class="nav-number">4.</span> <span class="nav-text">MySQL事务日志之redo日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redo%E6%97%A5%E5%BF%97"><span class="nav-number">4.1.</span> <span class="nav-text">redo日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log%E7%9A%84%E5%A5%BD%E5%A4%84%E3%80%81%E7%89%B9%E7%82%B9"><span class="nav-number">4.2.</span> <span class="nav-text">redo log的好处、特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-number">4.3.</span> <span class="nav-text">redo的组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-number">4.4.</span> <span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log-%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="nav-number">4.5.</span> <span class="nav-text">redo log 刷盘策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5redo-log-buffer%E8%BF%87%E7%A8%8B"><span class="nav-number">4.6.</span> <span class="nav-text">写入redo log buffer过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log-file"><span class="nav-number">4.7.</span> <span class="nav-text">redo log file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%BB%84"><span class="nav-number">4.8.</span> <span class="nav-text">日志文件组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E4%B9%8Bundo%E6%97%A5%E5%BF%97"><span class="nav-number">5.</span> <span class="nav-text">MySQL事务日志之undo日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undo%E6%97%A5%E5%BF%97"><span class="nav-number">5.1.</span> <span class="nav-text">undo日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">undo log 的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-number">5.3.</span> <span class="nav-text">undo 的存储结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E6%BB%9A%E6%AE%B5%E4%B8%8E%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.4.</span> <span class="nav-text">回滚段与事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E6%BB%9A%E6%AE%B5%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%B1%BB"><span class="nav-number">5.5.</span> <span class="nav-text">回滚段中的数据分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.6.</span> <span class="nav-text">undo的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">5.7.</span> <span class="nav-text">undo log的生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="nav-number">5.8.</span> <span class="nav-text">详细生成过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log-%E5%9B%9E%E6%BB%9A"><span class="nav-number">5.9.</span> <span class="nav-text">undo log 回滚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log%E5%88%A0%E9%99%A4"><span class="nav-number">5.10.</span> <span class="nav-text">undo log删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%B0%8F%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">日志小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81"><span class="nav-number">7.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%90%8C%E8%AE%B0%E5%BD%95"><span class="nav-number">7.1.</span> <span class="nav-text">并发事务访问相同记录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB-%E8%AF%BB%E6%83%85%E5%86%B5"><span class="nav-number">7.1.1.</span> <span class="nav-text">读-读情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99-%E5%86%99%E6%83%85%E5%86%B5"><span class="nav-number">7.1.2.</span> <span class="nav-text">写-写情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB-%E5%86%99%E6%88%96%E5%86%99-%E8%AF%BB%E6%83%85%E5%86%B5"><span class="nav-number">7.1.3.</span> <span class="nav-text">读-写或写-读情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">7.1.4.</span> <span class="nav-text">并发问题解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%88%92%E5%88%86"><span class="nav-number">7.2.</span> <span class="nav-text">从数据操作的类型划分</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%81%E5%AE%9A%E8%AF%BB"><span class="nav-number">7.2.1.</span> <span class="nav-text">锁定读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E6%93%8D%E4%BD%9C"><span class="nav-number">7.2.2.</span> <span class="nav-text">写操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E7%9A%84%E7%B2%92%E5%BA%A6%E5%88%92%E5%88%86%EF%BC%9A%E8%A1%A8%E7%BA%A7%E9%94%81%E3%80%81%E9%A1%B5%E7%BA%A7%E9%94%81%E3%80%81%E8%A1%8C%E9%94%81"><span class="nav-number">7.3.</span> <span class="nav-text">从数据操作的粒度划分：表级锁、页级锁、行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E9%94%81"><span class="nav-number">7.3.1.</span> <span class="nav-text">表锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E7%BA%A7%E5%88%AB%E7%9A%84S%E9%94%81%E3%80%81X%E9%94%81"><span class="nav-number">7.3.1.1.</span> <span class="nav-text">表级别的S锁、X锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%84%8F%E5%90%91%E9%94%81%EF%BC%88intention-lock%EF%BC%89"><span class="nav-number">7.3.1.2.</span> <span class="nav-text">意向锁（intention lock）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%A2%9E%E9%94%81%EF%BC%88AUTO-INC%E9%94%81%EF%BC%89"><span class="nav-number">7.3.1.3.</span> <span class="nav-text">自增锁（AUTO-INC锁）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="nav-number">7.3.1.4.</span> <span class="nav-text">元数据锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E9%94%81"><span class="nav-number">7.3.2.</span> <span class="nav-text">行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E9%94%81%EF%BC%88Record-Locks%EF%BC%89"><span class="nav-number">7.3.2.1.</span> <span class="nav-text">记录锁（Record Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88Gap-Locks%EF%BC%89"><span class="nav-number">7.3.2.2.</span> <span class="nav-text">间隙锁（Gap Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%B4%E5%BB%BA%E9%94%81%EF%BC%88Next-Key-Locks%EF%BC%89"><span class="nav-number">7.3.2.3.</span> <span class="nav-text">临建锁（Next-Key Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%84%8F%E5%90%91%E9%94%81%EF%BC%88Insert-Intention-Locks%EF%BC%89"><span class="nav-number">7.3.2.4.</span> <span class="nav-text">插入意向锁（Insert Intention Locks）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B5%E9%94%81"><span class="nav-number">7.3.3.</span> <span class="nav-text">页锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%AF%B9%E5%BE%85%E9%94%81%E7%9A%84%E6%80%81%E5%BA%A6%E5%88%92%E5%88%86%EF%BC%9A%E4%B9%90%E8%A7%82%E9%94%81%E3%80%81%E6%82%B2%E8%A7%82%E9%94%81"><span class="nav-number">7.4.</span> <span class="nav-text">从对待锁的态度划分：乐观锁、悲观锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%82%B2%E8%A7%82%E9%94%81%EF%BC%88Pessimistic-Locking%EF%BC%89"><span class="nav-number">7.4.1.</span> <span class="nav-text">悲观锁（Pessimistic Locking）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%EF%BC%88Optimistic-Locking%EF%BC%89"><span class="nav-number">7.4.2.</span> <span class="nav-text">乐观锁（Optimistic Locking）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7%E6%9C%BA%E5%88%B6"><span class="nav-number">7.4.2.1.</span> <span class="nav-text">乐观锁的版本号机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%B3%E6%9C%BA%E5%88%B6"><span class="nav-number">7.4.2.2.</span> <span class="nav-text">乐观锁的时间戳机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E9%94%81%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">7.4.2.3.</span> <span class="nav-text">两种锁的适用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%89%E7%85%A7%E5%8A%A0%E9%94%81%E7%9A%84%E6%96%B9%E5%BC%8F%E5%88%92%E5%88%86%EF%BC%9A%E6%98%BE%E5%BC%8F%E9%94%81%E3%80%81%E9%9A%90%E5%BC%8F%E9%94%81"><span class="nav-number">7.5.</span> <span class="nav-text">按照加锁的方式划分：显式锁、隐式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%90%E5%BC%8F%E9%94%81"><span class="nav-number">7.5.1.</span> <span class="nav-text">隐式锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%BE%E5%BC%8F%E9%94%81"><span class="nav-number">7.5.2.</span> <span class="nav-text">显式锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="nav-number">7.6.</span> <span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E9%94%81"><span class="nav-number">7.7.</span> <span class="nav-text">死锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A7%E7%94%9F%E6%AD%BB%E9%94%81%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6"><span class="nav-number">7.7.1.</span> <span class="nav-text">产生死锁的必要条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">7.7.2.</span> <span class="nav-text">死锁的解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="nav-number">7.7.3.</span> <span class="nav-text">避免死锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">8.</span> <span class="nav-text">锁的内存结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81%E7%9B%91%E6%8E%A7"><span class="nav-number">9.</span> <span class="nav-text">锁监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MVCC-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-number">10.</span> <span class="nav-text">MVCC 多版本并发控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E7%85%A7%E8%AF%BB%E4%B8%8E%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="nav-number">10.1.</span> <span class="nav-text">快照读与当前读</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="nav-number">10.1.1.</span> <span class="nav-text">快照读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="nav-number">10.1.2.</span> <span class="nav-text">当前读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8C%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5%E3%80%81Undo-Log%E7%89%88%E6%9C%AC%E9%93%BE"><span class="nav-number">10.2.</span> <span class="nav-text">隔离级别和隐藏字段、Undo Log版本链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadView"><span class="nav-number">10.3.</span> <span class="nav-text">ReadView</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-number">10.3.1.</span> <span class="nav-text">设计思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReadView%E7%9A%84%E8%A7%84%E5%88%99"><span class="nav-number">10.3.2.</span> <span class="nav-text">ReadView的规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVCC%E6%95%B4%E4%BD%93%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">10.4.</span> <span class="nav-text">MVCC整体操作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ReadView%E7%9A%84%E7%94%9F%E6%88%90%E8%8A%82%E7%82%B9"><span class="nav-number">10.4.1.</span> <span class="nav-text">ReadView的生成节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8MVCC"><span class="nav-number">10.5.</span> <span class="nav-text">使用MVCC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#READ-COMMITTED%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B"><span class="nav-number">10.5.1.</span> <span class="nav-text">READ COMMITTED隔离级别下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REPEATABLE-READ%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B"><span class="nav-number">10.5.2.</span> <span class="nav-text">REPEATABLE READ隔离级别下</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVCC%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB"><span class="nav-number">10.6.</span> <span class="nav-text">MVCC解决幻读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.7.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/fa7d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL学习笔记事务和锁篇 | 小夜时雨">
      <meta itemprop="description" content="这是学习MySQL的笔记事务和锁篇，主要包含数据库的事务、锁和MVCC机制。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL学习笔记事务和锁篇
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-24 00:00:00" itemprop="dateCreated datePublished" datetime="2022-11-24T00:00:00+08:00">2022-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-08 09:48:25" itemprop="dateModified" datetime="2023-09-08T09:48:25+08:00">2023-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span id="/post/fa7d.html" class="post-meta-item leancloud_visitors" data-flag-title="MySQL学习笔记事务和锁篇" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">这是学习MySQL的笔记事务和锁篇，主要包含数据库的事务、锁和MVCC机制。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="事务概述"><a href="#事务概述" class="headerlink" title="事务概述"></a>事务概述</h2><p>事务是数据库区别于文件系统的重要特性之一，当有了事务，就会让数据库使用保持一致性，同时还能通过事务的机制恢复到某个时间点，这样可以保证已提交到数据库的修改不会因为系统崩溃而丢失。</p>
<p>存储引擎支持事务的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> ENGINES;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> Engine             <span class="operator">|</span> Support <span class="operator">|</span> Comment                                                        <span class="operator">|</span> Transactions <span class="operator">|</span> XA   <span class="operator">|</span> Savepoints <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> ndbcluster         <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> Clustered, fault<span class="operator">-</span>tolerant tables                               <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FEDERATED          <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> Federated MySQL storage engine                                 <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MEMORY             <span class="operator">|</span> YES     <span class="operator">|</span> Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables      <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> InnoDB             <span class="operator">|</span> <span class="keyword">DEFAULT</span> <span class="operator">|</span> Supports transactions, <span class="type">row</span><span class="operator">-</span>level locking, <span class="keyword">and</span> <span class="keyword">foreign</span> keys     <span class="operator">|</span> YES          <span class="operator">|</span> YES  <span class="operator">|</span> YES        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> PERFORMANCE_SCHEMA <span class="operator">|</span> YES     <span class="operator">|</span> Performance Schema                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MyISAM             <span class="operator">|</span> YES     <span class="operator">|</span> MyISAM storage engine                                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ndbinfo            <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> MySQL Cluster <span class="keyword">system</span> information storage engine                <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MRG_MYISAM         <span class="operator">|</span> YES     <span class="operator">|</span> Collection <span class="keyword">of</span> identical MyISAM tables                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BLACKHOLE          <span class="operator">|</span> YES     <span class="operator">|</span> <span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> storage engine (anything you write <span class="keyword">to</span> it disappears) <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CSV                <span class="operator">|</span> YES     <span class="operator">|</span> CSV storage engine                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARCHIVE            <span class="operator">|</span> YES     <span class="operator">|</span> Archive storage engine                                         <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>可以看到，只有<code>InnoDB</code>支持事务。</p>
<p>事务：一组逻辑操作单元，使数据从一种状态变换到另一种状态。</p>
<p>事务的处理原则：保证所有事务都作为一个工作单元来执行，即使出现了故障，都不能改变这种执行方式。当在一个事务中执行多个操作时，要么所有的事务都被提交（<code>commit</code>），那么这些修改就<strong>永久</strong>地保存下来；要么数据库管理系统将<strong>放弃</strong>所做的所有<strong>修改</strong>，整个事务回滚（<code>rollback</code>）到最初状态。</p>
<h3 id="事务的ACID特性"><a href="#事务的ACID特性" class="headerlink" title="事务的ACID特性"></a>事务的ACID特性</h3><ul>
<li><p>原子性 <code>Atomicity</code>：原子性指事务是一个不可分割的工作单位，要么全部提交，要么全部失败回滚，没有中间状态</p>
</li>
<li><p>一致性 <code>Consistency</code>：一致性是指事务执行前后，数据从一个合法性状态变换到另外一个合法性状态，这种状态是语义上的而不是语法上的，跟具体业务有关。事务执行前后的状态，都是合法的，就是一致性。</p>
</li>
<li><p>隔离性 <code>Isolation</code>：隔离性是指事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能相互干扰。</p>
</li>
<li><p>持久性 <code>Durability</code>：持久性是指一个事务一旦被提交，它对数据库中数据的改变就是<strong>永久性的</strong>，接下来的其他操作和数据库故障不应该对其有任何影响。</p>
<p>持久性是通过<strong>事务日志</strong>来保证的，日志包括了<strong>重做日志</strong>和<strong>回滚日志</strong>，当通过事务对数据进行修改的时候，首先会将数据库的变化信息记录到重做日志中，然后再对数据库中对应的行进行修改。这样的好处是即使数据库系统崩溃，数据库重启后也能找到没有更新到数据库系统中的重做日志，重新执行，从而使事务具有持久性。</p>
</li>
</ul>
<p><code>ACID</code>是事务的四大特性，原子性是基础，隔离性是手段，一致性是约束条件，持久性是目的。</p>
<h3 id="事务的状态"><a href="#事务的状态" class="headerlink" title="事务的状态"></a>事务的状态</h3><p>MySQL根据对事务的一个或多个操作阶段，把事务大致划分几个状态：</p>
<ul>
<li>活动的 <code>active</code>：事务对应的数据库操作<strong>正在执行</strong>过程中时，就说该事务处在活动的状态。</li>
<li>部分提交的 <code>partially committed</code>：当事务中的最后一个操作执行完成，但由于操作都在内存中执行，所造成的影响并<strong>没有刷新到磁盘</strong>时，该事务处在部分提交状态。</li>
<li>失败的<code>failed</code>：当事务处在活动的或者部分提交的状态时，可能遇到了某些错误（数据库自身的错误、操作系统错误或者直接断电等）而无法继续执行，或者人为的停止当前事务的执行，该事务处于失败的状态。</li>
<li>中止的 <code>aborted</code>：事务执行了一部分而变成失败的状态，那么就需要把已经修改的事务中的操作还原到初始状态，也就是需要撤销操作。这个撤销的过程称之为回滚，当回滚操作执行完毕时，也就是数据库恢复到了执行事务之前的状态，该事务处在了中止的状态。</li>
<li>提交的 commit：当一个处在部分提交的状态的事务将修改后的数据都<strong>同步到磁盘</strong>上之后，该事务处在了提交的状态。</li>
</ul>
<p>事务状态转换图：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122205527852.png" alt="image-20221122205527852"></p>
<h3 id="使用事务"><a href="#使用事务" class="headerlink" title="使用事务"></a>使用事务</h3><p>事务的完整过程</p>
<p>显式事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 显式事务 </span></span><br><span class="line"><span class="comment">-- 步骤1：开启事务</span></span><br><span class="line"><span class="comment">-- START TRANSACTION 可以限制事务操作 </span></span><br><span class="line"><span class="comment">-- 当前事务是只读事务，不能增删改，只是不允许修改那些其他事务也能访问到的表的数据，对于临时表(CREATE TEMPORARY TABLE)来说，是可以进行增删改的 </span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION READ <span class="keyword">ONLY</span>;</span><br><span class="line"><span class="comment">-- 读写，默认 </span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION READ WRITE;</span><br><span class="line"><span class="comment">-- 开启一致性读 </span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION READ CONSISTENT SNAPSHOT;</span><br><span class="line"><span class="comment">-- 或者  </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 步骤2：一系列的DML操作</span></span><br><span class="line"><span class="comment">-- 步骤3：提交或者中止状态  </span></span><br><span class="line"><span class="comment">-- 提交事务 </span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 回滚事务  </span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<p>隐式事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 隐式事务  </span></span><br><span class="line"><span class="comment">-- 通过 autocommit 设置 ,默认 on，代表每一条DML都是一个独立的操作，执行之后，默认会自动提交。</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%autocommit%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 关闭自动提，只针对DML，对DDL是无效的  </span></span><br><span class="line"><span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="literal">FALSE</span>; </span><br><span class="line"><span class="comment">-- 执行操作，构成一个独立的事务   </span></span><br><span class="line"><span class="comment">-- 提交  </span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 当 autocommit 为 true，START TRANSACTION或者BEGIN之后，都不会将DML操作作为单个事务，而是作为整体一个事务。</span></span><br></pre></td></tr></table></figure>

<p>保存点：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 保存点 SAVEPOINT ： 事务操作中设置的一个状态，在事务结束之前，可以回到保存点继续操作失误。</span></span><br><span class="line"><span class="comment">-- 设置保存点 </span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> save1;</span><br><span class="line"><span class="comment">-- 回滚到保存点 </span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> save1;</span><br><span class="line"><span class="comment">-- 删除保存点 </span></span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span> save1;</span><br></pre></td></tr></table></figure>

<h3 id="隐式提交数据的情况"><a href="#隐式提交数据的情况" class="headerlink" title="隐式提交数据的情况"></a>隐式提交数据的情况</h3><ul>
<li><p>数据定义语言 <code>DDL</code> ：例如操作数据库、表、视图、存储过程等结构，<code>CREATE</code>、<code>ALTER</code>、<code>DROP</code>等语句</p>
</li>
<li><p>隐式使用或修改MySQL数据库中的表：使用 <code>ALTER USER</code>、<code>CREATE USER</code>、<code>DROP USER</code>、<code>GRANT</code>、<code>RENAME USER</code>、<code>REVOKE</code>、<code>SET PASSWORD</code>等语句也会隐式提交前面语句所属于的事务</p>
</li>
<li><p>事务控制或关于锁定的语句：在一个事务中没有提交或者回滚，又使用<code>START TRANSACTION</code>或者<code>BEGIN</code>开启一个新的事物，会隐式的提交上一个事务</p>
</li>
<li><p>将 <code>autocommit</code> 设置为<code>true</code>，也会隐式提交前边语句所属的事务</p>
</li>
<li><p>使用 <code>LOCK TABLES</code>、<code>UNLOCK TABLES</code>等关于锁定的语句也会隐式的提交前边语句所属的事务。</p>
</li>
<li><p>加载数据的语句：LOAD DATA语句来批量往数据库中导入数据时，也会隐式的提交前面语句所属的事务。</p>
</li>
<li><p>关于MySQL复制的一些语句：<code>START SLAVE</code>、<code>STOP SLAVE</code>、<code>RESET SLAVE</code>、<code>CHANGE MASTER TO</code>等语句，也会隐式的提交前面语句所属的事务。</p>
</li>
<li><p>其他的一些语句：使用 <code>ANALYZE TABLE</code>，<code>CACHE INDEX</code>、<code>CHECK TABLE</code>、<code>FLUSH</code>、<code>LOAD INDEX INTO CACHE</code>、<code>OPTIMIZE TABLE</code>、<code>REPAIR TABLE</code>、<code>RESET</code>等语句也会隐式的提交前面语句所属的事务。</p>
</li>
</ul>
<h2 id="事务操作"><a href="#事务操作" class="headerlink" title="事务操作"></a>事务操作</h2><h3 id="使用事务-1"><a href="#使用事务-1" class="headerlink" title="使用事务"></a>使用事务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用事务 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user3(name <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">PRIMARY</span> KEY);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">-- 获取数据，可以获取到 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="comment">-- 提交 </span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 获取数据，也可以获取到 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="comment">-- 收到主键影响，会插入失败  </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- DDL 操作会自动提交数据，不受 autocommit 变量的影响 </span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> user3;</span><br><span class="line"><span class="comment">-- autocommit为默认状态   </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%autocommit%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 默认一条DML为一个事务，可以提交成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>); </span><br><span class="line"><span class="comment">-- 由于主键原因，操作失败，处于 failed 状态 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">-- 回滚，回滚到失败状态之间</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="comment">-- 只插入了1条记录  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- completion_type的使用  </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@completion</span>_type;</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@completion</span>_type <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- autocommit为默认状态   </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%autocommit%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 默认一条DML为一个事务，可以提交成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;b&#x27;</span>); </span><br><span class="line"><span class="comment">-- 由于主键原因，操作失败，处于 failed 状态 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="comment">-- 回滚</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="comment">-- 还是只有a这1条记录，这就是由于   @@completion_type 的影响 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br></pre></td></tr></table></figure>

<p><code>completion_type</code>的使用</p>
<ol>
<li><code>completion_type=0</code>，默认情况，当执行<code>COMMIT</code>的时候会提交事务，执行下一个事务时，还需要用<code>START TRANSACTION</code>或者<code>BEGIN</code>来开启。</li>
<li><code>completion_type=1</code>，提交事务之后，相当于执行了 <code>COMMIT AND CHAIN</code>，也就是开启一个链式事物，即提交事务之后会开启一个相同隔离级别的事务。</li>
<li><code>completion_type=2</code>，这种情况下 <code>COMMIT=COMMIT AND RELEASE</code>，也就是当事务提交时，会自动与服务器断开连接。</li>
</ol>
<h3 id="InnoDB和MyISAM在事务下的区别"><a href="#InnoDB和MyISAM在事务下的区别" class="headerlink" title="InnoDB和MyISAM在事务下的区别"></a>InnoDB和MyISAM在事务下的区别</h3><p>MyISAM不支持事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表  </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test1(i <span class="type">INT</span>) ENGINE <span class="operator">=</span> INNODB;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test2(i <span class="type">INT</span>) ENGINE <span class="operator">=</span> MYISAM;</span><br><span class="line"><span class="comment">-- 针对 InnoDB </span></span><br><span class="line"><span class="keyword">BEGIN</span>; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1 <span class="keyword">VALUES</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="comment">-- 回滚之后，没有数据 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 针对 MyISAM </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="comment">-- 回滚之后，数据还在，事务对MyISAM无效 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test2;</span><br></pre></td></tr></table></figure>

<h3 id="保存点-SAVEPOINT"><a href="#保存点-SAVEPOINT" class="headerlink" title="保存点 SAVEPOINT"></a>保存点 SAVEPOINT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user4(NAME <span class="type">VARCHAR</span>(<span class="number">10</span>),balance <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>));</span><br><span class="line"><span class="comment">-- 操作事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user4(NAME,balance) <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>,<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 再次操作事务  </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> user4 <span class="keyword">SET</span> balance<span class="operator">=</span>balance<span class="number">-100</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> user4 <span class="keyword">SET</span> balance<span class="operator">=</span>balance<span class="number">-100</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="comment">-- 设置保存点 </span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> s1;</span><br><span class="line"><span class="keyword">UPDATE</span> user4 <span class="keyword">SET</span> balance<span class="operator">=</span>balance<span class="operator">+</span><span class="number">1</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="comment">-- 单独回滚 +1 的操作，回滚到保存点 s1  </span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> s1;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user4;</span><br><span class="line"><span class="comment">-- 此时事务没有完成  </span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="comment">-- 或者  </span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h2><p>实际使用场景中，可能出现多线程并发操作，而且可能出现多个线程同时使用事务，这种情况下，需要保障事务的<code>ACID</code>，此时就需要通过隔离性，某个事务对某个数据进行访问时，其他事务应该进行排队，当事务提交之后，其他事务才可以就行访问这个数据。但是这样对性能影响很大，因此需要权衡。 </p>
<p>数据准备</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student(</span><br><span class="line">studentno <span class="type">INT</span>,</span><br><span class="line">name <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">class <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY(studentno)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;小谷&#x27;</span>,<span class="string">&#x27;1班&#x27;</span>);</span><br><span class="line"><span class="comment">-- 获取数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span> studentno <span class="operator">|</span> name   <span class="operator">|</span> class <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span> 小谷   <span class="operator">|</span> <span class="number">1</span>班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="数据并发问题"><a href="#数据并发问题" class="headerlink" title="数据并发问题"></a>数据并发问题</h3><ol>
<li><p>脏写（<code>Dirty Write</code>）</p>
<p>对于两个事务<code>Session A</code>、<code>Session B</code>，如果事务<code>Session A</code>修改了另一个未提交事务<code>Session B</code>修改过的数据，那就意味着发生了脏写</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215224984.png" alt="image-20221122215224984"></p>
</li>
<li><p>脏读（<code>Dirty Read</code>）</p>
<p>对于两个事务<code>Session A</code>、<code>Session B</code>，<code>Session A</code>读取了<strong>已经被<code>Session B</code>更新但还没有被提交</strong>的字段。之后若<code>Session B</code>回滚，<code>Session A</code>读取的内容就是临时且无效的。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215425596.png" alt="image-20221122215425596"></p>
</li>
<li><p>不可重复读（<code>Non-Repeatable Read</code>）</p>
<p>对于两个事务<code>Session A</code>、<code>Session B</code>，**<code>Session A</code>读取了一个字段，然后<code>Session B</code>更新了该字段。之后<code>Session A</code>再次读取同一个字段，值就不同**，就意味着发生了不可重复读。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215607038.png" alt="image-20221122215607038"></p>
</li>
<li><p>幻读（<code>Phantom</code>）</p>
<p>对于两个事务<code>Session A</code>、<code>Session B</code>，<code>Session A</code>从一个表中读取了一个字段，然后<code>Session B</code>在该表中插入了一些新的行。之后，如果<code>Session A</code>再次读取同一个表，就会多出几行。那就意味着发生了幻读。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122215842827.png" alt="image-20221122215842827"></p>
<p>注意1：如果<code>Session B</code>删除了一些记录，导致<code>Session A</code>读取的记录变少了，这个现象不属于幻读，幻读强调的是一个事务按照某个相同条件多次读取记录时，后读取时读到了之前没有读到的记录。</p>
<p>注意2：对于先前已经读到的记录，之后又读取不到，这相当于每一条记录都发生了不可重复读的现象。</p>
</li>
</ol>
<h3 id="SQL中的四种隔离级别"><a href="#SQL中的四种隔离级别" class="headerlink" title="SQL中的四种隔离级别"></a>SQL中的四种隔离级别</h3><p>上面的问题按照严重性排序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">脏写 <span class="operator">&gt;</span> 脏读 <span class="operator">&gt;</span> 不可重复读 <span class="operator">&gt;</span> 幻读</span><br></pre></td></tr></table></figure>

<p>可以舍弃一部分隔离性来换取一部分性能在这里就体现在：设立一些隔离级别，隔离级别越低，并发问题发生的就越多。</p>
<p>SQL标准设立了4个隔离级别：</p>
<ul>
<li><p><code>READ UNCOMMIT</code>：读未提交，在该隔离级别，所有事务都可以看到其他未提交事务的执行结果（没有提交，但是可以看到结果，也就意味着发生了脏读，因为如果另外一个事务回滚，则出现前后不一致。）。不能避免脏读、不可重复读、幻读。</p>
</li>
<li><p><code>READ COMMIT</code>：读已提交，满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变（没有提交，则读取不到，提交，则读取到），这是大多数数据库系统的默认隔离级别（Oracle默认隔离级别）。可以避免脏读，但不可重复读、幻读问题仍然存在。</p>
</li>
<li><p><code>REPEATABLE READ</code>：可重复读，事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交，那么事务A再读该数据，读到的还是原来的内容（先读一条数据，后续无论其他事务是否提交，都按照这条已经读到的数据处理）（这里与脏读的差别是脏读提交之后可读取到，提交之前读取不到；可重复读是读取的都是第一次读取的数据。）。可以避免脏读、不可重复读，但幻读问题仍然存在。这是MySQL的默认隔离级别。</p>
</li>
<li><p><code>SERIALIZABLE</code>：可串行化，确保事务可以从一个表中读取相同的行。这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作。所有的并发问题都可以避免，但是性能很低。能避免脏读、不可重复读和幻读。</p>
</li>
</ul>
<p>SQL标准中规定，针对不同的隔离级别，并发事务可以发生不同严重程度的问题，具体情况如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122225953987.png" alt="image-20221122225953987"></p>
<p>脏读是最为严重的，因此这四种隔离级别，都解决了脏读的问题。</p>
<p>不同隔离级别有不同的锁和并发机制，隔离级别与并发性能关系如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221122225935399.png" alt="image-20221122225935399"></p>
<h3 id="MySQL支持的四种隔离级别"><a href="#MySQL支持的四种隔离级别" class="headerlink" title="MySQL支持的四种隔离级别"></a>MySQL支持的四种隔离级别</h3><p>MySQL虽然都支持四种隔离级别，但是跟SQL标准中的定义有些出入。MySQL在<code>REPEATABLE READ</code>隔离级别下，是可以禁止幻读问题的发生，主要是通过<code>MVCC</code>实现。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看隔离级别</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="comment">-- 设置隔离级别  </span></span><br><span class="line"><span class="comment">-- 当前会话  </span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line"><span class="comment">-- 全局 </span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"><span class="comment">-- 或者  </span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;READ-UNCOMMITTED&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;SERIALIZABLE&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><code>GLOBAL</code>：当前已经存在的会话无效，只对执行完该语句之后产生的会话起作用；</p>
<p><code>SESSION</code>：对当前会话的所有后续事务有效，如果在事务之间执行，对后续的事务有效，该语句可以在当前事务中间执行，但不会影响当前正在执行的事务</p>
<p>重启之后，都会恢复成默认隔离级别。</p>
<p>演示脏读的问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 解决读未提交 </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span>balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 回滚 </span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启的另外一个会话  </span></span><br><span class="line">USE dbtest2;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 修改隔离级别 </span></span><br><span class="line"><span class="comment">-- 修改成读未提交  </span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;READ-UNCOMMITTED&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="comment">-- 此时另外一个session的事务未提交 </span></span><br><span class="line"><span class="comment">-- 可以获取到数据，出现了脏读  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另外一个session的事务回滚之后，再次读取数据，此时数据又发生变更 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br></pre></td></tr></table></figure>

<p>演示不可重复读的问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 更改隔离级别，改成读已提交 </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 扣除1中500 </span></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">500</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 查询此时数据，数据正常 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 提交 </span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 更改隔离级别，改成读已提交 </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 开启事务之后先获取一次数据，起初状态都是 1000   </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另外一个session操作事物之后，获取到的还是 1000，此时就避免了脏读     </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 事务没有结束，另一个session提交之后，再次读取，读取的是提交之后的数据，出现了不可重复读  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>解决不可重复度的问题，使用可重复读的隔离级别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更改隔离级别，改成可重复度</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line"><span class="comment">-- 同时开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 开启之后就获取一次数据  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另一个回话事务修改之后，再次获取数据，与上次获取的是一样的，脏读避免了 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另一个回话事务提交之后，再次获取数据，与上次获取的是一样的，也解决了不可重复读的问题  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更改隔离级别，改成可重复度</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line"><span class="comment">-- 同时开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 开启之后就获取一次数据  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另一个回话事务修改之后，再次获取数据，与上次获取的是一样的，脏读避免了 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="comment">-- 另一个回话事务提交之后，再次获取数据，与上次获取的是一样的，也解决了不可重复读的问题  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br></pre></td></tr></table></figure>

<p>幻读的问题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更改隔离级别，改成可重复度</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account(id,`NAME`,balance) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更改隔离级别，改成可重复度</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line"><span class="comment">-- 开启事务  </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 获取个数，最开始为0个 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> account <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">-- 另一个session插入之后，再次获取个数，依然是0个，此时验证了可重复读  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> account <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">-- 但是如果此时3的记录插入，会出现报错   1062 - Duplicate entry &#x27;3&#x27; for key &#x27;account.PRIMARY&#x27; ，也就是记录3是存在的，出现了幻读  </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account(id,`NAME`,balance) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">200</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<p>通过<code>SERIALIZABLE</code>串行化解决幻读的问题</p>
<p><code>SERIALIZABLE</code>隔离级别下，如果在<code>session A</code>的事务中插入数据，此时会加上一个隐式的行<strong>（X）锁</strong>&#x2F;<strong>gap（X）锁</strong>，而<code>session B</code>的事务中再次插入会被阻塞，<code>session A</code> 的事务结束之后，<code>session B</code>的锁才会被释放。</p>
<p>MySQL在 <code>REPEATABLE-READ</code>隔离级别下，也是可以避免幻读的，主要也是对<code>select</code>操作手动<strong>加行X锁（独占锁）</strong>，从而在<code>session A</code>的 <code>insert</code>操作时会阻塞。即便当前记录不存在，比如<code>id=3</code>不存在，当前事务也会获得一把记录锁（因为InnoDB的行锁锁定的是索引，故记录实体存在与否没关系，存在就加行X锁，不存在就加间隙锁。），从而解决幻读的问题。</p>
<h2 id="MySQL事务日志之redo日志"><a href="#MySQL事务日志之redo日志" class="headerlink" title="MySQL事务日志之redo日志"></a>MySQL事务日志之<code>redo</code>日志</h2><p>事务的ACID特性实现机制：</p>
<ul>
<li>隔离性：通过锁机制实现</li>
<li>原子性、一致性、持久性由事务的<code>redo</code>日志和<code>undo</code>日志来保证<ul>
<li><code>REDO LOG</code>称为重做日志，提供再写入操作，恢复提交事务修改的页操作（如果事务写入到一半，服务器宕机，重启之后，能够保证事务写入完整，保证数据的可靠性），用来保证事务的持久性。</li>
<li><code>UNDO LOG</code>称为回滚日志，回滚行记录到某个特定版本，用来保证事务的原子性、一致性。</li>
</ul>
</li>
</ul>
<p><code>REDO</code>和<code>UNDO</code>都可以视为一种恢复操作，但是：</p>
<ul>
<li><p><code>redo log</code>：存储引擎<code>InnoDB</code>生成的日志，记录的是物理级别上的页的修改操作，比如<code>页号xxx</code>、<code>偏移量yyy</code>写入了<code>数据zzz</code>。主要是为了保证数据的可靠性。</p>
</li>
<li><p><code>undo log</code>：存储引擎<code>InnoDB</code>生成的日志，记录的是<strong>逻辑操作</strong>日志，比如对某一行数据进行了<code>INSERT</code>语句的操作，那么<code>undo log</code>就记录一条与之相反的<code>DELETE</code>操作。主要用于<strong>事务的回滚</strong>（<code>undo log</code>记录的是每个修改操作的<strong>逆操作</strong>）和一<strong>致性非锁定读</strong>（<code>undo log</code>回滚行记录到某种特定的版本–<code>MVCC</code>，即多版本并发控制）。</p>
</li>
</ul>
<h3 id="redo日志"><a href="#redo日志" class="headerlink" title="redo日志"></a><code>redo</code>日志</h3><p><code>InnoDB</code>存储引擎是<strong>以页为单位</strong>来管理存储空间的。早真正访问页面之前，需要把<strong>磁盘上</strong>的页缓存到内存中的<code>buffer pool</code>之后才可以访问。所有变更都必须<strong>先更新缓冲池</strong>中的数据，然后把缓冲池中的<strong>脏页</strong>会以一定的频率被刷入磁盘（<strong>checkpoint机制</strong>），通过缓冲池来优化CPU和磁盘之间的鸿沟，来保证整体的性能不会下降太快。</p>
<p>为什么需要&#96;&#96;redo log&#96;？</p>
<p>由于<code>checkpoint</code>机制不是每次变更的时候触发，当事务没有提交，事务中的操作只是修改了缓冲池中的数据，此时服务器宕机，缓冲池中的数据丢失，此时就无法保证事务的持久性。或者说事务执行到一半宕机，恢复之后，能够从继续从中断的部分继续开始。</p>
<p>事务的持久性特性，就是说对于一个已经提交的事务，在事务提交后即使系统发生了崩溃，这个事务对数据库中所做的更改也不能丢失。</p>
<p>一个简单的做法：通过在事务提交之前，把该事务所修改的所有页面都刷新到磁盘，但是这个做法有些问题：</p>
<ul>
<li>修改量与刷新磁盘工作量严重不成比例：修改缓冲池可能只有<code>1Byte</code>，但是一个页修改磁盘会修改<code>16KB</code>，这样会大大的增加成本。</li>
<li>随机<code>IO</code>刷新较慢：一个事务可能操作很多页，每一个页都去操作可能导致大量的随机<code>IO</code>，成本也很高。</li>
</ul>
<p>针对这种情况，可以将修改了的数据记录一下。</p>
<p><code>InnoDB</code>引擎的事务采用<strong>WAL技术</strong>（<code>Write-Ahead Log</code>），先写日志，再写磁盘，只有日志写入成功，才算事务提交成功，这里的日志就是<code>redo log</code>。当发生宕机，且数据未刷到磁盘的时候，可以通过<code>redo log</code>恢复，保证<code>ACID</code>中的<code>D</code>。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123145613755.png" alt="image-20221123145613755"></p>
<h3 id="redo-log的好处、特点"><a href="#redo-log的好处、特点" class="headerlink" title="redo log的好处、特点"></a><code>redo log</code>的好处、特点</h3><p>好处：</p>
<ul>
<li><code>redo log</code>降低刷盘频率</li>
<li><code>redo log</code>日志占用的空间非常小：保存<code>表空间id</code>、<code>页号</code>、<code>偏移量</code>以及<code>需要更新的值</code></li>
</ul>
<p>特定：</p>
<ul>
<li><code>redo log</code>是顺序写入的：按照产生的顺序写入磁盘</li>
<li>事务执行过程中，<code>redo log</code>不断记录</li>
</ul>
<h3 id="redo的组成"><a href="#redo的组成" class="headerlink" title="redo的组成"></a><code>redo</code>的组成</h3><p><code>redo log</code>可以简单分为两个部分：</p>
<ul>
<li><p>重做日志的缓冲（<code>redo log buffer</code>）：保存在内存中，是易失的。服务器启动时，就向操作系统申请了一大片称之为 <code>redo log buffer</code>的连续内存空间，这片空间被划分成若干个连续的 <code>redo log block</code>，一个 <code>redo log block</code>占用<code>512字节</code>大小。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123151948870.png" alt="image-20221123151948870"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看 redo log buffer </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%innodb_log_buffer_size%&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重做日志文件（<code>redo log file</code>）：保存在磁盘中，是持久的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql 3.2M Nov 23 02:14 &#x27;#ib_redo753&#x27;</span></span><br><span class="line">bash<span class="number">-4.4</span># pwd</span><br><span class="line"><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>#innodb_redo</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123154701699.png" alt="image-20221123154701699"></p>
<p>更新事务过程如下：</p>
<ol>
<li>将原始数据从磁盘加到到内存中，修改内存中的数据</li>
<li>生成一条<code>redo log</code>，写入<code>redo log buffer</code>，记录的是数据被修改后的值</li>
<li>当事务<code>commit</code>时，将<code>redo log buffer</code> 中的内存刷新到 <code>redo log file</code>，对 <code>redo log file</code> 采用追加写的方式</li>
<li>定期将内存中修改的数据刷新到磁盘中</li>
</ol>
<h3 id="redo-log-刷盘策略"><a href="#redo-log-刷盘策略" class="headerlink" title="redo log 刷盘策略"></a><code>redo log</code> 刷盘策略</h3><p><code>redo log buffer</code>中的数据，会以一定频率刷入到真正的<code>redo log file</code> 中。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123155107531.png" alt="image-20221123155107531"></p>
<p><code>redo log buffer</code> 刷盘到<code>redo log file</code>过程是刷到文件系统缓存，真正的写入会交给系统自己来决定。<code>InnoDB</code>也可以通过<code>innodb_flush_log_at_trx_commit</code>参数控制<code>commit</code>提交事务时，如何将<code>redo log buffer</code> 中的日志刷新到<code>redo log file</code>中。</p>
<ul>
<li><p>0：表示每次事务提交时不进行刷盘操作。（默认 <code>master thread</code> 每隔 1s 进行一次重做日志的同步）</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204441117.png" alt="image-20221123204441117"></p>
<p>IO效率高于1，安全性低于2，只将数据写入 <code>redo log buffer</code>，是一个折中方案。</p>
</li>
<li><p>1：表示每次事务提交时都将进行同步，刷盘操作（默认值）</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204009071.png" alt="image-20221123204009071"></p>
<p>这种情况主要事务提交，就会刷到磁盘，效率虽然差，但是安全性高。</p>
</li>
<li><p>2：表示每次事务提交都只把 <code>redo log buffer</code> 内容写入 <code>page cache</code>，不进行同步，由 <code>os</code> 自己决定什么时候同步到磁盘。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123204221137.png" alt="image-20221123204221137"></p>
<p>只要事务提交成功，<code>redo log buffer</code> 中的文件会写入<code>page cache</code>。</p>
</li>
</ul>
<p>查看和设置配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%innodb_flush_log_at_trx_commit%&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><code>InnoDB</code>存储引擎有一个后台线程，每隔<code>1s</code>，就会把<code>redo log buff</code>内容写入<code>page cache</code>，然后调用刷盘操作。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123203800462.png" alt="image-20221123203800462"></p>
<p>也就是说，一个没有提交事务的 <code>redo log</code> 记录，也可能会刷盘，因为事务执行过程 <code>redo log</code>记录是会写入 <code>redo log buffer</code> 中，这些 <code>redo log</code> 记录会被后台线程刷盘。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123203948900.png" alt="image-20221123203948900"></p>
<h3 id="写入redo-log-buffer过程"><a href="#写入redo-log-buffer过程" class="headerlink" title="写入redo log buffer过程"></a>写入<code>redo log buffer</code>过程</h3><p><code>MySQL</code>把底层页面中的一次原子访问的过程称之为一个<code>Mini-Transaction</code>，简称<code>mtr</code>，比如向某个索引对应的<code>B+</code>树中插入一条记录的过程就是一个<code>mtr</code>。一个所谓的<code>mtr</code>可以包含一组<code>redo log</code>，在进行崩溃时，这一组<code>redo log</code>日志作为一个不可分割的整体。</p>
<p>一个事务可以包含多个语句，每个语句其实是由若干个<code>mtr</code>组成，每一个<code>mtr</code>又可以包含若干条<code>redo log</code>。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205341477.png" alt="image-20221123205341477"></p>
<p>向<code>log buffer</code>中写入<code>redo log</code>的过程是顺序的，也就是先往前边的<code>block</code>写，当该<code>block</code>的空闲空间用完之后，再往下一个<code>block</code>写。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205503134.png" alt="image-20221123205503134"></p>
<p>一个<code>mtr</code>执行过程的<code>redo log</code>作为一个不可分割的组。每个<code>mtr</code>运行过程中产生的日志先暂存到一个地方，当该<code>mtr</code>结束的时候，将过程中产生的一组<code>redo log</code>全部复制到<code>log buffer</code>中。</p>
<p>例如两个交叉的事务日志记录 </p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205825888.png" alt="image-20221123205825888"></p>
<p><code>redo log block</code>由三个部分组成，日志头、日志体、日志尾，一共是<code>512字节</code>。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123205921819.png" alt="image-20221123205921819"></p>
<h3 id="redo-log-file"><a href="#redo-log-file" class="headerlink" title="redo log file"></a><code>redo log file</code></h3><p>日志目录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看 redo log file 存放位置 </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_log_group_home_dir&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看 redo log file 个数  </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_log_files_in_group&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看单个redo log file 大小，总大小就是 innodb_log_file_size * innodb_log_files_in_group，单个默认值 48M ，总最大值512G</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_log_file_size&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="日志文件组"><a href="#日志文件组" class="headerlink" title="日志文件组"></a>日志文件组</h3><p>写入日志文件的顺序是先写0号日志，写满了再往下一个日志文件中写 </p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123210521940.png" alt="image-20221123210521940"></p>
<p>循环使用的方式可能导致后写入的<code>redo</code>日志覆盖前面的<code>redo</code>日志，因此<code>InnoDB</code>提出<code>checkpoint</code>的概念。</p>
<p>整个日志文件组中还有两个重要的属性，分别是 <code>write pos</code>、<code>checkpoint</code></p>
<ul>
<li><code>write pos</code>：当前记录的位置，一边写一边后移</li>
<li><code>checkpoint</code>：当前要擦除的位置，也是往后推移</li>
</ul>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123210721287.png" alt="image-20221123210721287"></p>
<p>如果 <code>write pos</code>追上<code>checkpoint</code>，表示日志文件组满了，这时候就不能再写入新的<code>redo log</code>，<code>MySQL</code>需要清空一些记录，把<code>checkpoint</code>推进一下。 </p>
<p><img src="/../../../../../Library/Application%20Support/typora-user-images/image-20221123210845713.png" alt="image-20221123210845713"></p>
<h2 id="MySQL事务日志之undo日志"><a href="#MySQL事务日志之undo日志" class="headerlink" title="MySQL事务日志之undo日志"></a>MySQL事务日志之<code>undo</code>日志</h2><h3 id="undo日志"><a href="#undo日志" class="headerlink" title="undo日志"></a><code>undo</code>日志</h3><p><code>redo log</code> 是事务持久性的保证，<code>undo log</code> 是事务原子性的保证。在事务中更新数据的前置操作其实是要先写入一个<code>undo log</code> 。</p>
<p>事务需要原子性，当事务需要回滚或者服务器突然断电，需要将数据改变到原先的样子，这个过程就是<strong>回滚</strong>。</p>
<p>当做改动（<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code>）时（查询不会记录<code>undo log</code>），会将回滚时所需的东西记录下来：</p>
<ul>
<li>插入时，会记录一个基于主键的删除操作</li>
<li>删除时，会记录全部内容的一个插入操作</li>
<li>修改时，会记录一个相反的更新操作</li>
</ul>
<p>MySQL把这些为了回滚而记录的这些内容称之为撤销日志或者回滚日志（<code>undo log</code>）。此外，<code>undo log</code> 会产生 <code>redo log</code>，也就是<code>undo log</code> 的产生会伴随着<code>redo log</code> 的产生，这是因为<code>undo log</code> 也需要持久化。</p>
<h3 id="undo-log-的作用"><a href="#undo-log-的作用" class="headerlink" title="undo log 的作用"></a><code>undo log</code> 的作用</h3><ul>
<li>作用1：回滚数据：<code>undo</code>是逻辑层面，而不是物理层面，当新的数据开辟新的页，<code>undo</code>之后，不会回收新的页。</li>
<li>作用2：<code>MVCC</code>：当用户读取一行记录时，若该记录已经被其他事务占用，当前事务可以通过<code>undo</code>读取之前的行版本信息，以此实现非锁定读取。</li>
</ul>
<h3 id="undo-的存储结构"><a href="#undo-的存储结构" class="headerlink" title="undo 的存储结构"></a><code>undo</code> 的存储结构</h3><p>回滚段与<code>undo</code>页：<code>InnoDB</code>对<code>undo log</code>的管理采用段的方式，每个回滚段记录了<code>1024</code>个<code>undo log segment</code>，在每个<code>undo log segment</code>段中进行<code>undo</code>页的申请</p>
<p>1个<code>undo log segment</code>可支持1个事务，查看回滚段的个数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_undo%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_undo_directory    <span class="operator">|</span> .<span class="operator">/</span>    <span class="operator">|</span> <span class="comment">-- 日志存放位置</span></span><br><span class="line"><span class="operator">|</span> innodb_undo_log_encrypt  <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_undo_log_truncate <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_undo_tablespaces  <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span> <span class="comment">-- undo log segment都存储于共享表空间ibdata中</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="回滚段与事务"><a href="#回滚段与事务" class="headerlink" title="回滚段与事务"></a>回滚段与事务</h3><ol>
<li>每个事务会使用一个回滚段，一个回滚段同一时刻可能会服务于多个事务</li>
<li>一个事务开始的时候，会制定一个回滚段，在事务进行的过程中，当数据被修改时，原始的数据会被复制到回滚段</li>
<li>回滚段中，事务会不断填充盘区，直到事务结束或所有的空间被用完。如果当前盘区不沟通，事务会在段中请求下一个盘区，如果所有已分配的盘区都用完，事务会覆盖最初的盘区或者在回滚段允许的情况下扩展新的盘区来使用</li>
<li>回滚段存于<code>undo</code>表空间中，在数据库中可以存在多个<code>undo</code>表空间，但同一时刻只能使用一个<code>undo</code> 表空间。</li>
<li>当事务提交时，<code>InnoDB</code>存储引擎会做以下两件事情：<ol>
<li>将<code>undo log</code> 放入列表中，以供之后的<code>purge</code>操作</li>
<li>判断<code>undo log</code>所在的页是否可以重用（<code>undo log</code> 在<code>commit</code> 之后，会被放到一个链表中，然后判断<code>undo</code> 页的使用空间是否小于<code>3/4</code>，小于的话则代表当前<code>undo</code> 页可以重用），若可以分配给下个事务使用</li>
</ol>
</li>
</ol>
<h3 id="回滚段中的数据分类"><a href="#回滚段中的数据分类" class="headerlink" title="回滚段中的数据分类"></a>回滚段中的数据分类</h3><ol>
<li>未提交的回滚数据：用于实现读一致性，因此数据不能被其他事务的数据覆盖</li>
<li>已经提交但未过期的回滚数据：关联的事务已经提交，但是仍受到 <code>undo retention</code>参数的保持时间的影响。（可能有其他事务需要通过<code>undo log</code> 来得到记录之前的版本）</li>
<li>事务已经提交并过期的数据：事务已经提交，并且已经超过<code>undo retention</code>参数的保持时间，属于已经过期的数据。当回滚段满了之后，会优先覆盖”事务已经提交并过期的数据“</li>
</ol>
<h3 id="undo的类型"><a href="#undo的类型" class="headerlink" title="undo的类型"></a><code>undo</code>的类型</h3><ul>
<li><code>insert undo log</code> ：insert操作中产生的<code>undo log</code>。这个操作只对事务本身可见，对其他事务不可见（满足事务隔离性要求），因此<code>undo log</code> 可以在事务提交之后直接删除。</li>
<li><code>update undo log</code>：对<code>update</code>和<code>delete</code>操作中产生的<code>undo log</code> 。该<code>undo log</code> 可能需要提供<code>MVCC</code>机制，因此不能在事务提交时就进行删除。提交时放入<code>undo log</code> 链表，等待<code>purge</code> 线程进行最后的删除。</li>
</ul>
<h3 id="undo-log的生命周期"><a href="#undo-log的生命周期" class="headerlink" title="undo log的生命周期"></a><code>undo log</code>的生命周期</h3><p><code>A=1</code>和<code>B=2</code>，将A修改为3，B修改为4</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">记录 A<span class="operator">=</span><span class="number">1</span> 到 undo log;</span><br><span class="line"><span class="keyword">update</span> A<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line">记录 A<span class="operator">=</span><span class="number">3</span> 到 redo log;</span><br><span class="line">记录 B<span class="operator">=</span><span class="number">2</span> 到 undo log;</span><br><span class="line"><span class="keyword">update</span> B<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line">记录 B<span class="operator">=</span><span class="number">4</span> 到 redo log;</span><br><span class="line">将 redo log 刷新到磁盘;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>1-8步的任意一步系统宕机，事务未提交，该事务不会对磁盘上的数据做任何影响；</li>
<li>如果8-9之间宕机，恢复之后，可以选择回滚，也可以选择继续完成事务提交，因此此时<code>redo log</code> 已经持久化；</li>
<li>9之后系统宕机，内存映射中变更的数据还来不及刷回磁盘，那么系统恢复之后，可以根据<code>redo log</code> 把数据刷回磁盘。</li>
</ul>
<p>没有<code>redo log</code>和<code>undo log</code>，只有<code>Buffer Pool</code>的流程：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123215755143.png" alt="image-20221123215755143"></p>
<p>有 <code>redo log</code>和 <code>undo log</code>之后</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123215850385.png" alt="image-20221123215850385"></p>
<h3 id="详细生成过程"><a href="#详细生成过程" class="headerlink" title="详细生成过程"></a>详细生成过程</h3><p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220108591.png" alt="image-20221123220108591"></p>
<p>每一条数据的列式存储时，有隐藏的三个字段：</p>
<ul>
<li><code>DB_ROW_ID</code>：如果乜有显示的主键，也没有唯一索引，那么<code>InnoDB</code>会自动添加一个<code>row_id</code>的隐藏列作为主键</li>
<li><code>DB_TRX_ID</code>：每个事务都会有一个<code>id</code>，当记录发生变更时，记录这个事务的<code>ID</code></li>
<li><code>DB_ROLL_PTR</code>：回滚指针，指向<code>undo log</code>的指针</li>
</ul>
<p>当执行<code>INSERT</code>时</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span>(name) <span class="keyword">values</span>(&quot;tom&quot;);</span><br></pre></td></tr></table></figure>

<p>插入一条数据会生成一条<code>undo log</code>，</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220420343.png" alt="image-20221123220420343"></p>
<p>执行<code>UPDATE</code>时</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> name<span class="operator">=</span>&quot;Sun&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220458824.png" alt="image-20221123220458824"></p>
<p>将老的记录写入新的 <code>undo log</code>，让回滚指针指向新的 <code>undo log</code></p>
<p>此时更新</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123220621018.png" alt="image-20221123220621018"></p>
<p>实际上是将原先的数据的删除标记打开，然后在后面插入一条新的数据，新的数据回滚指针指向产生的 <code>undo log</code> 。<code>undo log</code>每次都是递增，按照序号依次向前推，就可以找到原始数据。</p>
<h3 id="undo-log-回滚"><a href="#undo-log-回滚" class="headerlink" title="undo log 回滚"></a><code>undo log</code> 回滚</h3><ol>
<li>通过<code>undo no=3</code>的日志把<code>id=2</code>的数据删除</li>
<li>通过<code>undo no=2</code>的日志把<code>id=1</code>的数据的<code>deletemark</code>还原成<code>0</code></li>
<li>通过<code>undo no=1</code>的日志把<code>id=1</code>的数据的<code>name</code>还原成<code>Tom</code></li>
<li>通过<code>undo no=0</code>的日志把<code>id=1</code>的数据删除</li>
</ol>
<h3 id="undo-log删除"><a href="#undo-log删除" class="headerlink" title="undo log删除"></a><code>undo log</code>删除</h3><ul>
<li>针对 <code>insert undo log</code>：事务提交之后直接删除</li>
<li>针对 <code>update undo log</code>：提交之后可能需要提供<code>MVCC</code>机制，提交时放到 <code>undo log</code>链表，等待 <code>purge</code>线程进行最后的删除</li>
</ul>
<p><code>purge</code>线程的作用有两个：</p>
<ol>
<li>清理<code>undo</code>页</li>
<li>清除<code>page</code>里面带有<code>Delete_Bit</code>标识的数据行</li>
</ol>
<h2 id="日志小结"><a href="#日志小结" class="headerlink" title="日志小结"></a>日志小结</h2><p><img src="/../../../../../Library/Application%20Support/typora-user-images/image-20221123210859630.png" alt="image-20221123210859630"></p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>锁是多个线程或进程<strong>并发访问</strong>某一资源的机制。为保证数据的<strong>一致性</strong>，需要对并发操作进行控制，因此产生了锁。同时锁机制也为<strong>实现MySQL的各个隔离级别</strong>提供了保证。<strong>锁冲突</strong>也是影响数据库并发访问性能的一个重要因素。</p>
<h3 id="并发事务访问相同记录"><a href="#并发事务访问相同记录" class="headerlink" title="并发事务访问相同记录"></a>并发事务访问相同记录</h3><h4 id="读-读情况"><a href="#读-读情况" class="headerlink" title="读-读情况"></a>读-读情况</h4><p>并发事务相继读取相同的记录。读取操作本身不会对记录有任何影响，并不会出现问题，所以允许这种情况。</p>
<h4 id="写-写情况"><a href="#写-写情况" class="headerlink" title="写-写情况"></a>写-写情况</h4><p>并发事务相继对相同的记录做出改动。</p>
<p>这种情况下会发生脏写的问题。在多个未提交事务相继对一条记录做改动时，需要让他们排队执行，这个排队过程其实是通过锁来实现的。这个锁其实是一个内存中的结构。</p>
<p>当这个事务对这个记录做改动时，首先看内存中有没有与这条记录挂链的锁结构，当没有的时候就会在内存中生成一个锁结构与之关联。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123222646322.png" alt="image-20221123222646322"></p>
<ul>
<li><code>trx</code>信息：代表这个锁结构是哪个事务生成的</li>
<li><code>is_waiting</code>：代表当前事务是否在等待</li>
</ul>
<p><code>T1</code>加锁成功之后，继续执行操作。另外一个事务<code>T2</code>获取锁失败，则等待锁结构释放。并且<code>T2</code>对应的锁结构的<code>is_waiting</code>属性为true</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123222905492.png" alt="image-20221123222905492"></p>
<p>当事务<code>T1</code>提交之后，就会把该事务生成的锁结构释放，然后看看还有没有别的事务在等待锁，发现事务<code>T2</code>在等待获取锁，将事务T2对应的锁结构的<code>is_wating</code>改为<code>false</code>，唤醒事务<code>T2</code>对应的线程，此时<code>T2</code>就算获取到锁。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221123223103358.png" alt="image-20221123223103358"></p>
<h4 id="读-写或写-读情况"><a href="#读-写或写-读情况" class="headerlink" title="读-写或写-读情况"></a>读-写或写-读情况</h4><p>即一个事务进行读取操作，另一个事务进行改动操作。这种情况可能发生脏读、不可重复读、幻读的问题。MySQL在<code>REPEATABLE READ</code>隔离级别上已经解决了幻读问题。</p>
<h4 id="并发问题解决方案"><a href="#并发问题解决方案" class="headerlink" title="并发问题解决方案"></a>并发问题解决方案</h4><ul>
<li><p>方案一：读操作利用多版本并发控制（<code>MVCC</code>），写操作进行加锁</p>
<p><code>MVCC</code>，生成一个<code>ReadView</code>，通过<code>ReadView</code>找到符合条件的记录版本（历史版本由<code>undo</code>日志构建），查询语句只能读到在生成<code>ReadView</code>之前已提交事务所做的更改，生成<code>ReadView</code>之前为提交的事务或者之后才开启的新事务所做的更改是看不到的。而写操作肯定针对的是最新版本的记录，读记录的历史版本和改动记录的最新版本本身并不冲突，也就是采用<code>MVCC</code>时，<strong>读-写操作</strong>并不冲突。</p>
<blockquote>
<p>普通的<code>SELECT</code>语句在<code>READ COMMITED</code>和<code>REPEATABLE READ</code>隔离级别下会使用到<code>MVCC</code>读取记录。</p>
<ul>
<li>在<code>READ COMMITED</code>隔离级别下，一个事务在执行过程中每次执行<code>SELECT</code>操作时都会生成一个<code>ReadView</code>，<code>ReadView</code>的存在保证了事务不可读取到未提交的事务所做的更改，避免了脏读现象；</li>
<li>在<code>REPEATABLE READ</code>隔离级别下，一个事务在执行过程中只有第一次执行<code>SELECT</code>操作才会生成一个<code>ReadView</code>，之后的<code>SELECT</code>操作都复用这个<code>ReadView</code>，避免了不可重复读和幻读的问题；</li>
</ul>
</blockquote>
</li>
<li><p>方案二：读写都加锁</p>
<p>有些业务不允许读取到记录的旧版本，此时就需要加锁。这种情况下，脏读、不可重复读、幻读（幻读加锁会比较麻烦，主要是无法确定新的记录如何加锁）的问题就全部都解决了，事务没有提交时，无法读取或者修改数据。</p>
</li>
</ul>
<p>汇总：</p>
<ul>
<li><p>采用<code>MVCC</code>的话，读-写操作并不冲突，性能更高。</p>
</li>
<li><p>采用加锁方式的话，读-写操作彼此需要排队，影响性能。</p>
</li>
</ul>
<p>一般情况下采用<code>MVCC</code>，业务特殊情况下，采用加锁的方式。</p>
<h3 id="从数据操作的类型划分"><a href="#从数据操作的类型划分" class="headerlink" title="从数据操作的类型划分"></a>从数据操作的类型划分</h3><p>读锁（<code>read lock</code>）、写锁（<code>write lock</code>），也称作共享锁（<code>Shared Lock，S Lock</code>）和排他锁（<code>Exclusive Lock，X Lock</code>）</p>
<ul>
<li>读锁：也称为<strong>共享锁</strong>、英文用<code>S</code>表示。表示同一份数据，多个事务的读操作可以同时进行而不会互相影响，互相不阻塞。</li>
<li>写锁：也称为<strong>排它锁</strong>、英文用<code>X</code>表示。当前写操作没有完成前，它会阻塞其他写锁和读锁，防止其他用户读取正在写入的同一资源。</li>
</ul>
<p>对于<code>InnoDB</code>引擎来说，读锁和写锁可以加在表上，也可以加在行上。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124093251289.png" alt="image-20221124093251289"></p>
<h4 id="锁定读"><a href="#锁定读" class="headerlink" title="锁定读"></a>锁定读</h4><p>采用加锁方式解决脏读、不可重复读、幻读这些问题时，读取一条记录时需要获取该记录的<code>S锁</code>，其实是不严谨的，有时候需要在读取记录时就获取记录的<code>X锁</code>，来禁止别的事务读写该记录，为此MySQL提出了两种比较特殊的<code>SELECT</code>语句格式：</p>
<ul>
<li><p>对读取的记录加<code>S锁</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="comment">-- 或者，在 8.0 中 </span></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> SHARE;</span><br></pre></td></tr></table></figure>

<p>如果当前事务执行该<code>SELECT</code>，会为读取到的记录加<code>S锁</code>，这样允许别的事务继续获取这些记录的<code>S锁</code>（比如别的记录也使用 <code>SELECT ... LOCK IN SHARE LOCK;</code>）。但是不能获取这些记录的X锁，获取<code>X锁</code>的时候会阻塞，直到当前事务提交之后将这些记录的<code>S锁</code>释放掉。</p>
</li>
<li><p>对读取的记录加<code>X锁</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<p>当前事务执行该语句，那么会对读取到的记录加<code>X锁</code>，这样既不允许别的事务获取这些记录的<code>S锁</code>，也不允许获取这些记录的<code>X锁</code>。如果别的事务想要获取这些记录的<code>S锁</code>或者<code>X锁</code>，那么会阻塞，直到当前事务提交之后将这些记录的<code>X锁</code>释放掉。</p>
</li>
</ul>
<p><code>session A</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 加读锁</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employee LOCK <span class="keyword">IN</span> SHARE MODE;</span><br></pre></td></tr></table></figure>

<p><code>session B</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employee; <span class="comment">-- 可获取数据 </span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employee LOCK <span class="keyword">IN</span> SHARE MODE; <span class="comment">-- 可获取数据 </span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employee <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>; <span class="comment">-- 报错</span></span><br><span class="line">ERROR <span class="number">3024</span> (HY000): Query execution was interrupted, maximum statement execution <span class="type">time</span> exceeded</span><br></pre></td></tr></table></figure>

<p>超过了最大执行时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@max</span>_execution_time;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@max</span>_execution_time <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span>                 <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"><span class="comment">-- 在MySQL调优中修改过。全局修改不会对已经连接的会话生效，改成0则是关闭。</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@max</span>_execution_time<span class="operator">=</span><span class="number">60000</span>;</span><br></pre></td></tr></table></figure>

<p><code>session B</code>关闭<code>max_execution_time</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>; <span class="comment">-- 进入阻塞状态</span></span><br></pre></td></tr></table></figure>

<p><code>MySQL 8.0</code>特性：</p>
<p>5.7 及之前版本，<code>SELECT ... FOR UPDATE;</code>如果获取不到锁，会一直等待，直到 <code>innodb_lock_wait_timeout</code>超时。</p>
<p>8.0版本中，<code>SELECT ... FOR SHARE;</code>和 <code>SELECT ... FOR UPDATE;</code>可以添加 <code>NOWAIT</code>、<code>SKIP LOCKED</code>语法，跳过等待，或者跳过锁定，立即返回。</p>
<p>如果查询的行已经加锁：</p>
<ul>
<li><code>NOWAIT</code>会立即返回报错</li>
<li><code>SKIP LOCKED</code>也会立即返回，只是返回的结果中不包含被锁定的行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 报错： Statement aborted because lock(s) could not be acquired immediately and NOWAIT is set.</span></span><br><span class="line"><span class="comment">-- navicate 可能将返回优化，在  SELECT * FROM employee FOR UPDATE nowait; 不会返回报错，而是返回空行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> nowait;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> <span class="keyword">SKIP</span> LOCKED;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h4><p>写操作就直接使用<code>X锁</code>。</p>
<ul>
<li><p><code>DELETE</code>：在<code>B+</code>树中定位到这条记录的位置，然后获取这条记录的<code>X锁</code>，再执行<code>delete mark</code>操作。</p>
</li>
<li><p><code>UPDATE</code>：分三种情况</p>
<ul>
<li><p>情况1：未修改该记录的键值（主键值），并且被更新的列占用的存储空间在修改前后未发生变化。</p>
<p>在B+树中定位到这条记录的位置，然后获取该记录的<code>X锁</code>，然后在原纪录的位置进行修改操作。</p>
</li>
<li><p>情况2：未修改记录的键值（主键值），并且至少有一个被更新的列占用的存储空间在修改前后发生变化。</p>
<p>在B+树中定位到这条记录的位置，然后获取该记录的<code>X锁</code>，将该记录彻底删除掉（把记录移入垃圾链表），最后再插入一条新记录。这个定位待修改记录在<code>B+树</code>中位置的过程看成是一个获取<code>X锁</code>的锁定读，新插入的记录由<code>INSERT</code>提供的<code>隐式锁</code>进行保护。</p>
</li>
<li><p>情况3：修改了该记录的键值（主键值），则相当于在原记录上做<code>DELETE</code>操作之后再来一次<code>INSERT</code>操作，加锁操作就需要按照<code>DELETE</code>和<code>INSERT</code>的规则进行。</p>
</li>
</ul>
</li>
<li><p><code>INSERT</code>：一般情况下，新插入一条记录的操作并不加锁，这一种称之为<code>隐式锁</code>的结构来保护这条新插入的记录在本事务提交之前不会被其他事务访问。</p>
</li>
</ul>
<h3 id="从数据操作的粒度划分：表级锁、页级锁、行锁"><a href="#从数据操作的粒度划分：表级锁、页级锁、行锁" class="headerlink" title="从数据操作的粒度划分：表级锁、页级锁、行锁"></a>从数据操作的粒度划分：表级锁、页级锁、行锁</h3><p>为了提高数据库的并发，每次锁定的数据范围越少越好，这样就产生了锁粒度（<code>Lokc granularity</code>）的概念。</p>
<p>对一条记录加锁只影响这条记录，这个锁的粒度比较细，这个就是<code>行锁</code>。</p>
<p>一个事务在表级别进行加锁，粒度就比较粗，这个就是<code>表锁</code>。</p>
<p>介于行锁和表锁之间，针对一个页进行操作的加锁，就是<code>页锁</code>。</p>
<h4 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h4><p>会锁住整张表，不依赖存储引擎，而且表锁是开销最小的策略，由于一次性将整个格表锁定，也可以很好的避免<code>死锁</code>的问题。锁的粒度大带来的负面影响就是出现锁资源争用的概率最高，导致并发率大打折扣。</p>
<h5 id="表级别的S锁、X锁"><a href="#表级别的S锁、X锁" class="headerlink" title="表级别的S锁、X锁"></a>表级别的<code>S锁</code>、<code>X锁</code></h5><p><code>InnoDB</code>提供<code>行锁</code>，因此使用表级<code>S锁</code>、<code>X锁</code>时，一般不会选择<code>InnoDB</code>，但是<code>InnoDB</code>中也会有表级锁存储，例如元数据锁。在一个事务对表进行增删改查时，如果另外一个会话修改表、删除表操作，会出现阻塞，这个过程其实是通过在<code>server</code>层使用的元数据锁（<code>Metadata Locks</code>，简称<code>MDL</code>）。</p>
<p>另外，在一些特殊情况下，也会使用<code>InnoDB</code>的表级别锁，例如崩溃回复过程。在系统变量<code>autocommit=0,innodb_table_locks=1</code>时，手动获取<code>InnoDB</code>提供的表的<code>S锁</code>或者<code>X锁</code>可以这样写。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES t READ; <span class="comment">-- 对表t加表级别S锁</span></span><br><span class="line">LOCK TABLES t WRITE; <span class="comment">-- 对表t加表级别X锁</span></span><br></pre></td></tr></table></figure>

<p>使用<code>MyISAM</code>使用表锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 MyISAM表 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mylock(</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY auto_increment,</span><br><span class="line">`name` <span class="type">VARCHAR</span>(<span class="number">10</span>)</span><br><span class="line">)ENGINE<span class="operator">=</span>myisam;</span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mylock(`name`) <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">-- 查看表上的锁  </span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES <span class="keyword">WHERE</span> `<span class="keyword">Table</span>` <span class="operator">=</span> <span class="string">&#x27;mylock&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>  <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> mitaka   <span class="operator">|</span> mylock <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"><span class="comment">-- 加读锁  </span></span><br><span class="line">LOCK TABLES mylock READ;</span><br><span class="line"><span class="comment">-- 查看锁</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES <span class="keyword">WHERE</span> `<span class="keyword">Table</span>` <span class="operator">=</span> <span class="string">&#x27;mylock&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>  <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> mitaka   <span class="operator">|</span> mylock <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="comment">-- 加写锁</span></span><br><span class="line">LOCK TABLES mylock WRITE;</span><br><span class="line"><span class="comment">-- 查看锁 </span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES <span class="keyword">WHERE</span> `<span class="keyword">Table</span>` <span class="operator">=</span> <span class="string">&#x27;mylock&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>  <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> mitaka   <span class="operator">|</span> mylock <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------+--------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="comment">-- 释放当前会话持有的锁 </span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<p>对表加<code>读锁</code>之后</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 自己读取，可读</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mylock;</span><br><span class="line"><span class="comment">-- 自己写入，报错 &gt; 1099 - Table &#x27;mylock&#x27; was locked with a READ lock and can&#x27;t be updated</span></span><br><span class="line"><span class="keyword">UPDATE</span> mylock <span class="keyword">SET</span> `name`<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 自己操作其他表，报错  &gt; 1100 - Table &#x27;employee&#x27; was not locked with LOCK TABLES</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 他人可读，可读</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mylock;</span><br><span class="line"><span class="comment">-- 他人可写 ,阻塞  </span></span><br><span class="line"><span class="keyword">UPDATE</span> mylock <span class="keyword">SET</span> `name`<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>对表加<code>写锁</code>之后</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 自己读取，可读</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock;</span><br><span class="line"><span class="comment">-- 自己写入，可写</span></span><br><span class="line"><span class="keyword">UPDATE</span> mylock <span class="keyword">SET</span> `name`<span class="operator">=</span><span class="string">&#x27;a&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 自己操作其他的表，报错 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee LIMIT <span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1100</span> (HY000): <span class="keyword">Table</span> <span class="string">&#x27;employee&#x27;</span> was <span class="keyword">not</span> locked <span class="keyword">with</span> LOCK TABLES</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 他人可读，阻塞 </span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock;</span><br><span class="line"><span class="comment">-- 他人可写，阻塞</span></span><br><span class="line"><span class="keyword">UPDATE</span> mylock <span class="keyword">SET</span> `name`<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<p><code>MyISAM</code>在执行查询语句（<code>SELECT</code>）前，会给涉及的所有表加读锁，执行增删改操作前，会给涉及的表加<code>写锁</code>。<code>InnoDB</code>存储引擎是不会为这个表添加表级别的<code>读锁</code>或者<code>写锁</code>的。</p>
<p>MySQL的表锁有两种模式：</p>
<ul>
<li>表共享<code>读锁</code></li>
<li>表独占<code>写锁</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124115442357.png" alt="image-20221124115442357"></p>
<h5 id="意向锁（intention-lock）"><a href="#意向锁（intention-lock）" class="headerlink" title="意向锁（intention lock）"></a>意向锁（<code>intention lock</code>）</h5><p><code>InnoDB</code>只支持<code>多粗粒度锁（multiple granularity locking）</code>，它允许<code>行级锁</code>与<code>表级锁</code>共存，而<strong>意向锁</strong>就是其中的一种<code>表锁</code>。</p>
<ol>
<li>意向锁的存在是为了协调行锁和表锁的的关系，支持多粗粒度（表锁与行锁）的锁并存</li>
<li>意向锁是一种<code>不予行级锁冲突表级锁</code></li>
<li>表明“某个事务正在某些行吃有了锁或该事务准备去持有锁”</li>
</ol>
<p>意向锁分为两种：</p>
<ul>
<li><p><strong>意向共享锁</strong>（<code>intention shared lock，IS</code>）：事务有意向对表中的某些行加<strong>共享锁</strong>（<code>S锁</code>）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span> <span class="keyword">FROM</span> <span class="keyword">table</span> ... LOCK <span class="keyword">IN</span> SHARE MODE;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>意向排他锁</strong>（<code>intention Exclusi lock，IX</code>）：事务有意向对表中的某些行加<strong>排他锁</strong>（<code>X锁</code>）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span> <span class="keyword">FROM</span> <span class="keyword">table</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>意向锁是由存储引擎自己维护的，用户无法手动操作意向锁，在为数据进行加共享、排他锁之前，<code>InnoDB</code>会先获取<strong>该数据行所在数据表的意向锁。</strong></p>
<p>意向锁要解决的问题：两个事务t1和t2，当t1在某一行上加一个<code>X锁</code>，此时会在这个表上加一个意向锁，当t2在这个表上加<code>X锁</code>时，就会被阻塞。简单来说，就是给更大一级别的空间示意里面是否已经上过锁了。</p>
<p><strong>如果给某一行数据加上了排他锁，数据库会自动给更大一级的空间，比如数据页或者数据表加上意向锁，告诉其他线程这个数据页或者表已经有人上过排它锁了。</strong>这样其他人要获取数据表排他锁时，就无需遍历表，只需要获取这个表的意向排他锁即可。</p>
<ul>
<li>如果事务想要获得数据表中某些记录的共享锁，就需要在数据表上添加意向共享锁。</li>
<li>如果事务想要获得数据表中某些记录的排他锁，就需要在数据表上添加意向排他锁。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 中</span></span><br><span class="line"><span class="comment">-- 获取 隔离级别  ，默认是  REPEATABLE-READ </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 在这一行上加排它锁  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t2 中 </span></span><br><span class="line"><span class="comment">-- 加表读锁，阻塞</span></span><br><span class="line">lock tables employee read;</span><br></pre></td></tr></table></figure>

<p>意向共享锁之间是互相兼容的</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124155836072.png" alt="image-20221124155836072"></p>
<p>但是会与普通的<code>排他</code>、<code>共享锁</code>互斥</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124155941944.png" alt="image-20221124155941944"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 在这一行上加排它锁  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t2 </span></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- 在另外一行上加共享锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">2</span> <span class="keyword">FOR</span> SHARE;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+------------+----------+-----------------+---------+----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> emp_id <span class="operator">|</span> fname <span class="operator">|</span> lname  <span class="operator">|</span> start_date <span class="operator">|</span> end_date <span class="operator">|</span> superior_emp_id <span class="operator">|</span> dept_id <span class="operator">|</span> title          <span class="operator">|</span> assigned_branch_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+------------+----------+-----------------+---------+----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span> Susan <span class="operator">|</span> Barker <span class="operator">|</span> <span class="number">2002</span><span class="number">-09</span><span class="number">-12</span> <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span>               <span class="number">1</span> <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span> Vice President <span class="operator">|</span>                  <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+------------+----------+-----------------+---------+----------------+--------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>但是同一行的时候，就不是意向锁兼容，而是行锁之间互斥。</p>
<h5 id="自增锁（AUTO-INC锁）"><a href="#自增锁（AUTO-INC锁）" class="headerlink" title="自增锁（AUTO-INC锁）"></a>自增锁（AUTO-INC锁）</h5><p>给某个列添加自增属性时，在插入语句时不需要为其赋值，系统会自动为它赋上自增的值。</p>
<p>实际上数据插入有三种模式：</p>
<ul>
<li><code>Simple inserts</code>（简单插入）：<code>insert ... values(),()</code>和 <code>replace</code>语句，已经确定要插入的行数。</li>
<li><code>Bulk inserts</code>（批量插入）：<code>insert ... select</code>,<code>replace ... select</code>和<code>load data</code>语句，不确定插入行数，每一行插入时，为<code>AUTO_INCREMENT</code>列分配一个新值。</li>
<li><code>Mixed-mode inserts</code>（混合模式插入）：<code>insert into xx(id,name) values(1,&#39;a&#39;),(5,&#39;b&#39;)</code>指定了部分id的值，另外一种是 <code>insert ... on duplicate key update</code></li>
</ul>
<p><code>AUTO-INC锁</code>是当想含有<code>AUTO_INCREMENT</code>列的表中插入数据时需要获取的一种特殊的表级锁，插入数据时，在表级别加一个<code>AUTO-INC锁</code>，然后为每条待插入记录<code>AUTO_INCREMENT</code>修饰的列分配递增的值，语句执行结束后释放锁。</p>
<p>一个事务在持有<code>AUTO-INC</code>锁的过程中，其他事务的插入语句都要被阻塞，可以保证一个语句中分配的递增值是连续的。</p>
<p>因此，并发性不高，当向一个有<code>AUTO_INCREMENT</code>关键字的主键插入值的时候，每条语句都要对这个表锁进行竞争。因此<code>InnoDB</code>通过 <code>innodb_autoinc_lock_mode</code>的不同取值来提供不同的锁定机制，来提高SQL语句的可伸缩性和性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%innodb_autoinc_lock_mode%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>0</code>：代表<code>传统锁定</code>模式，也就是上述的竞争方式。</p>
</li>
<li><p><code>1</code>：代表<code>连续锁定</code>模式，MySQL 8.0之前的默认模式，在简单插入的情况下，获取锁，一次性获取所需个数，然后释放锁，再插入。但是其他两种插入情况下还是与模式0一致。性能有部分提高。</p>
</li>
<li><p><code>2</code>：代表<code>交错锁定</code>模式，MySQL 8.0的默认模式，所有<code>INSERT</code>语句都不会使用表级<code>AUTO-INC</code>锁，并且可以同时执行多个语句。但是当使用基于语句的复制或恢复方案时，从二进制日志重播SQL语句时，这是不安全的。</p>
<p>这个模式下，自动递增值保证所有并发执行的<code>insert</code>语句是唯一且单调递增的，但是不一定连续。</p>
</li>
</ul>
<h5 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h5><p>MySQL 5.5引入<code>meta data lock</code>，简称<code>MDL锁</code>，属于锁范畴。MDL的作用是，保证读写的正确性。比如如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个<strong>表结构做变更</strong>，增加一列，那么查询线程拿到的结果就会出问题。</p>
<p><strong>当对一个表做增删改查操作的时候，加MDL读锁；</strong></p>
<p><strong>当对一个表做结构变更曹锁的时候，加MDL写锁；</strong></p>
<p>读锁之间不互斥，因此可以多个线程多一张表同时增删改查。读写锁之间、写锁之间互斥。不需要显式使用，在访问一个表的时候会自动加上。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 加读锁 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t2 加写锁</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t <span class="keyword">add</span> <span class="keyword">column</span> name <span class="type">varchar</span>(<span class="number">10</span>); <span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取状态 </span></span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span>            <span class="operator">|</span> Host             <span class="operator">|</span> db     <span class="operator">|</span> Command <span class="operator">|</span> <span class="type">Time</span>  <span class="operator">|</span> State                           <span class="operator">|</span> Info                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">58358</span> <span class="operator">|</span> mitaka <span class="operator">|</span> Query   <span class="operator">|</span>     <span class="number">8</span> <span class="operator">|</span> Waiting <span class="keyword">for</span> <span class="keyword">table</span> metadata lock <span class="operator">|</span> <span class="keyword">alter</span> <span class="keyword">table</span> t <span class="keyword">add</span> <span class="keyword">column</span> name <span class="type">varchar</span>(<span class="number">10</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">62312</span> <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span> Query   <span class="operator">|</span>     <span class="number">0</span> <span class="operator">|</span> init                            <span class="operator">|</span> <span class="keyword">show</span> processlist                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+-------------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t3 在 t2阻塞时，再增加读锁</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t; <span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span>            <span class="operator">|</span> Host             <span class="operator">|</span> db     <span class="operator">|</span> Command <span class="operator">|</span> <span class="type">Time</span>  <span class="operator">|</span> State                           <span class="operator">|</span> Info                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> event_scheduler <span class="operator">|</span> localhost        <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span> Daemon  <span class="operator">|</span> <span class="number">17112</span> <span class="operator">|</span> Waiting <span class="keyword">on</span> <span class="keyword">empty</span> queue          <span class="operator">|</span> <span class="keyword">NULL</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">58358</span> <span class="operator">|</span> mitaka <span class="operator">|</span> Query   <span class="operator">|</span>    <span class="number">36</span> <span class="operator">|</span> Waiting <span class="keyword">for</span> <span class="keyword">table</span> metadata lock <span class="operator">|</span> <span class="keyword">alter</span> <span class="keyword">table</span> t <span class="keyword">add</span> <span class="keyword">column</span> name1 <span class="type">varchar</span>(<span class="number">10</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">62312</span> <span class="operator">|</span> mitaka <span class="operator">|</span> Query   <span class="operator">|</span>    <span class="number">19</span> <span class="operator">|</span> Waiting <span class="keyword">for</span> <span class="keyword">table</span> metadata lock <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">62814</span> <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span> Query   <span class="operator">|</span>     <span class="number">0</span> <span class="operator">|</span> init                            <span class="operator">|</span> <span class="keyword">show</span> processlist                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+------------------+--------+---------+-------+---------------------------------+--------------------------------------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>也就是说，元数据锁可能带来的问题</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124163809373.png" alt="image-20221124163809373"></p>
<h4 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h4><p>行锁（<code>Row Lock</code>）也称为记录锁，也就是锁住某一行（某条记录<code>row</code>）。MySQL服务器层并没有实现锁机制，<strong>行级锁只在存储引擎层实现</strong>。</p>
<p><strong>优点</strong>：锁定力度小，发生<code>锁冲突概率低</code>，可以实现的<code>并发度高</code>。</p>
<p><strong>缺点</strong>：对于<code>锁的开销比较大</code>，加锁会比较慢，容易出现<code>死锁</code>情况。</p>
<p><code>InnoDB</code>与<code>MyISAM</code>的最大不同有两点：一是<strong>支持事务</strong>，而是<strong>采用行级锁</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>),(<span class="number">8</span>,<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>),(<span class="number">15</span>,<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>),(<span class="number">20</span>,<span class="string">&#x27;钱七&#x27;</span>,<span class="string">&#x27;三班&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 李四   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> 王五   <span class="operator">|</span> 二班   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span> 赵六   <span class="operator">|</span> 二班   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> 钱七   <span class="operator">|</span> 三班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>简化聚簇索引示意图</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124164354310.png" alt="image-20221124164354310"></p>
<h5 id="记录锁（Record-Locks）"><a href="#记录锁（Record-Locks）" class="headerlink" title="记录锁（Record Locks）"></a>记录锁（Record Locks）</h5><p>记录锁也就是仅仅把一条记录锁上，官方的类型名称为：<code>Lock_REC_NOT_GAP</code>。例如把id值为8的那条记录加一个记录锁的示意图如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124164630676.png" alt="image-20221124164630676"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 给这列增加x锁 </span></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;张三1&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t2</span></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 同时增加x锁</span></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;张三2&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line"><span class="comment">-- 或者增加s锁</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> share;</span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line"><span class="comment">-- 在其他的行上加s锁</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">3</span> <span class="keyword">for</span> share;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 李四   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>记录锁也有S锁和X锁，称之为<code>S型记录锁</code>和<code>X型记录锁</code>。</p>
<ul>
<li>当一个事务获取了一条记录的S型记录锁后，其他事务也可以继续获取该记录的S型记录锁，但不可以继续获取X型记录锁；</li>
<li>当一个事务获取了一条记录的X型记录锁后，其他事务既不可以获取该记录的S型记录锁，也不可以继续获取X型记录锁；</li>
</ul>
<h5 id="间隙锁（Gap-Locks）"><a href="#间隙锁（Gap-Locks）" class="headerlink" title="间隙锁（Gap Locks）"></a>间隙锁（Gap Locks）</h5><p><code>MySQL</code>在<code>REPEATABLE READ</code>隔离级别下是可以解决幻读问题的，解决方案有两种，一种是MVCC，另外一种是加锁。但是加锁方案有个问题，就是事务在第一次执行读取操作时，那些幻影上尚不存在（幻读：事务中第一次读取有5条记录，第二次读取有10条），无法给这些幻影记录加上记录锁。</p>
<p>InnoDB提出的一种称之为<code>Gap Locks</code>的锁，官方类型名称<code>LOCK_GAP</code>，可以简称<code>gap锁</code>。比如把值id为8的那条记录加一个<code>gap锁</code>的示意图：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124170709408.png" alt="image-20221124170709408"></p>
<p>意味着：<strong>不允许别的事务在id值为8的记录前面的间隙插入新记录</strong>（<code>3和8之间</code>）。</p>
<p><strong>gap锁的提出仅仅是为了防止插入幻影记录而提出的</strong>，<code>共享gap锁</code>和<code>独占gap锁</code>的作用一样的，对一条记录加了<code>gap锁</code>，并不会限制其他事务对这条记录加<code>记录锁</code>或者继续加<code>gap锁</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 对于不存在的数据</span></span><br><span class="line"><span class="comment">-- t1 中</span></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2 中</span></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">10</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span> <span class="keyword">for</span> share;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>间隙锁可以重复添加，并且与记录锁兼容。</p>
<p>实际作用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t3 阻塞</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 状态</span></span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">|</span> <span class="number">17</span> <span class="operator">|</span> root            <span class="operator">|</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">62312</span> <span class="operator">|</span> dbtest2 <span class="operator">|</span> Query   <span class="operator">|</span>    <span class="number">14</span> <span class="operator">|</span> <span class="keyword">update</span>                 <span class="operator">|</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>)     <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在id=5的地方加间隙锁，实际上是范围（3,8），以下都会锁住</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>间隙锁范围：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">200</span> <span class="keyword">for</span> share;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">199</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">200</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line">ERROR <span class="number">1317</span> (<span class="number">70100</span>): Query execution was interrupted</span><br><span class="line"><span class="comment">-- 执行成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">201</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p>查看间隙锁信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">1367</span>:<span class="number">281473433260976</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">562948481699032</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">374</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433260976</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span>               <span class="comment">-- 表锁</span></span><br><span class="line">            LOCK_MODE: <span class="keyword">IS</span>									 <span class="comment">-- 意向共享锁</span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">2</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">562948481699032</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">374</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD            <span class="comment">-- 记录锁</span></span><br><span class="line">            LOCK_MODE: S,REC_NOT_GAP		 <span class="comment">-- 共享锁，间隙锁</span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">200</span>							 <span class="comment">-- 间隙锁的数据</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p>间隙锁可能导致的死锁，t1和t2都有间隙锁，然后插入对方事务中间隙锁的范围</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span> <span class="keyword">for</span> share;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span> <span class="keyword">for</span> share;</span><br></pre></td></tr></table></figure>

<p>然后相互插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">9</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>); <span class="comment">-- 阻塞</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying <span class="keyword">to</span> <span class="keyword">get</span> lock; try restarting transaction <span class="comment">-- t2 检测到死锁，MySQL会选择一个成本最低的事务进行回滚</span></span><br><span class="line"><span class="comment">-- t2事务重启之后，t1退出阻塞</span></span><br></pre></td></tr></table></figure>

<h5 id="临建锁（Next-Key-Locks）"><a href="#临建锁（Next-Key-Locks）" class="headerlink" title="临建锁（Next-Key Locks）"></a>临建锁（Next-Key Locks）</h5><p>有时候既想<strong>锁住某条记录</strong>，有想<strong>阻止其他事务在该记录前边的间隙插入新记录</strong>，所以<code>InnoDB</code>提出<code>Next-Key Locks</code>的锁，官方的类型名称为：<code>LOCK_ORDINARY</code>，简称为<code>next-key</code>锁（间隙锁+记录锁）。<code>Next—Key Locks</code>是在存储引擎<code>InnoDB</code>、事务级别在<code>可重复读</code>的情况下使用的数据库锁，InnoDB默认的锁就是<code>Next-Key locks</code>。比如，把id为8的那条记录加一个next-key锁的示意图如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124204516590.png" alt="image-20221124204516590"></p>
<p><code>next-key锁</code>的本质就是一个<code>记录锁</code>和一个<code>gap锁</code>的合体，既能保护该条记录，又能阻止别的事务将新记录插入被保护记录前边的间隙。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 中 </span></span><br><span class="line"><span class="comment">-- 开启事务 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 在 3-8之间用间隙锁，id=8的记录用X锁</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&lt;=</span> <span class="number">8</span> <span class="keyword">and</span> id <span class="operator">&gt;</span> <span class="number">3</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> 王五   <span class="operator">|</span> 二班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2 中 </span></span><br><span class="line"><span class="comment">-- 开启事务  </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">8</span> <span class="keyword">for</span> share; <span class="comment">--阻塞</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">8</span> <span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment">-- 阻塞</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>); <span class="comment">-- 阻塞  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 锁状态</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">1367</span>:<span class="number">281473433267192</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015556</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">283</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433267192</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: IX										<span class="comment">-- 表级别，意向排他锁 </span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">1367</span>:<span class="number">281473433267104</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015556</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">282</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433267104</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: <span class="keyword">IS</span>										<span class="comment">-- 表级别，意向共享锁 </span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">4</span>:<span class="number">281473433265224</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015556</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">285</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433265224</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X,GAP,INSERT_INTENTION		<span class="comment">-- 记录级别，排它锁，间隙锁，插入意向锁</span></span><br><span class="line">          LOCK_STATUS: WAITING</span><br><span class="line">            LOCK_DATA: <span class="number">8</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">1367</span>:<span class="number">281473433260976</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015555</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">418</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433260976</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: IX											<span class="comment">-- 表级别排它锁 </span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">4</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015555</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">418</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X									<span class="comment">-- 记录级别排他锁</span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">8</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="插入意向锁（Insert-Intention-Locks）"><a href="#插入意向锁（Insert-Intention-Locks）" class="headerlink" title="插入意向锁（Insert Intention Locks）"></a>插入意向锁（<code>Insert Intention Locks</code>）</h5><p>事务在插入一条记录时需要判断一下插入位置是不是被别的事务加了<code>gap锁</code>（<code>next-key锁</code>也包含<code>gap锁</code>），如果有的话，插入操作需要等待，直到拥有<code>gap锁</code>的那个事务提交。<strong>但是InnoDB规定事务在等待的时候也需要在内存中生成一个锁结构</strong>，这个锁就是<code>Insert Intention Locks</code>，官方的类型名称为：<code>LOCK_INSERT_INTENTION</code>，称之为插入意向锁。插入意向锁时一种<code>Gap锁</code>，不是<code>意向锁</code>，在<code>insert</code>操作时产生。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上例中的 插入操作</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>); <span class="comment">-- 阻塞  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 锁状态</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">4</span>:<span class="number">281473433265224</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015556</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">285</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433265224</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X,GAP,INSERT_INTENTION		<span class="comment">-- 记录级别，排它锁，间隙锁，插入意向锁</span></span><br><span class="line">          LOCK_STATUS: WAITING</span><br><span class="line">            LOCK_DATA: <span class="number">8</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>插入意向锁</code>是一种特殊的<code>间隙锁</code>–<code>间隙锁</code>可以锁定开区间内的部分记录。</p>
</li>
<li><p><code>插入意向锁</code>之间互不排斥，只要记录本身（主键、唯一索引）不冲突，那么事务之间就不会出现冲突等待。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&lt;=</span> <span class="number">8</span> <span class="keyword">and</span> id <span class="operator">&gt;</span> <span class="number">3</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2 </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t3</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(id,name,class) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;一班&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t1 commit 之后，t2退出阻塞状态，t2 commit 之后，t3退出阻塞状态，说明插入意向锁是行锁，会相互冲突。</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>插入意向锁不是意向锁，意向锁是表锁，插入意向锁是行锁。</p>
<h4 id="页锁"><a href="#页锁" class="headerlink" title="页锁"></a>页锁</h4><p>页锁就是在页的粒度上进行锁定，锁定的数据资源比行锁要多，因为一页中可以有多个行记录。页锁的开销介于表锁和行锁之间，会出现死锁。锁定粒度介于表锁和行锁之间，并发度一般。</p>
<p>每一个层级的锁数量是有限的，因为锁会占用内存空间，锁空间的大小是有限的，当某个层级的锁数量超过了这个层级的阈值时，就会自动进行<code>锁升级</code>。</p>
<h3 id="从对待锁的态度划分：乐观锁、悲观锁"><a href="#从对待锁的态度划分：乐观锁、悲观锁" class="headerlink" title="从对待锁的态度划分：乐观锁、悲观锁"></a>从对待锁的态度划分：乐观锁、悲观锁</h3><p>需要注意的是，乐观锁和悲观锁并不是锁，而是锁的设计思想。</p>
<h4 id="悲观锁（Pessimistic-Locking）"><a href="#悲观锁（Pessimistic-Locking）" class="headerlink" title="悲观锁（Pessimistic Locking）"></a>悲观锁（Pessimistic Locking）</h4><p>悲观锁是一种思想，很悲观，对数据被其他事务的修改持保守态度，会通过数据库自身的锁机制来实现，从而保证数据操作的排他性。</p>
<p>悲观锁总是假设最坏的情况，每次拿数据的时候都认为别人会修改，所以每次拿数据的时候都会上锁，这样别人拿这个数据就会阻塞，直到它拿到锁（共享资源每次只给一个线程使用，其他线程阻塞，用完后再把资源转让给其他线程）。比如行锁、表锁、读锁、写锁等，都是在操作之前先上锁，当其他线程想要访问数据时，都需要阻塞挂起。</p>
<p><code>select ... for update</code>是MySQL中的悲观锁。需要注意，<strong>这个语句执行过程中所有扫描的行都会被锁上，因此在MySQL中使用悲观锁必须确定使用了索引，而不是全表扫描，否则将会把整个表锁住。</strong></p>
<p>悲观锁大多数情况下依靠数据库的锁机制来实现，以保证程序的并发访问性，这样对数据库性能开销影响很大，特别是长事务而言，这样的开销往往无法承受，这个时候就需要乐观锁。</p>
<h4 id="乐观锁（Optimistic-Locking）"><a href="#乐观锁（Optimistic-Locking）" class="headerlink" title="乐观锁（Optimistic Locking）"></a>乐观锁（<code>Optimistic Locking</code>）</h4><p>乐观锁认为对统一数据的并发操作不会总发生，属于小概率事件，不用每次都对数据上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，也就是<strong>不采用数据库自身的锁机制，而是通过程序来实现。</strong>一般采用<code>版本号控制</code>或者<code>CAS机制</code>。乐观锁适用于多度的应用类型，这样可以提高吞吐量。</p>
<h5 id="乐观锁的版本号机制"><a href="#乐观锁的版本号机制" class="headerlink" title="乐观锁的版本号机制"></a>乐观锁的版本号机制</h5><p>在表中设计一个<code>版本字段 version</code>，第一次读的时候记录<code>version</code>的值，然后对数据<code>更新或删除</code>操作时，会通过<code>version</code>作为<code>where</code>条件并且将<code>version+1</code>，如果已经有事务对这条数据进行了修改，修改就不会成功。</p>
<h5 id="乐观锁的时间戳机制"><a href="#乐观锁的时间戳机制" class="headerlink" title="乐观锁的时间戳机制"></a>乐观锁的时间戳机制</h5><p>时间戳和版本号一样，也是在更新提交的时候，将当前数据的时间戳和更新之前取得的时间戳进行比较，如果两者一致则更新成功，否则就是版本冲突。</p>
<p>注意：如果数据表时<strong>读写分离</strong>的表，当<code>master</code>表中写入的数据没有及时同步到<code>slave</code>表中时，会造成更新一致失效的问题。此时需要<code>强制读取master表</code>中的数据。（将<code>select</code>语句放到事务中即可，这时候查询的就是<code>master</code>主库）</p>
<h5 id="两种锁的适用场景"><a href="#两种锁的适用场景" class="headerlink" title="两种锁的适用场景"></a>两种锁的适用场景</h5><ol>
<li>乐观锁：适合读操作多的场景，相对来说写的操作比较少。优点在于程序实现，不存在死锁问题、</li>
<li>悲观锁：适合写操作多的场景，因为写的操作具有排他性。采用悲观锁的方式，可以在数据库层面阻止其他事务对该数据的操作权限，防止 读-写 和 写-写 的冲突</li>
</ol>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124212206988.png" alt="image-20221124212206988"></p>
<h3 id="按照加锁的方式划分：显式锁、隐式锁"><a href="#按照加锁的方式划分：显式锁、隐式锁" class="headerlink" title="按照加锁的方式划分：显式锁、隐式锁"></a>按照加锁的方式划分：显式锁、隐式锁</h3><h4 id="隐式锁"><a href="#隐式锁" class="headerlink" title="隐式锁"></a>隐式锁</h4><p>一个事务执行<code>INSERT</code>操作时，如果即将插入的间隙已经被其他事务加了<code>gap锁</code>，那么本次<code>insert</code>操作会阻塞，并且当前事务会在该间隙上加一个<code>插入意向锁</code>，否则一般情况下<code>insert</code>操作是不加锁的。</p>
<p>如果一个事务对一条记录（此时并没有在内存生产与该记录关联的锁结构），然后另一个事务：</p>
<ul>
<li><p>立即使用 <code>select ... for share</code>语句读取这条记录，也就是获取这条记录的S锁，或者使用 <code>select ... for update</code>语句读取这条记录，也就是获取这条记录的X锁。</p>
<p>如果允许，则可能产生脏读问题。</p>
</li>
<li><p>立即修改这条记录，也就是获取这条记录的X锁。</p>
<p>如果允许，则可能产生脏写问题。</p>
</li>
</ul>
<p>这个时候，就需要使用到事务id。聚簇索引和二级索引中的记录分开来看：</p>
<ul>
<li><p>情景一：使用聚簇索引，记录中有一个<code>trx_id</code>隐藏列，记录着最后改动该记录的<code>事务id</code>，在当前事务新插入一条聚簇索引记录后，该记录的<code>trx_id</code>隐藏列代表的就是当前事务的<code>事务id</code>，如果其他事务此时想对该记录添加<code>S锁</code>或者<code>X锁</code>时，首先会看一下该记录的<code>trx_id</code>隐藏列代表的事务是否是当前的活跃事务，如果是，则帮助当前事务创建一个X锁（也就是为当前事务创建一个锁结构，<code>is_waiting</code>属性是<code>false</code>，代表这个事务是活跃的），然后自己进入等待状态（也就是为自己也创建一个锁结构，<code>is_waiting</code>属性是<code>true</code>）</p>
</li>
<li><p>情景二：对于二级索引来说，本身并没有<code>trx_id</code>隐藏列，但是在二级索引<strong>页面</strong>的<code>Page Header</code>部分有一个<code>PAGE_MAX_TRX_ID</code>属性，该属性代表对该页面做改动的<code>最大的事务id</code>，如果<code>PAGE_MAX_TRX_ID</code>属性值小于当前最小的活跃<code>事务id</code>，那么说明对该页面做修改的事务都已经提交了，否则就需要在页面中定位到对应的二级索引记录，然后回表知道它对应的聚簇索引记录，然后再重复<code>情景一</code>的做法。</p>
</li>
</ul>
<p>即：一个事务对新插入的记录可以不显式的加锁（生成一个锁结构），但是由于<code>事务id</code>的存在，相当于加了一个隐式锁。别的事务在对这条记录<code>加S锁</code>或者<code>X锁</code>时，由于<code>隐式锁</code>的存在，会帮助当前事务生成一个锁结构，然后自己再生产一个锁结构后进入等待状态，隐式锁时一种<code>延迟加锁</code>的机制，从而来<code>减少加锁的数量</code>。</p>
<p>隐式锁在实际内存对象中并不含有这个锁信息。<strong>只有当产生锁等待时，隐式锁转化为显式锁</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t1 </span></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 有一个 写入 操作</span></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;张三11&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t3 获取锁信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `performance_schema`.data_lock_waits\G</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t2</span></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="comment">-- 使用 S锁 </span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">for</span> share; <span class="comment">-- 阻塞 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- t3 获取锁信息，看到隐式锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `performance_schema`.data_lock_waits\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                          ENGINE: INNODB</span><br><span class="line">       REQUESTING_ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433264192</span></span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: <span class="number">562948481699840</span></span><br><span class="line">            REQUESTING_THREAD_ID: <span class="number">49</span></span><br><span class="line">             REQUESTING_EVENT_ID: <span class="number">296</span></span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: <span class="number">281473433264192</span></span><br><span class="line">         BLOCKING_ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433257984</span></span><br><span class="line">  BLOCKING_ENGINE_TRANSACTION_ID: <span class="number">2015566</span></span><br><span class="line">              BLOCKING_THREAD_ID: <span class="number">48</span></span><br><span class="line">               BLOCKING_EVENT_ID: <span class="number">431</span></span><br><span class="line">  BLOCKING_OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>隐式锁逻辑如下：</p>
<ol>
<li>InnoDB的每条记录中都有一个隐藏的<code>trx_id</code>字段，存在于聚簇索引的<code>B+Tree</code>中</li>
<li>操作一条记录前，首先根据记录中的<code>trx_id</code>检查该事务是否是活动的事务（未提交或回滚）。如果是活动的事务，首先将隐式锁转换为显式锁（就是为该事务添加一个锁）</li>
<li>检查是否有锁冲突，如果有冲突，创建锁，设置为waiting状态。如果没有冲突，不加锁到5；</li>
<li>等待加锁成功，被唤醒，或者超时</li>
<li>写数据，并将自己的<code>trx_id</code>写入<code>trx_id</code>字段</li>
</ol>
<h4 id="显式锁"><a href="#显式锁" class="headerlink" title="显式锁"></a>显式锁</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ... lock <span class="keyword">in</span> share mode;</span><br><span class="line"><span class="keyword">select</span> ... <span class="keyword">for</span> share;</span><br><span class="line"><span class="keyword">select</span> ... <span class="keyword">for</span> <span class="keyword">update</span> </span><br></pre></td></tr></table></figure>

<h3 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h3><p>全局锁就是对<code>整个数据库</code>实例加锁。当需要让整个数据库处于只读状态，可以使用这个命令，增删改语句、DML和更新类事务会阻塞，只能读取。使用场景例如<strong>全库逻辑备份</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLush tables with read lock;</span><br></pre></td></tr></table></figure>

<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>死锁是指两个或多个事务在同一资源上相互占用，并请求锁定对方占用的资源，并且双方都不会释放自己的锁，从而导致恶性循环。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124221958830.png" alt="image-20221124221958830"></p>
<h4 id="产生死锁的必要条件"><a href="#产生死锁的必要条件" class="headerlink" title="产生死锁的必要条件"></a>产生死锁的必要条件</h4><ol>
<li>两个或者两个以上事务</li>
<li>每个事务都已经持有锁并且申请新的锁</li>
<li>锁资源同时只能被同一个事务持有或者不兼容</li>
<li>事务之间因为持有锁和申请锁导致彼此循环等待</li>
</ol>
<p>死锁的关键在于：两个（或以上）的Session加锁的顺序不一致。</p>
<h4 id="死锁的解决方案"><a href="#死锁的解决方案" class="headerlink" title="死锁的解决方案"></a>死锁的解决方案</h4><ul>
<li><p>方式1：等待，直到超时（<code>innodb_lock_wait_timeout=50s</code>），超时之后，自动回滚，另外一个事务继续运行。这个方式比较被动，而且影响本事务。</p>
</li>
<li><p>方式2：使用死锁检测进行死锁处理，通过<code>wait-for graph算法</code>来主动进行死锁检测，每当锁请求无法立即满足需要并进入等待时，<code>wait-for graph算法</code>都会被触发。</p>
<p>这是一种较为 <code>主动的死锁检测机制</code>，要求数据库保存 <code>锁的信息链表</code>和 <code>事务等待链表</code>两部分信息。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124222511565.png" alt="image-20221124222511565"></p>
</li>
</ul>
<p>基于这两个信息，可以绘制 <code>wait-for graph</code> 等待图 </p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124222545821.png" alt="image-20221124222545821"></p>
<p>死锁检测的原理是构建一个以事物为顶点、锁为边的有向图，判断有向图是否存在换，存在即有死锁。</p>
<p>一旦检测到回路、有死锁，这时候InnoDB存储引擎会选择回滚 <code>undo 量最小的事务</code>，让其他事务继续执行。（<code>innodb_deadlock_detect=on</code>表示开启这个逻辑，默认开启）</p>
<p>缺点：每个的被阻塞的线程都要判断自己是否进入死锁，这个操作的时间复杂度是o(n)，如果100个并发线程同时更新同一行，则要检测100 * 100 &#x3D; 1万次。</p>
<p>解决方法：</p>
<ol>
<li>关闭死锁检测，但是可能导致大量的超时，影响业务。</li>
<li>控制并发访问的数量，比如中间件中实现对于相同行的更新，在进入引擎之前排队，这样InnoDB内部就不会有大量的死锁检测工作。</li>
</ol>
<p>进一步思路：可以考虑通过将一行改成逻辑上的多行来减少锁冲突。比如一次性获取100个数，每100更新次更新数据库1次。</p>
<h4 id="避免死锁"><a href="#避免死锁" class="headerlink" title="避免死锁"></a>避免死锁</h4><ul>
<li>合理设计索引，使SQL尽可能通过索引定位更少的行，减少锁竞争。</li>
<li>调整业务逻辑SQL执行顺序，避免update、delete长时间持有锁的SQL在事务前面</li>
<li>避免大失误，尽量将大事务拆成多个小事务来处理，通过减少事务的时间来降低死锁概率</li>
<li>高并发系统中，不要显式加锁，特使是在事务里显式加锁。</li>
<li>降低隔离级别。如果业务允许，将隔离级别从<code>RR</code>调整为<code>RC</code>，可以避免很多因为<code>gap锁</code>造成的死锁。</li>
</ul>
<h2 id="锁的内存结构"><a href="#锁的内存结构" class="headerlink" title="锁的内存结构"></a>锁的内存结构</h2><p>对于<code>锁结构</code>中对应的记录数不是越多越好，也不是越少越好。符合下边这些条件的记录会放到一个<code>锁结构</code>中</p>
<ul>
<li>在同一个事务中进行加锁操作</li>
<li>被加锁的记录在同一个页面中</li>
<li>加锁的类型是一样的</li>
<li>等待状态是一样的</li>
</ul>
<p><code>InnoDB</code>存储引擎中的<code>锁结构</code>如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124223838600.png" alt="image-20221124223838600"></p>
<ul>
<li><ol>
<li>锁所在的事务信息：</li>
</ol>
<p>不管表锁还是行锁，都是在事务执行过程中生成的，哪个事务生成了这个锁结构，这里就记录这个事务的信息。</p>
<p>次锁所在的事务信息，在内存结构中只是一个指针，通过指针可以找到内存中关于该事务的更多信息，比方说事务id等。</p>
</li>
<li><ol start="2">
<li>索引信息：</li>
</ol>
<p>对于行锁来说，需要记录一下加锁的记录时属于哪个索引的，这个也是一个指针</p>
</li>
<li><ol start="3">
<li>表锁、行锁信息</li>
</ol>
<p>表锁结构和行锁结构在这个位置内容不同：</p>
<ul>
<li><p>表锁：</p>
<p>记录对哪个表加的锁，还有一些其他信息</p>
</li>
<li><p>行锁：</p>
<p>记录三个重要信息：</p>
<ul>
<li><code>Space ID</code>：记录所在表空间</li>
<li><code>Page Number</code>：记录所在页号</li>
<li><code>n_bits</code>：对于行锁来说，一条记录就对应着一个比特位，一个页面中包含了很多记录，用不同的比特位来区分到底是哪一条记录加了锁。为此在行锁结构的末尾放置了一堆比特位，这个<code>n_bits</code>属性代表使用了多少比特位。</li>
</ul>
</li>
</ul>
</li>
<li><ol start="4">
<li><p><code>type_mode</code></p>
<p>32位的数，被分成了<code>lock_mode</code>、<code>lock_type</code>和<code>rec_lock_type</code>三个部分</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221124224534753.png" alt="image-20221124224534753"></p>
<ul>
<li>锁的模式：例如共享意向锁、独占意向锁、共享锁、独占锁、自增锁</li>
<li>锁的类型：表级锁还是行级锁，</li>
<li>行锁的具体类型：例如是间隙锁、临建锁或者记录锁，第9位放置<code>is_waiting</code></li>
</ul>
</li>
</ol>
</li>
<li><ol start="5">
<li>其他信息：各种哈希表和链表</li>
</ol>
</li>
<li><ol start="6">
<li>一堆比特位</li>
</ol>
</li>
</ul>
<h2 id="锁监控"><a href="#锁监控" class="headerlink" title="锁监控"></a>锁监控</h2><p>获取锁信息：<code>SHOW STATUS LIKE &#39;%innodb_row_lock%&#39;;</code></p>
<p>获取使用过的锁：<code>SELECT * FROM performance_schema.data_locks;</code></p>
<p>获取当前等待的锁：<code>SELECT * FROM performance_schema.data_lock_waits;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取锁信息</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%innodb_row_lock%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_current_waits <span class="operator">|</span> <span class="number">0</span>      <span class="operator">|</span>	<span class="comment">-- 当前正在等待锁的数量</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time          <span class="operator">|</span> <span class="number">466658</span> <span class="operator">|</span>	<span class="comment">-- 系统启动到现在锁等待的总时长 **</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_avg      <span class="operator">|</span> <span class="number">16091</span>  <span class="operator">|</span>	<span class="comment">-- 平均锁定时长 ***</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_max      <span class="operator">|</span> <span class="number">50114</span>  <span class="operator">|</span>	<span class="comment">-- 锁等待最多时长</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_waits         <span class="operator">|</span> <span class="number">29</span>     <span class="operator">|</span>	<span class="comment">-- 锁等待的总次数 ***</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+--------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取锁信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                    trx_id: <span class="number">2015570</span>									<span class="comment">-- 事务id</span></span><br><span class="line">                 trx_state: LOCK WAIT								<span class="comment">-- 锁状态等待 </span></span><br><span class="line">               trx_started: <span class="number">2022</span><span class="number">-11</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">09</span></span><br><span class="line">     trx_requested_lock_id: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433264192</span></span><br><span class="line">          trx_wait_started: <span class="number">2022</span><span class="number">-11</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">09</span></span><br><span class="line">                trx_weight: <span class="number">2</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">9</span></span><br><span class="line">                 trx_query: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">for</span> <span class="keyword">update</span>		<span class="comment">-- 等待的SQL语句 </span></span><br><span class="line">       trx_operation_state: starting index read</span><br><span class="line">         trx_tables_in_use: <span class="number">1</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">2</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1128</span></span><br><span class="line">           trx_rows_locked: <span class="number">1</span> 						<span class="comment">-- 锁定行数 </span></span><br><span class="line">         trx_rows_modified: <span class="number">0</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: REPEATABLE READ</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="keyword">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br><span class="line">       trx_schedule_weight: <span class="number">1</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                    trx_id: <span class="number">2015569</span></span><br><span class="line">                 trx_state: <span class="keyword">RUNNING</span></span><br><span class="line">               trx_started: <span class="number">2022</span><span class="number">-11</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">56</span>:<span class="number">01</span></span><br><span class="line">     trx_requested_lock_id: <span class="keyword">NULL</span></span><br><span class="line">          trx_wait_started: <span class="keyword">NULL</span></span><br><span class="line">                trx_weight: <span class="number">2</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">8</span></span><br><span class="line">                 trx_query: <span class="keyword">NULL</span></span><br><span class="line">       trx_operation_state: <span class="keyword">NULL</span></span><br><span class="line">         trx_tables_in_use: <span class="number">0</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">2</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1128</span></span><br><span class="line">           trx_rows_locked: <span class="number">6</span></span><br><span class="line">         trx_rows_modified: <span class="number">0</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: REPEATABLE READ</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="keyword">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br><span class="line">       trx_schedule_weight: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL 5.7 之前，查看事务的锁情况，但只能看到阻塞事务的锁，如果事务没有被阻塞，就看不到 ，8.0更换 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.INNODB_LOCK;</span><br><span class="line"><span class="comment">-- MySQL 8.0 替代的表  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_locks\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">1367</span>:<span class="number">281473433267104</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015570</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">301</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433267104</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: IX</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433264536</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015570</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">302</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433264536</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: WAITING</span><br><span class="line">            LOCK_DATA: <span class="number">1</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">1367</span>:<span class="number">281473433260976</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433260976</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: IX</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">1</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: supremum pseudo<span class="operator">-</span>record</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">3</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">3</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">6.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">4</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">8</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">7.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">5</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">15</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">8.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">6</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">20</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">9.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433257984</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">            THREAD_ID: <span class="number">48</span></span><br><span class="line">             EVENT_ID: <span class="number">435</span></span><br><span class="line">        OBJECT_SCHEMA: dbtest2</span><br><span class="line">          OBJECT_NAME: student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">1</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_lock_waits\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                          ENGINE: INNODB</span><br><span class="line">       REQUESTING_ENGINE_LOCK_ID: <span class="number">281473504989184</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433264880</span></span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: <span class="number">2015570</span></span><br><span class="line">            REQUESTING_THREAD_ID: <span class="number">49</span></span><br><span class="line">             REQUESTING_EVENT_ID: <span class="number">303</span></span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: <span class="number">281473433264880</span></span><br><span class="line">         BLOCKING_ENGINE_LOCK_ID: <span class="number">281473504988376</span>:<span class="number">299</span>:<span class="number">4</span>:<span class="number">12</span>:<span class="number">281473433257984</span></span><br><span class="line">  BLOCKING_ENGINE_TRANSACTION_ID: <span class="number">2015569</span></span><br><span class="line">              BLOCKING_THREAD_ID: <span class="number">48</span></span><br><span class="line">               BLOCKING_EVENT_ID: <span class="number">435</span></span><br><span class="line">  BLOCKING_OBJECT_INSTANCE_BEGIN: <span class="number">281473433257984</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="MVCC-多版本并发控制"><a href="#MVCC-多版本并发控制" class="headerlink" title="MVCC 多版本并发控制"></a>MVCC 多版本并发控制</h2><p>为了解决脏读、不可重复读、幻读的问题，除了加锁，还可以通过MVCC的方案，而且并发性比加锁更好。</p>
<p>MVCC时通过数据行的多个版本管理来实现数据库的并发控制。使得<code>InnoDB</code>（MySQL中只有<code>InnoDB</code>引擎支持）的事务隔离级别下执行一致性读操作有了保证。换言之，就是为了查询一些正在被另一个事务更新的行，并且可以看到它们<code>被更新之前的值</code>，这样在做查询的时候就不用等待另一个事务释放锁。</p>
<h3 id="快照读与当前读"><a href="#快照读与当前读" class="headerlink" title="快照读与当前读"></a>快照读与当前读</h3><p>MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理 <code>读-写</code> 冲突，做到即使有读写冲突时，也能做到不<code>加锁</code>，<code>非阻塞并发读</code>，这个读就是<strong>快照读</strong>。<code>当前读实际上是一种加锁的控制，是悲观锁的实现</code>，<code>MVCC的本质是基于采用乐观锁思想的一种方式</code>。</p>
<h4 id="快照读"><a href="#快照读" class="headerlink" title="快照读"></a>快照读</h4><p>不加锁的简单的 SELECT 都属于快照读</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> ...</span><br></pre></td></tr></table></figure>

<p>MVCC在很多情况下，避免加锁操作，降低了开销。</p>
<p>快照读到的并不一定是数据的最新版本，而有可能是之前的历史版本。</p>
<p>快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。</p>
<h4 id="当前读"><a href="#当前读" class="headerlink" title="当前读"></a>当前读</h4><p>当前读取的是记录的最新版本（最新版本，而不是历史版本的数据），读取时还需要保证其他并发事务不能修改当前记录，会对读取的记录加锁。加锁的 SELECT ，或者对数据行增删改都会进行当前读。比如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 共享锁 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">FOR</span> SHARE;</span><br><span class="line"><span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span>() ...</span><br><span class="line"><span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> ...</span><br><span class="line"><span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> ...</span><br></pre></td></tr></table></figure>

<h3 id="隔离级别和隐藏字段、Undo-Log版本链"><a href="#隔离级别和隐藏字段、Undo-Log版本链" class="headerlink" title="隔离级别和隐藏字段、Undo Log版本链"></a>隔离级别和隐藏字段、Undo Log版本链</h3><p>SQL中的隔离级别和解决的问题</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102136430.png" alt="image-20221125102136430"></p>
<p>MySQL中默认隔离级别是可重复读，可以解决脏读和不可重复读的问题。而解决幻读需要通过串行化的方式，但是串行化会大幅度降低并发性。</p>
<p>MVCC可以不采用锁机制，而是通过乐观锁的方式来解决不可重复读和幻读问题。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102316103.png" alt="image-20221125102316103"></p>
<p>对于使用InnoDB引擎的表，聚簇索引记录中包含两个必要的隐藏列。</p>
<ul>
<li><code>trx_id</code>：每次一个事务对某条聚簇索引记录进行更改时，都会把该事务的事务id赋值给<code>trx_id</code></li>
<li><code>roll_point</code>：每次对某条聚簇索引记录进行改动时，就会把旧的版本写入到undo日志中，然后这个隐藏列就相当于一个指针，指向修改前的信息，用于回滚。</li>
</ul>
<p>例如插入id为1的事务id为8</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125102729824.png" alt="image-20221125102729824"></p>
<p>此时事务10、20分别对这条记录<code>UPDATE</code>，如果多个事务同时修改，此时会通过<code>X锁</code>控制并发修改的问题。例如事务10先操作，则事务20更新时会处于阻塞状态。</p>
<p>此时<code>undo</code>日志操作链：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125103220778.png" alt="image-20221125103220778"></p>
<h3 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h3><p><strong>MVCC的实现依赖于：隐藏字段、<code>undo log</code>链，<code>ReadView</code></strong></p>
<p>MVCC机制中，多个事务对同一个行记录进行更新，会产生多个历史快照，这些历史快照保存在<code>Undo log</code>里（多版本基于这个方式实现）。如果一个事务要查询这个行记录，需要读取的具体版本的记录，就需要用到<code>ReadView</code>。</p>
<p><code>ReadView</code>就是事务在使用MVCC机制进行快照读操作时产生的<strong>读视图</strong>。当事务启动时，会生成数据库系统当前的一个<strong>快照</strong>。<code>InnoDB</code>为每个事务构造了一个数组，用来记录并维护系统<strong>当前活跃</strong>事务的ID（活跃指的就是，启动了但还没提交。）</p>
<h4 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h4><p>使用 <code>READ UNCOMMITTED</code> 隔离级别的事务，由于可以读到未提交事务修改过的记录，所以直接读取记录的最新版本就好了。</p>
<p>使用 <code>SERIALIZABLE</code> 隔离级别的事务，<code>InnoDB</code>规定使用加锁的方式来访问记录。</p>
<p>使用 <code>READ COMMITED</code>和<code>REPEATABLE READ</code>隔离级别的事务，都必须保证度到了<code>已经提交了的事务</code>修改过的记录，加入另一个事务修改了但是尚未提交，只不能读取最新版本的记录的，核心问题就是<code>需要判断版本链中的哪个版本是当前事务可见的</code>，这是<code>ReadView</code>要解决的主要问题。</p>
<p><code>ReadView</code>中有4个比较重要的部分：</p>
<ol>
<li><code>creator_trx_id</code>：创建这个<code>ReadView</code>的事务id，（只有在对表中的记录做改动时，<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code>这些语句时，才会为事务分配事务id，只读的事务中的事务id都默认为0）</li>
<li><code>trx_ids</code>：表示生成<code>ReadView</code>时当前系统中活跃的读写事务的事务id列表</li>
<li><code>up_limit_id</code>：活跃的事务中最小的事务id</li>
<li><code>low_limit_id</code>：表示生成<code>ReadView</code>时系统中应该分配给下一个事务的id值。<code>low_limit_id</code>是系统最大事务id值（需要注意是系统最大事务id，要区别于正在活跃的事务id）</li>
</ol>
<blockquote>
<p>注意：<code>low_limit_id</code>并不是<code>trx_ids</code>中的最大值，事务id时递增分配的，比如，现在又id为1,2,3这三个事务，id为3的事务提交了。一个新的读事务在生成ReadView时，<code>trx_ids</code>就是1,2，此时<code>low_limit_id</code>的值就是4.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125110751171.png" alt="image-20221125110751171"></p>
<h4 id="ReadView的规则"><a href="#ReadView的规则" class="headerlink" title="ReadView的规则"></a>ReadView的规则</h4><p>有了<code>ReadView</code>，这样在访问某条记录时，只需要按照下面的步骤判断记录的某个版本是否可见。</p>
<ul>
<li>如果被访问版本的<code>trx_id</code>属性值与<code>ReadView</code>中的**<code>creator_trx_id</code>值相同<strong>，表明当前事务在访问它自己修改过的记录，所以该版本</strong>可以**被当前事务访问</li>
<li>如果被访问版本的<code>trx_id</code>属性值<strong>小于<code>ReadView</code>中的<code>up_limit_id</code>值</strong>，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本<strong>可以</strong>被当前事务访问</li>
<li>如果被访问版本的<code>trx_id</code>属性值<strong>大于或等于<code>ReadView</code>中的<code>low_limit_id</code>值</strong>，表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本<strong>不可以</strong>被当前事务访问</li>
<li>如果被访问版本的<code>trx_id</code>属性值<strong>在<code>ReadView</code>的<code>up_limit_id</code>和<code>low_limit_id</code>之间</strong>，那就需要判断一下**<code>trx_id</code>属性值是不是在<code>trx_ids</code>列表中**<ul>
<li>如果<strong>在</strong>，说明创建<code>ReadView</code>时生成该版本的事务还是活跃的，该版本<strong>不可以</strong>被访问</li>
<li>如果<strong>不在</strong>，说明创建<code>ReadView</code>时生成该版本的事务已经被提交，该版本<strong>可以</strong>被访问</li>
</ul>
</li>
</ul>
<h3 id="MVCC整体操作流程"><a href="#MVCC整体操作流程" class="headerlink" title="MVCC整体操作流程"></a>MVCC整体操作流程</h3><ol>
<li>首先获取事务ID</li>
<li>获取<code>ReadView</code></li>
<li>查询得到的数据，然后与<code>ReadView</code>中的事务版本号进行对比；</li>
<li>如果不符合<code>ReadView</code>规则，就需要从 <code>undo log</code>中获取历史快照</li>
<li>最后返回符合规则的数据</li>
</ol>
<p>如果某个版本的数据对当前事务不可见，就顺着版本链找到下一个版本的数据，继续按照上面的步骤判断可见性，直到最后一个版本。如果最后一个版本也不可见，代表这条记录对事务完全不可见，查询结果就不包含该记录。（解决幻读）</p>
<blockquote>
<p>InnoDB中，MVCC是通过 undo log + Read View 进行数据读取，Undo Log 保存了历史快照，Read View规则判断当前版本的数据是否可见</p>
</blockquote>
<h4 id="ReadView的生成节点"><a href="#ReadView的生成节点" class="headerlink" title="ReadView的生成节点"></a>ReadView的生成节点</h4><ul>
<li><p>在隔离级别为<code>READ COMMIT</code>时，一个事务中的每一次SELECT查询都会重新获取一次ReadView。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125112340543.png" alt="image-20221125112340543">此时，同样的查询语句都会重新获取一次ReadView，这时如果ReadView不同，就可能产生不可重复读或者幻读的情况。</p>
</li>
<li><p>在隔离级别为<code>REPEATABLE READ</code>时，一个事务只在第一次<code>SELECT</code>的时候会获取一次<code>ReadView</code>，后面所有的<code>SELECT</code>都会复用这个<code>ReadView</code></p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125112730129.png" alt="image-20221125112730129"></p>
</li>
</ul>
<h3 id="使用MVCC"><a href="#使用MVCC" class="headerlink" title="使用MVCC"></a>使用MVCC</h3><p><code>MVCC</code>只在<code>READ COMMIT</code>和<code>REPEATABLE READ</code>这两个隔离级别下工作。</p>
<p>例如在<code>student</code>表中只有一条由事务<code>id为8</code>的事务插入的一条记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="READ-COMMITTED隔离级别下"><a href="#READ-COMMITTED隔离级别下" class="headerlink" title="READ COMMITTED隔离级别下"></a><code>READ COMMITTED</code>隔离级别下</h4><p><code>READ COMMITTED</code>级别下，每次读取数据前都生成一个<code>ReadView</code>。</p>
<p>现在有两个事务，<code>id</code>分别是10、20，在执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t10 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;李四&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;王五&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t20 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test2 <span class="keyword">values</span>(<span class="number">3</span>); <span class="comment">-- 由于只有第一次修改记录时才分配一个独立的事务id，因此要随便修改一下其他的表</span></span><br></pre></td></tr></table></figure>

<p>此时，student中id为1的记录得到的版本链表如下</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125114343122.png" alt="image-20221125114343122"></p>
<p>一个使用<code>READ COMMITTED</code>隔离级别的事务开始操作 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> transaction_isolation<span class="operator">=</span><span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%transaction_isolation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> transaction_isolation <span class="operator">|</span> READ<span class="operator">-</span>COMMITTED <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>得到的结果是<code>张三</code>，执行 <code>select</code> 时，生成一个<code>ReadView</code>：</p>
<p>步骤1：</p>
<ul>
<li><p><code>trx_ids</code>列表的内容 <code>[10,20]</code>（操作的事务没有<code>INSERT</code>操作，事务id为0），</p>
</li>
<li><p><code>up_limit_id</code>为<code>10</code></p>
</li>
<li><p><code>low_limit_id</code>为<code>21</code></p>
</li>
<li><p><code>creator_trx_id</code>为<code>0</code></p>
</li>
</ul>
<p>步骤2：从版本链中可见的记录，最新版本是<code>王五</code>，<code>trx_id</code>是10，在<code>trx_ids</code>列表内，符合不可见要求，根据<code>roll_pointer</code>跳到下一个版本</p>
<p>步骤3：同步骤2，不可见，跳到下一个版本</p>
<p>步骤4：<code>name</code>列是 <code>张三</code>，<code>trx_id</code>为8，小于<code>ReadView</code>中的<code>up_limit_id</code>值10，符合要求，最后返回的版本就是这条列的记录。</p>
<p>此时提交事务10，然后将事务20的记录改一下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t10 </span></span><br><span class="line"><span class="keyword">commit</span>；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t20 </span></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;钱七&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;宋八&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>此时，记录为1的版本链就长这样：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125115601339.png" alt="image-20221125115601339"></p>
<p>此时，再在<code>READ COMMITTED</code>隔离级别的事务中继续查找这个id为1的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 王五   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>得到的结果是<code>王五</code>，这个<code>select</code>的执行过程如下：</p>
<p>步骤1，重新生成一个单独的<code>ReadView</code>：</p>
<ul>
<li><p><code>trx_ids</code>列表的内容 <code>[20]</code>（事务10已经提交），</p>
</li>
<li><p><code>up_limit_id</code>为<code>20</code></p>
</li>
<li><p><code>low_limit_id</code>为<code>21</code></p>
</li>
<li><p><code>creator_trx_id</code>为<code>0</code></p>
</li>
</ul>
<p>步骤2：从版本链中可见的记录，最新版本是<code>宋八</code>，<code>trx_id</code>是20，在<code>trx_ids</code>列表内，符合不可见要求，根据<code>roll_pointer</code>跳到下一个版本</p>
<p>步骤3：同步骤2，不可见，跳到下一个版本</p>
<p>步骤4：<code>name</code>列是 <code>王五</code>，<code>trx_id</code>为10，小于<code>ReadView</code>中的<code>up_limit_id</code>值20，符合要求，最后返回的版本就是这条列的记录。</p>
<h4 id="REPEATABLE-READ隔离级别下"><a href="#REPEATABLE-READ隔离级别下" class="headerlink" title="REPEATABLE READ隔离级别下"></a><code>REPEATABLE READ</code>隔离级别下</h4><p>使用<code>REPEATABLE READ</code>隔离级别，只会在第一次执行查询语句时生成一个ReadView，之后的查询就不会重复生成。</p>
<p>现在有两个事务，<code>id</code>分别是10、20，在执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t10 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;李四&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;王五&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t20 </span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test2 <span class="keyword">values</span>(<span class="number">3</span>); <span class="comment">-- 由于只有第一次修改记录时才分配一个独立的事务id，因此要随便修改一下其他的表</span></span><br></pre></td></tr></table></figure>

<p>此时，student中id为1的记录得到的版本链表如下</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125114343122.png" alt="image-20221125114343122"></p>
<p>一个使用<code>REPEATABLE READ</code>隔离级别的事务开始操作 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> transaction_isolation<span class="operator">=</span><span class="string">&#x27;REPEATABLE-READ&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%transaction_isolation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> transaction_isolation <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班   <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>这个过程与使用<code>READ COMMITTED</code>隔离级别一致，得到的结果是<code>张三</code>，执行 <code>select</code> 时，生成一个<code>ReadView</code>：</p>
<p>步骤1：</p>
<ul>
<li><p><code>trx_ids</code>列表的内容 <code>[10,20]</code>（操作的事务没有<code>INSERT</code>操作，事务id为0），</p>
</li>
<li><p><code>up_limit_id</code>为<code>10</code></p>
</li>
<li><p><code>low_limit_id</code>为<code>21</code></p>
</li>
<li><p><code>creator_trx_id</code>为<code>0</code></p>
</li>
</ul>
<p>步骤2：从版本链中可见的记录，最新版本是<code>王五</code>，<code>trx_id</code>是10，在<code>trx_ids</code>列表内，符合不可见要求，根据<code>roll_pointer</code>跳到下一个版本</p>
<p>步骤3：同步骤2，不可见，跳到下一个版本</p>
<p>步骤4：<code>name</code>列是 <code>张三</code>，<code>trx_id</code>为8，小于<code>ReadView</code>中的<code>up_limit_id</code>值10，符合要求，最后返回的版本就是这条列的记录。</p>
<p>此时提交事务10，然后将事务20的记录改一下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- t10 </span></span><br><span class="line"><span class="keyword">commit</span>；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- t20 </span></span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;钱七&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> student <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;宋八&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>此时，记录为1的版本链就长这样：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125115601339.png" alt="image-20221125115601339"></p>
<p>此时，再在<code>READ COMMITTED</code>隔离级别的事务中继续查找这个id为1的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>得到的结果是<code>张三</code>，这个<code>select</code>的执行过程跟第一次执行过程一样，只是不会再次生成一个<code>ReadView</code>。</p>
<h3 id="MVCC解决幻读"><a href="#MVCC解决幻读" class="headerlink" title="MVCC解决幻读"></a>MVCC解决幻读</h3><p>解决幻读的前提是在<code>REPEATABLE READ</code>隔离级别。</p>
<p>假设student表只有一条数据，数据内容中，主键<code>id=1</code>，隐藏的<code>trx_id=10</code>，<code>undo log</code>如下：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125121001971.png" alt="image-20221125121001971"></p>
<p>现在有事务A和事务B并发执行，事务A的事务id为20，事务B的事务id为30.</p>
<p>步骤1：事务A开始第一次查询数据，SQL语句如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&gt;=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>在开始查询之前，MySQL会为事务A生成一个<code>ReadView</code>，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">creator_trx_id = 20</span><br><span class="line">trx_ids = [20,30]</span><br><span class="line">up_limit_id = 20</span><br><span class="line">low_limit_id = 31</span><br></pre></td></tr></table></figure>

<p>此时符合 <code>id &gt;= 1</code>条件的记录只有1条，可以查出<code>id=1</code>的记录。</p>
<p>步骤2：在事务B中，往表student中插入两条数据，并提交事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id,name) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;李四&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id,name) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;王五&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>此时，student表中有三条数据，对应的<code>undo log</code>如下</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125121611519.png" alt="image-20221125121611519"></p>
<p>新的数据<code>trx_id</code>为30，在<code>trx_ids</code>之间，不可读取到。即使事务B提交，也在<code>trx_ids</code>内，也不可读取到，因此解决幻读的问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><code>MVCC</code>在<code>READ COMMITTED</code>和<code>REPEATABLE READ</code>隔离级别这两种隔离级别的事务，在执行读快照操作时访问版本链，这样使不同事务的<code>读-写</code>、<code>写-读</code>操作并发执行，从而提高性能。</p>
<p><code>MVCC</code>在<code>READ COMMITTED</code>和<code>REPEATABLE READ</code>隔离级别生成<code>ReadView</code>的时机不同：</p>
<ul>
<li><code>READ COMMITTED</code>每次读取时都生成<code>ReadView</code></li>
<li><code>REPEATABLE READ</code>在第一次读取时生成<code>ReadView</code>，以后复用</li>
</ul>
<blockquote>
<p><code>delete</code>语句或者更新主键的<code>update</code>语句，并不会立即把对应的记录从页面删除，而是执行一个<code>delete mark</code>操作，相当于打上一个删除标志，主要就是为<code>MVCC</code>服务</p>
</blockquote>
<p>通过MVCC解决的问题：</p>
<ul>
<li>读写之间阻塞的问题：让读写互不阻塞，提升并发处理能力</li>
<li>降低死锁的概率：通过乐观锁的方式</li>
<li>解决快照读的问题</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/de27.html" rel="prev" title="MySQL学习笔记设计规范和调优篇">
                  <i class="fa fa-chevron-left"></i> MySQL学习笔记设计规范和调优篇
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/a820.html" rel="next" title="MySQL学习笔记高可用篇">
                  MySQL学习笔记高可用篇 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
