<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Nginx 以其强大的性能闻名，核心是它的架构模型和请求处理过程和能力。">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx架构、阶段、模块">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/4b7bcf38.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="Nginx 以其强大的性能闻名，核心是它的架构模型和请求处理过程和能力。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-31-59-image-20240319173159019.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-36-49-image-20240319173649111.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-37-07-image-20240319173707309.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-43-55-goaccess-dashboard.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-27-51-image-20240319212751796.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-29-17-image-20240319212917574.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-31-24-image-20240319213124644.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-32-31-image-20240319213231497.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-34-16-image-20240319213415910.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-35-15-image-20240319213515766.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-39-54-image-20240319213954908.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-40-52-image-20240319214052396.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-41-54-image-20240319214154415.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-43-23-image-20240319214323670.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F10-29-54-image-20240320102954837.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F10-39-04-image-20240320103904332.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-06-46-image-20240320110646429.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-20-13-image-20240320112013511.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-32-34-image-20240320113234640.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-35-51-image-20240320113551100.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-36-03-image-20240320113603464.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F14-45-33-image-20240320144533754.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F14-49-12-image-20240320144912013.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F15-14-52-image-20240320151452328.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-16-39-image-20240320161639495.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-19-47-image-20240320161947779.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-20-07-image-20240320162007008.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-32-23-image-20240320163223907.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-47-58-image-20240320164758250.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-59-48-image-20240320165947952.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-06-09-image-20240320170609268.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-13-27-image-20240320171327210.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-00-image-20240320174200080.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-17-image-20240320174217530.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-47-image-20240320174247606.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-00-34-image-20240320200034481.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-02-55-image-20240320200255105.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-07-32-image-20240320200732364.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-09-17-image-20240320200917592.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-12-46-image-20240320201246522.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-14-29-image-20240320201429641.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-16-25-image-20240320201625382.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-17-36-image-20240320201736030.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-43-32-image-20240320204332742.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-43-57-image-20240320204357215.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-12-12-image-20240322151212664.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-12-35-image-20240322151234928.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-22-00-image-20240322152200841.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-27-35-image-20240322152735010.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F16-51-51-image-20240322165151774.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F20-05-00-image-20240322200500405.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F20-21-29-image-20240322202129575.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F23-09-56-image-20240322230956352.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F23-14-03-image-20240322231403898.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F23%2F14-00-48-image-20240323140048843.png">
<meta property="article:published_time" content="2024-03-18T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-25T01:59:49.547Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-31-59-image-20240319173159019.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/4b7bcf38.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/4b7bcf38.html","path":"post/4b7bcf38.html","title":"Nginx架构、阶段、模块"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx架构、阶段、模块 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E8%AF%86-Nginx"><span class="nav-number">1.</span> <span class="nav-text">初识 Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E4%B8%89%E4%B8%AA%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.1.</span> <span class="nav-text">Nginx 三个主要应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.2.</span> <span class="nav-text">Nginx 出现原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">1.3.</span> <span class="nav-text">Nginx 的优点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="nav-number">1.4.</span> <span class="nav-text">Nginx 组成部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83"><span class="nav-number">1.5.</span> <span class="nav-text">Nginx 版本发布</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%80%82%E5%90%88%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%85"><span class="nav-number">1.6.</span> <span class="nav-text">编译适合自己的包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="nav-number">1.7.</span> <span class="nav-text">Nginx 配置语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http-%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8C%87%E4%BB%A4%E5%BF%AB"><span class="nav-number">1.7.1.</span> <span class="nav-text">http 配置的指令快</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-number">1.8.</span> <span class="nav-text">Nginx 命令行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.8.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%BC%94%E7%A4%BA"><span class="nav-number">1.9.</span> <span class="nav-text">静态资源服务演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%A6%E6%9C%89%E7%BC%93%E5%AD%98%E7%9A%84%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">1.10.</span> <span class="nav-text">带有缓存的反向代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Go-access-%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90-accesslog-%E6%97%A5%E5%BF%97"><span class="nav-number">1.11.</span> <span class="nav-text">使用 Go access 实时分析 accesslog 日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS-SSL-%E5%8F%91%E5%B1%95"><span class="nav-number">1.12.</span> <span class="nav-text">TLS&#x2F;SSL 发展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TLS-%E5%AE%89%E5%85%A8%E5%AF%86%E7%A0%81%E5%A5%97%E4%BB%B6%E8%A7%A3%E8%AF%BB"><span class="nav-number">1.12.1.</span> <span class="nav-text">TLS 安全密码套件解读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-number">1.12.2.</span> <span class="nav-text">对称加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-number">1.12.3.</span> <span class="nav-text">非对称加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PKI-%E5%85%AC%E9%92%A5%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="nav-number">1.12.4.</span> <span class="nav-text">PKI 公钥基础设施</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.12.5.</span> <span class="nav-text">证书类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E9%93%BE"><span class="nav-number">1.12.6.</span> <span class="nav-text">证书链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS-%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B"><span class="nav-number">1.13.</span> <span class="nav-text">TLS 通讯过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenResty-%E5%AE%89%E8%A3%85"><span class="nav-number">1.14.</span> <span class="nav-text">OpenResty 安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80"><span class="nav-number">2.</span> <span class="nav-text">Nginx 架构基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">Nginx 请求处理流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">Nginx 进程结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BF%A1%E5%8F%B7"><span class="nav-number">2.3.</span> <span class="nav-text">Nginx 进程管理：信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reload-%E6%B5%81%E7%A8%8B"><span class="nav-number">2.4.</span> <span class="nav-text">reload 流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%83%AD%E5%8D%87%E7%BA%A7%E6%B5%81%E7%A8%8B"><span class="nav-number">2.5.</span> <span class="nav-text">热升级流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Worker-%E8%BF%9B%E7%A8%8B%EF%BC%9A%E4%BC%98%E9%9B%85%E7%9A%84%E5%85%B3%E9%97%AD"><span class="nav-number">2.6.</span> <span class="nav-text">Worker 进程：优雅的关闭</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E4%B8%8E-Nginx-%E4%BA%8B%E4%BB%B6%E9%97%B4%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="nav-number">2.7.</span> <span class="nav-text">网络收发与 Nginx 事件间的对应关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-number">2.7.1.</span> <span class="nav-text">Nginx 事件循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-number">2.8.</span> <span class="nav-text">epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%88%87%E6%8D%A2"><span class="nav-number">2.9.</span> <span class="nav-text">请求切换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E8%B0%83%E7%94%A8"><span class="nav-number">2.10.</span> <span class="nav-text">阻塞调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5-accept-%E4%B8%BA%E4%BE%8B"><span class="nav-number">2.10.1.</span> <span class="nav-text">以 accept 为例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E8%B0%83%E7%94%A8"><span class="nav-number">2.10.2.</span> <span class="nav-text">非阻塞调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E8%B0%83%E7%94%A8%E4%B8%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5"><span class="nav-number">2.10.3.</span> <span class="nav-text">非阻塞调用下的同步与异步</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E6%A8%A1%E5%9D%97"><span class="nav-number">2.11.</span> <span class="nav-text">Nginx 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%88%86%E7%B1%BB"><span class="nav-number">2.12.</span> <span class="nav-text">模块分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-number">2.13.</span> <span class="nav-text">连接池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.14.</span> <span class="nav-text">核心数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B1%A0"><span class="nav-number">2.15.</span> <span class="nav-text">内存池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E8%BF%9B%E7%A8%8B%E9%97%B4%E7%9A%84%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F"><span class="nav-number">2.16.</span> <span class="nav-text">Nginx 进程间的通讯方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%EF%BC%9A%E8%B7%A8-Worker-%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%AE%AF"><span class="nav-number">2.16.1.</span> <span class="nav-text">共享内存：跨 Worker 进程通讯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenResty-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.16.2.</span> <span class="nav-text">OpenResty 共享内存代码示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Slab-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">2.17.</span> <span class="nav-text">Slab 内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-slab-stat-%E7%BB%9F%E8%AE%A1-Slab-%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81"><span class="nav-number">2.17.1.</span> <span class="nav-text">ngx_slab_stat 统计 Slab 使用状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%AE%B9%E5%99%A8"><span class="nav-number">2.18.</span> <span class="nav-text">Nginx 容器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">2.18.1.</span> <span class="nav-text">Nginx 哈希表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E8%A1%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">2.18.2.</span> <span class="nav-text">哈希表配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="nav-number">2.18.3.</span> <span class="nav-text">红黑树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">2.18.4.</span> <span class="nav-text">红黑树的使用模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%A8%A1%E5%9D%97-%E5%87%8F%E5%B0%91%E7%BC%96%E8%AF%91%E7%8E%AF%E8%8A%82"><span class="nav-number">2.19.</span> <span class="nav-text">动态模块-减少编译环节</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3-HTTP-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.</span> <span class="nav-text">详解 HTTP 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%9D%97%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="nav-number">3.1.</span> <span class="nav-text">配置块的嵌套</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E7%9A%84-Context"><span class="nav-number">3.1.1.</span> <span class="nav-text">指令的 Context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E7%9A%84%E5%90%88%E5%B9%B6"><span class="nav-number">3.1.2.</span> <span class="nav-text">指令的合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%80%BC%E7%9A%84%E6%8C%87%E4%BB%A4%E7%BB%A7%E6%89%BF%E8%A7%84%E5%88%99%EF%BC%9A%E5%90%91%E4%B8%8A%E8%A6%86%E7%9B%96"><span class="nav-number">3.1.3.</span> <span class="nav-text">存储值的指令继承规则：向上覆盖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-%E6%A8%A1%E5%9D%97%E5%90%88%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.4.</span> <span class="nav-text">HTTP 模块合并配置的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="nav-number">3.2.</span> <span class="nav-text">常用指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Listen-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.2.1.</span> <span class="nav-text">Listen 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E4%BA%8B%E4%BB%B6%E6%A8%A1%E5%9D%97"><span class="nav-number">3.2.2.</span> <span class="nav-text">接收请求事件模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82-HTTP-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.2.3.</span> <span class="nav-text">接收请求 HTTP 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">3.3.</span> <span class="nav-text">正则表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E5%AD%97%E7%AC%A6"><span class="nav-number">3.3.1.</span> <span class="nav-text">元字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D"><span class="nav-number">3.3.2.</span> <span class="nav-text">重复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">3.3.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server-%E6%8C%87%E4%BB%A4%E5%9D%97"><span class="nav-number">3.4.</span> <span class="nav-text">server 指令块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#server-name-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.4.1.</span> <span class="nav-text">server_name 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-%E5%8C%B9%E9%85%8D%E9%A1%BA%E5%BA%8F"><span class="nav-number">3.4.2.</span> <span class="nav-text">server 匹配顺序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%97%B6%E7%9A%84-11-%E4%B8%AA%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.</span> <span class="nav-text">HTTP 请求处理时的 11 个阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E4%B8%AA%E9%98%B6%E6%AE%B5%E9%A1%BA%E5%BA%8F%E5%A4%84%E7%90%86"><span class="nav-number">3.5.1.</span> <span class="nav-text">11 个阶段顺序处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSTREAD-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.2.</span> <span class="nav-text">POSTREAD 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#realip-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.2.1.</span> <span class="nav-text">realip 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#REWRITE-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.3.</span> <span class="nav-text">REWRITE 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#return-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.3.1.</span> <span class="nav-text">return 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error-page-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.3.2.</span> <span class="nav-text">error_page 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rewrite-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.3.3.</span> <span class="nav-text">rewrite 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rewrite-log-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.3.4.</span> <span class="nav-text">rewrite_log 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#if-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.3.5.</span> <span class="nav-text">if 指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FIND-CONFIG-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.4.</span> <span class="nav-text">FIND_CONFIG 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Location-%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="nav-number">3.5.4.1.</span> <span class="nav-text">Location 匹配规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PREACCESS-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.5.</span> <span class="nav-text">PREACCESS 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-conn-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.5.1.</span> <span class="nav-text">limit_conn 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#limit-req-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.5.2.</span> <span class="nav-text">limit_req 指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ACCESS-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.6.</span> <span class="nav-text">ACCESS 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#access-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.6.1.</span> <span class="nav-text">access 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#auth-basic-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.6.2.</span> <span class="nav-text">auth_basic 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#auth-request-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.6.3.</span> <span class="nav-text">auth_request 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#satisfy-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.6.4.</span> <span class="nav-text">satisfy 指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PRECONTENT-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.7.</span> <span class="nav-text">PRECONTENT 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#try-files-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.7.1.</span> <span class="nav-text">try_files 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mirror-%E6%8C%87%E4%BB%A4"><span class="nav-number">3.5.7.2.</span> <span class="nav-text">mirror 指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CONTENT-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.8.</span> <span class="nav-text">CONTENT 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#static-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.8.1.</span> <span class="nav-text">static 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">3.5.8.2.</span> <span class="nav-text">重定向</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#index-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.8.3.</span> <span class="nav-text">index 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#randomindex-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.8.4.</span> <span class="nav-text">randomindex 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#autoindex-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.8.5.</span> <span class="nav-text">autoindex 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#concat-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.8.6.</span> <span class="nav-text">concat 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LOG-%E9%98%B6%E6%AE%B5"><span class="nav-number">3.5.9.</span> <span class="nav-text">LOG 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#access-log-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.9.1.</span> <span class="nav-text">access_log 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">3.5.10.</span> <span class="nav-text">过滤模块的位置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E5%B7%A5%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9"><span class="nav-number">3.5.10.1.</span> <span class="nav-text">加工响应内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sub-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.10.2.</span> <span class="nav-text">sub 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addition-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.5.10.3.</span> <span class="nav-text">addition 模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%8F%98%E9%87%8F%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">3.6.</span> <span class="nav-text">Nginx 变量的运行原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.</span> <span class="nav-text">HTTP 框架提供的变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-%E8%AF%B7%E6%B1%82%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.1.</span> <span class="nav-text">HTTP 请求相关的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.2.</span> <span class="nav-text">TCP 连接相关的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.3.</span> <span class="nav-text">Nginx 处理请求过程中产生的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81-HTTP-%E5%93%8D%E5%BA%94%E6%97%B6%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.4.</span> <span class="nav-text">发送 HTTP 响应时相关的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">3.7.5.</span> <span class="nav-text">Nginx 系统变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%9C%89%E6%95%88%E7%9A%84%E9%98%B2%E7%9B%97%E9%93%BE%E6%89%8B%E6%AE%B5-referer-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.8.</span> <span class="nav-text">简单有效的防盗链手段 referer 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE%E7%9A%84%E4%B8%80%E7%A7%8D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-secure-link-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.9.</span> <span class="nav-text">防盗链的一种解决方案 secure_link 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#map-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="nav-number">3.10.</span> <span class="nav-text">map 模块的指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#split-clients-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.11.</span> <span class="nav-text">split_clients 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#geo-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.12.</span> <span class="nav-text">geo 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#geoip-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.13.</span> <span class="nav-text">geoip 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keepalive-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.14.</span> <span class="nav-text">keepalive 模块</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/4b7bcf38.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx架构、阶段、模块 | 小夜时雨">
      <meta itemprop="description" content="Nginx 以其强大的性能闻名，核心是它的架构模型和请求处理过程和能力。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx架构、阶段、模块
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-19 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-19T00:00:00+08:00">2024-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-25 09:59:49" itemprop="dateModified" datetime="2024-03-25T09:59:49+08:00">2024-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
    <span id="/post/4b7bcf38.html" class="post-meta-item leancloud_visitors" data-flag-title="Nginx架构、阶段、模块" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">Nginx 以其强大的性能闻名，核心是它的架构模型和请求处理过程和能力。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="初识-Nginx"><a href="#初识-Nginx" class="headerlink" title="初识 Nginx"></a>初识 Nginx</h1><h2 id="Nginx-三个主要应用场景"><a href="#Nginx-三个主要应用场景" class="headerlink" title="Nginx 三个主要应用场景"></a>Nginx 三个主要应用场景</h2><ol>
<li>静态资源服务<ul>
<li>通过本地文件系统提供服务：例如直接提供一些 h5 资源（html,css）或者图片等静态资源</li>
</ul>
</li>
<li>反向代理服务<ul>
<li>Nginx 的强大性能：作为多个应用服务组成的集群的网关，提供高性能</li>
<li>缓存：将一段时间内看起来不变的内容缓存到 Nginx，加速访问</li>
<li>负载均衡：同一台 Nginx 可以同时支持多个后台服务器，并且做负载均衡</li>
</ul>
</li>
<li>API 服务<ul>
<li>OpenResty：直接访问数据库，提供完整的 API 服务</li>
</ul>
</li>
</ol>
<h2 id="Nginx-出现原因"><a href="#Nginx-出现原因" class="headerlink" title="Nginx 出现原因"></a>Nginx 出现原因</h2><ol>
<li>互联网的数据量快速增长，对高并发要求越来越高<ul>
<li>互联网的快速普及</li>
<li>全球化</li>
<li>物联网</li>
</ul>
</li>
<li>摩尔定律：性能提升<ul>
<li>物理硬件 CPU、内存提升之后，操作系统和应用也需要配套提升</li>
</ul>
</li>
<li>低效的 Apache<ul>
<li>一个连接对应一个进程：操作系统进程间切换，导致并发数上不来，并发上来之后，使用进程处理，会导致大量进程创建、删除、切换，从而产生很大的开销</li>
</ul>
</li>
</ol>
<h2 id="Nginx-的优点"><a href="#Nginx-的优点" class="headerlink" title="Nginx 的优点"></a>Nginx 的优点</h2><ul>
<li>高并发，高性能：可以达到百万QPS</li>
<li>可扩展性好：生态圈法阵非常好</li>
<li>高可靠性：可以持续不间断运行数年不重启</li>
<li>热部署：修改配置、升级后可以热加载，不需要重启</li>
<li>BSD 许可证：开源、免费，而且可以修改代码之后做商业化</li>
</ul>
<h2 id="Nginx-组成部分"><a href="#Nginx-组成部分" class="headerlink" title="Nginx 组成部分"></a>Nginx 组成部分</h2><ol>
<li>Nginx 二进制可执行文件<ul>
<li>由各模块源码编译出的一个文件</li>
</ul>
</li>
<li><code>nginx.conf</code> 配置文件<ul>
<li>控制 Nginx 的行为</li>
</ul>
</li>
<li><code>access.log</code> 访问日志<ul>
<li>记录每一条 <code>http</code> 请求信息和相应信息</li>
</ul>
</li>
<li><code>error.log</code> 错误日志<ul>
<li>用于定位问题</li>
</ul>
</li>
</ol>
<h2 id="Nginx-版本发布"><a href="#Nginx-版本发布" class="headerlink" title="Nginx 版本发布"></a>Nginx 版本发布</h2><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcv">https://nginx.org/<i class="fa fa-external-link-alt"></i></span></p>
<p>一些版本推荐：<span class="exturl" data-url="aHR0cHM6Ly9vcGVucmVzdHkub3JnL2NuLw==">https://openresty.org/cn/<i class="fa fa-external-link-alt"></i></span> （开源版）</p>
<h2 id="编译适合自己的包"><a href="#编译适合自己的包" class="headerlink" title="编译适合自己的包"></a>编译适合自己的包</h2><p><strong>下载源码</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG93bmxvYWQuaHRtbA==">https://nginx.org/en/download.html<i class="fa fa-external-link-alt"></i></span></p>
<p><strong>目录介绍</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">total 1624</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  323312 Apr 11  2023 CHANGES // 改动日志</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  494234 Apr 11  2023 CHANGES.ru // 俄罗斯版本语言改动日志</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    1397 Apr 11  2023 LICENSE</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff      49 Apr 11  2023 README</span><br><span class="line">drwxr-xr-x@ 25 xuwenxiang  staff     800 Apr 11  2023 auto // 供编译使用库和环境信息</span><br><span class="line">drwxr-xr-x@ 11 xuwenxiang  staff     352 Apr 11  2023 conf // 存放配置的目录</span><br><span class="line">-rwxr-xr-x@  1 xuwenxiang  staff    2611 Apr 11  2023 configure // 执行中间文件的直径脚本</span><br><span class="line">drwxr-xr-x@  6 xuwenxiang  staff     192 Apr 11  2023 contrib // vim 的插件和脚本</span><br><span class="line">drwxr-xr-x@  4 xuwenxiang  staff     128 Apr 11  2023 html // 标准处理的 html 文件</span><br><span class="line">drwxr-xr-x@  3 xuwenxiang  staff      96 Apr 11  2023 man // 帮助文件</span><br><span class="line">drwxr-xr-x@  9 xuwenxiang  staff     288 Apr 11  2023 src // 源代码存放目录</span><br></pre></td></tr></table></figure>

<p><code>auto</code> 目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">total 376</span><br><span class="line">drwxr-xr-x@ 13 xuwenxiang  staff    416 Apr 11  2023 cc  </span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    141 Apr 11  2023 define</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    889 Apr 11  2023 endianness</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   2812 Apr 11  2023 feature</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    136 Apr 11  2023 have</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    137 Apr 11  2023 have_headers</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    411 Apr 11  2023 headers</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   1020 Apr 11  2023 include</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    768 Apr 11  2023 init</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   4875 Apr 11  2023 install</span><br><span class="line">drwxr-xr-x@ 13 xuwenxiang  staff    416 Apr 11  2023 lib</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  18324 Apr 11  2023 make</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   3934 Apr 11  2023 module</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  38598 Apr 11  2023 modules</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    136 Apr 11  2023 nohave</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  25612 Apr 11  2023 options</span><br><span class="line">drwxr-xr-x@  8 xuwenxiang  staff    256 Apr 11  2023 os</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   8890 Apr 11  2023 sources</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    120 Apr 11  2023 stubs</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff   2032 Apr 11  2023 summary</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff    394 Apr 11  2023 threads</span><br><span class="line">drwxr-xr-x@  6 xuwenxiang  staff    192 Apr 11  2023 types</span><br><span class="line">-rw-r--r--@  1 xuwenxiang  staff  26166 Apr 11  2023 unix</span><br></pre></td></tr></table></figure>

<p><strong>Configure 文件介绍</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<ol>
<li>可以指定一些模块的文件存放位置</li>
<li>可以指定使用哪些模块和不适用哪些模块</li>
<li>可以指定哪些特殊参数，例如是否打印 <code>debug</code> 日志，或者是否加入第三方模块</li>
</ol>
<p><strong>中间文件介绍</strong></p>
<p>执行 <code>configure</code> 后，会将中间文件生成在 <code>objs</code> 目录中。里面存放编译的一些配置信息</p>
<p><strong>编译</strong></p>
<p>执行 <code>make</code> 进行编译，会生成二进制可执行文件在 <code>objs</code> 目录中</p>
<p><strong>安装</strong></p>
<p>执行 <code>make install</code>。将指定的安装目录中，<code>src</code> 目录下的二进制文件拷贝出去执行即可。</p>
<h2 id="Nginx-配置语法"><a href="#Nginx-配置语法" class="headerlink" title="Nginx 配置语法"></a>Nginx 配置语法</h2><ol>
<li>配置文件由指令与指令块构成：指令以 <code>;</code> 结尾，指令块在 <code>&#123;&#125;</code> 中</li>
<li>每条指令以 <code>;</code> 号结尾，指令与参数间以空格符号分割</li>
<li>指令快以 <code>&#123;&#125;</code> 大括号将多条指令组织在一起</li>
<li><code>include</code> 语句允许组合多个配置文件以提升可维护性</li>
<li>使用 <code>#</code> 符号添加注释，提高可读性</li>
<li>使用 <code>$</code> 符号使用变量</li>
<li>部分指令的参数支持正则表达式</li>
</ol>
<p>官方文件，一些模块：<span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy8=">https://nginx.org/en/docs/<i class="fa fa-external-link-alt"></i></span></p>
<p>例如：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-31-59-image-20240319173159019.png" alt="image-20240319173159019"></p>
<p>配置参数：时间的单位</p>
<img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-36-49-image-20240319173649111.png" alt="image-20240319173649111" style="zoom:25%;" />

<p>配置参数：空间的单位</p>
<img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F19%2F17-37-07-image-20240319173707309.png" alt="image-20240319173707309" style="zoom:25%;" />

<h3 id="http-配置的指令快"><a href="#http-配置的指令快" class="headerlink" title="http 配置的指令快"></a>http 配置的指令快</h3><ol>
<li><code>http</code>：表示所有的指令由 <code>http</code> 模块解析</li>
<li><code>server</code>：对应一个域名或者一组域名</li>
<li><code>location</code>：一个 <code>url</code> 表达式</li>
<li><code>upstream</code>：表示上游服务，例如内网其他服务</li>
</ol>
<h2 id="Nginx-命令行"><a href="#Nginx-命令行" class="headerlink" title="Nginx 命令行"></a>Nginx 命令行</h2><ol>
<li>格式：<code>nginx -s reload</code></li>
<li>帮助：<code>-? -h</code></li>
<li>使用指定的配置文件：<code>-c</code></li>
<li>指定配置指令：<code>-g</code>，主要用于 <code>forget</code> 中间的指令</li>
<li>指定运行目录：<code>-p</code></li>
<li>发送信号：<code>-s</code><ol>
<li>立即停止服务：<code>stop</code></li>
<li>优雅的停止服务：<code>quit</code></li>
<li>重载配置文件：<code>reload</code></li>
<li>重新开始记录日志文件：<code>reopen</code></li>
</ol>
</li>
<li>测试配置文件是否有语法错误：<code>-t</code>、<code>-T</code></li>
<li>打印 <code>nginx</code> 的版本信息、编译信息等：<code>-v</code>、<code>-V</code></li>
</ol>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>重载配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件后</span></span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<p>热部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当 nginx 正在运行，需要更新nginx，先备份二进制文件，将新的二进制nginx可执行文件拷贝到对应目录中替换原文件</span></span><br><span class="line"><span class="comment"># 获取 nginx 的 master 进程</span></span><br><span class="line">ps aux | grep nginx</span><br><span class="line"><span class="built_in">kill</span> -USR2 &lt;pid&gt;</span><br><span class="line"><span class="comment"># 会生成一个新的 nginx master 进程，也会新启动一些 worker 进程，老的 worker 进程的请求会过渡到新的 worker 中</span></span><br><span class="line"><span class="comment"># 让老 nginx 进程优雅关闭 worker 进程</span></span><br><span class="line"><span class="built_in">kill</span> -WINCH &lt;pid&gt;</span><br><span class="line"><span class="comment"># 剩下的就只有老的 nginx 的 master 进程，可以安全回退</span></span><br></pre></td></tr></table></figure>

<p>切割日志文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先拷贝 access.log 到另外一个地方</span></span><br><span class="line"><span class="built_in">mv</span> access.log bak.log</span><br><span class="line"><span class="comment"># 或者 kill -USR1 &lt;pid&gt;</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"><span class="comment"># 切割之后，原来的日志文件大小从0开始</span></span><br></pre></td></tr></table></figure>

<h2 id="静态资源服务演示"><a href="#静态资源服务演示" class="headerlink" title="静态资源服务演示"></a>静态资源服务演示</h2><p>例如一个 <code>index.html</code> 文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># 记录日志的格式，将这个格式命名成 main</span></span><br><span class="line">  <span class="attribute">log_format</span>  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                   <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                   <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将 main 这种格式的日志记录到某个文件中</span></span><br><span class="line">  <span class="attribute">access_log</span>  logs/access.log  main;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开内容压缩</span></span><br><span class="line">  <span class="attribute">gzip</span>  <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># 压缩长度最短限制</span></span><br><span class="line">  <span class="attribute">gzip_min_length</span> <span class="number">1</span>;</span><br><span class="line">  <span class="comment"># 压缩级别</span></span><br><span class="line">  <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">  <span class="comment"># 指定类型文件的压缩</span></span><br><span class="line">  <span class="attribute">gzip_types</span> text/plain;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">      <span class="comment"># 配置好监听端口</span></span><br><span class="line">      <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">      <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">      <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 所有的请求都转发到这里</span></span><br><span class="line">      <span class="section">location</span> / &#123;</span><br><span class="line">          <span class="comment"># alias 表示安装是的目录和当前目录对应，可以理解为指定相对目录</span></span><br><span class="line">          <span class="attribute">alias</span> xxx/;</span><br><span class="line">  				<span class="comment"># 显示目录及文件</span></span><br><span class="line">          <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">          <span class="comment"># 将 url 里面的路径带进来，因此一般使用 alias</span></span><br><span class="line">          <span class="comment"># root   html;</span></span><br><span class="line">          <span class="comment"># index  index.html index.htm;</span></span><br><span class="line">          <span class="comment"># 限制响应速度，限制每秒传输的字节数，防止一些大文件将带宽占满，导致无法获取小文件</span></span><br><span class="line">          <span class="attribute">set</span> <span class="variable">$limit_rate</span> <span class="number">1k</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>变量解释：<span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy8=">https://nginx.org/en/docs/<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="带有缓存的反向代理"><a href="#带有缓存的反向代理" class="headerlink" title="带有缓存的反向代理"></a>带有缓存的反向代理</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置缓存存放地方，以及使用共享内存大小</span></span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /tmp/nginxcache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">10m</span> max_size=<span class="number">10g</span> inactive=<span class="number">60m</span> use_temp_path=<span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置文件包含目录中的配置文件</span></span><br><span class="line">    <span class="attribute">include</span> vhost/<span class="regexp">*.conf</span>;</span><br><span class="line">    <span class="comment"># 将 local 表示为上游服务器，也就是本机 8081</span></span><br><span class="line">    <span class="section">upstream</span> local &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">8081</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment"># 域名</span></span><br><span class="line">        <span class="attribute">server_name</span> xxx.pub;</span><br><span class="line">        <span class="comment"># 监听端口</span></span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理所有请求</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># 将域名也一起给到上游</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="comment"># 通过反向代理的时候，将对端地址的 IP 传到上游服务器，替代自己的 IP</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forward_for</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 使用缓存，并且指定上面开辟的共享内存</span></span><br><span class="line">            <span class="attribute">proxy_cache</span> my_cache;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 设置缓存中的 key，通常相同的网站内容可以缓存起来</span></span><br><span class="line">            <span class="attribute">proxy_cache_key</span> <span class="variable">$host</span><span class="variable">$uri</span><span class="variable">$is_args</span>&amp;args;</span><br><span class="line">            <span class="comment"># 缓存条件</span></span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">304</span> <span class="number">302</span> <span class="number">1d</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将所有请求都代理到 local</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://local;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-Go-access-实时分析-accesslog-日志"><a href="#使用-Go-access-实时分析-accesslog-日志" class="headerlink" title="使用 Go access 实时分析 accesslog 日志"></a>使用 Go access 实时分析 accesslog 日志</h2><p>通过 <code>websocket</code> 监听 <code>accesslog</code> 的实施变更，以图形化的方式分析 <code>accesslog</code> </p>
<p><span class="exturl" data-url="aHR0cHM6Ly9nb2FjY2Vzcy5pby8=">https://goaccess.io/<i class="fa fa-external-link-alt"></i></span></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-43-55-goaccess-dashboard.png" alt="img"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goaccess access.log -o report.html --log-format=COMBINED</span><br></pre></td></tr></table></figure>

<h2 id="TLS-SSL-发展"><a href="#TLS-SSL-发展" class="headerlink" title="TLS&#x2F;SSL 发展"></a>TLS&#x2F;SSL 发展</h2><p>站点通过 HTTPS 保障安全。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-27-51-image-20240319212751796.png" alt="image-20240319212751796"></p>
<h3 id="TLS-安全密码套件解读"><a href="#TLS-安全密码套件解读" class="headerlink" title="TLS 安全密码套件解读"></a>TLS 安全密码套件解读</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-29-17-image-20240319212917574.png" alt="image-20240319212917574"></p>
<ul>
<li>密钥交换算法：解决浏览器和服务器之间各自独立生成密钥，并且密钥相同</li>
<li>身份验证：浏览器和服务器之间交换密钥后验证身份</li>
<li>对称加密算法、强度、分组模式</li>
<li>签名 hash 算法</li>
</ul>
<h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-31-24-image-20240319213124644.png" alt="image-20240319213124644"></p>
<p>通常说：加密和解密，使用同一份密钥，其他人就算有密钥，但是没有加密算法也无法破译。</p>
<p>例如使用 RC4 的加密算法</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-32-31-image-20240319213231497.png" alt="image-20240319213231497"></p>
<p>使用或运算，可以加密和解密，特点是性能好。</p>
<h3 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-34-16-image-20240319213415910.png" alt="image-20240319213415910"></p>
<p>根据授权原理，生成一对密钥，分为私钥和公钥。使用公钥加密，则使用私钥解密，使用私钥加密，则使用公钥解密。</p>
<h3 id="PKI-公钥基础设施"><a href="#PKI-公钥基础设施" class="headerlink" title="PKI 公钥基础设施"></a>PKI 公钥基础设施</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-35-15-image-20240319213515766.png" alt="image-20240319213515766"></p>
<p>站点在 CA 申请证书，CA 生成一对公钥和私钥，颁发给网站站点。</p>
<p>浏览器请求时，站点会将证书发送给浏览器，浏览器会验证证书是否合法。</p>
<h3 id="证书类型"><a href="#证书类型" class="headerlink" title="证书类型"></a>证书类型</h3><ul>
<li><p>域名验证（domain validated，DV）证书，验证证书归属是否正确</p>
<p><code>https://www.xiaoyeshiyu.com</code></p>
</li>
<li><p>组织证书（organization validated，OV）证书，验证机构企业名称是否正确</p>
<p><code>https://www.baidu.com</code></p>
</li>
<li><p>扩展验证（extended validation，EV）证书，严格，但是浏览器显式支持好</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-39-54-image-20240319213954908.png" alt="image-20240319213954908"></p>
</li>
</ul>
<h3 id="证书链"><a href="#证书链" class="headerlink" title="证书链"></a>证书链</h3><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-40-52-image-20240319214052396.png" alt="image-20240319214052396" style="zoom:25%;" />

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-41-54-image-20240319214154415.png" alt="image-20240319214154415"></p>
<h2 id="TLS-通讯过程"><a href="#TLS-通讯过程" class="headerlink" title="TLS 通讯过程"></a>TLS 通讯过程</h2><p>主要分为四个部分</p>
<ol>
<li>验证身份</li>
<li>达成安全套件共识</li>
<li>传递密钥</li>
<li>加密通讯</li>
</ol>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F19%2F21-43-23-image-20240319214323670.png" alt="image-20240319214323670"></p>
<p>TLS主要做两件事：交换密钥，加密通讯。</p>
<h2 id="OpenResty-安装"><a href="#OpenResty-安装" class="headerlink" title="OpenResty 安装"></a>OpenResty 安装</h2><p><span class="exturl" data-url="aHR0cHM6Ly9vcGVucmVzdHkub3JnL2NuL2luc3RhbGxhdGlvbi5odG1s">https://openresty.org/cn/installation.html<i class="fa fa-external-link-alt"></i></span></p>
<p>官网全中文，国人开源，非常友好。</p>
<p>扩展性更好，可以使用 <code>lua</code> 直接处理请求中的内容。</p>
<h1 id="Nginx-架构基础"><a href="#Nginx-架构基础" class="headerlink" title="Nginx 架构基础"></a>Nginx 架构基础</h1><p>Nginx 运行在企业内网的最外层，处理的流量非常庞大，这也是 Nginx 的架构非常重要的原因。</p>
<h2 id="Nginx-请求处理流程"><a href="#Nginx-请求处理流程" class="headerlink" title="Nginx 请求处理流程"></a>Nginx 请求处理流程</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F10-29-54-image-20240320102954837.png" alt="image-20240320102954837"></p>
<ul>
<li>外部流量大约可以分为三种：<code>WEB</code>、<code>EMAIL</code>、<code>TCP</code></li>
<li>Nginx 中处理这三种流量是通过非阻塞模型处理，<code>epoll</code>，处理请求通过不同的状态机实现</li>
<li>当请求需要处理静态资源，则通过磁盘缓存处理，如果是反向代理的缓存内容也是从磁盘缓存中读取</li>
<li>当缓存中数据不存在，则会进入 <code>IO</code> 阻塞调用，为了提高性能，还需要使用线程池处理磁盘阻塞调用</li>
<li>请求完成后，会记录日志，也可以通过 <code>syslog</code> 协议记录到远程机器上</li>
<li>Nginx 作为负载均衡或者反响代理，将请求以协议级传递给上游服务器</li>
<li>也可以通过应用层的协议，例如 FastCGI 等代理到相应的应用服务器</li>
</ul>
<h2 id="Nginx-进程结构"><a href="#Nginx-进程结构" class="headerlink" title="Nginx 进程结构"></a>Nginx 进程结构</h2><p>Nginx 进程结构分为：</p>
<ul>
<li>单进程结构：不适合于生产环境，适合开发、调试</li>
<li>多进程结构</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F10-39-04-image-20240320103904332.png" alt="image-20240320103904332"></p>
<p>多进程结构分为：</p>
<ul>
<li>一个父进程，Master 进程</li>
<li>多个子进程，分为两类：<ul>
<li><code>Worker</code> 进程</li>
<li><code>Cache</code> 相关的进程</li>
</ul>
</li>
</ul>
<p>Nginx 采用多进程的原因是为了高可靠性。如果是多线程模型，共用一个地址空间，当其他进程出现越界时，会影响 Nginx 进程。</p>
<p>第三方开发时，通常也不会在 Master 进程中加入模块，即使 Nginx 允许。</p>
<p>Master 进程用于做管理、监控其他 Worker 进程是否正常工作，监听热部署、重加载配置等信号，其他的 Worker 进程用于管理。</p>
<p>Cache 需要让缓存在多个进程间共享，不仅需要让 Master 进程使用，还需要在 Cache manager、Cache loader 进程使用。</p>
<p>Cache manager、Cache loader 则负责使用反向代理时的缓存，Cache manager 负责管理缓存，Cache loader 负责加载缓存。</p>
<p>Nginx 的进程间通讯，使用共享内存解决。</p>
<p>为了实现高性能，Nginx 的 worker 数量通常与 CPU 个数一致，并且当 CPU 核和 worker 进程绑定后，还可以减少缓存失效，提高缓存效率。</p>
<h2 id="Nginx-进程管理：信号"><a href="#Nginx-进程管理：信号" class="headerlink" title="Nginx 进程管理：信号"></a>Nginx 进程管理：信号</h2><p>Nginx 父子进程之间，通过信号进行管理。（数据共享还是通过共享内存）</p>
<ul>
<li><p>Master 进程</p>
<ul>
<li><p>监控 Worker 进程</p>
<ul>
<li>CHLD：当 Worker 进程出现异常，会向 Master 进程发送信号，Master 检测到信号之后，会立刻将 Worker 进程拉起</li>
</ul>
</li>
<li><p>管理 Worker 进程</p>
</li>
<li><p>接收信号</p>
<ul>
<li><p>TERM，INT：立刻停止 Nginx 进程</p>
</li>
<li><p>QUIT：优雅的停止 Nginx 进程，不会向用户发送 RESET 这样的 TCP 请求</p>
</li>
<li><p>HUP：重载配置文件</p>
</li>
<li><p>USR1：重新打开日志文件，做日志文件切割</p>
<p>上面四个可以通过 <code>nginx</code> 命令行发送，下面两个只能使用 <code>kill</code> 发送信号</p>
</li>
<li><p>USR2：热部署使用，生成一个新的 Nginx Master 进程，也会新启动一些 Worker 进程，老的 Worker 进程的请求会过渡到新的 Worker 中</p>
</li>
<li><p>WINCH：热部署使用，让老 nginx Master 进程优雅关闭老的 Worker 进程</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Worker 进程：接受来自 Master 的信号（通常不会直接向 Worker 进程发送信号，而是使用 Master 进程管理，虽然直接发送也可以）</p>
<ul>
<li>TERM，INT</li>
<li>QUIT</li>
<li>USR1</li>
<li>WINCH</li>
</ul>
</li>
<li><p><code>nginx</code> 命令行：Nginx 使用命令行启动时，会将 <code>pid</code> 记录到文件中，命令行会通过文件读取 <code>pid</code>，发送相应的命令。</p>
<ul>
<li><code>reload</code>：HUP</li>
<li><code>reopen</code>：USR1</li>
<li><code>stop</code>：TERM</li>
</ul>
</li>
</ul>
<p>使用 <code>nginx</code> 命令行，跟向 <code>master</code> 进程发送信号的作用一样。</p>
<h2 id="reload-流程"><a href="#reload-流程" class="headerlink" title="reload 流程"></a>reload 流程</h2><p>Nginx 可以不停止当前进程，启动新进程，避免当前请求中断。</p>
<ol>
<li>向 Master 进程发送 HUP 信号（<code>reload</code> 命令）</li>
<li>Master 进程校验配置语法是否正确（也可以提前使用 <code>-t</code> 先检查）</li>
<li>Master 进程打开新的监听端口（如果引入了新的端口，则会新打开端口，让子进程继承）</li>
<li>Master 进程用新配置启动新的 Worker 子进程（Nginx 保证平滑，因此会先启新进程，然后再向老子进程发送信号）</li>
<li>Master 进程向老 Worker 子进程发送 QUIT 信号（先结束请求，优雅关闭子进程，即使是一些 <code>keep-alive</code> 请求）</li>
<li>老 Worker 进程关闭监听句柄，处理完当前连接后结束进程（新的连接到新的子进程）</li>
</ol>
<p>有些时候，<code>reload</code> 之后，子进程数量不会减少，这种场景出现在 <code>upstream</code> 中比较多，例如一些连接没有被客户端处理，或者 <code>websocket</code>。</p>
<p>不停机载入新配置：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-06-46-image-20240320110646429.png" alt="image-20240320110646429"></p>
<p>当出现老 Worker 进程无法停止，Nginx 提供 <code>worker_shutdown_timeout</code> 参数来及时强制结束子进程。</p>
<h2 id="热升级流程"><a href="#热升级流程" class="headerlink" title="热升级流程"></a>热升级流程</h2><ol>
<li>将旧 Nginx 二进制可执行文件替换成新 Nginx 二进制可执行文件（注意备份）</li>
<li>向 Master 进程发送 USR2 信号（其实是相当于老 Master 进程以子进程的方式启动新的 Master 进程）</li>
<li>Master 进程修改 <code>pid</code> 文件名，加后缀 <code>.oldbin</code>（给新的 Master 进程让路）</li>
<li>Master 进程用新 Nginx 文件启动新 Master 进程</li>
<li>向老 Master 进程发送 WINCH 信号，关闭老 Master</li>
<li>回滚：向老 Master 发送 HUP 信号，向新 Master 发送 QUIT 信号</li>
</ol>
<p>不停机更新 Nginx 二进制文件：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-20-13-image-20240320112013511.png" alt="image-20240320112013511"></p>
<h2 id="Worker-进程：优雅的关闭"><a href="#Worker-进程：优雅的关闭" class="headerlink" title="Worker 进程：优雅的关闭"></a>Worker 进程：优雅的关闭</h2><p>使用 <code>QUIT</code> 信号，主要针对 <code>HTTP</code> 请求</p>
<ol>
<li>设置定时器 <code>worker_shutdown_timeout</code>（针对 <code>websocket</code> 这类无法检测是否完成的请求）</li>
<li>关闭监听句柄</li>
<li>关闭空闲连接（为了保证高效，有些连接不会关闭。类似连接池原理）</li>
<li>在循环中等待全部连接关闭（发现请求完毕，则将该请求的连接关闭）</li>
<li>退出进程</li>
</ol>
<h2 id="网络收发与-Nginx-事件间的对应关系"><a href="#网络收发与-Nginx-事件间的对应关系" class="headerlink" title="网络收发与 Nginx 事件间的对应关系"></a>网络收发与 Nginx 事件间的对应关系</h2><p>网络数据包被解封装出内部的数据载荷后，进入操作系统处理</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-32-34-image-20240320113234640.png" alt="image-20240320113234640"></p>
<p>操作系统处理事件会定义一个事件收集、分发器，通过定义的一系列消费者来处理。</p>
<p>例如 Nginx 会建立很多对应的消费者处理事件，例如 连接建立事件消费者、读事件消费者、写事件消费者 等等。。。</p>
<p>读事件：</p>
<ul>
<li>Accept 建立连接（TCP 建立连接、关闭连接都是接受报文读取里面的消息）</li>
<li>Read 读消息</li>
</ul>
<p>写事件：</p>
<ul>
<li>Write 写消息</li>
</ul>
<h3 id="Nginx-事件循环"><a href="#Nginx-事件循环" class="headerlink" title="Nginx 事件循环"></a>Nginx 事件循环</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-35-51-image-20240320113551100.png" alt="image-20240320113551100"></p>
<ul>
<li>Nginx 等待连接：此时处于 <code>epoll_wait</code></li>
<li>当三次握手完成，操作系统 Kernel 通知 Nginx 开始处理请求</li>
<li>Worker 从 Kernel 中获取事件，操作系统将处理好的事件放在队列中：比如建立连接、TCP 报文</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F11-36-03-image-20240320113603464.png" alt="image-20240320113603464"></p>
<ul>
<li>处理事件是一个循环，通过判断事件队列是否为空</li>
<li>在处理事件过程中，可能还会添加一个事件，例如超时时间（浏览器在超时时间内没有发送心跳，则将这个连接关闭）</li>
</ul>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>网络事件收集器模型对比：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F14-45-33-image-20240320144533754.png" alt="image-20240320144533754"></p>
<p>使用 <code>Libevent</code> 测试，当连接数增加，Select 和 Poll 所需要的时间增加都很多。</p>
<p>这是由于 Poll 和 Select 在有大并发连接的时候，Select 一次所能处理的句柄数有限，而 Poll 无法直接处理就绪的句柄，而需要便利所有的句柄，拿到活跃的连接。而 Epoll 则可以直接处理活跃的连接。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F14-49-12-image-20240320144912013.png" alt="image-20240320144912013"></p>
<ul>
<li>前提<ul>
<li>高并发连接中，每次处理的活跃连接数量占比很小</li>
</ul>
</li>
<li>实现<ul>
<li>红黑树：任何的操作放到、取出红黑树中，操作是 <code>log(n)</code></li>
<li>链表：当网卡接受到报文，链表新增元素，从内核态读取到用户态，只读取一个节点，效率高</li>
</ul>
</li>
<li>使用<ul>
<li>创建</li>
<li>操作：添加&#x2F;修改&#x2F;删除</li>
<li>获取句柄</li>
<li>关闭</li>
</ul>
</li>
</ul>
<h2 id="请求切换"><a href="#请求切换" class="headerlink" title="请求切换"></a>请求切换</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F15-14-52-image-20240320151452328.png" alt="image-20240320151452328"></p>
<p>相比传统服务的处理模型，一个进程同时只能处理一种请求，一个请求可能会在不同的阶段交由不同的进程处理，导致频繁的进程间切换。是一个线程仅处理一个连接。不做连接切换（而是进程切换），依赖 OS 的进程调度实现并发。</p>
<p>Nginx 的 Worker 处理模型，是一线程同时处理多连接。当网络事件不满足时，则切换到另外一个事件处理。用户态代码完成连接切换；也尽量减少 OS 进程切换。</p>
<h2 id="阻塞调用"><a href="#阻塞调用" class="headerlink" title="阻塞调用"></a>阻塞调用</h2><p>操作系统在执行进程时，如果进程是阻塞调用，则当无法执行下去的时候，例如 <code>IO</code> 阻塞，CPU 会切换执行其他线程，将该线程置于睡眠状态。而非组赛则是当线程的 CPU 时间片没有使用完之前，CPU 是不会切换进程执行其他进程的。</p>
<p>而异步或者非异步，则是从编码角度和业务处理角度来说的。</p>
<h3 id="以-accept-为例"><a href="#以-accept-为例" class="headerlink" title="以 accept 为例"></a>以 accept 为例</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-16-39-image-20240320161639495.png" alt="image-20240320161639495"></p>
<p>已经完成三次握手，建立连接后，阻塞 accept 下，调用 accept 时，会直接读取套接字，而不会阻塞。但是，如果 accept 队列为空，则操作系统会等待新的三次握手连接到达内核中，然后再唤醒 accept 调用。虽然超时时间可以设置，但是阻塞过程中，也就是等待 IO 完成，会让操作系统进行进程间切换。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-19-47-image-20240320161947779.png" alt="image-20240320161947779"></p>
<p>因此 Nginx 不会使用这种调用模型。</p>
<h3 id="非阻塞调用"><a href="#非阻塞调用" class="headerlink" title="非阻塞调用"></a>非阻塞调用</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-20-07-image-20240320162007008.png" alt="image-20240320162007008"></p>
<p>如果使用非阻塞 accept 调用套接字，当 ACCEPT 队列为空，不会等待，而是立刻返回一个 EAGAIN 错误码。此时会再次调用 accept，如果 ACCEPT 队列不为空，则将套接字从 ACCEPT 队列中移出并拷贝给进程。</p>
<p>那么，当接受到 EAGAIN 错误码的时候，是直接再次调用 accept 还是处理其他的请求，会根据代码逻辑来实现。</p>
<p>Nginx 会通过异步调用其他的业务逻辑。</p>
<h3 id="非阻塞调用下的同步与异步"><a href="#非阻塞调用下的同步与异步" class="headerlink" title="非阻塞调用下的同步与异步"></a>非阻塞调用下的同步与异步</h3><p>例如反响代理的实例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">rc</span> = ngx_http_read_request_body(r, ngx_http_upstream_init) ; </span><br><span class="line"><span class="attribute">if</span> ( rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">	<span class="attribute">return</span> rc ; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nginx 反向代理考虑到上游服务的处理能力通常不足，所以如果携带 <code>body</code> 请求，Nginx 会先接收完 <code>body</code>，再去向上游服务器发起连接。</p>
<p><code>ngx_http_read_request_body</code> 方法执行完时调用 <code>post_handler</code> 异步方法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ngx_int_t</span></span><br><span class="line">ngx_http_read_client_request_body (ngx_http_request_t * r,ngx_http_client_body_handler_pt post_handler)</span><br></pre></td></tr></table></figure>

<p>最终读取完 <code>body</code> 后调用 <code>ngx_http_upstream_init</code> 方法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">void</span></span><br><span class="line">ngx_http_upstream_init (ngx_http_request_t * r ) </span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>整个过程比较复杂难懂。</p>
<p>相比而言，Openresty 提供同步调用代码</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> client = redis:new() </span><br><span class="line">client:set_timeout(<span class="number">30000</span>)</span><br><span class="line"><span class="keyword">local</span> ok,err = client:connect(ip,port)  // 同步调用，里面使用非阻塞方法</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">	ngx.say(<span class="string">&quot;failed: &quot;</span>,err)</span><br><span class="line">	<span class="keyword">return</span> </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Nginx-模块"><a href="#Nginx-模块" class="headerlink" title="Nginx 模块"></a>Nginx 模块</h2><p>Nginx 模块设计非常精良。在编译期可以将模块编译进去，而有些模块还需要在使用时打开才能使用该模块。</p>
<p>官方模块文档：<span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy8=">https://nginx.org/en/docs/<i class="fa fa-external-link-alt"></i></span></p>
<p><code>nginx</code> 模块的伪代码：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-32-23-image-20240320163223907.png" alt="image-20240320163223907"></p>
<p>可以看到，模块之间<strong>高内聚</strong>，相同的功能在一个模块中。</p>
<p>模块内部高度抽象，都提供通用方法：</p>
<ul>
<li>配置</li>
<li>启停回调方法</li>
<li>子模块抽象<ul>
<li><code>http</code></li>
<li><code>event</code></li>
<li><code>mail</code></li>
<li><code>stream</code></li>
</ul>
</li>
</ul>
<h2 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h2><p>Nginx 模块划分为不同的子模块</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-47-58-image-20240320164758250.png" alt="image-20240320164758250"></p>
<ol>
<li><p>NGX_CORE_MODULE：Nginx 核心模块</p>
<p>一下几个，本身会定义出子类型模块</p>
<ol>
<li><code>events</code>: Nginx 事件通用处理方法，内聚成 <code>events</code> 方法<ol>
<li>NGX_EVENT_MODULE：每一个模块通过下划线后缀表示具体 <code>event</code> 信息，相同的核心模块排在最前面（类似于继承和封装的思想）</li>
</ol>
</li>
<li><code>http</code><ol>
<li>NGX_HTTP_MODULE</li>
</ol>
</li>
<li><code>stream</code></li>
<li><code>mail</code></li>
</ol>
</li>
<li><p>NGX_CONF_MODULE：一个独立模块，负责解析 Nginx 的 <code>conf</code> 文件</p>
</li>
</ol>
<h2 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F16-59-48-image-20240320165947952.png" alt="image-20240320165947952"></p>
<p>在配置文件中有参数 <code>worker_connections</code>，代表创建对应长度的数组。<span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9uZ3hfY29yZV9tb2R1bGUuaHRtbCN3b3JrZXJfY29ubmVjdGlvbnM=">https://nginx.org/en/docs/ngx_core_module.html#worker_connections<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">worker_connections</span> number;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">worker_connections</span> <span class="number">512</span>;</span><br><span class="line">Context:	events</span><br></pre></td></tr></table></figure>

<blockquote>
<p>It should be kept in mind that this number includes all connections (e.g. connections with proxied servers, among others), not only connections with clients.</p>
</blockquote>
<p>数组中每一位，都代表某一个事件，不同的事件维护不同的结构体。例如 <code>connections</code>，<code>read_events</code>，<code>write_events</code>。</p>
<p>并且由于读和写是不同的事件连接，因此，当分配较大的 <code>worker_connections</code> 时，占用内存也很多。</p>
<h2 id="核心数据结构"><a href="#核心数据结构" class="headerlink" title="核心数据结构"></a>核心数据结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_event_s</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>            *data;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         write:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         accept:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* used to detect the stale events in kqueue and epoll */</span></span><br><span class="line">    <span class="type">unsigned</span>         instance:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the event was passed or would be passed to a kernel;</span></span><br><span class="line"><span class="comment">     * in aio mode - operation was posted.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span>         active:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         disabled:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the ready event; in aio mode 0 means that no operation can be posted */</span></span><br><span class="line">    <span class="type">unsigned</span>         ready:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         oneshot:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* aio operation is complete */</span></span><br><span class="line">    <span class="type">unsigned</span>         complete:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         eof:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span>         error:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         timedout:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span>         timer_set:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         delayed:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         deferred_accept:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the pending eof reported by kqueue, epoll or in aio chain operation */</span></span><br><span class="line">    <span class="type">unsigned</span>         pending_eof:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         posted:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         closed:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* to test on worker exit */</span></span><br><span class="line">    <span class="type">unsigned</span>         channel:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span>         resolver:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>         cancelable:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_KQUEUE)</span></span><br><span class="line">    <span class="type">unsigned</span>         kq_vnode:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the pending errno reported by kqueue */</span></span><br><span class="line">    <span class="type">int</span>              kq_errno;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * kqueue only:</span></span><br><span class="line"><span class="comment">     *   accept:     number of sockets that wait to be accepted</span></span><br><span class="line"><span class="comment">     *   read:       bytes to read when event is ready</span></span><br><span class="line"><span class="comment">     *               or lowat when event is set with NGX_LOWAT_EVENT flag</span></span><br><span class="line"><span class="comment">     *   write:      available space in buffer when event is ready</span></span><br><span class="line"><span class="comment">     *               or lowat when event is set with NGX_LOWAT_EVENT flag</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * iocp: TODO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * otherwise:</span></span><br><span class="line"><span class="comment">     *   accept:     1 if accept many, 0 otherwise</span></span><br><span class="line"><span class="comment">     *   read:       bytes to read when event is ready, -1 if not known</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>              available;</span><br><span class="line"></span><br><span class="line">    ngx_event_handler_pt  handler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_IOCP)</span></span><br><span class="line">    <span class="type">ngx_event_ovlp_t</span> ovlp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>       index;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_log_t</span>       *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_rbtree_node_t</span>   timer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the posted queue */</span></span><br><span class="line">    <span class="type">ngx_queue_t</span>      <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the threads support */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the event thread context, we store it here</span></span><br><span class="line"><span class="comment">     * if $(CC) does not understand __thread declaration</span></span><br><span class="line"><span class="comment">     * and pthread_getspecific() is too costly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>            *thr_ctx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_EVENT_T_PADDING)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* event should not cross cache line in SMP */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span>         padding[NGX_EVENT_T_PADDING];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_connection_s</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>               *data;</span><br><span class="line">    <span class="type">ngx_event_t</span>        *read; <span class="comment">// 读事件</span></span><br><span class="line">    <span class="type">ngx_event_t</span>        *write; <span class="comment">// 写事件</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_socket_t</span>        fd;</span><br><span class="line"></span><br><span class="line">    ngx_recv_pt         recv; <span class="comment">// 抽象解耦 OS 底层方法</span></span><br><span class="line">    ngx_send_pt         send; <span class="comment">// 抽象解耦 OS 底层方法</span></span><br><span class="line">    ngx_recv_chain_pt   recv_chain;</span><br><span class="line">    ngx_send_chain_pt   send_chain;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_listening_t</span>    *listening;</span><br><span class="line"></span><br><span class="line">    <span class="type">off_t</span>               sent; <span class="comment">// bytes_sent 变量</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_log_t</span>          *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_pool_t</span>         *pool; <span class="comment">// 初始 connections_pool_size 配置</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>                 type;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">sockaddr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span>           socklen;</span><br><span class="line">    <span class="type">ngx_str_t</span>           addr_text;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_proxy_protocol_t</span>  *proxy_protocol;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_QUIC || NGX_COMPAT)</span></span><br><span class="line">    <span class="type">ngx_quic_stream_t</span>     *quic;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_SSL || NGX_COMPAT)</span></span><br><span class="line">    <span class="type">ngx_ssl_connection_t</span>  *ssl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_udp_connection_t</span>  *udp;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>    *<span class="title">local_sockaddr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span>           local_socklen;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_buf_t</span>          *buffer;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_queue_t</span>         <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_atomic_uint_t</span>   number;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_msec_t</span>          start_time;</span><br><span class="line">    <span class="type">ngx_uint_t</span>          requests;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-06-09-image-20240320170609268.png" alt="image-20240320170609268"></p>
<h2 id="内存池"><a href="#内存池" class="headerlink" title="内存池"></a>内存池</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-13-27-image-20240320171327210.png" alt="image-20240320171327210"></p>
<p>虽然 Nginx 使用 C语言写，自带内存池管理，不需要关注内存的申请和释放，但是也提供修改内存池大小，以供在特殊情况下处理请求和连接所需要的内存分配。</p>
<p>在 <code>ngx_connection_s</code> 中，<code>ngx_pool_t</code> 字段指向内存池，使用内存池的优势是减少内存碎片的大小。</p>
<p>当使用小块内存时，使用 <code>next</code> 指针连接在一起。</p>
<p>当分配大块内存时，还是会经过操作系统的 <code>alloc</code> 来进行分配。</p>
<p>内存池分为两种：</p>
<ul>
<li>连接内存池：当处理 <code>keep-alive</code> 请求时，一个连接会重复使用处理多个请求，当请求结束时，连接才关闭。</li>
<li>请求内存池：对于 HTTP 1.1 请求而言，一般会分配 <code>4k</code> 大小的内存，用于存放 <code>uri</code> 和 <code>header</code>。</li>
</ul>
<p>对于第三方开发而言，实现内存池后，无需管理内存，而只需要知道是从连接内存池获取内存还是请求内存池获取内存。</p>
<p>通过设置内存池大小，可以提前预分配，减少后续分配的次数。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjY29ubmVjdGlvbl9wb29sX3NpemU=">https://nginx.org/en/docs/http/ngx_http_core_module.html#connection_pool_size<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">connection_pool_size</span> size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">connection_pool_size</span> <span class="number">256</span>|<span class="number">512</span>;</span><br><span class="line">Context:	http, server</span><br></pre></td></tr></table></figure>

<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjcmVxdWVzdF9wb29sX3NpemU=">https://nginx.org/en/docs/http/ngx_http_core_module.html#request_pool_size<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">request_pool_size</span> size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">request_pool_size</span> <span class="number">4k</span>;</span><br><span class="line">Context:	http, server</span><br></pre></td></tr></table></figure>

<p><code>connection_pool_size</code> 默认 512 字节（64位），这是由于连接需要保存的上下文信息较少。</p>
<p><code>request_pool_size</code> 默认 4k，是由于对于连接而言，请求需要保存 <code>uri</code> 和 <code>header</code> 之类的。</p>
<h2 id="Nginx-进程间的通讯方式"><a href="#Nginx-进程间的通讯方式" class="headerlink" title="Nginx 进程间的通讯方式"></a>Nginx 进程间的通讯方式</h2><p>也就是所有 Worker 进程协同工作的关键。</p>
<p>Nginx 进程间通讯的方式有两种：</p>
<ul>
<li>信号：Master 进程管理 Worker 进程</li>
<li>共享内存：开辟一块内存空间，所有的 Worker 共享使用，可以读取写入</li>
</ul>
<p>为了使用好一块内存空间，则会引发两个问题：</p>
<ol>
<li>锁：解决数据竞态（使用自旋锁替代信号量，避免进程陷入阻塞和进程切换，再切换回来导致上下文切换）</li>
<li>Slab 内存管理器：降低进程使用内存的复杂性</li>
</ol>
<h3 id="共享内存：跨-Worker-进程通讯"><a href="#共享内存：跨-Worker-进程通讯" class="headerlink" title="共享内存：跨 Worker 进程通讯"></a>共享内存：跨 Worker 进程通讯</h3><p>共享内存使用者：</p>
<ul>
<li><p>官方模块</p>
<ul>
<li><p>ngx_http_lua_api</p>
</li>
<li><p>rbtree</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-00-image-20240320174200080.png" alt="image-20240320174200080"></p>
</li>
<li><p>单链表</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-17-image-20240320174217530.png" alt="image-20240320174217530"></p>
</li>
</ul>
</li>
</ul>
<h3 id="OpenResty-共享内存代码示例"><a href="#OpenResty-共享内存代码示例" class="headerlink" title="OpenResty 共享内存代码示例"></a>OpenResty 共享内存代码示例</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F20%2F17-42-47-image-20240320174247606.png" alt="image-20240320174247606"></p>
<h2 id="Slab-内存管理"><a href="#Slab-内存管理" class="headerlink" title="Slab 内存管理"></a>Slab 内存管理</h2><p>虽然可以通过共享内存，将数据存储在红黑树中，但是，具体实现小块内存分配还需要一些方法。一般来说，为了高效管理内存，还需要将内存划分为不同大小的小块，以便更好的利用内存，</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-00-34-image-20240320200034481.png" alt="image-20240320200034481"></p>
<p>大片内存按照 <code>slot</code> 分配，<code>slot</code> 按照两倍增加，8byte、16byte等。</p>
<ul>
<li><code>Bestfit</code> 分配方式<ul>
<li>最多两倍内存分配</li>
</ul>
</li>
<li><code>Bestfit</code> 优势<ul>
<li>适合小对象</li>
<li>避免碎片</li>
<li>避免重复初始化</li>
</ul>
</li>
</ul>
<h3 id="ngx-slab-stat-统计-Slab-使用状态"><a href="#ngx-slab-stat-统计-Slab-使用状态" class="headerlink" title="ngx_slab_stat 统计 Slab 使用状态"></a>ngx_slab_stat 统计 Slab 使用状态</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-02-55-image-20240320200255105.png" alt="image-20240320200255105"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly90ZW5naW5lLnRhb2Jhby5vcmcvZG9jdW1lbnRfY24vbmd4X3NsYWJfc3RhdF9jbi5odG1s">https://tengine.taobao.org/document_cn/ngx_slab_stat_cn.html<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="Nginx-容器"><a href="#Nginx-容器" class="headerlink" title="Nginx 容器"></a>Nginx 容器</h2><p>Nginx 容器是很多高级功能的基础。</p>
<ul>
<li>数组：多块连续内存</li>
<li>链表</li>
<li>队列</li>
<li><strong>哈希表</strong></li>
<li><strong>红黑树</strong></li>
<li>基数树</li>
</ul>
<h3 id="Nginx-哈希表"><a href="#Nginx-哈希表" class="headerlink" title="Nginx 哈希表"></a>Nginx 哈希表</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-07-32-image-20240320200732364.png" alt="image-20240320200732364"></p>
<p>将用户结构体放在一块连续的内存中。</p>
<h3 id="哈希表配置"><a href="#哈希表配置" class="headerlink" title="哈希表配置"></a>哈希表配置</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-09-17-image-20240320200917592.png" alt="image-20240320200917592"></p>
<p>一般应用于静态不变的内容。不会删除和移动。</p>
<p>在开始使用的时候，就可以确定 Bucket size 和 Max size。</p>
<p>使用场景：例如 Nginx 中的一些变量，反向代理的数据等。</p>
<p>由于 CPU 往 L1、L2、L3 Cache 中读取数据按照机器字为单位，所以 Bucket size 会有 CPU 内存对齐。</p>
<h3 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h3><p>红黑树是一个查找二叉树。同时，高度差不会太大。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-12-46-image-20240320201246522.png" alt="image-20240320201246522"></p>
<p>自平衡二叉查找树：</p>
<ul>
<li>高度不会超过 2 倍数 <code>log(n)</code></li>
<li>增删改查算法复杂度 <code>O(log(n))</code></li>
<li>便利复杂度 <code>O(n)</code></li>
</ul>
<h3 id="红黑树的使用模块"><a href="#红黑树的使用模块" class="headerlink" title="红黑树的使用模块"></a>红黑树的使用模块</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-14-29-image-20240320201429641.png" alt="image-20240320201429641"></p>
<p>红黑树一般会用于：</p>
<ol>
<li>管理定时器计时器</li>
<li>管理共享内存的红黑树</li>
</ol>
<h2 id="动态模块-减少编译环节"><a href="#动态模块-减少编译环节" class="headerlink" title="动态模块-减少编译环节"></a>动态模块-减少编译环节</h2><p>在不使用动态模块时，编译 Nginx 的过程：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-16-25-image-20240320201625382.png" alt="image-20240320201625382"></p>
<p>将 Nginx 官方模块源码和第三方模块源码放在一起编译。</p>
<p>使用动态模块：<code>load_module modules/ngx_http_image_filter_module.so;</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-17-36-image-20240320201736030.png" alt="image-20240320201736030"></p>
<p>除了生成可执行二进制文件，还会生成一个共享的动态库。</p>
<p>静态库：将所有源代码编译到可执行文件中</p>
<p>动态库：在二进制可执行文件中保留库文件位置，在需要用到动态库功能时，需要 Nginx 可执行文件调用动态库文件</p>
<p>好处是：如果编译了大量第三方文件，可以仅仅编译第三方动态库文件进行替换，Nginx reload 就行，而不需要重新编译和启动 Nginx。</p>
<ol>
<li>Configure 加入动态模块（不是所有的模块可以以动态模块的方式加入）；</li>
<li>编译进 binary（调用 make 命令）</li>
<li>启动时初始化模块数组</li>
<li>读取 <code>load_module</code> 配置</li>
<li>打开动态库并加入模块数组</li>
<li>基于模块数组开始初始化</li>
</ol>
<h1 id="详解-HTTP-模块"><a href="#详解-HTTP-模块" class="headerlink" title="详解 HTTP 模块"></a>详解 HTTP 模块</h1><p>配置文件中核心的配置模块。</p>
<h2 id="配置块的嵌套"><a href="#配置块的嵌套" class="headerlink" title="配置块的嵌套"></a>配置块的嵌套</h2><p>例如下面的配置块，存在嵌套关系。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在大括号外面的是 main，一般放整个系统的配置，例如 日志、worker 数</span></span><br><span class="line"><span class="attribute">main</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理请求模块</span></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">	<span class="section">upstream</span> &#123; ... &#125; </span><br><span class="line">	<span class="section">split_clients</span> &#123;...&#125; </span><br><span class="line">	<span class="section">map</span> &#123;...&#125;</span><br><span class="line">	<span class="section">geo</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">if</span> () &#123;...&#125;</span><br><span class="line"></span><br><span class="line">		<span class="section">location</span> &#123;</span><br><span class="line">			<span class="section">limit_except</span> &#123;...&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="section">location</span> &#123;</span><br><span class="line">			<span class="section">location</span> &#123;</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="section">server</span> &#123; </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指令的-Context"><a href="#指令的-Context" class="headerlink" title="指令的 Context"></a>指令的 Context</h3><p>例如下面管理 <code>log</code> 的模块指令</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="attribute">log_format</span> name [escape=default|json|<span class="literal">none</span>] string ...;</span><br><span class="line">Default: <span class="attribute">log_format</span> combined <span class="string">&quot;...&quot;</span>;</span><br><span class="line">Context: <span class="attribute">http</span></span><br><span class="line"></span><br><span class="line">Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]]; </span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">Default: <span class="attribute">access_log</span> logs/access.log combined;</span><br><span class="line">Context: http, server, <span class="section">location</span>, if in <span class="section">location</span>, limit_except</span><br></pre></td></tr></table></figure>

<p>Context 代表指令能出现的块。例如 <code>log_format</code> 只能出现在 <code>http</code> 块下，<code>access_log</code> 则可以出现在 <code>http, server, location, if in location, limit_except</code> 中。出现在其他地方就会报错。</p>
<h3 id="指令的合并"><a href="#指令的合并" class="headerlink" title="指令的合并"></a>指令的合并</h3><p>指令出现在多个块中，可以合并。</p>
<ul>
<li><p>值指令：存储配置项的值。可以合并，例如：</p>
<ul>
<li><code>root</code></li>
<li><code>access_log</code></li>
<li><code>gzip</code></li>
</ul>
</li>
<li><p>动作类指令：指定行为。不可以合并，例如：</p>
<ul>
<li><code>rewrite</code></li>
<li><code>proxy_pass</code></li>
</ul>
<p>生效阶段</p>
<ul>
<li><code>server_rewrite</code> 阶段</li>
<li><code>rewrite</code> 节点</li>
<li><code>content</code> 阶段</li>
</ul>
</li>
</ul>
<h3 id="存储值的指令继承规则：向上覆盖"><a href="#存储值的指令继承规则：向上覆盖" class="headerlink" title="存储值的指令继承规则：向上覆盖"></a>存储值的指令继承规则：向上覆盖</h3><p>子配置不存在时，直接使用父配置块。</p>
<p>子配置存在时，直接覆盖父配置块。</p>
<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">	<span class="comment"># listen 只能出现在 server 中</span></span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">	<span class="comment"># 定义了 root</span></span><br><span class="line">	<span class="attribute">root</span> /home/geek/nginx/html;</span><br><span class="line">	<span class="attribute">access_log</span> logs/geek.access.log main; </span><br><span class="line">	<span class="section">location</span> /test &#123;</span><br><span class="line">		<span class="comment"># 又重新定义了，则使用子配置</span></span><br><span class="line">		<span class="attribute">root</span> /home/geek/nginx/test;</span><br><span class="line">		<span class="attribute">access_log</span> logs/access.test.log main; </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="section">location</span> /dlib &#123; </span><br><span class="line">		<span class="attribute">alias</span> dlib/;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="comment"># 这里没有指定 root，就可以使用父配置块</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HTTP-模块合并配置的实现"><a href="#HTTP-模块合并配置的实现" class="headerlink" title="HTTP 模块合并配置的实现"></a>HTTP 模块合并配置的实现</h3><p>当第三方模块没有详细文档说明模块配置是否可以合并时，可以通过下面的方法判断：</p>
<ul>
<li><p>指令在哪个块下生效</p>
</li>
<li><p>指令允许出现在哪些块下</p>
</li>
<li><p>在 <code>server</code> 块内生效，从 <code>http</code> 向 <code>server</code> 合并指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *(*merge_srv_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev, <span class="type">void</span> *conf);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置缓存在内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *(*merge_loc_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev, <span class="type">void</span> *conf);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h2><h3 id="Listen-指令"><a href="#Listen-指令" class="headerlink" title="Listen 指令"></a>Listen 指令</h3><p>一般用于指定监听端口或者地址</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjbGlzdGVu">https://nginx.org/en/docs/http/ngx_http_core_module.html#listen<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">listen</span> address[:port] [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> port [default_server] [ssl] [http2 | quic] [proxy_protocol] [setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [ipv6only=<span class="literal">on</span>|<span class="literal">off</span>] [reuseport] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line"><span class="attribute">listen</span> unix:path [default_server] [ssl] [http2 | quic] [proxy_protocol] [backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind] [so_keepalive=<span class="literal">on</span>|<span class="literal">off</span>|[keepidle]:[keepintvl]:[keepcnt]];</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">80</span> | *:<span class="number">8000</span>;</span><br><span class="line">Context:	server</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 地址和端口</span><br><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1:8000</span>;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1</span>;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line"><span class="attribute">listen</span> *:<span class="number">8000</span>;</span><br><span class="line"><span class="attribute">listen</span> localhost:<span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">// <span class="attribute">ipv6</span></span><br><span class="line">listen [::]:<span class="number">8000</span>;</span><br><span class="line"><span class="attribute">listen</span> [::<span class="number">1</span>];</span><br><span class="line"><span class="comment"># 监听 unix sock，相比网络调用，本级上效率更高</span></span><br><span class="line"><span class="attribute">listen</span> unix:/var/run/nginx.sock;</span><br></pre></td></tr></table></figure>

<h3 id="接收请求事件模块"><a href="#接收请求事件模块" class="headerlink" title="接收请求事件模块"></a>接收请求事件模块</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-43-32-image-20240320204332742.png" alt="image-20240320204332742"></p>
<p>三次握手成功后，建立连接后，Worker 会根据自身负载均衡算法，选择一个 Worker 处理请求。</p>
<p>Worker 进程通过 Epoll_wait 方法获取连接好的句柄，通过这个读事件，调用  accept 方法，给这个连接分配 512 字节（初始大小）大小的连接内存池。</p>
<p>HTTP 模块从事件模块接手请求处理过程，此时会通过 <code>ngx_http_init_connection</code> 设置回调方法（<code>ngx_http_wait_request_handler</code> 方法，是为后续处理数据时执行），加入到 读事件中，并且添加超时定时器（<code>client_header_timeout</code>）。完后 Nginx 切换到其他的 <code>fd</code> 事件处理。</p>
<p>浏览器开发发送请求，通过监听 <code>epoll_wait</code> 事件，执行前面的回调函数，将内核中的 <code>data</code> 读取到用户态的内存中，从连接内存池中分配 1k（<code>client_header_buffer_size</code>）的内存大小。</p>
<p>当数据超过 1k，则需要在处理请求时解决。</p>
<h3 id="接收请求-HTTP-模块"><a href="#接收请求-HTTP-模块" class="headerlink" title="接收请求 HTTP 模块"></a>接收请求 HTTP 模块</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F20%2F20-43-57-image-20240320204357215.png" alt="image-20240320204357215"></p>
<ol>
<li>先分配请求内存池，默认 4k（ <code>client_header_buffer_size</code> 的8倍 ），不能过多，否则性能会下降</li>
<li>在状态机中，解析请求行（<code>uri</code>、协议等）</li>
<li>如果超过 1k 的内存大小，则分配更大的内存。（一般用于解决 <code>uri</code> 太长）<code>large_client_header_buffers:4 8k</code> 的意思是先分配 8k，然后将前面 1k 的内容拷贝过来，再用剩下的 7k 接受请求。如果 <code>uri</code> 很长，还没有接受完，则分配第二个 8k，继续在状态机中解析请求行。最多分配 <code>32k</code></li>
<li>解析完 <code>uri</code> 之后，例如解析到 <code>\r\n</code>，就标识 <code>uri</code>，标识的目的是使用指针指向 <code>uri</code>（性能高）</li>
<li>开始接收 <code>header</code>，<code>header</code> 可能很长，例如有 <code>cookie</code>、<code>host</code> 等字段</li>
<li>状态机中解析 <code>header</code></li>
<li>开始分配大内存，分配的内容会复用 <code>large_client_header_buffers</code> 的配置，跟 <code>uri</code> 公用这个内容大小</li>
<li>标识 <code>header</code>，代表收到所有的 <code>header</code></li>
<li>移除超时定时器，也就是连接建立后，还没有开始处理请求前设置的 <code>client_header_timeout</code></li>
<li>开始核心的过程，11个阶段的 <code>http</code> 请求处理</li>
</ol>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>在写域名或者 <code>location</code> 时，可以通过正则表达式提供更强大的用法。</p>
<h3 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h3><p>常用的元字符：</p>
<ul>
<li><code>.</code>：匹配除换行符意外的任意字符</li>
<li><code>\w</code>：匹配字母数字或下划线或汉字</li>
<li><code>\s</code>：匹配任意的空白符</li>
<li><code>\d</code>：匹配数字</li>
<li><code>\b</code>：匹配单词的开始或结束</li>
<li><code>^</code>：匹配字符串的开始</li>
<li><code>&amp;</code>：匹配字符串的结束</li>
</ul>
<h3 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h3><ul>
<li><code>*</code>：重复零次或更多次</li>
<li><code>+</code>：重复一次或更多次</li>
<li><code>?</code>：重复零次或一次</li>
<li><code>&#123;n&#125;</code>：重复 n 次</li>
<li><code>&#123;n,&#125;</code>：重复 n 次或更多次</li>
<li><code>&#123;n,m&#125;</code>：重复 n 到 m 次</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><code>\</code>：转义符号，取消元字符的特殊含义</li>
<li><code>()</code>：分组与取值</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">原始url：/admin/website/article/35/change/uploads/party/5.jpg </span><br><span class="line">转换后的url: /static/uploads/party/5.jpg</span><br><span class="line"></span><br><span class="line">匹配原始 url 的正则表达式：</span><br><span class="line">\/admin\/website\/article\/(\d+)\/change\/uploads\/(\w+)\/(\w+)\.(png|jpg|gif|jpeg|b mp)$/</span><br><span class="line">rewrite^/admin/website/solution/(\d+)/change/uploads/(.*)\.(png|jpg|gif|jpeg|bmp)$ /static/uploads/<span class="variable">$2</span>/<span class="variable">$3</span>.<span class="variable">$4</span> last;</span><br></pre></td></tr></table></figure>

<p>避免测试需要重复重启 Nginx，可以使用 <code>pcre</code> 工具进行校验：<span class="exturl" data-url="aHR0cHM6Ly93d3cucGNyZS5vcmcvb3JpZ2luYWwvZG9jL2h0bWwvcGNyZXRlc3QuaHRtbA==">https://www.pcre.org/original/doc/html/pcretest.html<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="server-指令块"><a href="#server-指令块" class="headerlink" title="server 指令块"></a>server 指令块</h2><h3 id="server-name-指令"><a href="#server-name-指令" class="headerlink" title="server_name 指令"></a>server_name 指令</h3><ol>
<li><p>跟多个域名，第 1 个是主域名</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server_name</span> www.xiaoyeshiyu.com</span><br></pre></td></tr></table></figure>

<p>当有多个域名时，可以通过 <code>server_name_in_redirect on</code> 将返回的 <code>Location</code> 为主域名。</p>
</li>
<li><p>泛域名：仅支持在最前或者最后</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server_name</span> <span class="regexp">*.xiaoyeshiyu.com</span> <span class="regexp">www.xiaoyeshiyu.*</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>正则表达式：加 <code>~</code> 前缀</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server_name</span> www.xiaoyeshiyu.com ~^www\d+\.xiaoyeshiyu\.com$;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用正则表达式创建变量：用小括号</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">server_name</span> ~^(www\.)?(.+)$;</span><br><span class="line">  <span class="comment"># $2 指的是上面命令产生的两个变量中的第二个，例如如果是 www.xiaoyeshiyu.com,则 $2 是 xiaoyeshiyu.com</span></span><br><span class="line">	<span class="section">location</span> / &#123; <span class="attribute">root</span> /sites/<span class="variable">$2</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># 命名变量，后面可以使用 $domain 这个变量</span></span><br><span class="line">	<span class="attribute">server_name</span> ~^(www\.)?(?&lt;domain&gt;.+)$;</span><br><span class="line">	<span class="section">location</span> / &#123; <span class="attribute">root</span> /sites/<span class="variable">$domain</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>.xiaoyeshiyu.com</code> 可以匹配 <code>xiaoyeshiyu.com</code>，<code>*.xiaoyeshiyu.com</code></p>
</li>
<li><p><code>_</code> 匹配所有</p>
</li>
<li><p><code>&quot;&quot;</code> 匹配没有传递 Host 头部</p>
</li>
</ol>
<h3 id="server-匹配顺序"><a href="#server-匹配顺序" class="headerlink" title="server 匹配顺序"></a>server 匹配顺序</h3><ol>
<li>精确匹配</li>
<li><code>*</code> 在前的泛域名</li>
<li><code>*</code> 在后的泛域名</li>
<li>按文件中的顺序匹配正则表达式域名</li>
<li><code>default server</code><ol>
<li>第一个</li>
<li><code>listen</code> 指定 <code>default</code></li>
</ol>
</li>
</ol>
<h2 id="HTTP-请求处理时的-11-个阶段"><a href="#HTTP-请求处理时的-11-个阶段" class="headerlink" title="HTTP 请求处理时的 11 个阶段"></a>HTTP 请求处理时的 11 个阶段</h2><p>Nginx 所有的模块只能在定义的 11 个阶段生效。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-12-12-image-20240322151212664.png" alt="image-20240322151212664"></p>
<ol>
<li>当一个请求进入到 Nginx 中，首先获取请求头，并且决定用哪个 <code>server</code> 块指令处理</li>
<li>确认哪个配置块生效</li>
<li>判断是否限流</li>
<li>验证请求是否是盗链，或者通过 <code>auth</code> 协议验证</li>
<li>生成用户响应信息</li>
<li>如果是转发请求到上游，还需要上游返回结果生成用户响应信息</li>
<li>如果这个过程中产生子请求或者重定向，那么接续前面几个阶段</li>
<li>返回请求时，会经过过滤模块，例如压缩、图片处理</li>
<li>返回给用户时，也会记录日志信息</li>
</ol>
<p>具体流程以及对应的模块：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-12-35-image-20240322151234928.png" alt="image-20240322151234928"></p>
<p>请求会从上到下，依次一个一个执行。</p>
<h3 id="11-个阶段顺序处理"><a href="#11-个阶段顺序处理" class="headerlink" title="11 个阶段顺序处理"></a>11 个阶段顺序处理</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-22-00-image-20240322152200841.png" alt="image-20240322152200841"></p>
<p>灰色由 Nginx 框架执行，蓝色由其他框架或者第三方框架执行。</p>
<h3 id="POSTREAD-阶段"><a href="#POSTREAD-阶段" class="headerlink" title="POSTREAD 阶段"></a>POSTREAD 阶段</h3><p>在这个阶段可以获取到真实的用户 IP 地址。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F15-27-35-image-20240322152735010.png" alt="image-20240322152735010"></p>
<ol>
<li>TCP 连接四元组（<code>src ip, src port, dst ip, dst port</code>）</li>
<li>HTTP 头部 <code>X-Forwarded-For</code> 用于传递 IP，会往后面加 IP </li>
<li>HTTP 头部 <code>X-Real-IP</code> 用于传递用户 IP，只能存放一个 IP</li>
<li>网络中存在许多反响代理</li>
</ol>
<p>拿到用户真实 IP 后，可以基于变量来使用，做一些限流的作用。</p>
<p>如 <code>binary_remote_addr</code>、<code>remote_addr</code> 这样的变量，其值就为真实的 IP（<code>X-Real-IP</code>），这样做连接限制（<code>limit_conn</code> 模块）。</p>
<h4 id="realip-模块"><a href="#realip-模块" class="headerlink" title="realip 模块"></a>realip 模块</h4><p>用于将客户端地址和可选端口更改为指定标头字段中发送的地址。</p>
<p>默认情况下，<code>realip</code> 模块不会编译进 Nginx，通过 <code>--with-http_realip_module</code> 启用功能。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3JlYWxpcF9tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_realip_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p><code>realip</code> 模块生效的前提是：直接连接 <code>nginx</code> 的<code>ip</code>是在<code>set_real_ip_from</code>中指定的。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义已知发送正确替换地址的受信任地址。如果指定了特殊值 unix:，则所有 UNIX 域套接字将被信任。也可以使用主机名来指定受信任地址（1.13.1）。</span></span><br><span class="line"><span class="comment"># 也就是告诉上游服务器，这个 IP 地址是我本机可信任的地址</span></span><br><span class="line">Syntax:	<span class="attribute">set_real_ip_from</span> address | CIDR | unix:;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义请求头字段，其值将用于替换客户端地址。</span></span><br><span class="line"><span class="comment"># 也就是告诉上游服务器，X-Real-IP 里面存放的是真实的客户端地址</span></span><br><span class="line">Syntax:	real_ip_header field | X-Real-IP | X-Forwarded-For | proxy_protocol;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">real_ip_header</span> X-Real-IP;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果禁用递归搜索，则将与受信任地址之一匹配的原始客户端地址替换为由real_ip_header指令定义的请求头字段中发送的最后一个地址。如果启用了递归搜索，则将与受信任地址之一匹配的原始客户端地址替换为请求头字段中发送的最后一个非受信任地址。</span></span><br><span class="line"><span class="comment"># 当real_ip_recursive为off时，nginx会把real_ip_header指定的HTTP头中的最后一个IP当成真实IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当real_ip_recursive为on时，nginx会把real_ip_header指定的HTTP头中的最后一个不是信任服务器的IP当成真实IP</span></span><br><span class="line">Syntax:	real_ip_recursive on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">real_ip_recursive</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in versions <span class="number">1</span>.<span class="number">3</span>.<span class="number">0</span> and <span class="number">1</span>.<span class="number">2</span>.<span class="number">1</span>.</span><br></pre></td></tr></table></figure>

<h3 id="REWRITE-阶段"><a href="#REWRITE-阶段" class="headerlink" title="REWRITE 阶段"></a>REWRITE 阶段</h3><p>会在 <code>SERVER_REWRITE</code> 阶段（对应 <code>server</code> 配置块下）、<code>REWRITE</code> （对应 <code>location</code> 配置块下）、<code>POST_REWRITE</code>阶段生效</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWwjcmV3cml0ZQ==">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">rewrite</span> regex replacement [flag];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span>, if</span><br></pre></td></tr></table></figure>

<h4 id="return-指令"><a href="#return-指令" class="headerlink" title="return 指令"></a>return 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWwjcmV0dXJu">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#return<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">return</span> code [text];</span><br><span class="line"><span class="attribute">return</span> code URL;</span><br><span class="line"><span class="attribute">return</span> URL;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span>, if</span><br></pre></td></tr></table></figure>

<ul>
<li>返回状态码<ul>
<li>Nginx 自定义<ul>
<li>例如 444: 关闭连接</li>
</ul>
</li>
<li>HTTP 1.0 标准<ul>
<li>301: http 1.0 永久重定向，缓存在浏览器中</li>
<li>302: 临时重定向，禁止被缓存</li>
</ul>
</li>
<li>HTTP 1.1 标准<ul>
<li>303: 临时重定向，允许改变方法，禁止被缓存</li>
<li>307: 临时重定向，不允许改变方法，禁止被缓存</li>
<li>308: 永久重定向，不允许改变方法</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="error-page-指令"><a href="#error-page-指令" class="headerlink" title="error_page 指令"></a>error_page 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjZXJyb3JfcGFnZQ==">https://nginx.org/en/docs/http/ngx_http_core_module.html#error_page<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">error_page</span> code ... [=[response]] uri;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span>, if in <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>与 <code>return</code> 有关联。用法是<strong>收到</strong>（这里注意是收到，而不是产生）一个返回码时，可以重定向为另外一个 URL 或者指定返回不一样的内容。</p>
<p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /empty.gif;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> = /<span class="number">404</span>.php;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">	<span class="attribute">error_page</span> <span class="number">404</span> = <span class="variable">@fallback</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> <span class="variable">@fallback</span> &#123;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">403</span> http://example.com/forbidden.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">301</span> http://example.com/notfound.html;</span><br></pre></td></tr></table></figure>

<p>当出现 <code>return</code> 的时候，<code>error_page</code> 的 <code>404</code> 是否能执行</p>
<p>在 <code>server</code> 下和在 <code>location</code> 下出现 <code>return</code>，是否合并和如何生效。</p>
<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">server_name</span> return.xiaoyeshiyu.com;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">	<span class="attribute">root</span> html/;</span><br><span class="line">	<span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">403</span>.html;</span><br><span class="line">  </span><br><span class="line">	<span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">  </span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">404</span> <span class="string">&quot;find nothing!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果有 <code>return</code> 指令，则直接返回对应信息，而不会返回 <code>error_page</code>；没有 <code>return</code> 指令，而是直接返回 404 状态码，则会被 <code>rewrite</code> 到 <code>error_page</code></li>
<li>在 <code>server</code> 模块下的 <code>return</code> 指令，是在 <code>SERVER_REWRITE</code> 阶段执行，先于 <code>location</code> 模块下的 <code>return</code> 指令在 <code>REWRITE</code> 阶段执行</li>
</ol>
<h4 id="rewrite-指令"><a href="#rewrite-指令" class="headerlink" title="rewrite 指令"></a>rewrite 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWwjcmV3cml0ZQ==">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">rewrite</span> regex replacement [flag];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span>, if</span><br></pre></td></tr></table></figure>

<ul>
<li>将 <code>regex</code> 指定的 <code>url</code> 替换成 <code>replacement</code> 这个新的 <code>url</code><ul>
<li>可以使用正则表达式及变量提取</li>
</ul>
</li>
<li>当 <code>replacement</code> 以 <code>http://</code> 或者 <code>https://</code> 或者 <code>$schema</code> 开头，则直接返回 <code>302</code> 重定向</li>
<li>替换后的 url 根据 flag 指定的方式进行处理<ul>
<li><code>--last</code>：意思是持续，用 <code>replacement</code> 这个 <code>URI</code> 进行新的 <code>location</code> 匹配</li>
<li><code>--break</code>：表示停止，停止当前脚本指令的执行，等价于独立的 <code>break</code> 指令，<code>break</code> 后面的指定都不会执行</li>
<li><code>--redirect</code>：返回 302 重定向</li>
<li><code>--permanent</code>：返回 301 重定向</li>
</ul>
</li>
</ul>
<h4 id="rewrite-log-指令"><a href="#rewrite-log-指令" class="headerlink" title="rewrite_log 指令"></a>rewrite_log 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWwjcmV3cml0ZV9sb2c=">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite_log<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">rewrite_log</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">rewrite_log</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span>, if</span><br></pre></td></tr></table></figure>

<p>将 <code>rewrite</code> 的信息记录到 <code>error_log</code> 中</p>
<h4 id="if-指令"><a href="#if-指令" class="headerlink" title="if 指令"></a>if 指令</h4><p>可以根据请求中的变量的值，判断是否满足某个条件之后是否执行下面的配置指令。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWwjaWY=">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">if</span> (condition) &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>条件 condition 为真，则执行大括号内的指令；遵循值指令的继承规则。</p>
<p>表达式：</p>
<ol>
<li>检查变量为空或者值是否为 0，直接使用</li>
<li>将变量与字符串做完全匹配，使用 <code>=</code> 或者 <code>!=</code></li>
<li>将变量与正则表达式做匹配<ul>
<li>大小写敏感，<code>~</code> 或者 <code>!~</code></li>
<li>大小写不敏感，<code>~*</code> 或者 <code>!~*</code></li>
</ul>
</li>
<li>检查文件是否存在，使用 <code>-f</code> 或者 <code>!-f</code></li>
<li>检查目录是否存在，使用 <code>-d</code> 或者 <code>!-d</code></li>
<li>检查文件、目录、软链接是否存在，使用 <code>-e</code> 或者 <code>!-e</code></li>
<li>检查是否为可执行文件，使用 <code>-x</code> 或者 <code>!-x</code></li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~ MSIE)</span> &#123; <span class="comment"># 判断是否是 ie 浏览器</span></span><br><span class="line">	<span class="attribute">rewrite</span><span class="regexp"> ^(.*)$</span> /msie/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$http_cookie</span> <span class="regexp">~* &quot;id=([^</span>;]+)(?:;|$)&quot;) &#123; <span class="comment"># 忽略大小写，从 cookie 中取出 id</span></span><br><span class="line">	<span class="attribute">set</span> <span class="variable">$id</span> <span class="variable">$1</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = POST) &#123; <span class="comment"># 对变量做字符串完全匹配</span></span><br><span class="line">  <span class="attribute">return</span> <span class="number">405</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$slow</span>) &#123; <span class="comment"># 对变量进行判断是否为空，map中的变量</span></span><br><span class="line">	<span class="attribute">limit_rate</span> <span class="number">10k</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;  <span class="comment"># 对 invalid_referer 模块</span></span><br><span class="line">  <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FIND-CONFIG-阶段"><a href="#FIND-CONFIG-阶段" class="headerlink" title="FIND_CONFIG 阶段"></a>FIND_CONFIG 阶段</h3><p>FIND_CONFIG 阶段主要是匹配 <code>location</code>，决定用哪个代码块处理。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjbG9jYXRpb24=">https://nginx.org/en/docs/http/ngx_http_core_module.html#location<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="section">location</span> [ = | <span class="regexp">~ |</span> <span class="regexp">~* |</span><span class="regexp"> ^~</span> ] uri &#123; ... &#125;</span><br><span class="line"><span class="section">location</span> <span class="variable">@name</span> &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjbWVyZ2Vfc2xhc2hlcw==">https://nginx.org/en/docs/http/ngx_http_core_module.html#merge_slashes<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">merge_slashes</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">merge_slashes</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server</span><br></pre></td></tr></table></figure>

<p>当两个 <code>/</code> 在一起时，<code>xxx//xxx.html</code>，打开 <code>merge_slashes</code> 则可以合并成一个 <code>/</code></p>
<h4 id="Location-匹配规则"><a href="#Location-匹配规则" class="headerlink" title="Location 匹配规则"></a>Location 匹配规则</h4><p>仅匹配 URI，忽略参数</p>
<ul>
<li>前缀字符串<ul>
<li>常规，例如 <code>xxx/xxx.html</code></li>
<li><code>=</code>：精确匹配</li>
<li><code>^~</code>：匹配上后则不再进行正则表达式匹配</li>
</ul>
</li>
<li>正则表达式<ul>
<li><code>~</code>：大小写敏感的正则匹配</li>
<li><code>~*</code>：忽略大小写的正则匹配</li>
</ul>
</li>
<li>合并连续的<code>/</code>符号<ul>
<li><code>merge_slashes on</code></li>
</ul>
</li>
<li>用于内部跳转的命名 <code>location</code><ul>
<li><code>@</code></li>
</ul>
</li>
</ul>
<p>匹配顺序：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F03%2F22%2F16-51-51-image-20240322165151774.png" alt="image-20240322165151774"></p>
<p>Nginx 中会使用 <strong>二叉树</strong> 放置全部的 <code>location</code>。</p>
<p>匹配时，有三种情况：</p>
<ol>
<li>匹配 <code>=</code> 字符串，则停止匹配</li>
<li>再进行其他的前缀匹配，匹配上的话，对应最长的匹配</li>
<li>如果是 <code>^~</code> 字符串，匹配上之后，则不会进行正则表达式匹配，如果多个匹配上，则用最长匹配上的 <code>url</code> 的 <code>location</code>，此时如果最长 <code>location</code> 没有 <code>^~</code>，因此后续还会进行正则表达式匹配</li>
<li>如果上面两个都没有，则先记住最长匹配的前缀字符串 <code>location</code>，并且再按照正则表达式匹配，如果正则表达式没有匹配上，则用这一个</li>
<li>使用正则表达式匹配是按照顺序的，如果匹配上，就直接使用，而不再继续往下匹配</li>
</ol>
<h3 id="PREACCESS-阶段"><a href="#PREACCESS-阶段" class="headerlink" title="PREACCESS 阶段"></a>PREACCESS 阶段</h3><p>用于限制每个客户端的并发连接数</p>
<p><code>ngx_http_limit_conn_module</code> 模块，默认编译进 Nginx </p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X2Nvbm5fbW9kdWxlLmh0bWw=">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>生效范围：</p>
<ul>
<li>全部 <code>worker</code> 进程（基于共享内存）</li>
<li>进入 <code>preaccess</code> 阶段前不生效</li>
<li>限制的有效性取决于 <code>key</code> 的设计：依赖 <code>postread</code> 阶段的 <code>realip</code> 模块取到真实 <code>ip</code>（例如前面有 SLB 做负载均衡，此时连接数限制会失效，因此可以基于 <code>realip</code> 来做限制连接数）</li>
</ul>
<h4 id="limit-conn-指令"><a href="#limit-conn-指令" class="headerlink" title="limit_conn 指令"></a>limit_conn 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X2Nvbm5fbW9kdWxlLmh0bWwjbGltaXRfY29ubl96b25l">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_conn_zone</span> key zone=name:size;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<p>定义共享内存（包括大小）以及 <code>key</code> 关键字，一般 <code>key</code> 取值于用户的 IP 地址（<code>remote_addr</code>）</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X2Nvbm5fbW9kdWxlLmh0bWwjbGltaXRfY29ubg==">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_conn</span> zone number;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>限制并发连接数</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X2Nvbm5fbW9kdWxlLmh0bWwjbGltaXRfY29ubl9sb2dfbGV2ZWw=">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_log_level<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_conn_log_level</span> <span class="literal">info</span> | <span class="literal">notice</span> | <span class="literal">warn</span> | <span class="literal">error</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">limit_conn_log_level</span> <span class="literal">error</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">0</span>.<span class="number">8</span>.<span class="number">18</span>.</span><br></pre></td></tr></table></figure>

<p>限制发生时的日志级别</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X2Nvbm5fbW9kdWxlLmh0bWwjbGltaXRfY29ubl9zdGF0dXM=">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_status<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_conn_status</span> code;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">limit_conn_status</span> <span class="number">503</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">3</span>.<span class="number">15</span>.</span><br></pre></td></tr></table></figure>

<p>限制发生时向客户端返回的错误码</p>
<h4 id="limit-req-指令"><a href="#limit-req-指令" class="headerlink" title="limit_req 指令"></a>limit_req 指令</h4><p>默认编译进 Nginx，用于限制请求数和大小。</p>
<p>生效算法：<code>leaky bucket</code> 算法（漏桶）：有一个一定容量的桶，请求来了之后，以固定的速度处理，如果桶满了，则直接返回报错</p>
<p>生效范围：</p>
<ul>
<li>全部 <code>worker</code> 进程（基于共享内存）</li>
<li>进入 <code>preaccess</code> 阶段前不生效</li>
<li>限制的有效性取决于 <code>key</code> 的设计，依赖 <code>postread</code> 阶段的 <code>realip</code> 模块取到真实 <code>ip</code>（例如前面有 SLB 做负载均衡，此时连接数限制会失效，因此可以基于 <code>realip</code> 来做限制连接数）</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X3JlcV9tb2R1bGUuaHRtbCNsaW1pdF9yZXFfem9uZQ==">https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_zone<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_req_zone</span> key zone=name:size rate=rate [sync];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<p>定义共享内存（包括大小），以及 key 关键字和限制速率。</p>
<p><code>rate</code> 单位为 <code>r/s</code> 或者 <code>r/m</code>，代表每秒&#x2F;分钟的请求数</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X3JlcV9tb2R1bGUuaHRtbCNsaW1pdF9yZXE=">https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_req</span> zone=name [burst=number] [nodelay | delay=number];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>限制并发连接数。</p>
<p><code>burst</code> 默认为0，代表盆中容纳多少个请求</p>
<p><code>nodelay</code> ，对 <code>burst</code> 中的请求不再采用延时处理的做法，而是立刻处理（立刻返回错误），如果设置了，则会等待延迟处理，如果超过了设置的 <code>number</code>，则会立刻返回错误。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X3JlcV9tb2R1bGUuaHRtbCNsaW1pdF9yZXFfbG9nX2xldmVs">https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_log_level<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_req_log_level</span> <span class="literal">info</span> | <span class="literal">notice</span> | <span class="literal">warn</span> | <span class="literal">error</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">limit_req_log_level</span> <span class="literal">error</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">0</span>.<span class="number">8</span>.<span class="number">18</span>.</span><br></pre></td></tr></table></figure>

<p>限制发生时的日志级别</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xpbWl0X3JlcV9tb2R1bGUuaHRtbCNsaW1pdF9yZXFfc3RhdHVz">https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_status<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">limit_req_status</span> code;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">limit_req_status</span> <span class="number">503</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">3</span>.<span class="number">15</span>.</span><br></pre></td></tr></table></figure>

<p>当 <code>limit_req</code> 与 <code>limit_conn</code> 配置同时生效，<code>limit_req</code> 会优先生效，这是基于 HTTP 处理流程的。</p>
<h3 id="ACCESS-阶段"><a href="#ACCESS-阶段" class="headerlink" title="ACCESS 阶段"></a>ACCESS 阶段</h3><p>控制请求是否可以继续向下访问，按照顺序，有 <code>access</code>、 <code>auth_basic</code>、<code> auth_request</code> 三个模块</p>
<h4 id="access-模块"><a href="#access-模块" class="headerlink" title="access 模块"></a>access 模块</h4><p>默认编译到 Nginx，生效范围：进入 <code>access</code> 阶段前不生效</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2FjY2Vzc19tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_access_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p><strong>allow 指令</strong></p>
<p>允许哪些地址访问</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2FjY2Vzc19tb2R1bGUuaHRtbCNhbGxvdw==">https://nginx.org/en/docs/http/ngx_http_access_module.html#allow<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">allow</span> address | CIDR | unix: | all;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span>, limit_except</span><br></pre></td></tr></table></figure>

<p><strong>deny 指令</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2FjY2Vzc19tb2R1bGUuaHRtbCNkZW55">https://nginx.org/en/docs/http/ngx_http_access_module.html#deny<i class="fa fa-external-link-alt"></i></span></p>
<p>不允许哪些地址访问</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">deny</span> address | CIDR | unix: | all;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span>, limit_except</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">deny</span>  <span class="number">192.168.1.1</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">24</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">    <span class="attribute">deny</span>  all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="auth-basic-模块"><a href="#auth-basic-模块" class="headerlink" title="auth_basic 模块"></a>auth_basic 模块</h4><p>对用户名、密码做限制。默认编译进 Nginx</p>
<p>使用 RFC2671 的 <code>HTTP Basic Authentication</code> 协议进行用户名密码的认证。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F20-05-00-image-20240322200500405.png" alt="image-20240322200500405"></p>
<p>浏览器访问浏览器时，浏览器返回一个 401 的响应，这个响应不会在客户端显式，浏览器会弹出对话框，输入用户名密码。浏览器通过明文将用户名密码发给服务端，因此可以使用 HTTPS。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2F1dGhfYmFzaWNfbW9kdWxlLmh0bWw=">https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">auth_basic</span> string | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">auth_basic</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span>, limit_except</span><br><span class="line"></span><br><span class="line">Syntax:	auth_basic_user_file file;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span>, limit_except</span><br></pre></td></tr></table></figure>

<p>生成密码文件：</p>
<ul>
<li><p>文件格式</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># comment</span></span><br><span class="line">name1:<span class="attribute">password1</span></span><br><span class="line">name2:password2:comment</span><br><span class="line">name3:password3</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成工具：<code>htpasswd</code></p>
<p>安装依赖包：<code>httpd-tools</code> ，命令行：<code>htpasswd –c file –b user pass</code></p>
</li>
</ul>
<h4 id="auth-request-模块"><a href="#auth-request-模块" class="headerlink" title="auth_request 模块"></a>auth_request 模块</h4><p>默认未编译进 Nginx。</p>
<p>功能：向上游的服务转发请求，若上游服务返回的响应码时 2xx，则继续执行，若上游服务返回的是 401 或者 403，则将响应返回给客户端。可以理解为向第三方验证，但是验证完成后由自己执行后面的操作。</p>
<p>原理：收到请求后，生成子请求（子请求与请求一致），通过反向代理技术把请求传递给上游服务。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2F1dGhfcmVxdWVzdF9tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_auth_request_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">auth_request</span> uri | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">auth_request</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方便后续处理，请求完成后，设置一个变量</span></span><br><span class="line">Syntax:	auth_request_set <span class="variable">$variable</span> value;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h4 id="satisfy-指令"><a href="#satisfy-指令" class="headerlink" title="satisfy 指令"></a>satisfy 指令</h4><p>限制所有 <code>access</code> 阶段模块的 <code>satisfy</code> 指令</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjc2F0aXNmeQ==">https://nginx.org/en/docs/http/ngx_http_core_module.html#satisfy<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">satisfy</span> all | any;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">satisfy</span> all;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p><code>access</code> 阶段的模块：</p>
<ul>
<li><code>access</code> 模块</li>
<li><code>auth_basic</code> 模块</li>
<li><code>auth_request</code> 模块</li>
<li>其他模块</li>
</ul>
<p><code>satisfy all</code> 代表所有的 <code>access</code> 模块都满足，请求才可以放行。</p>
<p><code>satisfy any</code> 代表只要有任意一个 <code>access</code> 模块放行了，那么这个请求就可以放行。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F20-21-29-image-20240322202129575.png" alt="image-20240322202129575"></p>
<ol>
<li>如果有 <code>return</code> 指令，<code>access</code> 阶段不会生效。这是由于 <code>return</code> 的 <code>REWRITE</code> 阶段在前面</li>
<li>多个 <code>access</code> 模块的顺序的影响，会按照执行顺序，如果放行则直接放行，如果拒绝则直接拒绝</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /&#123;</span><br><span class="line">	<span class="attribute">satisfy</span> any;</span><br><span class="line">	<span class="attribute">auth_basic</span> <span class="string">&quot;test auth_basic&quot;</span>; </span><br><span class="line">	<span class="attribute">auth_basic_user_file</span> examples/auth.pass; </span><br><span class="line">	<span class="attribute">deny</span> all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如上面，输入密码，可以访问文件；这是由于 <code>satisfy any</code> 作用于 <code>access</code> 模块之前，输入密码之后即可访问</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /&#123;</span><br><span class="line">	<span class="attribute">satisfy</span> any;</span><br><span class="line">  <span class="attribute">deny</span> all;</span><br><span class="line">	<span class="attribute">auth_basic</span> <span class="string">&quot;test auth_basic&quot;</span>; </span><br><span class="line">	<span class="attribute">auth_basic_user_file</span> examples/auth.pass; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即使是这样，输入密码也可以</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /&#123;</span><br><span class="line">	<span class="attribute">satisfy</span> any;</span><br><span class="line">  <span class="attribute">allow</span> all;</span><br><span class="line">	<span class="attribute">auth_basic</span> <span class="string">&quot;test auth_basic&quot;</span>; </span><br><span class="line">	<span class="attribute">auth_basic_user_file</span> examples/auth.pass; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果改为这样，则不需要输入密码，即可访问。这是由于 <code>access</code> 模块在 <code>auth_basic</code> 之前。</p>
<h3 id="PRECONTENT-阶段"><a href="#PRECONTENT-阶段" class="headerlink" title="PRECONTENT 阶段"></a>PRECONTENT 阶段</h3><h4 id="try-files-指令"><a href="#try-files-指令" class="headerlink" title="try_files 指令"></a>try_files 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjdHJ5X2ZpbGVz">https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files<i class="fa fa-external-link-alt"></i></span></p>
<p>默认编译到 Nginx 中，也无法取消。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">try_files</span> file ... uri;</span><br><span class="line"><span class="attribute">try_files</span> file ... =code;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>依次殊途访问多个 <code>url</code> 对应的文件（由 <code>root</code> 或者 <code>alias</code> 指令指定），当文件存在时直接返回文件内容，如果所有文件都不存在，则按最后一个 URL 结果或者 <code>code</code> 返回。</p>
<p>一般可以用于解决反向代理服务器的缓存，当存在文件则返回，如果不存在文件，则转发到上游服务器中。</p>
<h4 id="mirror-指令"><a href="#mirror-指令" class="headerlink" title="mirror 指令"></a>mirror 指令</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX21pcnJvcl9tb2R1bGUuaHRtbCNtaXJyb3I=">https://nginx.org/en/docs/http/ngx_http_mirror_module.html#mirror<i class="fa fa-external-link-alt"></i></span></p>
<p>一般用于创造一份镜像流量，例如生产环境中，可以将请求 <code>copy</code> 一份发送到测试环境或者生产环境中做处理。</p>
<p>默认编译进 Nginx，处理请求时，生成子请求访问其他服务，对子请求的返回值不做处理。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">mirror</span> uri | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">mirror</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line">Syntax:	mirror_request_body on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">mirror_request_body</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h3 id="CONTENT-阶段"><a href="#CONTENT-阶段" class="headerlink" title="CONTENT 阶段"></a>CONTENT 阶段</h3><h4 id="static-模块"><a href="#static-模块" class="headerlink" title="static 模块"></a>static 模块</h4><p>有两个指令，功能都是将 <code>url</code> 映射为文件路径，以返回静态文件内容。</p>
<p><strong>root</strong> 指令</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjcm9vdA==">https://nginx.org/en/docs/http/ngx_http_core_module.html#root<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">root</span> path;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">root</span> html;</span><br><span class="line">Context:	http, server, <span class="section">location</span>, if in <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>差别是：<code>root</code> 就将完整 <code>url</code> 映射进文件路径中；由默认配置，并且上下文很多</p>
<p><strong>alias</strong> 指令</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjYWxpYXM=">https://nginx.org/en/docs/http/ngx_http_core_module.html#alias<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">alias</span> path;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>差别：<code>alias</code> 只会将 <code>location</code> 后的 <code>URL</code> 映射到文件路径；没有默认配置</p>
<p><strong>三个变量</strong></p>
<p>除了 <code>root</code> 和 <code>alias</code> 之外，<code>static</code> 模块还提供三个变量。</p>
<ul>
<li><code>request_filename</code>：待访问文件的完整路径（绝对路径）</li>
<li><code>document_root</code>：由 URI 和 <code>root/alias</code> 规则生成的文件夹路径（目录的绝对路径）</li>
<li><code>realpath_root</code>：将 <code>document_root</code> 中的软链接等换成真实路径（软连接对应目录的绝对目录）</li>
</ul>
<p><strong>content-type</strong></p>
<p>当读取磁盘上的文件时，会根据文件的扩展名做一次映射，放在 <code>hash</code> 表中</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将扩展名和 content-type 做映射，放在 hash 表中</span></span><br><span class="line">Syntax:	<span class="section">types</span> &#123; ... &#125;</span><br><span class="line">Default:	</span><br><span class="line"><span class="section">types</span> &#123;</span><br><span class="line">    text/<span class="attribute">html</span>  html;</span><br><span class="line">    image/<span class="attribute">gif</span>  gif;</span><br><span class="line">    image/<span class="attribute">jpeg</span> jpg;</span><br><span class="line">&#125;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 return 时，没有文件名或者没有扩展名时的默认 content-type</span></span><br><span class="line">Syntax:	default_type mime-type;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">default_type</span> text/plain;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放 content-type 桶的大小和容量</span></span><br><span class="line">Syntax:	types_hash_bucket_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">types_hash_bucket_size</span> <span class="number">64</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line">Syntax:	types_hash_max_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">types_hash_max_size</span> <span class="number">1024</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p><strong>log_not_found</strong></p>
<p>当找不到文件时，打印日志。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">log_not_found</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">log_not_found</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[error] 10156<span class="params">#0</span>: *10723 open() &quot;/html/first/2.txt/root/2.txt&quot; failed (2: No such file or directory)</span><br></pre></td></tr></table></figure>

<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><p><code>static</code> 模块实现了 <code>root/alias</code> 功能时，发现访问目标是目录，但 <code>URL</code> 末尾未加 <code>/</code> 时，会返回 301 重定向。</p>
<p>此时可以根据不同的配置实现不同的效果：、</p>
<p>打开之后，重定向的 <code>Location</code> 内的内容就是主域名中的域名</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjc2VydmVyX25hbWVfaW5fcmVkaXJlY3Q=">https://nginx.org/en/docs/http/ngx_http_core_module.html#server_name_in_redirect<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">server_name_in_redirect</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">server_name_in_redirect</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>打开之后，在 <code>Location</code> 中显示出端口</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjcG9ydF9pbl9yZWRpcmVjdA==">https://nginx.org/en/docs/http/ngx_http_core_module.html#port_in_redirect<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">port_in_redirect</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">port_in_redirect</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>绝对路径打开，会返回一个域名，返回的域名默认是请求的域名，或者当请求的 <code>header</code> 中携带 <code>Host</code>，则是对应 <code>Host</code> 中的值，也可以由 <code>server_name_in_redirect</code> 控制，端口是否显式，由 <code>port_in_redirect</code> 控制。如果不打开，则返回的 <code>Location</code> 中不会携带 <code>http://xxx</code> 等，而是直接返回一个绝对路径</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjYWJzb2x1dGVfcmVkaXJlY3Q=">https://nginx.org/en/docs/http/ngx_http_core_module.html#absolute_redirect<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">absolute_redirect</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">absolute_redirect</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">11</span>.<span class="number">8</span>.</span><br></pre></td></tr></table></figure>

<h4 id="index-模块"><a href="#index-模块" class="headerlink" title="index 模块"></a>index 模块</h4><p>指定&#x2F;访问时返回 <code>index</code> 文件内容（当访问的 <code>url</code> 以 <code>/</code> 结尾时，回去查找目录下是否有 <code>index.html</code> 文件）</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2luZGV4X21vZHVsZS5odG1sI2luZGV4">https://nginx.org/en/docs/http/ngx_http_index_module.html#index<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">index</span> file ...;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h4 id="randomindex-模块"><a href="#randomindex-模块" class="headerlink" title="randomindex 模块"></a>randomindex 模块</h4><p>随机选择 <code>index</code> 指令指定的一系列 <code>index</code> 文件中的一个，作为 <code>/</code> 路径的返回文件内容。默认编译进 Nginx。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3JhbmRvbV9pbmRleF9tb2R1bGUuaHRtbCNyYW5kb21faW5kZXg=">https://nginx.org/en/docs/http/ngx_http_random_index_module.html#random_index<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">random_index</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">random_index</span> <span class="literal">off</span>;</span><br><span class="line">Context:	<span class="section">location</span></span><br></pre></td></tr></table></figure>

<h4 id="autoindex-模块"><a href="#autoindex-模块" class="headerlink" title="autoindex 模块"></a>autoindex 模块</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2F1dG9pbmRleF9tb2R1bGUuaHRtbCNhdXRvaW5kZXg=">https://nginx.org/en/docs/http/ngx_http_autoindex_module.html#autoindex<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启或者关闭</span></span><br><span class="line">Syntax:	<span class="attribute">autoindex</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">autoindex</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当返回 HTML 格式时才有效，表示显式文件大小是相对单位，还是以 Byte 单位</span></span><br><span class="line">Syntax:	autoindex_exact_size on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">autoindex_exact_size</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示返回是以哪种格式返回</span></span><br><span class="line">Syntax:	autoindex_format html | xml | json | jsonp;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">autoindex_format</span> html;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">7</span>.<span class="number">9</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示返回的时区</span></span><br><span class="line">Syntax:	autoindex_localtime on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">autoindex_localtime</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<p><code>index</code> 的执行顺序是先于 <code>autoindex</code>。</p>
<p>当 <code>URL</code> 以 <code>/</code> 结尾时，尝试以 <code>html/xml/json/jsonp</code> 等格式返回 <code>root/alias</code> 中指向目录的目录结构。默认编译进 Nginx</p>
<h4 id="concat-模块"><a href="#concat-模块" class="headerlink" title="concat 模块"></a>concat 模块</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvbmdpbngtaHR0cC1jb25jYXQ=">https://github.com/alibaba/nginx-http-concat<i class="fa fa-external-link-alt"></i></span></p>
<p>当页面需要访问多个小文件时，把它们的内容合并到一次 <code>http</code> 响应中返回，提升性能</p>
<p>使用：</p>
<p>在 <code>uri</code> 后面加上 <code>??</code>，后通过多个 <code>,</code> 号分隔文件。如果还有参数，则在最后通过 <code>?</code> 添加参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/??style1.css,style2.css,foo/style3.css</span><br><span class="line">http://example.com/??style1.css,style2.css,foo/style3.css?v=102234</span><br></pre></td></tr></table></figure>

<h3 id="LOG-阶段"><a href="#LOG-阶段" class="headerlink" title="LOG 阶段"></a>LOG 阶段</h3><p>记录请求访问日志的 <code>log</code> 模块</p>
<p>将 HTTP 请求相关信息记录到日志。<code>ngx_http_log_module</code> 无法禁用</p>
<h4 id="access-log-模块"><a href="#access-log-模块" class="headerlink" title="access_log 模块"></a>access_log 模块</h4><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2xvZ19tb2R1bGUuaHRtbCNhY2Nlc3NfbG9n">https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义格式</span></span><br><span class="line">Syntax:	<span class="attribute">log_format</span> name [escape=default|json|<span class="literal">none</span>] string ...;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">log_format</span> combined <span class="string">&quot;...&quot;</span>;</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义日志文件</span></span><br><span class="line">Syntax:	<span class="attribute">access_log</span> path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</span><br><span class="line"><span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">access_log</span> logs/access.log combined;</span><br><span class="line">Context:	http, server, <span class="section">location</span>, if in <span class="section">location</span>, limit_except</span><br></pre></td></tr></table></figure>

<ul>
<li><code>path</code> 路径可以包含变量（比如 <code>host</code> 根据不同主机写入不同文件）：不打开 <code>cache</code> 时每记录一条日志都需要打开、关闭日志文件（这种情况性能很低）</li>
<li><code>if</code> 通过通过变量值控制请求日志是否记录</li>
<li><code>format</code> 不填，默认使用 <code>combined</code></li>
<li>日志缓存<ul>
<li>批量将内存中的日志写入磁盘（也就是使用 <code>cache</code> 批量写入，节省性能）</li>
<li>写入磁盘的条件<ul>
<li>所有待写入磁盘的日志大小超出缓存文件</li>
<li>达到 <code>flush</code> 指定的过期时间（过长的话，中途宕机可能导致日志丢失）</li>
<li><code>worker</code> 进程执行 <code>reopen</code> 命令，或者正在关闭</li>
</ul>
</li>
</ul>
</li>
<li>日志压缩<ul>
<li>批量压缩内存中的日志，再写入磁盘</li>
<li><code>buffer</code> 大小默认为 <code>64KB</code></li>
<li>压缩级别默认为1（1最快压缩率最低，9最慢压缩率最高）</li>
</ul>
</li>
</ul>
<p>对日志文件名包含变量时的优化，使用缓存，避免每次写入日志都要先关闭当前文件，再打开要写入的文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">open_log_file_cache</span> max=N [inactive=time] [min_uses=N] [valid=time];</span><br><span class="line"><span class="attribute">open_log_file_cache</span> <span class="literal">off</span>;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">open_log_file_cache</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>max</code>：缓存内的最大文件句柄数，超出后用 LRU 算法淘汰</li>
<li><code>inactive</code>：文件访问完后在这段时间内不会被关闭。默认 10 秒</li>
<li><code>min_uses</code>：在 <code>inactive</code> 时间内使用次数超过 <code>min_uses</code> 才会继续存在内存中。默认1</li>
<li><code>valid</code>：超出 <code>valid</code> 时间后，将对缓存的日志文件检查是否存在。默认 60 秒</li>
<li><code>off</code>：关闭缓存功能</li>
</ul>
<h3 id="过滤模块的位置"><a href="#过滤模块的位置" class="headerlink" title="过滤模块的位置"></a>过滤模块的位置</h3><p>在将结果返回给客户端之前，对返回的结果还要进行过滤操作。这个操作的位置在 <code>LOG</code> 之前，<code>CONTENT</code> 阶段之后。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">limit_req</span> zone=req_one burst=<span class="number">120</span>;</span><br><span class="line"><span class="attribute">limit_conn</span> c_zone <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">satisfy</span> any;</span><br><span class="line"><span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">32</span>; </span><br><span class="line"><span class="attribute">auth_basic_user_file</span> access.pass;</span><br><span class="line"></span><br><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">image_filter</span> resize <span class="number">80</span> <span class="number">80</span>;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F23-09-56-image-20240322230956352.png" alt="image-20240322230956352"></p>
<p>在返回请求时，会先发送 <code>header</code>，发送完后，才发送 <code>body</code>，因此，不同的过滤模块的位置不同。</p>
<h4 id="加工响应内容"><a href="#加工响应内容" class="headerlink" title="加工响应内容"></a>加工响应内容</h4><p>过滤模块中，不同模块的处理顺序：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F22%2F23-14-03-image-20240322231403898.png" alt="image-20240322231403898"></p>
<ol>
<li>HTTP 过滤模块：<code>copy_filter</code>：复制包体内容（零拷贝技术，不经过用户态，直接拷贝给用户。但是如果使用 <code>gzip</code>，则需要拷贝到内存中处理）</li>
<li>HTTP 过滤模块：<code>postpone_filter</code>：处理子请求（例如需要关注一些子请求的结果）</li>
<li>HTTP 过滤模块:<ol>
<li><code>header_filter</code>：构造响应头部（例如增加 Nginx 版本信息到 <code>header</code> 中）</li>
<li><code>write_filter</code>：发送响应（调用系统 WRITE，发送数据到客户端）</li>
</ol>
</li>
</ol>
<h4 id="sub-模块"><a href="#sub-模块" class="headerlink" title="sub 模块"></a>sub 模块</h4><p>将响应中指定的字符串，替换成新的字符串。默认未编译进 Nginx</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3N1Yl9tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_sub_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配后换成新的字符串，忽略大小写</span></span><br><span class="line">Syntax:	<span class="attribute">sub_filter</span> string replacement;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否还需要在 header 中显示原先的 last_modified</span></span><br><span class="line">Syntax:	sub_filter_last_modified on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">sub_filter_last_modified</span> <span class="literal">off</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">5</span>.<span class="number">1</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只修改一次，on 代表扫描所有的 body 替换所有的，off 代表只替换一个</span></span><br><span class="line">Syntax:	sub_filter_once on | off;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">sub_filter_once</span> <span class="literal">on</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只针对什么类型的响应替换，如果是 * 代表所有的内容</span></span><br><span class="line">Syntax:	sub_filter_types mime-type ...;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">sub_filter_types</span> text/html;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

<h4 id="addition-模块"><a href="#addition-模块" class="headerlink" title="addition 模块"></a>addition 模块</h4><p>在响应的 <code>body</code> 内容前或者响应的 <code>body</code> 后增加内容，而增加内容的方式时通过新 <code>url</code> 响应完成。默认为编译进 Nginx</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2FkZGl0aW9uX21vZHVsZS5odG1s">https://nginx.org/en/docs/http/ngx_http_addition_module.html<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在响应之前添加内容，添加的内容是 uri 这个子请求返回的内容</span></span><br><span class="line">Syntax:	<span class="attribute">add_before_body</span> uri;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在响应后添加内容</span></span><br><span class="line">Syntax:	add_after_body uri;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 content-type 这样的类型才响应</span></span><br><span class="line">Syntax:	addition_types mime-type ...;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">addition_types</span> text/html;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">0</span>.<span class="number">7</span>.<span class="number">9</span>.</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-变量的运行原理"><a href="#Nginx-变量的运行原理" class="headerlink" title="Nginx 变量的运行原理"></a>Nginx 变量的运行原理</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/homework%2FPicGo%2F2024%2F03%2F23%2F14-00-48-image-20240323140048843.png" alt="image-20240323140048843"></p>
<p>Nginx 中分为提供变量的模块和使用变量的模块，<code>Preconfiguration</code> 是 HTTP 模块读取配置模块之前添加的新变量。定义的变量是变量名和解析出变量的方法，目的是定义规则，当需要使用这个变量时，输入对应的变量名得到对应的值。</p>
<p>使用变量时，则解析 <code>nginx.conf</code> 时定义变量的使用方法，在处理请求时，通过变量名获取这个请求对应的变量值。</p>
<p>变量的特性：</p>
<ul>
<li><p>惰性求值</p>
<p>只有当前请求处理完之后，才能通过变量名获取对应变量值</p>
<p>变量值可以时刻变化，其值为使用的那一时刻的值</p>
</li>
</ul>
<p>存放变量的哈希表：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwjdmFyaWFibGVzX2hhc2hfYnVja2V0X3NpemU=">https://nginx.org/en/docs/http/ngx_http_core_module.html#variables_hash_bucket_size<i class="fa fa-external-link-alt"></i></span></p>
<p>通过参数配置变量大小和容量</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">variables_hash_bucket_size</span> size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">variables_hash_bucket_size</span> <span class="number">64</span>;</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line"></span><br><span class="line">Syntax:	variables_hash_max_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">variables_hash_max_size</span> <span class="number">1024</span>;</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<h2 id="HTTP-框架提供的变量"><a href="#HTTP-框架提供的变量" class="headerlink" title="HTTP 框架提供的变量"></a>HTTP 框架提供的变量</h2><p>一些系统提供的变量</p>
<h3 id="HTTP-请求相关的变量"><a href="#HTTP-请求相关的变量" class="headerlink" title="HTTP 请求相关的变量"></a>HTTP 请求相关的变量</h3><ul>
<li><code>arg_参数名</code>：<code>URL</code> 中某个具体参数的值</li>
<li><code>query_string</code>：与 <code>args</code> 变量完全相同</li>
<li><code>args</code>：全部 URL 参数</li>
<li><code>is_args</code>：如果请求 URL 中有参数则返回 <code>?</code> 否则返回空</li>
<li><code>content_length</code>：HTTP 请求中标识包体长度的 <code>Content-Length</code> 头部的值</li>
<li><code>content_type</code>：标识请求包体类型的 <code>Content-Type</code> 头部的值</li>
<li><code>uri</code>：请求的 URI（不同于 URL，不包括 <code>?</code> 后的参数）</li>
<li><code>document_uri</code>：与 <code>uri</code> 完全相同</li>
<li><code>request_uri</code>：请求的 URL（包含 URI 以及完整的参数）</li>
<li><code>sheme</code>：协议名，例如 HTTP 或者 HTTPS</li>
<li><code>request_method</code>：请求方法，例如 GET、POST</li>
<li><code>request_length</code>：所有请求内容的大小，包括请求行、头部、包体等</li>
<li><code>remote_user</code>：由 HTTP Basic Authentication 协议传入的用户名</li>
<li><code>request_body_file</code>：临时存放请求包体的文件<ul>
<li>如果包体非常小则不会存文件</li>
<li><code>client_body_in_file_only</code> 强制所有包体存入文件，且可决定是否删除</li>
</ul>
</li>
<li><code>request_body</code>：请求中的包体，这个变量当且仅当使用反向代理，且设定用内存暂存包体时才有效</li>
<li><code>request</code>：原始的 <code>url</code> 请求，含有方法与协议版本，例如 <code>GET /?a=1&amp;b=2 HTTP/1.1</code></li>
<li><code>host</code>：先从请求行中获取<ul>
<li>如果含有 <code>Host</code> 的 <code>header</code>，则用其值替换掉请求行中的主机名</li>
<li>如果前两者都取不到，则使用匹配上的 <code>server_name</code></li>
</ul>
</li>
<li><code>http_头部名字</code>：返回一个具体请求头部的值<ul>
<li>特殊的几个，Nginx 会做一些特殊处理<ul>
<li><code>http_host</code>、<code>http_user_agent</code>、<code>http_referer</code>、<code>http_via</code>、<code>http_x_forwarded_for</code>、<code>http_cookie</code></li>
</ul>
</li>
<li>通用：其他的不会做任何处理，直接从 <code>Header</code> 中读取到内容就是变量的值</li>
</ul>
</li>
</ul>
<h3 id="TCP-连接相关的变量"><a href="#TCP-连接相关的变量" class="headerlink" title="TCP 连接相关的变量"></a>TCP 连接相关的变量</h3><ul>
<li><code>binary_remote_addr</code>：客户端地址的整型格式，对于 IPv4 是 4 字节，对于 IPv6 是 16字节（一般会使用这个作为缓存的 key，效率高，但是写入日志可读性就不好）</li>
<li><code>connection</code>：递增的连接序号</li>
<li><code>connection_requests</code>：当前连接上执行过的请求数，对 <code>keepalive</code> 连接有意义</li>
<li><code>remote_addr</code>：客户端度地址</li>
<li><code>remote_port</code>：客户端端口</li>
<li><code>proxy_protocol_addr</code>：如果使用了 <code>proxy_protocol</code> 协议则返回协议中的地址，否则返回空</li>
<li><code>proxy_protocol_port</code>：如果使用了 <code>proxy_protocol</code> 协议则返回协议中的端口，否则返回空</li>
<li><code>server_addr</code>：服务器端地址</li>
<li><code>server_port</code>：服务器端端口</li>
<li><code>TCP_INFO</code>：<code>tcp</code> 内核层参数，包括 <code>$tcpinfo_rtt, $tcpinfo_rttvar, $tcpinfo_snd_cwnd, $tcpinfo_rcv_space</code></li>
<li><code>server_protocol</code>：服务器端协议，例如 <code>HTTP/1.1</code></li>
</ul>
<h3 id="Nginx-处理请求过程中产生的变量"><a href="#Nginx-处理请求过程中产生的变量" class="headerlink" title="Nginx 处理请求过程中产生的变量"></a>Nginx 处理请求过程中产生的变量</h3><ul>
<li><code>request_time</code>：请求处理到现在的耗时，单位为秒，精确到毫秒</li>
<li><code>server_name</code>：匹配上请求的 <code>server_name</code> 值</li>
<li><code>https</code>：如果开启了 TLS&#x2F;SSL，则返回 <code>no</code>，否则返回空</li>
<li><code>request_completion</code>：若请求处理完则返回 <code>OK</code>，否则返回空</li>
<li><code>request_id</code>：以 16禁止输出的请求标识 id，该 id 公含有 16 个字节，是随机生成的</li>
<li><code>request_filename</code>：待访问文件的完整路径</li>
<li><code>document_root</code>：由 URI 和 <code>root/alias</code> 规则生成的文件夹路径</li>
<li><code>realpath_root</code>：将 <code>document_root</code> 中的软链接等换成真实路径</li>
<li><code>limit_rate</code>：返回客户端响应时的速度上限，单位为每秒字节数。可以通过 <code>set</code> 指令修改对请求产生效果</li>
</ul>
<h3 id="发送-HTTP-响应时相关的变量"><a href="#发送-HTTP-响应时相关的变量" class="headerlink" title="发送 HTTP 响应时相关的变量"></a>发送 HTTP 响应时相关的变量</h3><ul>
<li><code>body_bytes_sent</code>：响应中 <code>body</code> 包体的长度</li>
<li><code>bytes_sent</code>：全部 http 响应的长度</li>
<li><code>status</code>：<code>http</code> 响应中的返回码</li>
<li><code>sent_trailer_名字</code>：把响应结尾内容里值返回</li>
<li><code>sent_http_头部名字</code>：响应中某个具体头部的值<ul>
<li>特殊处理<ul>
<li><code>sent_http_content_type</code></li>
<li><code>sent_http_content_length</code></li>
<li><code>sent_http_location</code></li>
<li><code>sent_http_last_modified</code></li>
<li><code>sent_http_connection</code></li>
<li><code>sent_http_keep_alive</code></li>
<li><code>sent_http_transfer_encoding</code></li>
<li><code>sent_http_cache_control</code></li>
<li><code>sent_http_link</code></li>
</ul>
</li>
<li>通用</li>
</ul>
</li>
</ul>
<h3 id="Nginx-系统变量"><a href="#Nginx-系统变量" class="headerlink" title="Nginx 系统变量"></a>Nginx 系统变量</h3><ul>
<li><code>time_local</code>：以本地时间标准输出的当前时间，例如 <code>14/Nov/2022:15:55:37 +0800</code></li>
<li><code>time_iso8601</code>：使用 ISO 8601 标准输出的当前时间，例如 <code>2022-11-14T15:55:37+08:00</code></li>
<li><code>nginx_version</code>：Nginx 版本号</li>
<li><code>pid</code>：所属 <code>worker</code> 进程的进程 <code>id</code></li>
<li><code>pipe</code>：使用了管道则返回 <code>p</code>，否则返回 <code>.</code></li>
<li><code>hostname</code>：所在服务器的主机名，与 <code>hostname</code> 命令输出一致</li>
<li><code>msee</code>：1970年1月1日到现在的时间，单位为秒，小数点后精确到毫秒</li>
</ul>
<h2 id="简单有效的防盗链手段-referer-模块"><a href="#简单有效的防盗链手段-referer-模块" class="headerlink" title="简单有效的防盗链手段 referer 模块"></a>简单有效的防盗链手段 referer 模块</h2><p>场景：当某网站通过 <code>url</code> 引用了你的页面，当用户在浏览器上点击 <code>url</code> 时，<code>http</code> 请求的头部会通过 <code>referer</code> 头部，将该网站当前页面的 <code>url</code> 带上，告诉服务器本次请求是由这个网页发起的。</p>
<p>目的：拒绝非正常的网站访问我们站点的资源</p>
<p>思路：通过 <code>referer</code> 模块，用 <code>invalid_referer</code> 变量根据配置判断 &#96;&#96;referer&#96; 头部是否合法</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3JlZmVyZXJfbW9kdWxlLmh0bWw=">https://nginx.org/en/docs/http/ngx_http_referer_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>默认编译进 Nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">valid_referers</span> <span class="literal">none</span> | <span class="literal">blocked</span> | server_names | string ...;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># server_names 里面可能会有很多值，为了加速访问，会将这些值放在 hash 表中</span></span><br><span class="line">Syntax:	referer_hash_bucket_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">referer_hash_bucket_size</span> <span class="number">64</span>;</span><br><span class="line">Context:	server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">0</span>.<span class="number">5</span>.</span><br><span class="line"></span><br><span class="line">Syntax:	referer_hash_max_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">referer_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line">Context:	server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">1</span>.<span class="number">0</span>.<span class="number">5</span>.</span><br></pre></td></tr></table></figure>

<p><code>valid_referers</code> 可同时携带多个参数，标识多个 <code>referer</code> 头部都生效。</p>
<ul>
<li><code>none</code>：允许缺失 <code>referer</code> 头部的请求访问</li>
<li><code>blocked</code>：<code>referer</code> 字段存在于请求头中，允许 <code>referer</code> 头部没有对应的值的请求访问（可能是通过了反向代理或者防火墙导致，但是不是以 <code>http://</code> 开头或者以 <code>https://</code> 开头）</li>
<li><code>server_names</code>：若 <code>referer</code> 中站点域名与 <code>server_name</code> 中本机域名某个匹配，则允许该请求访问</li>
<li>标识域名及 <code>URL</code> 的字符串，对域名可在前缀或者后缀中含有 <code>*</code> 通配符：若 <code>referer</code> 头部的值匹配字符串后，则允许访问</li>
<li>正则表达式：若 <code>referer</code> 头部的值匹配正则表达式后，则允许访问</li>
</ul>
<p><code>invalid_referers</code> 变量：</p>
<ul>
<li>允许访问时，变量值为空</li>
<li>不允许访问时，变量值为1</li>
</ul>
<h2 id="防盗链的一种解决方案-secure-link-模块"><a href="#防盗链的一种解决方案-secure-link-模块" class="headerlink" title="防盗链的一种解决方案 secure_link 模块"></a>防盗链的一种解决方案 secure_link 模块</h2><p>通过验证 URL 中哈希值的方式防盗链。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3NlY3VyZV9saW5rX21vZHVsZS5odG1s">https://nginx.org/en/docs/http/ngx_http_secure_link_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>默认未编译进 Nginx</p>
<p>过程：</p>
<ul>
<li>由某服务器（也可以是 <code>nginx</code>）生成加密后的安全连接 <code>url</code>，返回给客户端</li>
<li>客户端使用安全 <code>url</code> 访问 <code>nginx</code>，由 <code>nginx</code> 的 <code>secure_link</code> 变量判断是否验证通过</li>
</ul>
<p>原理：</p>
<ul>
<li>哈希算法不可逆</li>
<li>客户端只能拿到执行过哈希算法的 URL</li>
<li>仅生成 URL 的服务器、验证 URL 是否安全的 <code>nginx</code> 这二者，才保存执行哈希算法前的原始字符串</li>
<li>原始字符串通常由以下部分有序组成：<ul>
<li>资源位置，例如 HTTP 中指定资源的 URI，防止攻击者拿到一个安全 URL 后可以访问任意资源</li>
<li>用户信息，例如用户 IP 地址，限制其他用户盗用安全 URL</li>
<li>时间戳，使安全 URL 及时过期</li>
<li>密钥，仅服务器端拥有，增加攻击者猜测出原始字符串的难度</li>
</ul>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">secure_link</span> expression;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line">Syntax:	secure_link_md5 expression;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line">Syntax:	secure_link_secret word;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="section">location</span></span><br></pre></td></tr></table></figure>

<p>变量：</p>
<ul>
<li><code>secure_link</code>：<ul>
<li>值为空字符串：校验不通过</li>
<li>值为0: URL 过期</li>
<li>值为1: 验证通过</li>
</ul>
</li>
<li><code>secure_link_expires</code>：时间戳的值</li>
</ul>
<p>例如一个变量值及带过期时间的配置：</p>
<p>通过命令行生成安全链接：</p>
<p>原始请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test1.txt?md5=md5生成值&amp;expires=时间戳（例如147483647）</span><br></pre></td></tr></table></figure>

<p>生成 <code>md5</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;时间戳URI客户端IP 密钥&#x27; | openssl md5 -binary | openssl base64 | tr +/ - | tr -d =</span><br></pre></td></tr></table></figure>

<p>Nginx 配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">secure_link</span> <span class="variable">$arg_md5</span>,<span class="variable">$arg_expires</span>;</span><br><span class="line"><span class="attribute">secure_link_md5</span> <span class="string">&quot;<span class="variable">$secure_link_expires</span><span class="variable">$uri</span><span class="variable">$remote_addr</span> secret&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>仅对 URI 进行哈希的简单办法：</p>
<ol>
<li>将请求 URL 分为三个部分：<code>/prefix/hash/link</code></li>
<li>Hash 生成方式：对 <code>link</code> 密钥做 <code>md5</code> 哈希求值</li>
<li>用 <code>secure_link_secret secret</code> 配置密钥</li>
</ol>
<p>例如：</p>
<p>原始请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link</span><br></pre></td></tr></table></figure>

<p>生成的安全请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/prefix/md5/link</span><br></pre></td></tr></table></figure>

<p>生成 md5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;linksecret&#x27; | openssl md5 –hex</span><br></pre></td></tr></table></figure>

<p>Nginx 配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">secure_link_secret</span> secret;</span><br></pre></td></tr></table></figure>

<h2 id="map-模块的指令"><a href="#map-模块的指令" class="headerlink" title="map 模块的指令"></a>map 模块的指令</h2><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX21hcF9tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_map_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>基于已有变量，使用类似 <code>switch &#123;case: ... default: ...&#125;</code> 的语法，创建新变量，为其他基于变量值实现功能的模块提供更多的可能性。</p>
<p>默认编译进 Nginx。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">map</span> string <span class="variable">$variable</span> &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line"></span><br><span class="line">Syntax:	map_hash_bucket_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">map_hash_bucket_size</span> <span class="number">32</span>|<span class="number">64</span>|<span class="number">128</span>;</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line"></span><br><span class="line">Syntax:	map_hash_max_size size;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">map_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法的意思是，如果已有变量 $http_host 的值，匹配上下面左边，则生成一个新变量 $name 值对应右边</span></span><br><span class="line"><span class="comment"># 如果没有匹配上任何值，则$name 为 0</span></span><br><span class="line"><span class="comment"># 使用 hostnames 遵循 server_name 的匹配规则一致</span></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$http_host</span> <span class="variable">$name</span> &#123;</span><br><span class="line">    hostnames;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">default</span>       <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    example.<span class="attribute">com</span>   <span class="number">1</span>;</span><br><span class="line">    *.example.<span class="attribute">com</span> <span class="number">1</span>;</span><br><span class="line">    example.<span class="attribute">org</span>   <span class="number">2</span>;</span><br><span class="line">    *.example.<span class="attribute">org</span> <span class="number">2</span>;</span><br><span class="line">    .example.<span class="attribute">net</span>  <span class="number">3</span>;</span><br><span class="line">    wap.*         4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$http_user_agent</span> <span class="variable">$mobile</span> &#123;</span><br><span class="line">    <span class="attribute">default</span>       <span class="number">0</span>;</span><br><span class="line">    &quot;~<span class="attribute">Opera</span> Mini<span class="string">&quot; 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>规则：</p>
<ul>
<li>已有变量：<ul>
<li>字符串</li>
<li>一个或者多个变量</li>
<li>变量与字符串的组合</li>
</ul>
</li>
<li><code>case</code> 规则：匹配过程有优先级，先匹配则返回对应内容<ul>
<li>字符串严格匹配</li>
<li>使用 <code>hostnames</code> 指令，可以对域名使用前缀 <code>*</code> 泛域名匹配</li>
<li>使用 <code>hostname</code> 指令，可以idui域名使用后缀 <code>*</code> 泛域名匹配</li>
<li><code>~</code> 和 <code>~*</code> 正则表达式匹配，后者忽略大小写</li>
</ul>
</li>
<li><code>default</code> 规则<ul>
<li>没有匹配到任何规则时，使用 <code>defualt</code></li>
<li>缺失 <code>defualt</code> 时，返回空字符串给新变量</li>
</ul>
</li>
<li>其他<ul>
<li>使用 <code>include</code> 语法提升可读性</li>
<li>使用 <code>volatile</code> 禁止变量值缓存</li>
</ul>
</li>
</ul>
<h2 id="split-clients-模块"><a href="#split-clients-模块" class="headerlink" title="split_clients 模块"></a>split_clients 模块</h2><p>主要用于实现 AB 测试，让百分比的用户体验某一部分新功能，然后看反馈。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3NwbGl0X2NsaWVudHNfbW9kdWxlLmh0bWw=">https://nginx.org/en/docs/http/ngx_http_split_clients_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>默认编译进 Nginx</p>
<p>也是基于已有变量创建新变量，为其他 AB 测试提供更多的可能性。（通过变量的值，以百分比的方式生成新的变量）</p>
<ul>
<li>对已有变量的值执行 <code>MurmurHash2</code> 算法得到 32 位整型哈希数字，记为 <code>hash</code></li>
<li>32 位无符号整型的最大数字 <code>2^32-1</code>，记为 max</li>
<li>哈希数字与最大数字相除 <code>hash/max</code>，可以得到百分比 <code>percent</code></li>
<li>配置指令中指示了各个百分比构成的范围，如 <code>0-1%</code>、<code>1%-5%</code> 等，及范围对应的值</li>
<li>当 <code>percent</code> 落在哪个范围里，新变量的值就对应着其后的参数</li>
</ul>
<p>规则：</p>
<ul>
<li>已有变量<ul>
<li>字符串</li>
<li>一个或者多个变量</li>
<li>变量与字符串的组合</li>
</ul>
</li>
<li><code>case</code> 规则<ul>
<li><code>xx.xx%</code>，支持小数点后 2 位，所有项的百分比相加不能超过 100%</li>
<li><code>*</code>，由它匹配剩余的百分比（100% 减去以上所有项相加的百分比）</li>
</ul>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">split_clients</span> string <span class="variable">$variable</span> &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">split_clients</span> <span class="string">&quot;<span class="variable">$&#123;remote_addr&#125;</span>AAA&quot;</span> <span class="variable">$variant</span> &#123;</span><br><span class="line">                   0.5%               .one; <span class="comment"># 0% ~ 0.5%</span></span><br><span class="line">                   2.0%               .two; <span class="comment"># 0.5% ~ 2.0%</span></span><br><span class="line">                   *                  &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">index</span> index<span class="variable">$&#123;variant&#125;</span>.html;</span><br></pre></td></tr></table></figure>

<h2 id="geo-模块"><a href="#geo-模块" class="headerlink" title="geo 模块"></a>geo 模块</h2><p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2dlb19tb2R1bGUuaHRtbA==">https://nginx.org/en/docs/http/ngx_http_geo_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>可以基于 IP地址创建新变量，默认编译进 Nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	<span class="attribute">geo</span> [<span class="variable">$address</span>] <span class="variable">$variable</span> &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">geo</span> <span class="variable">$country</span> &#123;</span><br><span class="line">    <span class="attribute">default</span>        ZZ;</span><br><span class="line">    <span class="attribute">include</span>        conf/geo.conf;</span><br><span class="line">    <span class="attribute">delete</span>         <span class="number">127.0.0.0</span>/<span class="number">16</span>;</span><br><span class="line">  <span class="comment"># proxy，此时 `remote_addr` 的值为 `X-Forwarded_For` 头部值中最后一个 IP 地址</span></span><br><span class="line">    <span class="attribute">proxy</span>          <span class="number">192.168.100.0</span>/<span class="number">24</span>;</span><br><span class="line">    <span class="attribute">proxy</span>          <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    127.0.0.0/24   US;</span><br><span class="line">    127.0.0.1/32   RU;</span><br><span class="line">    10.1.0.0/16    RU;</span><br><span class="line">    192.168.1.0/24 UK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 <code>geo</code> 指令后不输入 <code>$address</code>，那么默认使用 <code>$remote_addr</code> 变量作为 IP 地址</li>
<li><code>&#123; &#125;</code> 内的指令匹配：优先最长匹配<ul>
<li>通过 IP 地址及子网掩码的方式，定义 IP 范围，当 IP 地址在范围内时新变量使用其后的参数值</li>
<li><code>default</code> 指定了当以上范围都未匹配上时，新变量的默认值</li>
<li>通过 <code>proxy</code> 指令指定可信地址（参考 <code>realip</code> 模块），此时 <code>remote_addr</code> 的值为 <code>X-Forwarded_For</code> 头部值中最后一个 IP 地址</li>
<li><code>proxy_recursive</code> 允许循环地址搜索</li>
<li><code>include</code>，优化可读性</li>
<li><code>delete</code> 删除指定网络</li>
</ul>
</li>
</ul>
<h2 id="geoip-模块"><a href="#geoip-模块" class="headerlink" title="geoip 模块"></a>geoip 模块</h2><p>基于 MaxMind 数据库从客户端地址获取变量，例如地域和所属相关信息。默认未编译进 Nginx</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2dlb2lwX21vZHVsZS5odG1s">https://nginx.org/en/docs/http/ngx_http_geoip_module.html<i class="fa fa-external-link-alt"></i></span></p>
<p>依赖 <span class="exturl" data-url="aHR0cDovL3d3dy5tYXhtaW5kLmNvbS9hcHAvYw==">MaxMind GeoIP<i class="fa fa-external-link-alt"></i></span> 库，编译前需要先下载，然后编译时携带进去。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国家信息</span></span><br><span class="line">Syntax:	<span class="attribute">geoip_country</span> file;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 城市信息</span></span><br><span class="line">Syntax:	geoip_city file;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定可信地址，跟 realip 同样的用法</span></span><br><span class="line">Syntax:	geoip_proxy address | CIDR;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	<span class="attribute">http</span></span><br><span class="line">This directive appeared in versions <span class="number">1</span>.<span class="number">3</span>.<span class="number">0</span> and <span class="number">1</span>.<span class="number">2</span>.<span class="number">1</span>.</span><br></pre></td></tr></table></figure>

<p>变量：</p>
<ul>
<li><code>geoip_country_code</code>：两个字母的国家代码，比如 CN 或者 US</li>
<li><code>geoip_country_code3</code>：三个字母的国家代码，例如 CHN</li>
<li><code>geoip_country_name</code>：国家名称：例如 <code>China</code></li>
</ul>
<p><code>geoip_city</code> 中的指令很多，例如经度、纬度、洲、国家、洲或者省编码、省、邮编等</p>
<h2 id="keepalive-模块"><a href="#keepalive-模块" class="headerlink" title="keepalive 模块"></a>keepalive 模块</h2><p>是 HTTP 协议中的 <code>keepalive</code>，而不是 TCP 协议中的 <code>keepalive</code>。<code>keepalive</code> 本身包括对上游的和对下游的，对上游则是反向代理，自身相当于客户端。以下是对下游客户端而言。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX2NvcmVfbW9kdWxlLmh0bWwja2VlcGFsaXZlX2Rpc2FibGU=">https://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_disable<i class="fa fa-external-link-alt"></i></span></p>
<p>功能：多个 HTTP 请求通过复用 TCP 连接，实现以下功能：</p>
<ul>
<li>减少握手次数</li>
<li>通过减少并发连接数减少了服务器资源的消耗</li>
<li>降低 TCP 拥塞控制的影响</li>
</ul>
<p>协议：</p>
<ul>
<li><code>Connection</code> 头部：取值为 <code>close</code> 或者 <code>keepalive</code>，前者表示请求处理完即关闭连接，后者表示复用连接处理下一条请求。（这个 <code>header</code> 可以是客户端发给 Nginx，也可以是 Nginx 发给客户端）</li>
<li><code>Keep-Alive</code> 头部：其值为 <code>timeout=n</code>，后面的数字 <code>n</code> 单位是秒，告诉客户端连接至少保留 <code>n</code> 秒。（这个请求是 Nginx 发送给客户端）</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对某些浏览器关闭 keepalive</span></span><br><span class="line">Syntax:	<span class="attribute">keepalive_disable</span> <span class="literal">none</span> | browser ...;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">keepalive_disable</span> msie6;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示在一个 TCP 连接上最多执行多少个请求</span></span><br><span class="line">Syntax:	keepalive_requests number;</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br><span class="line">This directive appeared in version <span class="number">0</span>.<span class="number">8</span>.<span class="number">0</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个 timeout 表示客户端经过第一个 HTTP 请求后，经过 timeout 时间没有新请求，则关闭连接</span></span><br><span class="line"><span class="comment"># 第二个 timeout 表示 Nginx 发给客户端的 header Keep-Alive 头部，单位秒</span></span><br><span class="line">Syntax:	keepalive_timeout timeout [header_timeout];</span><br><span class="line">Default:	</span><br><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">75s</span>;</span><br><span class="line">Context:	http, server, <span class="section">location</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/a0155a17.html" rel="prev" title="基于 Istio 的⾼级流量管理">
                  <i class="fa fa-angle-left"></i> 基于 Istio 的⾼级流量管理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/4cec1707.html" rel="next" title="Nginx负载均衡和反向代理">
                  Nginx负载均衡和反向代理 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/4b7bcf38.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
