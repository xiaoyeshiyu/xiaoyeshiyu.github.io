<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Kubernetes 控制平面的核心引擎之一，API Server 扮演着整个系统的关键角色。作为 Kubernetes 集群的掌控中心，API Server 负责接收、处理和管理集群中的所有资源对象，从而实现集群的协同工作和资源编排。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 控制平面组件：API Server">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/bad7.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="Kubernetes 控制平面的核心引擎之一，API Server 扮演着整个系统的关键角色。作为 Kubernetes 集群的掌控中心，API Server 负责接收、处理和管理集群中的所有资源对象，从而实现集群的协同工作和资源编排。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240116130419930.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240116130437048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117145603076.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117145823918.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20240117150609156.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20240117152456469.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117164936287.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117172551578.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20240117172909954.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117173135949.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117173434981.png">
<meta property="og:image" content="https://www.xiaoyeshiyu.com/Library/Application%20Support/typora-user-images/image-20240117174933551.png">
<meta property="article:published_time" content="2024-01-14T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-18T09:03:38.183Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240116130419930.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/bad7.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/bad7.html","path":"post/bad7.html","title":"Kubernetes 控制平面组件：API Server"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes 控制平面组件：API Server | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#API-Server-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">API Server 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%A6%82%E8%A7%88"><span class="nav-number">1.1.</span> <span class="nav-text">访问控制概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%BB%86%E8%8A%82"><span class="nav-number">1.2.</span> <span class="nav-text">访问控制细节</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-number">2.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E6%8F%92%E4%BB%B6"><span class="nav-number">2.0.1.</span> <span class="nav-text">认证插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-webhook-%E7%9A%84%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90"><span class="nav-number">2.1.</span> <span class="nav-text">基于 webhook 的认证服务集成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-apiserver"><span class="nav-number">2.2.</span> <span class="nav-text">配置 apiserver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%99%B7%E9%98%B1"><span class="nav-number">2.3.</span> <span class="nav-text">生产系统中遇到的陷阱</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%89%B4%E6%9D%83"><span class="nav-number">3.</span> <span class="nav-text">鉴权</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%88%E6%9D%83"><span class="nav-number">3.1.</span> <span class="nav-text">授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-vs-ABAC"><span class="nav-number">3.2.</span> <span class="nav-text">RBAC vs ABAC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC-%E8%80%81%E5%9B%BE"><span class="nav-number">3.2.1.</span> <span class="nav-text">RBAC 老图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC-%E6%96%B0%E8%A7%A3"><span class="nav-number">3.2.2.</span> <span class="nav-text">RBAC 新解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Role-%E4%B8%8E-ClusterRole"><span class="nav-number">3.3.</span> <span class="nav-text">Role 与  ClusterRole</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binding"><span class="nav-number">3.4.</span> <span class="nav-text">binding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7-%E7%BB%84%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">3.5.</span> <span class="nav-text">账户&#x2F;组的管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E7%BE%A4%E7%BB%84%E6%8E%88%E6%9D%83"><span class="nav-number">3.5.1.</span> <span class="nav-text">针对群组授权</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E5%88%92%E7%B3%BB%E7%BB%9F%E8%A7%92%E8%89%B2"><span class="nav-number">3.6.</span> <span class="nav-text">规划系统角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="nav-number">3.7.</span> <span class="nav-text">实现方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8E%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E7%9A%84%E5%85%B6%E4%BB%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.8.</span> <span class="nav-text">与权限相关的其他最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%90%A5%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%87%BA%E7%8E%B0%E7%9A%84%E9%99%B7%E9%98%B1"><span class="nav-number">3.9.</span> <span class="nav-text">运营过程中出现的陷阱</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%85%A5"><span class="nav-number">4.</span> <span class="nav-text">准入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="nav-number">4.1.</span> <span class="nav-text">准入控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E6%8F%92%E4%BB%B6"><span class="nav-number">4.2.</span> <span class="nav-text">准入控制的默认插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E6%8F%92%E4%BB%B6"><span class="nav-number">4.3.</span> <span class="nav-text">准入控制插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%85%A5%E6%8F%92%E4%BB%B6%E7%9A%84%E5%BC%80%E5%8F%91"><span class="nav-number">4.4.</span> <span class="nav-text">准入插件的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E6%A1%88%E4%BE%8B"><span class="nav-number">4.4.1.</span> <span class="nav-text">准入控制案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%90%E6%B5%81"><span class="nav-number">5.</span> <span class="nav-text">限流</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3%E7%AE%97%E6%B3%95"><span class="nav-number">5.1.</span> <span class="nav-text">计数器固定窗口算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%AE%97%E6%B3%95"><span class="nav-number">5.2.</span> <span class="nav-text">计数器滑动窗口算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%96%97%E7%AE%97%E6%B3%95"><span class="nav-number">5.3.</span> <span class="nav-text">漏斗算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95"><span class="nav-number">5.4.</span> <span class="nav-text">令牌桶算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APIServer-%E4%B8%AD%E7%9A%84%E9%99%90%E6%B5%81"><span class="nav-number">5.5.</span> <span class="nav-text">APIServer 中的限流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E9%99%90%E6%B5%81%E6%96%B9%E6%B3%95%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-number">5.6.</span> <span class="nav-text">传统限流方法的局限性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-Priority-and-Fairness"><span class="nav-number">5.7.</span> <span class="nav-text">API Priority and Fairness</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">5.7.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">5.7.2.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E9%98%9F"><span class="nav-number">5.7.3.</span> <span class="nav-text">排队</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B1%81%E5%85%8D%E8%AF%B7%E6%B1%82"><span class="nav-number">5.7.4.</span> <span class="nav-text">豁免请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="nav-number">5.7.5.</span> <span class="nav-text">优先级默认配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PriorityLevelConfiguration"><span class="nav-number">5.7.6.</span> <span class="nav-text">PriorityLevelConfiguration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FlowSchema"><span class="nav-number">5.7.7.</span> <span class="nav-text">FlowSchema</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">5.8.</span> <span class="nav-text">调试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APIServer-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.</span> <span class="nav-text">APIServer 对象的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8-APIServer"><span class="nav-number">6.1.</span> <span class="nav-text">高可用 APIServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E5%A4%9A%E5%89%AF%E6%9C%AC-apiserver"><span class="nav-number">6.1.1.</span> <span class="nav-text">构建高可用的多副本 apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E7%95%99%E5%85%85%E8%B6%B3%E7%9A%84-CPU%E3%80%81%E5%86%85%E5%AD%98%E8%B5%84%E6%BA%90"><span class="nav-number">6.1.2.</span> <span class="nav-text">预留充足的 CPU、内存资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%96%84%E7%94%A8%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6%EF%BC%88RateLimit%EF%BC%89"><span class="nav-number">6.1.3.</span> <span class="nav-text">善用速率限制（RateLimit）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%88%E9%80%82%E7%9A%84%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="nav-number">6.1.4.</span> <span class="nav-text">设置合适的缓存大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%BD%E9%87%8F%E4%BD%BF%E7%94%A8%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.1.5.</span> <span class="nav-text">客户端尽量使用长连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE-APIServer"><span class="nav-number">6.1.6.</span> <span class="nav-text">访问 APIServer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%A4%9A%E7%A7%9F%E6%88%B7%E7%9A%84-Kubernetes-%E9%9B%86%E7%BE%A4"><span class="nav-number">6.2.</span> <span class="nav-text">搭建多租户的 Kubernetes 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81-1"><span class="nav-number">6.2.1.</span> <span class="nav-text">认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-APIService"><span class="nav-number">6.2.2.</span> <span class="nav-text">注册 APIService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83-1"><span class="nav-number">6.2.3.</span> <span class="nav-text">授权</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#apimachinery"><span class="nav-number">6.3.</span> <span class="nav-text">apimachinery</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%A0%B8%E5%BF%83%E5%86%85%E5%AE%B9%EF%BC%9AGKV"><span class="nav-number">6.3.1.</span> <span class="nav-text">对象核心内容：GKV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-Group"><span class="nav-number">6.3.2.</span> <span class="nav-text">定义 Group</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B-types-go"><span class="nav-number">6.3.3.</span> <span class="nav-text">定义对象类型 types.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90-Tags"><span class="nav-number">6.3.4.</span> <span class="nav-text">代码生成 Tags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-etcd-storage"><span class="nav-number">6.3.5.</span> <span class="nav-text">实现 etcd storage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subresource"><span class="nav-number">6.3.6.</span> <span class="nav-text">subresource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-APIGroup"><span class="nav-number">6.3.7.</span> <span class="nav-text">注册 APIGroup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="nav-number">6.3.8.</span> <span class="nav-text">代码生成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">7.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">135</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/bad7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes 控制平面组件：API Server | 小夜时雨">
      <meta itemprop="description" content="Kubernetes 控制平面的核心引擎之一，API Server 扮演着整个系统的关键角色。作为 Kubernetes 集群的掌控中心，API Server 负责接收、处理和管理集群中的所有资源对象，从而实现集群的协同工作和资源编排。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 控制平面组件：API Server
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-15T00:00:00+08:00">2024-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-18 17:03:38" itemprop="dateModified" datetime="2024-01-18T17:03:38+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">云原生训练营</span></a>
        </span>
    </span>

  
    <span id="/post/bad7.html" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes 控制平面组件：API Server" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">Kubernetes 控制平面的核心引擎之一，API Server 扮演着整个系统的关键角色。作为 Kubernetes 集群的掌控中心，API Server 负责接收、处理和管理集群中的所有资源对象，从而实现集群的协同工作和资源编排。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="API-Server-简介"><a href="#API-Server-简介" class="headerlink" title="API Server 简介"></a>API Server 简介</h1><p><code>kube-apiserver</code> 是 <code>Kubernetes</code> 最重要的核心组件之一，主要提供以下的功能</p>
<ul>
<li>提供集群管理的 <code>REST API</code> 接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的枢纽（其他模块通过 <code>API Server</code> 查询或修改数据，只有 <code>API Server</code> 才直接操作 <code>etcd</code>）</li>
</ul>
<h2 id="访问控制概览"><a href="#访问控制概览" class="headerlink" title="访问控制概览"></a>访问控制概览</h2><p>Kubernetes API 的每个请求都会经过多阶段的访问控制之后才会被接受，这包括认证、授权以及准入控制（<code>Admission Control</code>）等。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240116130419930.png" alt="image-20240116130419930"></p>
<ol>
<li>通过不同的 <code>HTTP handler</code> 来处理不同的请求</li>
<li>进行认证和鉴权</li>
<li>变形，通过自定义的一些 <code>Webhook</code> 修改一些对象（如果 Webhook 异常导致无法处理请求，则这个 API request 会卡住）</li>
<li>对象校验参数</li>
<li>自定义校验逻辑，通过自定义的  <code>Webhook</code> 校验</li>
<li>流量允许传到 <code>etcd</code></li>
</ol>
<h2 id="访问控制细节"><a href="#访问控制细节" class="headerlink" title="访问控制细节"></a>访问控制细节</h2><p>代码走读逻辑复盘：</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240116130437048.png" alt="image-20240116130437048"></p>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><p>开启 TLS 时，所有的请求都需要首先认证。</p>
<p>Kubernetes 支持多种认证机制，并支持同时开启多个认证插件（只要有一个认证通过即可）。如果认证成功，则用户的 <code>username</code> 会传入授权模块做进一步授权验证；而对于认证失败的请求则返回 <code>HTTP 401</code>。</p>
<h3 id="认证插件"><a href="#认证插件" class="headerlink" title="认证插件"></a>认证插件</h3><ul>
<li><p><code>X509</code> 证书</p>
<ul>
<li>使用 <code>X509</code> 客户端证书只需要 <code>API Server</code> 启动时配置 <code>--client-ca-file=SOMEFILE</code>。在证书认证时，其 <code>CN</code> 域用作用户名，而组织机构域用作 <code>group</code> 名。</li>
<li>默认，在 <code>.kube/config</code> 中</li>
</ul>
</li>
<li><p>静态 <code>Token</code> 文件</p>
<ul>
<li>使用静态 <code>Token</code> 文件认证只需要 <code>API Server</code> 启动时配置 <code>--token-auth-file=SOMEFIlE</code></li>
<li>该文件为 <code>csv</code> 格式，每行至少包括三列 <code>token</code>、<code>usernmae</code>、<code>user id</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token,user,uid,&quot;group1,group2,group3&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>引导 <code>Token</code></p>
<ul>
<li>为了支持平滑地启动引导新的集群，Kubernetes 包含了一种动态管理的持有者令牌类型，称作启动引导令牌（<code>Bootstrap Token</code>）</li>
<li>这些令牌以 <code>Secret</code> 的形式保存在 <code>kube-system</code> 命名空间中，可以被动态管理和创建</li>
<li>控制器管理器包含的 <code>TokenCleaner</code> 控制器能够在启动引导令牌过期时将其删除</li>
<li>在使用 <code>kubeadm</code> 部署 Kubernetes 时，可通过 <code>kubeadm token list</code> 命令查询</li>
</ul>
</li>
<li><p>静态密码文件</p>
<ul>
<li><p>需要 <code>API Server</code> 启动时配置 <code>--basic-auth-file=SOMEFILE</code>，文件格式为 <code>csv</code>，每行至少三列 <code>password, user, uid</code>，后面是可选的 <code>group</code> 名</p>
<p><code>password,user,uid,&quot;group1,group2,group3&quot;</code></p>
</li>
</ul>
</li>
<li><p><code>ServiceAccount</code></p>
<ul>
<li><p><code>ServiceAccount</code> 是 Kubernetes 自动生成的，并会自动挂载到容器的 <code>/run/secrets/kubernetes.io/serviceaccount</code> 目录中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl get serviceaccounts default -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2023-07-19T02:41:43Z&quot;</span><br><span class="line">  name: default</span><br><span class="line">  namespace: air</span><br><span class="line">  resourceVersion: &quot;29595001&quot;</span><br><span class="line">  selfLink: /api/v1/namespaces/air/serviceaccounts/default</span><br><span class="line">  uid: 16b2125c-1e75-4362-a7a9-53f380dbbf76</span><br><span class="line">secrets:</span><br><span class="line">- name: default-token-8xtx2  // 对应 secret</span><br><span class="line"></span><br><span class="line">// secret 内容</span><br><span class="line">~ kubectl get secrets default-token-8xtx2 -o yaml</span><br><span class="line">// 其中的 token 是一个标准的 jwt，可以使用这个 token 访问</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>OpenID</code></p>
<ul>
<li><code>OAuth 2.0</code> 的认证机制</li>
</ul>
</li>
<li><p><code>Webhook</code> 令牌身份认证</p>
<ul>
<li><code>--authentication-token-webhook-config-file</code> 指向一个配置文件，其中描述如何访问远程的 <code>Webhook</code> 服务</li>
<li><code>--authentication-token-webhook-cache-ttl</code> 用来设定身份认证决定的缓存时间。默认时长为 2 分钟。</li>
</ul>
</li>
<li><p>匿名请求</p>
<ul>
<li>如果使用 <code>AlwaysAllow</code> 以外的认证模式，则匿名请求默认开启，但可用 <code>--anonymous-auth=false</code> 禁止匿名请求</li>
</ul>
</li>
</ul>
<h2 id="基于-webhook-的认证服务集成"><a href="#基于-webhook-的认证服务集成" class="headerlink" title="基于 webhook 的认证服务集成"></a>基于 webhook 的认证服务集成</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVndWFyZC9ndWFyZA==">https://github.com/kubeguard/guard<i class="fa fa-external-link-alt"></i></span></p>
<p>构建符合 Kubernetes 规范，构建认证服务，用来认证 <code>tokenreview request</code></p>
<p>构建认证服务：</p>
<ul>
<li>认证服务需要满足如下 Kubernetes 的规范</li>
<li><code>URL: https://authn.example.com/authenticate</code></li>
<li><code>Method: POST</code></li>
<li><code>Input:</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TokenReview&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(BEARERTOKEN)&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Output:</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TokenReview&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;authenticated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;janedoe@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;42&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;groups&quot;</span><span class="punctuation">:</span></span><br><span class="line">            <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;developers&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;qa&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>如果解码失败，则认证失败：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">decoder := json.NewDecoder(r.Body)</span><br><span class="line"><span class="keyword">var</span> tr authentication.TokenReview</span><br><span class="line">err := decoder.Decode(&amp;tr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[Error]&quot;</span>, err.Error())</span><br><span class="line">	w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">	json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">		<span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">		<span class="string">&quot;status&quot;</span>: authentication.TokenReviewStatus&#123;</span><br><span class="line">			Authenticated: <span class="literal">false</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者转发到其他地方进行校验，例如使用 <code>github</code> 通过 <code>OAuth2</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ts := oauth2.StaticTokenSource(</span><br><span class="line">	&amp;oauth2.Token&#123;AccessToken: tr.Spec.Token&#125;,</span><br><span class="line">)</span><br><span class="line">tc := oauth2.NewClient(context.Background(), ts)</span><br><span class="line">client := github.NewClient(tc)</span><br><span class="line">user, _, err := client.Users.Get(context.Background(), <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[Error]&quot;</span>, err.Error())</span><br><span class="line">	w.WriteHeader(http.StatusUnauthorized)</span><br><span class="line">	json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">		<span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">		<span class="string">&quot;status&quot;</span>: authentication.TokenReviewStatus&#123;</span><br><span class="line">			Authenticated: <span class="literal">false</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;[Success] login as %s&quot;</span>, *user.Login)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将结果返回给 apiserver</span></span><br><span class="line">w.WriteHeader(http.StatusOK)</span><br><span class="line">trs := authentication.TokenReviewStatus&#123;</span><br><span class="line">	Authenticated: <span class="literal">true</span>,</span><br><span class="line">	User: authentication.UserInfo&#123;</span><br><span class="line">		Username: *user.Login,</span><br><span class="line">		UID:      *user.Login,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line">json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	<span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">	<span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">	<span class="string">&quot;status&quot;</span>:     trs,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>配置认证服务</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Config&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preferences&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github-authn&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.34.2:3000/authenticate&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authn-apiserver&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;secret&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contexts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webhook&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github-authn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authn-apiserver&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;current-context&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webhook&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置-apiserver"><a href="#配置-apiserver" class="headerlink" title="配置 apiserver"></a>配置 apiserver</h2><p>可以是任何认证系统</p>
<ul>
<li>但在用户认证完成后，生产代表用户身份的 <code>token</code></li>
<li>该 <code>token</code> 通常是有失效时间的</li>
<li>用户获取该 <code>token</code> 以后，将 <code>token</code> 配置进 <code>kubeconfig</code></li>
</ul>
<p>修改 <code>apiserver</code> 设置，开启认证服务，<code>apiserver</code> 保证将所有收到的请求中的 <code>token</code> 信息，发给认证服务进行验证</p>
<ul>
<li><code>--authentication-token-webhook-config-file</code>，该文件描述如何访问认证服务</li>
<li><code>--authentication-token-webhook-cache-ttl</code>，默认 2分钟</li>
</ul>
<p>配置文件需要 <code>mount</code> 进 Pod</p>
<p>配置文件中的服务器地址需要指向 <code>authService</code></p>
<p><code>apiserver</code> 配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="number">192.168</span><span class="number">.34</span><span class="number">.2</span><span class="string">:6443</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--advertise-address=192.168.34.2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--enable-bootstrap-token-auth=true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=6443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--service-account-issuer=https://kubernetes.default.svc.cluster.local</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--service-account-signing-key-file=/etc/kubernetes/pki/sa.key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--authentication-token-webhook-config-file=/etc/config/webhook-config.json</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.22.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.34</span><span class="number">.2</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.34</span><span class="number">.2</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">      <span class="attr">startupProbe:</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">24</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.34</span><span class="number">.2</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/pki</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">seccompProfile:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">RuntimeDefault</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/pki</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/config</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-config</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>将上面的配置文件，通过 <code>hostPath</code> 挂载到 Pod 内。</p>
<p>将认证服务启动到本地，监听 <code>3000</code> 端口。</p>
<p>在 <code>github</code> 上，<code>Settings</code> - <code>Personal access tokens</code> - <code>New persional access token</code> 创建一个新的 <code>token</code>，配置到 <code>~/.kube/config</code> 里面</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">github</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">&lt;mytoken&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="生产系统中遇到的陷阱"><a href="#生产系统中遇到的陷阱" class="headerlink" title="生产系统中遇到的陷阱"></a>生产系统中遇到的陷阱</h2><p>基于 Keystone 的认证插件，导致 Keystone 故障且无法恢复。</p>
<ul>
<li>Keystone 是企业关键服务。</li>
<li>Kubernetes 以  Keystone 作为认证插件。</li>
<li>Keystone 在出现故障后会抛出 401 错误。</li>
<li>Kubernetes 发现 401 错误后会尝试重新认证。</li>
<li>大多数 <code>controller</code> 都有指数级 <code>back off</code>，重试间隔越来越慢</li>
<li>但 <code>gophercloud</code> 包的逻辑，会缓存 <code>token</code>，缓存期间不会再去请求 <code>Keystone</code> 校验，针对过期 <code>token</code> 会一直 <code>retry</code></li>
<li>大量 <code>request</code> 积压在 Keystone 导致服务无法恢复</li>
<li>Kubernetes 称为压死企业认证服务的最后一根稻草</li>
</ul>
<p>解决方案：</p>
<ul>
<li><code>Circuit break</code>：在 <code>gophercloud</code> 中增加断路器</li>
<li><code>Rate limit</code>：在 <code>Keystone</code> 中增加限流</li>
</ul>
<h1 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h1><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>授权主要是用于对集群资源的访问控制，通过检查请求包含的相关属性值，与相对应的访问策略相比较，API 请求必须满足某些策略才能被处理。</p>
<p>跟认证类似，Kubernetes 也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。</p>
<p>如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；对于授权失败的请求则返回 <code>HTTP 403</code></p>
<p>Kubernetes 授权仅处理以下的请求属性：</p>
<ul>
<li><code>user</code>、<code>group</code>、<code>extra</code></li>
<li>API、请求方法（如 <code>get</code>、<code>post</code>、<code>update</code>、<code>patch</code> 和 <code>delete</code>）和请求路径（如 <code>/api</code>）</li>
<li>请求资源和子资源</li>
<li><code>Namespace</code></li>
<li><code>API Group</code></li>
</ul>
<p>目前，Kubernetes 支持以下授权插件</p>
<ul>
<li><code>ABAC</code></li>
<li><code>RBAC</code></li>
<li><code>Webhook</code>：独立开发</li>
<li><code>Node</code>：例如授权单个节点，用于安全的隔离</li>
</ul>
<h2 id="RBAC-vs-ABAC"><a href="#RBAC-vs-ABAC" class="headerlink" title="RBAC vs ABAC"></a>RBAC vs ABAC</h2><p>ABAC（<code>Attribute Based Access Control</code>）本来是不错的概念，但是在 Kubernetes 中的实现比较难于管理和理解，而且需要对 Master 所在节点的 SSH 和文件系统权限，要使得对授权的变更成功生效，还需要重新启动 API Server。</p>
<p>而 RBAC 的授权策略可以利用 <code>kubectl</code> 或者 Kubernetes API 直接进行配置。RBAC 可以授权给用户，让用户有权进行授权管理，这样就可以无需接触节点，直接进行授权管理。RBAC 在 Kubernetes 中被映射为 API 资源和操作。</p>
<h3 id="RBAC-老图"><a href="#RBAC-老图" class="headerlink" title="RBAC 老图"></a>RBAC 老图</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117145603076.png" alt="image-20240117145603076"></p>
<p>权限可以操作对象，多个权限可以绑定为一个角色，角色可以绑定给用户。</p>
<h3 id="RBAC-新解"><a href="#RBAC-新解" class="headerlink" title="RBAC 新解"></a>RBAC 新解</h3><p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117145823918.png" alt="image-20240117145823918"></p>
<p>Kubernetes 将权限分为全局的和 Namespace 内的，通过将权限绑定到不同的 <code>Bindings</code> 上划分为角色。</p>
<h2 id="Role-与-ClusterRole"><a href="#Role-与-ClusterRole" class="headerlink" title="Role 与  ClusterRole"></a>Role 与  ClusterRole</h2><p><code>Role</code>（角色）是一系列权限的集合，例如一个角色可以包含读取 Pod 的权限和列出 Pod 的权限。Role 只能用来给某个特定 Namespace 中的资源做鉴权，对多 Namespace 和集群级的资源或者是非资源类的 API（如 <code>/heathz</code>）使用 <code>ClusterRole</code>。</p>
<p>Role 示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">pod-reader</span> </span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group </span></span><br><span class="line">	<span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">	<span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>ClusterRole 示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="comment"># &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">secret-reader</span> </span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">	<span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">	<span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="binding"><a href="#binding" class="headerlink" title="binding"></a>binding</h2><p>将用户和角色绑定起来</p>
<p><img data-src="/../../../../../../Library/Application%20Support/typora-user-images/image-20240117150609156.png" alt="image-20240117150609156"></p>
<p>RoleBinding 示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This role binding allows &quot;dave&quot; to read secrets in the &quot;development&quot; namespace.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span> <span class="comment"># This only grants permissions within the &quot;development&quot; namespace.</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dave</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h2 id="账户-组的管理"><a href="#账户-组的管理" class="headerlink" title="账户&#x2F;组的管理"></a>账户&#x2F;组的管理</h2><p>角色绑定（<code>Role Binding</code>）是将角色中定义的权限赋予一个或者一组用户。</p>
<p>它包含若干主体（用户、组或服务账户）的列表和对这些主体所获得的角色的引用。</p>
<p>组的概念：</p>
<ul>
<li>当与外部认证系统对接时，用户信息（<code>UserInfo</code>）可包含 <code>Group</code> 信息，授权可针对用户群组</li>
<li>当对 <code>ServiceAccount</code> 授权时，<code>Group</code> 代表某个 Namespace 下的所有 <code>ServiceAccount</code></li>
</ul>
<p><img data-src="/../../../../../../Library/Application%20Support/typora-user-images/image-20240117152456469.png" alt="image-20240117152456469"></p>
<h3 id="针对群组授权"><a href="#针对群组授权" class="headerlink" title="针对群组授权"></a>针对群组授权</h3><p>将 <code>secret-reader</code> 这个 <code>clusterRole</code> 授权给 <code>manager</code> 这个群组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">read-secrets-global</span> </span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">manager</span> <span class="comment"># &#x27;name&#x27; 是区分大小写的</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span> </span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>将 <code>secret-reader</code> 这个 <code>clusterRole</code> 授权给 <code>system:serviceaccounts:qa</code> 这个群组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">read-secrets-global</span> </span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">system:serviceaccounts:qa</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span> </span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h2 id="规划系统角色"><a href="#规划系统角色" class="headerlink" title="规划系统角色"></a>规划系统角色</h2><p><code>User</code></p>
<ul>
<li>管理员<ul>
<li>是否需要所有资源的所有权限？针对不同部门、不同层级的管理员赋予不同的权限。</li>
</ul>
</li>
<li>普通用户<ul>
<li>是否有该用户创建的 <code>namespace</code> 下的所有 <code>object</code> 的操作权限？使用 <code>namespace</code> 来划分服务。</li>
<li>对其他用户的 <code>namespace</code> 资源是否可读，是否可写？Pod 管理隔开，但是服务可以访问。</li>
</ul>
</li>
</ul>
<p><code>SystemAccount</code></p>
<ul>
<li><code>SystemAccount</code> 是开发者（Kubernetes developer 或者 domain developer）创建应用后，应用于 <code>apiserver</code> 通讯需要的身份</li>
<li>用户可以创建自定的 <code>ServiceAccount</code>，Kubernetes 也为每个 <code>namespace</code> 创建 <code>default ServiceAccount</code></li>
<li><code>Default ServiceAccount</code> 通常需要给定权限以后才能对 <code>apiserver</code> 做写操作</li>
</ul>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>自定义鉴权方案：</p>
<p>在 <code>cluster</code> 创建时，创建自定义的 <code>role</code>，比如 <code>namespace-creator</code>，包含所有权限。</p>
<p><code>namespace-creator role</code> 定义用户可操作的对象和对应的读写操作。</p>
<p>创建自定义的 <code>namespace admission controller</code></p>
<ul>
<li>当 <code>namespace</code> 创建请求被处理时，获取当前用户信息并 <code>annotate</code> 到 <code>namespace</code> （新的 <code>namespace</code> 和新的 <code>user</code> 绑定起来）</li>
</ul>
<p>创建 RBAC controller</p>
<ul>
<li><code>Watch namespace</code> 的创建事件</li>
<li>获取当前 <code>namespace</code> 的创建者信息</li>
<li>在当前 <code>namespace</code> 创建 <code>rolebinding</code> 对象，并将 <code>namespace-creator</code> 角色和用户绑定</li>
</ul>
<h2 id="与权限相关的其他最佳实践"><a href="#与权限相关的其他最佳实践" class="headerlink" title="与权限相关的其他最佳实践"></a>与权限相关的其他最佳实践</h2><p><code>ClusterRole</code> 是非 <code>namespace</code> 绑定的，针对整个集群生效。</p>
<p>通常需要创建一个管理员角色，并且绑定给开发运营团队成员，由管理员角色操作，赋予用户权限。</p>
<p><code>ThirdPartyResource</code>（以前的名称） 和 <code>CustomResourceDefinition</code> （现在的名称，简称 <code>CRD</code>）是全局资源，普通用户创建 <code>ThirdPartyResource</code> 以后，需要管理员授予相应权限后才能真正操作该对象。</p>
<p>针对所有的角色管理，建议创建 <code>spec</code>，用源代码驱动。</p>
<ul>
<li>虽然可以通过 <code>edit</code> 操作来修改权限，但后期会导致权限管理混乱，可能会有很多临时创建出来的角色和角色绑定对象，重复绑定某一个资源权限。</li>
</ul>
<p>权限是可以传递的，用户 A 可以将其对某对象的某操作，抽取成一个权限，并赋给用户 B。</p>
<p>防止海量的角色和角色绑定对象，因为大量的对象会导致鉴权效率低，同时给 <code>apiserver</code> 增加负担 。</p>
<p><code>ServiceAccount</code> 也需要授权，否则你的 <code>component</code> 可能无法操作某对象。</p>
<p><code>Tips</code>：SSH 到 <code>master</code> 节点，通过 <code>insecure port</code> 访问 <code>apiserver</code> 可绕过鉴权，当需要做管理操作又没有权限时可以使用（不推荐）。</p>
<h2 id="运营过程中出现的陷阱"><a href="#运营过程中出现的陷阱" class="headerlink" title="运营过程中出现的陷阱"></a>运营过程中出现的陷阱</h2><p>案例1:</p>
<ul>
<li>研发人员为提高系统效率，将 <code>update</code> 方法修改为 <code>patch</code>（目的是增量更新，减少负担）</li>
<li>研发人员本地非安全测试环境测试通过</li>
<li>上生产，发现不 <code>work</code></li>
<li>原因：忘记更新 <code>rolebinding</code>，对应的 <code>serviceaccount</code> 没有 <code>patch</code> 权限</li>
</ul>
<p>案例2:</p>
<ul>
<li>研发人员创建 <code>CRD</code>，并针对该 <code>CRD</code> 编程</li>
<li>上生产后不工作</li>
<li>原因，该 <code>CRD</code> 未授权，对应的组件 <code>get</code> 不到对应的 <code>CRD</code> 资源</li>
</ul>
<h1 id="准入"><a href="#准入" class="headerlink" title="准入"></a>准入</h1><h2 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h2><p>为资源增加自定义属性</p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在 <code>namespace</code> 的准入控制中，获取用户信息，并将用户信息更新的 <code>namespace</code> 的 <code>annotation</code></li>
</ul>
<p>只有当 <code>namespace</code> 中有有效用户信息时，我们才可以在 <code>namespace</code> 创建时，自动绑定用户权限，<code>namespace</code> 才可用。</p>
<p>准入控制（Admission Control）在授权后对请求做进一步的验证或添加默认参数。不同于授权和认证只关心请求的用户和操作，准入控制还处理请求的内容，并且仅对创建、更新、删除或连接（如代理）等有效，而对读操作无效。</p>
<p>准入控制支持同时开启多个插件，它们依次调用，只有全部插件都通过的请求才可以放过进入系统。</p>
<h2 id="准入控制的默认插件"><a href="#准入控制的默认插件" class="headerlink" title="准入控制的默认插件"></a>准入控制的默认插件</h2><p>配额管理：</p>
<ul>
<li>原因：资源有限，如何限定某个用户有多少资源？</li>
</ul>
<p>方案：</p>
<ul>
<li><p>预定义每个 Namespace 的 ResourceQuota，并把 <code>spec</code> 保存为 <code>configmap</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  get resourcequota -A</span><br></pre></td></tr></table></figure>

<ul>
<li>用户可以创建多少个 Pod<ul>
<li><code>BestEffortPod</code></li>
<li><code>QoSPod</code></li>
</ul>
</li>
<li>用户可以创建多少个 Service</li>
<li>用户可以创建多少个 Ingress</li>
<li>用户可以创建多少个 Service VIP</li>
</ul>
</li>
<li><p>创建 ResourceQuota Controller</p>
<ul>
<li>监控 Namespace 创建事件，当 Namespace 创建时，在该 Namespace 创建对应的 ResourceQuota 对象</li>
</ul>
</li>
<li><p>APIServer 中开启 ResourceQuota 的 admission plugin</p>
</li>
</ul>
<h2 id="准入控制插件"><a href="#准入控制插件" class="headerlink" title="准入控制插件"></a>准入控制插件</h2><ul>
<li>AlwaysAdmit：接受所有请求</li>
<li>AlwaysPullImages：总是拉取最新镜像。在多租户场景下非常有用</li>
<li>DenyEscalatingExec：禁止特权容器的 <code>exec</code> 和 <code>attach</code> 操作</li>
<li>ImagePolicyWebhook：通过 <code>webhook</code> 决定 <code>image</code> 策略，需要同时配置 <code>--admission-control-config-file</code></li>
<li>ServiceAccount：自动创建默认 ServiceAccount，并确保 Pod 引用的 ServiceAccount 已经存在 </li>
<li>SecurityContextDeny：拒绝包含非法 SecurityContext 配置的容器</li>
<li>ResourceQuota：限制 Pod 的请求不会超过配额，需要在 namespace 中创建一个 ResourceQuota 对象</li>
<li>LimitRanger：为 Pod 设置默认资源请求和限制，需要在 namespace 中创建一个 LimitRange 对象</li>
<li>InitialResrouces：根据镜像的历史使用记录，为容器设置默认资源请求和限制</li>
<li>NamespaceLifecycle：确保处于 <code>termination</code> 状态的 <code>namespace</code> 不再接收新的对象创建请求，并拒绝请求不存在的 <code>namespace</code></li>
<li>DefaultStorageClass：为 PVC 设置默认 StorageClass</li>
<li>DefaultTolerationSeconds：使用 Pod Security Policies 时必须开启</li>
<li>NodeRestriction：限制 <code>kubelet</code> 仅可访问 <code>node</code>、<code>endpoint</code>、<code>pod</code>、<code>service</code> 以及 <code>secret</code>、<code>configmap</code>、<code>PV</code> 和 <code>PVC</code> 等相关的资源</li>
</ul>
<p>打开&#x2F;关闭某个插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-apiserver --<span class="built_in">help</span></span></span><br><span class="line">      --admission-control strings</span><br><span class="line">                Admission is divided into two phases. In the first phase, only mutating admission plugins run. In the second phase,</span><br><span class="line">                only validating admission plugins run. The names in the below list may represent a validating plugin, a mutating</span><br><span class="line">                plugin, or both. The order of plugins in which they are passed to this flag does not matter. Comma-delimited list</span><br><span class="line">                of: AlwaysAdmit, AlwaysDeny, AlwaysPullImages, DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec,</span><br><span class="line">                DenyExecOnPrivileged, EventRateLimit, ExtendedResourceToleration, ImagePolicyWebhook,</span><br><span class="line">                LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook, NamespaceAutoProvision, NamespaceExists,</span><br><span class="line">                NamespaceLifecycle, NodeRestriction, OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize,</span><br><span class="line">                PersistentVolumeLabel, PodNodeSelector, PodPreset, PodSecurityPolicy, PodTolerationRestriction, Priority,</span><br><span class="line">                ResourceQuota, RuntimeClass, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection,</span><br><span class="line">                TaintNodesByCondition, ValidatingAdmissionWebhook. (DEPRECATED: Use --enable-admission-plugins or</span><br><span class="line">                --disable-admission-plugins instead. Will be removed in a future version.)</span><br><span class="line">      --admission-control-config-file string</span><br><span class="line">                File with admission control configuration.</span><br><span class="line">      --disable-admission-plugins strings</span><br><span class="line">                admission plugins that should be disabled although they are in the default enabled plugins list</span><br><span class="line">                (NamespaceLifecycle, LimitRanger, ServiceAccount, TaintNodesByCondition, Priority, DefaultTolerationSeconds,</span><br><span class="line">                DefaultStorageClass, StorageObjectInUseProtection, PersistentVolumeClaimResize, MutatingAdmissionWebhook,</span><br><span class="line">                ValidatingAdmissionWebhook, RuntimeClass, ResourceQuota). Comma-delimited list of admission plugins: AlwaysAdmit,</span><br><span class="line">                AlwaysDeny, AlwaysPullImages, DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec,</span><br><span class="line">                DenyExecOnPrivileged, EventRateLimit, ExtendedResourceToleration, ImagePolicyWebhook,</span><br><span class="line">                LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook, NamespaceAutoProvision, NamespaceExists,</span><br><span class="line">                NamespaceLifecycle, NodeRestriction, OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize,</span><br><span class="line">                PersistentVolumeLabel, PodNodeSelector, PodPreset, PodSecurityPolicy, PodTolerationRestriction, Priority,</span><br><span class="line">                ResourceQuota, RuntimeClass, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection,</span><br><span class="line">                TaintNodesByCondition, ValidatingAdmissionWebhook. The order of plugins in this flag does not matter.</span><br><span class="line">      --enable-admission-plugins strings</span><br><span class="line">                admission plugins that should be enabled in addition to default enabled ones (NamespaceLifecycle, LimitRanger,</span><br><span class="line">                ServiceAccount, TaintNodesByCondition, Priority, DefaultTolerationSeconds, DefaultStorageClass,</span><br><span class="line">                StorageObjectInUseProtection, PersistentVolumeClaimResize, MutatingAdmissionWebhook, ValidatingAdmissionWebhook,</span><br><span class="line">                RuntimeClass, ResourceQuota). Comma-delimited list of admission plugins: AlwaysAdmit, AlwaysDeny, AlwaysPullImages,</span><br><span class="line">                DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec, DenyExecOnPrivileged, EventRateLimit,</span><br><span class="line">                ExtendedResourceToleration, ImagePolicyWebhook, LimitPodHardAntiAffinityTopology, LimitRanger,</span><br><span class="line">                MutatingAdmissionWebhook, NamespaceAutoProvision, NamespaceExists, NamespaceLifecycle, NodeRestriction,</span><br><span class="line">                OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, PersistentVolumeLabel, PodNodeSelector,</span><br><span class="line">                PodPreset, PodSecurityPolicy, PodTolerationRestriction, Priority, ResourceQuota, RuntimeClass, SecurityContextDeny,</span><br><span class="line">                ServiceAccount, StorageObjectInUseProtection, TaintNodesByCondition, ValidatingAdmissionWebhook. The order of</span><br><span class="line">                plugins in this flag does not matter.</span><br></pre></td></tr></table></figure>

<h2 id="准入插件的开发"><a href="#准入插件的开发" class="headerlink" title="准入插件的开发"></a>准入插件的开发</h2><p>除默认的准入控制插件以外，Kubernetes 预留了准入控制插件的扩展点，用户可自定义准入控制插件实现自定义准入功能</p>
<ul>
<li>MutatingWebhookConfigurat：变形插件，支持对准入对象的修改</li>
<li>ValidatingWebhookConfiguration：校验插件，只能对准入对象合法性进行校验，不能修改</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117164936287.png" alt="image-20240117164936287"></p>
<p>当在 <code>API Server</code> 上启用 <code>--admission-control</code>，会将 <code>AdmissionReview</code> 转发到对应 <code>Admission Controller</code> 上，返回的准入控制结果如果经过变形或者校验插件，直接更新到对象的 <code>annotation</code> 上，例如 <code>Pod</code>。</p>
<h3 id="准入控制案例"><a href="#准入控制案例" class="headerlink" title="准入控制案例"></a>准入控制案例</h3><p>为资源增加自定义属性</p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在 namespace 的准入控制中，获取用户信息，并将用户信息更新的 namespace 的 annotation</li>
</ul>
<p>只有当 namespace 中有有效用户信息时，才可以在 namespace 创建时，自动绑定用户权限，namespace 才可用。</p>
<p><code>kubectl  get mutatingwebhookconfigurations.admissionregistration.k8s.io</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#123;&#123;if eq .k8snode_validating &quot;enabled&quot;&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1beta1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">ns-mutating.webhook.k8s.io</span> </span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">clientConfig:</span></span><br><span class="line">		<span class="attr">caBundle:</span> &#123;&#123;<span class="string">.serverca_base64</span>&#125;&#125;</span><br><span class="line">		<span class="attr">url:</span> <span class="string">https://admission.local.tess.io/apis/admissio</span> <span class="string">n.k8s.io/v1alpha1/</span> <span class="string">ns-mutating</span></span><br><span class="line">	<span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">ns-mutating.webhook.k8s.io</span> </span><br><span class="line">	<span class="attr">namespaceSelector:</span> &#123;&#125;</span><br><span class="line">	<span class="attr">rules:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    	<span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    	<span class="attr">apiVersions:</span></span><br><span class="line">    	<span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    	<span class="attr">operations:</span></span><br><span class="line">    	<span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    	<span class="attr">resources:</span></span><br><span class="line">    	<span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  	<span class="attr">sideEffects:</span> <span class="string">Unknown</span></span><br><span class="line"><span class="comment"># &#123;&#123;end&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1234</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cncamp/admission-controller-webhook-demo:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webhook-api</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-tls-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/secrets/tls</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-tls-certs</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">webhook-server-tls</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">webhook-api</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-webhook</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-server.webhook-demo.svc</span></span><br><span class="line">    <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br><span class="line">    <span class="attr">clientConfig:</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/mutate&quot;</span></span><br><span class="line">      <span class="attr">caBundle:</span> <span class="string">$&#123;CA_PEM_B64&#125;</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operations:</span> [ <span class="string">&quot;CREATE&quot;</span> ]</span><br><span class="line">        <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">        <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h1 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h1><h2 id="计数器固定窗口算法"><a href="#计数器固定窗口算法" class="headerlink" title="计数器固定窗口算法"></a>计数器固定窗口算法</h2><p>原理就是对一段固定时间窗口内的请求进行计数，如果请求超过了阈值，则舍弃该请求；</p>
<p>如果没有达到设定的阈值，则接受该请求，且计数 +1.</p>
<p>当时间窗口结束时，重置计数器为 0.</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117172551578.png" alt="image-20240117172551578"></p>
<p>这个算法不精确，在某个时间节点流量非常大，第二个窗口也非常大，起不到限流效果。</p>
<h2 id="计数器滑动窗口算法"><a href="#计数器滑动窗口算法" class="headerlink" title="计数器滑动窗口算法"></a>计数器滑动窗口算法</h2><p>在固定窗口的基础上，将一个计时窗口分成了若干个小窗口，然后每个小窗口维护一个独立的计数器。</p>
<p>当请求的时间大于当前窗口的最大时间时，则将计时窗口向前平移一个小窗口。</p>
<p>平移时，将第一个小窗口的数据丢弃，然后将第二个小窗口设置为第一个小窗口，同时在最后面新增一个小窗口，将新的请求放在新增的小窗口中。</p>
<p>同时要保证整个窗口中所有小窗口的请求数目之后不能超过设定的阈值。</p>
<p><img data-src="/../../../../../../Library/Application%20Support/typora-user-images/image-20240117172909954.png" alt="image-20240117172909954"></p>
<p>这个算法不准确，一样会出现两个窗口峰值</p>
<h2 id="漏斗算法"><a href="#漏斗算法" class="headerlink" title="漏斗算法"></a>漏斗算法</h2><p>漏斗算法的原理也很容易理解。请求来了之后，会首先进到漏斗里，然后漏斗以恒定的速率将请求流出进行处理，从而起到平滑流量的作用。</p>
<p>当请求的流量过大时，漏斗达到最大容量时会溢出，此时请求被丢弃。</p>
<p>在系统看来，请求永远是以平滑的传输速率过来，从而起到了保护系统的作用。</p>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117173135949.png" alt="image-20240117173135949"></p>
<h2 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h2><p>令牌桶算法时对漏斗算法的一种改进，出了能够起到限流的作用外，还允许一定程度的流量突发。</p>
<p>在令牌桶算法中，存在一个令牌桶，算法中存在一种机制以恒定的速率向令牌桶中放入令牌。</p>
<p>令牌桶也有一定的容量，如果满了令牌就无法放进去了。</p>
<p>当请求来时，会首先到令牌桶中去拿令牌</p>
<ul>
<li>如果拿到了令牌，则该请求会被处理，并消耗拿到的令牌；</li>
<li>如果令牌桶为空，则该请求会被丢弃。</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2024/01/image-20240117173434981.png" alt="image-20240117173434981"></p>
<h2 id="APIServer-中的限流"><a href="#APIServer-中的限流" class="headerlink" title="APIServer 中的限流"></a>APIServer 中的限流</h2><p>max-requests-inflight：在给定时间内的最大 <code>non-mutating</code> 请求数</p>
<p>max-mutating-requests-inflight：在给定时间内的最大 <code>mutating</code> 请求数，调整 <code>apiserver</code> 的流控 <code>qos</code></p>
<table>
<thead>
<tr>
<th></th>
<th><strong>默认值</strong></th>
<th><strong>节点数</strong>1000-3000</th>
<th><strong>节点数</strong>&gt;3000</th>
</tr>
</thead>
<tbody><tr>
<td>max-requests-inflight</td>
<td>400</td>
<td>1500</td>
<td>3000</td>
</tr>
<tr>
<td>max-mutating-requests-inflight</td>
<td>200</td>
<td>500</td>
<td>1000</td>
</tr>
</tbody></table>
<p>Kubernetes 代码线代码位置：</p>
<p><code>staging/src/k8s.io/apiserver/pkg/server/filters/maxinflight.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithMaxInFlightLimit limits the number of in-flight requests to buffer size of the passed in channel.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithMaxInFlightLimit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	handler http.Handler,</span></span></span><br><span class="line"><span class="params"><span class="function">	nonMutatingLimit <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	mutatingLimit <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	longRunningRequestCheck apirequest.LongRunningRequestCheck,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> http.Handler &#123;</span><br><span class="line">	<span class="keyword">if</span> nonMutatingLimit == <span class="number">0</span> &amp;&amp; mutatingLimit == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> handler</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> nonMutatingChan <span class="keyword">chan</span> <span class="type">bool</span></span><br><span class="line">	<span class="keyword">var</span> mutatingChan <span class="keyword">chan</span> <span class="type">bool</span></span><br><span class="line">	<span class="keyword">if</span> nonMutatingLimit != <span class="number">0</span> &#123;</span><br><span class="line">		nonMutatingChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>, nonMutatingLimit)</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Initialized nonMutatingChan&quot;</span>, <span class="string">&quot;len&quot;</span>, nonMutatingLimit)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Running with nil nonMutatingChan&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> mutatingLimit != <span class="number">0</span> &#123;</span><br><span class="line">		mutatingChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>, mutatingLimit)</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Initialized mutatingChan&quot;</span>, <span class="string">&quot;len&quot;</span>, mutatingLimit)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">&quot;Running with nil mutatingChan&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	initMaxInFlight(nonMutatingLimit, mutatingLimit)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		ctx := r.Context()</span><br><span class="line">		requestInfo, ok := apirequest.RequestInfoFrom(ctx)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			handleError(w, r, fmt.Errorf(<span class="string">&quot;no RequestInfo found in context, handler chain must be wrong&quot;</span>))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Skip tracking long running events.</span></span><br><span class="line">		<span class="keyword">if</span> longRunningRequestCheck != <span class="literal">nil</span> &amp;&amp; longRunningRequestCheck(r, requestInfo) &#123;</span><br><span class="line">			handler.ServeHTTP(w, r)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> c <span class="keyword">chan</span> <span class="type">bool</span></span><br><span class="line">		isMutatingRequest := !nonMutatingRequestVerbs.Has(requestInfo.Verb)</span><br><span class="line">		<span class="keyword">if</span> isMutatingRequest &#123;</span><br><span class="line">			c = mutatingChan</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			c = nonMutatingChan</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">			handler.ServeHTTP(w, r)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> c &lt;- <span class="literal">true</span>:</span><br><span class="line">				<span class="comment">// We note the concurrency level both while the</span></span><br><span class="line">				<span class="comment">// request is being served and after it is done being</span></span><br><span class="line">				<span class="comment">// served, because both states contribute to the</span></span><br><span class="line">				<span class="comment">// sampled stats on concurrency.</span></span><br><span class="line">				<span class="keyword">if</span> isMutatingRequest &#123;</span><br><span class="line">					watermark.recordMutating(<span class="built_in">len</span>(c))</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					watermark.recordReadOnly(<span class="built_in">len</span>(c))</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					&lt;-c</span><br><span class="line">					<span class="keyword">if</span> isMutatingRequest &#123;</span><br><span class="line">						watermark.recordMutating(<span class="built_in">len</span>(c))</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						watermark.recordReadOnly(<span class="built_in">len</span>(c))</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;()</span><br><span class="line">				handler.ServeHTTP(w, r)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="comment">// at this point we&#x27;re about to return a 429, BUT not all actors should be rate limited.  A system:master is so powerful</span></span><br><span class="line">				<span class="comment">// that they should always get an answer.  It&#x27;s a super-admin or a loopback connection.</span></span><br><span class="line">				<span class="keyword">if</span> currUser, ok := apirequest.UserFrom(ctx); ok &#123;</span><br><span class="line">					<span class="keyword">for</span> _, group := <span class="keyword">range</span> currUser.GetGroups() &#123;</span><br><span class="line">						<span class="keyword">if</span> group == user.SystemPrivilegedGroup &#123;</span><br><span class="line">							handler.ServeHTTP(w, r)</span><br><span class="line">							<span class="keyword">return</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// We need to split this data between buckets used for throttling.</span></span><br><span class="line">				metrics.RecordDroppedRequest(r, requestInfo, metrics.APIServerComponent, isMutatingRequest)</span><br><span class="line">				metrics.RecordRequestTermination(r, requestInfo, metrics.APIServerComponent, http.StatusTooManyRequests)</span><br><span class="line">				tooManyRequests(r, w, retryAfter)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="传统限流方法的局限性"><a href="#传统限流方法的局限性" class="headerlink" title="传统限流方法的局限性"></a>传统限流方法的局限性</h2><ul>
<li>粒度粗<ul>
<li>无法为不同用户，不同场景设置不同的限流</li>
</ul>
</li>
<li>单队列<ul>
<li>共享限流窗口&#x2F;桶，一个坏用户可能会将整个系统堵塞，其他正常用户的请求无法被及时处理</li>
</ul>
</li>
<li>不公平<ul>
<li>正常用户的请求会被排到队尾，无法及时处理而饿死</li>
</ul>
</li>
<li>无优先级<ul>
<li>重要的系统指令一并被限流，系统故障难以恢复</li>
</ul>
</li>
</ul>
<h2 id="API-Priority-and-Fairness"><a href="#API-Priority-and-Fairness" class="headerlink" title="API Priority and Fairness"></a>API Priority and Fairness</h2><p>在 Kubernetes v1.18 版本之后，引入优先级和公平性</p>
<ul>
<li>APF 以更细粒度的方式对请求进行分类和隔离</li>
<li>它还引入了空间有限的排队机制，因此在非常短暂的突发情况下，API 服务器不会拒绝任何请求</li>
<li>通过使用公平排队技术从队列中分发请求，这样，一个行为不佳的控制器就不会饿死其他控制器（即使优先级相同）</li>
<li>APF 的核心<ul>
<li>多等级</li>
<li>多队列</li>
</ul>
</li>
</ul>
<p><img data-src="/../../../../../../Library/Application%20Support/typora-user-images/image-20240117174933551.png" alt="image-20240117174933551"></p>
<p>不同的等级划分为不同的 Flow，当某个请求阻塞，不影响其他的 Flow。</p>
<ul>
<li>APF 的实现依赖两个非常重要的资源 FlowSchema, PriorityLevelConfiguration</li>
<li>APF 对请求进行更细粒度的分类，每一个请求分类对应一个 FlowSchema（FS）</li>
<li>FS 内的请求又会根据 <code>distinguisher</code> 进一步划分为不同的 Flow</li>
<li>FS 会设置一个优先级（Priority Level，PL），不同优先级的并发资源是隔离的。所以不同优先级的资源不会被互相排挤。特定优先级的请求可以被高优处理。</li>
<li>一个 PL 可以对应多个 FS，PL 中维护了一个 QueueSet，用于缓存不能及时处理的请求，请求不会因为超出 PL 的并发限制而被丢弃。</li>
<li>FS 中的每个 Flow 通过 shuffle sharding 算法从 QueueSet 选取特定的 <code>queues</code> 缓存请求</li>
<li>每次从 QueueSet 中取请求执行时，会先应用 <code>fair queuing</code> 算法从 QueueSet 中选中一个 queue，然后从这个 queue 中取出 <code>oldest</code> 请求执行。所以即使是同一个 PL 内的请求，也不会出现一个 Flow 内的请求一直占用资源的不公平现象。</li>
</ul>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>传入的请求，通过 FlowSchema 按照其属性分类，并分配优先级</li>
<li>每个优先级维护自定义的并发限制，加强了隔离度，这样不同优先级的请求，就不会相互饿死</li>
<li>在同一个优先级内，公平排队算法可以防止不同 <code>flow</code> 的请求相互饿死</li>
<li>该算法将请求排队，通过排队机制，防止在平均负载较低时，通信量突增而导致请求失败</li>
</ul>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><ul>
<li>如果未启用 APF，API 服务器中的整体并发量将受到 <code>kube-apiserver</code> 的参数 <code>--max-requests-inflight</code> 和 <code>--max-mutating-requests-inflight</code> 的限制</li>
<li>启用 APF 后，将对这些参数定义的并发限制进行求和，然后将总和分配到一组可配置的优先级中。每个传入的请求都会分配一个优先级；</li>
<li>每个优先级都有各自的配置，设定允许分发的并发请求数；</li>
<li>例如，默认配置包括针对领导者选举请求、内置控制器请求和 Pod 请求都单独设置优先级。这表示即使异常的 Pod 向 API 服务器发送大量请求，也无法阻止领导者选举或内置控制器的操作执行成功；</li>
</ul>
<h3 id="排队"><a href="#排队" class="headerlink" title="排队"></a>排队</h3><ul>
<li>即使在同一优先级内，也可能存在大量不同的流量源</li>
<li>在过载的情况下，防止一个请求流饿死其他流是非常有价值的（尤其是在一个较为常见的场景中，一个有故障的客户端会疯狂地向 <code>kube-apiserver</code> 发送请求，理想情况下，这个有故障的客户端不应对其他客户端产生太大的影响）</li>
<li>公平排队算法在处理具有相同优先级的请求时，实现了上述场景</li>
<li>每个请求都被分配到某个 流（<code>Flow</code>） 中，该流由对应的 <code>FlowSchema</code> 的名字加上一个 流区分项（<code>FlowDistinguisher</code>）来标识</li>
<li>这里的流区分项可以是发出请求的用户、目标资源的名称空间或什么都不是</li>
<li>系统尝试为不同流中具有相同优先级的请求赋予近似相等的权重</li>
<li>将请求划分到流中之后，API 功能将请求分配到队列中</li>
<li>分配时使用一种称为 混洗分片（<code>Shuffle-Sharding</code>）的技术。该技术可以相对有效地利用队列隔离低强度流于高强度流</li>
<li>排队算法的细节可针对每个优先等级进行调整，并允许管理员在内存占用、公平性（当总流量超标时，各个独立的流将都会取得进展）、突发流量的容忍度以及排队引发的额外延迟之间进行权衡</li>
</ul>
<h3 id="豁免请求"><a href="#豁免请求" class="headerlink" title="豁免请求"></a>豁免请求</h3><p>某些特别重要的请求不受制于此特性施加的任何限制。</p>
<p>这些豁免可防止不当的流控配置完全禁用 API 服务器。</p>
<h3 id="优先级默认配置"><a href="#优先级默认配置" class="headerlink" title="优先级默认配置"></a>优先级默认配置</h3><ul>
<li><code>system</code><ul>
<li>用于 <code>system:nodes</code> 组（即 <code>kubelets</code> ）的请求；<code>kuberlets</code> 必须能连上 API 服务器，以便工作负载能够调度到其上</li>
</ul>
</li>
<li><code>leader-election</code><ul>
<li>用于内置控制器的领导选举的请求（特别是来自 <code>kube-system</code> 名称空间中 <code>system:kube-controller-manager</code> 和 <code>system:kube-scheduler</code> 用户和服务账号，针对 <code>endpoints</code>、<code>configmaps</code> 或 <code>leases</code> 的请求）。</li>
<li>将这些请求与其他流量相隔离非常重要，因为领导者选举失败会导致控制器发生故障并重新启动，这反过来会导致新启动的控制器在同步信息时，流量开销更大</li>
</ul>
</li>
<li><code>workload-high</code><ul>
<li>优先级用于内置控制器的请求</li>
</ul>
</li>
<li><code>workload-low</code><ul>
<li>优先级适用于来自任何服务账号的请求，通常包括来自 Pods 中运行的控制器的所有请求</li>
</ul>
</li>
<li><code>global-default </code><ul>
<li>优先级可处理所有其他流量，例如：非特权用户运行的交互式 <code>kubectl</code> 命令</li>
</ul>
</li>
<li><code>exempt</code><ul>
<li>优先级的请求完全不受流控限制：它们总是立刻被分发。特殊的 <code>exempt FlowSchema</code> 把 <code>system:masters</code> 组的所有请求都归入该优先级组</li>
</ul>
</li>
<li><code>catch-all</code><ul>
<li>优先级与特殊的 <code>catch-all FlowSchema</code> 结合使用，以确保每个请求都分类</li>
<li>一般不应依赖于 <code>catch-all</code> 的配置，而应适当地创建自己的 <code>catch-all FlowSchema</code> 和 <code>PriorityLevelConfigurations</code>（或使用默认安装的 <code>global-default</code> 配置）</li>
<li>为了帮助捕获部分请求未分类的配置错误，强制要求 <code>catch-all</code> 优先级仅允许 5 个并发份额，并且不对请求进行排队，使得仅与 <code>catch-all FlowSchema</code> 匹配的流量被拒绝的可能性更高，并显示 <code>HTTP 429</code> 错误。</li>
</ul>
</li>
</ul>
<h3 id="PriorityLevelConfiguration"><a href="#PriorityLevelConfiguration" class="headerlink" title="PriorityLevelConfiguration"></a>PriorityLevelConfiguration</h3><p>一个 PriorityLevelConfiguration 表示单个隔离类型。</p>
<p>每个 PriorityLevelConfigurations 对未完成的请求数有各自的限制，对排队中的请求数也有限制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl  get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io</span></span><br><span class="line">NAME              TYPE      NOMINALCONCURRENCYSHARES   QUEUES   HANDSIZE   QUEUELENGTHLIMIT   AGE</span><br><span class="line">catch-all         Limited   5                          &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             6d12h</span><br><span class="line">exempt            Exempt    &lt;none&gt;                     &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             6d12h</span><br><span class="line">global-default    Limited   20                         128      6          50                 6d12h</span><br><span class="line">leader-election   Limited   10                         16       4          50                 6d12h</span><br><span class="line">node-high         Limited   40                         64       6          50                 6d12h</span><br><span class="line">system            Limited   30                         64       6          50                 6d12h</span><br><span class="line">workload-high     Limited   40                         128      6          50                 6d12h</span><br><span class="line">workload-low      Limited   100                        128      6          50                 6d12h</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io global-default -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">apf.kubernetes.io/autoupdate-spec:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-11T13:00:16Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">global-default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;35&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">3c04ba32-58a1-45fd-a09e-1a9c93a65667</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limited:</span></span><br><span class="line">    <span class="attr">lendablePercent:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">limitResponse:</span></span><br><span class="line">      <span class="attr">queuing:</span></span><br><span class="line">        <span class="attr">handSize:</span> <span class="number">6</span>   <span class="comment"># shuffle sharding 的配置，每个flowschema+distinguisher的请求会被enqueue到多少个对列</span></span><br><span class="line">        <span class="attr">queueLengthLimit:</span> <span class="number">50</span> <span class="comment"># 每个队列中的对象数量</span></span><br><span class="line">        <span class="attr">queues:</span> <span class="number">128</span>		<span class="comment"># 当前PriorityLevel的队列总数</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Queue</span></span><br><span class="line">    <span class="attr">nominalConcurrencyShares:</span> <span class="number">20</span>	<span class="comment"># 允许的并发请求</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Limited</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FlowSchema"><a href="#FlowSchema" class="headerlink" title="FlowSchema"></a>FlowSchema</h3><p>FlowSchema 匹配一些入站请求，并将它们分配给优先级。</p>
<p>每个入站请求都会对所有 FlowSchema 测试是否匹配，首先从 matchingPrecedence 数值最低的匹配开始（我们认为这是逻辑上匹配度最高），然后依次进行，直到首个匹配出现。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl  get flowschemas.flowcontrol.apiserver.k8s.io</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">PRIORITYLEVEL</span>     <span class="string">MATCHINGPRECEDENCE</span>   <span class="string">DISTINGUISHERMETHOD</span>   <span class="string">AGE</span>     <span class="string">MISSINGPL</span></span><br><span class="line"><span class="string">exempt</span>                         <span class="string">exempt</span>            <span class="number">1</span>                    <span class="string">&lt;none&gt;</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">probes</span>                         <span class="string">exempt</span>            <span class="number">2</span>                    <span class="string">&lt;none&gt;</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">system-leader-election</span>         <span class="string">leader-election</span>   <span class="number">100</span>                  <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">endpoint-controller</span>            <span class="string">workload-high</span>     <span class="number">150</span>                  <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">workload-leader-election</span>       <span class="string">leader-election</span>   <span class="number">200</span>                  <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">system-node-high</span>               <span class="string">node-high</span>         <span class="number">400</span>                  <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">system-nodes</span>                   <span class="string">system</span>            <span class="number">500</span>                  <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">kube-controller-manager</span>        <span class="string">workload-high</span>     <span class="number">800</span>                  <span class="string">ByNamespace</span>           <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">kube-scheduler</span>                 <span class="string">workload-high</span>     <span class="number">800</span>                  <span class="string">ByNamespace</span>           <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">kube-system-service-accounts</span>   <span class="string">workload-high</span>     <span class="number">900</span>                  <span class="string">ByNamespace</span>           <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">service-accounts</span>               <span class="string">workload-low</span>      <span class="number">9000                 </span><span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">global-default</span>                 <span class="string">global-default</span>    <span class="number">9900                 </span><span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br><span class="line"><span class="string">catch-all</span>                      <span class="string">catch-all</span>         <span class="number">10000</span>                <span class="string">ByUser</span>                <span class="string">6d13h</span>   <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get flowschemas.flowcontrol.apiserver.k8s.io kube-scheduler -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">FlowSchema</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">apf.kubernetes.io/autoupdate-spec:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-11T13:00:17Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-scheduler</span>		<span class="comment"># FlowSchema名</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;57&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">a5dfa5c1-bc65-4d6a-b073-3f3e6d271af8</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">distinguisherMethod:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ByNamespace</span>		<span class="comment"># Distinguisher。由 FlowSchema名和 Distinguisher 确定一个 flow</span></span><br><span class="line">  <span class="attr">matchingPrecedence:</span> <span class="number">800</span>		<span class="comment">#    规则优先级</span></span><br><span class="line">  <span class="attr">priorityLevelConfiguration:</span>		<span class="comment">#  对应的队列优先级</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">workload-high</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceRules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">resourceRules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">clusterScope:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">namespaces:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span>					<span class="comment"># 对应的资源和请求类型</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">subjects:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">system:kube-scheduler</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-01-11T13:00:17Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">This</span> <span class="string">FlowSchema</span> <span class="string">references</span> <span class="string">the</span> <span class="string">PriorityLevelConfiguration</span> <span class="string">object</span> <span class="string">named</span></span><br><span class="line">      <span class="string">&quot;workload-high&quot;</span> <span class="string">and</span> <span class="string">it</span> <span class="string">exists</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Found</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Dangling</span></span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>获取优先级及其当前状态的列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get --raw /debug/api_priority_and_fairness/dump_priority_levels</span></span><br><span class="line">PriorityLevelName, ActiveQueues, IsIdle, IsQuiescing, WaitingRequests, ExecutingRequests, DispatchedRequests, RejectedRequests, TimedoutRequests, CancelledRequests</span><br><span class="line">catch-all,         0,            true,   false,       0,               0,                 38,                 0,                0,                0</span><br><span class="line">exempt,            0,            true,   false,       0,               0,                 3228,               0,                0,                0</span><br><span class="line">global-default,    0,            false,  false,       0,               1,                 82,                 0,                0,                0</span><br><span class="line">leader-election,   0,            true,   false,       0,               0,                 3839,               0,                0,                0</span><br><span class="line">node-high,         0,            true,   false,       0,               0,                 399,                0,                0,                0</span><br><span class="line">system,            0,            true,   false,       0,               0,                 202,                0,                0,                0</span><br><span class="line">workload-high,     0,            true,   false,       0,               0,                 907,                0,                0,                0</span><br><span class="line">workload-low,      0,            true,   false,       0,               0,                 10,                 0,                0,                0</span><br></pre></td></tr></table></figure>

<p>查看队列及其当前状态的列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get --raw /debug/api_priority_and_fairness/dump_queues</span></span><br><span class="line">PriorityLevelName, Index,  PendingRequests, ExecutingRequests, SeatsInUse, NextDispatchR, InitialSeatsSum, MaxSeatsSum, TotalWorkSum</span><br><span class="line">workload-high,     0,      0,               0,                 0,          0.00000000ss,  0,               0,           0.00000000ss</span><br><span class="line">workload-high,     1,      0,               0,                 0,          0.00000000ss,  0,               0,           0.00000000ss</span><br><span class="line">workload-high,     2,      0,               0,                 0,          0.00000000ss,  0,               0,           0.00000000ss</span><br><span class="line">workload-high,     3,      0,               0,                 0,          0.00000000ss,  0,               0,           0.00000000ss</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>当前正在队列中等待的所有请求的列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get --raw /debug/api_priority_and_fairness/dump_requests</span></span><br><span class="line">PriorityLevelName, FlowSchemaName, QueueIndex, RequestIndexInQueue, FlowDistingsher,  ArriveTime,                     InitialSeats, FinalSeats, AdditionalLatency, StartTime</span><br><span class="line">global-default,    global-default, 5,          -1,                  kubernetes-admin, 2024-01-18T06:19:07.260666899Z, 1,            0,          0s,                2024-01-18T06:19:07.260686264Z</span><br></pre></td></tr></table></figure>

<h1 id="APIServer-对象的实现"><a href="#APIServer-对象的实现" class="headerlink" title="APIServer 对象的实现"></a>APIServer 对象的实现</h1><h2 id="高可用-APIServer"><a href="#高可用-APIServer" class="headerlink" title="高可用 APIServer"></a>高可用 APIServer</h2><p>启动 <code>apiserver</code> 实例（作为一个独立的进程）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.239.128 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://127.0.0.1:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">改为新端口，不与本地端口冲突</span></span><br><span class="line">  --secure-port=6444 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">  --service-cluster-ip-range=10.1.0.0/16 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br></pre></td></tr></table></figure>

<h3 id="构建高可用的多副本-apiserver"><a href="#构建高可用的多副本-apiserver" class="headerlink" title="构建高可用的多副本 apiserver"></a>构建高可用的多副本 apiserver</h3><p><code>apiserver</code> 是无状态的 <code>Reset Server</code></p>
<p>无状态所以方便 <code>Scale up/down</code></p>
<p>负载均衡</p>
<ul>
<li>在多个 <code>apiserver</code> 实例之上，配置负载均衡</li>
<li>证书可能需要加上 <code>Loadbalancer VIP</code> 重新生成</li>
</ul>
<h3 id="预留充足的-CPU、内存资源"><a href="#预留充足的-CPU、内存资源" class="headerlink" title="预留充足的 CPU、内存资源"></a>预留充足的 CPU、内存资源</h3><p>随着集群中节点数量不断增多，APIServer 对 CPU 和内存的开销也不断增大。过少的 CPU 资源会降低其处理效率，过少的内存资源会导致 Pod 被 OOMKilled，直接导致服务不可用。在规划 APIServer 资源时，不能仅看当下需求，也要为未来预留充分。</p>
<p>使用 <code>kubelet</code> 启动 <code>apiserver</code> 可以通过 <code>k8s</code> 携带的探活保障服务异常时自动启动。</p>
<h3 id="善用速率限制（RateLimit）"><a href="#善用速率限制（RateLimit）" class="headerlink" title="善用速率限制（RateLimit）"></a>善用速率限制（RateLimit）</h3><p>APIServer 的参数 <code>--max-mutating-requests-inflight</code> 支持在给定时间内限制并行处理读请求（包括 Get、List 和 Watch 操作）和写请求（包括 Create、Delete、Update 和 Patch 操作）的最大数量。</p>
<p>当 APIServer 接收到的请求超过这两个参数设定的值时，再接收到的请求将会被直接拒绝。</p>
<p>通过速率限制机制，可以有效地控制 APIServer 内存的使用。</p>
<p>如果该配置过低，会经常出现请求超过限制的错误，如果配置过高，则 APIServer 可能会因为占用过多内存而被强制终止，因此需要根据实际的运行环境，结合实时用户请求数量和 APIServer 的资源配置进行调优。</p>
<p>客户端在接收到拒绝请求的返回值后，应等待一段时间再发起重试，无间隔的重试会加重  APISerer 的压力，导致性能进一步降低。针对并行处理请求数的过滤颗粒度太大，在请求数量比较多的场景，重要的消息可能会被拒绝掉，自 1.18 版本开始，社区引入了优先级和公平保证（Priority and Fairness）功能，以提供更细粒度地客户端请求控制。该功能支持将不同用户或不同类型的请求进行优先级归类，保证高优先级的请求总是能够更快得到处理，从而不受低优先级请求的影响。</p>
<h3 id="设置合适的缓存大小"><a href="#设置合适的缓存大小" class="headerlink" title="设置合适的缓存大小"></a>设置合适的缓存大小</h3><p>APIServer 与 etcd 之间基于 gRPC 协议进行通信，gRPC 协议保证了二者在大规模集群中的数据高速传输。gRPC 基于连接复用的 HTTP&#x2F;2 协议，即针对相同分组的对象，APIServer 和 etcd 之间共享相同的 TCP 连接，不同请求由不同的 <code>stream</code> 传输。</p>
<p>一个 HTTP&#x2F;2 连接有其 <code>stream</code> 配额，配额的大小限制了能支持的并发请求。APIServer 提供了集群对象的缓存机制，当客户端发起查询请求时，APIServer 默认会将其缓存（新数据覆盖老数据）直接返回给客户端。</p>
<p>缓存区大小可以通过参数 <code>--watch-cache-sizes</code> 设置。针对访问请求比较多的对象，适当设置缓存的大小，极大降低对 <code>etcd</code> 的访问频率，节省了网络调用，降低了对 <code>etcd</code> 集群的读写压力，从而提高对象访问的性能。</p>
<p>写入操作会直接写入 <code>etcd</code>，读取操作会先从缓存中读取。</p>
<p>但是 APIServer 也是允许客户端忽略缓存的，例如客户端请求中 <code>ListOption</code> 中没有设置 <code>resourceVersion</code>，这时 APIServer 直接从 <code>etcd</code> 拉取最新数据返回给客户端。客户端应尽量避免此操作，应在 <code>ListOption</code> 中设置 <code>resourceVersion</code> 为0，APIServer 则将从缓存里读取数据，而不会直接访问 <code>etcd</code>。</p>
<h3 id="客户端尽量使用长连接"><a href="#客户端尽量使用长连接" class="headerlink" title="客户端尽量使用长连接"></a>客户端尽量使用长连接</h3><p>当查询请求的返回数据较大且此类请求并发量较大时，容易引发 TCP 链路的阻塞，导致其他查询操作超时。</p>
<p>因此基于 Kubernetes 开发组件时，例如某些 DaemonSet 和 Controller，如果要查询某类对象，应尽量通过长连接 <code>ListWatch</code> 监听对象变更，避免全量从 <code>APIServer</code> 获取资源。（当资源出现变更，使用监听传输的数据很少，增量传输。但是单独获取可能出现 <code>apiserver</code> 从 <code>etcd</code> 中全量获取，过滤之后返回给调用端）</p>
<p>如果在同一应用程序中，如果有多个 <code>Informer</code> 监听 <code>APIServer</code> 资源变化，可以将这些 <code>Informer</code> 合并，减少和 APIServer 的长连接数，从而降低对 APIServer 的压力。</p>
<h3 id="访问-APIServer"><a href="#访问-APIServer" class="headerlink" title="访问 APIServer"></a>访问 APIServer</h3><p>对外部客户（<code>user</code>、<code>client</code>、<code>admin</code>），永远只通过 <code>LoadBalancer</code> 访问。</p>
<p>只有当负载均衡出现故障时，管理员才切换到 <code>apiserver IP</code> 进行管理。</p>
<p>内部客户端，优先访问 <code>Cluster IP</code>，重要情况下，直接访问 <code>apiserver IP</code>，不重要则使用 LB。但是 Kubernetes 组件最好统一使用同一个入口，避免出现异常的时候，组件表现出不一致的现象。</p>
<table>
<thead>
<tr>
<th>Client type</th>
<th>外部LB VIP</th>
<th>serviec cluster IP</th>
<th>apiserver IP</th>
</tr>
</thead>
<tbody><tr>
<td>Internal</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>External</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
</tr>
</tbody></table>
<h2 id="搭建多租户的-Kubernetes-集群"><a href="#搭建多租户的-Kubernetes-集群" class="headerlink" title="搭建多租户的 Kubernetes 集群"></a>搭建多租户的 Kubernetes 集群</h2><p>授信</p>
<ul>
<li>认证<ul>
<li>禁止匿名访问，只允许可信用户做操作</li>
</ul>
</li>
<li>授权<ul>
<li>基于授信的操作，防止多用户之间相互影响，比如普通用户删除 Kubernetes 核心服务，或者 A 用户删除或修改 B 用户的应用（基于鉴权，分隔用户权限）</li>
</ul>
</li>
</ul>
<p>隔离</p>
<ul>
<li>可见行隔离<ul>
<li>用户只关心自己的应用，无需看到其他用户的服务和部署</li>
</ul>
</li>
<li>资源隔离<ul>
<li>有些关键项目对资源需求较高，需要专有设备，不与其他人共享</li>
</ul>
</li>
<li>应用访问隔离<ul>
<li>用户创建的服务，按既定规则允许其他用户访问</li>
</ul>
</li>
</ul>
<p>资源管理</p>
<ul>
<li>Quota 管理<ul>
<li>针对不同用户，设置资源限制</li>
</ul>
</li>
</ul>
<h3 id="认证-1"><a href="#认证-1" class="headerlink" title="认证"></a>认证</h3><p>与企业现有认证系统集成</p>
<ul>
<li>很多企业基于 Microsoft Active Directory 提供认证服务</li>
</ul>
<p>选择认证插件</p>
<ul>
<li>选择 <code>webhook</code> 作为认证插件</li>
<li>选择 Keystone 作为认证插件，以  Microsoft AD 作为 <code>backend</code> 搭建 keystone 服务</li>
</ul>
<p>一旦认证完成，Kubernetes 即可获取当前用户信息（主要是用户名），并针对该用户做授权。授权和准入控制完成后，该用户的请求完成。</p>
<h3 id="注册-APIService"><a href="#注册-APIService" class="headerlink" title="注册 APIService"></a>注册 APIService</h3><p>将不同的服务注册到 APIServices 中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get apiservices.apiregistration.k8s.io</span></span><br><span class="line">NAME                                   SERVICE   AVAILABLE   AGE</span><br><span class="line">v1.                                    Local     True        76m</span><br><span class="line">v1.admissionregistration.k8s.io        Local     True        76m</span><br><span class="line">v1.apiextensions.k8s.io                Local     True        76m</span><br><span class="line">v1.apps                                Local     True        76m</span><br><span class="line">v1.authentication.k8s.io               Local     True        76m</span><br><span class="line">v1.authorization.k8s.io                Local     True        76m</span><br><span class="line">v1.autoscaling                         Local     True        76m</span><br><span class="line">v1.batch                               Local     True        76m</span><br><span class="line">v1.certificates.k8s.io                 Local     True        76m</span><br><span class="line">v1.coordination.k8s.io                 Local     True        76m</span><br><span class="line">v1.discovery.k8s.io                    Local     True        76m</span><br><span class="line">v1.events.k8s.io                       Local     True        76m</span><br><span class="line">v1.flowcontrol.apiserver.k8s.io        Local     True        76m</span><br><span class="line">v1.networking.k8s.io                   Local     True        76m</span><br><span class="line">v1.node.k8s.io                         Local     True        76m</span><br><span class="line">v1.policy                              Local     True        76m</span><br><span class="line">v1.rbac.authorization.k8s.io           Local     True        76m</span><br><span class="line">v1.scheduling.k8s.io                   Local     True        76m</span><br><span class="line">v1.storage.k8s.io                      Local     True        76m</span><br><span class="line">v1beta3.flowcontrol.apiserver.k8s.io   Local     True        76m</span><br><span class="line">v2.autoscaling                         Local     True        76m</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get apiservices.apiregistration.k8s.io v1. -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-18T05:45:52Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kube-aggregator.kubernetes.io/automanaged:</span> <span class="string">onstart</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1.</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;16&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">189a8967-9833-4770-988b-34c22c0fc2c4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">18000</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2024-01-18T05:45:52Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Local</span> <span class="string">APIServices</span> <span class="string">are</span> <span class="string">always</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Local</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br></pre></td></tr></table></figure>

<h3 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h3><p>ABAC 有局限性，需要针对每个 account 做配置，并且需要重启 <code>apiserver</code>。</p>
<p>RBAC 更灵活，更符合我们通常熟知的权限管理。</p>
<p>针对不同类型用户，规划系统角色，例如 <code>User</code>、<code>SystemAccount</code>。</p>
<h2 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a>apimachinery</h2><p>例如要开发一个对象，可以参考 <code>apimachinery</code> 的代码实现</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMvYXBpbWFjaGluZXJ5">https://github.com/kubernetes/apimachinery<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMva3ViZXJuZXRlcy90cmVlL21hc3Rlci9zdGFnaW5nL3NyYy9rOHMuaW8vYXBpbWFjaGluZXJ5">https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/apimachinery<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="对象核心内容：GKV"><a href="#对象核心内容：GKV" class="headerlink" title="对象核心内容：GKV"></a>对象核心内容：GKV</h3><p>Group：组，区分访问 APIServer 的 stream </p>
<p>Kind：代表 <code>Node</code> 还是 <code>Pod</code></p>
<p>Version：</p>
<ul>
<li><code>Internel version</code> 和 <code>External version</code>：前者面向外部调用的用户，后者面向集群之间（集群之间3个版本内兼容）</li>
<li>版本转换（老版本和新版本之间是向前兼容 3 个版本）</li>
</ul>
<h3 id="定义-Group"><a href="#定义-Group" class="headerlink" title="定义 Group"></a>定义 Group</h3><p><code>pkg/apis/testapigroup/register.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> testapigroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 SchemeBuilder</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">	AddToScheme   = SchemeBuilder.AddToScheme</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GroupName is the group name use in this package</span></span><br><span class="line"><span class="keyword">const</span> GroupName = <span class="string">&quot;testapigroup.apimachinery.k8s.io&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SchemeGroupVersion is group version used to register these objects</span></span><br><span class="line"><span class="keyword">var</span> SchemeGroupVersion = schema.GroupVersion&#123;Group: GroupName, Version: runtime.APIVersionInternal&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Kind takes an unqualified kind and returns a Group qualified GroupKind</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Kind</span><span class="params">(kind <span class="type">string</span>)</span></span> schema.GroupKind &#123;</span><br><span class="line">	<span class="keyword">return</span> SchemeGroupVersion.WithKind(kind).GroupKind()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Resource</span><span class="params">(resource <span class="type">string</span>)</span></span> schema.GroupResource &#123;</span><br><span class="line">	<span class="keyword">return</span> SchemeGroupVersion.WithResource(resource).GroupResource()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将对象加入SchemeBuild</span></span><br><span class="line"><span class="comment">// Adds the list of known types to the given scheme.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">		&amp;Carp&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义对象类型-types-go"><a href="#定义对象类型-types-go" class="headerlink" title="定义对象类型 types.go"></a>定义对象类型 types.go</h3><p>List：单一对象数据结构</p>
<ul>
<li>TypeMeta</li>
<li>ObjectMeta</li>
<li>Spec</li>
<li>Status</li>
</ul>
<p>例如 <code>Node</code> 的定义</p>
<p><code>staging/src/k8s.io/api/core/v1/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node is a worker node in Kubernetes.</span></span><br><span class="line"><span class="comment">// Each node will have a unique identifier in the cache (i.e. in etcd).</span></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">	metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">	<span class="comment">// Standard object&#x27;s metadata.</span></span><br><span class="line">	<span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line">	<span class="comment">// +optional</span></span><br><span class="line">	metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Spec defines the behavior of a node.</span></span><br><span class="line">	<span class="comment">// https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line">	<span class="comment">// +optional</span></span><br><span class="line">	Spec NodeSpec <span class="string">`json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name=spec&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Most recently observed status of the node.</span></span><br><span class="line">	<span class="comment">// Populated by the system.</span></span><br><span class="line">	<span class="comment">// Read-only.</span></span><br><span class="line">	<span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line">	<span class="comment">// +optional</span></span><br><span class="line">	Status NodeStatus <span class="string">`json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name=status&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>TypeMeta</code> 的定义：<code>staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TypeMeta describes an individual object in an API response or request</span></span><br><span class="line"><span class="comment">// with strings representing the type of the object and its API schema version.</span></span><br><span class="line"><span class="comment">// Structures that are versioned or persisted should inline TypeMeta.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen=false</span></span><br><span class="line"><span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line">	<span class="comment">// Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line">	<span class="comment">// Cannot be updated.</span></span><br><span class="line">	<span class="comment">// In CamelCase.</span></span><br><span class="line">	<span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line">	<span class="comment">// +optional</span></span><br><span class="line">	Kind <span class="type">string</span> <span class="string">`json:&quot;kind,omitempty&quot; protobuf:&quot;bytes,1,opt,name=kind&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line">	<span class="comment">// Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line">	<span class="comment">// may reject unrecognized values.</span></span><br><span class="line">	<span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line">	<span class="comment">// +optional</span></span><br><span class="line">	APIVersion <span class="type">string</span> <span class="string">`json:&quot;apiVersion,omitempty&quot; protobuf:&quot;bytes,2,opt,name=apiVersion&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代码生成-Tags"><a href="#代码生成-Tags" class="headerlink" title="代码生成 Tags"></a>代码生成 Tags</h3><p>在代码中会有一些 tag</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +genclient</span></span><br><span class="line"><span class="comment">// +genclient:nonNamespaced</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br></pre></td></tr></table></figure>

<p>以及在 <code>doc.go</code> 中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:openapi-gen=true</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen=package</span></span><br><span class="line"><span class="comment">// +k8s:protobuf-gen=package</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Package v1 is the v1 version of the core API.</span></span><br><span class="line"><span class="keyword">package</span> v1 <span class="comment">// import &quot;k8s.io/api/core/v1&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>Global Tags</code>：</p>
<ul>
<li><p>定义在 <code>doc.go</code> </p>
<ul>
<li><pre><code>// +k8s:deepcopy-gen=package // 深拷贝，包含里面的指针
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`Local Tags`</span><br><span class="line"></span><br><span class="line">* 定义在 `types.go` 中的每个对象里</span><br><span class="line"></span><br><span class="line">  * ```</span><br><span class="line">    // 生成接口</span><br><span class="line">    // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="实现-etcd-storage"><a href="#实现-etcd-storage" class="headerlink" title="实现 etcd storage"></a>实现 etcd storage</h3><p>例如操作 <code>configMap</code> 到 <code>etcd</code> 时的策略</p>
<p><code>pkg/registry/core/configmap/storage/storage.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewREST returns a RESTStorage object that will work with ConfigMap objects.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewREST</span><span class="params">(optsGetter generic.RESTOptionsGetter)</span></span> (*REST, <span class="type">error</span>) &#123;</span><br><span class="line">	store := &amp;genericregistry.Store&#123;</span><br><span class="line">		NewFunc:                   <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object &#123; <span class="keyword">return</span> &amp;api.ConfigMap&#123;&#125; &#125;,</span><br><span class="line">		NewListFunc:               <span class="function"><span class="keyword">func</span><span class="params">()</span></span> runtime.Object &#123; <span class="keyword">return</span> &amp;api.ConfigMapList&#123;&#125; &#125;,</span><br><span class="line">		PredicateFunc:             configmap.Matcher,</span><br><span class="line">		DefaultQualifiedResource:  api.Resource(<span class="string">&quot;configmaps&quot;</span>),</span><br><span class="line">		SingularQualifiedResource: api.Resource(<span class="string">&quot;configmap&quot;</span>),</span><br><span class="line"></span><br><span class="line">		CreateStrategy: configmap.Strategy,  	<span class="comment">// 创建时的策略</span></span><br><span class="line">		UpdateStrategy: configmap.Strategy,		<span class="comment">// 更新时的策略</span></span><br><span class="line">		DeleteStrategy: configmap.Strategy,		<span class="comment">// 删除时的策略</span></span><br><span class="line"></span><br><span class="line">		TableConvertor: printerstorage.TableConvertor&#123;TableGenerator: printers.NewTableGenerator().With(printersinternal.AddHandlers)&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	options := &amp;generic.StoreOptions&#123;</span><br><span class="line">		RESTOptions: optsGetter,</span><br><span class="line">		AttrFunc:    configmap.GetAttrs,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := store.CompleteWithOptions(options); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;REST&#123;store&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建和更新对象时的业务逻辑 - Strategy</p>
<p><code>pkg/registry/core/configmap/strategy.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Strategy is the default logic that applies when creating and updating ConfigMap</span></span><br><span class="line"><span class="comment">// objects via the REST API.</span></span><br><span class="line"><span class="keyword">var</span> Strategy = strategy&#123;legacyscheme.Scheme, names.SimpleNameGenerator&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(strategy)</span></span> PrepareForCreate(ctx context.Context, obj runtime.Object) &#123;</span><br><span class="line">	configMap := obj.(*api.ConfigMap)</span><br><span class="line">	dropDisabledFields(configMap, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(strategy)</span></span> Validate(ctx context.Context, obj runtime.Object) field.ErrorList &#123;</span><br><span class="line">	cfg := obj.(*api.ConfigMap)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> validation.ValidateConfigMap(cfg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(strategy)</span></span> PrepareForUpdate(ctx context.Context, newObj, oldObj runtime.Object) &#123;</span><br><span class="line">	oldConfigMap := oldObj.(*api.ConfigMap)</span><br><span class="line">	newConfigMap := newObj.(*api.ConfigMap)</span><br><span class="line">	dropDisabledFields(newConfigMap, oldConfigMap)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象更新时的校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(strategy)</span></span> ValidateUpdate(ctx context.Context, newObj, oldObj runtime.Object) field.ErrorList &#123;</span><br><span class="line">	oldCfg, newCfg := oldObj.(*api.ConfigMap), newObj.(*api.ConfigMap)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> validation.ValidateConfigMapUpdate(newCfg, oldCfg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pkg/apis/core/validation/validation.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ValidateConfigMapUpdate tests if required fields in the ConfigMap are set.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidateConfigMapUpdate</span><span class="params">(newCfg, oldCfg *core.ConfigMap)</span></span> field.ErrorList &#123;</span><br><span class="line">	allErrs := field.ErrorList&#123;&#125;</span><br><span class="line">	allErrs = <span class="built_in">append</span>(allErrs, ValidateObjectMetaUpdate(&amp;newCfg.ObjectMeta, &amp;oldCfg.ObjectMeta, field.NewPath(<span class="string">&quot;metadata&quot;</span>))...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> oldCfg.Immutable != <span class="literal">nil</span> &amp;&amp; *oldCfg.Immutable &#123;</span><br><span class="line">		<span class="keyword">if</span> newCfg.Immutable == <span class="literal">nil</span> || !*newCfg.Immutable &#123;</span><br><span class="line">			allErrs = <span class="built_in">append</span>(allErrs, field.Forbidden(field.NewPath(<span class="string">&quot;immutable&quot;</span>), <span class="string">&quot;field is immutable when `immutable` is set&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !reflect.DeepEqual(newCfg.Data, oldCfg.Data) &#123;</span><br><span class="line">			allErrs = <span class="built_in">append</span>(allErrs, field.Forbidden(field.NewPath(<span class="string">&quot;data&quot;</span>), <span class="string">&quot;field is immutable when `immutable` is set&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !reflect.DeepEqual(newCfg.BinaryData, oldCfg.BinaryData) &#123;</span><br><span class="line">			allErrs = <span class="built_in">append</span>(allErrs, field.Forbidden(field.NewPath(<span class="string">&quot;binaryData&quot;</span>), <span class="string">&quot;field is immutable when `immutable` is set&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	allErrs = <span class="built_in">append</span>(allErrs, ValidateConfigMap(newCfg)...)</span><br><span class="line">	<span class="keyword">return</span> allErrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="subresource"><a href="#subresource" class="headerlink" title="subresource"></a>subresource</h3><p>内嵌在 Kubernetes 对象中，有独立的操作逻辑的属性集合，如 <code>podstatus</code></p>
<p>例如在 <code>kubectl get pod coredns-857d9ff4c9-fnvm9 -o yaml</code> 时，下面的 <code>status:</code> 内容</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> podStatusStrategy <span class="keyword">struct</span> &#123;</span><br><span class="line">	podStrategy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(podStatusStrategy)</span></span> PrepareForUpdate(ctx context.Context, obj, old runtime.Object) &#123;</span><br><span class="line">	newPod := obj.(*api.Pod)</span><br><span class="line">	oldPod := old.(*api.Pod)</span><br><span class="line">	newPod.Spec = oldPod.Spec</span><br><span class="line">	newPod.DeletionTimestamp = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// don&#x27;t allow the pods/status endpoint to touch owner references since old kubelets corrupt them in a way</span></span><br><span class="line">	<span class="comment">// that breaks garbage collection</span></span><br><span class="line">	newPod.OwnerReferences = oldPod.OwnerReferences</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当更新 <code>Pod</code> 的 <code>status</code> 时，将所有的 <code>spec</code> 部分丢弃。作用是更新时将 <code>spec</code> 对象和 <code>status</code> 对象分离，更新这部分，则丢弃另外一部分的更新，避免冲突。</p>
<h3 id="注册-APIGroup"><a href="#注册-APIGroup" class="headerlink" title="注册 APIGroup"></a>注册 APIGroup</h3><p><code>pkg/registry/core/rest/storage_core_generic.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">configMapStorage, err := configmapstore.NewREST(restOptionsGetter)</span><br><span class="line"></span><br><span class="line">storage := <span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;</span><br><span class="line"></span><br><span class="line">storage[resource] = configMapStorage</span><br><span class="line"></span><br><span class="line">apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>] = storage</span><br></pre></td></tr></table></figure>

<p>定义 <code>configMapStorage</code>，并且加入到 <code>apiGroupInfo</code> 中</p>
<p><code>pkg/controlplane/instance.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := m.GenericAPIServer.InstallAPIGroups(nonLegacy...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering group versions: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终，将对象注册至 <code>APIServer</code> 中，也就是挂载 <code>handler</code>。</p>
<h3 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMvY29kZS1nZW5lcmF0b3I=">https://github.com/kubernetes/code-generator<i class="fa fa-external-link-alt"></i></span></p>
<p><code>deepcopy-gen</code>：为对象生成<code>DeepCopy</code>方法，用于创建对象副本 </p>
<p><code>client-gen</code>：创建<code>Clientset</code>，用于操作对象的<code>CRUD</code> </p>
<p><code>informer-gen</code>：为对象创建<code>Informer</code>框架，用于监听对象变化 </p>
<p><code>lister-gen</code>：为对象构建<code>Lister</code>框架，用于为<code>Get</code>和<code>List</code>操作，构建客户端缓存 </p>
<p><code>coversion-gen</code>：为对象构建<code>Conversion</code>方法，用于内外版本转换以及不同版本号的转换</p>
<p>通过脚本生成代码，例如：<code>hack/update-codegen.sh</code></p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2NvbW1hbmQtbGluZS10b29scy1yZWZlcmVuY2Uva3ViZS1hcGlzZXJ2ZXIv">kubernetes.io kube-apiserver<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdGVuY2VudC1jbG91ZC1uYXRpdmUvcC8xNDMwMTI3Ny5odG1s">一文读懂 Kubernetes APIServer 原理<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9raW5namN5LmdpdGh1Yi5pby9wb3N0L2Nsb3VkL3BhYXMvYmFzZS9rdWJlcm5ldGVzL2s4cy1hcGlzZXJ2ZXIv">云计算K8s组件系列（一）—- K8s apiserver 详解<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmZlaXNreS54eXovY29uY2VwdHMvY29tcG9uZW50cy9hcGlzZXJ2ZXI=">Kubernetes指南 kube-apiserver<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvdGFza3MvYWRtaW5pc3Rlci1jbHVzdGVyL2FjY2Vzcy1jbHVzdGVyLWFwaS8=">kubernetes.io 使用 Kubernetes API 访问集群<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd3R6YmsvcC8xNTcxNzkyNi5odG1s">Kubernetes-API Server<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kdXlhbmdoYW8uZ2l0aHViLmlvL2t1YmVybmV0ZXMtYXBpc2VydmVyLW92ZXJ2aWV3Lw==">Kubernetes apiserver原理概览<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZG5hdGl2ZS50by9ibG9nL2FwaXNlcnZlci1oYW5kbGVyLXJlZ2lzdGVyLw==">Kubernetes API Server handler 注册过程分析（源码）<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kcmF2ZW5lc3MubWUva3ViZXJuZXRlcy1vYmplY3QtaW50cm8v">从 Kubernetes 中的对象谈起<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/387e.html" rel="prev" title="Kubernetes 控制平面组件：etcd">
                  <i class="fa fa-angle-left"></i> Kubernetes 控制平面组件：etcd
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/ea1d.html" rel="next" title="Kubernetes 控制平面组件：调度器和控制器">
                  Kubernetes 控制平面组件：调度器和控制器 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/bad7.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
