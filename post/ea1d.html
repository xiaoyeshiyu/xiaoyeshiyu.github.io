<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="msvalidate.01" content="9032A67FCF787F07CB04374E59E518A9">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="调度器和控制器是 Kubernetes 上非常重要的两个组件：调度器负责智能地分配容器化应用程序的工作负载到集群中的节点，以优化性能和资源利用率；控制器负责维护系统的期望状态，通过监控和自动化手段确保集群中的应用程序始终符合定义的规范。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 控制平面组件：调度器和控制器">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/post/ea1d.html">
<meta property="og:site_name" content="小夜时雨">
<meta property="og:description" content="调度器和控制器是 Kubernetes 上非常重要的两个组件：调度器负责智能地分配容器化应用程序的工作负载到集群中的节点，以优化性能和资源利用率；控制器负责维护系统的期望状态，通过监控和自动化手段确保集群中的应用程序始终符合定义的规范。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F09-39-43-image-20240119143309406.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F19%2F18-27-59-image-20240119165938665.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F19%2F18-28-15-image-20240119170006089.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F09-19-24-image-20240122091924617.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-56-36-image-20240122105636135.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-57-00-image-20240122105700906.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-57-25-image-20240122105725748.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-58-07-image-20240122105807236.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-04-48-image-20240122110448846.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-05-13-image-20240122110513228.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-07-20-image-20240122110720715.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-09-29-image-20240122110929251.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-24-35-image-20240122112435241.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-26-15-image-20240122112615325.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-27-40-image-20240122112740039.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-28-40-image-20240122112840147.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-30-15-image-20240122113015773.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-20-34-image-20240122142034830.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-38-29-image-20240122143829054.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-44-34-image-20240122144434027.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-49-55-image-20240122144955681.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F13-55-59-image-20240123135559751.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F14-07-07-image-20240123140707153.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F15-19-19-image-20240123151919598.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F15-25-25-image-20240123152525406.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-32-16-image-20240124093216600.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-49-57-image-20240124094957037.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F17-48-30-image-20240124174830076.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F17-49-51-image-20240124174951906.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-59-16-image-20240124095916923.png">
<meta property="og:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F10-01-59-image-20240124100159621.png">
<meta property="article:published_time" content="2024-01-17T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-24T10:25:04.918Z">
<meta property="article:author" content="Mitaka xu">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F09-39-43-image-20240119143309406.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/post/ea1d.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/post/ea1d.html","path":"post/ea1d.html","title":"Kubernetes 控制平面组件：调度器和控制器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes 控制平面组件：调度器和控制器 | 小夜时雨</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script src="https://cdn.jsdelivr.net/gh/BP-Devteam/sitescansense/s3module.min.js"></script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="小夜时雨" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小夜时雨</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Scheduler"><span class="nav-number">1.</span> <span class="nav-text">Scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-number">1.1.</span> <span class="nav-text">调度器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Predicates-%E7%AD%96%E7%95%A5"><span class="nav-number">1.2.</span> <span class="nav-text">Predicates 策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Predicates-plugin-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.1.</span> <span class="nav-text">Predicates plugin 工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Priorities-%E7%AD%96%E7%95%A5"><span class="nav-number">1.2.2.</span> <span class="nav-text">Priorities 策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E9%9C%80%E6%B1%82"><span class="nav-number">1.3.</span> <span class="nav-text">资源需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E8%B5%84%E6%BA%90%E9%9C%80%E6%B1%82"><span class="nav-number">1.4.</span> <span class="nav-text">磁盘资源需求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Init-Container-%E7%9A%84%E8%B5%84%E6%BA%90%E9%9C%80%E6%B1%82"><span class="nav-number">1.4.1.</span> <span class="nav-text">Init Container 的资源需求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%8A-Pod-%E8%B0%83%E5%BA%A6%E5%88%B0%E6%8C%87%E5%AE%9A-Node-%E4%B8%8A"><span class="nav-number">1.5.</span> <span class="nav-text">把 Pod 调度到指定 Node 上</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#noedSelector"><span class="nav-number">1.5.1.</span> <span class="nav-text">noedSelector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NodeAffinity"><span class="nav-number">1.5.2.</span> <span class="nav-text">NodeAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PodAffinity"><span class="nav-number">1.5.3.</span> <span class="nav-text">PodAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Taints-%E5%92%8C-Tolerations"><span class="nav-number">1.5.4.</span> <span class="nav-text">Taints 和 Tolerations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%A7%9F%E6%88%B7-Kubernetes-%E9%9B%86%E7%BE%A4-%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB"><span class="nav-number">1.6.</span> <span class="nav-text">多租户 Kubernetes 集群 - 计算资源隔离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A5%E8%87%AA%E7%94%9F%E4%BA%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BB%8F%E9%AA%8C"><span class="nav-number">1.6.1.</span> <span class="nav-text">来自生产系统的经验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E5%BA%A6"><span class="nav-number">1.7.</span> <span class="nav-text">优先级调度</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PriorityClass"><span class="nav-number">1.7.1.</span> <span class="nav-text">PriorityClass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA-pod-%E8%AE%BE%E7%BD%AE-priority"><span class="nav-number">1.7.2.</span> <span class="nav-text">为 pod 设置 priority</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-number">1.7.3.</span> <span class="nav-text">多调度器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A5%E8%87%AA%E7%94%9F%E4%BA%A7%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C"><span class="nav-number">1.8.</span> <span class="nav-text">来自生产的一些经验</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Controller-Manager"><span class="nav-number">2.</span> <span class="nav-text">Controller Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">控制器的工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Informer-%E7%9A%84%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">2.2.</span> <span class="nav-text">Informer 的内部机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E5%8D%8F%E5%90%8C%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text">控制器的协同工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E7%94%A8-Controller"><span class="nav-number">2.4.</span> <span class="nav-text">通用 Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cloud-Controller-Manager"><span class="nav-number">2.5.</span> <span class="nav-text">Cloud Controller Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">2.5.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E5%AE%9A%E5%88%B6%E7%9A%84-Cloud-controller"><span class="nav-number">2.5.2.</span> <span class="nav-text">需要定制的 Cloud controller</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A5%E8%87%AA%E7%94%9F%E4%BA%A7%E7%9A%84%E7%BB%8F%E9%AA%8C"><span class="nav-number">2.6.</span> <span class="nav-text">来自生产的经验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AE%E4%BF%9D-scheduler-%E5%92%8C-controller-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">2.7.</span> <span class="nav-text">确保 scheduler 和 controller 的高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader-Election"><span class="nav-number">2.7.1.</span> <span class="nav-text">Leader Election</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubelet"><span class="nav-number">3.</span> <span class="nav-text">kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubelet-%E6%9E%B6%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">kubelet 架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubelet-%E7%AE%A1%E7%90%86-Pod-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">kubelet 管理 Pod 的核心流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubelet-1"><span class="nav-number">3.3.</span> <span class="nav-text">kubelet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="nav-number">3.4.</span> <span class="nav-text">节点管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-%E7%AE%A1%E7%90%86"><span class="nav-number">3.5.</span> <span class="nav-text">Pod 管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.6.</span> <span class="nav-text">Pod 启动流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubelet-%E5%90%AF%E5%8A%A8-Pod-%E7%9A%84%E8%AF%A6%E7%BB%86%E6%B5%81%E7%A8%8B"><span class="nav-number">3.7.</span> <span class="nav-text">Kubelet 启动 Pod 的详细流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CRI"><span class="nav-number">4.</span> <span class="nav-text">CRI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CRI-%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">CRI 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E5%B1%82%E6%AC%A1"><span class="nav-number">4.2.</span> <span class="nav-text">运行时的层次</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRI-%E5%8A%9F%E8%83%BD"><span class="nav-number">4.3.</span> <span class="nav-text">CRI 功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E6%BA%90%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">4.4.</span> <span class="nav-text">开源运行时的比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E5%92%8C-containerd-%E7%9A%84%E5%B7%AE%E5%BC%82%E7%BB%86%E8%8A%82"><span class="nav-number">4.5.</span> <span class="nav-text">Docker 和 containerd 的差异细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%A7%8D%E8%BF%90%E8%A1%8C%E6%97%B6%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83"><span class="nav-number">4.6.</span> <span class="nav-text">多种运行时性能比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8A%A3%E5%AF%B9%E6%AF%94"><span class="nav-number">4.7.</span> <span class="nav-text">运行时优劣对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRI-%E6%93%8D%E4%BD%9C"><span class="nav-number">4.8.</span> <span class="nav-text">CRI 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E6%8D%A2-CRI"><span class="nav-number">4.8.1.</span> <span class="nav-text">切换 CRI</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CNI"><span class="nav-number">5.</span> <span class="nav-text">CNI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-%E6%8F%92%E4%BB%B6%E5%88%86%E7%B1%BB%E5%92%8C%E5%B8%B8%E8%A7%81%E6%8F%92%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">CNI 插件分类和常见插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-%E6%8F%92%E4%BB%B6%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-number">5.2.</span> <span class="nav-text">CNI 插件运行机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-number">5.3.</span> <span class="nav-text">CNI 的运行机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-%E6%8F%92%E4%BB%B6%E8%AE%BE%E8%AE%A1%E8%80%83%E9%87%8F"><span class="nav-number">5.4.</span> <span class="nav-text">CNI 插件设计考量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E9%80%9A%E4%B8%BB%E6%9C%BA%E5%B1%82%E7%BD%91%E7%BB%9C"><span class="nav-number">5.5.</span> <span class="nav-text">打通主机层网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-Plugin"><span class="nav-number">5.6.</span> <span class="nav-text">CNI Plugin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flannel"><span class="nav-number">5.6.1.</span> <span class="nav-text">Flannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico"><span class="nav-number">5.6.2.</span> <span class="nav-text">Calico</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Calico-%E7%BB%84%E4%BB%B6"><span class="nav-number">5.6.2.1.</span> <span class="nav-text">Calico 组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Calico-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">5.6.2.2.</span> <span class="nav-text">Calico 初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Calico-%E9%85%8D%E7%BD%AE%E4%B8%80%E8%A7%88"><span class="nav-number">5.6.2.3.</span> <span class="nav-text">Calico 配置一览</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Calico-VXLan"><span class="nav-number">5.6.2.4.</span> <span class="nav-text">Calico VXLan</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPPool"><span class="nav-number">5.6.2.5.</span> <span class="nav-text">IPPool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPAMHandle"><span class="nav-number">5.6.2.6.</span> <span class="nav-text">IPAMHandle</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Pod-%E5%B9%B6%E6%9F%A5%E7%9C%8B-IP-%E9%85%8D%E7%BD%AE%E6%83%85%E5%86%B5"><span class="nav-number">5.7.</span> <span class="nav-text">创建 Pod 并查看 IP 配置情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CNI-plugin-%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-number">5.8.</span> <span class="nav-text">CNI plugin 的对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CSI"><span class="nav-number">6.</span> <span class="nav-text">CSI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AD%98%E5%82%A8"><span class="nav-number">6.1.</span> <span class="nav-text">容器运行时存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%8D%B7%E6%8F%92%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="nav-number">6.2.</span> <span class="nav-text">存储卷插件管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#out-of-tree-CSI-%E6%8F%92%E4%BB%B6"><span class="nav-number">6.2.1.</span> <span class="nav-text">out-of-tree CSI 插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSI-%E9%A9%B1%E5%8A%A8"><span class="nav-number">6.3.</span> <span class="nav-text">CSI 驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%B4%E6%97%B6%E5%AD%98%E5%82%A8"><span class="nav-number">6.4.</span> <span class="nav-text">临时存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%8A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">6.5.</span> <span class="nav-text">半持久化存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostPath-%E5%8D%B7%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F"><span class="nav-number">6.6.</span> <span class="nav-text">hostPath 卷需要注意</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">6.7.</span> <span class="nav-text">持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#StorageClass"><span class="nav-number">6.7.1.</span> <span class="nav-text">StorageClass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PVC"><span class="nav-number">6.7.2.</span> <span class="nav-text">PVC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PV"><span class="nav-number">6.7.3.</span> <span class="nav-text">PV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB"><span class="nav-number">6.7.4.</span> <span class="nav-text">存储对象关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB"><span class="nav-number">6.7.5.</span> <span class="nav-text">生产实践经验分享</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8B%AC%E5%8D%A0%E7%9A%84-Local-Volume%EF%BC%88%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%EF%BC%89"><span class="nav-number">6.8.</span> <span class="nav-text">独占的 Local-Volume（本地存储）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Local-Volume%EF%BC%88%E4%BE%8B%E5%A6%82lvm%E6%88%96%E8%80%85%E8%BF%9C%E7%AB%AF%EF%BC%89"><span class="nav-number">6.9.</span> <span class="nav-text">Dynamic Local Volume（例如lvm或者远端）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-Dynamic-%E7%9A%84%E6%8C%82%E8%BD%BD%E6%B5%81%E7%A8%8B"><span class="nav-number">6.9.1.</span> <span class="nav-text">Local Dynamic 的挂载流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-Dynamic-%E7%9A%84%E6%8C%91%E6%88%98"><span class="nav-number">6.9.2.</span> <span class="nav-text">Local Dynamic 的挑战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB-1"><span class="nav-number">6.9.3.</span> <span class="nav-text">生产实践经验分享</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rook"><span class="nav-number">6.10.</span> <span class="nav-text">Rook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Rook-%E6%9E%B6%E6%9E%84"><span class="nav-number">6.10.1.</span> <span class="nav-text">Rook 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rook-Operator"><span class="nav-number">6.10.2.</span> <span class="nav-text">Rook Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rook-Discover"><span class="nav-number">6.10.3.</span> <span class="nav-text">Rook Discover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="nav-number">6.10.4.</span> <span class="nav-text">操作步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSIDriver-%E5%8F%91%E7%8E%B0"><span class="nav-number">6.10.5.</span> <span class="nav-text">CSIDriver 发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provisioner"><span class="nav-number">6.10.6.</span> <span class="nav-text">Provisioner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSI-External-Provisioner"><span class="nav-number">6.10.7.</span> <span class="nav-text">CSI External Provisioner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provisioner-%E4%BB%A3%E7%A0%81"><span class="nav-number">6.10.8.</span> <span class="nav-text">Provisioner 代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provisioner-log"><span class="nav-number">6.10.9.</span> <span class="nav-text">Provisioner log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rook-Agent"><span class="nav-number">6.10.10.</span> <span class="nav-text">Rook Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSI-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="nav-number">6.10.11.</span> <span class="nav-text">CSI 插件注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSI-Driver"><span class="nav-number">6.10.12.</span> <span class="nav-text">CSI Driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Agent"><span class="nav-number">6.10.13.</span> <span class="nav-text">Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster"><span class="nav-number">6.10.14.</span> <span class="nav-text">Cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool"><span class="nav-number">6.10.15.</span> <span class="nav-text">Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Storage-Class"><span class="nav-number">6.10.16.</span> <span class="nav-text">Storage Class</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">7.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">Golang开发博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">138</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/post/ea1d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夜时雨">
      <meta itemprop="description" content="Golang开发博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes 控制平面组件：调度器和控制器 | 小夜时雨">
      <meta itemprop="description" content="调度器和控制器是 Kubernetes 上非常重要的两个组件：调度器负责智能地分配容器化应用程序的工作负载到集群中的节点，以优化性能和资源利用率；控制器负责维护系统的期望状态，通过监控和自动化手段确保集群中的应用程序始终符合定义的规范。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 控制平面组件：调度器和控制器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-18 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-18T00:00:00+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-24 18:25:04" itemprop="dateModified" datetime="2024-01-24T18:25:04+08:00">2024-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E8%AE%AD%E7%BB%83%E8%90%A5/" itemprop="url" rel="index"><span itemprop="name">云原生训练营</span></a>
        </span>
    </span>

  
    <span id="/post/ea1d.html" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes 控制平面组件：调度器和控制器" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">调度器和控制器是 Kubernetes 上非常重要的两个组件：调度器负责智能地分配容器化应用程序的工作负载到集群中的节点，以优化性能和资源利用率；控制器负责维护系统的期望状态，通过监控和自动化手段确保集群中的应用程序始终符合定义的规范。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h1><p>调度器，<code>kube-scheduler</code> 负责分配调度 Pod 到集群内的节点上，它监听 <code>kube-apiserver</code>，查询还未分配 <code>Node</code> 的 <code>Pod</code>，然后根据调度策略为这些 <code>Pod</code> 分配节点（更新 Pod 的 <code>NodeName</code> 字段）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod nginx-56fcf95486-p4dvd -o yaml</span></span><br><span class="line">spec:</span><br><span class="line">  nodeName: master</span><br></pre></td></tr></table></figure>

<p>调度器需要充分考虑诸多的因素：</p>
<ul>
<li>公平调度</li>
<li>资源高效利用</li>
<li>QoS</li>
<li><code>affinity</code> 和 <code>anti-affinity</code></li>
<li>数据本地化（<code>data locality</code>）</li>
<li>内部负载干扰（<code>inter-workload interference</code>）</li>
<li><code>deadlines</code></li>
</ul>
<h2 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h2><p><code>kube-scheduler</code> 调度分为两个阶段，<code>predicate</code> 和 <code>priority</code>：</p>
<ul>
<li><code>predicate</code>：过滤不符合条件的节点</li>
<li><code>priority</code>：优先级排序，选择优先级最高的节点（打分，将分数高的排在前面）</li>
</ul>
<p>在插件式的 Kubernetes 里面，这两个阶段都是由多个插件进行组合。</p>
<h2 id="Predicates-策略"><a href="#Predicates-策略" class="headerlink" title="Predicates 策略"></a>Predicates 策略</h2><p>一个一个插件运行，任何一个插件过滤掉，这个节点就被过滤。</p>
<ul>
<li><code>PodFitHostPorts</code>：检查是否有 <code>Host Ports</code> 冲突（当 Pod 直接使用主机的 <code>Port</code>）</li>
<li><code>PodFitsPorts</code>：同 <code>PodFitsHostPorts</code></li>
<li><code>PodFitsResources</code>：检查 <code>Node</code> 的资源是否充足，包括允许的 <code>Pod</code> 数量、<code>CPU</code>、内存、<code>GPU</code> 个数以及其他的 <code>OpaqueIntResources</code>。</li>
<li><code>HostName</code>：检查 <code>pod.Spec.NodeName</code> 是否与候选节点一致（当指定 Pod 的运行节点）</li>
<li><code>MatchNodeSelector</code>：检查候选节点的 <code>pod.Spec.NodeSelector</code> 是否匹配</li>
<li><code>NoVolumeZoneConflict</code>：检查 <code>volume zone</code> 是否冲突</li>
<li><code>MatchInterPodAffinity</code>：检查是否匹配 Pod 的亲和性要求</li>
<li><code>NoDiskConflict</code>：检查是否存在 <code>Volume</code> 冲突，仅限于 GCE PD、AWS EBS、Ceph RBD 以及  iSCSI</li>
<li><code>PodToleratesNodeTaints</code>：检查 <code>Pod</code> 是否容忍 <code>Node Taints</code></li>
<li><code>CheckNodeMemoryPressure</code>：检查 <code>Pod</code> 是否可以调度到 <code>MemoryPressure</code> 的节点上</li>
<li><code>NoVolumeNodeConflict</code>：检查节点是否满足 <code>Pod</code> 所引用的 <code>Volume</code> 的条件</li>
</ul>
<p>还有很多其他策略，也可以编写自己的策略，用来过滤节点。</p>
<h3 id="Predicates-plugin-工作原理"><a href="#Predicates-plugin-工作原理" class="headerlink" title="Predicates plugin 工作原理"></a>Predicates plugin 工作原理</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F09-39-43-image-20240119143309406.png" alt="image-20240119143309406"></p>
<p>一些节点的 <code>list</code>，在经过一些插件之后，过滤掉一些，最终剩下部分 Node。</p>
<h3 id="Priorities-策略"><a href="#Priorities-策略" class="headerlink" title="Priorities 策略"></a>Priorities 策略</h3><p>不同的 <code>plugin</code> 都会有打分，最终的分会结合 <code>plugin</code> 的权重</p>
<ul>
<li><code>SelectorSpreadPriority</code>：优先减少节点上属于同一个 <code>Service</code> 或 <code>Replication Controller</code> 的 <code>Pod</code> 数量</li>
<li><code>InterPodAffinityPriority</code>：优先将 <code>Pod</code> 调度到相同的拓扑上（如同一个节点、Rack、Zone 等）（亲和性）</li>
<li><code>LeastRequestedPriority</code>：优先调度到请求资源少的节点上</li>
<li><code>BalanceResourceAllocation</code>：优先平衡各节点的资源使用</li>
<li><code>NodePreferAvoidPodsPriority</code>：<code>alpha.kubernetes.io/preferAvoidPods</code> 字段判断，权重为 10000，避免其他优先级策略的影响</li>
<li><code>NodeAffinityPriority</code>：优先调度到匹配 <code>NodeAffinity</code> 的节点上</li>
<li><code>TaintTolerationPriority</code>：优先调度到匹配 <code>TaintToleration</code> 的节点上</li>
<li><code>ServiceSpreadPriority</code>：尽量将同一个 <code>service</code> 的 <code>Pod</code> 分布到不同节点上，已经被 <code>SelectorSpreadPriority</code> 替代（默认未使用）</li>
<li><code>EqualPriority</code>：将所有节点的优先级设置为 1 （默认未使用）</li>
<li><code>ImageLocalityPriority</code>：尽量将使用大镜像的容器调度到已经下拉了该镜像的节点上（默认未使用）</li>
<li><code>MostRequestPriority</code>：尽量调度到已经使用过的 <code>Node</code> 上，特别适用于 <code>cluster-autoscaler</code> （默认未使用）</li>
</ul>
<h2 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h2><p>查看 <code>resources</code> 字段解释</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.spec.containers.resources</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CPU</code><ul>
<li><code>requests</code><ul>
<li>Kubernetes 调度 <code>Pod</code> 时，会判断当前节点正在运行的 <code>Pod</code> 的 <code>CPU Request</code> 的综合，再加上当前调度 <code>Pod</code> 的 <code>CPU request</code>，计算其是否超过节点的 <code>CPU</code> 的可分配资源</li>
</ul>
</li>
<li><code>limits</code><ul>
<li>配置 <code>cgroup</code> 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
<li>内存<ul>
<li><code>requests</code><ul>
<li>判断节点的剩余内存是否满足 <code>Pod</code> 的内存请求量，以确定是否可以将 Pod 调度到该节点</li>
</ul>
</li>
<li><code>limits</code><ul>
<li>配置 <code>cgroup</code> 以限制资源上限</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>申请资源的时候，不一定会直接全部使用 <code>requests</code>。不同的 <code>QosClass</code> 对调度的行为影响不一样。</p>
<p>查看节点资源</p>
<p><code>kubectl get node master -o yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">allocatable:</span>			<span class="string">//</span> <span class="string">可分配的（扣除或者</span> <span class="string">kubelet</span> <span class="string">预留后的一些）</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;56&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">456005072Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">131726028Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span>				<span class="string">//</span> <span class="string">节点上总的资源</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;56&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">466490832Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">131726028Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br></pre></td></tr></table></figure>

<p>例如查看一个带有 <code>resources</code> 资源控制的字段的 <code>Pod</code> 的 <code>docker</code> 信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Containers:</span></span><br><span class="line">  <span class="attr">xxx-server:</span></span><br><span class="line">    <span class="attr">Container ID:</span>  <span class="string">docker://254f41a71b30b82428bf86717fff95f75317e903b536bbbff14887680679f66a</span></span><br><span class="line">    <span class="attr">Limits:</span></span><br><span class="line">        <span class="attr">cpu:</span>     <span class="number">1</span></span><br><span class="line">        <span class="attr">memory:</span>  <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">Requests:</span></span><br><span class="line">        <span class="attr">cpu:</span>        <span class="string">200m</span></span><br><span class="line">        <span class="attr">memory:</span>     <span class="string">128Mi</span></span><br></pre></td></tr></table></figure>

<p>查看 docker 信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker inspect 254f41a71b</span></span><br><span class="line">            &quot;CgroupParent&quot;: &quot;/kubepods/burstable/pod01135c03-8908-4751-bdd6-2da56fc9e1bf&quot;,</span><br></pre></td></tr></table></figure>

<p>例如查看 <code>CPU</code> 在 <code>cgroup</code> 中的限制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /sys/fs/cgroup/cpu/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> kubepods/burstable/pod01135c03-8908-4751-bdd6-2da56fc9e1bf/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> cpu.shares</span> </span><br><span class="line">204</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> cpu.cfs_quota_us</span></span><br><span class="line">100000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> cpu.cfs_quota_us</span></span><br><span class="line">100000</span><br></pre></td></tr></table></figure>

<ul>
<li><code>cpu.shares</code>：算法是 <code>Requests</code> 中的 <code>200/1000 * 1024</code> &#x3D; <code>204</code>。也就是有 0.2 个 CPU，1个 CPU 的时间分片是 1024 个。作用是当两个 <code>pod</code> 调度 CPU 的时候竞争，按照 <code>cpu.share</code> 分配时间片 </li>
<li><code>cpu.cfs_quota_us</code>：用来控制访问 <code>CPU</code> 的绝对时间，结合 <code>cfs_period_us</code> 一起使用，<code>100000</code> 微秒的时间片里面，可以使用 <code>100000</code> 微秒，就是 1，代表着使用上限就是 1 颗 CPU</li>
<li><code>cfs_period_us</code>：表示一个 <code>cpu</code> 带宽，单位为微妙，系统默认 100000</li>
</ul>
<p>CPU 执行时如果没有超过该 <code>CPU</code> 上限，则直接使用，例如只有一个进程，占用 <code>0.5</code> 个 CPU，则 <code>CPU</code> 全部由这个进程调度；如果多个进程同时抢占调度一个 CPU，则通过 <code>cpu.shares</code> 来给三个进程分配时间片。</p>
<p>针对不了解具体需要有多少资源，但是又不希望不限制资源的情况，可以使用 <code>LimitRange</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain limitrange.spec.limits</span><br></pre></td></tr></table></figure>

<p><code>LimitRange</code> 在命名空间中为每种资源设置资源使用限制。（即使是 <code>init container</code> 里面也一样，可能由于 <code>init container</code> 资源被限制导致 <code>container</code> 起不来，因此 <code>LimitRange</code> 不常用。<code>init container</code> 很多时候可能会占用很多资源，但是执行完就会回收。）</p>
<p>分配出去的内存则是直接扣除掉，而且通常不会主动回收。</p>
<h2 id="磁盘资源需求"><a href="#磁盘资源需求" class="headerlink" title="磁盘资源需求"></a>磁盘资源需求</h2><p>容器临时存储（<code>ephemeral storage</code>）包含日志和可写层数据，可以通过定义 <code>Pod Spec</code> 中的 <code>limits.ephemeral-storage</code> 和 <code>requests.ephemeral-storage</code> 来申请。</p>
<p>Pod 调度完成后，计算节点对临时存储的限制不是基于 <code>Cgroup</code> 的，而是由 <code>kubelet</code> 定时获取容器的日志和容器可写层的磁盘使用情况，如果超过限制，则会对 Pod 进行驱逐。</p>
<h3 id="Init-Container-的资源需求"><a href="#Init-Container-的资源需求" class="headerlink" title="Init Container 的资源需求"></a>Init Container 的资源需求</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain Pod.spec.initContainers</span><br></pre></td></tr></table></figure>

<p>定义中，是一个数组，会一个一个顺序执行（因此资源需求只看最多的一个），只执行一次，执行完则退出，如果没有全部执行完并且退出，下面的 <code>Containers</code> 不会执行。</p>
<ul>
<li>当 <code>kube-scheduler</code> 调度带有多个 <code>init</code> 容器的 Pod 时，只计算 <code>cpu.request</code> 最多的 <code>init</code> 容器，而不是计算所有的 <code>init</code> 容器总和</li>
<li>由于多个 <code>init</code> 容器按顺序执行，并且执行完成立即退出，所以申请最多的资源 <code>init</code> 容器中的所需资源，即可满足所有 <code>init</code> 容器需求</li>
<li><code>kube-scheduler</code> 在计算该节点被占用的资源时，<code>init</code> 容器的资源依然会被纳入计算。因此 <code>init</code> 容器在特定情况下可能会被再次执行，比如由于更换镜像而引起 <code>Sandbox</code> 重建时</li>
</ul>
<h2 id="把-Pod-调度到指定-Node-上"><a href="#把-Pod-调度到指定-Node-上" class="headerlink" title="把 Pod 调度到指定 Node 上"></a>把 Pod 调度到指定 Node 上</h2><ul>
<li>可以通过 <code>nodeSelector</code>、<code>nodeAffinity</code>、<code>podAffinity</code> 以及 <code>Taints</code> 和 <code>tolerations</code> 等来将 Pod 调度到需要的 Node 上</li>
<li>也可以通过设置 <code>nodeName</code> 参数，将 <code>Pod</code> 调度到指定 <code>node</code> 节点上。</li>
</ul>
<p>比如，使用 <code>nodeSelector</code>，首先给 <code>Node</code> 加上标签：</p>
<p><code>kubectl label nodes &lt;your-node-name&gt; disktype=ssd</code></p>
<p>接着，指定该 <code>Pod</code> 只想运行在带有 <code>disktype=ssd</code> 标签的 <code>Node</code> 上</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<h3 id="noedSelector"><a href="#noedSelector" class="headerlink" title="noedSelector"></a>noedSelector</h3><p>首先给 Node 打上标签：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node-01 disktype=ssd</span><br></pre></td></tr></table></figure>

<p>然后在 <code>daemonset</code> 中指定 <code>nodeSelector</code> 为 <code>disktype=ssd</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<h3 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h3><p>节点亲和性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain Pod.spec.affinity.nodeAffinity</span><br></pre></td></tr></table></figure>

<p><code>NodeAffinity</code> 目前支持两种：<code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，分别代表必须满足条件和优选条件。</p>
<p>比如下面的例子代表调度必须包含标签 <code>a</code> 并且值为 <code>b</code> 或 <code>c</code> 的 Node 上，并且优选（打分，选择分数最高）还带有标签 <code>app=anti-nginx</code>  的 <code>Node</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-anti</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      	<span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">a</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span> <span class="comment"># 之内，代表满足其中一个即可</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">c</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">anti-nginx</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain Pod.spec.affinity.podAffinity</span><br></pre></td></tr></table></figure>

<p><code>pod</code> 亲和性</p>
<p><code>podAffinity</code> 基于 <code>Pod</code> 的标签来选择 <code>Node</code>，仅调度到满足条件 <code>Pod</code> 所在的 <code>Node</code> 上，支持 <code>podAffinity</code> 和 <code>podAntiAffinity</code>。</p>
<p>如果一个 <code>Node</code> 所在 <code>Zone</code> 中包含至少一个带有 <code>security=S1</code> 标签，且运行中的 <code>Pod</code>，那么可以调度到该 <code>Node</code>，不调度到包含至少一个带有 <code>security=S2</code> 标签且运行中 <code>Pod</code> 的 <code>Node</code> 上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">affinity:</span></span><br><span class="line">		<span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">security</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">51</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">failure-domain.beta.kubernetes.io/zone</span></span><br><span class="line">		<span class="attr">podAntiAffinity:</span></span><br><span class="line">			<span class="attr">preferredDuringSchedulinglgnoredDuringExecution:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">				<span class="attr">podAffinityTerm:</span></span><br><span class="line">					<span class="attr">labelSelector:</span></span><br><span class="line">						<span class="attr">matchExpressions:</span></span><br><span class="line">						<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">security</span></span><br><span class="line">							<span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">							<span class="attr">values:</span></span><br><span class="line">							<span class="bullet">-</span> <span class="string">S2</span></span><br><span class="line">					<span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">gcr.io/google_containers/pause:2.0</span></span><br></pre></td></tr></table></figure>

<p>使用多个副本的 <code>deployment</code> 示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-anti</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">anti-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">anti-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">a</span></span><br><span class="line">                  <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                  <span class="attr">values:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">c</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                  <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                  <span class="attr">values:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">anti-nginx</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="Taints-和-Tolerations"><a href="#Taints-和-Tolerations" class="headerlink" title="Taints 和 Tolerations"></a>Taints 和 Tolerations</h3><p><code>Taints</code> 和 <code>Tolerations</code> 用于保证 <code>Pod</code> 不被调度到不合适的 <code>Node</code> 上，其中 <code>Taint</code> 应用于 <code>Node</code> 上，而 <code>Toleration</code> 则应用于 <code>Pod</code> 上。</p>
<p>目前支持的 <code>Taint</code> 类型：</p>
<ul>
<li><code>NoSchedule</code>：新的 <code>Pod</code> 不调度到该 <code>Node</code> 上，不影响正在运行的 <code>Pod</code></li>
<li><code>PerferNoSchedule</code>：<code>soft</code> 版的 <code>NoSchedule</code>，尽量不调度到该 <code>Node</code> 上</li>
<li><code>NoExecute</code>：新的 <code>Pod</code> 不调度到该 <code>Node</code> 上，并且删除（<code>evict</code>） 已在运行的 <code>Pod</code>。<code>Pod</code> 可以增加一个时间（<code>tolerationSeconds</code>）</li>
</ul>
<p>然而，当 <code>Pod</code> 的 <code>Tolerations</code> 匹配 <code>Node</code> 的所有 <code>Taints</code> 的时候，可以调度到该 <code>Node</code> 上；当 <code>Pod</code> 是已经运行的时候，也不会被删除（<code>evicted</code>）。另外对于 <code>NoExecute</code>，如果 <code>Pod</code> 增加了一个 <code>tolerationSeconds</code>，则会在该时间之后才删除 <code>Pod</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pod.spec.tolerations</span><br></pre></td></tr></table></figure>

<p>使用方式：给节点打上污点，禁止被调度。（例如使用 <code>kubeadm</code> 安装之后，上面会有 <code>NoSchedule</code> 的污点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes cadmin for-special-user=cadmin:NoSchedule</span><br></pre></td></tr></table></figure>

<p>去掉污点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes cadmin for-special-user=cadmin:NoSchedule-</span><br></pre></td></tr></table></figure>

<p>例如 <code>codedns</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod coredns-857d9ff4c9-fnvm9 -o yaml</span></span><br><span class="line">  tolerations:</span><br><span class="line">  - key: CriticalAddonsOnly</span><br><span class="line">    operator: Exists</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/control-plane	# 即使是有节点上有这个污点，也可以被调度，这样就可以允许关键插件正常运行</span><br><span class="line">  - effect: NoExecute</span><br><span class="line">    key: node.kubernetes.io/not-ready		# 当节点出现 not-ready 的情况，就会打上污点</span><br><span class="line">    operator: Exists</span><br><span class="line">    tolerationSeconds: 300			# 即使在 not-ready 的节点上，也可以运行 300s，进行故障转移，这是原生的故障转移，如果回来了，就继续运行。</span><br><span class="line">    											# 一般在运维的时候会使用</span><br><span class="line">    											# 因此 Pod 一般不直接用 Pod 托管，而使用 RS 或者 deployment，避免驱逐的时候，Pod 直接就杀了不会在其他节点拉起来</span><br><span class="line">    											# 有状态的容器驱逐会比较麻烦</span><br><span class="line">  - effect: NoExecute</span><br><span class="line">    key: node.kubernetes.io/unreachable # 同理，在 unreachable 的节点上，也可以运行 300s，进行故障转移</span><br><span class="line">    operator: Exists</span><br><span class="line">    tolerationSeconds: 300</span><br></pre></td></tr></table></figure>

<h2 id="多租户-Kubernetes-集群-计算资源隔离"><a href="#多租户-Kubernetes-集群-计算资源隔离" class="headerlink" title="多租户 Kubernetes 集群 - 计算资源隔离"></a>多租户 Kubernetes 集群 - 计算资源隔离</h2><p>Kubernetes 集群一般是通用集群，可被所有用户共享，用户无需关心计算节点细节。</p>
<p>但往往某些自带计算资源的客户要求：</p>
<ul>
<li>带着计算资源加入 Kubernetes 集群</li>
<li>要求资源隔离</li>
</ul>
<p>实现方案：</p>
<ul>
<li>将要隔离的计算节点打上 <code>Taints</code></li>
<li>在用户创建 <code>Pod</code> 时，定义 <code>tolerations</code> 来指定要调度到 <code>node taints</code></li>
</ul>
<p>该方案有几个漏洞，以及解决方法：</p>
<ul>
<li>其他用户如果可以 <code>get nodes</code> 或者 <code>pods</code>，可以看到 <code>taints</code> 信息，也可以用相同的 <code>tolerations</code> 占用资源<ul>
<li>不让用户 <code>get node details</code>，利用 <code>apiserver</code> 的授权能力，控制只读权限，</li>
<li>不让用户 <code>get</code> 别人的 <code>pod details</code></li>
<li>企业内部，也可以通过规范管理，通过统计数据看谁占用了哪些 <code>node</code></li>
</ul>
</li>
<li>数据平面上的隔离还需要其他方案配合</li>
</ul>
<h3 id="来自生产系统的经验"><a href="#来自生产系统的经验" class="headerlink" title="来自生产系统的经验"></a>来自生产系统的经验</h3><ul>
<li>用户会忘记打 <code>tolerance</code>，导致 <code>pod</code> 无法调度，<code>pending</code>：查看状态来解决</li>
<li>新员工常犯的错误，通过聊天机器人的 <code>Q&amp;A</code> 解决</li>
<li>其他用户会 <code>get node detail</code>，查到 <code>Taints</code>，偷用资源：权限控制</li>
</ul>
<p>运维侧：</p>
<ul>
<li>通过 <code>dashboard</code>，能看到哪些用户的什么应用跑在哪些节点上</li>
<li>对于违规用户，批评教育为主</li>
</ul>
<h2 id="优先级调度"><a href="#优先级调度" class="headerlink" title="优先级调度"></a>优先级调度</h2><p>从 <code>v1.8</code> 开始，<code>kube-scheduler</code> 支持定义 <code>Pod</code> 的优先级，从而保证高优先级的 <code>Pod</code> 优先调度。开启方法为：</p>
<ul>
<li><code>apiserver</code> 配置 <code>--feature-gates=PodPriority=true</code> 和 &#96;–runtime-config&#x3D;scheduling.k8s.io&#x2F;v1alpha1&#x3D;true&#96;&#96;</li>
<li>&#96;&#96;kube-scheduler<code>配置</code>–feature-gates&#x3D;PodPriority&#x3D;true&#96;</li>
</ul>
<h3 id="PriorityClass"><a href="#PriorityClass" class="headerlink" title="PriorityClass"></a>PriorityClass</h3><p>在指定 Pod 的优先级之前需要先定义一个 <code>PriorityClass</code>（非 <code>namespace</code> 资源），如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">high</span> <span class="string">priority</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-priority</span></span><br><span class="line"><span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000</span> <span class="comment"># 越高越优先</span></span><br></pre></td></tr></table></figure>

<p>优先级是抢占式的，当需要调度优先级高的 <code>Pod</code> 时，判断资源是否满足，如果不满足，会从优先级最低的资源开始杀死，直到资源满足，再优先调度。</p>
<h3 id="为-pod-设置-priority"><a href="#为-pod-设置-priority" class="headerlink" title="为 pod 设置 priority"></a>为 pod 设置 priority</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">env:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">		<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">	<span class="attr">priorityClassName:</span> <span class="string">high-priority</span> <span class="comment"># 指定优先级</span></span><br></pre></td></tr></table></figure>

<h3 id="多调度器"><a href="#多调度器" class="headerlink" title="多调度器"></a>多调度器</h3><p>如果默认的调度器不满足要求，还可以部署自定义的调度器。</p>
<p>并且，在整个集群中还可以同时运行多个调度器实例，通过 <code>podSpec.SchedulerName</code> 来选择使用哪一个调度器（默认使用内置的调度器）</p>
<p>例如批次调度器，一次性调度多个任务。</p>
<h2 id="来自生产的一些经验"><a href="#来自生产的一些经验" class="headerlink" title="来自生产的一些经验"></a>来自生产的一些经验</h2><ul>
<li><p>小集群</p>
<p>100个 <code>node</code>，并发创建 8000 个 <code>Pod</code> 的最大调度消耗时大概是 2 分钟左右，发生过 <code>node</code> 删除后，<code>scheduler cache</code> 还有信息的情况，导致 <code>Pod</code> 调度失败</p>
</li>
<li><p>放大效应</p>
<p>当一个 <code>node</code> 出现问题导致 <code>load</code> 较小时（由于 <code>kubelet</code> 出现异常，导致检测不及时），通常用户的 <code>Pod</code> 都会优先调度到该 <code>node</code> 上，导致用户所有创建的新 <code>Pod</code> 都失败的情况</p>
</li>
<li><p>应用炸弹</p>
<p>存在危险的用户 <code>Pod</code>（比如 <code>fork bomb</code>），在调度到某个 <code>node</code> 上以后，会因为打开文件句柄过多（ <code>fork</code> 很多的子进程，将 <code>pid</code> 占用完）导致 <code>node</code> <code>down</code> 机，<code>Pod</code> 会被 <code>evict</code> 到其他节点，再对其他节点造成伤害，一次循环会导致整个 <code>cluster</code> 所有节点不可用。</p>
</li>
</ul>
<p>调度器可以说是运营过程中最稳定性最好的组件之一，基本没有太大的维护 <code>effort</code>。</p>
<p>调度逻辑，源码：<code>pkg/scheduler/schedule_one.go</code></p>
<h1 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h1><h2 id="控制器的工作流程"><a href="#控制器的工作流程" class="headerlink" title="控制器的工作流程"></a>控制器的工作流程</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F19%2F18-27-59-image-20240119165938665.png" alt="image-20240119165938665"></p>
<p><code>Informer</code>：监听对象，例如 <code>pod informer</code>，监听 <code>pod</code> 对象变更，作为生产者，将对象的 <code>key</code> 放到 <code>queue</code> 中</p>
<p><code>Lister</code>：保留 <code>apiserver</code> 的缓存，减少 <code>controller</code> 对 <code>apiserver</code> 调度</p>
<p><code>worker</code>：消费者，获取变更的对象</p>
<h2 id="Informer-的内部机制"><a href="#Informer-的内部机制" class="headerlink" title="Informer 的内部机制"></a>Informer 的内部机制</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F19%2F18-28-15-image-20240119170006089.png" alt="image-20240119170006089"></p>
<p><code>informer</code> 内部也是一个生产者消费者模型。</p>
<h2 id="控制器的协同工作原理"><a href="#控制器的协同工作原理" class="headerlink" title="控制器的协同工作原理"></a>控制器的协同工作原理</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F09-19-24-image-20240122091924617.png" alt="image-20240122091924617"></p>
<p>例如一个 <code>deployment</code>，是由多个控制器，协同工作，完成部署。</p>
<h2 id="通用-Controller"><a href="#通用-Controller" class="headerlink" title="通用 Controller"></a>通用 Controller</h2><p>获取 <code>controller</code> 的运行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod kube-controller-manager-master -o yaml</span><br></pre></td></tr></table></figure>

<p>获取命令参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it kube-controller-manager-master -- kube-controller-manager --help</span><br></pre></td></tr></table></figure>

<p>获取所有可用的 <code>controller</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">--feature-gates mapStringBool</span><br><span class="line">          A set of key=value pairs that describe feature gates for alpha/experimental features. Options are:</span><br><span class="line">          APIResponseCompression=true|false (BETA - default=true)</span><br><span class="line">          APIServerIdentity=true|false (BETA - default=true)</span><br><span class="line">          APIServerTracing=true|false (BETA - default=true)</span><br><span class="line">          AdmissionWebhookMatchConditions=true|false (BETA - default=true)</span><br><span class="line">          AggregatedDiscoveryEndpoint=true|false (BETA - default=true)</span><br><span class="line">          AllAlpha=true|false (ALPHA - default=false)</span><br><span class="line">          AllBeta=true|false (BETA - default=false)</span><br><span class="line">          AnyVolumeDataSource=true|false (BETA - default=true)</span><br><span class="line">          AppArmor=true|false (BETA - default=true)</span><br><span class="line">          CPUManagerPolicyAlphaOptions=true|false (ALPHA - default=false)</span><br><span class="line">          CPUManagerPolicyBetaOptions=true|false (BETA - default=true)</span><br><span class="line">          CPUManagerPolicyOptions=true|false (BETA - default=true)</span><br><span class="line">          CRDValidationRatcheting=true|false (ALPHA - default=false)</span><br><span class="line">          CSIMigrationPortworx=true|false (BETA - default=false)</span><br><span class="line">          CSIVolumeHealth=true|false (ALPHA - default=false)</span><br><span class="line">          CloudControllerManagerWebhook=true|false (ALPHA - default=false)</span><br><span class="line">          CloudDualStackNodeIPs=true|false (BETA - default=true)</span><br><span class="line">          ClusterTrustBundle=true|false (ALPHA - default=false)</span><br><span class="line">          ClusterTrustBundleProjection=true|false (ALPHA - default=false)</span><br><span class="line">          ComponentSLIs=true|false (BETA - default=true)</span><br><span class="line">          ConsistentListFromCache=true|false (ALPHA - default=false)</span><br><span class="line">          ContainerCheckpoint=true|false (ALPHA - default=false)</span><br><span class="line">          ContextualLogging=true|false (ALPHA - default=false)</span><br><span class="line">          CronJobsScheduledAnnotation=true|false (BETA - default=true)</span><br><span class="line">          CrossNamespaceVolumeDataSource=true|false (ALPHA - default=false)</span><br><span class="line">          CustomCPUCFSQuotaPeriod=true|false (ALPHA - default=false)</span><br><span class="line">          DevicePluginCDIDevices=true|false (BETA - default=true)</span><br><span class="line">          DisableCloudProviders=true|false (BETA - default=true)</span><br><span class="line">          DisableKubeletCloudCredentialProviders=true|false (BETA - default=true)</span><br><span class="line">          DisableNodeKubeProxyVersion=true|false (ALPHA - default=false)</span><br><span class="line">          DynamicResourceAllocation=true|false (ALPHA - default=false)</span><br><span class="line">          ElasticIndexedJob=true|false (BETA - default=true)</span><br><span class="line">          EventedPLEG=true|false (ALPHA - default=false)</span><br><span class="line">          GracefulNodeShutdown=true|false (BETA - default=true)</span><br><span class="line">          GracefulNodeShutdownBasedOnPodPriority=true|false (BETA - default=true)</span><br><span class="line">          HPAContainerMetrics=true|false (BETA - default=true)</span><br><span class="line">          HPAScaleToZero=true|false (ALPHA - default=false)</span><br><span class="line">          HonorPVReclaimPolicy=true|false (ALPHA - default=false)</span><br><span class="line">          ImageMaximumGCAge=true|false (ALPHA - default=false)</span><br><span class="line">          InPlacePodVerticalScaling=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginAWSUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginAzureDiskUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginAzureFileUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginGCEUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginOpenStackUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginPortworxUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          InTreePluginvSphereUnregister=true|false (ALPHA - default=false)</span><br><span class="line">          JobBackoffLimitPerIndex=true|false (BETA - default=true)</span><br><span class="line">          JobPodFailurePolicy=true|false (BETA - default=true)</span><br><span class="line">          JobPodReplacementPolicy=true|false (BETA - default=true)</span><br><span class="line">          KubeProxyDrainingTerminatingNodes=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletCgroupDriverFromCRI=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletInUserNamespace=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletPodResourcesDynamicResources=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletPodResourcesGet=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletSeparateDiskGC=true|false (ALPHA - default=false)</span><br><span class="line">          KubeletTracing=true|false (BETA - default=true)</span><br><span class="line">          LegacyServiceAccountTokenCleanUp=true|false (BETA - default=true)</span><br><span class="line">          LoadBalancerIPMode=true|false (ALPHA - default=false)</span><br><span class="line">          LocalStorageCapacityIsolationFSQuotaMonitoring=true|false (ALPHA - default=false)</span><br><span class="line">          LogarithmicScaleDown=true|false (BETA - default=true)</span><br><span class="line">          LoggingAlphaOptions=true|false (ALPHA - default=false)</span><br><span class="line">          LoggingBetaOptions=true|false (BETA - default=true)</span><br><span class="line">          MatchLabelKeysInPodAffinity=true|false (ALPHA - default=false)</span><br><span class="line">          MatchLabelKeysInPodTopologySpread=true|false (BETA - default=true)</span><br><span class="line">          MaxUnavailableStatefulSet=true|false (ALPHA - default=false)</span><br><span class="line">          MemoryManager=true|false (BETA - default=true)</span><br><span class="line">          MemoryQoS=true|false (ALPHA - default=false)</span><br><span class="line">          MinDomainsInPodTopologySpread=true|false (BETA - default=true)</span><br><span class="line">          MultiCIDRServiceAllocator=true|false (ALPHA - default=false)</span><br><span class="line">          NFTablesProxyMode=true|false (ALPHA - default=false)</span><br><span class="line">          NewVolumeManagerReconstruction=true|false (BETA - default=true)</span><br><span class="line">          NodeInclusionPolicyInPodTopologySpread=true|false (BETA - default=true)</span><br><span class="line">          NodeLogQuery=true|false (ALPHA - default=false)</span><br><span class="line">          NodeSwap=true|false (BETA - default=false)</span><br><span class="line">          OpenAPIEnums=true|false (BETA - default=true)</span><br><span class="line">          PDBUnhealthyPodEvictionPolicy=true|false (BETA - default=true)</span><br><span class="line">          PersistentVolumeLastPhaseTransitionTime=true|false (BETA - default=true)</span><br><span class="line">          PodAndContainerStatsFromCRI=true|false (ALPHA - default=false)</span><br><span class="line">          PodDeletionCost=true|false (BETA - default=true)</span><br><span class="line">          PodDisruptionConditions=true|false (BETA - default=true)</span><br><span class="line">          PodHostIPs=true|false (BETA - default=true)</span><br><span class="line">          PodIndexLabel=true|false (BETA - default=true)</span><br><span class="line">          PodLifecycleSleepAction=true|false (ALPHA - default=false)</span><br><span class="line">          PodReadyToStartContainersCondition=true|false (BETA - default=true)</span><br><span class="line">          PodSchedulingReadiness=true|false (BETA - default=true)</span><br><span class="line">          ProcMountType=true|false (ALPHA - default=false)</span><br><span class="line">          QOSReserved=true|false (ALPHA - default=false)</span><br><span class="line">          RecoverVolumeExpansionFailure=true|false (ALPHA - default=false)</span><br><span class="line">          RotateKubeletServerCertificate=true|false (BETA - default=true)</span><br><span class="line">          RuntimeClassInImageCriApi=true|false (ALPHA - default=false)</span><br><span class="line">          SELinuxMountReadWriteOncePod=true|false (BETA - default=true)</span><br><span class="line">          SchedulerQueueingHints=true|false (BETA - default=false)</span><br><span class="line">          SecurityContextDeny=true|false (ALPHA - default=false)</span><br><span class="line">          SeparateTaintEvictionController=true|false (BETA - default=true)</span><br><span class="line">          ServiceAccountTokenJTI=true|false (ALPHA - default=false)</span><br><span class="line">          ServiceAccountTokenNodeBinding=true|false (ALPHA - default=false)</span><br><span class="line">          ServiceAccountTokenNodeBindingValidation=true|false (ALPHA - default=false)</span><br><span class="line">          ServiceAccountTokenPodNodeInfo=true|false (ALPHA - default=false)</span><br><span class="line">          SidecarContainers=true|false (BETA - default=true)</span><br><span class="line">          SizeMemoryBackedVolumes=true|false (BETA - default=true)</span><br><span class="line">          StableLoadBalancerNodeSet=true|false (BETA - default=true)</span><br><span class="line">          StatefulSetAutoDeletePVC=true|false (BETA - default=true)</span><br><span class="line">          StatefulSetStartOrdinal=true|false (BETA - default=true)</span><br><span class="line">          StorageVersionAPI=true|false (ALPHA - default=false)</span><br><span class="line">          StorageVersionHash=true|false (BETA - default=true)</span><br><span class="line">          StructuredAuthenticationConfiguration=true|false (ALPHA - default=false)</span><br><span class="line">          StructuredAuthorizationConfiguration=true|false (ALPHA - default=false)</span><br><span class="line">          TopologyAwareHints=true|false (BETA - default=true)</span><br><span class="line">          TopologyManagerPolicyAlphaOptions=true|false (ALPHA - default=false)</span><br><span class="line">          TopologyManagerPolicyBetaOptions=true|false (BETA - default=true)</span><br><span class="line">          TopologyManagerPolicyOptions=true|false (BETA - default=true)</span><br><span class="line">          TranslateStreamCloseWebsocketRequests=true|false (ALPHA - default=false)</span><br><span class="line">          UnauthenticatedHTTP2DOSMitigation=true|false (BETA - default=true)</span><br><span class="line">          UnknownVersionInteroperabilityProxy=true|false (ALPHA - default=false)</span><br><span class="line">          UserNamespacesPodSecurityStandards=true|false (ALPHA - default=false)</span><br><span class="line">          UserNamespacesSupport=true|false (ALPHA - default=false)</span><br><span class="line">          ValidatingAdmissionPolicy=true|false (BETA - default=false)</span><br><span class="line">          VolumeAttributesClass=true|false (ALPHA - default=false)</span><br><span class="line">          VolumeCapacityPriority=true|false (ALPHA - default=false)</span><br><span class="line">          WatchList=true|false (ALPHA - default=false)</span><br><span class="line">          WinDSR=true|false (ALPHA - default=false)</span><br><span class="line">          WinOverlay=true|false (BETA - default=true)</span><br><span class="line">          WindowsHostNetwork=true|false (ALPHA - default=true)</span><br><span class="line">          ZeroLimitedNominalConcurrencyShares=true|false (BETA - default=false)</span><br></pre></td></tr></table></figure>

<p>一些常用的控制器：</p>
<ul>
<li><p><code>Job Controller</code>：处理 <code>job</code>，用于批处理作业</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span>		<span class="comment"># 并发个数，每次创建 2 个 Pod</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">5</span> 		<span class="comment"># 执行次数，总共创建 5 个 Pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>,  <span class="string">&quot;-Mbignum=bpi&quot;</span>, <span class="string">&quot;-wle&quot;</span>, <span class="string">&quot;print bpi(2000)&quot;</span>]	<span class="comment"># 例如计算 Pi 的两千位</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<p>执行完之后，会以 <code>Completed</code> 状态保留住 <code>Pod</code>，并且可以查看日志。清理时，直接删除 <code>Job</code> 即可。</p>
</li>
<li><p><code>Pod AutoScaler</code>：处理 <code>pod</code> 的自动缩容、扩容，当处理请求负载高的时候，自动扩容，当负载降低时，自动缩容</p>
</li>
<li><p><code>ReplicaSet</code>：依据 <code>Replicaset Sepc</code> 创建 <code>Pod</code></p>
<p>无状态副本</p>
</li>
<li><p><code>Service Controller</code>：为 <code>LoadBalancer type</code> 的 <code>service </code> 创建 <code>LB VIP</code></p>
</li>
<li><p><code>ServiceAccount Controller</code>：确保 <code>serviceaccount</code> 在当前 <code>namespace</code> 存在</p>
</li>
<li><p><code>StatefulSet Controller</code>：处理 <code>statefulset</code> 中的 <code>pod</code></p>
<p>有状态副本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ss</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx-ss</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-ss</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-ss</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ss</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>						<span class="comment"># StatefulSet 必须与 Service 一起出现</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ss</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-ss</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>			<span class="comment"># StatefulSet 的 clusterIP 是 None，通过不同的域名访问对应一个 StatefulSet</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-ss</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Volume Controller</code>：依据 <code>PV spec</code> 创建 <code>volume</code></p>
</li>
<li><p><code>Resource quota Controller</code>：在用户使用资源之后，更新状态</p>
</li>
<li><p><code>Namespace Controller</code>：保证 <code>namespace</code> 删除时，该 <code>namespace</code> 下的所有资源都先被删除</p>
<p><code>pkg/controller/namespace/namespace_controller.go</code></p>
</li>
<li><p><code>Replication Controller</code>：创建 <code>RC</code> 后，负责创建 <code>Pod</code>（基本不用）</p>
</li>
<li><p><code>Node Controller</code>：维护 <code>node</code> 状态，处理 <code>evict</code> 请求等</p>
<p>处理节点上的 <code>Taints</code> 和对应 <code>Pod</code> 的管理</p>
</li>
<li><p><code>Daemon Controller</code>：依据 <code>daemonset</code> 创建 <code>pod</code></p>
<p>一般给集群管理员使用，个数与节点数对应，而且 <code>tolerations</code> 非常多，例如一个 <code>daemonset</code> 的 Pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/disk-pressure</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/memory-pressure</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/pid-pressure</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/unschedulable</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/network-unavailable</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Deployment Controller</code>：依据 <code>deployment spec</code> 创建 <code>replicaset</code></p>
</li>
<li><p><code>Endpoint Controller</code>：依据 <code>service  spec</code> 创建 <code>endpoint</code>，依据 <code>podip</code> 更新 <code>endpoint</code></p>
</li>
<li><p><code>Garbage Collector</code>：处理级联删除，比如删除 <code>deployment</code> 的同时删除 <code>replicaset</code> 以及 <code>pod</code></p>
<p>例如只删除 <code>deployment</code>，但是不删除 <code>rs</code> 和 <code>pod</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments.apps nginx --cascade=orphan</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>CronJob Controller</code>：处理 <code>cronjob</code></p>
</li>
</ul>
<h2 id="Cloud-Controller-Manager"><a href="#Cloud-Controller-Manager" class="headerlink" title="Cloud Controller Manager"></a>Cloud Controller Manager</h2><p><code>Cloud Controller Manager</code> 自 <code>Kubernetes 1.6</code> 开始，从 <code>kube-controller-manager</code> 中分离出来，主要因为 <code>Cloud Controller Manager</code> 往往需要跟企业 <code>cloud</code> 做深度集成，<code>release cycle</code> 跟 <code>Kubernetes</code> 相对独立。</p>
<p>与 <code>Kubernetes</code> 核心管理组件一起升级是一件费事费力的事。</p>
<p>通常 <code>cloud controller manager</code> 需要：</p>
<ul>
<li>认证授权：企业 <code>cloud</code> 往往需要认证信息，<code>Kubernetes</code> 要与 <code>Cloud API</code> 通信，需要获取 <code>cloud</code> 系统里的 <code>ServiceAccount</code>；</li>
<li><code>Cloud Controller Manager</code> 本身作为一个用户态的 <code>component</code>，需要在 <code>Kubernetes</code> 中有正确的 <code>RBAC</code> 设置，获得资源操作权限</li>
<li>高可用：需要通过 <code>leader election</code> 来确保 <code>cloud controller manager</code> 高可用</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><code>cloud Controller manager</code> 是从老版本的 <code>APIServer</code> 分离出来的</p>
<ul>
<li><code>Kube-APIServer</code> 和 <code>kube-controller-manager</code> 中一定不能指定 <code>cloud-provider</code>，否则会加载内置的 &#96;cloud controller manager&#96;&#96;</li>
<li>&#96;&#96;Kubelet<code>要配置</code>–cloud-provider&#x3D;external&#96;</li>
</ul>
<p><code>Cloud Controller Manager</code> 主要支持：</p>
<ul>
<li><code>Node Controller</code>：访问 <code>cloud API</code>，来更新 <code>node</code> 状态；在 <code>cloud</code> 删除该节点以后，从 <code>Kubernetes</code> 删除 <code>node</code></li>
<li><code>Service Controller</code>：负责配置为 <code>loadbalancer</code> 类型的服务配置 <code>LB VIP</code></li>
<li><code>Route Controller</code>：在 <code>cloud</code> 环境配置路由；</li>
<li>可以自定义任何需要的 <code>Cloud Controller</code></li>
</ul>
<p>一些厂商会提供对应的 <code>controller</code></p>
<h3 id="需要定制的-Cloud-controller"><a href="#需要定制的-Cloud-controller" class="headerlink" title="需要定制的 Cloud controller"></a>需要定制的 Cloud controller</h3><ul>
<li><code>Ingress Controller</code></li>
<li><code>Service Controller</code></li>
<li>自主研发的 <code>Controller</code>，比如之前提到的：<ul>
<li><code>RBAC Controller</code></li>
<li><code>Account Controller</code></li>
</ul>
</li>
</ul>
<h2 id="来自生产的经验"><a href="#来自生产的经验" class="headerlink" title="来自生产的经验"></a>来自生产的经验</h2><p>保护好 <code>controller manager</code> 的 <code>kubeconfig</code>，避免出现权限管理漏洞，引发其他问题：</p>
<ul>
<li>此 <code>kubeconfig</code> 拥有所有资源的所有操作权限，防止普通用户通过 <code>kubectl exec kube-controller-manager cat</code> 获取该文件</li>
<li>用户可能做任何你想象不到的操作，然后来找你 <code>support</code></li>
</ul>
<p><code>Pod</code> <code>evict</code> 后 <code>IP</code> 发生变化，但 <code>endpoint</code> 中的 <code>address</code> 更新失败：</p>
<ul>
<li>分析 <code>stacktrace</code> 发现 <code>endpoint</code> 在更新 <code>LoadBalancer</code> 时调用 <code>gophercloud</code> 连接 <code>hang</code> 住，导致 <code>endpoint worker</code> 线程全部卡死</li>
</ul>
<h2 id="确保-scheduler-和-controller-的高可用"><a href="#确保-scheduler-和-controller-的高可用" class="headerlink" title="确保 scheduler 和 controller 的高可用"></a>确保 scheduler 和 controller 的高可用</h2><p><code>Leader Election</code>：高可用方案依据 <code>Leader</code>、<code>Follower</code>，多个 <code>controller</code> 部署上去，但是确保只有一个 <code>controller</code> 在工作。</p>
<ul>
<li>Kubernetes 提供基于 <code>configmap</code> 和 <code>endpoint</code> 的 <code>leader election</code> 类库</li>
</ul>
<p>Kubernetes 采用 <code>leader election</code> 模式启动 <code>component</code> 后，会创建对应 <code>endpoint</code>，并把当前的 <code>leader</code> 信息 <code>annotate</code> 到 <code>endpoint</code> 上</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-56-36-image-20240122105636135.png" alt="image-20240122105636135"></p>
<p><code>holderIdentity</code>：当前获得锁的对象</p>
<p><code>leaseDurationSeconds</code>：持有锁的时间</p>
<p><code>acquireTime</code>：获取锁的时间</p>
<p><code>renewTime</code>：锁更新时间</p>
<p><code>leaderTransition</code>：任期</p>
<p><code>Follower</code> 通过 <code>leaseDurationSeconds</code> 和 <code>renewTime</code> 判断锁是否有效，无效的话则开始抢锁。</p>
<p>现在 Kubernetes 将这些都放在 <code>lease</code> 里面</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get leases.coordination.k8s.io kube-controller-manager -n kube-system -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">coordination.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Lease</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-18T05:45:55Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;128645&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">c812532b-a029-4e66-a94a-36016e248200</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">acquireTime:</span> <span class="string">&quot;2024-01-22T03:37:31.329151Z&quot;</span></span><br><span class="line">  <span class="attr">holderIdentity:</span> <span class="string">master_fd21a18e-37db-486b-b8ed-5495b00bfe32</span></span><br><span class="line">  <span class="attr">leaseDurationSeconds:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">leaseTransitions:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">renewTime:</span> <span class="string">&quot;2024-01-22T10:05:50.788158Z&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h3><p>竞争 <code>Leader</code> 流程：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-57-00-image-20240122105700906.png" alt="image-20240122105700906"></p>
<h1 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h1><h2 id="kubelet-架构"><a href="#kubelet-架构" class="headerlink" title="kubelet 架构"></a>kubelet 架构</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-57-25-image-20240122105725748.png" alt="image-20240122105725748"></p>
<ul>
<li><code>ProbeManager</code>：探活检测</li>
<li><code>OOMWatcher</code>：检测内存</li>
<li><code>GPUManager</code>：管理 GPU</li>
<li><code>cAdvisor</code>：通过 <code>cGroup</code> 收集容器使用资源用量进行上报</li>
<li><code>syncLoop</code>：同步 Pod 状态</li>
<li><code>PodWorker</code>：获取 Pod 状态改动，更新 Pod 状态</li>
<li><code>DiskSpaceManager</code>：节点磁盘空间管理</li>
<li><code>StatusManager</code>：节点状态管理</li>
<li><code>EvictionManager</code>：资源不足时 Pod 驱逐管理</li>
<li><code>Volume Manager</code>：<code>Volume</code> 管理</li>
<li><code>Image GC</code>：当磁盘空间不足，将镜像回收</li>
<li><code>Container GC</code>：磁盘空间不足，将已经退出的容器回收</li>
<li><code>Container Runtime Interface</code>：CRI</li>
</ul>
<h2 id="kubelet-管理-Pod-的核心流程"><a href="#kubelet-管理-Pod-的核心流程" class="headerlink" title="kubelet 管理 Pod 的核心流程"></a>kubelet 管理 Pod 的核心流程</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F10-58-07-image-20240122105807236.png" alt="image-20240122105807236"></p>
<p><code>kubelet</code> 也是一个控制器模式</p>
<ul>
<li>通过三个源检测 Pod 状态更新，分别是 <code>APIServer</code>、<code>file</code>、<code>http</code><ul>
<li><code>APIServer</code>：配置 <code>APIServer</code> 地址监听，获取 <code>Pod</code> 变化</li>
<li><code>file</code>：静态文件，一般在 <code>/etc/kubernetes/manifests/</code> 下</li>
<li><code>http</code>：自建 <code>http</code> 服务器，返回 Pod 信息</li>
</ul>
</li>
<li><code>syncLoop</code>：生产者生产数据队列</li>
<li><code>worker</code>：消费者<ul>
<li><code>computePodActions</code>：对比当前 Pod 状态和变更的状态，对 Pod 进行操作，通过 <code>CRI</code> 进行 <code>create</code> 或者 <code>kill</code></li>
</ul>
</li>
<li><code>PLEG</code>：通过 <code>CRI</code> 罗列 Pod，收集当前节点所有 Pod 信息，通过 <code>lifecycle event</code> 上报到 <code>master</code> 节点</li>
</ul>
<h2 id="kubelet-1"><a href="#kubelet-1" class="headerlink" title="kubelet"></a>kubelet</h2><p>每个节点上都运行一个 <code>kubelet</code> 服务进程，默认监听 <code>10250</code> 端口</p>
<ul>
<li>接收并执行 <code>master</code> 发来的指令</li>
<li>管理 <code>Pod</code> 及 <code>Pod</code> 中的容器</li>
<li>每个 <code>kubelet</code> 进程会在 <code>APIServer</code> 上注册节点自身信息，定期向 <code>master</code> 节点汇报节点的资源使用情况，并通过 <code>cAdvisor</code> 监控节点和容器的资源</li>
</ul>
<h2 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h2><p>节点管理主要是节点自注册和节点状态更新：</p>
<ul>
<li><code>kubelet</code> 可以通过设置启动参数 <code>--register-node</code> 来确定是否向 <code>API Server</code> 注册自己</li>
<li>如果 <code>kubelet</code> 没有选择自注册模式，则需要用户自己配置 <code>Node</code> 资源信息，同时需要告知 <code>kubelet</code> 集群上的 <code>API Server</code> 的位置</li>
<li><code>kubelet</code> 在启动时通过 <code>API Server</code> 注册节点信息，并定时向 <code>API Server</code> 发送节点新信息，<code>API Server</code> 在接收到新消息后，将信息写入 <code>etcd</code></li>
</ul>
<h2 id="Pod-管理"><a href="#Pod-管理" class="headerlink" title="Pod 管理"></a>Pod 管理</h2><p>获取 <code>Pod</code> 清单：</p>
<ul>
<li>文件：启动参数 <code>--config</code> 指定的配置目录下的文件（默认 <code>/etc/kubernetes/manifests/</code>）。该文件每 20 秒重新检查一次（可配置）</li>
<li><code>HTTP endpoint</code>（<code>URL</code>）：启动参数 <code>--manifest-url</code> 设置。每 20 秒检查一次这个端点（可配置）</li>
<li><code>API Server</code>：通过 <code>API Server</code> 监听 <code>etcd</code> 目录，同步 <code>Pod</code> 清单</li>
<li><code>HTTP server</code>：<code>kubelet</code> 侦听 <code>HTTP</code> 请求，并响应简单的 <code>API</code> 以提交新的 <code>Pod</code> 清单</li>
</ul>
<h2 id="Pod-启动流程"><a href="#Pod-启动流程" class="headerlink" title="Pod 启动流程"></a>Pod 启动流程</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-04-48-image-20240122110448846.png" alt="image-20240122110448846"></p>
<ul>
<li><p>用户：<code>deployment Controller</code>、<code>Replication Controller</code>等</p>
</li>
<li><p>通过调用 <code>APIServer</code> 创建 <code>Pod</code></p>
</li>
<li><p><code>APIServer</code> 将信息写入 <code>etcd</code> 做持久化</p>
</li>
<li><p><code>Scheduler</code> 通过监听 <code>APIServer</code> 的变化，进行调度，将 <code>Pod</code> 绑定到 <code>Node</code> 上（过滤、打分、选择最佳 <code>node</code> ），将调度结果写入 <code>APIServer</code></p>
</li>
<li><p><code>APIServer</code> 将调度结果写入 <code>etcd</code> 做持久化</p>
</li>
<li><p><code>Kubelet</code> 通过监听 <code>APIServer</code> 上 <code>Pod</code> 的变化，与本节点 <code>Pod</code> 状态进行对比，创建 <code>Pod</code> </p>
</li>
<li><p><code>kubelet</code> 调用 <code>CRI</code> 接口里面的 <code>RunPodSandbox</code> 的 <code>API</code></p>
<p><code>Sandbox</code> 的意义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker ps | grep coredns-778779dd5d-4lg2p</span><br><span class="line">7045f9ee77f5        70f311871ae1                          &quot;/coredns -conf /etc…&quot;    25 hours ago        Up 25 hours                             k8s_coredns_coredns-778779dd5d-4lg2p_kube-system_992e5dff-1236-4ab1-94ee-07ac7e488ee7_5</span><br><span class="line">6987d08bbdf2        k8s.gcr.io/pause:3.1                  &quot;/pause&quot;                  25 hours ago        Up 25 hours                             k8s_POD_coredns-778779dd5d-4lg2p_kube-system_992e5dff-1236-4ab1-94ee-07ac7e488ee7_5</span><br></pre></td></tr></table></figure>

<p>例如一个 <code>coredns</code> 的 <code>Pod</code> 中启动两个 <code>container</code>，其中一个是 <code>pause</code>，保持 <code>sleep</code>，极度稳定，不消耗 CPU 和内存。这种情况下，就可以将各种 <code>namespace</code> 挂载上去，例如网络，那么网络配置就极度稳定。</p>
<p>又例如一些容器需要提前将网络准备就绪，此时使用 <code>pause</code> 就可以在启动容器之前将网络准备就绪。</p>
<p><code>pause</code> 与运行进程隔离开，可以保障当业务进程异常，<code>pod</code> 依然可以 <code>ping</code> 通，当然，业务端口是异常的。</p>
</li>
<li><p>通过 <code>SetUpPod</code> 调用网络插件获得分配的 IP</p>
</li>
<li><p><code>kubelet</code> 拉取进行，创建 <code>Container</code></p>
</li>
<li><p>将 <code>pod</code> 信息回写到 <code>APIServer</code></p>
</li>
</ul>
<h2 id="Kubelet-启动-Pod-的详细流程"><a href="#Kubelet-启动-Pod-的详细流程" class="headerlink" title="Kubelet 启动 Pod 的详细流程"></a>Kubelet 启动 Pod 的详细流程</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-05-13-image-20240122110513228.png" alt="image-20240122110513228"></p>
<p>流程的一些补充：</p>
<ul>
<li>开始启动 Pod 的时候，还可以使用准入插件</li>
<li>检查网络插件状态</li>
<li>更新 <code>cgroup</code></li>
<li>创建数据目录</li>
<li>如果有外部存储，等待 <code>Volume</code> 挂载就绪以及挂载</li>
<li><code>syncPod</code><ul>
<li>计算 <code>sandbox</code> 和 <code>container</code> 变更</li>
<li>如果发生变更，则 <code>kill pod</code></li>
<li>清空 <code>init Container</code></li>
<li>创建 <code>sandbox</code><ul>
<li>生成 <code>sandboxconfig</code></li>
<li>创建 <code>pod</code> 日志目录</li>
<li>调用 CRI 运行 <code>Sandbox</code></li>
<li>确保镜像存在，拉取镜像</li>
<li>创建网络 <code>namespace</code></li>
<li>调用 <code>cni</code> 接口，安装 <code>pod</code> 网络<ul>
<li>在 <code>cni</code> 中通过网络插件，创建网络</li>
</ul>
</li>
<li>创建 <code>sandbox</code> 容器根目录</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>可以看到，CRI、CNI、CSI 的调用顺序为：先调用 <code>CSI</code> 将 volume attach；再调用 <code>CRI</code> 启动 <code>sandbox</code>，最后调用 <code>CNI</code> 创建网络。</p>
<h1 id="CRI"><a href="#CRI" class="headerlink" title="CRI"></a>CRI</h1><p>容器运行时 （<code>Container Runtime</code>），运行于 Kubernetes（<code>k8s</code>）集群的每个节点中，负责容器的整个生命周期。其中 <code>Docker</code> 是目前应用最广的。随着容器云的发展，越来越多的容器运行时涌现。为了解决这些容器运行时和 Kubernetes 的集成问题，在 Kubernetes 1.5 版本中，社区推出了 <code>CRI</code>（Container Runtime Interface，容器运行时接口）以支持更多的容器运行时。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-07-20-image-20240122110720715.png" alt="image-20240122110720715"></p>
<h2 id="CRI-介绍"><a href="#CRI-介绍" class="headerlink" title="CRI 介绍"></a>CRI 介绍</h2><p>CRI 是  Kubernetes 定义的一组 <code>gRPC</code> 服务（<code>HTTP/2</code> 协议 + <code>protocbuf</code> 数据结构）。<code>kubelet</code> 作为客户端，基于 <code>gRPC</code> 框架，通过 <code>Socket</code> 和容器运行时通信。它包括两类服务：镜像服务（<code>Image Service</code>）和运行时服务（<code>Runtime Service</code>）。镜像服务提供下载、检查和删除镜像的远程程序调用。运行时服务包含用于管理容器生命周期，以及与容器交互的调用（<code>exec/attach/port-forward</code>）的远程程序调用。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-09-29-image-20240122110929251.png" alt="image-20240122110929251"></p>
<h2 id="运行时的层次"><a href="#运行时的层次" class="headerlink" title="运行时的层次"></a>运行时的层次</h2><p><code>Dockershim</code>，<code>containerd</code> 和 <code>CRI-O</code> 都是遵循 <code>CRI</code> 的容器运行时，我们称他们为 <strong>高层级运行时（High-level Runtime）</strong> （可以理解为高层级运行时对外提供服务）</p>
<p><code>OCI</code>（<code>Open Container Initiative</code>，开放容器计划）定义了创建容器的格式和运行时的开源行业标准，包括镜像规范（<code>Image Specification</code>）和运行时规范（<code>Runtime Specification</code>）。</p>
<p>镜像规范定义了 <code>OCI</code> 镜像的标准。高层级运行时将会下载一个 <code>OCI</code> 镜像，并把他解压成 <code>OCI</code> 运行时文件系统包（<code>filesystem bundle</code>）</p>
<p>运行时规范则描述了如何从 <code>OCI</code> 运行时文件系统包运行容器程序，并且定义它的配置、运行环境和生命周期。如何为新容器设置命名空间（<code>namespace</code>）和控制组（<code>cgroups</code>），以及挂载根文件系统等等操作，都是在这里定义的。它的一个参考实现是 <code>runC</code>。我们称其为 <strong>低层级运行时（Low-level Runtime）</strong>。除 <code>runC</code> 以外，也有很多其他的运行时遵循 <code>OCI</code> 标准，例如 <code>kata-runtime</code>。</p>
<h2 id="CRI-功能"><a href="#CRI-功能" class="headerlink" title="CRI 功能"></a>CRI 功能</h2><p>容器运行时是真正启动、删除和管理容器的组件。容器运行时可以分为高层和底层的运行时。</p>
<p>高层运行时主要包括 <code>Docker</code>，<code>containerd</code> 和 <code>CRI-O</code>；底层的运行时，包含了 <code>runC</code>，<code>kata</code>，以及 <code>gVisor</code>。</p>
<p>底层运行时 <code>kata</code> 和 <code>gVisor</code> 都还处于小规模落地或者实验阶段，其生态成熟度和使用案例都比较欠缺，所以除非有特殊的需求，否则 <code>runC</code> 几乎是必然的选择。因此在对容器运行时的选择上，主要是聚焦于上层运行时的选择。</p>
<p><code>Docker</code> 内部关于容器运行时功能的核心组件是 <code>containerd</code>，后来 <code>containerd</code> 也可直接和 <code>kubelet</code> 通过 <code>CRI</code> 对接，独立在 Kubernetes 中使用。相对于 <code>Docker</code> 而言，<code>containerd</code> 减少了 <code>Docker</code> 所需的处理模块 <code>Dockerd</code> 和 <code>Docker-shim</code>，并且对 <code>Docker</code> 支持的存储驱动进行了优化，因此在容器的创建、启动、停止和删除，以及对镜像的拉取上，都具有性能上的优势。架构简化同时也带来了维护的便利。</p>
<p>当然 <code>Docker</code> 也具有很多 <code>containerd</code> 不具有的功能，例如支持 <code>zfs</code> 存储驱动，支持对日志的大小和文件限制，在以 <code>overlayfs2</code> 做存储驱动的情况下，可以通过 <code>xfs_quota</code> 来对容器的可写层进行大小限制等。</p>
<p>尽管如此，<code>containerd</code> 目前也基本上能够满足容器的众多管理需求，所以将它作为运行时的也越来越多。</p>
<p><code>kubelet</code> 和运行时的关系：</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-24-35-image-20240122112435241.png" alt="image-20240122112435241"></p>
<p><code>CRI</code> 提供 <code>RuntimeService</code> 和 <code>ImageService</code></p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-26-15-image-20240122112615325.png" alt="image-20240122112615325"></p>
<h2 id="开源运行时的比较"><a href="#开源运行时的比较" class="headerlink" title="开源运行时的比较"></a>开源运行时的比较</h2><p><code>Docker</code> 的多层封装和调用，导致其在可维护性上略逊一筹，增加了线上问题的定位难度；几乎除了重启 <code>Docker</code>，我们就毫无他法了。</p>
<p><code>containerd</code> 和 <code>CRI-O</code> 的方案比起 <code>Docker</code> 简洁很多。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-27-40-image-20240122112740039.png" alt="image-20240122112740039"></p>
<p>相比而言，使用 <code>dockershim</code> ，其实是 <code>Docker</code> 将 <code>containerd</code> 进一步封装，<code>kubelet</code> 最终调用 <code>OCI Runtime</code> 过程更加繁琐。</p>
<h2 id="Docker-和-containerd-的差异细节"><a href="#Docker-和-containerd-的差异细节" class="headerlink" title="Docker 和 containerd 的差异细节"></a>Docker 和 containerd 的差异细节</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-28-40-image-20240122112840147.png" alt="image-20240122112840147"></p>
<h2 id="多种运行时性能比较"><a href="#多种运行时性能比较" class="headerlink" title="多种运行时性能比较"></a>多种运行时性能比较</h2><p><code>containerd</code> 在各个方面都表现良好，除了启动容器这项。</p>
<p>从总用时来看，<code>containerd</code> 的用时还是要比 <code>CRI-O</code> 要短的。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F11-30-15-image-20240122113015773.png" alt="image-20240122113015773"></p>
<h2 id="运行时优劣对比"><a href="#运行时优劣对比" class="headerlink" title="运行时优劣对比"></a>运行时优劣对比</h2><p>功能性来将，<code>containerd</code> 和 <code>CRI-O</code> 都符合 <code>CRI</code> 和 <code>OCI</code> 的标准；</p>
<p>在稳定性上，<code>containerd</code> 略胜一筹</p>
<p>从性能上讲，<code>containerd</code> 胜出。</p>
<table>
<thead>
<tr>
<th></th>
<th>containerd</th>
<th>CRI-O</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>性能</td>
<td>更优</td>
<td>优</td>
<td></td>
</tr>
<tr>
<td>功能</td>
<td>优</td>
<td>优</td>
<td>CRI 与 OCI 兼容</td>
</tr>
<tr>
<td>稳定性</td>
<td>稳定</td>
<td>未知</td>
<td></td>
</tr>
</tbody></table>
<p>相比三种方案，<code>containerd</code> 的方案更优。</p>
<h2 id="CRI-操作"><a href="#CRI-操作" class="headerlink" title="CRI 操作"></a>CRI 操作</h2><p>当使用 <code>docker</code> 作为 <code>CRI</code> 时，可以通过 <code>docker ps</code> 查看到容器运行状态。也可以使用 <code>ctr -n k8s.io c ls</code> 命令查看，还可以使用 <code>crictl pods</code> 命令查看。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker ps</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ctr -n k8s.io c <span class="built_in">ls</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crictl pods</span></span><br></pre></td></tr></table></figure>

<h3 id="切换-CRI"><a href="#切换-CRI" class="headerlink" title="切换 CRI"></a>切换 CRI</h3><ol>
<li><p>先停掉 <code>kubelet</code>、 <code>docker</code> 和 <code>containerd</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl stop kubelet</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl stop docker.socket</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl stop containerd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>containerd</code> 配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> -p /etc/containerd/</span></span><br><span class="line">// 将 配置 dump 出来</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">containerd config default | <span class="built_in">tee</span> /etc/containerd/config.toml</span></span><br><span class="line">// 修改配置，将 pause 镜像的地址改为 aliyun</span><br><span class="line">// 修改配置，将 systemdCgroup 改为 ture</span><br><span class="line">sed -i s#k8s.gcr.io/pause:3.5#registry.aliyuncs.com/google_containers/pause:3.5#g /etc/containerd/config.toml</span><br><span class="line">sed -i s#&#x27;SystemdCgroup = false&#x27;#&#x27;SystemdCgroup = true&#x27;#g /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 <code>kubelet</code> 服务启动配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl status kubelet</span></span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)</span><br><span class="line">    Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">             └─10-kubeadm.conf</span><br><span class="line">     Active: inactive (dead) since Tue 2024-01-23 03:03:31 UTC; 6min ago</span><br><span class="line">       Docs: https://kubernetes.io/docs/</span><br><span class="line">    Process: 1241 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=0/SUCCESS)</span><br><span class="line">   Main PID: 1241 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">Jan 23 02:18:05 master kubelet[1241]: E0123 02:18:05.661831    1241 kuberuntime_manager.go:1172] &quot;CreatePodSandbox for pod failed&quot; err=&quot;rpc error: code = Unknown desc = failed to set&gt;</span><br><span class="line">Jan 23 02:18:05 master kubelet[1241]: E0123 02:18:05.661990    1241 pod_workers.go:1298] &quot;Error syncing pod, skipping&quot; err=&quot;failed to \&quot;CreatePodSandbox\&quot; for \&quot;coredns-857d9ff4c9-fn&gt;</span><br><span class="line">Jan 23 02:18:01 master kubelet[1241]: I0123 02:18:01.986626    1241 kuberuntime_container_linux.go:167] &quot;No swap cgroup controller present&quot; swapBehavior=&quot;&quot; pod=&quot;kube-system/coredns-8&gt;</span><br><span class="line">Jan 23 02:18:06 master kubelet[1241]: I0123 02:18:06.567990    1241 kuberuntime_container_linux.go:167] &quot;No swap cgroup controller present&quot; swapBehavior=&quot;&quot; pod=&quot;kube-system/coredns-8&gt;</span><br><span class="line">Jan 23 02:18:17 master kubelet[1241]: I0123 02:18:17.642092    1241 kuberuntime_container_linux.go:167] &quot;No swap cgroup controller present&quot; swapBehavior=&quot;&quot; pod=&quot;default/nginx-56fcf95&gt;</span><br><span class="line">Jan 23 02:18:24 master kubelet[1241]: I0123 02:18:24.368059    1241 kuberuntime_container_linux.go:167] &quot;No swap cgroup controller present&quot; swapBehavior=&quot;&quot; pod=&quot;default/nginx-56fcf95&gt;</span><br><span class="line">Jan 23 03:03:31 master kubelet[1241]: I0123 03:03:31.905086    1241 dynamic_cafile_content.go:171] &quot;Shutting down controller&quot; name=&quot;client-ca-bundle::/etc/kubernetes/pki/ca.crt&quot;</span><br><span class="line">Jan 23 03:03:31 master systemd[1]: Stopping kubelet: The Kubernetes Node Agent...</span><br><span class="line">Jan 23 03:03:31 master systemd[1]: kubelet.service: Succeeded.</span><br><span class="line">Jan 23 03:03:31 master systemd[1]: Stopped kubelet: The Kubernetes Node Agent.</span><br></pre></td></tr></table></figure>

<p>配置文件是 <code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code>（有些环境可能是 <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>）</p>
</li>
<li><p>修改启动参数，新增一个配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">Environment=&quot;KUBELET_EXTRA_ARGS=--container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.5&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart containerd</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>crictl</code> 命令配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h1><p>Kubernetes 网络模型设计的基础原则是：</p>
<ul>
<li>所有的 <code>Pod</code> 能够不通过 <code>NAT</code> 就能相互访问</li>
<li>所有的节点能够不通过 <code>NAT</code> 就能相互访问</li>
<li>容器内看见的 <code>IP</code> 地址和外部组件看到的容器 <code>IP</code> 是一样的</li>
</ul>
<p>Kubernetes 的集群里，<code>IP</code> 地址是以 <code>Pod</code> 为单位进行分配的，每个 <code>Pod</code> 都拥有一个独立的 <code>IP</code> 地址。</p>
<p>一个 <code>Pod</code> 内部的所有容器共享一个网络栈，即主机上的一个网络命名空间，包括它们的 <code>IP</code> 地址、网络设备、配置等都是共享的。也就是说，<code>Pod</code> 里面的所有容器能通过 <code>localhost:port</code> 来连接对方。在 Kubernetes 中，提供了一个轻量的通用容器网络接口 <code>CNI</code>（<code>Container Network Interface</code>），专门用于设置和删除容器的网络连通性。容器运行时通过 <code>CNI</code> 调用网络插件来完成容器的网络设置。</p>
<h2 id="CNI-插件分类和常见插件"><a href="#CNI-插件分类和常见插件" class="headerlink" title="CNI 插件分类和常见插件"></a>CNI 插件分类和常见插件</h2><ul>
<li><code>IPAM</code>：IP 分配器，用于 IP 地址分配</li>
<li>主插件：网卡设置<ul>
<li><code>bridge</code>：创建一个网桥，并把主机端口和容器端口插入网桥</li>
<li><code>ipvlan</code>：为容器添加 <code>ipvlan</code> 网口</li>
<li><code>loopback</code>：设置 <code>loopback</code> 网口</li>
</ul>
</li>
<li><code>Meta</code>：附加功能<ul>
<li><code>portmap</code>：设置主机端口和容器端口映射</li>
<li><code>bandwidth</code>：利用 <code>Linux Traffic Control</code> 限流</li>
<li><code>firewall</code>：通过 <code>iptables</code> 或 <code>firewall</code> 为容器设置防火墙规则</li>
</ul>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvbnRhaW5lcm5ldHdvcmtpbmcvcGx1Z2lucw==">https://github.com/containernetworking/plugins<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="CNI-插件运行机制"><a href="#CNI-插件运行机制" class="headerlink" title="CNI 插件运行机制"></a>CNI 插件运行机制</h2><p>容器运行时在启动时会从 <code>CNI</code> 的配置目录（默认目录 <code>/etc/cni/net.d/</code> ）中读取 <code>JSON</code> 格式的配置文件，文件后缀为 <code>.conf</code>、<code>.conflist</code>、<code>.json</code>。如果配置目录中包含多个文件，一般情况下，会以名字排序选用第一个配置文件作为默认的网络配置，并加载获取其中指定的 <code>CNI</code> 插件名称和配置参数。</p>
<p>默认可执行文件位置：<code>/opt/cni/bin/</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /opt/cni/bin/</span></span><br><span class="line">bandwidth  bridge  calico  calico-ipam  dhcp  dummy  firewall  flannel  host-device  host-local  ipvlan  loopback  macvlan  portmap  ptp  sbr  static  tap  tuning  vlan  vrf</span><br></pre></td></tr></table></figure>

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-20-34-image-20240122142034830.png" alt="image-20240122142034830"></p>
<h2 id="CNI-的运行机制"><a href="#CNI-的运行机制" class="headerlink" title="CNI 的运行机制"></a>CNI 的运行机制</h2><p>关于容器网络管理，容器运行时一般需要配置两个参数 <code>--cni-bin-dir</code> 和 <code>--cni-conf-dir</code>。有一种特殊情况，<code>kubelet</code> 内置的 <code>Docker</code> 作为容器运行时，是由  <code>kubelet</code> 来查找 <code>CNI</code> 插件的，运行插件来为容器设置网络，这两个参数应该配置在 <code>kubelet</code> 处：</p>
<ul>
<li><code>cni-bin-dir</code>：网络插件的可执行文件所在目录。默认是 <code>/opt/cni/bin</code></li>
<li><code>cni-conf-dir</code>：网络插件的配置文件所在目录。默认是 <code>/etc/cni/net.d</code></li>
</ul>
<h2 id="CNI-插件设计考量"><a href="#CNI-插件设计考量" class="headerlink" title="CNI 插件设计考量"></a>CNI 插件设计考量</h2><ul>
<li>容器运行时必须在调用任何插件之前为容器创建一个新的网络命名空间</li>
<li>容器运行时必须决定这个容器属于哪些网络，针对每个网络，哪些插件必须要执行</li>
<li>容器运行时必须加载配置文件，并确定设置网络时哪些插件必须被执行</li>
<li>网络配置采用 <code>JSON</code> 格式，可以很容易地存储在文件中</li>
<li>容器运行时必须按顺序执行配置文件里相应的插件（配置文件中多个 <code>plugins</code> 时，链式调用）</li>
<li>在完成容器生命周期后，容器运行时必须按照与执行添加容器相反的顺序执行插件，以便将容器与网络断开连接</li>
<li>容器运行时被同一容器调用时不能并行操作，但被不同的容器调用时，允许并行操作</li>
<li>容器运行时针对一个容器必须按顺序执行 <code>ADD</code> 和 <code>DEL</code> 操作，<code>ADD</code> 后面总是跟着相应的 <code>DEL</code>。<code>DEL</code> 可能跟着额外的 <code>DEL</code>，插件应该允许处理多个 <code>DEL</code></li>
<li>容器必须由 <code>ContainerID</code> 来唯一标识，需要存储状态的插件需要使用网络名称、容器 <code>ID</code> 和网络接口组成的主 <code>key</code> 用于索引</li>
<li>容器运行时针对同一个网络、同一个容器、同一个网络接口，不能连续调用两次 <code>ADD</code> 命令</li>
</ul>
<h2 id="打通主机层网络"><a href="#打通主机层网络" class="headerlink" title="打通主机层网络"></a>打通主机层网络</h2><p><code>CNI</code> 插件外，Kubernetes 还需要标准的 <code>CNI</code> 插件 <code>lo</code>，最低版本为 <code>0.2.0</code> 版本。</p>
<p>网络插件除支持设置和清理 <code>Pod</code> 网络接口外，该插件还需要支持 <code>iptables</code>。</p>
<p>如果 <code>Kube-proxy</code> 工作在 <code>iptables</code> 模式，网络插件需要确保容器流量能使用 <code>iptables</code> 转发。例如，网络插件将容器连接到 <code>Linux</code> 网桥，必须将 <code>net/bridge/bridge-nf-call-iptables</code> 参数 <code>sysctl</code> 设置为 1，网桥上数据包将遍历 <code>iptables</code> 规则。</p>
<p>如果插件不使用 <code>Linux</code> 桥接器（而是类似 <code>Open vSwitch</code> 或其他某种机制的插件），则应确保容器流量被正确设置了路由。</p>
<h2 id="CNI-Plugin"><a href="#CNI-Plugin" class="headerlink" title="CNI Plugin"></a>CNI Plugin</h2><p><code>ContainerNetworking</code> 组维护了一些 <code>CNI</code> 插件，包括网络接口创建的 <code>bridge</code>、<code>ipvlan</code>、<code>loopback</code>、<code>macvlan</code>、<code>ptp</code>、<code>host-device</code> 等，<code>IP</code> 地址分配的 <code>DHCP</code>、<code>host-local</code> 和 <code>static</code>，其他的 <code>Flannel</code>、<code>tunning</code>、<code>portmap</code>、<code>firewalld</code> 等。</p>
<p>社区还有些第三方网络策略方面的插件，例如 <code>Calic</code>、<code>Cilium</code> 和 <code>Weave</code> 等。可用选项的多样性意味着大多数用户将能够找到适合当前需求和部署环境的的 <code>CNI</code> 插件，并在情况变化时迅捷转换解决方案。（<code>Calic</code> 和 <code>Cilium</code> 这两个插件比较推荐，是完备的解决方案）</p>
<h3 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h3><p><code>Flannel</code> 是由  <code>CoreOS</code> 开发的项目，是 <code>CNI</code> 插件早期的入门产品，简单易用。</p>
<p><code>Flannel</code> 使用 Kubernetes 集群的现有 <code>etcd</code> 集群来存储其状态信息，从而不必提供专用的数据存储，只需要在每个节点上运行 <code>flanneld</code> 来守护进程。</p>
<p>每个节点都被分配一个子网，为该节点上的 <code>Pod</code> 分配 <code>IP</code> 地址。</p>
<p>同一主机内的 Pod 可以使用网桥进行通信，而不同主机上的 Pod 将通过 <code>flanneld</code> 将其流量封装在 <code>UDP</code> 数据包中，以路由到适当的目的地。</p>
<p>封装方式默认和推荐的方法是使用 <code>VxLAN</code>，因为它具有良好的性能，并且比其他选项要少些人为干预。虽然使用 <code>VxLAN</code> 之类的技术封装的解决方案效果很好，但缺点就是该过程使流量跟踪变得困难。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-38-29-image-20240122143829054.png" alt="image-20240122143829054"></p>
<h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><p><code>Calico</code> 以其性能、灵活性和网络策略而闻名，不仅涉及在主机和 Pod 之间提供网络连接，而且还涉及网络安全性和策略管理。</p>
<p>对于同网段通信，基于第 3 层，<code>Calico</code> 使用 <code>BGP</code> 路由协议在主机之间路由数据包，使用 <code>BGP</code> 路由协议也意味着数据包在主机之间移动时不需要包装在额外的封装层中。</p>
<p>对于跨网段通信，基于 <code>IPinIP</code> （<code>Calico</code> 支持多种，也支持 <code>VxLan</code>）使用虚拟网卡设备 <code>tunl0</code>，用一个 IP 数据包封装另一个 IP 数据包，外层 IP 数据包头的源地址为隧道入口设备的 IP 地址，目标地址为隧道出口设备的 IP 地址。</p>
<p>网络策略是 <code>Calico</code> 最受欢迎的功能之一，使用 <code>ACLs</code> 协议和 <code>kube-proxy</code> 来创建 <code>iptables</code> 过滤规则，从而实现隔离容器网络的目的。</p>
<p>此外，<code>Calico</code> 还可以与服务网络 <code>Istio</code> 集成，在服务网格层和基础结构层上解释和实施集群中工作负载的策略。这意味着您可以配置功能强大的规则，以描述 Pod 应该如何发送和接受流量，提高安全性及加强对网络环境的控制。</p>
<p><code>Calico</code> 属于完全分布式的横向扩展接口，允许开发人员和管理员快速和平稳地扩展部署规模。对于性能和功能（如网络策略）要求高的环境，<code>Calico</code> 是一个不错选择。</p>
<h4 id="Calico-组件"><a href="#Calico-组件" class="headerlink" title="Calico 组件"></a>Calico 组件</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-44-34-image-20240122144434027.png" alt="image-20240122144434027"></p>
<h4 id="Calico-初始化"><a href="#Calico-初始化" class="headerlink" title="Calico 初始化"></a>Calico 初始化</h4><p>配置和 <code>CNI</code> 二进制文件由  <code>initContainer</code> 推送</p>
<p><code>https://docs.projectcalico.org/manifests/calico.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This container installs the CNI binaries</span></span><br><span class="line"><span class="comment"># and CNI network config file on each node.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker.io/calico/cni:v3.26.1</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">command:</span> [<span class="string">&quot;/opt/cni/bin/install&quot;</span>]</span><br><span class="line">  <span class="attr">envFrom:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">      <span class="comment"># Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode.</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kubernetes-services-endpoint</span></span><br><span class="line">      <span class="attr">optional:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="comment"># Name of the CNI config file to create.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CNI_CONF_NAME</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;10-calico.conflist&quot;</span></span><br><span class="line">    <span class="comment"># The CNI network config to install on each node.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CNI_NETWORK_CONFIG</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">calico-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">cni_network_config</span></span><br><span class="line">    <span class="comment"># Set the hostname based on the k8s node name.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBERNETES_NODE_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="comment"># CNI MTU Config variable</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CNI_MTU</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">calico-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">veth_mtu</span></span><br><span class="line">    <span class="comment"># Prevents the container from sleeping forever.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SLEEP</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="comment"># 将主机的 bin 目录挂载到容器中，将二进制可执行文件拷贝到容器中执行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host/opt/cni/bin</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">cni-bin-dir</span></span><br><span class="line">  <span class="comment"># 同理，将主机的配置文件目录挂载到容器中，执行是按照配置文件执行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host/etc/cni/net.d</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cni-net-dir</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="Calico-配置一览"><a href="#Calico-配置一览" class="headerlink" title="Calico 配置一览"></a>Calico 配置一览</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;k8s-pod-network&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;cniVersion&quot;:</span> <span class="string">&quot;0.3.1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;plugins&quot;:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment"># type 表示执行哪个二进制文件</span></span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;calico&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;log_level&quot;:</span> <span class="string">&quot;info&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;log_file_path&quot;:</span> <span class="string">&quot;/var/log/calico/cni/cni.log&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;datastore_type&quot;:</span> <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;nodename&quot;:</span> <span class="string">&quot;__KUBERNETES_NODE_NAME__&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;mtu&quot;:</span> <span class="string">__CNI_MTU__</span>,</span><br><span class="line">      <span class="attr">&quot;ipam&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;calico-ipam&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;k8s&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;kubernetes&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;kubeconfig&quot;:</span> <span class="string">&quot;__KUBECONFIG_FILEPATH__&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;portmap&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;snat&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;capabilities&quot;:</span> &#123;<span class="attr">&quot;portMappings&quot;:</span> <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;bandwidth&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;capabilities&quot;:</span> &#123;<span class="attr">&quot;bandwidth&quot;:</span> <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Calico-VXLan"><a href="#Calico-VXLan" class="headerlink" title="Calico VXLan"></a>Calico VXLan</h4><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F22%2F14-49-55-image-20240122144955681.png" alt="image-20240122144955681"></p>
<p>例如 Pod 跨主机通信时，本机 Pod 通过 <code>vxlan-calico</code> 将包重新封装，数据传输到另外一个 Node 之后，解封装。</p>
<h4 id="IPPool"><a href="#IPPool" class="headerlink" title="IPPool"></a>IPPool</h4><p><code>IPPool</code> 用来定义一个集群的预定义 IP 段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get ippools.crd.projectcalico.org -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">crd.projectcalico.org/v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">IPPool</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">projectcalico.org/metadata:</span> <span class="string">&#x27;&#123;&quot;uid&quot;:&quot;5ee07c6d-3c02-430a-9b6f-1b58adb9ca9d&quot;,&quot;creationTimestamp&quot;:&quot;2024-01-23T08:03:49Z&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-23T08:03:49Z&quot;</span></span><br><span class="line">    <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default-ipv4-ippool</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;179541&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">38b10bd6-e759-417d-a90d-229141c6d8f1</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">allowedUses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Workload</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Tunnel</span></span><br><span class="line">    <span class="comment"># 每个节点的 IP 段</span></span><br><span class="line">    <span class="attr">blockSize:</span> <span class="number">26</span></span><br><span class="line">    <span class="comment"># IP池</span></span><br><span class="line">    <span class="attr">cidr:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">    <span class="attr">ipipMode:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">natOutgoing:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">all()</span></span><br><span class="line">    <span class="attr">vxlanMode:</span> <span class="string">CrossSubnet</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>IPAMBlock</p>
<p><code>IPAMBlock</code> 用来定义每个主机预分配的 IP 段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get ipamblocks.crd.projectcalico.org</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">AGE</span></span><br><span class="line"><span class="number">10</span><span class="number">-244</span><span class="number">-219</span><span class="number">-64</span><span class="number">-26</span>   <span class="string">10m</span></span><br><span class="line"><span class="comment"># kubectl get ipamblocks.crd.projectcalico.org 10-244-219-64-26 -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">crd.projectcalico.org/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IPAMBlock</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">projectcalico.org/metadata:</span> <span class="string">&#x27;&#123;&quot;creationTimestamp&quot;:null&#125;&#x27;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-23T08:03:50Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">10</span><span class="number">-244</span><span class="number">-219</span><span class="number">-64</span><span class="number">-26</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;179674&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">05b0f741-2b9d-437d-9765-dfea7372ef5f</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span> <span class="string">host:master</span></span><br><span class="line">  <span class="comment"># 记录已经分配出去的 IP</span></span><br><span class="line">  <span class="attr">allocations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="bullet">-</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">attributes:</span></span><br><span class="line">  <span class="comment"># 记录对应节点上的对应 pod 网络信息</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">handle_id:</span> <span class="string">vxlan-tunnel-addr-master</span></span><br><span class="line">    <span class="attr">secondary:</span></span><br><span class="line">      <span class="attr">node:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">vxlanTunnelAddress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">handle_id:</span> <span class="string">k8s-pod-network.97b842e968e4f6a87ec18c49d83e8fdee8b15c08f1abe434ae37544e9c1c981a</span></span><br><span class="line">    <span class="attr">secondary:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">calico-apiserver</span></span><br><span class="line">      <span class="attr">node:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">pod:</span> <span class="string">calico-apiserver-56b77f99b6-jmdd8</span></span><br><span class="line">      <span class="attr">timestamp:</span> <span class="number">2024-01-23 08:04:23.416519759</span> <span class="string">+0000</span> <span class="string">UTC</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">handle_id:</span> <span class="string">k8s-pod-network.cc7335cb78b8a510a2a0092fa3b2fb63c883a7ec646965433196f2e88ede4b6f</span></span><br><span class="line">    <span class="attr">secondary:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">calico-apiserver</span></span><br><span class="line">      <span class="attr">node:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">pod:</span> <span class="string">calico-apiserver-56b77f99b6-7v9zz</span></span><br><span class="line">      <span class="attr">timestamp:</span> <span class="number">2024-01-23 08:04:23.416519533</span> <span class="string">+0000</span> <span class="string">UTC</span></span><br><span class="line">  <span class="comment"># 本机上的地址段</span></span><br><span class="line">  <span class="attr">cidr:</span> <span class="number">10.244</span><span class="number">.219</span><span class="number">.64</span><span class="string">/26</span></span><br><span class="line">  <span class="attr">deleted:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">sequenceNumber:</span> <span class="number">1705997030297882301</span></span><br><span class="line">  <span class="attr">sequenceNumberForAllocation:</span></span><br><span class="line">    <span class="attr">&quot;0&quot;:</span> <span class="number">1705997030297882298</span></span><br><span class="line">    <span class="attr">&quot;1&quot;:</span> <span class="number">1705997030297882299</span></span><br><span class="line">    <span class="attr">&quot;2&quot;:</span> <span class="number">1705997030297882300</span></span><br><span class="line">  <span class="attr">strictAffinity:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 记录没有分配出去的IP</span></span><br><span class="line">  <span class="attr">unallocated:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">4</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">5</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">7</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">8</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">9</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">12</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">13</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">14</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">15</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">16</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">17</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">18</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">19</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">20</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">21</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">22</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">23</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">24</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">25</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">26</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">27</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">28</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">29</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">30</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">31</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">32</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">33</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">34</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">35</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">36</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">37</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">38</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">39</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">40</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">41</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">42</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">43</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">44</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">45</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">46</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">47</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">48</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">49</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">50</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">51</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">52</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">53</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">54</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">55</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">56</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">57</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">58</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">59</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">60</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">61</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">62</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">63</span></span><br></pre></td></tr></table></figure>

<p>新建两个 Pod 之后</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">handle_id:</span> <span class="string">k8s-pod-network.1ff620c63d340470341e83d594a6c8d4e3a86c40e4cf3cc5cec695dcf32fb036</span></span><br><span class="line">  <span class="attr">secondary:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">node:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">pod:</span> <span class="string">nginx-56fcf95486-x2f4k</span></span><br><span class="line">    <span class="attr">timestamp:</span> <span class="number">2024-01-23 08:20:10.014758292</span> <span class="string">+0000</span> <span class="string">UTC</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">handle_id:</span> <span class="string">k8s-pod-network.985155d82a66713ec672a3671961b95b9f57e41289724247129d00446ef826ec</span></span><br><span class="line">  <span class="attr">secondary:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">node:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">pod:</span> <span class="string">nginx-56fcf95486-vspfn</span></span><br><span class="line">    <span class="attr">timestamp:</span> <span class="number">2024-01-23 08:20:10.026023872</span> <span class="string">+0000</span> <span class="string">UTC</span></span><br></pre></td></tr></table></figure>

<h4 id="IPAMHandle"><a href="#IPAMHandle" class="headerlink" title="IPAMHandle"></a>IPAMHandle</h4><p><code>IPAMHandle</code> 用来记录 <code>IP</code> 分配的具体细节</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get ipamhandles.crd.projectcalico.org</span></span><br><span class="line"><span class="string">NAME</span>                                                                               <span class="string">AGE</span></span><br><span class="line"><span class="string">k8s-pod-network.97b842e968e4f6a87ec18c49d83e8fdee8b15c08f1abe434ae37544e9c1c981a</span>   <span class="string">12m</span></span><br><span class="line"><span class="string">k8s-pod-network.cc7335cb78b8a510a2a0092fa3b2fb63c883a7ec646965433196f2e88ede4b6f</span>   <span class="string">12m</span></span><br><span class="line"><span class="string">vxlan-tunnel-addr-master</span>                                                           <span class="string">13m</span></span><br><span class="line"><span class="comment"># kubectl get ipamhandles.crd.projectcalico.org  k8s-pod-network.97b842e968e4f6a87ec18c49d83e8fdee8b15c08f1abe434ae37544e9c1c981a -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">crd.projectcalico.org/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IPAMHandle</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">projectcalico.org/metadata:</span> <span class="string">&#x27;&#123;&quot;creationTimestamp&quot;:null&#125;&#x27;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-23T08:04:23Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-pod-network.97b842e968e4f6a87ec18c49d83e8fdee8b15c08f1abe434ae37544e9c1c981a</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;179670&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">f18070ec-8deb-4163-bb3b-06854f008435</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">block:</span></span><br><span class="line">    <span class="attr">10.244.219.64/26:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">deleted:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">handleID:</span> <span class="string">k8s-pod-network.97b842e968e4f6a87ec18c49d83e8fdee8b15c08f1abe434ae37544e9c1c981a</span></span><br></pre></td></tr></table></figure>

<p>查看 Pod 之间的网络通信方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod calico-node-5dd86 -n calico-system -o yaml</span></span><br><span class="line">// 在环境变量中可以看到，使用的 BACKEND 是 bird</span><br><span class="line">    - name: CALICO_NETWORKING_BACKEND</span><br><span class="line">      value: bird</span><br><span class="line">    // 同时，在准备探针检测中，会判断 bird 是否正常运行</span><br><span class="line">    readinessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /bin/calico-node</span><br><span class="line">        - -bird-ready</span><br><span class="line">        - -felix-ready</span><br></pre></td></tr></table></figure>

<p>单一节点上的路由</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP              NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">centos-cdc7c7c47-nlwbz   1/1     Running   0          2m58s   10.244.219.77   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-56fcf95486-vspfn   1/1     Running   0          20m     10.244.219.68   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-56fcf95486-x2f4k   1/1     Running   0          20m     10.244.219.67   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">// 查看 pod 路由表</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it centos-cdc7c7c47-nlwbz -- ip r</span></span><br><span class="line">default via 169.254.1.1 dev eth0</span><br><span class="line">169.254.1.1 dev eth0 scope link</span><br><span class="line">// ping 另外一个 Pod，获取 arp 信息，根据路由表，会将数据发送给网关</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it centos-cdc7c7c47-nlwbz -- arping 10.244.219.67</span></span><br><span class="line">ARPING 10.244.219.67 from 10.244.219.77 eth0</span><br><span class="line">Unicast reply from 10.244.219.67 [EE:EE:EE:EE:EE:EE]  0.537ms</span><br><span class="line">Unicast reply from 10.244.219.67 [EE:EE:EE:EE:EE:EE]  0.545ms</span><br><span class="line">Unicast reply from 10.244.219.67 [EE:EE:EE:EE:EE:EE]  0.547ms</span><br><span class="line">// 可以看到 mac 是 EE:EE:EE:EE:EE:EE</span><br></pre></td></tr></table></figure>

<p>查看主机上对应端口信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip a</span></span><br><span class="line">17: cali4780ce7eb39@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-05afe92d-eb9a-98af-e8f7-bb95220c91ef</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">18: cali13cd52fc8bb@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-25adab6a-1a59-276e-bd6d-d4e0fa9ea051</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">27: calibe26fc2c4e2@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-67fcb21d-38ca-8ae0-ea98-8137da4216aa</span><br><span class="line">    inet6 fe80::ecee:eeff:feee:eeee/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>可以看到，发出的包会被主机获取</p>
<p>主机通过路由表信息，获取对端网口，将网络请求转发过去</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip r</span></span><br><span class="line">default via 192.168.239.2 dev ens33 proto dhcp src 192.168.239.128 metric 100</span><br><span class="line">10.244.0.0/24 dev cni0 proto kernel scope <span class="built_in">link</span> src 10.244.0.1</span><br><span class="line">blackhole 10.244.219.64/26 proto 80</span><br><span class="line">10.244.219.65 dev cali87846c71e8e scope <span class="built_in">link</span>  </span><br><span class="line">10.244.219.66 dev cali875743405b5 scope <span class="built_in">link</span></span><br><span class="line">10.244.219.67 dev cali4780ce7eb39 scope <span class="built_in">link</span>	// 路由信息</span><br><span class="line">10.244.219.68 dev cali13cd52fc8bb scope <span class="built_in">link</span></span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope <span class="built_in">link</span> src 172.17.0.1 linkdown</span><br><span class="line">192.168.239.0/24 dev ens33 proto kernel scope <span class="built_in">link</span> src 192.168.239.128</span><br><span class="line">192.168.239.2 dev ens33 proto dhcp scope <span class="built_in">link</span> src 192.168.239.128 metric 100</span><br></pre></td></tr></table></figure>

<p>通过 BGP 交换路由信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip r</span></span><br><span class="line">default via 192.168.1.1 dev ens37 proto static</span><br><span class="line">10.244.34.64/26 via 192.168.239.129 dev ens33 proto 80 onlink</span><br><span class="line">10.244.57.192/26 via 192.168.239.130 dev ens33 proto 80 onlink</span><br><span class="line">blackhole 10.244.219.64/26 proto 80						// 通过 bird 获取路由信息，将跨主机的网络请求转发出去</span><br><span class="line">10.244.219.68 dev cali84e33c2883b scope link</span><br><span class="line">10.244.219.69 dev calid290945cc5f scope link</span><br><span class="line">10.244.219.70 dev cali186d08d48b3 scope link</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown</span><br><span class="line">192.168.1.0/24 dev ens37 proto kernel scope link src 192.168.1.12</span><br><span class="line">192.168.239.0/24 dev ens33 proto kernel scope link src 192.168.239.128</span><br></pre></td></tr></table></figure>

<h2 id="创建-Pod-并查看-IP-配置情况"><a href="#创建-Pod-并查看-IP-配置情况" class="headerlink" title="创建 Pod 并查看 IP 配置情况"></a>创建 Pod 并查看 IP 配置情况</h2><p>使用其他插件的查看过程差不多，例如 <code>flannel</code></p>
<p>容器 <code>namespace</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nsenter -t 3863 -n ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 5a:4a:5c:f8:71:77 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.244.0.11/24 brd 10.244.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::584a:5cff:fef8:7177/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nsenter -t 3863 -n ip r</span></span><br><span class="line">default via 10.244.0.1 dev eth0</span><br><span class="line">10.244.0.0/24 dev eth0 proto kernel scope link src 10.244.0.11</span><br><span class="line">10.244.0.0/16 via 10.244.0.1 dev eth0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nsenter -t 3427 -n arp</span></span><br><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">10.244.0.1               ether   d2:f8:7e:93:5d:bb   C                     eth0</span><br></pre></td></tr></table></figure>

<p>主机 <code>namespace</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip <span class="built_in">link</span></span></span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span><br><span class="line">    link/ether e2:39:90:82:b3:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether d2:f8:7e:93:5d:bb brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip route</span></span><br><span class="line">10.244.0.0/24 dev cni0 proto kernel scope link src 10.244.0.1</span><br></pre></td></tr></table></figure>

<h2 id="CNI-plugin-的对比"><a href="#CNI-plugin-的对比" class="headerlink" title="CNI plugin 的对比"></a>CNI plugin 的对比</h2><table>
<thead>
<tr>
<th>解决方案</th>
<th>是否支持网络策略</th>
<th>是否支持 ipv6</th>
<th>基于网络层级</th>
<th>部署方式</th>
<th>命令行</th>
</tr>
</thead>
<tbody><tr>
<td>Calico</td>
<td>是</td>
<td>是</td>
<td>L3(IPinIP, BGP)</td>
<td>DaemonSet</td>
<td>calicoctl</td>
</tr>
<tr>
<td>Cilium</td>
<td>是</td>
<td>是</td>
<td>L3&#x2F;L4 + L7(filtering)</td>
<td>DaemonSet</td>
<td>cilium</td>
</tr>
<tr>
<td>Contiv</td>
<td>否</td>
<td>是</td>
<td>L2(VxLan) &#x2F; L3(BGP)</td>
<td>DaemonSet</td>
<td>无</td>
</tr>
<tr>
<td>Flannel</td>
<td>否</td>
<td>否</td>
<td>L2(VxLan)</td>
<td>DaemonSet</td>
<td>无</td>
</tr>
<tr>
<td>Weave net</td>
<td>是</td>
<td>是</td>
<td>L2(VxLan)</td>
<td>DaemonSet</td>
<td>无</td>
</tr>
</tbody></table>
<h1 id="CSI"><a href="#CSI" class="headerlink" title="CSI"></a>CSI</h1><h2 id="容器运行时存储"><a href="#容器运行时存储" class="headerlink" title="容器运行时存储"></a>容器运行时存储</h2><ul>
<li>除外挂存储外，容器启动后，运行时所需文件系统性能直接影响容器性能；</li>
<li>早期的 <code>Docker</code> 采用 <code>Device Mapper</code> 作为容器运行时存储驱动，因为 <code>OverlayFS</code> 尚未合并进 <code>Kernel</code>；</li>
<li>目前 <code>Docker</code> 和 <code>containerd</code> 都默认以 <code>OverlayFS</code> 作为<strong>运行时存储</strong>驱动（镜像层，一般不会往里面写数据，仅作为将运行时拉起来的存储）；</li>
<li><code>OverlayFS</code> 目前已经有非常好的性能，与 <code>DeviceMapper</code> 相比优 <code>20%</code>，于操作主机文件性能几乎一致；</li>
</ul>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F13-55-59-image-20240123135559751.png" alt="image-20240123135559751"></p>
<h2 id="存储卷插件管理"><a href="#存储卷插件管理" class="headerlink" title="存储卷插件管理"></a>存储卷插件管理</h2><p>Kubernetes 支持以插件的形式来实现对不同存储的支持和扩展，这些扩展基于如下三种方式：</p>
<ul>
<li><p><code>in-tree</code> 插件</p>
<p>Kubernetes 社区已不再接受新的 <code>in-tree</code> 存储插件，新的存储必须通过 <code>out-of-tree</code> 插件进行支持</p>
</li>
<li><p><code>out-of-tree</code> <code>FlexVolume</code> 插件（与 CNI 一样的逻辑，提供二进制可执行文件，在容器内执行）</p>
<p><code>FlexVolume</code>  是指 Kubernetes 通过调用计算节点的本地可执行文件与存储插件进行交互。</p>
<p><code>FlexVolume</code> 插件需要宿主机用 <code>root</code> 权限来安装插件驱动 </p>
<p><code>FlexVolume</code> 存储驱动需要宿主机安装 <code>attach</code>、<code>mount</code> 等工具，也需要具有 <code>root</code> 访问权限</p>
</li>
<li><p><code>out-of-tree</code> <code>CSI</code> 插件（相比而言更加适用）</p>
</li>
</ul>
<h3 id="out-of-tree-CSI-插件"><a href="#out-of-tree-CSI-插件" class="headerlink" title="out-of-tree CSI 插件"></a>out-of-tree CSI 插件</h3><ul>
<li>CSI 通过 RPC 与存储驱动进行交互</li>
<li>在设计 CSI 的时候，Kubernetes 对 CSI 存储驱动的打包和部署要求很少，主要定义了 Kubernetes 的两个相关模块：<ul>
<li><code>kube-controller-manager</code>：<ul>
<li><code>kube-controller-manager</code> 模块用于感知 <code>CSI</code> 驱动存在</li>
<li>Kubernetes 的主控模块通过 <code>Unix domain socket</code>（而不是 <code>CSI</code> 驱动）或者其他方式进行直接地交互</li>
<li>Kubernetes 的主控模块只与 Kubernetes 相关的 <code>API</code> 进行交互</li>
<li>因此 <code>CSI</code> 驱动若有依赖于 Kubernetes <code>API</code> 的操作，例如卷的创建、卷的 <code>attach</code>、卷的快照等，需要在 <code>CSI</code> 驱动里面通过 Kubernetes 的 <code>API</code>，来触发相关的 <code>CSI</code> 操作</li>
</ul>
</li>
<li><code>kubelet</code><ul>
<li><code>kubelet</code> 模块用于与  <code>CSI</code> 驱动进行交互</li>
<li><code>kubelet</code> 通过 <code>Unix domain socket</code> 向 <code>CSI</code> 驱动发起 <code>CSI</code> 调用（如 <code>NodeStageVolume</code>、<code>NodePublishVolume</code> 等），再发起 <code>mount</code> 卷和 <code>umount</code> 卷</li>
<li><code>kubelet</code> 通过插件注册机制发现 <code>CSI</code> 驱动及用于和 <code>CSI</code> 驱动交互的 <code>Unix Domain Soclet</code></li>
<li>所有部署在 Kubernetes 集群中的 <code>CSI</code> 驱动都要通过 <code>kubelet</code> 的插件注册机制来注册自己</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="CSI-驱动"><a href="#CSI-驱动" class="headerlink" title="CSI 驱动"></a>CSI 驱动</h2><p><code>CSI</code> 的驱动一般包含 <code>external-attacher</code>、<code>external-provision</code>、<code>external-resizer</code>、<code>external-snapshotter</code>、<code>node-driver-register</code>、<code>CSI driver</code> 等模块，可以根据实际的存储类型和需求进行不同方式的部署。驱动器以 <code>DaemonSet</code> 的形式部署在所有节点。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F14-07-07-image-20240123140707153.png" alt="image-20240123140707153"></p>
<h2 id="临时存储"><a href="#临时存储" class="headerlink" title="临时存储"></a>临时存储</h2><p>常见的临时存储主要就是 <code>emptyDir</code> 卷；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="comment"># 挂载到容器中的某个目录</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">        <span class="comment"># 声明一个 emptyDir</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>emptyDir</code> 是一种经常被用户使用的卷类型，顾名思义，<strong>卷</strong> 最初是空的。</p>
<p>当 Pod 从节点上删除时，<code>emptyDir</code> 卷中的数据也会被永久删除。但当 Pod 的容器因为某些原因退出再重启时，<code>emptyDir</code> 卷内的数据并不会丢失。</p>
<p>默认情况下，<code>emptyDir</code> 卷存储支持在该节点所使用的存储介质上，可以是本地磁盘或网络存储。</p>
<p><code>emptyDir</code> 也可以通过将 <code>emptyDir.medium</code> 字段设置为 <code>Memory</code> 来通知 Kubernetes 为容器安装 <code>tmpfs</code>，此时数据被存储在内存中，速度相对于本地存储和网络存储快很多。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain pod.spec.volumes.emptyDir</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: emptyDir &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     EmptyDir represents a temporary directory that shares a pod<span class="string">&#x27;s lifetime.</span></span><br><span class="line"><span class="string">     More info: https://kubernetes.io/docs/concepts/storage/volumes#emptydir</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Represents an empty directory for a pod. Empty directory volumes support</span></span><br><span class="line"><span class="string">     ownership management and SELinux relabeling.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FIELDS:</span></span><br><span class="line"><span class="string">   medium	&lt;string&gt;</span></span><br><span class="line"><span class="string">     What type of storage medium should back this directory. The default is &quot;&quot;</span></span><br><span class="line"><span class="string">     which means to use the node&#x27;</span>s default medium. Must be an empty string</span><br><span class="line">     (default) or Memory. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/storage/volumes<span class="comment">#emptydir</span></span><br><span class="line"></span><br><span class="line">   sizeLimit	&lt;string&gt;</span><br><span class="line">     Total amount of <span class="built_in">local</span> storage required <span class="keyword">for</span> this EmptyDir volume. The size</span><br><span class="line">     <span class="built_in">limit</span> is also applicable <span class="keyword">for</span> memory medium. The maximum usage on memory</span><br><span class="line">     medium EmptyDir would be the minimum value between the SizeLimit specified</span><br><span class="line">     here and the <span class="built_in">sum</span> of memory limits of all containers <span class="keyword">in</span> a pod. The default</span><br><span class="line">     is nil <span class="built_in">which</span> means that the <span class="built_in">limit</span> is undefined. More info:</span><br><span class="line">     http://kubernetes.io/docs/user-guide/volumes<span class="comment">#emptydir</span></span><br></pre></td></tr></table></figure>

<p>但是在节点重启的时候，内存数据会被清除；而如果存在磁盘上，则重启后数据依然存在。另外，使用 <code>tmpfs</code> 的内存也会计入容器的使用内存总量中，受系统的 <code>Cgroup</code> 限制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 查看所有的 container</span><br><span class="line">crictl ps</span><br><span class="line">// 获取详情</span><br><span class="line">crictl inspect 46e17212892c1</span><br><span class="line">// 查看到挂载的目录对应的主机目录</span><br></pre></td></tr></table></figure>

<p><code>emptyDir</code> 设计的初衷主要是给应用充当缓存空间，或者存储中间数据，用于快速恢复。</p>
<p>然而，这并不是说满足以上需求的用户都被推荐使用 <code>emptyDir</code>，我们要根据用户业务的实际特点来判断是否使用 <code>emptyDir</code>。因为 <code>emptyDir</code> 的空间位于系统根盘，被所有容器共享，所以在磁盘的使用率较高时会触发 Pod 的 <code>eviction</code> 操作，从而影响业务的稳定。</p>
<h2 id="半持久化存储"><a href="#半持久化存储" class="headerlink" title="半持久化存储"></a>半持久化存储</h2><p>常见的半持久化存储主要是 <code>hostPath</code> 卷。<code>hostPath</code> 卷能将主机节点文件系统上的文件或目录挂载到指定 Pod 中。对普通用户而言一般不需要这样的卷，但是对很多需要获取节点系统信息的 Pod 而言，却是非常必要的。</p>
<p>使用 <code>hostPath</code> 一般有两种方式：</p>
<ol>
<li>直接定义一个路径挂载到容器内</li>
<li>使用 <code>PV</code> 和 <code>PVC</code></li>
</ol>
<p>例如使用 <code>PV</code> 和 <code>PVC</code> 的方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明 PV</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">task-pv-volume</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">100Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">	  <span class="comment"># 不指定节点，集群环境下，如果 Pod 创建在某个节点，会直接使用该节点上的路径</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/mnt/data&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于 PV 声明 PVC</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">task-pv-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Mi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">task-pv-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-pv-storage</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">task-pv-claim</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-pv-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;http-server&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">task-pv-storage</span></span><br></pre></td></tr></table></figure>

<p>例如，<code>hostPath</code> 的用法举例如下：</p>
<ul>
<li>某个 Pod 需要获取节点上所有 <code>Pod</code> 的 <code>log</code>，可以通过 <code>hostPath</code> 访问所有 Pod 的 <code>stdout</code> 输出存储目录，例如 <code>/var/log/pods</code> 路径</li>
<li>某个 <code>Pod</code> 需要统计系统相关的信息，可以通过 <code>hostPath</code> 访问系统的 <code>/proc</code> 目录</li>
</ul>
<p>使用 <code>hostPath</code> 的时候，除设置必需的 <code>path</code> 属性外，用户还可以有选择性地为 <code>hostPath</code> 卷指定类型，支持类型包含目录、字符设备、块设备等。</p>
<h2 id="hostPath-卷需要注意"><a href="#hostPath-卷需要注意" class="headerlink" title="hostPath 卷需要注意"></a>hostPath 卷需要注意</h2><p>使用同一个目录的 <code>Pod</code> 可能会由于调度到不同的节点，导致目录中的内容有所不同。</p>
<p>Kubernetes 在调度时无法顾及由 <code>hostPath</code> 使用的资源。</p>
<p><code>Pod</code> 被删除后，如果没有特别处理，那么 <code>hostPath</code> 上写的数据会遗留到节点上，占用磁盘空间。</p>
<h2 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h2><p>支持持久化的存储是所有分布式系统所必备的特性。针对持久化存储，Kubernetes 引入了 <code>StorageClass</code>、<code>Volume</code>、<code>PVC（Persistent Volume Claim）</code>、<code>PV（Persistent Volume）</code> 的概念，将存储独立于 Pod 的生命周期来进行管理。</p>
<p>Kubernetes 目前支持的持久化存储包含各种主流的块存储和文件存储，譬如 <code>awsElasticBlockStore</code>、<code>azureDisk</code>、<code>cinder</code>、<code>NFS</code>、<code>cephfs</code>、<code>iscsi</code> 等，在大类上可以将其分为网络存储和本地存储两种类型。</p>
<h3 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h3><p><code>StorageClass</code> 用于指示存储的类型，不同的存储类型可以通过不同的 <code>StorageClass</code> 来为用户提供服务。<code>StorageClass</code> 主要包含存储插件 <code>provisioner</code>、卷的创建和 <code>mount</code> 参数等字段。</p>
<p>例如 <code>ceph</code></p>
<p><code>https://github.com/rook/rook/blob/master/deploy/examples/csi/cephfs/storageclass.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rook-cephfs</span></span><br><span class="line"><span class="comment"># Change &quot;rook-ceph&quot; provisioner prefix to match the operator namespace if needed</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">rook-ceph.cephfs.csi.ceph.com</span> <span class="comment"># driver:namespace:operator</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># clusterID is the namespace where the rook cluster is running</span></span><br><span class="line">  <span class="comment"># If you change this namespace, also change the namespace below where the secret namespaces are defined</span></span><br><span class="line">  <span class="attr">clusterID:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># CephFS filesystem name into which the volume shall be created</span></span><br><span class="line">  <span class="attr">fsName:</span> <span class="string">myfs</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Ceph pool into which the volume shall be created</span></span><br><span class="line">  <span class="comment"># Required for provisionVolume: &quot;true&quot;</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">myfs-replicated</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The secrets contain Ceph admin credentials. These are generated automatically by the operator</span></span><br><span class="line">  <span class="comment"># in the same namespace as the cluster.</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-name:</span> <span class="string">rook-csi-cephfs-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-name:</span> <span class="string">rook-csi-cephfs-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-name:</span> <span class="string">rook-csi-cephfs-node</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># (optional) The driver can use either ceph-fuse (fuse) or ceph kernel client (kernel)</span></span><br><span class="line">  <span class="comment"># If omitted, default volume mounter will be used - this is determined by probing for ceph-fuse</span></span><br><span class="line">  <span class="comment"># or by setting the default mounter explicitly via --volumemounter command-line argument.</span></span><br><span class="line">  <span class="comment"># mounter: kernel</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">  <span class="comment"># uncomment the following line for debugging</span></span><br><span class="line">  <span class="comment">#- debug</span></span><br></pre></td></tr></table></figure>

<h3 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h3><p>由用户创建，代表用户对存储需求的声明，主要包含需要的存储大小、存储卷的访问模式、<code>StorageClass</code> 等类型，其中存储卷的访问模式必须与存储的类型一致。</p>
<p><code>accessModes </code>字段</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>全称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>RWO</td>
<td>ReadWriteOnce</td>
<td>该卷职能在一个节点上被 mount，属性为可读可写</td>
</tr>
<tr>
<td>ROX</td>
<td>ReadOnlyMany</td>
<td>该卷可以在不同的节点上被 mount，属性为只读</td>
</tr>
<tr>
<td>RWX</td>
<td>ReadWriteMany</td>
<td>该卷可以在不同的节点上被 mount，属性为可读可写</td>
</tr>
</tbody></table>
<h3 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h3><p>由集群管理员提前创建，或者根据 PVC 的申请需求动态地创建，它代表系统后端的真实的存储空间，可以称之为卷空间。</p>
<h3 id="存储对象关系"><a href="#存储对象关系" class="headerlink" title="存储对象关系"></a>存储对象关系</h3><p>用户通过创建 PVC 来申请次存储。控制器通过 PVC 的 <code>StorageClass</code> 和请求的大小声明来存储后端创建卷，进而创建 PV，Pod 通过指定 PVC 来引用存储。用户层面，可以直接看到卷，而无法看到 <code>PVC</code> 和 <code>PV</code>。</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F15-19-19-image-20240123151919598.png" alt="image-20240123151919598"></p>
<h3 id="生产实践经验分享"><a href="#生产实践经验分享" class="headerlink" title="生产实践经验分享"></a>生产实践经验分享</h3><p>不同介质类型的磁盘，需要设置不同的 <code>StorageClass</code>，以便让用户做区分。<code>StorageClass</code> 需要设置磁盘介质的类型，以便用户了解该类存储的属性。</p>
<p>在本地存储的 PV 静态部署模式下，每个物理磁盘都尽量只创建一个 PV，而不是划分为多个分区来提供多个本地存储 PV，避免在使用时分区之间的 <code>I/O</code> 干扰。</p>
<p>本地存储需要配合磁盘检测来使用。当集群部署规模化后，每个集群的本地存储 PV 可能会超过几万个，如磁盘损坏将是频发时间。此时。需要在检测到磁盘损坏、丢盘的问题后，对节点的磁盘和相应的本地存储 PV 进行特殊的处理，例如出发告警、自动 <code>cordon</code> 节点、自动通知用户等。</p>
<p>对于提供本地存储节点的磁盘管理，需要做到灵活管理和自动化。节点磁盘的信息可以归一、集中化管理。在 <code>local-volume-provisioner</code> 中增加部署逻辑，当容器运行起来时，拉取该节点需要提供本地存储的磁盘信息，例如磁盘的设备路径，以 <code>Filesystem</code> 或 <code>Block</code> 的模式提供本地存储，或者是否需要加入某个 LVM 的虚拟组（VG）等。</p>
<p><code>local-volume-provisioner</code> 根据获取的磁盘信息对磁盘进行格式化，或者加入到某个 VG，从而形成对本地存储支持的自动化闭环。</p>
<h2 id="独占的-Local-Volume（本地存储）"><a href="#独占的-Local-Volume（本地存储）" class="headerlink" title="独占的 Local-Volume（本地存储）"></a>独占的 Local-Volume（本地存储）</h2><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F23%2F15-25-25-image-20240123152525406.png" alt="image-20240123152525406"></p>
<ul>
<li>创建 PV：通过 <code>local-volume-provisioner</code> <code>DaemonSet</code> 创建本地存储的 PV</li>
<li>创建 PVC：用户创建 PVC，由于它处于 <code>pending</code> 状态，所以 <code>kube-controller-manager</code> 并不会对该 PVC 做任何操作</li>
<li>创建 Pod：用户创建 Pod</li>
<li>Pod 挑选节点：<code>kube-scheduler</code> 开始调度 Pod，通过 PVC 的 <code>resource.request.storage</code> 和 <code>volumeMode</code> 选择满足条件的 PV，并且为 Pod 选择一个合适的节点</li>
<li>更新 PV：<code>kube-schedule</code> 将 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC，并且设置 <code>annotation pv.kubernetes.io/bound-by-controller</code> 的值为 <code>yes</code></li>
<li>PVC 和 PV 绑定：<code>pv_controller</code> 同步 PVC 和 PV 的状态，并将 PVC 和 PV 进行绑定</li>
<li>监听 PVC 对象：<code>kube-schedule</code> 等待 PVC 的状态变成 <code>Bound</code> 状态</li>
<li>Pod 调度到节点：如果 PVC 的状态变为 <code>Bound</code> 则说明调度成功，而如果 PVC 一直处于 <code>pending</code> 状态，超时后会再次进行调度</li>
<li><code>Mount</code> 卷启动容器：<code>kubelet</code> 监听到有 Pod 已经调度到节点上，对本地存储进行 <code>mount</code> 操作，并启动容器</li>
</ul>
<h2 id="Dynamic-Local-Volume（例如lvm或者远端）"><a href="#Dynamic-Local-Volume（例如lvm或者远端）" class="headerlink" title="Dynamic Local Volume（例如lvm或者远端）"></a>Dynamic Local Volume（例如lvm或者远端）</h2><p>CSI 驱动需要汇报节点上相关存储的资源信息，以便用于调度。</p>
<p>但是机器的厂家不同，汇报方式也不同。</p>
<p>例如，有的厂家的机器节点上具有 <code>NVMe</code>、<code>SSD</code>、<code>HDD</code> 等多种存储介质，希望将这些存储介质分别进行汇报。</p>
<p>这种嗯需求有别于其他存储类型的 CSI 驱动对接口的需求，因此如何汇报节点的存储信息，以及如何让节点的存储信息应用于调度，目前并没有形成统一的意见。</p>
<p>集群管理员可以基于节点存储的实际情况对开源 CSI 驱动和调度进行一些代码修改，再进行部署和使用。</p>
<h3 id="Local-Dynamic-的挂载流程"><a href="#Local-Dynamic-的挂载流程" class="headerlink" title="Local Dynamic 的挂载流程"></a>Local Dynamic 的挂载流程</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-32-16-image-20240124093216600.png" alt="image-20240124093216600"></p>
<ul>
<li>创建 PVC：用户创建 PVC，PVC 处于 <code>pending</code> 状态</li>
<li>创建 Pod：用户创建 Pod </li>
<li>Pod 选择节点：<code>kube-scheduler</code> 开始调度 Pod，通过 PVC 的 <code>pvc.spec.resources.requests.storage</code> 等选择满足条件的节点</li>
<li>更新 PVC：选择节点后，<code>kube-scheduler</code> 会给 PVC 添加包含节点信息的 <code>annotation: volume.kubernetes.io/selected-node:&lt;节点名字&gt;</code></li>
<li>创建卷：运行在节点上的容器 <code>external-provisioner</code> 监听到 PVC 带有该节点相关的 <code>annotation</code>，向相应的 CSI 驱动申请分配卷</li>
<li>创建 PV：PVC 申请到所需的存储空间后，<code>external-provisioner</code> 创建 PV，该 PV 的 <code>pv.Spec.claimRef</code> 设置为对应的 PVC</li>
<li>PVC 和 PV 绑定：<code>kube-controller-manager</code> 将 PVC 和 PV 进行绑定，状态修改为 <code>Bound</code></li>
<li>监听 PVC 状态：<code>kube-scheduler</code> 等待 PVC 编程 <code>Bound</code> 状态</li>
<li>Pod 调度到节点：当 PVC 的状态为 <code>Bound</code> 时，Pod 才算真正调度成功了。如果 PVC 一直处于 <code>Pending</code> 状态，超时后会再次进行调度</li>
<li><code>Mount</code> 卷：<code>kubelet</code> 监听到有 Pod 已经调度到节点上，对本地存储进行 <code>mount</code> 操作</li>
<li>启动容器：启动容器</li>
</ul>
<h3 id="Local-Dynamic-的挑战"><a href="#Local-Dynamic-的挑战" class="headerlink" title="Local Dynamic 的挑战"></a>Local Dynamic 的挑战</h3><p>如果将磁盘空间作为一个存储池（例如 LVM）来动态分配，那么在分配出来的逻辑卷空间的使用上，可能会受到其他逻辑卷的 <code>I/O</code> 干扰，因为底层的物理卷可能是同一个。</p>
<p>如果 PV 后端的磁盘空间是一块独立的物理磁盘，则 <code>I/O</code> 就不会受到干扰。</p>
<h3 id="生产实践经验分享-1"><a href="#生产实践经验分享-1" class="headerlink" title="生产实践经验分享"></a>生产实践经验分享</h3><ul>
<li><p>不同介质类型的磁盘，需要设置不同的 <code>StorageClass</code>，以便让用户做区分。<code>StorageClass</code> 需要设置磁盘介质的类型，以便用户了解该类存储的属性。</p>
</li>
<li><p>在本地存储的 PV 静态部署模式下，每个物理磁盘都尽量只创建一个 PV，而不是划分为多个分区来提供多个本地存储 PV，避免在使用时区分之间的 <code>I/O</code> 干扰。</p>
</li>
<li><p>本地存储需要配合磁盘检测来使用。当集群部署规模化后，每个集群的本地存储 PV 可能会超过几万个，如磁盘损坏将是频发事件。此时，需要在检测到磁盘损坏、丢盘等问题后，对节点的磁盘和相应的本地存储 PV 进行特定的处理，例如触发告警、自动 <code>cordon</code> 节点、自动通知用户等。</p>
</li>
<li><p>对于提供本地存储节点的磁盘管理，需要做到灵活管理和自动化。节点磁盘的信息可以归一、集中化管理。</p>
<p>在 <code>local-volume-provisioner</code> 中增加部署逻辑，当容器运行起来时，拉取该节点需要提供本地存储的磁盘信息，例如磁盘的设备路径，以 <code>Filesystem</code> 或 <code>Block</code> 的模式提供本地存储，或者是否需要加入某个 <code>LVM</code> 的虚拟组（<code>VG</code>）等。<code>local-volume-provisioner</code> 根据获取的磁盘信息对磁盘进行格式化，或者加入到某个 <code>VG</code>，从而形成对本地存储支持的自动化闭环。</p>
</li>
</ul>
<h2 id="Rook"><a href="#Rook" class="headerlink" title="Rook"></a>Rook</h2><p><code>Rook</code> 是一款云原生环境下的开源分布式存储编排系统，目前支持 <code>Ceph</code>、<code>NFS</code>、<code>EdgeFS</code>、<code>Cassandra</code>、<code>CockroachDB</code> 等存储系统。它实现了一个自动管理的、自动扩容的、自动修复的分布式存储服务。</p>
<p><code>Rook</code> 支持自动部署、启动、配置、分配、扩容&#x2F;缩容、升级、迁移、灾难恢复、监控以及资源管理。</p>
<h3 id="Rook-架构"><a href="#Rook-架构" class="headerlink" title="Rook 架构"></a>Rook 架构</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-49-57-image-20240124094957037.png" alt="image-20240124094957037"></p>
<h3 id="Rook-Operator"><a href="#Rook-Operator" class="headerlink" title="Rook Operator"></a>Rook Operator</h3><p><code>Rook Operator</code> 是 <code>Rook</code> 的大脑，以 <code>deployment</code> 形式存在。</p>
<p>其利用 Kubernetes 的 <code>controller-runtime</code> 框架实现了 <code>CRD</code>，并进而接受 Kubernetes 创建资源的请求并创建相关资源（集群，pool，块存储服务，文件存储服务等）</p>
<p><code>Rook Operator</code> 监控存储守护进程，来确保存储集群的健康</p>
<p>监听 <code>Rook Discovers</code> 收集到的存储磁盘设备，并创建相应服务（<code>Ceph</code> 的话就是 <code>OSD</code> 了）</p>
<h3 id="Rook-Discover"><a href="#Rook-Discover" class="headerlink" title="Rook Discover"></a>Rook Discover</h3><p><code>Rook Discover</code> 是以 <code>DaemonSet</code> 形式部署在所有的存储机上的，其检测挂接到存储节点上的存储设备。</p>
<p>把符合要求的存储设备记录下来，这样 <code>Rook Operate</code> 感知到以后就可以基于该存储设备创建相应服务了。例如使用 <code>lsblk</code> 罗列可用盘。</p>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><ol>
<li>Resetup rook，清除环境</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /var/lib/rook</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Add a new raw device，添加一块大于 5G 的盘</li>
</ol>
<p>Create a raw disk from virtualbox console and attach to the vm (must &gt; 5G).</p>
<ol start="3">
<li>Clean env for next demo，清除资源，防止遗留</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete ns rook-ceph</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `kubectl api-resources | grep <span class="literal">true</span> | awk <span class="string">&#x27;&#123;print \$1&#125;&#x27;</span>`; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>;kubectl get <span class="variable">$i</span> -n clusternet-skgdp; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Checkout rook，下载代码</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --single-branch --branch master https://github.com/rook/rook.git</span><br><span class="line"><span class="built_in">cd</span> rook/deploy/examples</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Create rook operator，创建 operator</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crds.yaml # 注册控制器</span><br><span class="line">common.yaml # sa 权限等</span><br><span class="line">operator.yaml # 控制器核心配置</span><br></pre></td></tr></table></figure>

<p>可以修改控制器核心配置文件中的镜像文件地址，改成 <code>aliyun</code> 避免下面下镜像失败导致的问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The default version of CSI supported by Rook will be started. To change the version</span></span><br><span class="line"><span class="comment"># of the CSI driver to something other than what is officially supported, change</span></span><br><span class="line"><span class="comment"># these images to the desired release of the CSI driver.</span></span><br><span class="line"><span class="comment"># ROOK_CSI_CEPH_IMAGE: &quot;quay.io/cephcsi/cephcsi:v3.10.1&quot;</span></span><br><span class="line"><span class="comment"># ROOK_CSI_REGISTRAR_IMAGE: &quot;registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.9.1&quot;</span></span><br><span class="line"><span class="comment"># ROOK_CSI_RESIZER_IMAGE: &quot;registry.k8s.io/sig-storage/csi-resizer:v1.9.2&quot;</span></span><br><span class="line"><span class="comment"># ROOK_CSI_PROVISIONER_IMAGE: &quot;registry.k8s.io/sig-storage/csi-provisioner:v3.6.2&quot;</span></span><br><span class="line"><span class="comment"># ROOK_CSI_SNAPSHOTTER_IMAGE: &quot;registry.k8s.io/sig-storage/csi-snapshotter:v6.3.2&quot;</span></span><br><span class="line"><span class="comment"># ROOK_CSI_ATTACHER_IMAGE: &quot;registry.k8s.io/sig-storage/csi-attacher:v4.4.2&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f crds.yaml -f common.yaml -f operator.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Create ceph cluster，创建 ceph cluster</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n rook-ceph</span><br></pre></td></tr></table></figure>

<p>Wait for all pod to be running, and：（这一步会下载很多镜像，容易出错），可以先通过 aliyun 下载，然后修改 tag</p>
<p>也可以直接修改 <code>cm</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl edit cm rook-ceph-operator-config</span></span><br><span class="line">  ROOK_CSI_REGISTRAR_IMAGE: &quot;registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1&quot;</span><br><span class="line">  ROOK_CSI_RESIZER_IMAGE: &quot;registry.aliyuncs.com/google_containers/csi-resizer:v1.9.2&quot;</span><br><span class="line">  ROOK_CSI_PROVISIONER_IMAGE: &quot;registry.aliyuncs.com/google_containers/csi-provisioner:v3.6.2&quot;</span><br><span class="line">  ROOK_CSI_SNAPSHOTTER_IMAGE: &quot;registry.aliyuncs.com/google_containers/csi-snapshotter:v6.3.2&quot;</span><br><span class="line">  ROOK_CSI_ATTACHER_IMAGE: &quot;registry.aliyuncs.com/google_containers/csi-attacher:v4.4.2&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1 registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.9.1</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/csi-snapshotter:v6.3.2</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/csi-snapshotter:v6.3.2 registry.k8s.io/sig-storage/csi-snapshotter:v6.3.2</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/csi-attacher:v4.4.2</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/csi-attacher:v4.4.2 registry.k8s.io/sig-storage/csi-attacher:v4.4.2</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/csi-resizer:v1.9.2</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/csi-resizer:v1.9.2 registry.k8s.io/sig-storage/csi-resizer:v1.9.2</span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/csi-provisioner:v3.6.2</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/csi-provisioner:v3.6.2 registry.k8s.io/sig-storage/csi-provisioner:v3.6.2</span><br></pre></td></tr></table></figure>

<p>或者修改 <code>yaml</code> 配置中的镜像，将镜像前缀替换成 <code>aliyun</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如将</span></span><br><span class="line">registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.9.1</span><br><span class="line"><span class="comment"># 替换成</span></span><br><span class="line">registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cluster-test.yaml</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>整个过程会比较长，简单来说，就是 <code>rook</code> 通过几个控制器检查独立的磁盘，并且使用 <code>ceph</code> 的命令行进行格式化处理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl logs -f rook-ceph-osd-prepare-master-r5srp</span></span><br><span class="line">2024-01-24 07:10:48.572868 I | cephosd: discovering hardware</span><br><span class="line">2024-01-24 07:10:48.573130 D | exec: Running command: lsblk --all --noheadings --list --output KNAME</span><br><span class="line">2024-01-24 07:10:48.582603 D | exec: Running command: lsblk /dev/fd0 --bytes --nodeps --pairs --paths --output SIZE,ROTA,RO,TYPE,PKNAME,NAME,KNAME,MOUNTPOINT,FSTYPE</span><br><span class="line">// 依次处理每块磁盘</span><br><span class="line">2024-01-24 07:10:49.182447 D | exec: Running command: lsblk /dev/sdb --bytes --nodeps --pairs --paths --output SIZE,ROTA,RO,TYPE,PKNAME,NAME,KNAME,MOUNTPOINT,FSTYPE</span><br><span class="line">2024-01-24 07:10:49.188848 D | sys: lsblk output: &quot;SIZE=\&quot;10737418240\&quot; ROTA=\&quot;1\&quot; RO=\&quot;0\&quot; TYPE=\&quot;disk\&quot; PKNAME=\&quot;\&quot; NAME=\&quot;/dev/sdb\&quot; KNAME=\&quot;/dev/sdb\&quot; MOUNTPOINT=\&quot;\&quot; FSTYPE=\&quot;ceph_bluestore\&quot;&quot;</span><br><span class="line">2024-01-24 07:10:49.189049 D | exec: Running command: sgdisk --print /dev/sdb</span><br><span class="line">2024-01-24 07:10:49.194088 D | exec: Running command: udevadm info --query=property /dev/sdb</span><br><span class="line">2024-01-24 07:10:49.213747 D | sys: udevadm info output: &quot;DEVLINKS=/dev/disk/by-path/pci-0000:00:10.0-scsi-0:0:1:0\nDEVNAME=/dev/sdb\nDEVPATH=/devices/pci0000:00/0000:00:10.0/host32/target32:0:1/32:0:1:0/block/sdb\nDEVTYPE=disk\nID_BUS=scsi\nID_FS_TYPE=ceph_bluestore\nID_FS_USAGE=other\nID_MODEL=VMware_Virtual_S\nID_MODEL_ENC=VMware\\x20Virtual\\x20S\nID_PATH=pci-0000:00:10.0-scsi-0:0:1:0\nID_PATH_TAG=pci-0000_00_10_0-scsi-0_0_1_0\nID_REVISION=1.0\nID_SCSI=1\nID_TYPE=disk\nID_VENDOR=VMware_\nID_VENDOR_ENC=VMware\\x2c\\x20\nMAJOR=8\nMINOR=16\nMPATH_SBIN_PATH=/sbin\nSCSI_MODEL=VMware_Virtual_S\nSCSI_MODEL_ENC=VMware\\x20Virtual\\x20S\nSCSI_REVISION=1.0\nSCSI_TPGS=0\nSCSI_TYPE=disk\nSCSI_VENDOR=VMware,\nSCSI_VENDOR_ENC=VMware,\\x20\nSUBSYSTEM=block\nTAGS=:systemd:\nUSEC_INITIALIZED=7881345425&quot;</span><br><span class="line">2024-01-24 07:10:49.213844 D | exec: Running command: lsblk --noheadings --path --list --output NAME /dev/sdb</span><br><span class="line"></span><br><span class="line">2024-01-24 07:10:49.328153 D | inventory: &amp;&#123;Name:sdb Parent: HasChildren:false DevLinks:/dev/disk/by-path/pci-0000:00:10.0-scsi-0:0:1:0 Size:10737418240 UUID:fa8cb5e3-f65c-4a9e-8324-c3ab4696d8e8 Serial: Type:disk Rotational:true Readonly:false Partitions:[] Filesystem:ceph_bluestore Mountpoint: Vendor:VMware_ Model:VMware_Virtual_S WWN: WWNVendorExtension: Empty:false CephVolumeData: RealPath:/dev/sdb KernelName:sdb Encrypted:false&#125;</span><br><span class="line">2024-01-24 07:10:49.328235 D | cephosd: &amp;&#123;Name:sdb Parent: HasChildren:false DevLinks:/dev/disk/by-path/pci-0000:00:10.0-scsi-0:0:1:0 Size:10737418240 UUID:fa8cb5e3-f65c-4a9e-8324-c3ab4696d8e8 Serial: Type:disk Rotational:true Readonly:false Partitions:[] Filesystem:ceph_bluestore Mountpoint: Vendor:VMware_ Model:VMware_Virtual_S WWN: WWNVendorExtension: Empty:false CephVolumeData: RealPath:/dev/sdb KernelName:sdb Encrypted:false&#125;</span><br><span class="line"></span><br><span class="line">// 将新磁盘以 osd 加入进来</span><br><span class="line">2024-01-24 07:10:53.357751 D | cephosd: &#123;</span><br><span class="line">    &quot;e4c5938e-0c71-4c89-bf03-c843aaeb042a&quot;: &#123;</span><br><span class="line">        &quot;ceph_fsid&quot;: &quot;33f01f1f-49f5-4a3e-9e4d-170a78a73862&quot;,</span><br><span class="line">        &quot;device&quot;: &quot;/dev/sdb&quot;,</span><br><span class="line">        &quot;osd_id&quot;: 1,</span><br><span class="line">        &quot;osd_uuid&quot;: &quot;e4c5938e-0c71-4c89-bf03-c843aaeb042a&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;bluestore&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">2024-01-24 07:10:53.357984 D | exec: Running command: lsblk /dev/sdb --bytes --nodeps --pairs --paths --output SIZE,ROTA,RO,TYPE,PKNAME,NAME,KNAME,MOUNTPOINT,FSTYPE</span><br><span class="line">2024-01-24 07:10:53.365269 D | sys: lsblk output: &quot;SIZE=\&quot;10737418240\&quot; ROTA=\&quot;1\&quot; RO=\&quot;0\&quot; TYPE=\&quot;disk\&quot; PKNAME=\&quot;\&quot; NAME=\&quot;/dev/sdb\&quot; KNAME=\&quot;/dev/sdb\&quot; MOUNTPOINT=\&quot;\&quot; FSTYPE=\&quot;ceph_bluestore\&quot;&quot;</span><br><span class="line">2024-01-24 07:10:53.365582 D | exec: Running command: sgdisk --print /dev/sdb</span><br><span class="line">2024-01-24 07:10:53.389306 I | cephosd: setting device class &quot;hdd&quot; for device &quot;/dev/sdb&quot;</span><br><span class="line">2024-01-24 07:10:53.389338 I | cephosd: 1 ceph-volume raw osd devices configured on this node</span><br><span class="line">2024-01-24 07:10:53.389378 I | cephosd: devices = [&#123;ID:1 Cluster:ceph UUID:e4c5938e-0c71-4c89-bf03-c843aaeb042a DevicePartUUID: DeviceClass:hdd BlockPath:/dev/sdb MetadataPath: WalPath: SkipLVRelease:true Location:root=default host=master LVBackedPV:false CVMode:raw Store:bluestore TopologyAffinity: Encrypted:false ExportService:false NodeName: PVCName:&#125;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create storage class，等待 pod 都正常运行，创建 sc</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n rook-ceph</span><br><span class="line">NAME                                            READY   STATUS      RESTARTS     AGE</span><br><span class="line">csi-cephfsplugin-d7928                          2/2     Running     0            46m</span><br><span class="line">csi-cephfsplugin-f2czr                          2/2     Running     0            46m</span><br><span class="line">csi-cephfsplugin-provisioner-865b98f797-b7qpz   5/5     Running     0            23m</span><br><span class="line">csi-cephfsplugin-provisioner-865b98f797-xc2sz   5/5     Running     0            23m</span><br><span class="line">csi-cephfsplugin-v7s6x                          2/2     Running     0            46m</span><br><span class="line">csi-rbdplugin-7djvh                             2/2     Running     0            47m</span><br><span class="line">csi-rbdplugin-chz4n                             2/2     Running     0            47m</span><br><span class="line">csi-rbdplugin-f82kv                             2/2     Running     0            47m</span><br><span class="line">csi-rbdplugin-provisioner-77dd8f7f94-ssnf6      5/5     Running     0            24m</span><br><span class="line">csi-rbdplugin-provisioner-77dd8f7f94-xcstd      5/5     Running     0            24m</span><br><span class="line">rook-ceph-exporter-master-5f769f57f5-q9t9c      1/1     Running     0            3h52m</span><br><span class="line">rook-ceph-exporter-slave01-f76cdfcf9-lrbfd      1/1     Running     0            59m</span><br><span class="line">rook-ceph-mgr-a-8555f84c85-qcpcr                1/1     Running     0            3h59m</span><br><span class="line">rook-ceph-mon-a-58bb889bb4-k9kx7                1/1     Running     3 (4h ago)   4h6m</span><br><span class="line">rook-ceph-operator-855ddbc95c-n7ms4             1/1     Running     0            61m</span><br><span class="line">rook-ceph-osd-0-56f5c5c759-r5cbq                1/1     Running     0            59m</span><br><span class="line">rook-ceph-osd-1-6c7559ff-x6s6h                  1/1     Running     0            25m</span><br><span class="line">rook-ceph-osd-prepare-master-r5srp              0/1     Completed   0            22m</span><br><span class="line">rook-ceph-osd-prepare-slave01-6fqxl             0/1     Completed   0            22m</span><br><span class="line">rook-ceph-osd-prepare-slave02-4zzx6             0/1     Completed   0            22m</span><br></pre></td></tr></table></figure>

<p>Wait for all pod to be running, and:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f csi/rbd/storageclass-test.yaml</span><br><span class="line"><span class="comment"># kubectl get storageclasses.storage.k8s.io rook-ceph-block -o yaml</span></span><br><span class="line">allowVolumeExpansion: <span class="literal">true</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2024-01-24T07:34:03Z&quot;</span></span><br><span class="line">  name: rook-ceph-block</span><br><span class="line">  resourceVersion: <span class="string">&quot;141236&quot;</span></span><br><span class="line">  uid: 82d0a1cc-570c-471d-bbca-d752d8f06de3</span><br><span class="line">parameters:</span><br><span class="line">  clusterID: rook-ceph</span><br><span class="line">  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner</span><br><span class="line">  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph</span><br><span class="line">  csi.storage.k8s.io/fstype: ext4</span><br><span class="line">  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node</span><br><span class="line">  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph</span><br><span class="line">  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner</span><br><span class="line">  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph</span><br><span class="line">  imageFeatures: layering</span><br><span class="line">  imageFormat: <span class="string">&quot;2&quot;</span></span><br><span class="line">  pool: replicapool</span><br><span class="line">provisioner: rook-ceph.rbd.csi.ceph.com</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>Check configuration，查看 cm 里面的配置</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap -n rook-ceph rook-ceph-operator-config -oyaml</span><br><span class="line"><span class="comment"># 打开 ROOK 的 CSI</span></span><br><span class="line">ROOK_CSI_ENABLE_RBD: <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>Check csidriver，查看 csidriver</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csidriver rook-ceph.rbd.csi.ceph.com</span><br><span class="line">NAME                         ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE</span><br><span class="line">rook-ceph.rbd.csi.ceph.com   <span class="literal">true</span>             <span class="literal">false</span>            <span class="literal">false</span>             &lt;<span class="built_in">unset</span>&gt;         <span class="literal">false</span>               Persistent   4h10m</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>Check csi plugin configuration，检查 cis 插件的配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="string">csi-rbdplugin-j4s6c</span> <span class="string">-n</span> <span class="string">rook-ceph</span> <span class="string">-oyaml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--nodeid=$(NODE_ID)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--endpoint=$(CSI_ENDPOINT)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--type=rbd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--nodeserver=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--drivername=rook-ceph.rbd.csi.ceph.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--pidlimit=-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ID</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CSI_ENDPOINT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">unix:///csi/csi.sock</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cephcsi/cephcsi:v3.10.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">csi-rbdplugin</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--csi-address=/csi/csi.sock</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-registration-path=/var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com/csi.sock</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBE_NODE_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">driver-registrar</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/csi</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">plugin-dir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/registration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">registration-dir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-7h6tz</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">plugin-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/lib/kubelet/plugins</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">plugin-mount-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/lib/kubelet/plugins_registry/</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">registration-dir</span></span><br></pre></td></tr></table></figure>

<p><code>plugin</code> 直接使用主机上的 <code>sock</code> 进行管理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span> /var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com/</span></span><br><span class="line">csi.sock</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>Create toolbox when required</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f toolbox.yaml</span><br></pre></td></tr></table></figure>

<p>可以启动一个操作 ceph 的 <code>toolbox</code> 容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it rook-ceph-tools-66b77b8df5-x4lbt bash</span></span><br><span class="line">bash-4.4$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     33f01f1f-49f5-4a3e-9e4d-170a78a73862</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"></span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum a (age 4h)</span><br><span class="line">    mgr: a(active, since 4h)</span><br><span class="line">    osd: 2 osds: 2 up (since 58m), 2 in (since 59m)</span><br><span class="line"></span><br><span class="line">  data:</span><br><span class="line">    pools:   2 pools, 64 pgs</span><br><span class="line">    objects: 18 objects, 3.9 MiB</span><br><span class="line">    usage:   54 MiB used, 20 GiB / 20 GiB avail</span><br><span class="line">    pgs:     64 active+clean</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool <span class="built_in">ls</span> detail</span></span><br><span class="line">pool 1 &#x27;.mgr&#x27; replicated size 1 min_size 1 crush_rule 1 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode on last_change 17 lfor 0/0/15 flags hashpspool stripe_width 0 application mgr read_balance_score 1.25</span><br><span class="line">pool 2 &#x27;replicapool&#x27; replicated size 1 min_size 1 crush_rule 3 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode on last_change 36 lfor 0/0/34 flags hashpspool,selfmanaged_snaps stripe_width 0 application rbd read_balance_score 1.06</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>Test networkstorage</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">rook-ceph-block</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Mi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">task-pv-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-pv-storage</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-pv-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;http-server&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/mnt/ceph&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">task-pv-storage</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pvc.yaml</span><br><span class="line">kubectl create -f pod.yaml</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>Enter pod and write some data</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubeclt exec -it task-pv-pod sh</span></span><br><span class="line"><span class="comment"># lsblk</span></span><br><span class="line">rbd0   252:0    0   100M  0 disk /mnt/ceph</span><br><span class="line"><span class="comment"># cd /mnt/ceph</span></span><br><span class="line"><span class="built_in">echo</span> hello world &gt; hello.log</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>Exit pod and delete the pod</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f pod.yaml</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>Recreate the pod and check <code>/mnt/ceph</code> again, and you will find the file is there</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pod.yaml</span><br><span class="line">kubeclt <span class="built_in">exec</span> -it task-pv-pod sh</span><br><span class="line"><span class="built_in">cd</span> /mnt/ceph</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">hello.log</span><br><span class="line"><span class="comment"># cat /mnt/ceph/hello.log</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<ol start="16">
<li>Expose dashboard，修改 <code>CephCluster</code> ，指定端口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl edit cephclusters.ceph.rook.io my-cluster</span></span><br><span class="line">  dashboard:</span><br><span class="line">    enabled: true</span><br><span class="line">    port: 8443</span><br><span class="line">    urlPrefix: /ceph-dashboard</span><br></pre></td></tr></table></figure>

<p>由于 <code>cephclusters</code> 会检测 <code>svc</code> 变化，因此直接修改 <code>svc</code> 会被修改回来，因此需要额外使用一个 <code>svc</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f dashboard-external-https.yaml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc rook-ceph-mgr-dashboard-external-https</span></span><br><span class="line">NAME                                     TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">rook-ceph-mgr-dashboard-external-https   NodePort   10.1.49.152   &lt;none&gt;        8443:31362/TCP   5m19s</span><br></pre></td></tr></table></figure>

<p>Login to the console with <code>admin/&lt;password&gt;</code>.</p>
<p>密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=&quot;&#123;[&#x27;data&#x27;][&#x27;password&#x27;]&#125;&quot; | base64 --decode &amp;&amp; echo</span><br></pre></td></tr></table></figure>

<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F17-48-30-image-20240124174830076.png" alt="image-20240124174830076"></p>
<p>使用账号密码登录</p>
<p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F17-49-51-image-20240124174951906.png" alt="image-20240124174951906"></p>
<ol start="17">
<li>Clean up</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> rook/cluster/examples/kubernetes/ceph</span><br><span class="line">kubectl delete -f csi/rbd/storageclass-test.yaml</span><br><span class="line">kubectl delete -f cluster-test.yaml</span><br><span class="line">kubectl delete -f crds.yaml -f common.yaml -f operator.yaml</span><br><span class="line">kubectl delete ns rook-ceph</span><br></pre></td></tr></table></figure>
<ol start="18">
<li>clean up</li>
</ol>
<p>编辑下面四个文件，将 <code>finalizer</code> 的值修改为 <code>null</code></p>
<p>例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ceph.rook.io/disaster-protection/</span></span><br></pre></td></tr></table></figure>
<p>修改为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">finalizers：null</span><br><span class="line"></span><br><span class="line">kubectl edit secret -n rook-ceph</span><br><span class="line">kubectl edit configmap -n rook-ceph</span><br><span class="line">kubectl edit cephclusters -n rook-ceph</span><br><span class="line">kubectl edit cephblockpools -n rook-ceph</span><br></pre></td></tr></table></figure>
<p>执行下面循环，直至找不到任何rook关联对象。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in `kubectl api-resources | grep true | awk &#x27;&#123;print \$1&#125;&#x27;`; do echo $i;kubectl get $i -n rook-ceph; done</span><br><span class="line"></span><br><span class="line">rm -rf /var/lib/rook</span><br></pre></td></tr></table></figure>

<h3 id="CSIDriver-发现"><a href="#CSIDriver-发现" class="headerlink" title="CSIDriver 发现"></a>CSIDriver 发现</h3><p>CSI 驱动发现：</p>
<p>如果一个 CSI 驱动创建 CSIDriver 对象，Kubernetes 用户可以通过 <code>get CSIDriver</code> 命令发现它们；</p>
<p>CSI 对象有如下特点：</p>
<ul>
<li>自定义的 Kubernetes 逻辑</li>
<li>Kubernetes 对存储卷有一系列操作，这些 <code>CSIDriver</code> 可以自定义支持哪些操作？</li>
</ul>
<h3 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a>Provisioner</h3><p><code>CSI external-provisioner</code> 是一个监控 Kubernetes <code>PVC</code> 对象的 <code>Sidecar</code> 容器。</p>
<p>当用户创建 <code>PVC</code> 后，Kubernetes 会监测 <code>PVC</code> 对应的 <code>StorageClass</code>，如果 <code>StorageClass</code> 中的 <code>provisioner</code> 与某插件匹配，该容器通过 <code>CSI Endpoint</code>（通常是 <code>unix socket</code>）调用 <code>CreateVolume</code> 方法。</p>
<p>如果 <code>CreateVolume</code> 方法调用成功，则 <code>Provisioner sidecar</code> 创建 Kubernetes <code>PV</code> 对象。</p>
<h3 id="CSI-External-Provisioner"><a href="#CSI-External-Provisioner" class="headerlink" title="CSI External Provisioner"></a>CSI External Provisioner</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于 cephfs 的 plugin</span></span><br><span class="line"><span class="comment"># kubectl get pod csi-cephfsplugin-provisioner-865b98f797-b7qpz -o yaml</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--csi-address=$(ADDRESS)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--timeout=2m30s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--retry-interval-start=500ms</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-election=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-election-namespace=rook-ceph</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-election-lease-duration=137s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-election-renew-deadline=107s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-election-retry-period=26s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--extra-create-metadata=true</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ADDRESS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">unix:///csi/csi-provisioner.sock</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/csi-provisioner:v3.6.2</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">csi-provisioner</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/csi</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">socket-dir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-52fmn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于 rbd 的plugin</span></span><br><span class="line"><span class="comment"># kubectl get pod csi-rbdplugin-7djvh -oyaml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--nodeid=$(NODE_ID)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--endpoint=$(CSI_ENDPOINT)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--type=rbd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--nodeserver=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--drivername=rook-ceph.rbd.csi.ceph.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--pidlimit=-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cephcsi/cephcsi:v3.10.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">csi-rbdplugin</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span></span><br><span class="line">      <span class="attr">medium:</span> <span class="string">Memory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">keys-tmp-dir</span></span><br></pre></td></tr></table></figure>

<h3 id="Provisioner-代码"><a href="#Provisioner-代码" class="headerlink" title="Provisioner 代码"></a>Provisioner 代码</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F09-59-16-image-20240124095916923.png" alt="image-20240124095916923"></p>
<h3 id="Provisioner-log"><a href="#Provisioner-log" class="headerlink" title="Provisioner log"></a>Provisioner log</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># kubectl logs -f csi-rbdplugin-provisioner-77dd8f7f94-ssnf6</span><br><span class="line">Defaulted container &quot;csi-provisioner&quot; out of: csi-provisioner, csi-resizer, csi-attacher, csi-snapshotter, csi-rbdplugin</span><br><span class="line">I0124 07:47:52.730654       1 csi-provisioner.go:154] Version: v3.6.2</span><br><span class="line">I0124 07:47:52.730808       1 csi-provisioner.go:177] Building kube configs for running in cluster...</span><br><span class="line">I0124 07:47:52.733073       1 common.go:138] Probing CSI driver for readiness</span><br><span class="line">I0124 07:47:52.739443       1 csi-provisioner.go:302] CSI driver does not support PUBLISH_UNPUBLISH_VOLUME, not watching VolumeAttachments</span><br><span class="line">I0124 07:47:52.742855       1 leaderelection.go:250] attempting to acquire leader lease rook-ceph/rook-ceph-rbd-csi-ceph-com...</span><br><span class="line">I0124 07:50:19.907224       1 leaderelection.go:260] successfully acquired lease rook-ceph/rook-ceph-rbd-csi-ceph-com</span><br><span class="line">I0124 07:50:20.008442       1 controller.go:811] Starting provisioner controller rook-ceph.rbd.csi.ceph.com_csi-rbdplugin-provisioner-77dd8f7f94-ssnf6_cf8d797f-0922-4cf8-99b8-2756dda3e9c7!</span><br><span class="line">I0124 07:50:20.008497       1 volume_store.go:97] Starting save volume queue</span><br><span class="line">I0124 07:50:20.008565       1 clone_controller.go:66] Starting CloningProtection controller</span><br><span class="line">I0124 07:50:20.008602       1 clone_controller.go:82] Started CloningProtection controller</span><br><span class="line">I0124 07:50:20.110170       1 controller.go:860] Started provisioner controller rook-ceph.rbd.csi.ceph.com_csi-rbdplugin-provisioner-77dd8f7f94-ssnf6_cf8d797f-0922-4cf8-99b8-2756dda3e9c7!</span><br><span class="line">I0124 07:50:20.110298       1 controller.go:1366] provision &quot;default/rook-ceph&quot; class &quot;rook-ceph-block&quot;: started</span><br><span class="line">I0124 07:50:20.110891       1 controller.go:1366] provision &quot;rook-ceph/rook-ceph&quot; class &quot;rook-ceph-block&quot;: started</span><br><span class="line">I0124 07:50:20.113057       1 event.go:298] Event(v1.ObjectReference&#123;Kind:&quot;PersistentVolumeClaim&quot;, Namespace:&quot;default&quot;, Name:&quot;rook-ceph&quot;, UID:&quot;88279eb9-64f5-4d4d-b127-85aeb9ab0469&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;142951&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;Provisioning&#x27; External provisioner is provisioning volume for claim &quot;default/rook-ceph&quot;</span><br><span class="line">I0124 07:50:20.113109       1 event.go:298] Event(v1.ObjectReference&#123;Kind:&quot;PersistentVolumeClaim&quot;, Namespace:&quot;rook-ceph&quot;, Name:&quot;rook-ceph&quot;, UID:&quot;ebca82a8-ad77-4da2-bcec-361eb16ecca2&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;142874&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;Provisioning&#x27; External provisioner is provisioning volume for claim &quot;rook-ceph/rook-ceph&quot;</span><br><span class="line">I0124 07:50:20.478765       1 controller.go:1449] provision &quot;rook-ceph/rook-ceph&quot; class &quot;rook-ceph-block&quot;: volume &quot;pvc-ebca82a8-ad77-4da2-bcec-361eb16ecca2&quot; provisioned</span><br><span class="line">I0124 07:50:20.478817       1 controller.go:1462] provision &quot;rook-ceph/rook-ceph&quot; class &quot;rook-ceph-block&quot;: succeeded</span><br><span class="line">I0124 07:50:20.478917       1 controller.go:1449] provision &quot;default/rook-ceph&quot; class &quot;rook-ceph-block&quot;: volume &quot;pvc-88279eb9-64f5-4d4d-b127-85aeb9ab0469&quot; provisioned</span><br><span class="line">I0124 07:50:20.478962       1 controller.go:1462] provision &quot;default/rook-ceph&quot; class &quot;rook-ceph-block&quot;: succeeded</span><br><span class="line">I0124 07:50:20.492398       1 event.go:298] Event(v1.ObjectReference&#123;Kind:&quot;PersistentVolumeClaim&quot;, Namespace:&quot;rook-ceph&quot;, Name:&quot;rook-ceph&quot;, UID:&quot;ebca82a8-ad77-4da2-bcec-361eb16ecca2&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;142874&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;ProvisioningSucceeded&#x27; Successfully provisioned volume pvc-ebca82a8-ad77-4da2-bcec-361eb16ecca2</span><br><span class="line">I0124 07:50:20.495824       1 event.go:298] Event(v1.ObjectReference&#123;Kind:&quot;PersistentVolumeClaim&quot;, Namespace:&quot;default&quot;, Name:&quot;rook-ceph&quot;, UID:&quot;88279eb9-64f5-4d4d-b127-85aeb9ab0469&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;142951&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;ProvisioningSucceeded&#x27; Successfully provisioned volume pvc-88279eb9-64f5-4d4d-b127-85aeb9ab0469</span><br></pre></td></tr></table></figure>

<h3 id="Rook-Agent"><a href="#Rook-Agent" class="headerlink" title="Rook Agent"></a>Rook Agent</h3><p><code>Rook Agent</code> 是以 <code>DaemonSet</code> 形式部署在所有的存储机上的，其处理所有的存储操作，例如挂卸载存储卷以及格式化文件系统等。</p>
<h3 id="CSI-插件注册"><a href="#CSI-插件注册" class="headerlink" title="CSI 插件注册"></a>CSI 插件注册</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get DaemonSet csi-rbdplugin -o yaml</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span>		<span class="comment"># 直接使用主机信息</span></span><br><span class="line">  <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--csi-address=/csi/csi.sock</span>		<span class="comment"># 使用 sock 通信</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-registration-path=/var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com/csi.sock</span> <span class="comment"># 使用 sock</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBE_NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.9.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">driver-registrar</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span>		<span class="comment"># 权限管理</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/csi</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">plugin-dir</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/registration</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">registration-dir</span></span><br></pre></td></tr></table></figure>

<h3 id="CSI-Driver"><a href="#CSI-Driver" class="headerlink" title="CSI Driver"></a>CSI Driver</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get csidrivers.storage.k8s.io rook-ceph.rbd.csi.ceph.com -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CSIDriver</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-24T03:24:00Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rook-ceph.rbd.csi.ceph.com</span>		<span class="comment"># 驱动名称</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;27345&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">88fb566c-aef7-482d-9b94-8e2d4ed35ebb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">attachRequired:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">fsGroupPolicy:</span> <span class="string">File</span></span><br><span class="line">  <span class="attr">podInfoOnMount:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">requiresRepublish:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">seLinuxMount:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">storageCapacity:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumeLifecycleModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Persistent</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span> /var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com/csi.sock</span></span><br><span class="line">/var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com/csi.sock</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--nodeid=$(NODE_ID)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--endpoint=$(CSI_ENDPOINT)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--v=0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--type=rbd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--nodeserver=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--drivername=rook-ceph.rbd.csi.ceph.com</span> <span class="comment"># 指定驱动名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--pidlimit=-1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ID</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CSI_ENDPOINT</span>			<span class="comment"># 使用 sock 交互</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">unix:///csi/csi.sock</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.io/cephcsi/cephcsi:v3.10.1</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-rbdplugin</span></span><br><span class="line">  <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span>	<span class="comment"># 打开权限</span></span><br><span class="line">    <span class="attr">capabilities:</span></span><br><span class="line">      <span class="attr">add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SYS_ADMIN</span>	<span class="comment"># 拥有admin 权限</span></span><br><span class="line">      <span class="attr">drop:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">  <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">  <span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/csi</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">plugin-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/pods</span></span><br><span class="line">    <span class="attr">mountPropagation:</span> <span class="string">Bidirectional</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pods-mount-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/plugins</span></span><br><span class="line">    <span class="attr">mountPropagation:</span> <span class="string">Bidirectional</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">plugin-mount-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/dev</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">host-dev</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/sys</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/lib/modules</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">lib-modules</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ceph-csi-config/</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ceph-csi-configs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/csi/keys</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">keys-tmp-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/run/mount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">host-run-mount</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/run/secrets/tokens</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">oidc-token</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-api-access-xfxxn</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/kubelet/plugins/rook-ceph.rbd.csi.ceph.com</span>	<span class="comment"># 映射本机目录，与 sock 交互</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">plugin-dir</span></span><br></pre></td></tr></table></figure>

<h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><p><img data-src="https://image-hosting-xiaoyeshiyu-shanghai.oss-cn-shanghai.aliyuncs.com/img/PicGo%2F2024%2F01%2F24%2F10-01-59-image-20240124100159621.png" alt="image-20240124100159621"></p>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p>针对不同 <code>ceph cluster</code>，<code>rook</code> 启动一组管理组件，包括：</p>
<p><code>mon</code>，<code>mgr</code>，<code>osd</code>，<code>mds</code>，<code>rgw</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get cephclusters.ceph.rook.io my-cluster -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-24T03:23:04Z&quot;</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cephcluster.ceph.rook.io</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;171057&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">181ecde7-91d5-4364-9544-27cdd5ea1a0d</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">cephConfig:</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">bdev_flock_retry:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">      <span class="attr">bluefs_buffered_io:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">mon_data_avail_warn:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">      <span class="attr">mon_warn_on_pool_no_redundancy:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">osd_pool_default_size:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">cephVersion:</span></span><br><span class="line">    <span class="attr">allowUnsupported:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/ceph/ceph:v18</span></span><br><span class="line">  <span class="attr">cleanupPolicy:</span></span><br><span class="line">    <span class="attr">sanitizeDisks:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">crashCollector:</span></span><br><span class="line">    <span class="attr">disable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">csi:</span></span><br><span class="line">    <span class="attr">cephfs:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">readAffinity:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">urlPrefix:</span> <span class="string">/ceph-dashboard</span></span><br><span class="line">  <span class="attr">dataDirHostPath:</span> <span class="string">/var/lib/rook</span></span><br><span class="line">  <span class="attr">disruptionManagement:</span></span><br><span class="line">    <span class="attr">managePodBudgets:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">external:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">healthCheck:</span></span><br><span class="line">    <span class="attr">daemonHealth:</span></span><br><span class="line">      <span class="attr">mon:</span></span><br><span class="line">        <span class="attr">interval:</span> <span class="string">45s</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">600s</span></span><br><span class="line">      <span class="attr">osd:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">status:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">logCollector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">mgr:</span></span><br><span class="line">    <span class="attr">allowMultiplePerNode:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">mon:</span></span><br><span class="line">    <span class="attr">allowMultiplePerNode:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">monitoring:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">multiClusterService:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">priorityClassNames:</span></span><br><span class="line">    <span class="attr">all:</span> <span class="string">system-node-critical</span></span><br><span class="line">    <span class="attr">mgr:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">keyRotation:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kms:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">flappingRestartIntervalHours:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">store:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">useAllDevices:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">useAllNodes:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h3><p>一个 <code>ceph cluster</code> 可以有多个 <code>pool</code>，定义副本数量，故障域等多个属性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get cephblockpool replicapool -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephBlockPool</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-24T07:34:03Z&quot;</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cephblockpool.ceph.rook.io</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">replicapool</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;151545&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">eb189b2d-d3b6-4c39-a21b-e894d6e91249</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">erasureCoded:</span></span><br><span class="line">    <span class="attr">codingChunks:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">dataChunks:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">failureDomain:</span> <span class="string">osd</span></span><br><span class="line">  <span class="attr">mirroring:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">quotas:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">replicated:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">1</span>		<span class="comment"># 副本数</span></span><br><span class="line">  <span class="attr">statusCheck:</span></span><br><span class="line">    <span class="attr">mirror:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Ready</span></span><br></pre></td></tr></table></figure>

<h3 id="Storage-Class"><a href="#Storage-Class" class="headerlink" title="Storage Class"></a>Storage Class</h3><p><code>StorageClass</code> 是 Kubernetes 用来自动创建 PV 的对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get storageclasses.storage.k8s.io rook-ceph-block -o yaml</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2024-01-24T07:34:03Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rook-ceph-block</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;141236&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">82d0a1cc-570c-471d-bbca-d752d8f06de3</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">clusterID:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-name:</span> <span class="string">rook-csi-rbd-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/fstype:</span> <span class="string">ext4</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-name:</span> <span class="string">rook-csi-rbd-node</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-name:</span> <span class="string">rook-csi-rbd-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">imageFeatures:</span> <span class="string">layering</span></span><br><span class="line">  <span class="attr">imageFormat:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">replicapool</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">rook-ceph.rbd.csi.ceph.com</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">Immediate</span></span><br></pre></td></tr></table></figure>

<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><span class="exturl" data-url="aHR0cHM6Ly9kcmFtYXNhbXkubWVkaXVtLmNvbS9saWZlLW9mLWEtcGFja2V0LWluLWt1YmVybmV0ZXMtcGFydC0xLWY5YmMwOTA5ZTA1MQ==">Life of a Packet in Kubernetes — Part 1<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kcmFtYXNhbXkubWVkaXVtLmNvbS9saWZlLW9mLWEtcGFja2V0LWluLWt1YmVybmV0ZXMtcGFydC0yLWEwN2Y1YmYwZmYxNA==">Life of a Packet in Kubernetes — Part 2<i class="fa fa-external-link-alt"></i></span></p>
<p>扩展：<span class="exturl" data-url="aHR0cHM6Ly9kcmFtYXNhbXkubWVkaXVtLmNvbS9saWZlLW9mLWEtcGFja2V0LWluLWt1YmVybmV0ZXMtcGFydC0zLWRkODgxNDc2ZGEwZg==">Life of a Packet in Kubernetes — Part 3<i class="fa fa-external-link-alt"></i></span></p>
<p>扩展：<span class="exturl" data-url="aHR0cHM6Ly9kcmFtYXNhbXkubWVkaXVtLmNvbS9saWZlLW9mLWEtcGFja2V0LWluLWt1YmVybmV0ZXMtcGFydC00LTRkYmM1MjU2MDUwYQ==">Life of a Packet in Kubernetes — Part 4<i class="fa fa-external-link-alt"></i></span></p>
<p>扩展：<span class="exturl" data-url="aHR0cHM6Ly9kcmFtYXNhbXkubWVkaXVtLmNvbS9saWZlLW9mLWEtcGFja2V0LWluLWlzdGlvLXBhcnQtMS04MjIxOTcxZDc3ZGU=">Life of a Packet in ISTIO — Part 1<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reference/" rel="tag"># 学习笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/bad7.html" rel="prev" title="Kubernetes 控制平面组件：API Server">
                  <i class="fa fa-angle-left"></i> Kubernetes 控制平面组件：API Server
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/f2e1.html" rel="next" title="Kubernetes 控制平面组件：生命周期管理和服务发现">
                  Kubernetes 控制平面组件：生命周期管理和服务发现 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
  </div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hpYW95ZXNoaXl1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.xiaoyeshiyu.com/post/ea1d.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
