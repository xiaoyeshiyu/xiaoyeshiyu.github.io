<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是学习MySQL的笔记高级使用篇，主要是视图、存储、函数、变量、流程和触发器等。">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL学习笔记高级使用篇">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/2022/11/08/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="这是学习MySQL的笔记高级使用篇，主要是视图、存储、函数、变量、流程和触发器等。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221110163846331.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221111204155284.png">
<meta property="article:published_time" content="2022-11-07T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-01T07:49:49.110Z">
<meta property="article:author" content="Mitaka xu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221110163846331.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/2022/11/08/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/2022/11/08/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87/","path":"2022/11/08/MySQL学习笔记高级使用篇/","title":"MySQL学习笔记高级使用篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL学习笔记高级使用篇 | Hexo</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.</span> <span class="nav-text">数据库对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE"><span class="nav-number">2.</span> <span class="nav-text">视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9A%E4%B9%89"><span class="nav-number">2.1.</span> <span class="nav-text">基本定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="nav-number">2.2.</span> <span class="nav-text">创建视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE"><span class="nav-number">2.3.</span> <span class="nav-text">查看视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">2.4.</span> <span class="nav-text">更新视图中的数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E3%80%81%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE"><span class="nav-number">2.5.</span> <span class="nav-text">删除、修改视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.6.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%87%BD%E6%95%B0"><span class="nav-number">3.</span> <span class="nav-text">存储过程与函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">3.1.1.</span> <span class="nav-text">创建和使用存储过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-number">3.2.</span> <span class="nav-text">存储函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94"><span class="nav-number">3.3.</span> <span class="nav-text">对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%87%BD%E6%95%B0%E7%9A%84%E6%9F%A5%E7%9C%8B%E3%80%81%E4%BF%AE%E6%94%B9%E3%80%81%E5%88%A0%E9%99%A4"><span class="nav-number">3.4.</span> <span class="nav-text">存储过程和函数的查看、修改、删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E3%80%81%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87"><span class="nav-number">4.</span> <span class="nav-text">变量、流程控制与游标</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">4.1.</span> <span class="nav-text">系统变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">4.1.1.</span> <span class="nav-text">查看系统变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">4.1.2.</span> <span class="nav-text">修改系统变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="nav-number">4.2.</span> <span class="nav-text">用户变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">4.2.1.</span> <span class="nav-text">定义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6%E4%B8%8E%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.3.</span> <span class="nav-text">定义条件与处理程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="nav-number">4.4.</span> <span class="nav-text">流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IF"><span class="nav-number">4.4.1.</span> <span class="nav-text">IF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CASE"><span class="nav-number">4.4.2.</span> <span class="nav-text">CASE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LOOP"><span class="nav-number">4.4.3.</span> <span class="nav-text">LOOP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WHILE"><span class="nav-number">4.4.4.</span> <span class="nav-text">WHILE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REPEAT"><span class="nav-number">4.4.5.</span> <span class="nav-text">REPEAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LEAVE%E5%92%8CITERATE"><span class="nav-number">4.4.6.</span> <span class="nav-text">LEAVE和ITERATE</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%B8%E6%A0%87"><span class="nav-number">4.5.</span> <span class="nav-text">游标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-8-0%E7%89%B9%E6%80%A7"><span class="nav-number">4.6.</span> <span class="nav-text">MySQL 8.0特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">5.</span> <span class="nav-text">触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">5.1.</span> <span class="nav-text">创建触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">5.2.</span> <span class="nav-text">查看、删除触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%92%8C%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">5.3.</span> <span class="nav-text">优缺点和注意点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">5.3.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">5.3.2.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">5.3.3.</span> <span class="nav-text">注意点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%8F%B7%E5%87%BD%E6%95%B0"><span class="nav-number">6.1.</span> <span class="nav-text">序号函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%87%BD%E6%95%B0"><span class="nav-number">6.2.</span> <span class="nav-text">分布函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%90%8E%E5%87%BD%E6%95%B0"><span class="nav-number">6.3.</span> <span class="nav-text">前后函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A6%96%E4%BD%8D%E5%87%BD%E6%95%B0"><span class="nav-number">6.4.</span> <span class="nav-text">首位函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="nav-number">6.5.</span> <span class="nav-text">其他函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">6.6.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AC%E7%94%A8%E8%A1%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.</span> <span class="nav-text">公用表表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%85%AC%E7%94%A8%E8%A1%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.1.</span> <span class="nav-text">普通公用表表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%BD%92%E5%85%AC%E7%94%A8%E8%A1%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">递归公用表表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">7.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">8.</span> <span class="nav-text">字符集的相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="nav-number">8.1.</span> <span class="nav-text">修改字符集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E7%BA%A7%E5%88%AB%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="nav-number">8.2.</span> <span class="nav-text">各级别字符集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E8%BE%83%E8%A7%84%E5%88%99"><span class="nav-number">8.3.</span> <span class="nav-text">比较规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%88%B0%E5%93%8D%E5%BA%94%E8%BF%87%E7%A8%8B%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-number">8.4.</span> <span class="nav-text">请求到响应过程字符集的变化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL-%E5%A4%A7%E5%B0%8F%E5%86%99%E8%A7%84%E8%8C%83"><span class="nav-number">9.</span> <span class="nav-text">SQL 大小写规范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sql-model"><span class="nav-number">10.</span> <span class="nav-text">sql_model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95"><span class="nav-number">11.</span> <span class="nav-text">MySQL的数据目录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95"><span class="nav-number">11.1.</span> <span class="nav-text">物理存储目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">11.2.</span> <span class="nav-text">数据库和文件系统的管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="nav-number">11.3.</span> <span class="nav-text">数据库在文件系统中的表示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="nav-number">11.4.</span> <span class="nav-text">配置文件目录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90"><span class="nav-number">12.</span> <span class="nav-text">用户与权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E5%BD%95"><span class="nav-number">12.1.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E5%AF%86%E7%A0%81%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">12.2.</span> <span class="nav-text">用户和密码的管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90"><span class="nav-number">12.3.</span> <span class="nav-text">权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E8%A1%A8"><span class="nav-number">12.4.</span> <span class="nav-text">权限表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%92%E8%89%B2"><span class="nav-number">13.</span> <span class="nav-text">角色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E8%A7%92%E8%89%B2"><span class="nav-number">13.1.</span> <span class="nav-text">管理角色</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">保持积累，保持学习。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaoyeshiyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/2022/11/08/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="保持积累，保持学习。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL学习笔记高级使用篇 | Hexo">
      <meta itemprop="description" content="这是学习MySQL的笔记高级使用篇，主要是视图、存储、函数、变量、流程和触发器等。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL学习笔记高级使用篇<a href="https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/_posts/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87.md" class="post-edit-link" title="Edit this post" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 00:00:00" itemprop="dateCreated datePublished" datetime="2022-11-08T00:00:00+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-01 15:49:49" itemprop="dateModified" datetime="2023-03-01T15:49:49+08:00">2023-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/" itemprop="url" rel="index"><span itemprop="name">databse</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/develope/" itemprop="url" rel="index"><span itemprop="name">develope</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/develope/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
    <span id="/2022/11/08/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%AF%87/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL学习笔记高级使用篇" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">这是学习MySQL的笔记高级使用篇，主要是视图、存储、函数、变量、流程和触发器等。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="数据库对象"><a href="#数据库对象" class="headerlink" title="数据库对象"></a>数据库对象</h2><p>常见的数据库对象</p>
<table>
<thead>
<tr>
<th>对象</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>表 <code>TABLE</code></td>
<td>数据库里最基础的存储单元，表里的数据由行和列组织排列的。</td>
</tr>
<tr>
<td>数据字典</td>
<td>就是系统表，存放数据库相关信息的表，系统表的数据通常由数据库系统维护，程序员通常不应该修改，只可查看。MySQL 8新增。</td>
</tr>
<tr>
<td>约束 <code>CONSTRAINT</code></td>
<td>执行数据校验规则，用于保证数据完整性的规则</td>
</tr>
<tr>
<td>视图 <code>VIEW</code></td>
<td>一个或多个数据表里的数据的逻辑显示，视图并不存储数据。视图是一个虚拟的表，其内容由查询定义。 同真实的表一样，视图包含一系列带有名称的列和行数据。但是，视图并不在数据库中以存储的数据值集合的形式存在。行和列数据来自由定义视图的查询所引用的表，并且在引用视图时动态生成。</td>
</tr>
<tr>
<td>索引 <code>INDEX</code></td>
<td>索引是对数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的指定信息。 例如，想按指定职员的姓来查找他或她，则与在表中搜索所有的行相比，索引有助于更快地获取信息。</td>
</tr>
<tr>
<td>存储过程 <code>PROCEDIRE</code></td>
<td>用于完成一次完整的业务处理，没有返回值，但可通过传出参数将多个值传给调用环境</td>
</tr>
<tr>
<td>存储函数 <code>FUNCTION</code></td>
<td>用于完成一次特定的计算，具有一个返回值</td>
</tr>
<tr>
<td>触发器 <code>TRIGGER</code></td>
<td>相当于一个事件监听器，当数据库发生特定事件后，触发器被触发，完成相应的处理</td>
</tr>
</tbody></table>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ol>
<li>视图隐藏了底层的表结构，简化了数据访问操作，客户端不再需要知道底层表的结构及其之间的关系。</li>
<li>视图提供了一个统一访问数据的接口。（即可以允许用户通过视图访问数据的安全机制，而不授予用户直接访问底层表的权限）</li>
<li>从而加强了安全性，使用户只能看到视图所显示的数据。</li>
<li>视图还可以被嵌套，一个视图中可以嵌套另一个视图。</li>
</ol>
<h3 id="基本定义"><a href="#基本定义" class="headerlink" title="基本定义"></a>基本定义</h3><ul>
<li><p>视图是一种虚拟表，本身不具有数据，占用很少的内存空间，是SQL中的一个重要概念。</p>
</li>
<li><p>视图建立在已有表的基础上，视图依赖建立的这些表称为基表。</p>
</li>
<li><p>视图的创建和删除只影响视图本身，不影响对应的基表。当对视图中的数据进行增加、删除和修改操作时，数据表中的数据会相应地发生变化，反之亦然</p>
</li>
<li><p>向视图提供数据内容的语句为SELECT语句，可以将视图理解为存储起来的SELECT语句</p>
</li>
<li><p>视图是向用户提供基表数据的另一种表现形式。在大型项目中以及数据表比较复杂的情况下，视图的价值就凸显出来了。</p>
</li>
</ul>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>在<code>create view</code>语句中嵌套子查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> department;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建视图</span></span><br><span class="line"><span class="comment">-- 针对单表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id,fname <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="comment">-- 字段的别名会作为视图中的别名出现</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp2 <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id `id`,fname `name` <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="comment">-- 别名的第二种方式，定义的名称与SELECT的名称需要一一对应</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp3(id,`name`) <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id ,fname <span class="keyword">FROM</span> employee;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用视图</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp6;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询在表中不存在的字段</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp6 <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(start_date),dept_id <span class="keyword">FROM</span> employee <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 针对多表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp_dept1 <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> employee.emp_id,employee.fname,department.name <span class="keyword">FROM</span> employee <span class="keyword">JOIN</span> department <span class="keyword">ON</span> employee.dept_id <span class="operator">=</span> department.dept_id;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_dept1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> emp_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 利用视图对数据进行格式化</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp_dept2 <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> employee.emp_id,CONCAT(employee.fname,<span class="string">&#x27; &#x27;</span>,employee.lname,<span class="string">&#x27; =》 &#x27;</span>,department.`name`) emp_info <span class="keyword">FROM</span> employee <span class="keyword">JOIN</span> department <span class="keyword">ON</span> employee.dept_id <span class="operator">=</span> department.dept_id;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_dept2;</span><br><span class="line"><span class="keyword">DESC</span> vu_emp_dept2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 基于视图创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp7 <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id,fname,dept_id <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp8 <span class="keyword">AS</span> <span class="keyword">SELECT</span> fname,dept_id <span class="keyword">FROM</span> vu_emp7;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp8;</span><br></pre></td></tr></table></figure>

<h3 id="查看视图"><a href="#查看视图" class="headerlink" title="查看视图"></a>查看视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看数据库的表对象、视图对象</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="comment">-- 查看视图结构</span></span><br><span class="line"><span class="keyword">DESC</span> vu_emp1;</span><br><span class="line"><span class="comment">-- 查看视图的属性信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;vu_emp1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看视图详细定义信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp1;</span><br></pre></td></tr></table></figure>

<h3 id="更新视图中的数据"><a href="#更新视图中的数据" class="headerlink" title="更新视图中的数据"></a>更新视图中的数据</h3><p>更新视图中的数据要更新成功，需要保证更新的数据要有表中的数据一一对应。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更新视图中的字段，会导致表中的数据更改</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp7;</span><br><span class="line"><span class="keyword">UPDATE</span> vu_emp7 <span class="keyword">SET</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp7;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="comment">-- 更新表中的数据，会导致视图中的数据更改</span></span><br><span class="line"><span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp7;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除视图中的数据，会导致表中的数据删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> vu_emp7 <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">18</span>;</span><br><span class="line"><span class="comment">-- 删除表中的数据也会导致视图中的数据删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新视图中的数据</span></span><br><span class="line"><span class="comment">-- 一般情况下，视图中的数据可以更新，视图中数据更新会导致表中数据也更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> vu_emp7 <span class="keyword">SET</span> dept_id <span class="operator">=</span> <span class="number">3</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 有时候不能更新视图中的数据，例如表中没有对应字段，例如最大值</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp9 <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="built_in">max</span>(start_date) max_date,dept_id <span class="keyword">FROM</span> employee <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp9;</span><br><span class="line"><span class="comment">-- The target table vu_emp9 of the UPDATE is not updatable</span></span><br><span class="line"><span class="keyword">UPDATE</span> vu_emp9 <span class="keyword">SET</span> max_date <span class="operator">=</span> <span class="number">2000</span><span class="number">-01</span><span class="number">-01</span> <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 删除同样不行 The target table vu_emp9 of the DELETE is not updatable</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> vu_emp9 <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>虽然可以更新视图数据，但是总得来说，视图作为虚拟表，是方便查询，不建议更新视图的数据。对视图数据的更改，都是通过对实际数据表里数据的操作来完成的。</p>
</blockquote>
<h3 id="删除、修改视图"><a href="#删除、修改视图" class="headerlink" title="删除、修改视图"></a>删除、修改视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改、删除视图</span></span><br><span class="line"><span class="keyword">DESC</span> vu_emp1;</span><br><span class="line"><span class="comment">-- 方式1，重新创建</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> vu_emp1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id,lname <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> start_date <span class="operator">&gt;</span> <span class="string">&#x27;2002-01-01&#x27;</span>;</span><br><span class="line"><span class="comment">-- 方式2，更新</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> vu_emp1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> emp_id,lname <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> start_date <span class="operator">&gt;</span> <span class="string">&#x27;2002-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="comment">-- 删除视图</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> vu_emp9;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> IF <span class="keyword">EXISTS</span> vu_emp8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当表删除，视图查询会报错</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mitaka_test1;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_mita1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> id,last_name <span class="keyword">FROM</span> mitaka_test1;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_mita1;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> mitaka_test1;</span><br><span class="line"><span class="comment">-- View &#x27;mitaka.vu_mita1&#x27; references invalid table(s) or column(s) or function(s) or definer/invoker of view lack rights to use them</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_mita1;</span><br></pre></td></tr></table></figure>

<p>当基于视图a、视图b创建新的视图c，如果视图a后者视图b删除，会导致视图c的查询失败，这样的视图c需要手动删除或者修改，否则会影响使用。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>优势：</p>
<ol>
<li>操作简单：不需要理解表和表之间的关系，操作视图即可</li>
<li>减少数据冗余：视图本身不占用存储资源</li>
<li>数据安全：可通过管理权限实现对数据的保护，实现隔离性</li>
<li>适应灵活多变的需求：不用修改数据库字段，通过更新视图即可完成</li>
<li>能够分解复杂的查询逻辑：创建多个视图获取数据，再将多个视图结合起来，完成复杂的查询逻辑</li>
</ol>
<p>不足：</p>
<ol>
<li>如果实际数据表的结构变更，就需要及时对相关的视图进行相应的维护</li>
<li>如果视图过多，会导致数据库维护成本的问题</li>
</ol>
<h2 id="存储过程与函数"><a href="#存储过程与函数" class="headerlink" title="存储过程与函数"></a>存储过程与函数</h2><h3 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h3><p><code>Stored Procedure</code>，一组经过预先编译的SQL语句的封装。</p>
<p>执行过程：存储过程预先存储在MySQL服务器上，需要执行的时候，客户端只需要向服务器端发出调用存储过程的命令，服务器端就可以把预先存储好的这一系列SQL语句全部执行。</p>
<p>好处：</p>
<ol>
<li>简化操作，体现于sql语句的重用性，一次编译多次使用</li>
<li>减少操作过程中的失误，提高效率</li>
<li>减少网络传输量</li>
<li>减少SQL语句暴露在网上的风险，也提高了数据查询的安全性</li>
</ol>
<p>缺点：</p>
<blockquote>
<p>阿里开发规范：【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有一致性。</p>
</blockquote>
<ol>
<li>可移植性差，不同的数据库支持粒度不一样</li>
<li>调试过程困难，当函数非常复杂，开发维护都不容易</li>
<li>存储过程的版本管理很困难，例如当索引发生变化，可能导致存储过程失效</li>
<li>不适合高并发，高并发通常会采用分库分表，对扩展性要求很高，这种情况下存储过程很难维护，增加数据库压力，显然不适用。</li>
</ol>
<p>一旦存储过程被创建出来，使用就像使用函数一样简单，可以直接通过调用存储过程名即可。相较于函数，存储过程<strong>没有返回值</strong>。</p>
<p>存储过程的参数类型可以是IN、OUT和INOUT分类：(这里的返回是指函数的<code>return</code>，不代表执行存储过程的返回。)</p>
<ol>
<li>没有参数（无参数无返回）</li>
<li>仅仅带IN类型（有参数无返回）</li>
<li>仅仅带OUT类型（无参数有返回）</li>
<li>既带IN又带OUT类型（有参数有返回）</li>
<li>带INOUT（有参数有返回）</li>
</ol>
<p>IN、OUT、INOUT都可以在一个存储过程中带多个。</p>
<h4 id="创建和使用存储过程"><a href="#创建和使用存储过程" class="headerlink" title="创建和使用存储过程"></a>创建和使用存储过程</h4><p>无参数无返回</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建存储过程</span></span><br><span class="line"><span class="comment">-- 无参数无返回值</span></span><br><span class="line"><span class="comment">-- 将结束符改为 $</span></span><br><span class="line">delimiter $</span><br><span class="line"><span class="comment">-- 创建存储过程  存储过程名称 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> select_all_data() </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">END</span>$</span><br><span class="line"><span class="comment">-- 将结束符改回;</span></span><br><span class="line">delimiter;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> select_all_data();</span><br></pre></td></tr></table></figure>

<p>无参数有返回</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 无参数有返回值</span></span><br><span class="line">delimiter $</span><br><span class="line"><span class="comment">-- 输出参数 max_start_date 类型是date</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> select_max_start_date(<span class="keyword">OUT</span> max_start_date <span class="type">DATE</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 将查询到的结果定义到max_start_date</span></span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(start_date) <span class="keyword">INTO</span> max_start_date <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">delimiter;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="comment">-- 传入一个变量，用于接收函数的返回</span></span><br><span class="line"><span class="keyword">CALL</span> select_max_start_date(<span class="variable">@start</span>_date);</span><br><span class="line"><span class="comment">-- 查看变量值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@start</span>_date;</span><br></pre></td></tr></table></figure>

<p>有参数没有返回值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 有参数没有返回</span></span><br><span class="line">delimiter $</span><br><span class="line"><span class="comment">-- 输入参数 emp_id_in 类型是SMALLINT</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_someone_start_date(<span class="keyword">IN</span> emp_id_in <span class="type">SMALLINT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 使用的条件是emp_id_in，入参名称需要注意，不能与表字段一致，不然会检索到所有数据，类似于1=1</span></span><br><span class="line">	<span class="keyword">SELECT</span> start_date <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> emp_id_in;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">delimiter;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> show_someone_start_date(<span class="number">1</span>);</span><br><span class="line"><span class="comment">-- 或者使用变量</span></span><br><span class="line"><span class="comment">-- @代表用户定义变量，@@代表系统变量</span></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@emp</span>_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">CALL</span> show_someone_start_date(<span class="variable">@emp</span>_id);</span><br></pre></td></tr></table></figure>

<p>有输入有输出</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 有输入和输出</span></span><br><span class="line">delimiter $</span><br><span class="line"><span class="comment">-- 输入参数 emp_id_in 类型是SMALLINT，输出参数是emp_end_date_out类型是DATE</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_someone_end_date(<span class="keyword">IN</span> emp_id_in <span class="type">SMALLINT</span>,<span class="keyword">OUT</span> emp_end_date_out <span class="type">DATE</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> end_date <span class="keyword">INTO</span> emp_end_date_out <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> emp_id_in;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">delimiter;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> show_someone_end_date(<span class="number">1</span>,<span class="variable">@emp</span>_end_date_out);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@emp</span>_end_date_out;</span><br></pre></td></tr></table></figure>

<p>有输入有输出的INOUT</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 带INOUT</span></span><br><span class="line"><span class="comment">-- 获取某个员工的管理员名称</span></span><br><span class="line">delimiter $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_mgr_name(<span class="keyword">INOUT</span> empname <span class="type">VARCHAR</span>(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> fname <span class="keyword">INTO</span> empname <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> (<span class="keyword">SELECT</span> superior_emp_id <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> fname <span class="operator">=</span> empname);</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 执行</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@empname</span> <span class="operator">=</span> <span class="string">&#x27;Jane&#x27;</span>;</span><br><span class="line"><span class="keyword">CALL</span> show_mgr_name(<span class="variable">@empname</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@empname</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果使用navicat，会自动设置<code>delimiter</code>为其他符号，可以不需要进行<code>delimiter</code>操作。</p>
</blockquote>
<h3 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h3><p>存储函数指的是用户自定义的函数。</p>
<p>函数一定有返回值。函数只有IN类型，也就是只需要填入入参。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> employee;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建存储函数</span></span><br><span class="line"><span class="comment">-- 使用navicat，可以不使用 delimiter</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> title_by_name()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line"><span class="comment">-- 必须要加上特性</span></span><br><span class="line">	<span class="keyword">DETERMINISTIC</span>	<span class="comment">-- 确定性</span></span><br><span class="line">	<span class="keyword">CONTAINS</span> <span class="keyword">SQL</span> <span class="comment">-- 包含sql语句</span></span><br><span class="line">	<span class="keyword">READS</span> <span class="keyword">SQL</span> DATA <span class="comment">-- 读取sql数据</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> title <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> fname <span class="operator">=</span> <span class="string">&#x27;Robert&#x27;</span>) ;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 加上特性的第二种方式，全局加</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_bin_trust_function_creators <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 再创建存储函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> title_by_name1()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> title <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> fname <span class="operator">=</span> <span class="string">&#x27;Robert&#x27;</span>) ;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">SELECT</span> title_by_name1();</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_bin_trust_function_creators <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 有参数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> title_by_id(in_emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> title <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> in_emp_id) ;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">SELECT</span> title_by_id(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 传入多个参数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> count_by_id(in_dept_id <span class="type">INT</span>,in_assigned_branch_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">INT</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> in_dept_id <span class="keyword">AND</span> assigned_branch_id <span class="operator">=</span> in_assigned_branch_id);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="keyword">SELECT</span> count_by_id(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除存储函数</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> title_by_name1;</span><br></pre></td></tr></table></figure>

<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><table>
<thead>
<tr>
<th></th>
<th>存储过程</th>
<th>存储函数</th>
</tr>
</thead>
<tbody><tr>
<td>关键字</td>
<td>PROCEDURE</td>
<td>FUNCTION</td>
</tr>
<tr>
<td>调用语法</td>
<td><code>CALL 存储过程()</code></td>
<td><code>SELECT 存储函数()</code></td>
</tr>
<tr>
<td>返回值</td>
<td>理解为没有返回值（可以放在OUT里面）</td>
<td>只能是一个，RETURNS后</td>
</tr>
<tr>
<td>应用场景</td>
<td>一般用于更新</td>
<td>一般用于查询结果为一个值并返回时</td>
</tr>
</tbody></table>
<p>存储函数可以放在查询语句中使用，存储过程不行。</p>
<p>存储过程的功能更加强大，包括能够执行对表的操作（比如创建表、删除表等）和事务操作，这些功能是存储函数不具备的。</p>
<h3 id="存储过程和函数的查看、修改、删除"><a href="#存储过程和函数的查看、修改、删除" class="headerlink" title="存储过程和函数的查看、修改、删除"></a>存储过程和函数的查看、修改、删除</h3><p>查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取存储过程和函数</span></span><br><span class="line"><span class="comment">-- 方式1，用 show create</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_mgr_name;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> title_by_name;</span><br><span class="line"><span class="comment">-- 方式2，查看状态信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;show_mgr_name&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FUNCTION</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;title_by_name&#x27;</span>;</span><br><span class="line"><span class="comment">-- 方式3，在information_schema.ROUTINES表中查看信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.ROUTINES <span class="keyword">WHERE</span> ROUTINE_NAME<span class="operator">=</span><span class="string">&#x27;show_mgr_name&#x27;</span> <span class="keyword">AND</span> ROUTINE_TYPE <span class="operator">=</span> <span class="string">&#x27;PROCEDURE&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.ROUTINES <span class="keyword">WHERE</span> ROUTINE_NAME<span class="operator">=</span><span class="string">&#x27;title_by_name&#x27;</span> <span class="keyword">AND</span> ROUTINE_TYPE <span class="operator">=</span> <span class="string">&#x27;FUNCTION&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改</span></span><br><span class="line"><span class="comment">-- 修改不影响存储过程和函数功能，只是修改相关特性</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> show_mgr_name </span><br><span class="line"><span class="comment">-- 安全调用，也就是需要有权限</span></span><br><span class="line"><span class="keyword">SQL</span> SECURITY INVOKER</span><br><span class="line">COMMENT <span class="string">&#x27;查询管理者名字&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除存储过程和函数</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> show_mgr_name;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> title_by_name;</span><br></pre></td></tr></table></figure>

<h2 id="变量、流程控制与游标"><a href="#变量、流程控制与游标" class="headerlink" title="变量、流程控制与游标"></a>变量、流程控制与游标</h2><p>在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。</p>
<p>在MySQL数据库中，变量分为<strong>系统变量</strong>以及<strong>用户自定义变量</strong>。</p>
<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><p>变量由系统定义，不是用户定义，属于服务器层面。启动MySQL服务生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些变量要么是<strong>编译MySQL时参数的默认值</strong>，要么是<strong>配置文件中的参数值</strong>。</p>
<p>MySQL 8.0系统变量：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html">https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html</a></p>
<p>MySQL 5.5系统变量：<a target="_blank" rel="noopener" href="http://download.nust.na/pub6/mysql/doc/refman/5.5/en/using-system-variables.html">http://download.nust.na/pub6/mysql/doc/refman/5.5/en/using-system-variables.html</a></p>
<p>系统变量分为全局系统变量（或者称为全局变量，通过关键字<code>global</code>）以及会话系统变量（或者称为local变量，通过关键字<code>session</code>）。<strong>如果不写。默认会话级别。</strong>静态变量（不能使用set动态修改）属于特殊的全局系统变量。</p>
<p>客户端连接之后，都会产生对应的会话。会话期间，MySQL服务实例会在内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。</p>
<ul>
<li>全局系统变量针对所有会话都有效，重启后失效</li>
<li>会话系统变量针对对应连接的会话，会话断开重连之后，会话系统变量失效</li>
<li>会话1对某个全局系统变量的修改会导致会话2中同一个全局系统变量</li>
</ul>
<p>MySQL有些系统变量的作用域是全局的（例如max_connections最大连接数），有些变量的作用域既可以是全局又可以是会话（例如字符集character_set_client），有些变量的作用域是会话（例如pseudo_thread_id标记当前会话的MySQL连接ID）。</p>
<h4 id="查看系统变量"><a href="#查看系统变量" class="headerlink" title="查看系统变量"></a>查看系统变量</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看所有系统变量</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES;</span><br><span class="line"><span class="comment">-- 查看所有会话变量</span></span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES;</span><br><span class="line"><span class="comment">-- 查询会话变量的另外一种方式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES;</span><br><span class="line"><span class="comment">-- 查看满足条件的部分系统变量</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%version%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看指定系统变量</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.admin_port;</span><br><span class="line"><span class="comment">-- 查看指定回话变量</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.collation_connection;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.collation_connection;</span><br><span class="line"><span class="comment">-- 先查看会话变量，再查看系统变量</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@collation</span>_connection;</span><br></pre></td></tr></table></figure>

<h4 id="修改系统变量"><a href="#修改系统变量" class="headerlink" title="修改系统变量"></a>修改系统变量</h4><p>方式1：永久修改，修改配置文件，然后重启</p>
<p>方式2：临时修改，一旦重启MySQL就失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改系统变量</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@global</span>.max_connections <span class="operator">=</span> <span class="number">161</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections  <span class="operator">=</span> <span class="number">171</span>;</span><br><span class="line"><span class="comment">-- 修改回话系统变量</span></span><br><span class="line"><span class="comment">-- 一旦断开回话重新建立回话，修改失效</span></span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.character_set_client;</span><br><span class="line"><span class="keyword">SET</span> SESSION character_set_client <span class="operator">=</span> <span class="string">&#x27;gbk&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="用户变量"><a href="#用户变量" class="headerlink" title="用户变量"></a>用户变量</h3><p>用户变量是用户自定义的，以一个<code>@</code>开头，根据作用范围分为会话用户变量和局部变量。</p>
<ul>
<li>会话用户变量：作用域为当前会话</li>
<li>局部变量：作用域为存储过程和函数中</li>
</ul>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置会话用户变量</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@var1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@var2</span> :<span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 使用变量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@var1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@var2</span>;</span><br><span class="line"><span class="comment">-- 只要会话还在，则变量还可以访问</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@var1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置会话用户变量方式2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@count</span> :<span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@count</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置会话用户变量方式3</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(start_date) <span class="keyword">INTO</span> <span class="variable">@max</span>_start_date <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@max</span>_start_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 局部变量</span></span><br><span class="line"><span class="comment">-- 1. 使用 DECLARE 声明</span></span><br><span class="line"><span class="comment">-- 2. 必须放在BEGIN END中</span></span><br><span class="line"><span class="comment">-- 3. DECLARE 的方式声明的局部变量必须声明在 BEGIN 中的首行位置</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_max_start_date()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">-- 声明局部变量</span></span><br><span class="line">	<span class="keyword">DECLARE</span> a <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> b <span class="type">CHAR</span>(<span class="number">20</span>);</span><br><span class="line"><span class="comment">-- 	赋值</span></span><br><span class="line">	<span class="keyword">SET</span> a <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">SET</span> b <span class="operator">=</span> <span class="string">&#x27;name&#x27;</span>;</span><br><span class="line">	<span class="keyword">SELECT</span> lname <span class="keyword">INTO</span> b <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> a;</span><br><span class="line"><span class="comment">-- 	使用</span></span><br><span class="line">	<span class="keyword">SELECT</span> a,b;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> get_max_start_date();</span><br></pre></td></tr></table></figure>

<h3 id="定义条件与处理程序"><a href="#定义条件与处理程序" class="headerlink" title="定义条件与处理程序"></a>定义条件与处理程序</h3><p>主要解决当程序在执行过程中出错时如何处理错误。<code>定义条件</code>是事先定义程序执行过程中可能遇到的问题，<code>处理程序</code>定义了遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。</p>
<p>说明：定义条件和处理程序在存储过程、存储函数中都是支持的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">ERROR <span class="number">1048</span> (<span class="number">23000</span>): <span class="keyword">Column</span> <span class="string">&#x27;fname&#x27;</span> cannot be <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>例如上面这个SQL语句，执行之后出现报错。<code>1048 (23000)</code>，其中1048是<code>MySQL_error_code</code>，23000是<code>sqlstate_value</code></p>
<ul>
<li><code>MySQL_error_code</code>：数值类型错误代码</li>
<li><code>sqlstate_value</code>：长度为5的字符串类型错误代码</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_pro1()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">-- 设置用户变量</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 	fname有非空约束</span></span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line"><span class="comment">-- 	验证报错后执行的变量是否会声明成功</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@y</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@z</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="keyword">CALL</span> test_pro1();</span><br><span class="line"><span class="comment">-- 出现报错</span></span><br><span class="line"><span class="comment">-- 1048 - Column &#x27;fname&#x27; cannot be null</span></span><br><span class="line"><span class="comment">-- 查看值，只有x声明成功</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@x</span>,<span class="variable">@y</span>,<span class="variable">@z</span>;</span><br></pre></td></tr></table></figure>

<p>定义条件与处理程序解决报错：</p>
<p>定义条件在外部定义即可</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义条件</span></span><br><span class="line"><span class="comment">-- 方式1，使用MySQL_error_code</span></span><br><span class="line"><span class="keyword">DECLARE</span> Field_Not_Be_NULL1 <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1048</span>;</span><br><span class="line"><span class="comment">-- 方式2，使用sqlstate_value，通过SQLSTATE防止将字符串转化成整形</span></span><br><span class="line"><span class="keyword">DECLARE</span> Field_Not_Be_Null2 <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;23000&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>定义处理程序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 声明处理方式 HANDLER <span class="keyword">FOR</span> 错误类型 处理语句</span><br></pre></td></tr></table></figure>

<p><strong>处理方式</strong>：</p>
<p>​	<code>CONTINUE</code> 错误不处理，继续运行；</p>
<p>​	<code>EXIT</code> 碰到错误马上退出；</p>
<p>​	<code>UNDO</code> 撤回之前的操作，MySQL暂时不支持 <code>UNDO</code></p>
<p><strong>错误类型</strong>：</p>
<p>​	<code>SQLSTATE</code> ‘字符串错误码’</p>
<p>​	<code>SQLSTATE</code> ‘字符串错误码’：匹配字符串类型错误码</p>
<p>​	<code>MySQL_error_code</code>: 匹配错误数值类型错误码</p>
<p><strong>错误名称</strong>：匹配前面定义的错误条件</p>
<p>​	<code>SQLWARNING</code>: 匹配所有以01开头的 <code>SQLSTATE</code> 的错误码</p>
<p>​	<code>NOT</code> FOUND: 匹配所有以02开头的 <code>SQLSTATE</code> 的错误码</p>
<p>​	<code>SQLEXCEPTION</code>: 匹配所有没有被 <code>SQLWARNING</code> 或 <code>NOT FOUND</code>捕获的 <code>SQLSTATE</code> 错误代码</p>
<p><strong>处理语句</strong>：如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像 <code>SET 变量 = 值</code>这样的简单语句，也可以是使用 <code>BEGIN ... END</code> 编写的复合语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义条件，使用MySQL_error_code</span></span><br><span class="line"><span class="keyword">DECLARE</span> Field_Not_Be_NULL1 <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1048</span>;</span><br><span class="line"><span class="comment">-- 定义存储过程</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_pro2()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">--  定义处理程序</span></span><br><span class="line">	<span class="keyword">DECLARE</span> Field_Not_Be_NULL1 <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1048</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> Field_Not_Be_NULL1 <span class="keyword">SET</span> <span class="variable">@info</span><span class="operator">=</span><span class="string">&#x27;Column cannot be null&#x27;</span>;</span><br><span class="line"><span class="comment">-- 	处理方式2 </span></span><br><span class="line">	# <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;23000&#x27;</span> <span class="keyword">SET</span> <span class="variable">@info2</span><span class="operator">=</span><span class="string">&#x27;this is 23000&#x27;</span>;</span><br><span class="line"><span class="comment">-- 设置用户变量</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 	fname有非空约束</span></span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line"><span class="comment">-- 	验证报错后执行的变量是否会声明成功</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@y</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@z</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_pro2();</span><br><span class="line"><span class="comment">-- 没有报错</span></span><br><span class="line"><span class="comment">-- 查看值，x,y,z,info都声明成功</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@x</span>,<span class="variable">@y</span>,<span class="variable">@z</span>,<span class="variable">@info</span>;</span><br></pre></td></tr></table></figure>

<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><p>控制存储过程中SQL语句的执行顺序。</p>
<ul>
<li>顺序结构：从上往下</li>
<li>分支结构：按照条件选择某一个路径</li>
<li>循环结构：满足条件时，重复执行一组数据</li>
</ul>
<p>流程控制语句：</p>
<ul>
<li>条件判断：IF 和 CASE</li>
<li>循环语句：LOOP、WHILE和REPEAT</li>
<li>跳转语句：ITERATE和LEAVE</li>
</ul>
<h4 id="IF"><a href="#IF" class="headerlink" title="IF"></a>IF</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 条件判断</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_if()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 声明局部变量</span></span><br><span class="line">    <span class="keyword">DECLARE</span> stu_name  <span class="type">VARCHAR</span>(<span class="number">15</span>);</span><br><span class="line"><span class="comment">-- 		使用 IF 结构</span></span><br><span class="line">IF stu_name <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">THEN</span>	<span class="keyword">SELECT</span> <span class="string">&#x27;stu_name is null&#x27;</span>;</span><br><span class="line"><span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_if();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 二选一</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_if2()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> email <span class="type">VARCHAR</span>(<span class="number">25</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;123@a.com&#x27;</span>;</span><br><span class="line">	IF email <span class="keyword">IS</span> <span class="keyword">NULL</span> 	</span><br><span class="line">	<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;email is null&#x27;</span>;</span><br><span class="line">	<span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;email is not null&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_if2();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多选一</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_if3()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> age <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">20</span>;</span><br><span class="line">	</span><br><span class="line">	IF age <span class="operator">&gt;</span> <span class="number">40</span> </span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;中年&#x27;</span>;</span><br><span class="line">	ELSEIF age <span class="operator">&gt;</span> <span class="number">20</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;青年&#x27;</span>;</span><br><span class="line">	<span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;少年&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="keyword">CALL</span> test_if3();</span><br></pre></td></tr></table></figure>

<h4 id="CASE"><a href="#CASE" class="headerlink" title="CASE"></a>CASE</h4><p>情况一：类似于switch</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- CASE</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_case1()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> var <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">CASE</span> var </span><br><span class="line">	<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;var = 1&#x27;</span>;</span><br><span class="line">	<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;var = 2&#x27;</span>;</span><br><span class="line">	<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;var = 3&#x27;</span>;</span><br><span class="line">	<span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;other value&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_case1();</span><br></pre></td></tr></table></figure>

<p>情况二：类似于多重if</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_case2()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> var <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">CASE</span></span><br><span class="line">	<span class="keyword">WHEN</span> var <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;var 3位数&#x27;</span>;</span><br><span class="line">	<span class="keyword">WHEN</span> var <span class="operator">&gt;=</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;var 2位数&#x27;</span>;</span><br><span class="line">	<span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;个位数&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="keyword">CALL</span> test_case2();</span><br></pre></td></tr></table></figure>

<h4 id="LOOP"><a href="#LOOP" class="headerlink" title="LOOP"></a>LOOP</h4><p>循环语句主要由四个部分组成：</p>
<ol>
<li>初始化条件</li>
<li>循环条件</li>
<li>循环体</li>
<li>迭代条件</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_loop()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 初始化条件</span></span><br><span class="line">	<span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	loop_label: LOOP</span><br><span class="line">	<span class="comment">-- 循环体和迭代条件</span></span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">	<span class="comment">-- 循环条件</span></span><br><span class="line">	IF num <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">THEN</span></span><br><span class="line">		LEAVE loop_label; </span><br><span class="line">	<span class="keyword">END</span> IF; </span><br><span class="line"><span class="keyword">END</span> LOOP loop_label;</span><br><span class="line"><span class="keyword">SELECT</span> num;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_loop();</span><br></pre></td></tr></table></figure>

<h4 id="WHILE"><a href="#WHILE" class="headerlink" title="WHILE"></a>WHILE</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_while()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 初始化条件</span></span><br><span class="line">  <span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">-- 循环条件</span></span><br><span class="line">	WHILE num <span class="operator">&lt;</span> <span class="number">10</span> DO</span><br><span class="line">	<span class="comment">-- 循环体和迭代条件</span></span><br><span class="line">		<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	<span class="keyword">SELECT</span> num;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 执行</span></span><br><span class="line"><span class="keyword">CALL</span> test_while();</span><br></pre></td></tr></table></figure>

<h4 id="REPEAT"><a href="#REPEAT" class="headerlink" title="REPEAT"></a>REPEAT</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_repeat()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 初始化条件</span></span><br><span class="line">  <span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	REPEAT</span><br><span class="line">	<span class="comment">-- 循环体和迭代条件</span></span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">	<span class="comment">-- 循环条件</span></span><br><span class="line">UNTIL num <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">END</span> REPEAT;</span><br><span class="line">	<span class="keyword">SELECT</span> num;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 执行</span></span><br><span class="line"><span class="keyword">CALL</span> test_repeat();</span><br></pre></td></tr></table></figure>

<h4 id="LEAVE和ITERATE"><a href="#LEAVE和ITERATE" class="headerlink" title="LEAVE和ITERATE"></a>LEAVE和ITERATE</h4><p><code>LEAVE</code>：使用在循环体内或者使用在BEGIN和END之间，表示跳出循环体或者跳出程序体的操作，类似于break。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_leave(<span class="keyword">IN</span> num <span class="type">INT</span>)</span><br><span class="line">begin_label:<span class="keyword">BEGIN</span></span><br><span class="line">	IF num <span class="operator">&lt;=</span> <span class="number">0</span> </span><br><span class="line"><span class="comment">-- 跳出begin	</span></span><br><span class="line">			<span class="keyword">THEN</span> LEAVE begin_label;</span><br><span class="line">		ELSEIF num <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">			<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="built_in">max</span>(start_date) <span class="keyword">FROM</span> employee;</span><br><span class="line">		ELSEIF num <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">			<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="built_in">min</span>(start_date) <span class="keyword">FROM</span> employee;</span><br><span class="line">		<span class="keyword">ELSE</span> </span><br><span class="line">			<span class="keyword">SELECT</span> <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_leave(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p><code>ITERATE</code>：只能使用在循环体内，表示跳过当前循环，进入下次循环。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_iterate(<span class="keyword">IN</span> num <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> size <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	loop_label: LOOP</span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">	IF num <span class="operator">&lt;=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line"><span class="comment">-- 跳出loop	</span></span><br><span class="line">			LEAVE loop_label; </span><br><span class="line">	ELSEIF num <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">SET</span> size <span class="operator">=</span> size <span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">	<span class="comment">-- 跳过此次loop，进入下次loop</span></span><br><span class="line">	<span class="keyword">ELSE</span> ITERATE loop_label;</span><br><span class="line">	<span class="keyword">END</span> IF; </span><br><span class="line"><span class="keyword">END</span> LOOP loop_label;</span><br><span class="line">	<span class="keyword">SELECT</span> size;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> test_iterate(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<h3 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h3><p>提供一种灵活的操作方式，让我们能够对结果集中的每一条记录进行定位，并对指向记录中的数据进行操作的数据结构。</p>
<p>游标让SQL这种面向集合的语言有了面向过程开发的能力。</p>
<p>游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。这里游标充当了指针的作用，我们可以通过操作游标来对数据行进行操作。</p>
<p>游标的使用分为四个步骤</p>
<ol>
<li>声明游标</li>
<li>打开游标</li>
<li>使用游标：使用该游标读取当前行，ZEROFILL</li>
<li>关闭游标：打开游标就需要关闭游标，游标会占用系统资源，不及时关闭的话，游标会一直保持到存储过程结束，影响系统效率。关闭游标会释放系统资源。关闭游标之后，就无法再次打开</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_count_by_limit_total_balance(<span class="keyword">IN</span> limit_total_balance <span class="keyword">DOUBLE</span>,<span class="keyword">OUT</span> total_count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">-- 	声明局部变量</span></span><br><span class="line">	<span class="keyword">DECLARE</span> sum_balance <span class="keyword">DOUBLE</span> <span class="keyword">DEFAULT</span> <span class="number">0.0</span>; <span class="comment">-- 记录累加的balance</span></span><br><span class="line">	<span class="keyword">DECLARE</span> account_balance <span class="keyword">DOUBLE</span>; <span class="comment">-- 记录每一个account的balance</span></span><br><span class="line">	<span class="keyword">DECLARE</span> account_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>; <span class="comment">-- 记录叠加的account</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 声明游标</span></span><br><span class="line">	<span class="keyword">DECLARE</span> account_balance_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> avail_balance <span class="keyword">FROM</span> account <span class="keyword">ORDER</span> <span class="keyword">BY</span> avail_balance <span class="keyword">DESC</span>;</span><br><span class="line">	</span><br><span class="line"><span class="comment">-- 	打开游标</span></span><br><span class="line">	<span class="keyword">OPEN</span> account_balance_cursor;</span><br><span class="line">	</span><br><span class="line">	REPEAT</span><br><span class="line">	<span class="comment">-- 	使用游标</span></span><br><span class="line">	<span class="keyword">FETCH</span> account_balance_cursor <span class="keyword">INTO</span> account_balance;</span><br><span class="line">	<span class="keyword">SET</span> sum_balance <span class="operator">=</span> sum_balance <span class="operator">+</span> account_balance;</span><br><span class="line">	<span class="keyword">SET</span> account_count <span class="operator">=</span> account_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">UNTIL sum_balance <span class="operator">&gt;=</span> limit_total_balance <span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="comment">-- 	关闭游标</span></span><br><span class="line">	<span class="keyword">CLOSE</span> account_balance_cursor;</span><br><span class="line">	<span class="keyword">SET</span> total_count <span class="operator">=</span> account_count;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@limit</span>_total_balance <span class="operator">=</span> <span class="number">100000.0</span>;</span><br><span class="line"><span class="keyword">CALL</span> get_count_by_limit_total_balance(<span class="variable">@limit</span>_total_balance,<span class="variable">@total</span>_count);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@total</span>_count;</span><br></pre></td></tr></table></figure>

<p>优点：为<strong>逐条读取结果集中的数据</strong>提供完美的解决方案，相比全部获取出来再应用程序中计算，使用游标效率高。</p>
<p>缺点：使用游标过程中，会对<strong>数据行加锁</strong>，高并发下不仅会影响业务效率，还会降低系统资源，造成内存不足，这是因为游标是在内存中处理的。</p>
<h3 id="MySQL-8-0特性"><a href="#MySQL-8-0特性" class="headerlink" title="MySQL 8.0特性"></a>MySQL 8.0特性</h3><ol>
<li><p>全局系统变量持久化，通过<code>persist</code>参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> persist innodb_buffer_pool_size <span class="operator">=</span> <span class="number">134217727</span>;</span><br><span class="line"><span class="keyword">SET</span> persist max_connections <span class="operator">=</span> <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<p>服务器重启之后，会加载这部分的配置。</p>
</li>
</ol>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><p>触发器是由<code>事件来触发</code>某个操作，这些事件包括<code>insert</code>、<code>update</code>、<code>delete</code>事件。所谓的事件就是指用户的操作或者触发某项行为。如果定义了触发程序，当数据执行这些语句的时候，就相当于事件发生了，就会<code>自动</code>激发触发器执行相应的操作。</p>
<p>当对数据表中的数据执行<strong>插入</strong>、<strong>更新</strong>和<strong>删除</strong>操作，需要自动执行一些数据库逻辑时，可以使用触发器来实现。</p>
<h3 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_trigger(</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY auto_increment,</span><br><span class="line">t_note <span class="type">VARCHAR</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_log(</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY auto_increment,</span><br><span class="line">t_log <span class="type">VARCHAR</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建触发器</span></span><br><span class="line"><span class="comment">-- 创建触发器名称</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> before_insert_test_tri </span><br><span class="line"><span class="comment">-- 在 INSERT 到 test_trigger 之前 ，对于每一行插入的数据</span></span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> test_trigger <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> </span><br><span class="line"><span class="comment">-- 在insert之后</span></span><br><span class="line"><span class="comment">-- AFTER INSERT INTO test_trigger FOR EACH ROW</span></span><br><span class="line"><span class="comment">-- 触发之后的动作</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 插入确定数据</span></span><br><span class="line"><span class="comment">-- 	INSERT INTO test_log(t_log) VALUES (&#x27;before insert&#x27;);</span></span><br><span class="line"><span class="comment">-- 	插入跟插入数据有关联的数据</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_log(t_log) <span class="keyword">VALUES</span> (new.t_note);</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_trigger(t_note) <span class="keyword">VALUES</span> (<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="comment">-- 获取触发器结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_log;</span><br></pre></td></tr></table></figure>

<h3 id="查看、删除触发器"><a href="#查看、删除触发器" class="headerlink" title="查看、删除触发器"></a>查看、删除触发器</h3><p>查看触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看触发器</span></span><br><span class="line"><span class="comment">-- 查看所有的触发器定义</span></span><br><span class="line"><span class="keyword">SHOW</span> TRIGGERS;</span><br><span class="line"><span class="comment">-- 查看触发器的创建定义</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> before_insert_test_tri;</span><br><span class="line"><span class="comment">-- 从 information_schema.TRIGGERS 表中查看</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.TRIGGERS <span class="keyword">WHERE</span> trigger_name <span class="operator">=</span> <span class="string">&#x27;before_insert_test_tri&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>删除触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除触发器</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> IF <span class="keyword">EXISTS</span> before_insert_test_tri;</span><br></pre></td></tr></table></figure>

<h3 id="优缺点和注意点"><a href="#优缺点和注意点" class="headerlink" title="优缺点和注意点"></a>优缺点和注意点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ol>
<li>触发器可以确保数据完整性</li>
<li>触发器可以帮助记录操作日志</li>
<li>在操作数据前，对数据合法性进行检验</li>
</ol>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>1、可读性差，触发器存储在数据库中，由事件驱动，不受应用层的控制</p>
<p>2、相关数据更新，可能导致触发器出错</p>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><p>如果在子表中定义了外键约束，并且外键指定了触发器，此时修改父表被引用的键值或者删除父表被引用的记录时，会引擎子表的修改和删除操作，此时基于子表的触发器，并不会被激活。</p>
<h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><p>MySQL 8新特性。在需要用到分组统计的结果对每一条记录进行计算的场景下，使用窗口函数效果更好。</p>
<p>窗口函数的作用类似于在查询过程中对数据进行分组，而且是将结果置于每一条数据记录中。相比较GROUP BY，不会聚合成一行。</p>
<p>窗口函数可以分为<strong>静态窗口函数</strong>和<strong>动态窗口函数</strong></p>
<ul>
<li>静态窗口函数：窗口大小固定，不会因为记录的不同而不同</li>
<li>动态窗口函数：窗口大小会随着记录的不同而变化</li>
</ul>
<p>窗口函数总体上可以分为序号函数、分布函数、前后函数、首位函数和其他函数。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221110163846331.png" alt="image-20221110163846331"></p>
<h3 id="序号函数"><a href="#序号函数" class="headerlink" title="序号函数"></a>序号函数</h3><p>增加一个序号，顺序排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ROW_NUMBER()</span></span><br><span class="line"><span class="comment">-- 例如列出来同department中start_date 降序排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span> </span><br><span class="line"><span class="comment">-- 通过 dept_id 分区，通过 start_date 排序，将分区和降序的结果序号作为row_num </span></span><br><span class="line">	(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date) <span class="keyword">AS</span> row_num,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+--------+------------+---------+</span></span><br><span class="line"><span class="operator">|</span> row_num <span class="operator">|</span> emp_id <span class="operator">|</span> start_date <span class="operator">|</span> dept_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+--------+------------+---------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>     <span class="number">19</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-12</span><span class="number">-12</span> <span class="operator">|</span>    <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span> <span class="number">2000</span><span class="number">-02</span><span class="number">-09</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>     <span class="number">13</span> <span class="operator">|</span> <span class="number">2000</span><span class="number">-05</span><span class="number">-11</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>     <span class="number">11</span> <span class="operator">|</span> <span class="number">2000</span><span class="number">-10</span><span class="number">-23</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">4</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span> <span class="number">2001</span><span class="number">-03</span><span class="number">-15</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span>      <span class="number">4</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-04</span><span class="number">-24</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">6</span> <span class="operator">|</span>      <span class="number">9</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-05</span><span class="number">-03</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">7</span> <span class="operator">|</span>     <span class="number">17</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-06</span><span class="number">-29</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">8</span> <span class="operator">|</span>     <span class="number">10</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-07</span><span class="number">-27</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">9</span> <span class="operator">|</span>     <span class="number">14</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-08</span><span class="number">-09</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">10</span> <span class="operator">|</span>      <span class="number">8</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-12</span><span class="number">-02</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">11</span> <span class="operator">|</span>     <span class="number">12</span> <span class="operator">|</span> <span class="number">2003</span><span class="number">-01</span><span class="number">-08</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">12</span> <span class="operator">|</span>     <span class="number">15</span> <span class="operator">|</span> <span class="number">2003</span><span class="number">-04</span><span class="number">-01</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">13</span> <span class="operator">|</span>      <span class="number">6</span> <span class="operator">|</span> <span class="number">2004</span><span class="number">-03</span><span class="number">-17</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">14</span> <span class="operator">|</span>      <span class="number">7</span> <span class="operator">|</span> <span class="number">2004</span><span class="number">-09</span><span class="number">-15</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>      <span class="number">5</span> <span class="operator">|</span> <span class="number">2003</span><span class="number">-11</span><span class="number">-14</span> <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>      <span class="number">2</span> <span class="operator">|</span> <span class="number">2002</span><span class="number">-09</span><span class="number">-12</span> <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> <span class="number">2022</span><span class="number">-10</span><span class="number">-11</span> <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+--------+------------+---------+</span></span><br><span class="line"><span class="number">18</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- RANK()，并列排序，会跳过重复的序号</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">RANK</span>() <span class="keyword">over</span> </span><br><span class="line"><span class="comment">-- 通过 dept_id 分区，通过 start_date 排序，将分区和降序的结果序号作为row_num </span></span><br><span class="line">	(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date) <span class="keyword">AS</span> row_num,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- DENSE_RANK(),并列排序，不会跳过重复的序号</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">DENSE_RANK</span>() <span class="keyword">over</span> </span><br><span class="line"><span class="comment">-- 通过 dept_id 分区，通过 start_date 排序，将分区和降序的结果序号作为row_num </span></span><br><span class="line">	(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date) <span class="keyword">AS</span> row_num,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口函数的另外一种写法，将窗口函数作为一个 window 声明</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">DENSE_RANK</span>() <span class="keyword">over</span> w <span class="keyword">AS</span> row_num,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date);</span><br></pre></td></tr></table></figure>

<h3 id="分布函数"><a href="#分布函数" class="headerlink" title="分布函数"></a>分布函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- PERCENT_RANK() 等级值百分比，(rank - 1) / (rows - 1)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">RANK</span>() <span class="keyword">OVER</span> w <span class="keyword">AS</span> r,</span><br><span class="line"><span class="built_in">PERCENT_RANK</span>() <span class="keyword">OVER</span> w <span class="keyword">AS</span> pr,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--  CUME_DIST() 查询小于或等于的比例</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CUME_DIST</span>() <span class="keyword">OVER</span> w <span class="keyword">AS</span> c,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>

<h3 id="前后函数"><a href="#前后函数" class="headerlink" title="前后函数"></a>前后函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询前一个员工的start_date</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LAG</span>(start_date,<span class="number">1</span>) <span class="keyword">OVER</span> w <span class="keyword">AS</span> pre_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br><span class="line"><span class="comment">-- 可以作为一个子函数，实现差值</span></span><br><span class="line"><span class="keyword">SELECT</span> pre_start_date,DATEDIFF(pre_start_date,start_date) <span class="keyword">AS</span> diff_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> (</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LAG</span>(start_date,<span class="number">1</span>) <span class="keyword">OVER</span> w <span class="keyword">AS</span> pre_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>))t</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询后一个员工的start_date</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LEAD</span>(start_date,<span class="number">1</span>) <span class="keyword">OVER</span> w <span class="keyword">AS</span> behind_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>

<h3 id="首位函数"><a href="#首位函数" class="headerlink" title="首位函数"></a>首位函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询分组后最头一个的start_date，可以用来获取差值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FIRST_VALUE</span>(start_date) <span class="keyword">OVER</span> w <span class="keyword">AS</span> first_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br><span class="line"><span class="comment">-- 查询分组后最尾部一个的start_date，可以用来获取差值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LAST_VALUE是获取当前行与之前行的比较，因此获取到的是本行的</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LAST_VALUE</span>(start_date) <span class="keyword">OVER</span> w <span class="keyword">AS</span> last_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br><span class="line"><span class="comment">-- 正确用法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LAST_VALUE</span>(start_date) <span class="keyword">OVER</span> w <span class="keyword">AS</span> last_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span> <span class="keyword">rows</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> unbounded following);</span><br></pre></td></tr></table></figure>

<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取start_date排名第三的start_date</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">NTH_VALUE</span>(start_date,<span class="number">3</span>) <span class="keyword">OVER</span> w <span class="keyword">AS</span> <span class="number">3</span>th_start_date,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将分组后的数据，再次平均分组，</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span> w <span class="keyword">AS</span> nt,</span><br><span class="line">emp_id,start_date,dept_id <span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_date <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>窗口函数的特点是可以分组，而且可以在分组内排序。另外，<strong>窗口函数不会因为分组而减少原表中的行数</strong>，这在原表数据的基础上进行统计和排序非常有用。</p>
<h2 id="公用表表达式"><a href="#公用表表达式" class="headerlink" title="公用表表达式"></a>公用表表达式</h2><p>MySQL 8新特性。也叫做通用表表达式，<code>Common Table Expressions</code>（<code>CTE</code>）。</p>
<p><code>CTE</code>是一个命名的临时结果集，作用范围是当前语句。CTE可以理解成一个可以复用的子查询，CTE可以引用其他CTE，但子查询不能引用其他子查询，所以可以考虑代替子查询。</p>
<p>依据语法结构和执行方式不同，公用表达式分为<strong>普通公用表表达式</strong>和<strong>递归公用表表达式</strong></p>
<h3 id="普通公用表表达式"><a href="#普通公用表表达式" class="headerlink" title="普通公用表表达式"></a>普通公用表表达式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 普通公用表表达式</span></span><br><span class="line"><span class="comment">-- 查看员工所在部门的信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> department <span class="keyword">WHERE</span> dept_id <span class="keyword">IN</span> (</span><br><span class="line"><span class="comment">-- 使用子查询</span></span><br><span class="line">	<span class="keyword">SELECT</span> dept_id <span class="keyword">FROM</span> employee);</span><br><span class="line">	</span><br><span class="line"><span class="comment">-- 	将子查询替换成公用表表达式</span></span><br><span class="line"><span class="comment">-- 声明公用表表达式，需要与调用一起使用</span></span><br><span class="line"><span class="keyword">WITH</span> cte_emp </span><br><span class="line"><span class="keyword">AS</span> ( </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> dept_id <span class="keyword">FROM</span> employee</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 使用公用表表达式</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> department d <span class="keyword">JOIN</span> cte_emp c <span class="keyword">ON</span> d.dept_id <span class="operator">=</span> c.dept_id;</span><br></pre></td></tr></table></figure>

<h3 id="递归公用表表达式"><a href="#递归公用表表达式" class="headerlink" title="递归公用表表达式"></a>递归公用表表达式</h3><p>递归公用表表达式除了普通公用表表达式的特点之外，还可以自己调用自己。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 递归公用表表达式</span></span><br><span class="line"><span class="comment">-- 例如查询出有下属后，下属还有的下属</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">recursive</span> cte_emp <span class="keyword">AS</span> (</span><br><span class="line"><span class="keyword">SELECT</span> emp_id,lname,superior_emp_id,<span class="number">1</span> <span class="keyword">AS</span> n <span class="keyword">FROM</span> employee <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">1</span> <span class="comment">-- 种子查询,先取老板</span></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> a.emp_id,a.lname,a.superior_emp_id,n<span class="operator">+</span><span class="number">1</span> <span class="keyword">FROM</span> employee <span class="keyword">AS</span> a <span class="keyword">JOIN</span> cte_emp <span class="keyword">ON</span> </span><br><span class="line"><span class="comment">-- 递归查询，找出递归公用表表达式的人为领导的人，也就是老板的下属，递归查询下属的下属</span></span><br><span class="line">(a.superior_emp_id <span class="operator">=</span> cte_emp.emp_id))</span><br><span class="line"><span class="keyword">SELECT</span> emp_id,lname <span class="keyword">FROM</span> cte_emp <span class="keyword">WHERE</span> n <span class="operator">&gt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>公用表表达式的作用是可以替代子查询，而且可以被多次引用。递归公用表表达式对查询有一个共同根节点的树形结构数据非常高效，可以轻松搞定其他查询方式难以处理的查询。</p>
<h2 id="字符集的相关操作"><a href="#字符集的相关操作" class="headerlink" title="字符集的相关操作"></a>字符集的相关操作</h2><h3 id="修改字符集"><a href="#修改字符集" class="headerlink" title="修改字符集"></a>修改字符集</h3><p>MySQL 8.0版本之前，默认字符集为<code>latin1</code>。<code>utf8</code>字符集指向的是<code>utf8mb3</code>，其中3代表1个字符占用3个字节。如果遗忘修改字符集，就会出现乱码的问题。从MySQL 8.0开始，数据库的默认编码将改成<code>utf8mb4</code>，代表1个字符占用4个字节。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看默认使用的字符集</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%character%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> character_set_client     <span class="operator">|</span> utf8mb4                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_connection <span class="operator">|</span> utf8mb4                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_database   <span class="operator">|</span> utf8mb4                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_filesystem <span class="operator">|</span> <span class="type">binary</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_results    <span class="operator">|</span> utf8mb4                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_server     <span class="operator">|</span> utf8mb4                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_set_system     <span class="operator">|</span> utf8mb3                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> character_sets_dir       <span class="operator">|</span> <span class="operator">/</span>usr<span class="operator">/</span>share<span class="operator">/</span>mysql<span class="number">-8.0</span><span class="operator">/</span>charsets<span class="operator">/</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+--------------------------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE dbtest1;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE dbtest1;</span><br><span class="line"><span class="comment">-- 修改数据库默认字符集</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;latin1&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@character</span>_set_database <span class="operator">=</span> <span class="string">&#x27;utf8mb4&#x27;</span>;</span><br><span class="line"><span class="comment">-- 修改某个数据库的字符集</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE dbtest1 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;latin1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建表时如果没有指定字符集，则使用数据库默认字符集</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table1(id <span class="type">INT</span>,`name` <span class="type">VARCHAR</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table1;</span><br><span class="line"><span class="comment">-- 更改表字符集</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table1 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8mb4&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>如果表中有数据，并且数据兼容新的字符集，则可以成功修改。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取所有支持的字符集和比较规则</span></span><br><span class="line"><span class="keyword">SHOW</span> CHARSET;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Charset  <span class="operator">|</span> Description                     <span class="operator">|</span> <span class="keyword">Default</span> <span class="keyword">collation</span>   <span class="operator">|</span> Maxlen <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> armscii8 <span class="operator">|</span> ARMSCII<span class="number">-8</span> Armenian              <span class="operator">|</span> armscii8_general_ci <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">-- 字符集			描述																默认比较规则						最大占用字节数</span></span><br></pre></td></tr></table></figure>

<h3 id="各级别字符集"><a href="#各级别字符集" class="headerlink" title="各级别字符集"></a>各级别字符集</h3><ul>
<li>服务器级别</li>
<li>数据库级别</li>
<li>表级别</li>
<li>列级别</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> character_set_database   <span class="operator">|</span> utf8mb4                        <span class="operator">|</span> <span class="comment">-- 数据库级别</span></span><br><span class="line"><span class="operator">|</span> character_set_server     <span class="operator">|</span> utf8mb4                        <span class="operator">|</span> <span class="comment">-- 服务器级别</span></span><br></pre></td></tr></table></figure>

<p>从上到下，如果没有指明字符集，创建时则默认使用上级字符集。</p>
<h3 id="比较规则"><a href="#比较规则" class="headerlink" title="比较规则"></a>比较规则</h3><p>比较规则是在当前字符集下的排序计量方式，规则名称的后缀表示该比较规则是否区分语言中的重音、大小写。具体如下</p>
<table>
<thead>
<tr>
<th>后缀</th>
<th>英文释义</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>_ai</code></td>
<td><code>accent insensitive</code></td>
<td>不区分重音</td>
</tr>
<tr>
<td><code>_as</code></td>
<td><code>accent sensitive</code></td>
<td>区分重音</td>
</tr>
<tr>
<td><code>_ci</code></td>
<td><code>case insensitive</code></td>
<td>不区分大小写</td>
</tr>
<tr>
<td><code>_cs</code></td>
<td><code>case sensitive</code></td>
<td>区分大小写</td>
</tr>
<tr>
<td><code>_bin</code></td>
<td><code>binary</code></td>
<td>以二进制方式比较</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看比较规则</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">COLLATION</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器的字符集和比较规则</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%_server%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看数据库的字符集和比较规则</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%_database%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改具体数据库的字符集和比较规则</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE dbtest1 <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8mb4&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8mb4_general_ci&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表的比较规则</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">FROM</span> dbtest1 <span class="keyword">WHERE</span> Name <span class="operator">=</span> <span class="string">&#x27;table1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 修改表的比较规则</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table1 <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8mb4&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8mb4_general_ci&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>说明</p>
<ul>
<li>一般情况，<code>utf8mb4_general_ci</code>最优，如果是德语、法语或者俄语，使用<code>utf8mb4_unicode_ci</code>更好。</li>
<li>修改了数据库的默认字符集和比较规则后，原来已经创建的表的字符集和比较规则不会改变，如果要改，那么需要单独修改。</li>
</ul>
<h3 id="请求到响应过程字符集的变化"><a href="#请求到响应过程字符集的变化" class="headerlink" title="请求到响应过程字符集的变化"></a>请求到响应过程字符集的变化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">--------------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> character_set_client     <span class="operator">|</span> utf8mb4                        <span class="operator">|</span> <span class="comment">-- 客户端的字符集，传输数据到服务端使用对应字符集对数据进行编码</span></span><br><span class="line"><span class="operator">|</span> character_set_connection <span class="operator">|</span> utf8mb4                        <span class="operator">|</span> <span class="comment">-- 从这个字符集转换为具体的列使用的字符集</span></span><br><span class="line"><span class="operator">|</span> character_set_results    <span class="operator">|</span> utf8mb4                        <span class="operator">|</span>	<span class="comment">-- 将查询结果从具体的列使用的字符转换位这个字符集</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221111204155284.png" alt="image-20221111204155284"></p>
<p>总结：</p>
<p>通常把<code>character_set_client</code>，<code>character_set_connection</code>，<code>character_set_results</code>设置成和客户端使用的字符集一致，减少很多无谓的字符集转换。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 一次性设置传输的字符集</span></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="comment">-- 想等于</span></span><br><span class="line"><span class="keyword">SET</span> character_set_client <span class="operator">=</span> utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> character_set_connection <span class="operator">=</span> utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> character_set_results <span class="operator">=</span> utf8mb4;</span><br></pre></td></tr></table></figure>

<h2 id="SQL-大小写规范"><a href="#SQL-大小写规范" class="headerlink" title="SQL 大小写规范"></a>SQL 大小写规范</h2><p>通常情况下，MySQL在<code>Linux</code>下大小写敏感，在<code>Windows</code>下大小写不敏感。</p>
<p>查看大小写是否敏感</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%lower_case_table_name%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>默认为0，代表大小写敏感</li>
<li>设置1，大小写不敏感。创建的表、数据库都是以小写形式存放在磁盘上，对于sql语句都是转换为小写对表和数据库查询</li>
<li>设置2，创建的表和数据库依据语句上格式存放，范式查找都是转换为小写进行</li>
</ul>
<blockquote>
<p>MySQL在<code>Linux</code>下数据库名、表名、列名、别名大小写规则是这样的：</p>
<p>1、数据库名、表名、表的别名、变量名是严格区分大小写的；</p>
<p>2、关键字、函数名称在 SQL 中不区分大小写；</p>
<p>3、列名（或字段名）与列的别名（或字段别名）在所有的情况下均是忽略大小写的；</p>
<p>MySQL在Windows的环境下全部不区分大小写</p>
</blockquote>
<p>修改大小写规则：</p>
<ul>
<li>MySQL 5版本需要修改<code>my.cnf</code>配置文件的参数，然后重启，但是在重启之前，需要将原来的数据库和表转换为小写，不然重启后将找不到数据库名</li>
<li>MySQL 8版本修改之后，重启会失败，必须要删除 <code>/var/lib/mysql</code>中的文件，也就是数据中的数据</li>
</ul>
<p>SQL编写建议：</p>
<ul>
<li>关键字和函数名全部大写</li>
<li>数据库名、表名、表别名、字段名、字段别名全部小写</li>
<li>SQL语句必须以分号结尾</li>
</ul>
<h2 id="sql-model"><a href="#sql-model" class="headerlink" title="sql_model"></a>sql_model</h2><p><code>sql_mode</code>会影响MySQL支持的SQL语法以及它执行的数据验证检查。通过设置<code>sql_mode</code>可以完成不同严格程度的数据校验，有效的保障数据准确性。</p>
<ul>
<li><p>宽松模式：插入数据时，即便给了一个错误的数据，也可能会被接受，而且不报错。例如长度为2，插入<code>abc</code>，实际上会插入<code>ab</code>而不会报错</p>
<p>主要应用于数据库之间进行迁移。</p>
</li>
<li><p>严格模式：插入数据时，如果给了一个错误的数据，就会报错。</p>
<p>主要应用于生产、开发、测试环境。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前 sql_mode </span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.sql_mode; </span><br><span class="line"><span class="comment">-- 设置 sql_mode </span></span><br><span class="line"><span class="keyword">SET</span> SESSION sql_mode <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">-- 永久设置需要配置在my.cnf配置文件中。</span></span><br></pre></td></tr></table></figure>

<p>更多<code>sql_mode</code>：</p>
<p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/sql-mode/">https://mariadb.com/kb/en/sql-mode/</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html">https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html</a></p>
<h2 id="MySQL的数据目录"><a href="#MySQL的数据目录" class="headerlink" title="MySQL的数据目录"></a>MySQL的数据目录</h2><h3 id="物理存储目录"><a href="#物理存储目录" class="headerlink" title="物理存储目录"></a>物理存储目录</h3><p>库是以目录的方式存储。表存储在对应的目录中。MySQL数据库文件存放路径：<code>/var/lib/mysql</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -l /var/lib/mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%datadir%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="数据库和文件系统的管理"><a href="#数据库和文件系统的管理" class="headerlink" title="数据库和文件系统的管理"></a>数据库和文件系统的管理</h3><p>像<code>InnoDB</code>、<code>MyISAM</code>这样的存储引擎都是把表存储在磁盘上，操作系统用来管理磁盘的结构被称为<code>文件系统</code>，也就是说，像<code>InnoDB</code>、<code>MyISAM</code>这样的存储引擎都是把表存储在文件系统上的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 默认数据库</span></span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span>			<span class="comment">-- 保存MySQL服务器维护其他的数据库的基本信息，例如表、视图、触发器、列、索引的信息</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span>      <span class="comment">-- 核心数据库，存储用户、权限的信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息，一些帮助信息以及时区信息</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span>			<span class="comment">-- 保存MySQL服务器运行过程中的一些状态信息，用来监控MySQL服务的各类性能指标</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span>			<span class="comment">-- 通过视图的形式，把 information_schema 和 performance_schema结合起来，帮助管理员监控MySQL的技术性能</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="数据库在文件系统中的表示"><a href="#数据库在文件系统中的表示" class="headerlink" title="数据库在文件系统中的表示"></a>数据库在文件系统中的表示</h3><p>不同的存储引擎，不同的MySQL版本，文件存储方式不同，这里用MySQL 8版本说明。</p>
<p>使用<code>MyISAM</code>引擎</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE dbtest2;</span><br><span class="line">USE dbtest2;</span><br><span class="line">CREATE TABLE myisam1(id INT,`name` varchar(15)) ENGINE=MYISAM;</span><br></pre></td></tr></table></figure>

<p>在<code>/var/lib/mysql/dbtest2</code>下，表文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-rw-r-----  1 mysql mysql 2.4K Nov 11 14:26 myisam1_539.sdi		// 元数据，列的信息：列名，属性，约束等	</span><br><span class="line">-rw-r-----  1 mysql mysql 1.0K Nov 11 14:26 myisam1.MYI				// 索引</span><br><span class="line">-rw-r-----  1 mysql mysql    0 Nov 11 14:26 myisam1.MYD				// 数据</span><br></pre></td></tr></table></figure>

<p>使用<code>InnoDB</code>引擎（默认），表文件如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 mysql mysql   327680 Jul 16 09:42 time_zone_name.ibd // 列的结构：列名，属性，约束等，以及数据(如果存储在独立表空间)</span><br></pre></td></tr></table></figure>

<p><code>InnoDB</code>还提供系统表空间，查看配置，是否存在系统表空间还是独立表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_file_per_table&#x27;</span>;</span><br><span class="line"><span class="comment">-- ON 代表使用独立表空间，OFF代表使用系统表空间</span></span><br></pre></td></tr></table></figure>

<p>如果存在系统表空间，则会将数据信息和索引都存储在<code>ibdata1</code>中。</p>
<h3 id="配置文件目录"><a href="#配置文件目录" class="headerlink" title="配置文件目录"></a>配置文件目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf</span><br></pre></td></tr></table></figure>

<h2 id="用户与权限"><a href="#用户与权限" class="headerlink" title="用户与权限"></a>用户与权限</h2><p>MySQL的用户可以分为<code>普通用户</code>和<code>root</code>用户，<code>root</code>用户是超级管理员，拥有所有权限，包括创建用户、删除用户和修改用户的密码登管理权限；普通用户只拥有被授予的各种权限。</p>
<p>MySQL数据库的安全性通过账户管理来保证。</p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 DATABASE -e &quot;SQL语句&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-h</code>：后面接主机名或者主机IP</li>
<li><code>-P</code>：后面接端口</li>
<li><code>-u</code>：后面接用户名</li>
<li><code>-p</code>：后面接密码，一般不显示出来，会提示输入密码</li>
<li><code>DATABASE</code>：表示连接到的数据库</li>
<li><code>-e</code>：后面接可直接执行的SQL语句</li>
</ul>
<h3 id="用户和密码的管理"><a href="#用户和密码的管理" class="headerlink" title="用户和密码的管理"></a>用户和密码的管理</h3><p>用户和密码的增删改查</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line"><span class="comment">-- 查看用户</span></span><br><span class="line"><span class="keyword">SELECT</span> `host`,`<span class="keyword">USER</span>`,authentication_string <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="comment">-- 创建用户，不写host默认为%</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> user01 IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="comment">-- 增，创建一个host为127.0.0.1的用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> user01<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="comment">-- 因此，user表中，是以 user 和 host 字段一起创建的联合主键 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改用户，其实是修改user表中的数据</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">&#x27;user02&#x27;</span> <span class="keyword">WHERE</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">&#x27;user01&#x27;</span> <span class="keyword">AND</span> host <span class="operator">=</span> <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 修改之后，一定要刷新用户信息</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除,如果没有设置host，默认是%</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> user01;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> user01<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>;</span><br><span class="line"><span class="comment">-- 另外一种方式，不推荐，这种方式删除可能会有残留</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">&#x27;user01&#x27;</span> <span class="keyword">AND</span> host <span class="operator">=</span> <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>密码管理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改自己的密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="keyword">user</span>() IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 修改某个用户的密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> IDENTIFIED <span class="keyword">by</span> <span class="string">&#x27;456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 方式二 </span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span><span class="operator">=</span><span class="string">&#x27;456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 密码存储字段，是 authentication_string ，经过了加密处理</span></span><br><span class="line"><span class="keyword">DESC</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>

<p>密码可以通过配置插件设置安全性</p>
<ul>
<li>密码复杂度</li>
<li>密码加密策略</li>
<li>密码过期策略（不需要插件）</li>
<li>密码重用策略</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置密码马上过期，用户可登录，但是不能查询，需要重置自己的密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> PASSWORD EXPIRE;</span><br><span class="line"><span class="comment">-- 设置全局密码过期时间，也可以在配置文件中设置</span></span><br><span class="line"><span class="keyword">SET</span> PERSIST default_password_lifetime <span class="operator">=</span> <span class="number">180</span>; <span class="comment">-- 每隔180天过期</span></span><br><span class="line"><span class="comment">-- 设置单独的账号过期时间</span></span><br><span class="line"><span class="comment">-- 90天过期</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> PASSWORD EXPIRE <span class="type">INTERVAL</span> <span class="number">90</span> <span class="keyword">DAY</span>;</span><br><span class="line"><span class="comment">-- 永不过期</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> PASSWORD EXPIRE NEVER;</span><br><span class="line"><span class="comment">-- 沿用全局密码过期</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> PASSWORD EXPIRE <span class="keyword">DEFAULT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>给某个对象赋予操作某个范围的某个权限(8.0版本中，创建用户和授权分来，不能在一条命令中实现)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看所有权限</span></span><br><span class="line"><span class="keyword">SHOW</span> PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>权限可分为针对表权限、列权限、过程（存储过程、存储函数）权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将 mitaka 数据库的所有的表 的 所有的 权限，赋予 user01@127.0.0.1</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> mitaka.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 赋予部分权限，例如查询和更新</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>,<span class="keyword">UPDATE</span> <span class="keyword">ON</span> mitaka.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 将所有权限赋予所有的库的所有表给用户，但是这个用户不能赋予其他用户权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>查看当前用户的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 权限带有 WITH GRANT OPTION 则代表可以将权限赋予其他用户</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="built_in">CURRENT_USER</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="built_in">CURRENT_USER</span>();</span><br><span class="line"><span class="comment">-- 查看某个用户的权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>回收权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> mitaka.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;user01&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意：用户需要重新登录才能生效。</strong></p>
<p>刷新权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="权限表"><a href="#权限表" class="headerlink" title="权限表"></a>权限表</h3><p>MySQL通过权限表来控制用户对数据库的访问，权限表存放在<code>mysql</code>数据库中。</p>
<ul>
<li>连接核实阶段：用户登录，通过账号密码验证用户，使用<code>user</code>表的<code>host</code>、<code>user</code>、<code>authentication_string</code>字段匹配客户端登录信息。</li>
<li>请求核实阶段：当用户操作某个数据库或者表，也就是发送请求，通过以下权限表逐个核实权限，如果有权限则允许，如果没有权限，则查询下一个权限表，直到<code>columns_priv</code>表。</li>
</ul>
<p><code>user</code>表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------------------+------+-----+-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field                    <span class="operator">|</span> Type                              <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>               <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------------------+------+-----+-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Host                     <span class="operator">|</span> <span class="type">char</span>(<span class="number">255</span>)                         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">User</span>                     <span class="operator">|</span> <span class="type">char</span>(<span class="number">32</span>)                          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 以下是权限</span></span><br><span class="line"><span class="operator">|</span> Select_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Insert_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Update_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Delete_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Drop_priv                <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Reload_priv              <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shutdown_priv            <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Process_priv             <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> File_priv                <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Grant_priv               <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> References_priv          <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Index_priv               <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Alter_priv               <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Show_db_priv             <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Super_priv               <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_tmp_table_priv    <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Lock_tables_priv         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Execute_priv             <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Repl_slave_priv          <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Repl_client_priv         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_view_priv         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Show_view_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_routine_priv      <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Alter_routine_priv       <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_user_priv         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Event_priv               <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Trigger_priv             <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_tablespace_priv   <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 以上是权限</span></span><br><span class="line"><span class="operator">|</span> ssl_type                 <span class="operator">|</span> enum(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;ANY&#x27;</span>,<span class="string">&#x27;X509&#x27;</span>,<span class="string">&#x27;SPECIFIED&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>                       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_cipher               <span class="operator">|</span> <span class="type">blob</span>                              <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> x509_issuer              <span class="operator">|</span> <span class="type">blob</span>                              <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> x509_subject             <span class="operator">|</span> <span class="type">blob</span>                              <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> max_questions            <span class="operator">|</span> <span class="type">int</span> unsigned                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> max_updates              <span class="operator">|</span> <span class="type">int</span> unsigned                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 最大连接数</span></span><br><span class="line"><span class="operator">|</span> max_connections          <span class="operator">|</span> <span class="type">int</span> unsigned                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> max_user_connections     <span class="operator">|</span> <span class="type">int</span> unsigned                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 插件</span></span><br><span class="line"><span class="operator">|</span> plugin                   <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> caching_sha2_password <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 密码</span></span><br><span class="line"><span class="operator">|</span> authentication_string    <span class="operator">|</span> text                              <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="comment">-- 密码是否过期</span></span><br><span class="line"><span class="operator">|</span> password_expired         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> password_last_changed    <span class="operator">|</span> <span class="type">timestamp</span>                         <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> password_lifetime        <span class="operator">|</span> <span class="type">smallint</span> unsigned                 <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> account_locked           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_role_priv         <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Drop_role_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N                     <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Password_reuse_history   <span class="operator">|</span> <span class="type">smallint</span> unsigned                 <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Password_reuse_time      <span class="operator">|</span> <span class="type">smallint</span> unsigned                 <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Password_require_current <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>)                     <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> User_attributes          <span class="operator">|</span> json                              <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------------------+------+-----+-----------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p><code>db</code>表，体现用户在具体某个数据库的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> db;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field                 <span class="operator">|</span> Type          <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Host                  <span class="operator">|</span> <span class="type">char</span>(<span class="number">255</span>)     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>         <span class="operator">|</span>       <span class="operator">|</span> <span class="comment">-- 主机 </span></span><br><span class="line"><span class="operator">|</span> Db                    <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>         <span class="operator">|</span>       <span class="operator">|</span> <span class="comment">-- 表</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">User</span>                  <span class="operator">|</span> <span class="type">char</span>(<span class="number">32</span>)      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>         <span class="operator">|</span>       <span class="operator">|</span> <span class="comment">-- 用户</span></span><br><span class="line"><span class="operator">|</span> Select_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Insert_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Update_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Delete_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_priv           <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Drop_priv             <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Grant_priv            <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> References_priv       <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Index_priv            <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Alter_priv            <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_tmp_table_priv <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Lock_tables_priv      <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_view_priv      <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Show_view_priv        <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Create_routine_priv   <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Alter_routine_priv    <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Execute_priv          <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Event_priv            <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Trigger_priv          <span class="operator">|</span> enum(<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> N       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">22</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>表<code>tables_priv</code>，体现表中的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> tables_priv;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                                                                                                                              <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra                                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Host        <span class="operator">|</span> <span class="type">char</span>(<span class="number">255</span>)                                                                                                                         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Db          <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                                                                                                                          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">User</span>        <span class="operator">|</span> <span class="type">char</span>(<span class="number">32</span>)                                                                                                                          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Table_name  <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                                                                                                                          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Grantor     <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">288</span>)                                                                                                                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">Timestamp</span>   <span class="operator">|</span> <span class="type">timestamp</span>                                                                                                                         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span> DEFAULT_GENERATED <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Table_priv  <span class="operator">|</span> <span class="keyword">set</span>(<span class="string">&#x27;Select&#x27;</span>,<span class="string">&#x27;Insert&#x27;</span>,<span class="string">&#x27;Update&#x27;</span>,<span class="string">&#x27;Delete&#x27;</span>,<span class="string">&#x27;Create&#x27;</span>,<span class="string">&#x27;Drop&#x27;</span>,<span class="string">&#x27;Grant&#x27;</span>,<span class="string">&#x27;References&#x27;</span>,<span class="string">&#x27;Index&#x27;</span>,<span class="string">&#x27;Alter&#x27;</span>,<span class="string">&#x27;Create View&#x27;</span>,<span class="string">&#x27;Show view&#x27;</span>,<span class="string">&#x27;Trigger&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Column_priv <span class="operator">|</span> <span class="keyword">set</span>(<span class="string">&#x27;Select&#x27;</span>,<span class="string">&#x27;Insert&#x27;</span>,<span class="string">&#x27;Update&#x27;</span>,<span class="string">&#x27;References&#x27;</span>)                                                                                      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p>表<code>columns_priv</code>，体现列的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> columns_priv;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                                         <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra                                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Host        <span class="operator">|</span> <span class="type">char</span>(<span class="number">255</span>)                                    <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Db          <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">User</span>        <span class="operator">|</span> <span class="type">char</span>(<span class="number">32</span>)                                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Table_name  <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Column_name <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                                     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">Timestamp</span>   <span class="operator">|</span> <span class="type">timestamp</span>                                    <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span> DEFAULT_GENERATED <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Column_priv <span class="operator">|</span> <span class="keyword">set</span>(<span class="string">&#x27;Select&#x27;</span>,<span class="string">&#x27;Insert&#x27;</span>,<span class="string">&#x27;Update&#x27;</span>,<span class="string">&#x27;References&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>表<code>procs_priv</code>，存储过程和存储函数的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> procs_priv;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field        <span class="operator">|</span> Type                                   <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra                                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Host         <span class="operator">|</span> <span class="type">char</span>(<span class="number">255</span>)                              <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Db           <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                               <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">User</span>         <span class="operator">|</span> <span class="type">char</span>(<span class="number">32</span>)                               <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Routine_name <span class="operator">|</span> <span class="type">char</span>(<span class="number">64</span>)                               <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Routine_type <span class="operator">|</span> enum(<span class="string">&#x27;FUNCTION&#x27;</span>,<span class="string">&#x27;PROCEDURE&#x27;</span>)           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Grantor      <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">288</span>)                           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Proc_priv    <span class="operator">|</span> <span class="keyword">set</span>(<span class="string">&#x27;Execute&#x27;</span>,<span class="string">&#x27;Alter Routine&#x27;</span>,<span class="string">&#x27;Grant&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>                   <span class="operator">|</span>                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">Timestamp</span>    <span class="operator">|</span> <span class="type">timestamp</span>                              <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span> DEFAULT_GENERATED <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------------------------------+------+-----+-------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h2><p>MySQL 8.0引入的新功能，角色是权限的集合，可以给角色添加或移除权限，给用户赋予角色之后，用户就拥有角色中包含的权限。</p>
<h3 id="管理角色"><a href="#管理角色" class="headerlink" title="管理角色"></a>管理角色</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建角色</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;boss&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 给角色赋予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>,<span class="keyword">UPDATE</span> <span class="keyword">ON</span> dbtest1.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> dbtest1.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;boss&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看角色的权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;boss&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 回收角色的权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> dbtest1.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"><span class="comment">-- 删除角色</span></span><br><span class="line"><span class="keyword">DROP</span> ROLE <span class="string">&#x27;boss&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>角色和用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;user4&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 将角色赋予到用户</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;user4&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 角色赋予用户之后，还不能直接使用，还需要将角色激活</span></span><br><span class="line"><span class="comment">-- 角色创建之后，默认没有被激活</span></span><br><span class="line"><span class="comment">-- 使用用户的user4登录，查看当前角色</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CURRENT_ROLE</span>();</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">CURRENT_ROLE</span>() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NONE</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="comment">-- 激活角色</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">DEFAULT</span> ROLE <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;user4&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 再次退出、登录</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">current_role</span>();</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">current_role</span>() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> `manager`@`<span class="operator">%</span>`  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 激活方式2，设置默认激活状态</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%activate_all_roles_on_login%&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> activate_all_roles_on_login<span class="operator">=</span><span class="keyword">ON</span>;</span><br><span class="line"><span class="comment">-- 对所有角色激活</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从用户撤销角色</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;user4&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 需要重新登录，才会应用新的权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置强制角色</span></span><br><span class="line"><span class="comment">-- 强制角色是给每个创建账户的默认角色，不需要手动设置，强制角色无法被REVOKE或者DROP </span></span><br><span class="line"><span class="comment">-- 方式1：服务启动前设置，在配置文件中增加配置</span></span><br><span class="line"><span class="comment">-- 方式2：运行时设置 </span></span><br><span class="line"><span class="comment">-- 系统重启后仍然有效</span></span><br><span class="line"><span class="keyword">SET</span> PERSIST mandatory_roles <span class="operator">=</span> <span class="string">&#x27;role1,role2@localhost,r2@%&#x27;</span>; </span><br><span class="line"><span class="comment">-- 系统重启后失效</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> mandatory_roles <span class="operator">=</span> <span class="string">&#x27;role1,role2@localhost,r2@%&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p>推荐阅读：</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html">窗口函数使用手册</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzt19881123/article/details/109511245">mysql 8.0 配置文件my.cnf中文注解</a></p>
<p><a target="_blank" rel="noopener" href="https://kalacloud.com/blog/how-to-edit-mysql-configuration-file-my-cnf-ini/">MySQL 配置文件 my.cnf &#x2F; my.ini 逐行详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hldx.cc/90">MySQL 配置文件</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/26/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0DQL%E7%AF%87/" rel="prev" title="MySQL学习笔记DQL篇">
                  <i class="fa fa-chevron-left"></i> MySQL学习笔记DQL篇
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/12/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E6%9E%B6%E6%9E%84%E7%AF%87/" rel="next" title="MySQL学习笔记架构篇">
                  MySQL学习笔记架构篇 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/xiaoyeshiyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
