<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是学习MySQL的笔记高可用篇，主要包含日志、主从复制、备份和恢复。">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL学习笔记高可用篇">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="这是学习MySQL的笔记高可用篇，主要包含日志、主从复制、备份和恢复。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125142619500.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127205519810.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212122996.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212426155.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212912578.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212958101.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213116014.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213241645.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213435259.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213527435.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213809370.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127214552686.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215004563.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215122649.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215450293.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215729414.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128101737619.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128102504878.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128103048825.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128180941894.png">
<meta property="article:published_time" content="2022-11-24T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-01T07:49:49.109Z">
<meta property="article:author" content="Mitaka xu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125142619500.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/","path":"2022/11/25/MySQL学习笔记高可用篇/","title":"MySQL学习笔记高可用篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL学习笔记高可用篇 | Hexo</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%A5%E5%BF%97"><span class="nav-number">1.</span> <span class="nav-text">数据库日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%EF%BC%88slow-query-log%EF%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">慢查询日志（slow query log）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%EF%BC%88general-query-log%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">通用查询日志（general query log）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%EF%BC%88error-log%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">错误日志（error log）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97%EF%BC%88binlog%EF%BC%89"><span class="nav-number">1.4.</span> <span class="nav-text">二进制日志（binlog）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">1.4.1.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E6%9C%BA%E5%88%B6"><span class="nav-number">1.4.2.</span> <span class="nav-text">写入机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#binlog%E5%92%8Credolog%E5%AF%B9%E6%AF%94"><span class="nav-number">1.4.3.</span> <span class="nav-text">binlog和redolog对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="nav-number">1.4.4.</span> <span class="nav-text">二阶段提交</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E7%BB%A7%E6%97%A5%E5%BF%97%EF%BC%88relay-log%EF%BC%89"><span class="nav-number">1.5.</span> <span class="nav-text">中继日志（relay log）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%BD%9C%E7%94%A8"><span class="nav-number">2.1.</span> <span class="nav-text">主从复制作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">2.2.</span> <span class="nav-text">主从复制的原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="nav-number">2.3.</span> <span class="nav-text">准备环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text">主机配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">2.5.</span> <span class="nav-text">从机配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%BB%BA%E7%AB%8B%E8%B4%A6%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83"><span class="nav-number">2.6.</span> <span class="nav-text">主机建立账户并授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E4%BB%8E%E6%9C%BA"><span class="nav-number">2.7.</span> <span class="nav-text">操作从机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E5%90%8C%E6%AD%A5"><span class="nav-number">2.7.1.</span> <span class="nav-text">停止同步</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">数据一致性问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%951%EF%BC%9A%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">3.0.1.</span> <span class="nav-text">方法1：异步复制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%952%EF%BC%9A%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">3.1.</span> <span class="nav-text">方法2：半同步复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD"><span class="nav-number">4.</span> <span class="nav-text">数据库备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%A4%87%E4%BB%BD%E4%B8%8E%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD"><span class="nav-number">4.1.</span> <span class="nav-text">物理备份与逻辑备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD"><span class="nav-number">4.2.</span> <span class="nav-text">逻辑备份</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%81%A2%E5%A4%8D"><span class="nav-number">4.2.1.</span> <span class="nav-text">数据库恢复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%A4%87%E4%BB%BD"><span class="nav-number">4.3.</span> <span class="nav-text">物理备份</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8%E7%9A%84%E5%AF%BC%E5%87%BA%E4%B8%8E%E5%AF%BC%E5%85%A5"><span class="nav-number">5.</span> <span class="nav-text">表的导出与导入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E7%9A%84%E5%AF%BC%E5%87%BA"><span class="nav-number">5.1.</span> <span class="nav-text">表的导出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="nav-number">6.</span> <span class="nav-text">数据库迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">6.1.</span> <span class="nav-text">注意点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AF%E6%93%8D%E4%BD%9C%E5%90%8E%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C"><span class="nav-number">7.</span> <span class="nav-text">误操作后的一些操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AF%E5%88%A0%E8%A1%8C%E6%95%B0%E6%8D%AE"><span class="nav-number">7.1.</span> <span class="nav-text">误删行数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AF%E5%88%A0%E5%BA%93%E3%80%81%E8%A1%A8"><span class="nav-number">7.2.</span> <span class="nav-text">误删库、表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AF%E5%88%A0MySQL%E5%AE%9E%E4%BE%8B"><span class="nav-number">7.3.</span> <span class="nav-text">误删MySQL实例</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">保持积累，保持学习。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaoyeshiyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="保持积累，保持学习。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL学习笔记高可用篇 | Hexo">
      <meta itemprop="description" content="这是学习MySQL的笔记高可用篇，主要包含日志、主从复制、备份和恢复。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL学习笔记高可用篇
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-25 00:00:00" itemprop="dateCreated datePublished" datetime="2022-11-25T00:00:00+08:00">2022-11-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-01 15:49:49" itemprop="dateModified" datetime="2023-03-01T15:49:49+08:00">2023-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/" itemprop="url" rel="index"><span itemprop="name">databse</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/develope/" itemprop="url" rel="index"><span itemprop="name">develope</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/databse/develope/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
    <span id="/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL学习笔记高可用篇" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan: </span>
    
    <a title="MySQL学习笔记高可用篇" href="/2022/11/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AF%87/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::5e2230e9a9133810a0091b6d745f4166" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description">这是学习MySQL的笔记高可用篇，主要包含日志、主从复制、备份和恢复。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="数据库日志"><a href="#数据库日志" class="headerlink" title="数据库日志"></a>数据库日志</h2><p>除了前面在用于支持事务的<code>redo log</code>和<code>undo log</code>，数据库系统还有其他的日志。例如系统运行过程中的错误日志、同步日志等。</p>
<p>MySQL 8.0官网日志地址：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-logs.html">https://dev.mysql.com/doc/refman/8.0/en/server-logs.html</a></p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221125142619500.png" alt="image-20221125142619500"></p>
<p>日志的分类：</p>
<ul>
<li><code>Slow query log</code>：慢查询日志，记录所有执行时间超过 <code>long_query_time</code> 的所有查询，方便对查询进行优化</li>
<li><code>General query log</code>：通用查询日志，记录所有连接的其实时间和终止时间，以及连接发送给数据库服务器的所有指令，对复原操作的实际场景、发现问题，甚至是对数据库操作的审计都有很大的帮助</li>
<li><code>Error log</code>：记录MySQL服务的启动、运行或停止MySQL服务时出现的问题，方便了解服务器状态，从而维护服务器</li>
<li><code>Binary log</code>：二进制日志，记录所有更改数据的语句（可选择是语句还是修改数据的行数），可以用于主从服务器之间的数据同步，以及服务器遇到故障时数据的无损失恢复</li>
<li><code>Relay log</code>：中继日志，用于主从服务器架构中，从服务器用来存放主服务器二进制日志内容的一个中间文件。从服务器通过读取终极日志的内容，来同步主服务器上的操作</li>
<li><code>DDL log</code>：数据定义语句日志：记录数据定义语句执行的元数据操作。</li>
</ul>
<p>除了二进制文件外，其他日志都是文本文件。默认情况下，所有日志创建与<code>MySQL</code>数据目录中。</p>
<p>日志的弊端：</p>
<ul>
<li>日志会降低MySQL数据库的性能</li>
<li>日志会占用大量的磁盘空间</li>
</ul>
<h3 id="慢查询日志（slow-query-log）"><a href="#慢查询日志（slow-query-log）" class="headerlink" title="慢查询日志（slow query log）"></a>慢查询日志（slow query log）</h3><p>详细使用：<a href="https://www.xiaoyeshiyu.com/2022/11/15/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E7%B4%A2%E5%BC%95%E7%AF%87/">定位执行慢的SQL：慢查询日志</a></p>
<h3 id="通用查询日志（general-query-log）"><a href="#通用查询日志（general-query-log）" class="headerlink" title="通用查询日志（general query log）"></a>通用查询日志（general query log）</h3><p>通用查询日志用来记录用户的所有操作，包括启动和关闭MySQL服务、所有用户的连接开始时间和截止时间、发给MySQL数据库服务器的所有SQL指令等。当数据发生异常时，查看通用查询日志，还原操作时的具体场景，帮助定位问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看通用查询日志  </span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%general%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+---------------------------------+</span></span><br><span class="line"><span class="operator">|</span> general_log      <span class="operator">|</span> OFF                             <span class="operator">|</span>     <span class="comment">-- 开关 </span></span><br><span class="line"><span class="operator">|</span> general_log_file <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span><span class="number">87e36</span>d56e6fe.log <span class="operator">|</span>     <span class="comment">-- 日志存放位置</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+---------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 打开  </span></span><br><span class="line"><span class="comment">-- 永久性打开需改配置文件即可 </span></span><br><span class="line"><span class="comment">-- 临时 </span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log<span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<p>例如查看表中的数据和删除记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.511669</span>Z	   <span class="number">32</span> Query	<span class="keyword">SET</span> PROFILING <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.518526</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.532349</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.543366</span>Z	   <span class="number">32</span> Query	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student  <span class="comment">-- 查询操作 </span></span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.548264</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.559547</span>Z	   <span class="number">32</span> Query	<span class="keyword">SELECT</span> QUERY_ID, <span class="built_in">SUM</span>(DURATION) <span class="keyword">AS</span> SUM_DURATION <span class="keyword">FROM</span> INFORMATION_SCHEMA.PROFILING <span class="keyword">GROUP</span> <span class="keyword">BY</span> QUERY_ID</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">06.561674</span>Z	   <span class="number">32</span> Query	<span class="keyword">SELECT</span> STATE <span class="keyword">AS</span> `Status`, ROUND(<span class="built_in">SUM</span>(DURATION),<span class="number">7</span>) <span class="keyword">AS</span> `Duration`, CONCAT(ROUND(<span class="built_in">SUM</span>(DURATION)<span class="operator">/</span><span class="number">0.001319</span><span class="operator">*</span><span class="number">100</span>,<span class="number">3</span>), <span class="string">&#x27;&#x27;</span>) <span class="keyword">AS</span> `Percentage` <span class="keyword">FROM</span> INFORMATION_SCHEMA.PROFILING <span class="keyword">WHERE</span> QUERY_ID<span class="operator">=</span><span class="number">2</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> SEQ, STATE <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.764407</span>Z	   <span class="number">32</span> Query	<span class="keyword">SET</span> PROFILING <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.765769</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.773061</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.779955</span>Z	   <span class="number">32</span> Query	<span class="keyword">DELETE</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>  <span class="comment">-- 删除操作 </span></span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.789336</span>Z	   <span class="number">32</span> Query	<span class="keyword">SHOW</span> STATUS</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.800005</span>Z	   <span class="number">32</span> Query	<span class="keyword">SELECT</span> QUERY_ID, <span class="built_in">SUM</span>(DURATION) <span class="keyword">AS</span> SUM_DURATION <span class="keyword">FROM</span> INFORMATION_SCHEMA.PROFILING <span class="keyword">GROUP</span> <span class="keyword">BY</span> QUERY_ID</span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">11</span>:<span class="number">20.804624</span>Z	   <span class="number">32</span> Query	<span class="keyword">SELECT</span> STATE <span class="keyword">AS</span> `Status`, ROUND(<span class="built_in">SUM</span>(DURATION),<span class="number">7</span>) <span class="keyword">AS</span> `Duration`, CONCAT(ROUND(<span class="built_in">SUM</span>(DURATION)<span class="operator">/</span><span class="number">0.000655</span><span class="operator">*</span><span class="number">100</span>,<span class="number">3</span>), <span class="string">&#x27;&#x27;</span>) <span class="keyword">AS</span> `Percentage` <span class="keyword">FROM</span> INFORMATION_SCHEMA.PROFILING <span class="keyword">WHERE</span> QUERY_ID<span class="operator">=</span><span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> SEQ, STATE <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 关闭日志 </span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log<span class="operator">=</span>off;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭之后，日志也会记录操作，但是关闭之后的操作日志就不会记录</span></span><br><span class="line"><span class="number">2022</span><span class="number">-11</span><span class="number">-27</span>T12:<span class="number">13</span>:<span class="number">33.071206</span>Z	   <span class="number">32</span> Query	<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log<span class="operator">=</span>off</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除、刷新日志</span></span><br><span class="line"><span class="comment">-- 用于回收空间或者将日志归档 </span></span><br><span class="line"><span class="comment">-- 状态改成  on</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log<span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在shell中操作，将原先的日志文件删除或者备份，执行命令之后会重新生成一个新的日志文件</span></span><br><span class="line">mysqladmin -uroot -p flush-logs</span><br></pre></td></tr></table></figure>

<h3 id="错误日志（error-log）"><a href="#错误日志（error-log）" class="headerlink" title="错误日志（error log）"></a>错误日志（error log）</h3><p>记录出现的错误、警告和提示等。</p>
<p>错误日志默认是开启的，而且错误日志无法被禁止。默认路径是<code>mysqld.log</code>（Linux系统）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_err%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name              <span class="operator">|</span> <span class="keyword">Value</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_error                  <span class="operator">|</span> stderr                                 <span class="operator">|</span> <span class="comment">-- 日志存放地方</span></span><br><span class="line"><span class="operator">|</span> log_error_services         <span class="operator">|</span> log_filter_internal; log_sink_internal <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_error_suppression_list <span class="operator">|</span>                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_error_verbosity        <span class="operator">|</span> <span class="number">2</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat 87e36d56e6fe.err</span><br><span class="line">2022-10-15T16:02:22.224566Z 0 [Warning] [MY-011068] [Server] The syntax &#x27;--skip-host-cache&#x27; is deprecated and will be removed in a future release. Please use SET GLOBAL host_cache_size=0 instead.</span><br><span class="line">2022-10-15T16:02:22.226445Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.31) starting as process 131</span><br><span class="line">2022-10-15T16:02:22.237472Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2022-10-15T16:02:22.335308Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2022-10-15T16:02:22.517693Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.</span><br><span class="line">2022-10-15T16:02:22.517716Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.</span><br><span class="line">2022-10-15T16:02:22.519052Z 0 [Warning] [MY-011810] [Server] Insecure configuration for --pid-file: Location &#x27;/var/run/mysqld&#x27; in the path is accessible to all OS users. Consider choosing a different directory.</span><br><span class="line">2022-10-15T16:02:22.527760Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: /var/run/mysqld/mysqlx.sock</span><br><span class="line">2022-10-15T16:02:22.527771Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: &#x27;8.0.31&#x27;  socket: &#x27;/var/run/mysqld/mysqld.sock&#x27;  port: 0  MySQL Community Server - GPL.</span><br><span class="line">2022-10-15T16:02:24.497294Z 10 [System] [MY-013172] [Server] Received SHUTDOWN from user root. Shutting down mysqld (Version: 8.0.31).</span><br><span class="line">2022-10-15T16:02:26.130206Z 0 [System] [MY-010910] [Server] /usr/sbin/mysqld: Shutdown complete (mysqld 8.0.31)  MySQL Community Server - GPL.</span><br></pre></td></tr></table></figure>

<p>删除、刷新过程，与上面一样，重命名之后。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 首先需要执行，然后再刷新。这是由于MySQL新版本备份操作要多做一步。</span><br><span class="line">install -omysql -gmysql -m0644 /dev/null /var/log/mysqld.log</span><br><span class="line">mysqladmin -uroot -p flush-logs</span><br></pre></td></tr></table></figure>

<h3 id="二进制日志（binlog）"><a href="#二进制日志（binlog）" class="headerlink" title="二进制日志（binlog）"></a>二进制日志（binlog）</h3><p>二进制日志，也就是 <code>binary log</code>，也做叫变更日志（<code>update log</code>），记录了数据库所有执行的<code>DDL</code>和<code>DML</code>等数据库更新事件的语句，但是不包含没有修改任何数据的语句。</p>
<p>主要应用场景：</p>
<ul>
<li>用于数据恢复</li>
<li>用于数据复制，主从复制中<code>master</code>将二进制日志传递给<code>slaves</code>来达到<code>master-slave</code>数据一致的目的</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>MySQL数据库的数据备份、主备、主主、主从都离不开<code>binlog</code>，都需要依靠<code>binlog</code>来同步数据，保证数据一致性。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                          <span class="operator">|</span>		<span class="comment">-- 开关</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>binlog       <span class="operator">|</span>		<span class="comment">-- 日志名称</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>binlog.index <span class="operator">|</span>		<span class="comment">-- 日志索引文件 </span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                         <span class="operator">|</span>		<span class="comment">-- 是否信任存储函数</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql 639M Nov 21 01:27  binlog.000013	-- 重启一次就会新生成一个</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql  180 Nov 21 05:52  binlog.000014</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql  13K Nov 24 02:52  binlog.000015</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql 1.2K Nov 24 03:48  binlog.000016</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----  1 mysql mysql  180 Nov 24 03:51  binlog.000017</span></span><br></pre></td></tr></table></figure>

<p>修改配置，持久化修改需要修改 <code>my.cnf</code> 配置文件，临时修改改配置文件，而且只能用<code>session</code>级别。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志存放名称</span></span><br><span class="line">log-bin=mitaka-bin </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件保留时长，单位是s</span></span><br><span class="line">binlog_expire_logs=60000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">控制二进制文件大小，超过时，执行切换动作。最大和默认值都是1GB。</span></span><br><span class="line">max_binlog_size=300M</span><br></pre></td></tr></table></figure>

<p>数据库文件最好不要与二进制文件放在同一个磁盘上，避免磁盘损坏导致数据无法恢复。使用新的目录要修改目录所属用户和所属用户组。</p>
<p>查看日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name      <span class="operator">|</span> File_size <span class="operator">|</span> Encrypted <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000008</span> <span class="operator">|</span> <span class="number">327952480</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000009</span> <span class="operator">|</span>     <span class="number">19174</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000010</span> <span class="operator">|</span>     <span class="number">32499</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000011</span> <span class="operator">|</span>     <span class="number">46652</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000012</span> <span class="operator">|</span>      <span class="number">1933</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000013</span> <span class="operator">|</span> <span class="number">670026047</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000014</span> <span class="operator">|</span>       <span class="number">180</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000015</span> <span class="operator">|</span>     <span class="number">13276</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000016</span> <span class="operator">|</span>      <span class="number">1127</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000017</span> <span class="operator">|</span>       <span class="number">180</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000018</span> <span class="operator">|</span>     <span class="number">13712</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000019</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000020</span> <span class="operator">|</span>       <span class="number">157</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="number">13</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>查看日志具体信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog &quot;/var/bin/log/binlog.000020&quot;</span><br></pre></td></tr></table></figure>

<p>查看到的日志具体数据都是二进制的，通过参数 <code>-v</code>可以看到具体操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v &quot;/var/bin/log/binlog.000020&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127205519810.png" alt="image-20221127205519810"></p>
<p><code>binlog</code>一些用法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看帮助</span></span><br><span class="line">mysqlbinlog --no-defaults --help </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看最后100行</span></span><br><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -vv binlog.000020 | tail -100</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据position查找</span></span><br><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -vv binlog.000020 | grep -A 20 &#x27;123345&#x27;</span><br></pre></td></tr></table></figure>

<p>更方便的查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> binlog events [<span class="keyword">IN</span> <span class="string">&#x27;log_name&#x27;</span>] [<span class="keyword">from</span> pos] [limit [<span class="keyword">offset</span>,] row_count];</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[IN &#39;log_name&#39;]</code>：指定查询binlog文件名</li>
<li><code>[from pos]</code>：指定从哪个pos起始点开始查</li>
<li><code>limit [offset,]</code>：偏移量</li>
<li><code>row_count</code>：查询总条数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">IN</span> <span class="string">&#x27;binlog.000020&#x27;</span> limit <span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----+----------------+-----------+-------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name      <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----+----------------+-----------+-------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000020</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>         <span class="number">126</span> <span class="operator">|</span> Server ver: <span class="number">8.0</span><span class="number">.31</span>, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000020</span> <span class="operator">|</span> <span class="number">126</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>         <span class="number">157</span> <span class="operator">|</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----+----------------+-----------+-------------+-----------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><code>binlog</code>格式查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%binlog_format%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> binlog_format <span class="operator">|</span> <span class="type">ROW</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Statement</code>：每一条会修改数据的sql都会记录在<code>binlog</code>中。</li>
<li><code>Row</code>：不记录sql语句上下文相关信息，仅保存记录被修改的信息</li>
<li><code>Mixed</code>：<code>Statement</code>和<code>Row</code>的结合</li>
</ul>
<p>使用<code>binlog</code>恢复数据，例如误删除一些操作，此时可以使用<code>binlog</code>将误删除的数据恢复出来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 先刷新日志，创建出一个新的二进制日志文件，避免单个文件写入又读取</span></span><br><span class="line"><span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="comment">-- 读取老的二进制文件读取数据</span></span><br><span class="line"><span class="comment">-- 如果使用pos的方式恢复，则使用 show events 的方式</span></span><br><span class="line"><span class="comment">-- 如果使用时间的方式恢复，则使用 mysqlbinlog 的方式</span></span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;binlog.000020&#x27;</span></span><br><span class="line"><span class="comment">-- 获取恢复数据段的上一个BEGIN为开始，下一个BEGIN为结束</span></span><br></pre></td></tr></table></figure>

<p>恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-position=100 --stop-position=800 --database=dbtest2 /var/lib/mysql/binlog.000020 | mysql -uroot -p123456 -v student;</span><br></pre></td></tr></table></figure>

<p>起止时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog <span class="comment">--start-datetime=&quot;2022-11-27 21:00:00&quot; --stop-datetime=&quot;2022-11-27 21:01:00&quot; --database=dbtest2 /var/lib/mysql/binlog.000020 | mysql -uroot -p123456 -v student;</span></span><br></pre></td></tr></table></figure>

<p>删除二进制文件</p>
<p>可以选择部分删除或者全部都删</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- PURGE MASTER LOGS：删除指定 ,将11 之前（不包含11）的都删掉</span></span><br><span class="line">PURGE MASTER LOGS <span class="keyword">TO</span> <span class="string">&#x27;binlog.000011&#x27;</span>;</span><br><span class="line"><span class="comment">-- 通过时间删除</span></span><br><span class="line">PURGE MASTER LOGS BEFORE <span class="string">&#x27;20221127&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>全部删除，（<strong>慎用</strong>）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RESET MASTER;</span><br><span class="line"><span class="comment">-- 删除之后，只能看到一个binlog</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name      <span class="operator">|</span> File_size <span class="operator">|</span> Encrypted <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">157</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="写入机制"><a href="#写入机制" class="headerlink" title="写入机制"></a>写入机制</h4><p><code>binlog</code>是在事务执行过程中，先将<code>binlog</code>写入<code>binlog cache</code>，再提交事务，再把<code>binlog cache</code>写到<code>binlog</code>文件中。因为一个事务的<code>binlog</code>不能被拆开，无论这个事务多大，也要确保一次性写入，所以系统会给每个线程分配一个块内存作为<code>binlog cache</code>。</p>
<p>可以通过 <code>binlog_cache_size</code> 参数控制单个线程<code>binlog cache</code>大小，存储内容超过这个参数，就会暂存到磁盘。</p>
<p>刷盘流程：</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212122996.png" alt="image-20221127212122996"></p>
<p><code>write</code>是将<code>binlog cache</code>写入<code>page cache</code>，<code>fsync</code>是将<code>page cache</code>同步到磁盘。</p>
<p><code>write</code>和<code>fsync</code>的时机可以由参数 <code>sync_binlog</code> 控制，默认是<code>0</code>，代表每次提交事务都只<code>write</code>，由系统判断<code>fsync</code>的执行时机。性能会提升，但是可能有丢失数据的风险</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212426155.png" alt="image-20221127212426155"></p>
<p>为了安全，可以设置为1，每次提交事务都会执行<code>fsycn</code>，如同<code>redo log</code>刷盘流程一样。</p>
<p>也可以改成<code>N(&gt;1)</code>，每次提交事务都<code>write</code>，积累N个事务之后才<code>fsync</code>。性能更高，但是风险也更高。</p>
<h4 id="binlog和redolog对比"><a href="#binlog和redolog对比" class="headerlink" title="binlog和redolog对比"></a><code>binlog</code>和<code>redolog</code>对比</h4><ul>
<li><code>redo log</code>是物理日志，记录的是某个数据页上的改动，属于<code>InnoDB</code>存储引擎产生的</li>
<li><code>bin log</code>是逻辑日志，记录语句的原始逻辑，属于<code>MySQL server</code>层</li>
<li>都可以持久化，但是侧重点不同<ul>
<li><code>redo log</code>让<code>InnoDB</code>存储引擎有了崩溃恢复能力</li>
<li><code>bin log</code>保证MySQL集群架构的数据一致性</li>
</ul>
</li>
</ul>
<h4 id="二阶段提交"><a href="#二阶段提交" class="headerlink" title="二阶段提交"></a>二阶段提交</h4><p>更新语句会更新<code>redo log</code>和<code>bin log</code>，以基本事务为单位，<code>redo log</code>在事务执行过程中可以不断写入，<code>bin log</code>只有在事务提交才会写入</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212912578.png" alt="image-20221127212912578"></p>
<p>如果两份日志不一致，会出现什么问题？</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127212958101.png" alt="image-20221127212958101"></p>
<p><code>bin log</code>没写完就异常，而 <code>redo log</code>正常，恢复之后，会出现 <code>c</code> 这一行的数据不一致。</p>
<p>此时，通过<code>bin log</code>做数据同步，数据会不一致。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213116014.png" alt="image-20221127213116014"></p>
<p>为了解决数据之间不一致的问题，InnoDB存储引擎使用两阶段提交的方案，原理是将<code>redo log</code>的写入拆成两个步骤，<code>prepare</code>和<code>commit</code>，这就是两阶段提交 </p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213241645.png" alt="image-20221127213241645"></p>
<p>通过<code>redo log</code>恢复数据时，发现<code>redo log</code>处于<code>prepare</code>阶段，并且没有对应binlog日志，就会回滚该事务</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213435259.png" alt="image-20221127213435259"></p>
<p>如果是 <code>redo log</code>设置<code>commit</code>阶段发生异常，此时就不会回滚，虽然<code>redo log</code>处于<code>prepare</code>阶段，但是能通过事务<code>id</code>找到对应的<code>binlog</code>，所以MySQL认为是完整的，就会提交事务恢复数据。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213527435.png" alt="image-20221127213527435"></p>
<h3 id="中继日志（relay-log）"><a href="#中继日志（relay-log）" class="headerlink" title="中继日志（relay log）"></a>中继日志（relay log）</h3><p><strong>中继日志只在主从服务器架构中的从服务器上存在</strong>。例如一主一从架构中，为了与主服务保持一致，需要从服务器读取二进制的内容，并且把读取到的信息写入本地的日志文件中，这个就是<strong>中继日志</strong>。然后从服务器读取中继日志，数据更新，完成数据同步。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127213809370.png" alt="image-20221127213809370"></p>
<p>文件格式是 <code>从服务器名-relay-bin.序号</code>。中继日志还有一个索引文件：<code>从服务器名-relay-bin.index</code>，用来定位当前使用的中继日志。</p>
<p>查看方式可以使用<code>mysqlbinlog</code></p>
<p>如果从服务器宕机，并且从服务器宕机，从中继日志恢复数据，可能导致数据不一致，这可能由于日志中的从服务器名不一致。</p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>提升数据库的并发能力常常会采用<code>redis</code>作为缓存与MySQL配合使用，可以提高读取的效率，也降低数据库的压力。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127214552686.png" alt="image-20221127214552686"></p>
<p>一般应用对数据库而言都是<strong>读多写少</strong>，也就是对数据库读取数据的压力比较大，这个时候就可以通过主从架构、进行读写分离，提升服务器的读取能力。</p>
<p>但是数据库调优的过程，是先从成本考虑，从成本低到成本高，因此，从硬件方面实现主从架构，是最后的方案</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215004563.png" alt="image-20221127215004563"></p>
<h3 id="主从复制作用"><a href="#主从复制作用" class="headerlink" title="主从复制作用"></a>主从复制作用</h3><ul>
<li><p>读写分离</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215122649.png" alt="image-20221127215122649"></p>
<p>其中一个是Master主库，负责写入数据，称之为写库</p>
<p>其他都是Slave从库，负责读取数据，称之为读库。</p>
<p>这种方式可以实现更高的并发访问，不仅可负载均衡，还减少了锁表的影响，当主库负责写，主库出现写锁的时候，不影响从库读取。</p>
</li>
<li><p>数据备份</p>
<p>将数据从主库复制到从库，相当于是一种热备。</p>
</li>
<li><p>具有高可用性</p>
<p>是一种冗余的机制，通过这种冗余的机制，可以换取数据库的高可用性，当服务器出现故障或者宕机的情况下，可以切换到从服务器上。</p>
</li>
</ul>
<h3 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h3><p><code>Slave</code>会从<code>Master</code>读取<code>bin log</code>来同步。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215450293.png" alt="image-20221127215450293"></p>
<p>实际上是有三个线程：</p>
<p>主库<strong>二进制转储线程</strong>将二进制发送给从库，主库读取时间的时候，会在<code>binlog</code>上加锁，读取完成之后，再将锁释放。</p>
<p>从库**<code>I/O</code>线程**会连接主库，向主库发送请求更新<code>binlog</code>，从库的<code>I/O</code>线程将读取到主库的二进制日志转储<code>binlog</code>的更新部分，并且拷贝到本地的中继日志。</p>
<p>从库<strong>SQL线程</strong>会读取从库中的中继日志，并且执行日志中的事件，将从库中的数据与主库保持同步。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221127215729414.png" alt="image-20221127215729414"></p>
<blockquote>
<p>注意：不是所有<code>MySQL</code>版本都默认开启服务器的二进制日志，进行主从同步的时候，需要先检查服务器是否已经开启二进制日志。</p>
</blockquote>
<p>复制的最大问题，就是<strong>延迟</strong>。写入主库和读取从库中间需要时间。</p>
<p>复制的原则：</p>
<ul>
<li>每个<code>Slave</code>只有一个<code>Master</code></li>
<li>每个<code>Slave</code>只能有一个唯一的服务器ID</li>
<li>每个<code>Master</code>可以有多个<code>Slave</code></li>
</ul>
<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><p>搭建两台MySQL服务器，一主一从。</p>
<p>这里使用两个容器搭建。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 两个 UUID</span><br><span class="line">cat <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>auto.cnf</span><br></pre></td></tr></table></figure>

<h3 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h3><ul>
<li><p>必选</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">log-bin=binlog</span><br></pre></td></tr></table></figure>
</li>
<li><p>可选</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"># 0 表示读写（主机），1表示只读（从机）</span><br><span class="line">read-only=0</span><br><span class="line"># 设置日志文件保留的时长，单位是秒 </span><br><span class="line">binlog_expire_logs_seconds=6000</span><br><span class="line"># binlog日志最大大小</span><br><span class="line">max_binlog_size=200M</span><br><span class="line"># 不要复制的数据库</span><br><span class="line">binlog-ignore-db=test</span><br><span class="line"># 复制的数据库，不写默认全部</span><br><span class="line">binlog-do-db=</span><br><span class="line"># binlog格式 STATEMENT：基于SQL语句的配置 </span><br><span class="line">binlog_format=STATEMENT</span><br></pre></td></tr></table></figure>

<p><code>binlog_format</code>：<code>binlog</code>格式</p>
<ul>
<li><p><code>STATEMENT</code>：默认，基于SQL语句的复制，每一条会修改数据的SQL语句都会记录到<code>binlog</code>中。（例如<code>INSERT ... SELECT</code>，记录的语句）。</p>
<p>优点是减少<code>binlog</code>日志，包含所有数据库的更改信息，可以实时还原，二不仅仅是复制。</p>
<p>缺点是不是所有UPDATE语句都可以被复制，例如<code>UUID</code>这样的函数；会产生更多的行级锁；复杂语句会消耗更多资源；</p>
</li>
<li><p><code>ROW</code>：基于行的格式，不记录每条SQL语句的上下文信息，仅记录哪条数据被修改了，修改成什么样。（例如<code>INSERT ... SELECT</code>，记录的插入的数据）。</p>
<p>优点是安全可靠；可以采用多线程执行复制</p>
<p>缺点：日志大；复杂的回滚binlog中会包含大量的数据；</p>
</li>
<li><p><code>MIXED</code>：二者集合</p>
<p>一般的语句修改使用<code>STATEMENT</code>格式保存<code>binlog</code>。</p>
<p>比如一些函数，<code>STATEMENT</code>无法完成主从复制，则采用row格式保存<code>binlog</code>。</p>
</li>
</ul>
</li>
</ul>
<h3 id="从机配置"><a href="#从机配置" class="headerlink" title="从机配置"></a>从机配置</h3><ul>
<li><p>必选</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>可选</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 启用中继日志</span><br><span class="line">relay-log=mysql-relay</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="主机建立账户并授权"><a href="#主机建立账户并授权" class="headerlink" title="主机建立账户并授权"></a>主机建立账户并授权</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;slave1&#x27;</span>@<span class="string">&#x27;172.17.0.3&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;slave1&#x27;</span>@<span class="string">&#x27;172.17.0.3&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;slave1&#x27;</span>@<span class="string">&#x27;172.17.0.3&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>查询master状态，并记录<code>File</code>和<code>Position</code>信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File          <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog<span class="number">.000002</span> <span class="operator">|</span>     <span class="number">1192</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="操作从机"><a href="#操作从机" class="headerlink" title="操作从机"></a>操作从机</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;172.17.0.2&#x27;</span>,MASTER_USER<span class="operator">=</span><span class="string">&#x27;slave1&#x27;</span>,MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>,MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;binlog.000002&#x27;</span>,MASTER_LOG_POS<span class="operator">=</span><span class="number">1192</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">7</span> warnings (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure>

<p>如果出现一些报错，例如前面配置过从机，则需要停止从机，然后再<code>CHANGE MASTER ...</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;</span><br></pre></td></tr></table></figure>

<p>启动<code>slave</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p>如果启动报错，可能是由于已经有<code>relay_log</code>，此时<code>reset</code>，然后重新<code>CHANGE MASTER ...</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RESET SLAVE;</span><br></pre></td></tr></table></figure>

<p>查看从机状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> source <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">                  Master_User: slave1</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: binlog<span class="number">.000002</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">3656</span></span><br><span class="line">               Relay_Log_File: mysql<span class="operator">-</span>relay<span class="number">.000003</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">323</span></span><br><span class="line">        Relay_Master_Log_File: binlog<span class="number">.000002</span></span><br><span class="line">             Slave_IO_Running: Yes						<span class="comment">-- 两个 yes 说明同步成功</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">3656</span></span><br><span class="line">              Relay_Log_Space: <span class="number">3159</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">1</span></span><br><span class="line">                  Master_UUID: bebe4f0f<span class="number">-4</span>ca2<span class="number">-11</span>ed<span class="operator">-</span>afe3<span class="number">-0242</span>ac110003</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: <span class="keyword">NULL</span></span><br><span class="line">      Slave_SQL_Running_State: Replica has read <span class="keyword">all</span> relay log; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Master_Retry_Count: <span class="number">86400</span></span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: <span class="number">0</span></span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">       Master_public_key_path:</span><br><span class="line">        Get_master_public_key: <span class="number">0</span></span><br><span class="line">            Network_Namespace:</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>主库操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database dbtest10;</span><br><span class="line">use dbtest10;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">15</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>从库操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> dbtest10           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">use dbtest10;</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_dbtest10 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> a    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>可以看到同步成功。</p>
<h4 id="停止同步"><a href="#停止同步" class="headerlink" title="停止同步"></a>停止同步</h4><p>停止同步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br></pre></td></tr></table></figure>

<p>重新配置主从，需要在主机上执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除master中所有binlog文件，将日志索引清空，重新开始所有新的日志文件（慎用）</span></span><br><span class="line">reset master;  </span><br></pre></td></tr></table></figure>

<h2 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h2><p>主从同步的要求：</p>
<ul>
<li>读库和写库的数据一致（最终一致）；</li>
<li>写数据必须写到写库；</li>
<li>读数据必读到读库（不一定）；</li>
</ul>
<h4 id="方法1：异步复制"><a href="#方法1：异步复制" class="headerlink" title="方法1：异步复制"></a>方法1：异步复制</h4><p>异步模式就是客户端提交COMMIT之后，不需要等从库返回任何结果，而是直接将结果返回给客户端，这样的好处是不会影响主库写的效率，但是可能存在主库宕机，<code>binlog</code>还没有同步到从库的情况，也就是此时主库和从库数据不一致。这时候从从库中选择一个作为新主，那么新主则能缺少原来主服务器已提交的事务。所以，这种复制模式下的数据一致性是最弱的。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128101737619.png" alt="image-20221128101737619"></p>
<p>ps：图中<code>commit</code>在<code>binlog</code>之后，是表示系统宕机启动之后，通过<code>redo log</code>和<code>bin log</code>之后再判断这个事务是否会提交。</p>
<h3 id="方法2：半同步复制"><a href="#方法2：半同步复制" class="headerlink" title="方法2：半同步复制"></a>方法2：半同步复制</h3><p>MySQL 5.5版本之后开始支持，当客户端提交<code>COMMIT</code>之后，不直接将结果返回给客户端，而是等待至少有一个从库收到了<code>binlog</code>，并且写入中继日志中，再返回给客户端。</p>
<p>好处是提高了数据一致性，相比异步复制，至少多增加了一个网络连接的延迟，降低了主从写的效率。</p>
<p>MySQL 5.7 版本增加一个 <code>rpl_semi_sync_master_wait_for_slave_count</code> 参数，可以设置应答的从库数量，默认为1，也就是有1个从库响应，就可以返回给客户端。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128102504878.png" alt="image-20221128102504878"></p>
<p>方法3：组复制</p>
<p>异步复制和半同步复制都无法最终保证数据的一致性问题，半同步复制是通过判断从库响应的个数来决定是否返回给客户端，虽然数据一致性相比于异步复制有提升，但仍然无法满足对数据一致性要求高的场景。</p>
<p>组复制技术，简称MGR（MySQL Group Replication），基于Paxos协议的状态机复制。</p>
<p>MGR工作原理：</p>
<p>首先将多个节点组成一个复制组，在执行读写事务的时候，通过一致性协议层的同意，也就是<strong>读写（RW）事务</strong>想要进行提交，必须要经过组里“大多数人”（<code>x &gt; N/2+1</code>）的同意，才可以提交。针对<strong>只读（RO）事务</strong>，则不需要经过组内同意，直接<code>COMMIT</code>即可。</p>
<p>在一个复制组内有多个节点组成，各自维护了自己的数据副本，并且在一致性协议层实现了原子消息和全局有序消息，从而保证组内数据的一致性。</p>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128103048825.png" alt="image-20221128103048825"></p>
<h2 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h2><p>为了有效防止数据丢失，并将损失降到最低，应定期对MySQL数据库服务器做备份，如果数据库中的数据丢失或者出现错误，可以使用备份的数据进行恢复。主从服务器之间的数据同步问题可以通过复制功能实现。</p>
<h3 id="物理备份与逻辑备份"><a href="#物理备份与逻辑备份" class="headerlink" title="物理备份与逻辑备份"></a>物理备份与逻辑备份</h3><p>物理备份：备份数据文件，转储数据库物理文件到某一目录。物理备份恢复速度快，但占用空间比较大，MySQL中可以用<code>xtrabackup</code>工具来进行物理备份。</p>
<p>逻辑备份：对数据库对象利用工具进行导出，汇总入备份文件内。逻辑备份恢复速度慢，但占用空间小，更灵活。MySQL中常用的备份工具为<code>mysqldump</code>。逻辑备份就是备份<code>sql</code>语句，在恢复的时候执行备份的<code>sql</code>语句实现数据库数据的重现。</p>
<h3 id="逻辑备份"><a href="#逻辑备份" class="headerlink" title="逻辑备份"></a>逻辑备份</h3><p><code>mysqldump</code>执行时，可以即将数据库备份成一个<strong>文本文件</strong>，包含多个<code>CREATE</code>和<code>INSERT</code>语句，使用这些语句可以重新创建表和插入数据。</p>
<ul>
<li>查出需要备份的表的结构，在文本文件中生成一个<code>CREATE</code>语句</li>
<li>将表中的所有记录转换成一条<code>INSERT</code>语句</li>
</ul>
<p>基本语法:</p>
<p>备份指定数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 &gt; dbtest2_bak.sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>

<p>备份出来的 <code>dbtest2_bak.sql</code>可以直接查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 截取部分</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Table structure for table `account`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `account`;</span><br><span class="line"><span class="comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;</span><br><span class="line"><span class="comment">/*!50503 SET character_set_client = utf8mb4 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `account` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `NAME` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `balance` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"><span class="comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Dumping data for table `account`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line">LOCK TABLES `account` WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `account` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `account` <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="number">400.00</span>),(<span class="number">2</span>,<span class="string">&#x27;李四&#x27;</span>,<span class="number">1000.00</span>),(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">100.00</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `account` ENABLE KEYS */</span>;</span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<p>备份全部数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 --all_databases &gt; all_databases_bak.sql</span><br></pre></td></tr></table></figure>

<p>备份多个数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 --databases dbtest2 dbtest &gt; dbtest2_dbtest1_bak.sql</span><br></pre></td></tr></table></figure>

<p>备份部分表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 account student &gt; dbtest2_account_student_bak.sql</span><br></pre></td></tr></table></figure>

<p>备份单表中的部分数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 account --where=&quot;id &lt; 2&quot; &gt; dbtest2_account_id2_low_bak.sql</span><br></pre></td></tr></table></figure>

<p>排除某些表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 --ignore-table=dbtest2.account &gt; dbtest2_excloud_account_bak.sql</span><br></pre></td></tr></table></figure>

<p>只备份表结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 --no-data &gt; dbtest2_nodata.sql</span><br></pre></td></tr></table></figure>

<p>只备份数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 --no-create-info &gt; dbtest2_no_table.sql</span><br></pre></td></tr></table></figure>

<p>备份包含存储过程、函数、事件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看函数和存储过程</span></span><br><span class="line"><span class="keyword">SELECT</span> SPECIFIC_NAME,ROUTINE_TYPE <span class="keyword">FROM</span> information_schema.ROUTINES <span class="keyword">WHERE</span> routine_schema<span class="operator">=</span><span class="string">&#x27;mitaka&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><code>-R</code> ：备份存储过程和函数</p>
<p><code>-E</code>：备份事件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 -R -E mitaka  &gt; mitaka_func.sql</span><br></pre></td></tr></table></figure>

<p>备份结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER ;;</span><br><span class="line"><span class="keyword">CREATE</span> DEFINER<span class="operator">=</span>`root`@`<span class="operator">%</span>` <span class="keyword">PROCEDURE</span> `test_pro1`()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 设置用户变量</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 	fname有非空约束</span></span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line"><span class="comment">-- 	验证报错后执行的变量是否会声明成功</span></span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@y</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> fname <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span> <span class="keyword">WHERE</span> emp_id <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">SET</span> <span class="variable">@z</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">END</span> ;;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h4 id="数据库恢复"><a href="#数据库恢复" class="headerlink" title="数据库恢复"></a>数据库恢复</h4><p>恢复时，通过备份出的<code>.sql</code>文件，用<code>mysql</code>命令恢复</p>
<p>单库备份中恢复单库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 既可以恢复到原先的库中，没有指定库名，就恢复到原先的数据库中</span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 &lt; dbtest2_bak.sql</span><br><span class="line"></span><br><span class="line">-- 也可以通过指定库名，恢复到新的库中 </span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 -e &quot;create database dbtest2_bak&quot;</span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 dbtest2_bak &lt; dbtest2_bak.sql</span><br></pre></td></tr></table></figure>

<p>全量恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 &lt; all_databases_bak.sql</span><br></pre></td></tr></table></figure>

<p>从全量备份中恢复单个数据库，从全局的sql文件中提取部分数据库的数据，放到一个新的文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n &#x27;/^-- Current Database: `dbtest`/,/^-- Current Database: `/p&#x27; all_databases_bak.sql &gt; dbtest_bak.sql</span><br></pre></td></tr></table></figure>

<p>然后再恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 &lt; dbtest_bak.sql</span><br></pre></td></tr></table></figure>

<p>从单库备份中恢复单表 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 表结构</span><br><span class="line">cat all_databases_bak.sql | sed -e &#x27;/./&#123;H;$!d;&#125;&#x27; -e &#x27;x;/CREATE TABLE `student`/!d;q&#x27; &gt; student_structure.sql</span><br><span class="line">-- 表数据</span><br><span class="line">cat all_databases_bak.sql | grep --ignore-case &#x27;insert into `student`&#x27; &gt; student_data.sql</span><br></pre></td></tr></table></figure>

<p>然后再恢复 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在sql中通过source命令恢复 </span></span><br><span class="line">source .<span class="operator">/</span>student_structure.sql</span><br><span class="line">source .<span class="operator">/</span>student_data.sql</span><br></pre></td></tr></table></figure>

<h3 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h3><p>直接复制整个数据库，原理就是拷贝数据。</p>
<p>为了保证数据一致性：</p>
<ul>
<li>方式1：备份前，将服务器停止</li>
<li>方式2：备份前，对相关表执行 <code>FLUSH TABLES WITH READ LOCK</code> 操作</li>
</ul>
<p>这种方式方便、快速，但不是最好的备份方法，因为实际情况可能不允许停止MySQL服务器或者锁表，而且这种方法对InnoDB存储引擎的表不适用。</p>
<p>注意，物理备份完毕后，执行<code>UNLOCK TABLES</code>来解锁。</p>
<blockquote>
<p>说明：</p>
<p>​	在MySQL版本号中，第一个数字表示主版本号，主版本号相同的MySQL数据库文件格式相同。</p>
</blockquote>
<p>此外，还可以考虑使用相关工具实现备份，比如<code>MySQLhotcopy</code>工具。<code>MySQLhotcopy</code>是一个<code>Perl</code>脚本，使用<code>LOCK TABLES</code>、<code>FLUSH TABLES</code>和<code>cp</code>或者<code>scp</code>来快速备份数据库。它是备份数据库或单个表最快的途径，但只能运行在数据库目录所在的机器上，并且只能备份<code>MyISAM</code>类型的表。</p>
<p>备份和恢复需要注意：备份和恢复的数据库版本的<strong>主版本号</strong>必须相同</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份</span></span><br><span class="line">cp dbtest10 /backup/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">恢复</span></span><br><span class="line">cp /backup/dbtest10 /var/lib/mysql/</span><br><span class="line">chown -R mysql:mysql /var/lib/mysql/dbtest10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启MySQL</span></span><br></pre></td></tr></table></figure>

<h2 id="表的导出与导入"><a href="#表的导出与导入" class="headerlink" title="表的导出与导入"></a>表的导出与导入</h2><h3 id="表的导出"><a href="#表的导出" class="headerlink" title="表的导出"></a>表的导出</h3><p>将表的数据导出到某个文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取目录位置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%secure%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> require_secure_transport <span class="operator">|</span> OFF                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> secure_file_priv         <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">-</span>files<span class="operator">/</span> <span class="operator">|</span>    <span class="comment">-- 导出文件所在目录，如果为 empty，代表不限制位置，这是不安全的设置，如果是NULL代表不允许导出</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-----------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account <span class="keyword">INTO</span> OUTFILE &quot;/var/lib/mysql-files/account1.txt&quot;;</span><br></pre></td></tr></table></figure>

<p>查看文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /var/lib/mysql-files/account1.txt</span><br><span class="line">1	张三	400.00</span><br><span class="line">2	李四	1000.00</span><br><span class="line">3	a	100.00</span><br></pre></td></tr></table></figure>

<p>或者使用<code>mysqldump</code>将数据和表结构导出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 -T &quot;/var/lib/mysql-files/&quot; dbtest2 account</span><br><span class="line"></span><br><span class="line">ls -l</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root  root  1458 Nov 28 09:13 account.sql  -- 结构</span><br><span class="line">-rw-r----- 1 mysql mysql   44 Nov 28 09:13 account.txt	-- 数据</span><br></pre></td></tr></table></figure>

<p>也可以使用<code>FIELDS</code>字段，将字段之间使用逗号 “，”间隔，所有字符类型字段值用双引号括起来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -P3306 -uroot -p123456 -T &quot;/var/lib/mysql-files/&quot; dbtest2 account --fields-terminated-by=&#x27;,&#x27; --fields-optionally-enclosed-by=&#x27;\&quot;&#x27;</span><br><span class="line"></span><br><span class="line">cat account.txt</span><br><span class="line">1,&quot;张三&quot;,400.00</span><br><span class="line">2,&quot;李四&quot;,1000.00</span><br><span class="line">3,&quot;a&quot;,100.00</span><br></pre></td></tr></table></figure>

<p>使用<code>mysql</code>语句导出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 --execute=&quot;SELECT * FROM account;&quot; dbtest2 &gt; ./account2.txt</span><br><span class="line"></span><br><span class="line">cat account2.txt</span><br><span class="line">id	NAME	balance</span><br><span class="line">1	张三	400.00</span><br><span class="line">2	李四	1000.00</span><br><span class="line">3	a	100.00</span><br><span class="line"></span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 --vertical --execute=&quot;SELECT * FROM account;&quot; dbtest2 &gt; ./account3.txt</span><br><span class="line">cat account3.txt</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">     id: 1</span><br><span class="line">   NAME: 张三</span><br><span class="line">balance: 400.00</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">     id: 2</span><br><span class="line">   NAME: 李四</span><br><span class="line">balance: 1000.00</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">     id: 3</span><br><span class="line">   NAME: a</span><br><span class="line">balance: 100.00</span><br><span class="line"></span><br><span class="line">mysql -h127.0.0.1 -P3306 -uroot -p123456 --xml --execute=&quot;SELECT * FROM account;&quot; dbtest2 &gt; ./account4.xml</span><br><span class="line">cat account4.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;resultset statement=&quot;SELECT * FROM account&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class="line">  &lt;row&gt;</span><br><span class="line">	&lt;field name=&quot;id&quot;&gt;1&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;NAME&quot;&gt;张三&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;balance&quot;&gt;400.00&lt;/field&gt;</span><br><span class="line">  &lt;/row&gt;</span><br><span class="line"></span><br><span class="line">  &lt;row&gt;</span><br><span class="line">	&lt;field name=&quot;id&quot;&gt;2&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;NAME&quot;&gt;李四&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;balance&quot;&gt;1000.00&lt;/field&gt;</span><br><span class="line">  &lt;/row&gt;</span><br><span class="line"></span><br><span class="line">  &lt;row&gt;</span><br><span class="line">	&lt;field name=&quot;id&quot;&gt;3&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;NAME&quot;&gt;a&lt;/field&gt;</span><br><span class="line">	&lt;field name=&quot;balance&quot;&gt;100.00&lt;/field&gt;</span><br><span class="line">  &lt;/row&gt;</span><br><span class="line">&lt;/resultset&gt;</span><br></pre></td></tr></table></figure>

<p>导入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 先删除，再导入</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> account;</span><br><span class="line">LOAD DATA INFILE <span class="string">&#x27;/var/lib/mysql-files/account1.txt&#x27;</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> dbtest2.account;</span><br></pre></td></tr></table></figure>

<p>使用<code>mysqlimport</code>导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport -h127.0.0.1 -P3306 -uroot -p123456 dbtest2 &quot;/var/lib/mysql-files/account.txt&quot; --fields-terminated-by=&#x27;,&#x27; --fields-optionally-enclosed-by=&#x27;\&quot;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h2><p>数据迁移（<code>data migration</code>）是指选择、准备、提取和转换数据，将数据从一个计算机存储系统永久地传输到另一个计算机存储系统。迁移完之后，还需要验证迁移数据的完整性和退役原来旧的数据存储。</p>
<p>MySQL迁移方案通常有<strong>物理迁移</strong>和<strong>逻辑迁移</strong>两类，通常尽可能采用自动化的方式执行。</p>
<ul>
<li><p>物理迁移</p>
<p>速度快，需要停机迁移，并且要求MySQL版本以及配置必须和元服务器相同。</p>
<p>物理迁移包括拷贝数据和使用<code>XtraBackup</code>备份工具两种。</p>
<p>不同服务器之间可以使用物理迁移，在新的服务器上安装相同的版本软件，创建相同的目录，建议配置文件也要和原数据库相同，然后从原数据库方拷贝来数据文件及日志文件，配置好文件组权限，之后在新服务器上使用<code>mysqld</code>命令启动服务器。</p>
</li>
<li><p>逻辑迁移</p>
<p>逻辑迁移适用范围更广，无论是部分迁移还是全量迁移，都可以使用逻辑迁移。逻辑迁移中使用最多的就是通过<code>mysqldump</code>等备份工具</p>
</li>
</ul>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ol>
<li><p>相同版本的数据库之间迁移注意点</p>
<p>方式1：迁移前后MySQL数据库的主版本号相同，可以拷贝数据库文件实现，但是物理迁移方式只适用于<code>MyISAM</code>引擎。</p>
<p>方式2：最常用的方案，还是使用<code>mysqldump</code>导出数据，然后再在目标服务器上导入数据。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过 | ，将前面的结果作为后面语句的输入</span></span><br><span class="line">mysqldump -h host1 -uroot -p --all-databases| mysql -h host2 -uroot -p </span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>不同版本的数据库之间迁移注意点</p>
<p>例如从MySQL 5.5迁移到MySQL 8.0，不同版本之间迁移。</p>
<p>新旧版本可能使用不同的默认字符集，如果数据库中有中文数据，那么迁移过程中需要对默认字符集进行修改。</p>
<p>高版本的MySQL数据库通常会兼容低版本，因此可以从低版本的MySQL数据库迁移到高版本。</p>
</li>
<li><p>不同数据库之间迁移点</p>
<p>例如从<code>postgres</code>或者<code>sqlite</code>迁移到<code>MySQL</code>，这种迁移没有普适的解决方法。</p>
<p>迁移之前，需要了解不同数据库的架构，比较它们之间的差异。不同数据库中定义相同的数据的关键字可能会不同。</p>
<p>不同类型数据库之间的差异造成了互相迁移的困难，但是有些数据库之间是可以迁移的，例如用<code>MyODBC</code>实现MySQL和<code>SQLServer</code>之间的迁移。MySQL官方提供的工具<code>MySQL Migration Toolkit</code>也可以在不同数据库之间进行数据迁移。MySQL迁移到Oracle时，需要使用<code>mysqldump</code>命令导出sql文件，然后，手动更改sql文件中的CREATE语句。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/11/image-20221128180941894.png" alt="image-20221128180941894"></p>
<h2 id="误操作后的一些操作"><a href="#误操作后的一些操作" class="headerlink" title="误操作后的一些操作"></a>误操作后的一些操作</h2><p>例如一些误删除操作：</p>
<ol>
<li>使用<code>delete</code>语句误删数据行</li>
<li>使用drop table或者truncate table语句误删除数据表</li>
<li>使用drop database语句误删除数据库</li>
<li>使用rm命令误删整个MySQL实例</li>
</ol>
<h3 id="误删行数据"><a href="#误删行数据" class="headerlink" title="误删行数据"></a>误删行数据</h3><p>使用<code>Flashback</code>工具恢复数据。</p>
<p>原理：修改<code>bin log</code>内容，拿回原库重放。如果误删数据涉及到了多个事务，需要将事务的顺序调过来再执行。</p>
<p>使用前提：<code>binlog_format=row</code> 和 <code>binlog_row_image=FULL</code></p>
<p>最好的方案还是预防操作：代码做SQL审查、审计；打开<strong>安全模式</strong>，<code>sql_safe_updates</code>参数设置为<code>on</code>，删除时要求加<code>where</code>条件且<code>where</code>后需要时索引字段，否则必须使用limit，否则就会报错。</p>
<h3 id="误删库、表"><a href="#误删库、表" class="headerlink" title="误删库、表"></a>误删库、表</h3><p><code>delete</code>操作可以通过<code>redolog</code>、<code>binlog</code>恢复，使用<code>truncate table</code>或者<code>drop table</code>命令，在日志中也只有相同的命令记录，这个无法使用<code>Flashback</code>恢复。</p>
<p>这种情况，需要使用<strong>全量备份</strong>与<strong>增量日志</strong>结合的方式。</p>
<p>前提：有定期的全量备份，并且实时备份<code>binlog</code></p>
<p>恢复步骤：</p>
<ol>
<li>取最近一次全量备份</li>
<li>用备份恢复出一个临时库（这里是恢复临时库，不是操作主库）</li>
<li>取出备份时间之后的<code>binlog</code></li>
<li>剔除误删除语句，将其他语句全部应用到临时库</li>
<li>然后恢复主库</li>
</ol>
<p>预防：</p>
<ol>
<li>权限分离：不给业务人员<code>drop</code>、<code>truncate</code>权限，日常使用给只读权限；不同账号、不同数据之间进行权限分离</li>
<li>制定操作规范</li>
<li>设置延迟复制备库：例如设置1小时延迟时间再同步到备库，出现误操作1小时内，到这个备库执行<code>stop slave</code>，再通过<code>redo log</code>恢复到误删之前的操作</li>
</ol>
<h3 id="误删MySQL实例"><a href="#误删MySQL实例" class="headerlink" title="误删MySQL实例"></a>误删MySQL实例</h3><p>如果是有高可用实例的MySQL集群，删除一个节点之后，HA系统会重新选取一个主库，从而保证整个集群的正常工作。将这个节点上的数据恢复之后，再接入整个集群即可。</p>
<p>如果是删除集群，那就需要考虑跨机房备份，跨城市备份。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/11/24/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%94%81%E7%AF%87/" rel="prev" title="MySQL学习笔记事务和锁篇">
                  <i class="fa fa-chevron-left"></i> MySQL学习笔记事务和锁篇
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/12/06/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%AE%9E%E7%94%A8%E7%AF%87/" rel="next" title="Redis学习笔记之实用篇">
                  Redis学习笔记之实用篇 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-changyan">changyan</a></li>
            <li class="tab"><a href="#comment-disqusjs">disqusjs</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane changyan" id="comment-changyan">
              <div class="comments" id="SOHUCS" sid="5e2230e9a9133810a0091b6d745f4166"></div>
            </div>
            <div class="tab-pane disqusjs" id="comment-disqusjs">
              
  <div class="comments disqusjs-container">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
            </div>
        </div>
      </div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/xiaoyeshiyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.3/algoliasearch-lite.umd.js" integrity="sha256-dyJcbGuYfdzNfifkHxYVd/rzeR6SLLcDFYEidcybldM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.51.1/instantsearch.production.min.js" integrity="sha256-y6I4MY/blLHk4a7G33zp97DcnBFRY2iMId4FObo8toI=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cywylq09R","appkey":"144212e4b2486a1d43ffce31b0d7a370","count":true}</script>
<script src="/js/third-party/comments/changyan.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css" integrity="sha256-71XarXwNr1Td27HmZI9zjY+rMzRdush6/glo6VFXp7o=" crossorigin="anonymous">

<script class="next-config" data-name="disqusjs" type="application/json">{"enable":true,"api":null,"apikey":"CLClshNEb4J4q8Qv18lqsTcfWhmqPD8VyrjgFcPOJFfvEHypfUNIZDdVhnUCPMwk","shortname":"xiaoyeshiyu","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js","integrity":"sha256-okP99ZQKVpIy7+NogAMpGlIQzJa9XKXhIJcFgdju5bU="}}</script>
<script src="/js/third-party/comments/disqusjs.js"></script>

</body>
</html>
