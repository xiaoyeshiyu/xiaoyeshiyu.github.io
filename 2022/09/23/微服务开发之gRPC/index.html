<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="S_5aoPFd3QQihrUOLiKdVR0Mj4fj6n6qJojwyjj9cAY">
  <meta name="baidu-site-verification" content="code-Onlniop0d6">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaoyeshiyu.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="微服务开发过程中，一般使用gRPC框架更多，gRPC集成了链路追踪，超时控制等特性。">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务开发之gRPC">
<meta property="og:url" content="https://www.xiaoyeshiyu.com/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="微服务开发过程中，一般使用gRPC框架更多，gRPC集成了链路追踪，超时控制等特性。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/09/image-20220922210413261.png">
<meta property="article:published_time" content="2022-09-22T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-01T07:49:49.127Z">
<meta property="article:author" content="Mitaka xu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/09/image-20220922210413261.png">


<link rel="canonical" href="https://www.xiaoyeshiyu.com/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.xiaoyeshiyu.com/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/","path":"2022/09/23/微服务开发之gRPC/","title":"微服务开发之gRPC"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>微服务开发之gRPC | Hexo</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVJ11TVHH"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBVJ11TVHH","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573725610fbc6ff9b42032bd13615370"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子敬其在己者，而不慕其在天者，是以日进也。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Protobuf"><span class="nav-number">1.</span> <span class="nav-text">Protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E5%85%B6%E4%BB%96%E7%9A%84proto%E6%96%87%E4%BB%B6%E7%9A%84message"><span class="nav-number">1.3.</span> <span class="nav-text">引入其他的proto文件的message</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97message"><span class="nav-number">1.4.</span> <span class="nav-text">嵌套message</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gRPC"><span class="nav-number">2.</span> <span class="nav-text">gRPC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B9%8B%E9%97%B4%E7%9A%84%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">客户端服务端之间的模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.1.</span> <span class="nav-text">简单模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%95%B0%E6%8D%AE%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.2.</span> <span class="nav-text">服务端数据流模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%95%B0%E6%8D%AE%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.3.</span> <span class="nav-text">客户端数据流模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.4.</span> <span class="nav-text">双向数据流模式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metadata"><span class="nav-number">2.2.</span> <span class="nav-text">metadata</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">2.3.</span> <span class="nav-text">拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="nav-number">2.4.</span> <span class="nav-text">验证器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">2.5.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6"><span class="nav-number">2.6.</span> <span class="nav-text">超时机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gRPC%E5%BC%80%E5%8F%91%E4%B8%AD%E7%A2%B0%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">gRPC开发中碰到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%9D%91%EF%BC%9A"><span class="nav-number">3.1.</span> <span class="nav-text">一些坑：</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mitaka xu"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Mitaka xu</p>
  <div class="site-description" itemprop="description">保持积累，保持学习。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaoyeshiyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaoyeshiyu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.xiaoyeshiyu.com/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Mitaka xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="保持积累，保持学习。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="微服务开发之gRPC | Hexo">
      <meta itemprop="description" content="微服务开发过程中，一般使用gRPC框架更多，gRPC集成了链路追踪，超时控制等特性。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务开发之gRPC
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-23 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-23T00:00:00+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-01 15:49:49" itemprop="dateModified" datetime="2023-03-01T15:49:49+08:00">2023-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/golang/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
    <span id="/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/" class="post-meta-item leancloud_visitors" data-flag-title="微服务开发之gRPC" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan: </span>
    
    <a title="微服务开发之gRPC" href="/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::4311508f40ecc5a323c7cd73c80bbd24" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/09/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B9%8BgRPC/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/09/23/微服务开发之gRPC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description">微服务开发过程中，一般使用gRPC框架更多，gRPC集成了链路追踪，超时控制等特性。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h2><p>protocol buffers 是一种灵活，高效，自动化机制的结构数据序列化方法－可类比 XML，但是比 XML 更小、更快、更为简单。有性能高、跨语言、开发容易维护等特点，而且天然集成gRPC框架，因此，Protobuf是微服务中的基石。</p>
<p>Protobuf序列化和反序列化，json化的方式在文档：<a href="https://www.xiaoyeshiyu.com/2022/08/11/Golang%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a>和<a href="https://www.xiaoyeshiyu.com/2022/07/05/RPC/">RPC</a>中，这里不再赘叙。</p>
<p>示例：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user&#x27;s name.</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Protobuf文件一般以<code>.proto</code>结尾</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; <span class="comment">// 表明版本是proto3，需要放在最开头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;920/minegrpc;minegrpc&quot;</span>; <span class="comment">// 代表生成的go代码，包目录是920/minegrpc，包名称是minegrpc</span></span><br></pre></td></tr></table></figure>

<p>定义数据结构</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;	<span class="comment">// 1 代表字段编号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span></span><br></pre></td></tr></table></figure>

<p>目录树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minegrpc</span><br><span class="line">└── helloworld</span><br><span class="line">    └── helloworld.proto</span><br></pre></td></tr></table></figure>

<p>生成stub代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> minegrpc &amp;&amp; protoc --go_out=. --go_opt=paths=source_relative \</span></span><br><span class="line"><span class="language-bash">    --go-grpc_out=. --go-grpc_opt=paths=source_relative \</span></span><br><span class="line"><span class="language-bash">    helloworld/helloworld.proto</span></span><br></pre></td></tr></table></figure>

<p><code>--go_out=.</code>：代表将<strong>数据结构</strong>go代码生成到当前目录</p>
<p><code>--go-grpc_out=.</code>：代表将<strong>stub</strong>go代码生成到当前目录</p>
<p><code>paths=source_relative</code>：会使文件中<code>option go_package = &quot;920/grpc;grpc&quot;;</code>定义失效，会生成到<code>helloworld</code>目录下</p>
<p>生成代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">minegrpc</span><br><span class="line">└── helloworld</span><br><span class="line">    ├── helloworld.pb.go</span><br><span class="line">    ├── helloworld.proto</span><br><span class="line">    └── helloworld_grpc.pb.go</span><br></pre></td></tr></table></figure>

<p>如果要生成到<code>minegrpc</code>目录下，可以通过<code>--proto_path</code>指定目录，设置当前目录为<code>grpc</code>目录(或者 <code>-I</code> 指定目录)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">protoc --proto_path=./helloworld \</span></span><br><span class="line"><span class="language-bash">        --go_out=. --go_opt=paths=source_relative \</span></span><br><span class="line"><span class="language-bash">    --go-grpc_out=. --go-grpc_opt=paths=source_relative \</span></span><br><span class="line"><span class="language-bash">    helloworld.proto</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">minegrpc</span><br><span class="line">├── helloworld</span><br><span class="line">│   └── helloworld.proto</span><br><span class="line">├── helloworld.pb.go						// 生成结构体对象</span><br><span class="line">└── helloworld_grpc.pb.go				// 生成对象方法</span><br></pre></td></tr></table></figure>

<p>引用包中的结构体和方法是，则是通过</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> minegrpc <span class="string">&quot;gostudy/920/minegrpc&quot;</span></span><br></pre></td></tr></table></figure>

<p>生成的结构体，可以看到注释也一起生成</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The request message containing the user&#x27;s name.</span></span><br><span class="line"><span class="keyword">type</span> HelloRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	state         protoimpl.MessageState</span><br><span class="line">	sizeCache     protoimpl.SizeCache</span><br><span class="line">	unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">	Name <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,1,opt,name=name,proto3&quot; json:&quot;name,omitempty&quot;`</span> <span class="comment">// 1 代表字段编号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的服务端方法，在<code>helloworld_grpc.pb.go</code>中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreeterServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Sends a greeting</span></span><br><span class="line">	SayHello(context.Context, *HelloRequest) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">	<span class="comment">// Sends another greeting</span></span><br><span class="line">	SayHelloAgain(context.Context, *HelloRequest) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">	mustEmbedUnimplementedGreeterServer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端方法也在<code>helloworld_grpc.pb.go</code>中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreeterClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Sends a greeting</span></span><br><span class="line">	SayHello(ctx context.Context, in *HelloRequest, opts ...grpc.CallOption) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">	<span class="comment">// Sends another greeting</span></span><br><span class="line">	SayHelloAgain(ctx context.Context, in *HelloRequest, opts ...grpc.CallOption) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGreeterClient</span><span class="params">(cc grpc.ClientConnInterface)</span></span> GreeterClient &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;greeterClient&#123;cc&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>protoco buffer中的数据类型对照：<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">proto3</a>，中文：<a target="_blank" rel="noopener" href="https://halfrost.com/protobuf_encode/#toc-0">高效的数据压缩编码方式 Protobuf</a></p>
<img src="https://raw.githubusercontent.com/xiaoyeshiyu/image-hosting-service/main/uPic/2022/09/image-20220922210413261.png" alt="image-20220922210413261" style="zoom:50%;" />

<p>默认值：</p>
<p>当一个消息被解析时，如果被编码的信息不包含一个特定的singular元素，被解析的对象锁对应的域被设置为一个默认值，不同类型默认值如下：</p>
<ul>
<li>string，默认是一个空的string</li>
<li>bytes，默认是一个空的bytes</li>
<li>bools，默认是false</li>
<li>数值类型，默认是0</li>
<li>枚举类型，默认是第一个枚举值，也就是0</li>
<li>消息体，在go里面是nil，而不是为空</li>
<li>重复型，空slice</li>
</ul>
<p>默认值在不同的语言中可能不同，具体的默认值可以查看文档：<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/reference/overview">generated code guide</a></p>
<p>例如枚举类型</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum </span><span class="title class_">Goods</span> &#123;	<span class="comment">// 枚举类型，在Golang中生成是int32类型</span></span><br><span class="line">    GOODS_UNSPECIFIED = <span class="number">0</span>;		<span class="comment">// 注意，枚举类型的第一个字段，一定是0</span></span><br><span class="line">    GOODS_APPLE = <span class="number">1</span>;</span><br><span class="line">    GOODS_BANANA = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Goods <span class="type">int32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Goods_GOODS_UNSPECIFIED Goods = <span class="number">0</span></span><br><span class="line">	Goods_GOODS_APPLE       Goods = <span class="number">1</span></span><br><span class="line">	Goods_GOODS_BANANA      Goods = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>例如map类型</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Map</span> &#123;</span><br><span class="line">    map&lt;<span class="type">string</span>,<span class="type">string</span>&gt; mp =<span class="number">1</span>; <span class="comment">// 在Golang中，会生成map[string]string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	state         protoimpl.MessageState</span><br><span class="line">	sizeCache     protoimpl.SizeCache</span><br><span class="line">	unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">	Mp <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`protobuf:&quot;bytes,1,rep,name=mp,proto3&quot; json:&quot;mp,omitempty&quot; protobuf_key:&quot;bytes,1,opt,name=key,proto3&quot; protobuf_val:&quot;bytes,2,opt,name=value,proto3&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如时间戳类型</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Data</span> &#123;</span><br><span class="line">    google.protobuf.Timestamp time =<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Data <span class="keyword">struct</span> &#123;</span><br><span class="line">	state         protoimpl.MessageState</span><br><span class="line">	sizeCache     protoimpl.SizeCache</span><br><span class="line">	unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">	Time *timestamppb.Timestamp <span class="string">`protobuf:&quot;bytes,1,opt,name=time,proto3&quot; json:&quot;time,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而使用方式是通过</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// types/known/timestamppb/timestamp.pb.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(t time.Time)</span></span> *Timestamp &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Timestamp&#123;Seconds: <span class="type">int64</span>(t.Unix()), Nanos: <span class="type">int32</span>(t.Nanosecond())&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引入其他的proto文件的message"><a href="#引入其他的proto文件的message" class="headerlink" title="引入其他的proto文件的message"></a>引入其他的proto文件的message</h3><p>引入同目录下的proto文件<code>helloworld.proto</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; <span class="comment">// 表明版本是proto3，需要放在最开头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;base.proto&quot;</span>;	<span class="comment">// 通过import加文件名称即可</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;920/minegrpc;minegrpc&quot;</span>; <span class="comment">// 代表生成的go代码，包目录是920/grpc，包名称是grpc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Ping(Empty) <span class="keyword">returns</span>(Pong)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>base.proto</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option go_package = &quot;920/minegrpc;minegrpc&quot;;</span><br><span class="line"></span><br><span class="line">message Empty &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Pong&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种形式，如果只生成<code>helloworld.proto</code>对应的代码，是无法直接使用<code>Empty</code>和<code>Pong</code>的，还需要将<code>base.proto</code>生成代码。</p>
<p>引入第三方包</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; <span class="comment">// 表明版本是proto3，需要放在最开头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;base.proto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;	<span class="comment">// 通过路径引用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;920/minegrpc;minegrpc&quot;</span>; <span class="comment">// 代表生成的go代码，包目录是920/grpc，包名称是grpc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Ping(google.protobuf.Empty) <span class="keyword">returns</span>(Pong)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三方可以引用的包在<code>go/pkg/mod/google.golang.org/protobuf@v1.28.0/types/known</code>中</p>
<p>在源码中，可以看到包是<code>option go_package = &quot;google.golang.org/protobuf/types/known/emptypb&quot;;</code></p>
<h3 id="嵌套message"><a href="#嵌套message" class="headerlink" title="嵌套message"></a>嵌套message</h3><p>可以直接嵌套引用</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Empty</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Pong</span>&#123;</span><br><span class="line">    <span class="keyword">repeated</span> Empty empty = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以只放在内部使用</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Pong</span>&#123;</span><br><span class="line">    <span class="keyword">message </span><span class="title class_">Empty</span> &#123;</span><br><span class="line">        <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">repeated</span> Empty empty = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以引用其他的message内部嵌套的message</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Empty</span> &#123;</span><br><span class="line">    Pong.Data data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Pong</span>&#123;</span><br><span class="line">    <span class="keyword">message </span><span class="title class_">Data</span> &#123;</span><br><span class="line">        <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h2><p>gRPC的框架或者说插件，可以将proto中的rpc service生成golang的方法代码。</p>
<p>例如在proto中</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="comment">// Sends a greeting</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务端生成的代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreeterServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Sends a greeting</span></span><br><span class="line">	SayHello(context.Context, *HelloRequest) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">	mustEmbedUnimplementedGreeterServer()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterGreeterServer</span><span class="params">(s grpc.ServiceRegistrar, srv GreeterServer)</span></span> &#123;</span><br><span class="line">	s.RegisterService(&amp;Greeter_ServiceDesc, srv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在客户端生成的代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreeterClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Sends a greeting</span></span><br><span class="line">	SayHello(ctx context.Context, in *HelloRequest, opts ...grpc.CallOption) (*HelloReply, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> greeterClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	cc grpc.ClientConnInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGreeterClient</span><span class="params">(cc grpc.ClientConnInterface)</span></span> GreeterClient &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;greeterClient&#123;cc&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端生成的服务需要进行注册，客户端生成的代码，则构造客户端对象（<code>interface</code>），进行调用。</p>
<h3 id="客户端服务端之间的模式"><a href="#客户端服务端之间的模式" class="headerlink" title="客户端服务端之间的模式"></a>客户端服务端之间的模式</h3><h4 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h4><p>Simple RPC，客户端发起一次请求，服务端响应一个数据，跟平时熟悉的RPC没有大的区别。</p>
<p>服务端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gostudy/920/minegrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Service <span class="keyword">struct</span> &#123;</span><br><span class="line">	minegrpc.UnimplementedGreeterServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> SayHello(ctx context.Context, req *minegrpc.HelloRequest) (*minegrpc.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;minegrpc.HelloReply&#123;Message: <span class="string">&quot;hello&quot;</span> + req.Name&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> SayHelloAgain(ctx context.Context, req *minegrpc.HelloRequest) (*minegrpc.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;minegrpc.HelloReply&#123;Message: <span class="string">&quot;hello again&quot;</span> + req.Name&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line">	minegrpc.RegisterGreeterServer(s, &amp;Service&#123;&#125;)</span><br><span class="line">	log.Fatal(s.Serve(listener))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gostudy/920/minegrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	req := minegrpc.HelloRequest&#123;Name: <span class="string">&quot;abc&quot;</span>&#125;</span><br><span class="line">	hello, err := client.SayHello(ctx, &amp;req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(hello.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ps：简单模式也是长连接，只是收发过程是一对一。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	req := minegrpc.HelloRequest&#123;Name: <span class="string">&quot;abc&quot;</span>&#125;</span><br><span class="line">	hello, err := client.SayHello(ctx, &amp;req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(hello.Message)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端处于阻塞状态时，通过<code>netstat</code>可以看到socket信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ netstat -an | grep 8080</span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.65502        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.65502        127.0.0.1.8080         ESTABLISHED</span><br></pre></td></tr></table></figure>

<h4 id="服务端数据流模式"><a href="#服务端数据流模式" class="headerlink" title="服务端数据流模式"></a>服务端数据流模式</h4><p>Server-side streaming RPC：客户端发起一次请求，服务端返回一段连续的数据流。典型的例子是客户端向服务端发送一个股票代码，服务端就把该股票的实时数据源不断的返回给客户端。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="comment">// Sends a greeting</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetStream (HelloRequest) <span class="keyword">returns</span> (stream HelloReply) </span>&#123;&#125;     <span class="comment">// 服务端返回stream，是服务端流模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端数据流模式"><a href="#客户端数据流模式" class="headerlink" title="客户端数据流模式"></a>客户端数据流模式</h4><p>Client-side streaming RPC ：客户端源源不断向服务端发送数据流，发送结束后，由服务端返回一个响应。典型的例子是物联网终端向服务器发送数据。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="comment">// Sends another greeting</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> PutStream (stream HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;     <span class="comment">// 客户端发送stream，是客户端流模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="双向数据流模式"><a href="#双向数据流模式" class="headerlink" title="双向数据流模式"></a>双向数据流模式</h4><p>Bidirectional streaming RPC：客户端和服务端都可以向对方发送数据流，这个时候数据可以同时相互发送，也就是可以实现实时交互。典型的例子是聊天机器人，机器人可以源源不断发送信息，客户端也可以向聊天机器人源源不断发送信息。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> AllStream (stream HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;     <span class="comment">// 客户端发送stream，服务端返回stream，是双向流模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，通过protoc生成代码之后，方法为</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreeterServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Sends a greeting</span></span><br><span class="line">	GetStream(*HelloRequest, Greeter_GetStreamServer) <span class="type">error</span></span><br><span class="line">	<span class="comment">// Sends another greeting</span></span><br><span class="line">	PutStream(Greeter_PutStreamServer) <span class="type">error</span></span><br><span class="line">	AllStream(Greeter_AllStreamServer) <span class="type">error</span></span><br><span class="line">	mustEmbedUnimplementedGreeterServer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端数据流模式，服务端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> GetStream(req *minegrpc.HelloRequest, res minegrpc.Greeter_GetStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> err := res.Send(&amp;minegrpc.HelloReply&#123;Message: <span class="string">&quot;hello &quot;</span> + req.Name + <span class="string">&quot;:&quot;</span> + time.Now().String()&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gostudy/920/minegrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	req := minegrpc.HelloRequest&#123;Name: <span class="string">&quot;abc&quot;</span>&#125;</span><br><span class="line">	hello, err := client.GetStream(ctx, &amp;req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		reply, err := hello.Recv()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(reply.Message)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行效果，客户端显示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hello abc:2022-09-21 23:41:52.996397 +0800 CST m=+4.289561293</span><br><span class="line">hello abc:2022-09-21 23:41:53.497469 +0800 CST m=+4.790634043</span><br><span class="line">hello abc:2022-09-21 23:41:53.998574 +0800 CST m=+5.291739501</span><br><span class="line">hello abc:2022-09-21 23:41:54.500105 +0800 CST m=+5.793270918</span><br><span class="line">hello abc:2022-09-21 23:41:55.003888 +0800 CST m=+6.297055335</span><br><span class="line">hello abc:2022-09-21 23:41:55.505045 +0800 CST m=+6.798212876</span><br><span class="line">hello abc:2022-09-21 23:41:56.006222 +0800 CST m=+7.299389793</span><br><span class="line">hello abc:2022-09-21 23:41:56.507297 +0800 CST m=+7.800465251</span><br><span class="line">hello abc:2022-09-21 23:41:57.008563 +0800 CST m=+8.301732210</span><br><span class="line">hello abc:2022-09-21 23:41:57.509321 +0800 CST m=+8.802490793</span><br><span class="line">2022/09/21 23:41:58 EOF</span><br></pre></td></tr></table></figure>

<p>客户端数据流模式，服务端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> PutStream(req minegrpc.Greeter_PutStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		recv, err := req.Recv()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(recv.Name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;gostudy/920/minegrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	hello, err := client.PutStream(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">		req := minegrpc.HelloRequest&#123;Name: <span class="string">&quot;abc: &quot;</span> + time.Now().String()&#125;</span><br><span class="line">		err := hello.Send(&amp;req)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果服务端显示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">abc: 2022-09-21 23:47:15.221367 +0800 CST m=+0.003326418</span><br><span class="line">abc: 2022-09-21 23:47:16.222609 +0800 CST m=+1.004569751</span><br><span class="line">abc: 2022-09-21 23:47:17.223701 +0800 CST m=+2.005663168</span><br><span class="line">abc: 2022-09-21 23:47:18.224789 +0800 CST m=+3.006752376</span><br><span class="line">abc: 2022-09-21 23:47:19.225939 +0800 CST m=+4.007903626</span><br></pre></td></tr></table></figure>

<p>双向流模式，服务端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> AllStream(req minegrpc.Greeter_AllStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">	wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			recv, err := req.Recv()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(<span class="string">&quot;server receive: &quot;</span>, recv.Name)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			send := minegrpc.HelloReply&#123;Message: <span class="string">&quot;server: &quot;</span> + time.Now().String()&#125;</span><br><span class="line">			err := req.SendMsg(&amp;send)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(<span class="string">&quot;server send: &quot;</span>, send.Message)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Llongfile)</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	hello, err := client.AllStream(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">			req := minegrpc.HelloRequest&#123;Name: <span class="string">&quot;client: &quot;</span> + time.Now().String()&#125;</span><br><span class="line">			err := hello.Send(&amp;req)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != io.EOF &#123;</span><br><span class="line">				log.Fatal(err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//time.Sleep(time.Second)</span></span><br><span class="line">			fmt.Println(<span class="string">&quot;client send: &quot;</span>, req.Name)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">			<span class="keyword">var</span> req minegrpc.HelloReply</span><br><span class="line">			err = hello.RecvMsg(&amp;req)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(err)				<span class="comment">// 注意这里，接收消息是，一定会返回报错，因此无法对错误进行判断状态</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(<span class="string">&quot;client receive: &quot;</span>, req.Message)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端结果显示</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server send:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397325</span> +<span class="number">0800</span> CST m=+<span class="number">1.809850334</span></span><br><span class="line">server receive:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397059</span> +<span class="number">0800</span> CST m=+<span class="number">0.004309168</span></span><br><span class="line">server receive:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397447</span> +<span class="number">0800</span> CST m=+<span class="number">0.004697376</span></span><br><span class="line">server receive:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397453</span> +<span class="number">0800</span> CST m=+<span class="number">0.004702835</span></span><br><span class="line">server receive:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397456</span> +<span class="number">0800</span> CST m=+<span class="number">0.004705835</span></span><br><span class="line">server receive:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397458</span> +<span class="number">0800</span> CST m=+<span class="number">0.004708251</span>	<span class="comment">// 后续删除大量服务端代码</span></span><br><span class="line">server send:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397959</span> +<span class="number">0800</span> CST m=+<span class="number">1.810484501</span></span><br><span class="line">server send:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397961</span> +<span class="number">0800</span> CST m=+<span class="number">1.810486334</span></span><br><span class="line">server send:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397964</span> +<span class="number">0800</span> CST m=+<span class="number">1.810488959</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">61</span>: rpc <span class="type">error</span>: code = Canceled desc = context canceled</span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">48</span>: rpc <span class="type">error</span>: code = Canceled desc = context canceled</span><br></pre></td></tr></table></figure>

<p>客户端显示</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">client send:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397059</span> +<span class="number">0800</span> CST m=+<span class="number">0.004309168</span></span><br><span class="line">client send:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397447</span> +<span class="number">0800</span> CST m=+<span class="number">0.004697376</span></span><br><span class="line">client send:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397453</span> +<span class="number">0800</span> CST m=+<span class="number">0.004702835</span></span><br><span class="line">client send:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397456</span> +<span class="number">0800</span> CST m=+<span class="number">0.004705835</span></span><br><span class="line">client send:  client: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397458</span> +<span class="number">0800</span> CST m=+<span class="number">0.004708251</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">51</span>: rpc <span class="type">error</span>: code = Unknown desc = grpc: client streaming protocol violation: get &lt;<span class="literal">nil</span>&gt;, want &lt;EOF&gt;</span><br><span class="line">client receive:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397679</span> +<span class="number">0800</span> CST m=+<span class="number">1.810204626</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">51</span>: rpc <span class="type">error</span>: code = Unknown desc = grpc: client streaming protocol violation: get &lt;<span class="literal">nil</span>&gt;, want &lt;EOF&gt;</span><br><span class="line">client receive:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397704</span> +<span class="number">0800</span> CST m=+<span class="number">1.810229084</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">51</span>: rpc <span class="type">error</span>: code = Unknown desc = grpc: client streaming protocol violation: get &lt;<span class="literal">nil</span>&gt;, want &lt;EOF&gt;</span><br><span class="line">client receive:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397709</span> +<span class="number">0800</span> CST m=+<span class="number">1.810234459</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">51</span>: rpc <span class="type">error</span>: code = Unknown desc = grpc: client streaming protocol violation: get &lt;<span class="literal">nil</span>&gt;, want &lt;EOF&gt;</span><br><span class="line">client receive:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397713</span> +<span class="number">0800</span> CST m=+<span class="number">1.810238292</span></span><br><span class="line">main.<span class="keyword">go</span>:<span class="number">51</span>: rpc <span class="type">error</span>: code = Unknown desc = grpc: client streaming protocol violation: get &lt;<span class="literal">nil</span>&gt;, want &lt;EOF&gt;</span><br><span class="line">client receive:  server: <span class="number">2022</span><span class="number">-09</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">46.397715</span> +<span class="number">0800</span> CST m=+<span class="number">1.810239917</span></span><br></pre></td></tr></table></figure>

<p>可见，并不是客户端接受到，服务端才发送，而是一端直接发送到对端。</p>
<h3 id="metadata"><a href="#metadata" class="headerlink" title="metadata"></a>metadata</h3><p>在gRPC调用过程中，需要传递一些隐式数据（例如<code>token</code>，不需要嵌入业务逻辑的代码，需要用<code>header</code>传输），而且是跨进程通信，此时就可以通过<code>gRPC</code>中的<code>context</code>传递，将<code>metadata</code>传入<code>context</code>中。<code>metadata</code>就可以用于权限验证、链路跟踪等。</p>
<p>metadata是以<code>key-value</code>的形式存储数据的，key是<code>string</code>类型，<code>value</code>是<code>[]string</code>，即一个字符串数组类型。<code>http</code>中的<code>header</code>的生命周期是一次<code>http</code>请求，<code>metadata</code>的生命周期就是一次<code>RPC</code>调用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &quot;google.golang.org/grpc/metadata&quot;</span></span><br><span class="line"><span class="keyword">type</span> MD <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br></pre></td></tr></table></figure>

<p>使用方式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md := metadata.Pairs(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>RPC客户端发送</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply,err := client.SomeRPC(ctx,req)</span><br></pre></td></tr></table></figure>

<p>RPC服务端接受</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">	log.Fatal(<span class="string">&quot;something wrong&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> md &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;key: %s,value: %v&quot;</span>, k, v) <span class="comment">// v是一个[]string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>也就是中间件，例如记录接口响应时间，鉴权，做过滤，获取请求放信息等。</p>
<p>拦截器分为：一元拦截器（对于简单模式）；和流拦截器（对于数据流模式）</p>
<p>在创建Server中需要注入<code>ServerOption</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(opt ...ServerOption)</span></span> *Server &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以通过UnaryInterceptor方法生成ServerOption</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnaryInterceptor</span><span class="params">(i UnaryServerInterceptor)</span></span> ServerOption &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递UnaryServerInterceptor参数</span></span><br><span class="line"><span class="comment">// 也就是一个UnaryServerInterceptor对象，实现方法即可</span></span><br><span class="line"><span class="keyword">type</span> UnaryServerInterceptor <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *UnaryServerInfo, handler UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">intercept</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="params"><span class="function">	req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">	info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">	handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;receive a new request.&quot;</span>)</span><br><span class="line">  </span><br><span class="line">	resp, err = handler(ctx, req)</span><br><span class="line">  </span><br><span class="line">	fmt.Println(<span class="string">&quot;request already done.&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> resp, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Lshortfile)</span><br><span class="line">	listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	opt := grpc.UnaryInterceptor(intercept)</span><br><span class="line">	s := grpc.NewServer(opt)</span><br><span class="line">	minegrpc.RegisterGreeterServer(s, &amp;Service&#123;&#125;)</span><br><span class="line">	log.Fatal(s.Serve(listener))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行之后，服务端可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">receive a new request.</span><br></pre></td></tr></table></figure>

<p>拦截器也可以放在客户端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Dial</span><span class="params">(target <span class="type">string</span>, opts ...DialOption)</span></span> (*ClientConn, <span class="type">error</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithUnaryInterceptor</span><span class="params">(f UnaryClientInterceptor)</span></span> DialOption &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 与服务端同样的逻辑，声明一个函数</span></span><br><span class="line"><span class="keyword">type</span> UnaryClientInterceptor <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption)</span></span> <span class="type">error</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Lshortfile)</span><br><span class="line">	<span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithUnaryInterceptor(interceptor))</span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line">	dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, opts...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dial.Close()</span><br><span class="line"></span><br><span class="line">	client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">	ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">	hello, err := client.SayHello(ctx, &amp;minegrpc.HelloRequest&#123;Name: <span class="string">&quot;mitaka&quot;</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(hello.Message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interceptor</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	start := time.Now()</span><br><span class="line">	err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;spend: %s\n&quot;</span>, time.Since(start))</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行之后，客户端可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spend: 1.638416ms</span><br><span class="line">hellomitaka</span><br></pre></td></tr></table></figure>

<p>拦截器的开源项目：<a target="_blank" rel="noopener" href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-midware</a></p>
<p>例如做一个身份验证的拦截器</p>
<p>服务端通过拦截器验证token：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">auth</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="params"><span class="function">	req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">	info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">	handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.Unauthenticated, <span class="string">&quot;no token&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(md) <span class="comment">// 这个地方还可以嵌入日志记录验证的token</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		appid  <span class="type">string</span></span><br><span class="line">		appkey <span class="type">string</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> v1, ok := md[<span class="string">&quot;appid&quot;</span>]; ok &#123;</span><br><span class="line">		appid = v1[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> v2, ok := md[<span class="string">&quot;appkey&quot;</span>]; ok &#123;</span><br><span class="line">		appkey = v2[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !(appid == <span class="string">&quot;mitaka&quot;</span> &amp;&amp; appkey == <span class="string">&quot;pwd&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.Unauthenticated, <span class="string">&quot;auth failed&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端通过拦截器加载token</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">auth</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	md := metadata.Pairs(</span><br><span class="line">		<span class="string">&quot;appid&quot;</span>, <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">		<span class="string">&quot;appkey&quot;</span>, <span class="string">&quot;pwd&quot;</span>,</span><br><span class="line">	)</span><br><span class="line">	ctx = metadata.NewOutgoingContext(ctx, md)</span><br><span class="line"></span><br><span class="line">	err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Golang中，针对认证拦截器，可以通过<code>WithPerRPCCredentials</code>的拦截器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPerRPCCredentials</span><span class="params">(creds credentials.PerRPCCredentials)</span></span> DialOption &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现PerRPCCredentials接口</span></span><br><span class="line"><span class="keyword">type</span> PerRPCCredentials <span class="keyword">interface</span> &#123;</span><br><span class="line">	GetRequestMetadata(ctx context.Context, uri ...<span class="type">string</span>) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">	RequireTransportSecurity() <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在客户端上实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> perRPCCredentials <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *perRPCCredentials)</span></span> GetRequestMetadata(ctx context.Context, uri ...<span class="type">string</span>) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;appid&quot;</span>:  <span class="string">&quot;mitaka&quot;</span>,</span><br><span class="line">		<span class="string">&quot;appkey&quot;</span>: <span class="string">&quot;pwd&quot;</span>,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *perRPCCredentials)</span></span> RequireTransportSecurity() <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line">opts = <span class="built_in">append</span>(opts, grpc.WithTransportCredentials(insecure.NewCredentials()),</span><br><span class="line">	grpc.WithPerRPCCredentials(&amp;perRPCCredentials&#123;&#125;))</span><br><span class="line">dial, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8080&quot;</span>, opts...)</span><br></pre></td></tr></table></figure>

<h3 id="验证器"><a href="#验证器" class="headerlink" title="验证器"></a>验证器</h3><p>validator，验证传入参数是否满足要求。更多的匹配规则在官方文档中：<a target="_blank" rel="noopener" href="https://github.com/envoyproxy/protoc-gen-validate">protoc-gen-validate</a></p>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fetches this repo into <span class="variable">$GOPATH</span></span></span><br><span class="line">go get -d github.com/envoyproxy/protoc-gen-validate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installs PGV into <span class="variable">$GOPATH</span>/bin</span></span><br><span class="line">make build</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/envoyproxy/protoc-gen-validate@latest</span><br></pre></td></tr></table></figure>

<p>拷贝validator的proto，目录如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── base.pb.go</span><br><span class="line">├── helloworld</span><br><span class="line">│   ├── base.proto</span><br><span class="line">│   └── helloworld.proto</span><br><span class="line">├── helloworld.pb.go</span><br><span class="line">├── helloworld_grpc.pb.go</span><br><span class="line">└── validate</span><br><span class="line">    └── validate.proto</span><br></pre></td></tr></table></figure>

<p>定义数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">message Person &#123;</span><br><span class="line">    <span class="type">uint64</span> id    = <span class="number">1</span> [(validate.rules).<span class="type">uint64</span>.gt    = <span class="number">999</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">string</span> email = <span class="number">2</span> [(validate.rules).<span class="type">string</span>.email = <span class="literal">true</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">string</span> name  = <span class="number">3</span> [(validate.rules).<span class="type">string</span> = &#123;</span><br><span class="line">        pattern:   <span class="string">&quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;</span>,</span><br><span class="line">        max_bytes: <span class="number">256</span>,</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    Location home = <span class="number">4</span> [(validate.rules).message.required = <span class="literal">true</span>];</span><br><span class="line"></span><br><span class="line">    message Location &#123;</span><br><span class="line">        double lat = <span class="number">1</span> [(validate.rules).double = &#123; gte: <span class="number">-90</span>,  lte: <span class="number">90</span> &#125;];</span><br><span class="line">        double lng = <span class="number">2</span> [(validate.rules).double = &#123; gte: <span class="number">-180</span>, lte: <span class="number">180</span> &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path=. \</span><br><span class="line">	--proto_path=./helloworld \</span><br><span class="line">	--go_out=. --go_opt=paths=source_relative \</span><br><span class="line">    --go-grpc_out=. --go-grpc_opt=paths=source_relative \</span><br><span class="line">    --validate_out=&quot;lang=go:../../&quot; \	// 注意生成路径，由于在helloworld.proto指定package，因此路径会按照当前路径生成目录</span><br><span class="line">    helloworld.proto</span><br></pre></td></tr></table></figure>

<p>可以看到生成一个<code>helloworld.pb.validate.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	p := minegrpc.Person&#123;</span><br><span class="line">		Id: <span class="number">0</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := p.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到出现报错：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>/<span class="number">09</span>/<span class="number">23</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">45</span> invalid Person.Id: value must be greater than <span class="number">999</span></span><br></pre></td></tr></table></figure>

<p>如果每个参数都这样校验，逻辑会有很多重复的，此时可以使用拦截器。</p>
<p>那么其中有个问题，如何确定req有没有validate方法，这里就可以通过interface和断言实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> validator <span class="keyword">interface</span> &#123;</span><br><span class="line">	Validate() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">intercept</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="params"><span class="function">	req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">	info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">	handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> v, ok := req.(validator); ok &amp;&amp; v.Validate() != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.InvalidArgument, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handler(ctx, resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>在HTTP中有Code标明这个请求的状态，在gRPC中也有状态码：</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://developers.google.com/maps-booking/reference/grpc-api/status_codes">Status Response Codes</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">GRPC Core </a></p>
<p>服务端通过制定返回错误</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span></span> SayHello(ctx context.Context, req *minegrpc.HelloRequest) (*minegrpc.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.NotFound, <span class="string">&quot;not found&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端调用之后，可以收到</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hello, err := client.SayHello(ctx, &amp;minegrpc.HelloRequest&#123;Name: <span class="string">&quot;mitaka&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> e, ok := status.FromError(err); ok &#123; <span class="comment">// 类似断言，类型判断</span></span><br><span class="line">		fmt.Println(e.Code())</span><br><span class="line">		fmt.Println(e.Message())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NotFound</span><br><span class="line">not found</span><br></pre></td></tr></table></figure>

<h3 id="超时机制"><a href="#超时机制" class="headerlink" title="超时机制"></a>超时机制</h3><p>gRPC在客户端可以设置超时时间，当出现网络抖动、网络拥塞、服务端处理响应慢、服务端依赖数据库等第三方导致很慢，如果一直等待返回，如果后端服务会有连续调用，已经响应过慢的请求本来就没有必要再响应，而且还会占用服务端资源，因此需要使用超时机制。在gRPC中，超时可以向下传递，可以在请求的每个节点上都实现超时控制，在当前节点已经超时，则不需要将请求再传递到下一个节点。在熔断、降级、限流的功能中，都需要用到超时机制。</p>
<p>在客户端请求时，设置超时</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client := minegrpc.NewGreeterClient(dial)</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">1</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">_, err = client.SayHello(ctx, &amp;minegrpc.HelloRequest&#123;Name: <span class="string">&quot;mitaka&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>服务端改动，改成sleep 2s</p>
<p>可以看到客户端请求之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DeadlineExceeded</span><br><span class="line">context deadline exceeded</span><br></pre></td></tr></table></figure>

<h2 id="gRPC开发中碰到的问题"><a href="#gRPC开发中碰到的问题" class="headerlink" title="gRPC开发中碰到的问题"></a>gRPC开发中碰到的问题</h2><ol>
<li><p>params：参数默认值，是否为非空</p>
<p>在接口对接过程中，例如一些更新接口，由于没传和零值可能造成混淆，例如开关，没有更新开关，gRPC会默认收到<code>false</code>，与将开关关闭逻辑一样，因此需要区分零值和空值；还有一种情况是状态请求，响应的请求如果是零值，则不会返回，就变成当开关是<code>off</code>，此时获取开关状态是空的，这个需要注意。</p>
<p>在<code>Golang</code>中，可以通过指针进行判断值是<code>nil</code>还是为零值，将这个思想移植过来，则可以通过<code>oneof</code>或者<code>wrappers</code>的方式。</p>
<p><code>oneof</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">oneof</span> switch &#123;</span><br><span class="line">        <span class="type">bool</span> on =<span class="number">2</span>;</span><br><span class="line">        <span class="type">bool</span> off=<span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在使用中，就需要进行判断</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> req.GetOn() &#123;</span><br><span class="line">	stat = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，相比较下，这个方式不易读，更加推崇<code>wrappers</code>的方式</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">    google.protobuf.BoolValue switch =<span class="number">2</span>;</span><br><span class="line">    Gender sex =<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Gender</span> &#123;</span><br><span class="line">    SEX_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line">    SEX_MALE = <span class="number">1</span>;</span><br><span class="line">    SEX_FEMALE = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用过程通过与nil进行判断，更加符合Golang中的习惯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> req.Switch != <span class="literal">nil</span> &#123;</span><br><span class="line">		stat = req.Switch.Value</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>枚举类型同理，在获取值时，需要先判断是否为未指定（未指定是枚举类型的零值）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> req.Sex != minegrpc.Gender_SEX_UNSPECIFIED &#123;</span><br><span class="line">	sex = req.Sex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>swagger</code>分组</p>
<p>通过<code>gRPC-GATEWAY</code>可以生成<code>HTTP</code>请求，还可以通过<code>swagger</code>生成<code>swagger</code>，如果所有的<code>rpc</code>请求都放在同一个<code>service</code>中，<code>swagger</code>就没有分组，<code>swagger</code>默认以<code>service</code>进行分组。</p>
</li>
<li><p><code>Proto</code> 枚举下，使用<code>int</code>而不是<code>string</code>，以及变量输出格式为下划线（蛇形体）而不是驼峰体</p>
<p>在使用枚举类型时，返回的结果可能会将枚举的值返回出来，而在使用proto进行对接时，枚举类型暴露出来意义不大，而且更容易出错，因此建议使用枚举类型的序号。在RPC交互时，推荐使用序号，在存储到数据库时，推荐使用值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGRPCGateway</span><span class="params">()</span></span> *runtime.ServeMux &#123;</span><br><span class="line">	<span class="keyword">return</span> runtime.NewServeMux(runtime.WithMarshalerOption(</span><br><span class="line">		runtime.MIMEWildcard, &amp;runtime.JSONPb&#123;</span><br><span class="line">			MarshalOptions: protojson.MarshalOptions&#123;</span><br><span class="line">				<span class="comment">// 将枚举类型返回为数字，marshal之后是数字枚举</span></span><br><span class="line">				UseEnumNumbers: <span class="literal">true</span>,</span><br><span class="line">				<span class="comment">// 以proto中定义的下划线输出，而不是用驼峰体输出</span></span><br><span class="line">				UseProtoNames: <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			UnmarshalOptions: protojson.UnmarshalOptions&#123;&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ps：RPC交互时，传枚举类型还是传值，都可以。</p>
</li>
<li><p>gRPC实现文件上传相比而言比较麻烦，</p>
</li>
</ol>
<h3 id="一些坑："><a href="#一些坑：" class="headerlink" title="一些坑："></a>一些坑：</h3><ol>
<li>所有字段都可选，默认不填为零值。这是为了适配新老系统。因此需要在设计阶段就要考虑。例如，增加一个状态字段</li>
<li>字段序号确定之后，就不能改变，改变了会影响老系统对接</li>
<li>定义字段的时候，顺序没有关系，只有字段后面的数字会有影响</li>
<li>使用<code>int32</code>而不是<code>int64</code>，不然数字会变成<code>string</code></li>
</ol>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;api/v1;v1&quot;</span>;</span><br><span class="line"><span class="comment">// 目录名称;包名</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/19/Golang%E4%B8%AD%E7%9A%84GC/" rel="prev" title="Golang中的GC">
                  <i class="fa fa-chevron-left"></i> Golang中的GC
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/09/26/GORM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="GORM学习笔记">
                  GORM学习笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-changyan">changyan</a></li>
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
            <li class="tab"><a href="#comment-disqusjs">disqusjs</a></li>
            <li class="tab"><a href="#comment-gitalk">gitalk</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane changyan" id="comment-changyan">
              <div class="comments" id="SOHUCS" sid="4311508f40ecc5a323c7cd73c80bbd24"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
            </div>
            <div class="tab-pane disqusjs" id="comment-disqusjs">
              
  <div class="comments disqusjs-container">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
            </div>
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments gitalk-container"></div>
            </div>
        </div>
      </div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mitaka xu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/xiaoyeshiyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.3/algoliasearch-lite.umd.js" integrity="sha256-dyJcbGuYfdzNfifkHxYVd/rzeR6SLLcDFYEidcybldM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.51.1/instantsearch.production.min.js" integrity="sha256-y6I4MY/blLHk4a7G33zp97DcnBFRY2iMId4FObo8toI=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"TVx6Wkfs8VJGOwYPurtjWY2e-9Nh9j0Va","app_key":"c7VvaRnyF8r3DUIPq1x2KJ7Q","server_url":"https://tvx6wkfs.lc-cn-e1-shared.com","security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cywylq09R","appkey":"144212e4b2486a1d43ffce31b0d7a370","count":true}</script>
<script src="/js/third-party/comments/changyan.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaoyeshiyu","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css" integrity="sha256-71XarXwNr1Td27HmZI9zjY+rMzRdush6/glo6VFXp7o=" crossorigin="anonymous">

<script class="next-config" data-name="disqusjs" type="application/json">{"enable":true,"api":null,"apikey":"CLClshNEb4J4q8Qv18lqsTcfWhmqPD8VyrjgFcPOJFfvEHypfUNIZDdVhnUCPMwk","shortname":"xiaoyeshiyu","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js","integrity":"sha256-okP99ZQKVpIy7+NogAMpGlIQzJa9XKXhIJcFgdju5bU="}}</script>
<script src="/js/third-party/comments/disqusjs.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"xiaoyeshiyu","repo":"xiaoyeshiyu.github.io","client_id":"8ebf146b6bbf3b76e5b8","client_secret":"ba5d23f1e5b245184fbbe5821450b377e63ab20a","admin_user":"xiaoyeshiyu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"4311508f40ecc5a323c7cd73c80bbd24"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
